{"version":3,"sources":["L.IM_ControlLayerManager.js","L.IM_Search.js","L.IM_Map-2.0.0.js","L.IM_ColorLayer.js","L.IM_Coordinates.js","L.IM_OpenInstamapsControl.js","L.IM_HomeControl.js","L.IM_ShareControl.js","L.IM_RoutingControl.js","L.IM_SearchControl.js","L.IM_SnapshotControl.js","L.IM_LikeControl.js","L.IM_PrintControl.js","L.IM_GeoPdfControl.js","L.IM_3DControl.js","L.IM_LegendBtnControl.js","L.IM_LegendControl.js","L.IM_LayersBtnControl.js","L.IM_LocationControl.js","L.IM_ControlScale.js","L.IM_MinimapControl.js","L.IM_LogosControl.js","L.IM_WidgetsControl.js","L.IM_MapExportControl.js","L.IM_Spin.js","L.Wikipedia.js","L.Twitter.js","L.IM_Label.js","geocat.config-1.0.0.js","geocat.constants.js","geocat.ajax-1.0.0.js","geocat.utils.js","geocat.web-1.0.0.js","geocat.compartir.js","instamaps.analytics-2.0.0.js","geocat.panel-capes.js","geocat.mapa.draw.js","geocat.mapa.wms.js","geocat.mapa.tematics.js","geocat.mapa.url-file.js","geocat.mapa.visualitzacioWMS.js","geocat.mapa.xarxes-socials.js","geocat.mapa.dades-obertes.js","geocat.mapa.json.js","geocat.mapa.heat.js","geocat.mapa.cluster.js","geocat.mapa.canvas.js","geocat.mapa.semaforic.js","geocat.mapa.basic.js","geocat.mapa.categories.js","geocat.mapa.edit-data-table.js","instamaps.layers-1.0.0.js","instamaps.wms-1.0.0.js","geocat.visor.fons.js","instamaps.mapa.3D-1.0.0.js","instamaps.visor.visor-2.0.0.js","instamaps.visor.app-1.0.0.js","instamaps.geolocal.selectMunicipis.js","instamaps.geolocal.listViewMunicipis.js","instamaps.geolocal.widgets.meteo.js","instamaps.geolocal.widgets.idescat.js","instamaps.geolocal.widgets.cartoteca.js","instamaps.geolocal.widgets.rpuc.js","instamaps.geolocal.widgets.cadastre.js","instamaps.geolocal.widgets.infoparcela.js","instamaps.geolocal.widgets.mascara.js","instamaps.visor.geolocal.js","instamaps.visor.simple.js","instamaps.app-1.0.0.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1yDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9hCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACt4CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9ZA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzgCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3sFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9bA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACn3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1pBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACl9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1OA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/XA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnqDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"instamaps-e7f566566d.js","sourcesContent":["L.Control.OrderLayers = L.Control.Layers.extend({\r\n\toptions : {\r\n\t\tcollapsed : true,\r\n\t\tposition : 'topright',\r\n\t\ttitle : 'Title',\r\n\t\tautoZIndex : true,\r\n\t\tautoUpdate: true\r\n\t},\r\n\r\n\tinitialize : function(baseLayers, groupedOverlays, options) {\r\n\t\tvar i, j;\r\n\t\t\r\n\t\tL.Util.setOptions(this, options);\r\n\t\t\r\n\t\tthis._layers = {};\r\n\t\tthis._lastZIndex = 0;\r\n\t\tthis._handlingClick = false;\r\n\t\tthis._groupList = [];\r\n\t\tthis._domGroups = [];\r\n\t\tthis._socInstamapsVell=\"_socVisorVellInstamaps_\";\r\n\t\tthis._mapConfig = options.mapConfig;\r\n\t\t\r\n\t\tfor (i in baseLayers) {\r\n\t\t\tfor ( var j in baseLayers[i].layers) {\r\n\t\t\t\tthis._addLayer(baseLayers[i].layers[j], j,\r\n\t\t\t\t\tbaseLayers[i], false);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (i in groupedOverlays) {\r\n\t\t\tfor ( var j in groupedOverlays[i].layers) {\r\n\t\t\t\tthis._addLayer(groupedOverlays[i].layers[j], j, true,\r\n\t\t\t\t\tnull, groupedOverlays[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tonAdd : function(map) {\r\n\t\tthis._initLayout();\r\n\t\tthis._update();\r\n\t\tmap.on('layeradd', this._onLayerChange, this).on('layerremove', this._onLayerChange, this);\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\tonRemove : function(map) {\r\n\t\tmap.off('layeradd', this._onLayerChange).off('layerremove', this._onLayerChange);\r\n\t},\r\n\r\n\taddBaseLayer : function(layer, name, group) {\r\n\t\tthis._addLayer(layer, name, group, false);\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\taddOverlay : function(layer, name, overlay, groupLeafletId) {\r\n\t\tthis._addLayer(layer, name, overlay, groupLeafletId);\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\tremoveLayer : function(obj) {\r\n\t\tvar id = L.stamp(obj.layer);\r\n\t\tif (!obj.sublayer) {\r\n\t\t\tdelete this._layers[id];\r\n\t\t} else {\r\n\t\t\tdelete this._layers[obj.layerIdParent]._layers[id];\r\n\t\t}\r\n\r\n\t\tvar _thereIs = false;\r\n\t\tfor (layer in this._layers) {\r\n\t\t\tif (this._layers[layer].layer.options.tipus && this._layers[layer].layer.options.tipus.indexOf(t_wms) != -1) {\r\n\t\t\t\tif (this._layers[layer].layer.options.wmstime == true) {\r\n\t\t\t\t\t_thereIs = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tshowTimeControl(_thereIs);\r\n\r\n\t\tthis._update();\r\n\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,\"remove\",true);}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetCountLayers:function(){\r\n\t\tvar i=0;\r\n\t\tfor (layer in this._layers) {\r\n\t\t\ti=i+1;\r\n\t\t\tfor (sublayer in this._layers[layer]._layers) {\r\n\t\t\t\ti=i+1;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn i;\r\n\t},\r\n\t\r\n\tgetLayersFromGroupId : function(groupId, groupName) {\r\n\t\tvar resp_Layer = [];\r\n\t\tfor (layer in this._layers) {\r\n\t\t\tif (this._layers[layer].layer.options.group.groupName == groupName\r\n\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\r\n\t\t\t\tresp_Layer.push(this._layers[layer]);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn resp_Layer;\r\n\t},\r\n\r\n\tupdateTreeGroupLayers : function(groupId, groupName, businessId, z_order, expanded) {\r\n\t\tvar dfd = $.Deferred();\r\n\t\ttry{\r\n\t\t\tthis._groupList[groupId].groupName = groupName;\r\n\t\t\tthis._groupList[groupId].name = groupName;\r\n\t\t\tthis._groupList[groupId].id = groupId;\r\n\t\t\tthis._groupList[groupId].expanded = expanded;\r\n\t\r\n\t\t\tfor (layer in this._layers) {\r\n\t\t\t\tif (this._layers[layer].layer.options.group\r\n\t\t\t\t\t&& this._layers[layer].layer.options.businessId == businessId) {\r\n\t\t\t\t\tthis._layers[layer].layer.options.group.name = groupName;\r\n\t\t\t\t\tthis._layers[layer].layer.options.group.groupName = groupName;\r\n\t\t\t\t\tthis._layers[layer].layer.options.group.id = groupId;\r\n\t\t\t\t\tthis._layers[layer].layer.options.group.z_order = z_order;\r\n\t\t\t\t\tthis._layers[layer].layer.options.group.expanded = expanded;\r\n\t\t\t\t\tthis._layers[layer].layer.options.zIndex = z_order;\r\n\t\t\t\t\tthis._layers[layer].layer.setZIndex(parseInt(z_order)+1);\r\n\t\t\t\t\tmap.eachLayer(function(layer) {\r\n\t\t\t\t\t\tif (layer.options\r\n\t\t\t\t\t\t\t&& layer.options.businessId == businessId) {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tlayer.bringToFront();\r\n\t\t\t\t\t\t\t} catch (Err) {\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdfd.resolve(this._layers[layer].layer);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}catch(Err){\r\n\t\t\tdfd.reject(Err);\r\n\t\t\tconsole.debug(Err);\r\n\t\t}\r\n\t\treturn dfd.promise();\r\n\t},\r\n\r\n\tupdateGroupName : function(oldName, newName, groupId) {\r\n\t\tvar resp_Layer = [];\r\n\t\tfor (group in this._groupList) {\r\n\t\t\tif (this._groupList[group].groupName == oldName\r\n\t\t\t\t&& this._groupList[group].id == groupId) {\r\n\t\t\t\tthis._groupList[group].groupName = newName;\r\n\t\t\t\tthis._groupList[group].name = newName;\r\n\r\n\t\t\t\tfor (layer in this._layers) {\r\n\t\t\t\t\tif (this._layers[layer].layer.options.group\r\n\t\t\t\t\t\t&& this._layers[layer].layer.options.group.name == oldName\r\n\t\t\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\r\n\t\t\t\t\t\tthis._layers[layer].layer.options.group.name = newName;\r\n\t\t\t\t\t\tthis._layers[layer].layer.options.group.groupName = newName;\r\n\t\t\t\t\t\tresp_Layer.push(this._layers[layer].layer);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._update();\r\n\t\treturn resp_Layer;\r\n\t},\r\n\r\n\tremoveGroup : function(groupName, groupId) {\r\n\t\tif (groupName) {\r\n\t\t\tfor (group in this._groupList) {\r\n\t\t\t\tif (this._groupList[group].groupName == groupName\r\n\t\t\t\t\t\t&& this._groupList[group].id == groupId) {\r\n\t\t\t\t\tfor (layer in this._layers) {\r\n\t\t\t\t\t\tif (this._layers[layer].layer.options.group\r\n\t\t\t\t\t\t\t&& this._layers[layer].layer.options.group.groupName == groupName\r\n\t\t\t\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\r\n\t\t\t\t\t\t\tdelete this._layers[layer];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdelete this._groupList[group];\r\n\t\t\t\t\tthis._update();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_initLayout : function() {\r\n\t\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html') != -1);\r\n\t\tvar className = 'leaflet-control-layers', \r\n\t\tcontainer = this._container = L.DomUtil.create('div', className);\r\n\r\n\t\t// Makes this work on IE10 Touch devices by stopping it from\r\n\t\t// firing a mouseout event when the touch is released\r\n\t\tcontainer.setAttribute('aria-haspopup', true);\r\n\r\n\t\tif (!L.Browser.touch) {\r\n\t\t\tL.DomEvent.disableClickPropagation(container);\r\n\t\t\tL.DomEvent.on(container, 'wheel', L.DomEvent.stopPropagation);\r\n\t\t} else {\r\n\t\t\tL.DomEvent.on(container, 'click', L.DomEvent.stopPropagation);\r\n\t\t}\r\n\t\tvar section = document.createElement('section');\r\n\t\tsection.className = 'ac-container ' + className + '-list';\r\n\t\t\r\n\t\tvar spiner = this._spiner = L.DomUtil.create('div', className + '-spiner');\r\n\t\t\r\n\t\tspiner.innerHTML = \"<i class='fa fa-refresh fa-spin fa-fw margin-bottom'></i>\"+\r\n\t\t\"<span lang='ca'>Carregant, esperi si us plau...</span>\";\r\n\t\t\r\n\t\tsection.appendChild(spiner);\r\n\t\t\r\n\t\tvar form = this._form = L.DomUtil.create('div', className + '-list');\r\n\r\n\t\tif (this.options.title) {\r\n\t\t\tvar title = L.DomUtil.create('h3', className + '-title editable');\r\n\t\t\ttitle.innerHTML = this.options.title;\r\n\t\t\ttitle.id = 'nomAplicacio';\r\n\t\t\tform.appendChild(title);\r\n\t\t}\r\n\r\n\t\tsection.appendChild(form);\r\n\r\n\t\tif (this.options.collapsed) {\r\n\t\t\tif (!L.Browser.android) {\r\n\t\t\t\tL.DomEvent.on(container, 'mouseover', this._expand,\r\n\t\t\t\t\tthis).on(container, 'mouseout', this._collapse,\r\n\t\t\t\t\tthis);\r\n\t\t\t}\r\n\t\t\tvar link = this._layersLink = L.DomUtil.create('a',\r\n\t\t\t\tclassName + '-toggle', container);\r\n\t\t\tlink.href = '#';\r\n\t\t\tlink.title = 'Layers';\r\n\r\n\t\t\tif (L.Browser.touch) {\r\n\t\t\t\tL.DomEvent.on(link, 'click', L.DomEvent.stop).on(link,\r\n\t\t\t\t\t'click', this._expand, this);\r\n\t\t\t} else {\r\n\t\t\t\tL.DomEvent.on(link, 'focus', this._expand, this);\r\n\t\t\t}\r\n\r\n\t\t\tthis._map.on('click', this._collapse, this);\r\n\t\t\t// TODO keyboard accessibility\r\n\r\n\t\t} else {\r\n\t\t\tthis._expand();\r\n\t\t}\r\n\r\n\t\tvar strLayersList = 'layers-list';\r\n\t\tthis._baseLayersList = L.DomUtil.create('div', className + '-base', form);\r\n\r\n\t\tthis._overlaysList = L.DomUtil.create('ol', className + '-overlays', form);\r\n\r\n\t\tif (getModeMapa()) {\r\n\t\t\tthis._addButton = L.DomUtil.create('div', 'addVerd', form);\r\n\t\t\tL.DomEvent.on(this._addButton, 'click',\r\n\t\t\t\tthis._addGroupFromScratch, this);\r\n\r\n\t\t\t$(this._addButton).tooltip({\r\n\t\t\t\tplacement : 'left',\r\n\t\t\t\tcontainer : 'body',\r\n\t\t\t\ttitle : window.lang.translate(\"Nou grup\")\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tcontainer.appendChild(section);\r\n\r\n\t\t// process options of ac-container css class - to\r\n\t\t// options.container_width and options.container_maxHeight\r\n\t\tfor (var c = 0; c < (containers = container\r\n\t\t  .getElementsByClassName('ac-container')).length; c++) {\r\n\t\t\tif (this.options.container_width) {\r\n\t\t\t\tcontainers[c].style.width = this.options.container_width;\r\n\t\t\t}\r\n\r\n\t\t\t// set the max-height of control to y value of map object\r\n\t\t\tthis._default_maxHeight = this.options.container_maxHeight ? this.options.container_maxHeight\r\n\t\t\t\t: (this._map._size.y - 70);\r\n\t\t}\r\n\t\twindow.onresize = this._on_resize_window.bind(this);\r\n\t},\r\n\r\n\t_on_resize_window : function() {\r\n\r\n\t},\r\n\r\n\t// remove the px from a css value and convert to a int\r\n\t_removePxToInt : function(value) {\r\n\t\tif (typeof (value) == \"number\") {\r\n\t\t\treturn value;\r\n\t\t} else {\r\n\t\t\treturn parseInt(value.replace(\"px\", \"\"));\r\n\t\t}\r\n\t},\r\n\r\n\t_socVisorInstamaps:function(){\r\n\t\tvar self = this;\r\n\t\tvar hoSoc=false;\r\n\t\tif (self._mapConfig===undefined) self._mapConfig=mapConfig;\r\n\t\tif(self._mapConfig.tipusAplicacioId==1 && !getModeMapa()){\r\n\t\t\thoSoc=true;\r\n\t\t}\r\n\t\treturn hoSoc;\r\n\t},\r\n\t\r\n\t_createGroupFromScratch : function(position) {\r\n\t\tvar pos = this._groupList.length;\r\n\t\tvar posTXT;\r\n\t\tvar genericName=window.lang.translate('Capes');\r\n\t\tvar genericPos=\"\";\r\n\r\n\t\tpos==0?genericPos=\"\":genericPos=pos;\r\n\r\n\t\tthis._socVisorInstamaps()?genericName=this._socInstamapsVell:genericName=genericName;\r\n\r\n\t\tif (position == 1 && pos > 0) { // estic afegint una\r\n\t\t\t// capa però ja existeix\r\n\t\t\t// un grup\r\n\t\t\treturn this.getActiveGroup();\r\n\t\t} else {\r\n\t\t\tvar group = {\r\n\t\t\t\t\"groupName\" : genericName+\" \"+ genericPos,\r\n\t\t\t\t\"name\" : genericName+\" \"+ genericPos,\r\n\t\t\t\t\"id\" : pos,\r\n\t\t\t\t\"expanded\" : true\r\n\t\t\t};\r\n\t\t\tthis._groupList.push(group);\r\n\t\t\treturn group;\r\n\t\t}\r\n\t},\r\n\r\n\tgetActiveGroup : function() {\r\n\t\tvar groupLast = this._groupList[this._groupList.length - 1];\r\n\t\tvar notExpanded = false;\r\n\t\tif (groupLast.expanded==true || groupLast.expanded==\"true\") {\r\n\t\t\treturn groupLast;\r\n\t\t} else {\r\n\t\t\tfor (j=0; j < this._groupList.length;j++ ){\r\n\t\t\t\tvar _gr=this._groupList[j];\r\n\t\t\t\tif (_gr.expanded==true || _gr.expanded==\"true\") {\r\n\t\t\t\t\tnotExpanded = true;\r\n\t\t\t\t\treturn _gr;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!notExpanded) {\r\n\t\t\treturn groupLast;\r\n\t\t}\r\n\t},\r\n\r\n\tgetGroupWhereIBelong : function() {\r\n\t\tvar pos = this._groupList.length;\r\n\t\tif (pos > 0) { // estic afegint una capa però ja existeix un\r\n\t\t\t// grup\r\n\t\t\treturn this._groupList[this._groupList.length - 1];\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t},\r\n\r\n\t_addGroupFromScratch : function() {\r\n\t\tvar container = this._overlaysList;\r\n\t\tvar obj = {};\r\n\t\tvar group = this._createGroupFromScratch(0);\r\n\r\n\t\tobj.group = group;\r\n\t\tthis._addGroup(container, obj, null);\r\n\t\tif (getModeMapa()) {\r\n\t\t\tupdateEditableElements();\r\n\t\t\trefreshSortablesElements();\r\n\t\t}\r\n\t},\r\n\r\n\t_addGroupFromObject : function(group) {\r\n\t\tif (group) {\r\n\t\t\tvar container = this._overlaysList;\r\n\t\t\tvar obj = {};\r\n\t\t\tobj.group = group;\r\n\t\t\tvar trobat = false;\r\n\t\t\tfor (g in this._groupList) {\r\n\t\t\t\tif (this._groupList[g].id == group.id) {\r\n\t\t\t\t\ttrobat = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!trobat) {\r\n\t\t\t\tthis._groupList.push(obj.group);\r\n\t\t\t}\r\n\t\t\tthis._addGroup(container, obj, null);\r\n\t\t}\r\n\t},\r\n\r\n\t_addGroup : function(container, _obj, _menu_item_checkbox) {\r\n\t\tvar _id;\r\n\t\tvar obj;\r\n\t\tif (_obj.group) {\r\n\t\t\t_id = _obj.group.id;\r\n\t\t\tobj = _obj;\r\n\t\t} else if (_obj.layer) {\r\n\t\t\tobj = _obj.layer.options;\r\n\t\t\ttry{\r\n\t\t\t_id = _obj.layer.options.group.id;\r\n\t\t\t}catch(Err){\r\n\r\n\t\t\t_id= this._domGroups.length -1;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t_id = null;\r\n\t\t}\r\n\t\tif (_id >= 0) {\r\n\t\t\tvar groupContainer = this._domGroups[_id];\r\n\t\t\tif (!groupContainer) {\r\n\t\t\t\tgroupContainer = document.createElement('div');\r\n\t\t\t\tgroupContainer.id = 'leaflet-control-accordion-layers-'+ _id;\r\n\t\t\t\tgroupContainer.className = 'leaflet-control-accordion-layers';\r\n\t\t\t\t// verify if group is expanded\r\n\t\t\t\tvar s_expanded = obj.group.expanded ? ' checked = \"true\" ': '';\r\n\t\t\t\t// verify if type is exclusive\r\n\t\t\t\tvar s_type_exclusive = this.options.exclusive ? ' type=\"radio\" '\r\n\t\t\t\t\t: ' type=\"checkbox\" ';\r\n\t\t\t\tinputElement = '<input id=\"ac' + _id\r\n\t\t\t\t\t+ '\" name=\"accordion-' + _id\r\n\t\t\t\t\t+ '\" class=\"menu expanded_input\" ' + s_expanded\r\n\t\t\t\t\t+ s_type_exclusive + '/>';\r\n\t\t\t\tinputLabel = document.createElement('label');\r\n\t\t\t\tvar _for = document.createAttribute('for');\r\n\t\t\t\t_for.value = \"ac\" + _id;\r\n\t\t\t\tinputLabel.setAttributeNode(_for);\r\n\r\n\t\t\t\tvar spanGroup = document.createElement('span');\r\n\t\t\t\tspanGroup.innerHTML = obj.group.name;\r\n\t\t\t\tvar classExpanded = 'glyphicon glyphicon-triangle-bottom label_gl';\r\n\t\t\t\tif (!obj.group.expanded) {\r\n\t\t\t\t\tclassExpanded = 'glyphicon glyphicon-triangle-right label_gl';\r\n\t\t\t\t}\r\n\t\t\t\tinputLabel.id = 'lbl_ac_' + _id;\r\n\r\n\t\t\t\tif(obj.group.name.indexOf(this._socInstamapsVell)==-1){\r\n\t\t\t\t\tinputLabel.className = 'label_ac';\r\n\t\t\t\t}else{\r\n\t\t\t\t\tinputLabel.className = 'label_ac_novisible';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar _i = document.createElement('i');\r\n\t\t\t\t_i.id = '_i_' + _id;\r\n\t\t\t\t_i.className = classExpanded\r\n\t\t\t\tinputLabel.appendChild(_i);\r\n\t\t\t\t\tL.DomEvent.on(inputLabel, 'click', this._onExpandGroup,this);\r\n\t\t\t\tspanGroup.className = 'span_ac editable';\r\n\t\t\t\tspanGroup.id = 'ac' + _id;\r\n\t\t\t\tspanGroup.groupId = _id;\r\n\t\t\t\tspanGroup.groupName = obj.group.name;\r\n\t\t\t\tinputLabel.appendChild(spanGroup);\r\n\r\n\t\t\t\tif (getModeMapa()) {\r\n\t\t\t\t\tvar col = L.DomUtil.create('span', \r\n\t\t\t\t\t\t'tema_verd glyphicon glyphicon-remove group-conf');\r\n\t\t\t\t\tcol.id = 'mv-' + _id;\r\n\t\t\t\t\tcol.groupId = _id;\r\n\t\t\t\t\tcol.groupName = obj.group.name;\r\n\t\t\t\t\tL.DomEvent.on(col, 'click', this._onRemoveGroup,this);\r\n\t\t\t\t\tinputLabel.appendChild(col);\r\n\r\n\t\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\t\tplacement : 'left',\r\n\t\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\t\ttitle : window.lang.translate(\"Esborrar grup\")\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tvar col = L.DomUtil.create('span',\r\n\t\t\t\t\t\t'tema_verd_move glyphicon glyphicon-move group-conf');\r\n\t\t\t\t\tcol.id = 'rv-' + _id;\r\n\t\t\t\t\tcol.groupName = obj.group.name;\r\n\t\t\t\t\tcol.groupId = _id;\r\n\t\t\t\t\tinputLabel.appendChild(col);\r\n\t\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\t\tplacement : 'left',\r\n\t\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\t\ttitle : window.lang.translate(\"Moure grup\")\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tarticle = document.createElement('ol');\r\n\t\t\t\tarticle.className = 'ac-large';\r\n\t\t\t\tif (_menu_item_checkbox) {\r\n\t\t\t\t\tarticle.appendChild(_menu_item_checkbox);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// process options of ac-large css class - to\r\n\t\t\t\t// options.group_maxHeight property\r\n\t\t\t\tif (this.options.group_maxHeight) {\r\n\t\t\t\t\tarticle.style.maxHeight = this.options.group_maxHeight;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tgroupContainer.innerHTML = inputElement;\r\n\t\t\t\tgroupContainer.appendChild(inputLabel);\r\n\t\t\t\tgroupContainer.appendChild(article);\r\n\r\n\t\t\t\tvar supraLI = document.createElement('li');\r\n\t\t\t\tsupraLI.appendChild(groupContainer);\r\n\r\n\t\t\t\tcontainer.appendChild(supraLI);\r\n\r\n\t\t\t\tthis._domGroups[_id] = groupContainer;\r\n\t\t\t} else {\r\n\t\t\t\tif (_menu_item_checkbox) {\r\n\t\t\t\t\tgroupContainer.lastElementChild.appendChild(_menu_item_checkbox);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_addLayer : function(layer, name, overlay, groupLeafletId) {\r\n\t\tvar id = L.Util.stamp(layer);\r\n\t\tif (groupLeafletId) {\r\n\t\t\tthis._layers[groupLeafletId]._layers[id] = {\r\n\t\t\t\tlayer : layer,\r\n\t\t\t\tname : name,\r\n\t\t\t\toverlay : overlay,\r\n\t\t\t\tsublayer : true,\r\n\t\t\t\tlayerIdParent : groupLeafletId\r\n\t\t\t};\r\n\t\t} else {\r\n\t\t\tthis._layers[id] = {\r\n\t\t\t\tlayer : layer,\r\n\t\t\t\tname : name,\r\n\t\t\t\toverlay : overlay,\r\n\t\t\t\tsublayer : false,\r\n\t\t\t\t_layers : {}\r\n\t\t\t};\r\n\t\t}\r\n\t\tvar group = layer.options.group;\r\n\t\tvar _heCreat = false;\r\n\t\tvar _heCreatFromScratch=false;\r\n\t\tif (!group) {\r\n\t\t\tgroup = this._createGroupFromScratch(1);\r\n\t\t\t_heCreat = true;\r\n\t\t\t_heCreatFromScratch=true;\r\n\t\t}\r\n\t\tvar groupId;\r\n\t\tif (group) {\r\n\t\t\t//var groupId = this._groupList.indexOf(group);\r\n\t\t\tif (undefined !=group.id) {\r\n\t\t\t\tgroupId = group.id;\r\n\t\t\t\tvar trobat = false;\r\n\t\t\t\tfor (g in this._groupList) {\r\n\t\t\t\t\tif (this._groupList[g].id == group.id) {\r\n\t\t\t\t\t\ttrobat = true;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!trobat) {\r\n\t\t\t\t\tthis._groupList.push(group);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\t// if not find the group search for the name\r\n\t\t\t/*if (groupId === -1) {\r\n\t\t\t\tfor (g in this._groupList) {\r\n\t\t\t\t\tif (this._groupList[g].groupName == group.groupName) {\r\n\t\t\t\t\t\tgroupId = g;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}*/\r\n\r\n\t\t\tif (groupId === -1) {\r\n\t\t\t\tgroupId = this._groupList.push(group) - 1;\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\t\t\tif (this._layers[id]) {\r\n\t\t\t\tthis._layers[id].layer.options.group = {\r\n\t\t\t\t\tname : group.groupName,\r\n\t\t\t\t\tgroupName : group.groupName,\r\n\t\t\t\t\tid : groupId,\r\n\t\t\t\t\tz_order : this._layers[id].layer.options.zIndex,\r\n\t\t\t\t\texpanded : group.expanded\r\n\t\t\t\t};\r\n\r\n\t\t\t\tif (_heCreat) {\r\n\t\t\t\t\tif (getModeMapa()) {\r\n\t\t\t\t\t\tif(_heCreatFromScratch){\r\n\t\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\t\tbusinessId : this._layers[id].layer.options.businessId, // url('?businessid')\r\n\t\t\t\t\t\t\t\tuid : Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\toptions : JSON.stringify(this._layers[id].layer.options.group)\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t// Ara desactivat\r\n\t\t\t\t\t\t\tupdateGroupsLayerGroup(data, null);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this.options.autoZIndex && layer.setZIndex && !layer.options.hasOwnProperty(\"zIndex\")) {\r\n\t\t\tthis._lastZIndex++;\r\n\t\t\tlayer.setZIndex(this._lastZIndex);\r\n\t\t}\r\n\t\telse if(layer.options.hasOwnProperty(\"zIndex\"))\r\n\t\t{\r\n\r\n\t\t\tthis._lastZIndex = (layer.zIndex > this._lastZIndex) ? layer.zIndex : this._lastZIndex;\r\n\r\n\t\t}\r\n\t},\r\n\r\n\t_update : function(makeUpdate) {\r\n\t\tvar self = this;\r\n\t\tvar redraw = makeUpdate || self.options.autoUpdate;\r\n\t\tif(redraw){\r\n\t\t\tif (!self._container) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tself._domGroupsTMP = self._groupList;\r\n\t\t\tself._groupList = [];\r\n\t\t\tself._baseLayersList.innerHTML = '';\r\n\t\t\tself._overlaysList.innerHTML = '';\r\n\t\t\tself._domGroups.length = 0;\r\n\r\n\t\t\tself._domGroupsTMP = sortByKey(self._domGroupsTMP, \"id\");\r\n\t\t\tself._groupList = sortByKey(self._groupList, \"id\");\t\t\t\r\n\t\t\t\r\n\t\t\tself._domGroupsTMP.forEach(function(item, index, array) {\r\n\t\t\t\tself._addGroupFromObject(item);\r\n\t\t\t});\r\n\r\n\t\t\tvar baseLayersPresent = false, overlaysPresent = false, i, obj;\r\n\t\t\tvar layerArray=[];\r\n\t\t\tfor (i in self._layers) {\r\n\t\t\t\tlayerArray.push(self._layers[i]);\r\n\t\t\t}\r\n\t\t\tlayerArray = sortByKeyPath(layerArray, \"zIndex\");\r\n\t\t\t\r\n\t\t\tfor (i in layerArray) {\r\n\t\t\t\tobj = layerArray[i];\r\n\t\t\t\tself._addItem(obj);\r\n\t\t\t\toverlaysPresent = overlaysPresent || obj.overlay;\r\n\t\t\t\tbaseLayersPresent = baseLayersPresent || !obj.overlay;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tself._hideSpiner();\r\n\t\t\t\r\n\t\t\tmap.fire('onRedrawLegend', self._mapConfig);\r\n\t\t\t$.publish('onRedrawLegend', self._mapConfig);\r\n\t\t}\r\n\t},\r\n\t\r\n\tforceUpdate: function(autoUpdate){\r\n\t\tif(autoUpdate){\r\n\t\t\tthis.options.autoUpdate = true;\r\n\t\t}\r\n\t\tthis._update(true);\r\n\t},\r\n\r\n\t_diferences : function(a1, a2) {\r\n\t\tvar a = [], diff = [];\r\n\t\tfor (var i = 0; i < a1.length; i++)\r\n\t\t\ta[a1[i]] = true;\r\n\t\tfor (var i = 0; i < a2.length; i++)\r\n\t\t\tif (a[a2[i]])\r\n\t\t\t\tdelete a[a2[i]];\r\n\t\t\telse\r\n\t\t\t\ta[a2[i]] = true;\r\n\t\tfor ( var k in a)\r\n\t\t\tdiff.push(parseInt(k));\r\n\t\treturn diff;\r\n\t},\r\n\r\n\t_onLayerChange : function(e) {\r\n\t\tvar obj = this._layers[L.Util.stamp(e.layer)];\r\n\t\tif (!obj) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this._handlingClick) {\r\n\t\t\tthis._update();\r\n\t\t}\r\n\t\t//parece que esta parte de código no se usa.\r\n\t\tvar type = obj.overlay ? (e.type === 'layeradd' ? 'overlayadd'\r\n\t\t\t: 'overlayremove')\r\n\t\t\t: (e.type === 'layeradd' ? 'baselayerchange' : null);\r\n\t\tif (type) {\r\n\t\t\tthis._map.fire(type, obj);\t\t\t\t\t\r\n\t\t}\r\n\t},\r\n\r\n\t_createRadioElement : function(name, checked) {\r\n\t\tvar radioHtml = '<input type=\"radio\" class=\"leaflet-control-layers-selector\" name=\"'\r\n\t\t\t+ name + '\"';\r\n\t\tif (checked) {\r\n\t\t\tradioHtml += ' checked=\"checked\"';\r\n\t\t}\r\n\t\tradioHtml += '/>';\r\n\t\tvar radioFragment = document.createElement('div');\r\n\t\tradioFragment.innerHTML = radioHtml;\r\n\t\treturn radioFragment.firstChild;\r\n\t},\r\n\r\n\t_addItem : function(obj) {\r\n\t\tvar _menu_item_checkbox = document.createElement('li'), \r\n\t\tinput, checked = this._map.hasLayer(obj.layer), \r\n\t\tcontainer;\t\r\n\t\t\r\n\t\tvar _leaflet_input = document.createElement('div');\r\n\t\tif (obj.overlay) {\r\n\t\t\t_menu_item_checkbox.className = \"leaflet-row\";\r\n\t\t\t_menu_item_checkbox.id = 'LI-'+ obj.layer.options.businessId;\r\n\r\n\t\t\tinput = document.createElement('input');\r\n\t\t\tinput.id = 'input-' + obj.layer.options.businessId;\r\n\t\t\tinput.type = 'checkbox';\r\n\t\t\tinput.className = 'checkbox_styled hide leaflet-control-layers-selector';\r\n\t\t\t\r\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\r\n\t\t\t\tif (obj.layer.options.wmstime == true) {\r\n\t\t\t\t\tinput.className = 'checkbox_time hide leaflet-control-layers-selector';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinput.defaultChecked = checked;\r\n\t\t} else {\r\n\t\t\tinput = this._createRadioElement('leaflet-base-layers', checked);\r\n\t\t}\r\n\r\n\t\t_leaflet_input.className = \"leaflet-input\";\r\n\t\tinput.layerId = L.Util.stamp(obj.layer);\r\n\t\tL.DomEvent.on(input, 'click', this._onInputClick, this);\r\n\t\tvar label_for = document.createElement('label');\r\n\t\tvar _for = document.createAttribute('for');\r\n\t\t_for.value = 'input-' + obj.layer.options.businessId;\r\n\t\tlabel_for.setAttributeNode(_for);\r\n\t\t_leaflet_input.appendChild(input);\r\n\t\t_leaflet_input.appendChild(label_for);\r\n\r\n\t\tvar _leaflet_name = document.createElement('div');\r\n\t\t_leaflet_name.className = 'leaflet-name';\r\n\t\tvar _label_buit = document.createElement('label');\r\n\t\tvar nomCapa = document.createElement('span');\r\n\r\n\t\t\r\n\t\tvar layerName=obj.name;\t\t\t\r\n    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\r\n \r\n\t\tnomCapa.innerHTML = ' ' + layerName;\r\n\t\t//nomCapa.innerHTML = ' ' + obj.name;\r\n\t\tnomCapa.className = 'editable';\r\n\t\tnomCapa.id = input.layerId;\r\n\r\n\t\tif(obj.layer.error){\r\n\t\t\t_label_buit.className = 'error';\r\n\t\t}\r\n\t\t\r\n\t\t_label_buit.appendChild(nomCapa);\r\n\r\n\t\tif (obj.layer.options.tipus == t_visualitzacio\r\n\t\t\t\t|| obj.layer.options.tipus == t_tematic\r\n\t\t\t\t|| obj.layer.options.tipus == t_dades_obertes\r\n\t\t\t\t|| obj.layer.options.tipus == t_json\r\n\t\t\t\t|| obj.layer.options.tipus == t_url_file) {\r\n\t\t\tvar count = document.createElement('span');\r\n\t\t\tcount.className = 'layer-count';\r\n\t\t\tcount.id = 'count-' + obj.layer.options.businessId;\r\n\t\t\tcount.innerHTML = ' (' + obj.layer.getLayers().length + ')';\r\n\t\t\t_label_buit.appendChild(count);\r\n\t\t}\r\n\r\n\t\t_leaflet_name.appendChild(_label_buit);\r\n\t\t_menu_item_checkbox.appendChild(_leaflet_input);\r\n\t\t_menu_item_checkbox.appendChild(_leaflet_name);\r\n\r\n\t\tvar container;\r\n\t\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html') != -1);\r\n\r\n\t\tvar col;\r\n\r\n\t\tif (obj.overlay) {\r\n\t\t\t// Icona conf Sempre\r\n\t\t\tcol = L.DomUtil.create('div', 'leaflet-conf glyphicon glyphicon-cog opcio-conf');\r\n\t\t\tL.DomEvent.on(col, 'click', this._showOptions, this);\r\n\t\t\tcol.layerId = input.layerId;\r\n\t\t\t_menu_item_checkbox.appendChild(col);\r\n\r\n\t\t\t// Icona remove només Edicio\r\n\t\t\tif (getModeMapa()) {\r\n\t\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-remove glyphicon glyphicon-remove subopcio-conf');\r\n\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\tL.DomEvent.on(col, 'click', this._onRemoveClick, this);\r\n\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t\t\t}\r\n\t\t\t// Icona Taula de Dades Sempre\r\n\t\t\tif ((obj.layer.options.source || obj.layer.options.geometryType==\"marker\" ||  obj.layer.options.geometryType==\"polyline\" \r\n\t\t\t\t||  obj.layer.options.geometryType==\"polygon\") && !obj.layer.options.dinamic ) {\r\n\t\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t\t'data-table-'+ obj.layer.options.businessId+ ' leaflet-data-table glyphicon glyphicon-list-alt');\r\n\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\tL.DomEvent.on(col, 'click', this._onOpenDataTable, this);\r\n\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t\t\t}\r\n\t\t\t// Icona Descàrrega sempre\r\n\t\t\t//Issue #467: S'ha de respectar el que es selecciona al publicar sobre si una capa és descarregable o no.\r\n\t\t\tif (getModeMapa()) {\r\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) == -1\r\n\t\t\t\t\t&& obj.layer.options.tipus.indexOf(t_geojsonvt) == -1) {\r\n\t\t\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-download glyphicon glyphicon-save subopcio-conf');\r\n\t\t\t\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\t\t\t\tL.DomEvent.on(col, 'click', this._onDownloadClick, this);\r\n\t\t\t\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) == -1\r\n\t\t\t\t\t&& obj.layer.options.tipus.indexOf(t_geojsonvt) == -1) {\r\n\t\t\t\t\tif(downloadableData[obj.layer.options.businessId]){\r\n\t    \t\t\t\tif(downloadableData[obj.layer.options.businessId][0].chck) {\r\n\t\t\t\t\t\t\tcol = L.DomUtil\r\n\t\t\t\t\t\t\t\t\t.create(\r\n\t\t\t\t\t\t\t\t\t\t\t'div',\r\n\t\t\t\t\t\t\t\t\t\t\t'conf-'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ obj.layer.options.businessId\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ ' leaflet-download glyphicon glyphicon-save subopcio-conf');\r\n\t\t\t\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\t\t\t\tL.DomEvent\r\n\t\t\t\t\t\t\t\t\t.on(col, 'click', this._onDownloadClick, this);\r\n\t\t\t\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t    \t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\t// Icona Transparència\r\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\r\n\t\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-trans glyphicon glyphicon-adjust subopcio-conf');\r\n\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\tL.DomEvent.on(col, 'click', this._onTransparenciaClick,this);\r\n\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\tplacement : 'bottom',\r\n\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\ttitle : window.lang.translate(\"Transparència\")\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\t// Icona Moure només Edicio\r\n\t\t\tif (getModeMapa()) {\r\n\t\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-move glyphicon glyphicon-move subopcio-conf');\r\n\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\tplacement : 'bottom',\r\n\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\ttitle : window.lang.translate(\"Moure\")\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tcol = L.DomUtil.create('div',\r\n\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-zoom glyphicon glyphicon-search subopcio-conf');\r\n\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\tL.DomEvent.on(col, 'click', this._onZoomClick,this);\r\n\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\r\n\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\tplacement : 'bottom',\r\n\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\ttitle : window.lang.translate(\"Zoom a la capa\")\r\n\t\t\t\t});\r\n\t\t\t\r\n\t\t\tif (getModeMapa()) {\r\n\t\t\t\tif ((obj.layer.options.tipus == t_visualitzacio\r\n\t\t\t\t\t\t|| obj.layer.options.tipus == t_url_file\r\n\t\t\t\t\t\t|| obj.layer.options.tipus == t_json) && !obj.layer.options.dinamic) {\r\n\t\t\t\t\tcol = L.DomUtil\r\n\t\t\t\t\t\t\t.create(\r\n\t\t\t\t\t\t\t\t\t'div',\r\n\t\t\t\t\t\t\t\t\t'conf-'\r\n\t\t\t\t\t\t\t\t\t\t\t+ obj.layer.options.businessId\r\n\t\t\t\t\t\t\t\t\t\t\t+ ' leaflet-zoom glyphicon glyphicon-font subopcio-conf');\r\n\t\t\t\t\tcol.layerId = input.layerId;\r\n\t\t\t\t\t// L.DomEvent.on(col, 'click', this._onDownClick, this);\r\n\t\t\t\t\tL.DomEvent.on(col, 'click', this._onEtiquetaClick,\r\n\t\t\t\t\t\t\tthis);\r\n\t\t\t\t\t_menu_item_checkbox.appendChild(col);\r\n\r\n\t\t\t\t\t$(col).tooltip({\r\n\t\t\t\t\t\tplacement : 'bottom',\r\n\t\t\t\t\t\tcontainer : 'body',\r\n\t\t\t\t\t\ttitle : window.lang.translate(\"Etiquetes de la capa\")\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tcontainer = this._overlaysList;\r\n\t\t} else {\r\n\t\t\tcontainer = this._baseLayersList;\r\n\t\t}\r\n\r\n\t\tvar sublayers = obj._layers;\r\n\t\tfor (j in sublayers) {\r\n\t\t\tvar row_sublayer = this._createSubItem(sublayers[j], input.layerId, modeMapa);\r\n\t\t\t_menu_item_checkbox.appendChild(row_sublayer);\r\n\t\t}\r\n\r\n\t\tthis._addGroup(container, obj, _menu_item_checkbox);\r\n\r\n\t\t// Afegim tooltips\r\n\t\t$(\".data-table-\" + obj.layer.options.businessId\r\n\t\t\t+ \".leaflet-data-table\").tooltip({\r\n\t\t\tplacement : 'bottom',\r\n\t\t\tcontainer : 'body',\r\n\t\t\ttitle : window.lang.translate(\"dades\")\r\n\t\t});\r\n\r\n\t\t$(\".opcio-conf\").tooltip({\r\n\t\t\tplacement : 'bottom',\r\n\t\t\tcontainer : 'body',\r\n\t\t\ttitle : window.lang.translate(\"opcions\")\r\n\t\t});\r\n\r\n\t\tif (getModeMapa()){\r\n\t\t\ttry{\r\n\t\t\t\tupdateEditableElements();\r\n\t\t\t\trefreshSortablesElements();\r\n\t\t\t\tmap.fireEvent('addItemFinish');\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,\"add\",true);}\t\r\n\t\t\t\t\r\n\t\t\t\t//generallegendaMapaEdicio();\r\n\t\t\t\t\r\n\t\t\t}catch(Err){\r\n\t\t\t\tupdateEditableElements();\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn _menu_item_checkbox;\r\n\t},\r\n\t\r\n\t_createSubItem : function(sublayer, layerIdParent, modeMapa) {\r\n\t\tvar row_sublayer = L.DomUtil.create('div',\r\n\t\t\t\t'leaflet-row leaflet-subrow');\r\n\r\n\t\tvar label_sublayer, \r\n\t\t\tinput_sublayer, checked = this._map.hasLayer(sublayer.layer);\r\n\r\n\t\tif(sublayer.layer.error){\r\n\t\t\tlabel_sublayer = L.DomUtil.create('label', 'error');\r\n\t\t}else{\r\n\t\t\tlabel_sublayer = L.DomUtil.create('label', '');\r\n\t\t}\r\n\t\tlabel_sublayer.id =  'lblsub-'+ sublayer.layer.options.businessId;\t\t\r\n\t\t\t\t\r\n\t\tinput_sublayer = L.DomUtil.create('input');\r\n\t\tinput_sublayer.id = 'input-'\r\n\t\t\t\t+ sublayer.layer.options.businessId;\r\n\t\tinput_sublayer.type = 'checkbox';\r\n\t\tinput_sublayer.className = 'checkbox_eye hide leaflet-control-layers-selector';\r\n\t\tinput_sublayer.defaultChecked = checked;\r\n\r\n\t\tinput_sublayer.layerId = L.stamp(sublayer.layer);\r\n\t\tinput_sublayer.layerIdParent = layerIdParent; // input.layerId;\r\n\r\n\t\tL.DomEvent.on(input_sublayer, 'click', this._onInputClick, this);\r\n\r\n\t\tvar name_sublayer = document.createElement('span');\r\n\t\tname_sublayer.className = 'editable';\r\n\t\tname_sublayer.idParent = layerIdParent;\r\n\t\tname_sublayer.id = L.stamp(sublayer.layer);\r\n\t\tvar layerName=sublayer.name;\t\t\t\r\n    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\t\r\n \r\n\t\tname_sublayer.innerHTML = ' ' + layerName;\r\n\r\n\t\tvar col_sublayer = L.DomUtil.create('div', 'leaflet-input');\r\n\t\tvar label_for = document.createElement('label');\r\n\t\tvar _for = document.createAttribute('for');\r\n\t\t_for.value = 'input-' + sublayer.layer.options.businessId;\r\n\t\tlabel_for.setAttributeNode(_for);\r\n\t\tcol_sublayer.appendChild(input_sublayer);\r\n\t\tcol_sublayer.appendChild(label_for);\r\n\r\n\t\trow_sublayer.appendChild(col_sublayer);\r\n\t\tcol_sublayer = L.DomUtil.create('div', 'leaflet-name');\r\n\t\tcol_sublayer.appendChild(label_sublayer);\r\n\t\trow_sublayer.appendChild(col_sublayer);\r\n\t\tlabel_sublayer.appendChild(name_sublayer);\r\n\r\n\t\tif (modeMapa) {\r\n\t\t\tcol_sublayer = L.DomUtil.create('span','leaflet-remove glyphicon glyphicon-remove opcio-conf');\r\n\t\t\tL.DomEvent.on(col_sublayer, 'click', this._onRemoveClick, this);\r\n\t\t\tcol_sublayer.layerId = input_sublayer.layerId;\r\n\t\t\tcol_sublayer.layerIdParent = layerIdParent;\r\n\t\t\trow_sublayer.appendChild(col_sublayer);\r\n\t\t\t\t\r\n\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(sublayer.layer.options,\"add\",true);}\t\r\n\t\t}\r\n\t\treturn row_sublayer;\r\n\t},\r\n\r\n\tgetCountActiveLayers:function(){\r\n\t\tvar i, input, obj, \r\n\t\tinputs = this._form.getElementsByTagName('input'), \r\n\t\tinputsLen = inputs.length;\r\n\t\tvar j=0;\r\n\t\tfor (i = 0; i < inputsLen; i++) {\r\n\t\t\tinput = inputs[i];\r\n\t\t\tif (!input.layerId) {\r\n\t\t\t\tcontinue;\r\n\t\t\t} else{\r\n\t\t\t\t\r\n\t\t\t\tif (input.checked){\r\n\t\t\t\t\tj=j+1;\r\n\t\t\t\t\tobj=input.id.replace(\"input-\", \"\");\r\n\t\t\t\t}\t\r\n\t\t\t\t\t\r\n\t\t\t}\r\n\t\t\r\n\t\t}\r\n\t\treturn {total:j, lastActive:obj};\r\n\t},\t\r\n\t\r\n\t_onInputClick : function(event) {\r\n\t\tvar i, input, obj, \r\n\t\tinputs = this._form.getElementsByTagName('input'), \r\n\t\tinputsLen = inputs.length;\r\n\r\n\t\tthis._handlingClick = true;\r\n\t\tvar checkHeat = false;\r\n\t\tvar id, parentId;\r\n\r\n\t\tvar currentbid = arguments[0].currentTarget.id.replace(\"input-\", \"\");\r\n\t\t\r\n\t\t// tractament en cas heatmap\r\n\t\tif (arguments[0].currentTarget.layerIdParent) {\r\n\t\t\tid = arguments[0].currentTarget.layerId;\r\n\t\t\tparentId = arguments[0].currentTarget.layerIdParent;\r\n\t\t\tcheckHeat = isHeat(controlCapes._layers[parentId]._layers[id])\r\n\t\t\t\t\t&& arguments[0].currentTarget.value == \"on\";\r\n\t\t}\r\n\r\n\t\tvar _timeLayers = [];\r\n\t\tvar isLegendLoad=false;\r\n\t\t\r\n\t\tfor (i = 0; i < inputsLen; i++) {\r\n\t\t\tinput = inputs[i];\r\n\t\t\tif (!input.layerId) {\r\n\t\t\t\tcontinue;\r\n\t\t\t} else if (!input.layerIdParent) {\r\n\t\t\t\tobj = this._layers[input.layerId];\r\n\t\t\t} else {\r\n\t\t\t\tobj = this._layers[input.layerIdParent]._layers[input.layerId];\r\n\t\t\t}\r\n\r\n\t\t\t// Si la capa clickada es  heatmap i s'ha d'activar, i la que\r\n\t\t\t// estem tractant tb, no s'ha de mostrar\r\n\t\t\tif (isHeat(obj) && checkHeat && obj.layer._leaflet_id != id) {\r\n\t\t\t\tinput.checked = false;\r\n\t\t\t}\r\n\t\t\t// valida tipus CapaTime\r\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\r\n\t\t\t\tif (obj.layer.options.wmstime == true) {\r\n\t\t\t\t\t_timeLayers.push(input);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(currentbid === obj.layer.options.businessId){\r\n\t\t\t\t\r\n\t\t\t\t\t//$.publish('activaLegendTab',{id: currentbid, activo: input.checked});\r\n\t\t\t\t\tthis._map.fire('activaLegendTab',{id: currentbid, activo: input.checked});\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t// Afegir\r\n\t\t\tvar canSpiderify = (obj.layer.options.tipusRang == tem_clasic || \r\n\t\t\t\tobj.layer.options.tipusRang == tem_simple || \r\n\t\t\t\tobj.layer.options.tipusRang == tem_origen);\r\n\t\t\tif (input.checked && !this._map.hasLayer(obj.layer)) {\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tthis._map.addLayer(obj.layer);\r\n\r\n\t\t\t\tif(this._map.hasOwnProperty(\"oms\") && obj.layer._layers ){\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\t//Add the markers to Spiderify\r\n\t\t\t\t\tvar keys = Object.keys(obj.layer._layers);\r\n\t\t\t\t\tvar num = this._map.oms.markers.length;\r\n\t\t\t\t\tfor(var j=0; j<keys.length; ++j)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tvar aux = obj.layer._layers[keys[j]];\r\n\t\t\t\t\t\tif(canSpiderify)\r\n\t\t\t\t\t\t\tthis._map.oms.addMarker(aux);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(num != this._map.oms.markers.length)\r\n\t\t\t\t\t\tthis._map.oms.unspiderfy();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//Mostrem els labels\r\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\r\n\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\r\n\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\t\r\n\t\t\t\t\t\tvar zoomInicial = \"2\";\r\n\t\t\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\r\n\t\t\t\t \t\tvar zoomFinal = \"19\";\r\n\t\t\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\r\n\t\t\t\t \t\t\r\n\t\t\t\t \t\tif ( map.getZoom()>=zoomInicial &&  map.getZoom() <= zoomFinal) {//mostrem labels\r\n\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\r\n\t\t\t\t\t\t\t\tif (lay.label!=undefined) {\r\n\t\t\t\t\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(1);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif(lay._showLabel){\r\n\t\t\t\t                        lay._showLabel({latlng: lay.label._latlng});\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t \t\t }\r\n\t\t\t\t \t\t else {//amaguem labels\r\n\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\r\n\t\t\t\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\t\t\t\tlay.label.setOpacity(0);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t }\t\t\t\t\t\t\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_vis_wms) != -1) {\r\n\t\t\t\t\tvar optionsUtfGrid = {\r\n\t\t\t\t\t\tlayers : obj.layer.options.businessId,\r\n\t\t\t\t\t\tcrs : L.CRS.EPSG4326,\r\n\t\t\t\t\t\tsrs : \"EPSG:4326\",\r\n\t\t\t\t\t\ttransparent : true,\r\n\t\t\t\t\t\tformat : 'utfgrid',\r\n\t\t\t\t\t\tnom : obj.layer.options.nom + \" utfgrid\",\r\n\t\t\t\t\t\ttipus : obj.layer.options.tipus,\r\n\t\t\t\t\t\tbusinessId : obj.layer.options.businessId\r\n\t\t\t\t\t};\r\n\t\t\t\t\tvar utfGrid = createUtfGridLayer(obj.layer._url, optionsUtfGrid);\r\n\t\t\t\t\tthis._map.addLayer(utfGrid);\r\n\t\t\t\t\tobj.layer.options.utfGridLeafletId = utfGrid._leaflet_id;\r\n\t\t\t\t}\r\n\t\t\t\t// Si hem activat capa de tipus tematic categories,\r\n\t\t\t\t// mostrem la seva llegenda\r\n\t\t\t\tif (currentbid == obj.layer.options.businessId\r\n\t\t\t\t\t\t&& obj.layer.options.tipusRang\r\n\t\t\t\t\t\t&& (obj.layer.options.tipusRang == tem_clasic || obj.layer.options.tipusRang == tem_size)) {\r\n\t\t\t\t\t//thisLoadMapLegendEdicio(obj.layer);\r\n\t\t\t\t\tisLegendLoad=true;\r\n\t\t\t\t}\r\n\t\t\t\telse if (obj.layer.options.tipus==\"wms\"){//per WMS tb s'ha d'omplir\r\n\t\t\t\t\t//thisLoadMapLegendEdicio(obj.layer);\r\n\t\t\t\t\tisLegendLoad=true;\r\n\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\telse if (!isLegendLoad){\r\n\t\t\t\t\t//thisEmptyMapLegendEdicio(obj.layer,true);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tif (obj.layer.options.dinamic && (obj.layer.options.tem == tem_clasic || obj.layer.options.tem == tem_size)) {\r\n\t\t\t\t\t//thisLoadMapLegendEdicioDinamic(obj.layer);\r\n\t\t\t\t\tisLegendLoad=true;\r\n\t\t\t\t}\r\n\t\t\t\telse if(!isLegendLoad){\r\n\r\n\t\t\t\t//thisEmptyMapLegendEdicio(obj.layer,true);\r\n\t\t\t\t}\r\n\t\t\t\t//mirem vista 3D\r\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,'display',true);}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t} else if (!input.checked && this._map.hasLayer(obj.layer)) {\r\n\t\t\t\t//Amaguem els labels\r\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\r\n\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\r\n\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\r\n\t\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\t\tlay.label.setOpacity(0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\t\r\n\t\t\t\t}\r\n\t\t\t\t// Si es vis_wms, hem d'eliminar tb la capa utfgrid\r\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_vis_wms) != -1) {\r\n\t\t\t\t\tvar utfGridLayer = this._map._layers[obj.layer.options.utfGridLeafletId];\r\n\t\t\t\t\tthis._map.removeLayer(utfGridLayer);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._map.removeLayer(obj.layer);\r\n\r\n\t\t\t\tif(this._map.hasOwnProperty(\"oms\") && obj.layer._layers ){\r\n\t\t\t\t\r\n\t\t\t\t\t//Remove the markers from Spiderify\r\n\t\t\t\t\tvar keys = Object.keys(obj.layer._layers);\r\n\t\t\t\t\tvar num = this._map.oms.markers.length;\r\n\t\t\t\t\tfor(var j=0; j<keys.length; ++j)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tvar aux = obj.layer._layers[keys[j]];\r\n\t\t\t\t\t\tif(canSpiderify)\r\n\t\t\t\t\t\t\tthis._map.oms.removeMarker(aux);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(num != this._map.oms.markers.length)\r\n\t\t\t\t\t\tthis._map.oms.unspiderfy();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Si hem desactivat capa de tipus tematic categories,\r\n\t\t\t\t// mostrem la seva llegenda\r\n\t\t\t\tif (currentbid == obj.layer.options.businessId\r\n\t\t\t\t\t\t&& obj.layer.options.tipusRang\r\n\t\t\t\t\t\t&& (obj.layer.options.tipusRang == tem_clasic|| obj.layer.options.tipusRang == tem_size)) {\r\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (currentbid == obj.layer.options.businessId && obj.layer.options.dinamic && \r\n\t\t\t\t\t\t(obj.layer.options.tem == tem_clasic || obj.layer.options.tem == tem_size)) {\r\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\r\n\t\t\t\t}\r\n\t\t\t\tif (obj.layer.options.tipus==\"wms\"){\r\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\r\n\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,'display',false);}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._validateWmsTime(_timeLayers);\r\n\t\tthis._handlingClick = false;\r\n\t\tthis._refocusOnMap();\r\n\t},\r\n\r\n\t_validateWmsTime : function(_timeLayers) {\r\n\t\tvar _thereIs = false;\r\n\t\tfor (j = 0; j < _timeLayers.length; j++) {\r\n\t\t\tif (_timeLayers[j].checked) {\r\n\t\t\t\t_thereIs = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tshowTimeControl(_thereIs);\r\n\t},\r\n\r\n\t_onUpClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar inputs = this._form.getElementsByTagName('input');\r\n\t\tvar obj = this._layers[layerId];\r\n\r\n\t\tif (!obj.overlay) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar replaceLayer = null;\r\n\t\tfor (var i = 0; i < inputs.length; i++) {\r\n\t\t\tif (!inputs[i].layerIdParent) {\r\n\t\t\t\tvar auxLayer = this._layers[inputs[i].layerId];\r\n\t\t\t\tif (auxLayer.overlay\r\n\t\t\t\t\t\t&& ((obj.layer.options.zIndex - 1) === auxLayer.layer.options.zIndex)) {\r\n\t\t\t\t\treplaceLayer = auxLayer;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar newZIndex = obj.layer.options.zIndex - 1;\r\n\t\tif (replaceLayer) {\r\n\r\n\t\t\tif (typeof url('?businessid') == \"string\") {\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\tuid : Cookies.get('uid'),\r\n\t\t\t\t\tbusinessId : url('?businessid'),\r\n\t\t\t\t\tservidorWMSbusinessId : obj.layer.options.businessId\r\n\t\t\t\t\t\t\t+ ','\r\n\t\t\t\t\t\t\t+ replaceLayer.layer.options.businessId,\r\n\t\t\t\t\torder : newZIndex + ',' + (newZIndex + 1)\r\n\t\t\t\t};\r\n\r\n\t\t\t\tupdateServersOrderToMap(data).then(function(results) {\r\n\t\t\t\t\tif (results.status != 'OK')\r\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\r\n\t\t\t\t\t// no es faci tampoc a client, i es\r\n\t\t\t\t\t// mostri un error\r\n\t\t\t\t}, function(results) {\r\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\r\n\t\t\t\t\t// faci tampoc a client, i es mostri un\r\n\t\t\t\t\t// error\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tobj.layer.options.zIndex = newZIndex;\r\n\t\t\treplaceLayer.layer.options.zIndex = newZIndex + 1;\r\n\r\n\t\t\tthis._map.fire('changeorder', obj, this);\r\n\t\t}\r\n\t},\r\n\r\n\t_onDownClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar inputs = this._form.getElementsByTagName('input');\r\n\t\tvar obj = this._layers[layerId];\r\n\r\n\t\tif (!obj.overlay) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar replaceLayer = null;\r\n\t\tfor (var i = 0; i < inputs.length; i++) {\r\n\t\t\tif (!inputs[i].layerIdParent) {\r\n\t\t\t\tvar auxLayer = this._layers[inputs[i].layerId];\r\n\t\t\t\tif (auxLayer.overlay\r\n\t\t\t\t\t\t&& ((obj.layer.options.zIndex + 1) === auxLayer.layer.options.zIndex)) {\r\n\t\t\t\t\treplaceLayer = auxLayer;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar newZIndex = obj.layer.options.zIndex + 1;\r\n\t\tif (replaceLayer) {\r\n\t\t\tif (typeof url('?businessid') == \"string\") {\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\tuid : Cookies.get('uid'),\r\n\t\t\t\t\tbusinessId : url('?businessid'),\r\n\t\t\t\t\tservidorWMSbusinessId : obj.layer.options.businessId\r\n\t\t\t\t\t\t\t+ ','\r\n\t\t\t\t\t\t\t+ replaceLayer.layer.options.businessId,\r\n\t\t\t\t\torder : newZIndex + ',' + (newZIndex - 1)\r\n\t\t\t\t};\r\n\r\n\t\t\t\tupdateServersOrderToMap(data).then(function(results) {\r\n\t\t\t\t\tif (results.status != 'OK')\r\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\r\n\t\t\t\t\t// no es faci tampoc a client, i es\r\n\t\t\t\t\t// mostri un error\r\n\t\t\t\t}, function(results) {\r\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\r\n\t\t\t\t\t// faci tampoc a client, i es mostri un\r\n\t\t\t\t\t// error\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tobj.layer.options.zIndex = newZIndex;\r\n\t\t\treplaceLayer.layer.options.zIndex = newZIndex - 1;\r\n\r\n\t\t\tthis._map.fire('changeorder', obj, this);\r\n\t\t}\r\n\t},\r\n\r\n\t_onExpandGroup : function(e) {\r\n\t\tvar cl=e.explicitOriginalTarget;\r\n\t\tif(!cl){\r\n\t\t\tcl=e.srcElement;\r\n\t\t}\r\n\t\tvar cls=jQuery(cl).attr('class');\r\n\t\tif(getModeMapa()){\r\n\t\t\tif(cls && cls.indexOf('label')!=-1){\r\n\t\t\t\tvar _id = e.currentTarget.id;\r\n\t\t\t\t_id = _id.replace('lbl_ac_', '_i_');\r\n\t\t\t\tif ($('#' + _id).hasClass('glyphicon-triangle-bottom')) {\r\n\t\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-bottom');\r\n\t\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-right');\r\n\r\n\t\t\t\t} else if ($('#' + _id).hasClass('glyphicon-triangle-right')) {\r\n\t\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-right');\r\n\t\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-bottom');\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tvar _id = e.currentTarget.id;\r\n\t\t\t_id = _id.replace('lbl_ac_', '_i_');\r\n\t\t\tif ($('#' + _id).hasClass('glyphicon-triangle-bottom')) {\r\n\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-bottom');\r\n\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-right');\r\n\t\r\n\t\t\t} else if ($('#' + _id).hasClass('glyphicon-triangle-right')) {\r\n\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-right');\r\n\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-bottom');\r\n\t\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (getModeMapa()) {\r\n\t\t\treOrderGroupsAndLayers(false);\r\n\t\t}\r\n\t},\r\n\r\n\t_onRemoveGroup : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\te.stopImmediatePropagation();\r\n\r\n\t\t$('#dialog_delete_group').modal('show');\r\n\t\t$('#dialog_delete_group #nom_group_delete').text(e.currentTarget.groupName);\r\n\t\t$('#dialog_delete_group .btn-danger').data(\"group\",e.currentTarget);\r\n\t},\r\n\r\n\t_onRemoveClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\r\n\t\tvar lbusinessId = [];\r\n\t\tif (!layerIdParent) {\r\n\t\t\tvar obj = this._layers[layerId];\r\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t\tfor (i in obj._layers) {\r\n\t\t\t\tlbusinessId.push(obj._layers[i].layer.options.businessId);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tvar objParent = this._layers[layerIdParent];\r\n\t\t\tvar obj = objParent._layers[layerId];\r\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t}\r\n\r\n\t\tif (!obj.overlay) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (typeof url('?businessid') == \"string\") {\r\n\t\t\tvar data = {\r\n\t\t\t\tbusinessId : url('?businessid'),\r\n\t\t\t\tuid : Cookies.get('uid'),\r\n\t\t\t\tservidorWMSbusinessId : lbusinessId.toString()\r\n\t\t\t};\r\n\t\t\t$('#dialog_delete_capa').modal('show');\r\n\t\t\t$('#dialog_delete_capa #nom_capa_delete').text(obj.layer.options.nom);\r\n\t\t\t$('#dialog_delete_capa .btn-danger').data(\"data\", data);\r\n\t\t\t$('#dialog_delete_capa .btn-danger').data(\"obj\", obj);\r\n\t\t}\r\n\t},\r\n\r\n\t_onDeleteClick : function(obj) {\r\n\t\tvar node = obj.target.parentElement.childNodes[0];\r\n\t\tn_obj = this._layers[node.layerId];\r\n\r\n\t\t// verify if obj is a basemap and checked to not remove\r\n\t\tif (!n_obj.overlay && node.checked) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tif (this._map.hasLayer(n_obj.layer)) {\r\n\t\t\tthis._map.removeLayer(n_obj.layer);\r\n\t\t}\r\n\t\tthis.removeLayer(n_obj.layer);\r\n\t\tobj.target.parentNode.remove();\r\n\r\n\t\treturn false;\r\n\t},\r\n\t\r\n\t_onEditNameClick : function(e) {\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tif (!obj.overlay) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t},\r\n\t\r\n\t_onOpenDataTable : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\r\n\t\t$('#modal_data_table').modal('show');\r\n\t\tconsole.debug($('#modal_data_table'));\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tdownload_layer = obj;\r\n\t\tfillModalDataTable(obj);\r\n\t},\r\n\r\n\t_onTransparenciaClick : function(e) {\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tvar op = obj.layer.options.opacity;\r\n\r\n\t\top ? op = obj.layer.options.opacity\r\n\t\t\t\t: op = obj.layer.options.fillOpacity;\r\n\r\n\t\tif (!op) {\r\n\t\t\top = 1;\r\n\t\t\tobj.layer.options.fillOpacity = 1;\r\n\t\t} else {\r\n\t\t\tif (op == 0) {\r\n\t\t\t\top = 1\r\n\t\t\t} else {\r\n\t\t\t\top = (parseFloat(op) - 0.25)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tobj.layer.setOpacity(op);\r\n\t\t\tif(estatMapa3D){mapaVista3D.canviaOpacity(obj.layer.options.businessId,op);}\r\n\t\t} catch (err) {\r\n\t\t\tobj.layer.options.fillOpacity = op;\r\n\t\t\tobj.layer.options.opacity = op;\r\n\t\t}\r\n\r\n\t\tif (getModeMapa()) {\r\n\t\t\tvar data = {\r\n\t\t\t\tbusinessId : obj.layer.options.businessId, // url('?businessid')\r\n\t\t\t\tuid : Cookies.get('uid'),\r\n\t\t\t\topacity : op\r\n\t\t\t};\r\n\t\t\tupdateServidorWMSOpacity(data).then(function(results) {\r\n\t\t\t\tif (results.status === 'OK') {\r\n\t\t\t\t\t// console.debug(results);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\t_onDownloadClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tdownload_layer = obj;\r\n\r\n\t\tif (obj.layer.options.tipusRang\r\n\t\t\t\t&& (obj.layer.options.tipusRang == tem_cluster || obj.layer.options.tipusRang == tem_heatmap)) {\r\n\t\t\t$('#modal-body-download-not-available').show();\r\n\t\t\t$('#modal-body-download-error').hide();\r\n\t\t\t$('#modal-body-download').hide();\r\n\t\t\t$('#modal_download_layer .modal-footer').show();\r\n\t\t\t$('#bt_download_tancar').show();\r\n\t\t\t$('#bt_download_accept').hide();\r\n\t\t\t$('#modal_download_layer').modal('show');\r\n\t\t} else {\r\n\t\t\t$('#modal-body-download-not-available').hide();\r\n\t\t\t$('#modal-body-download-error').hide();\r\n\t\t\t$('#modal-body-download').show();\r\n\t\t\t$('#modal_download_layer .modal-footer').show();\r\n\t\t\t$('#bt_download_tancar').hide();\r\n\t\t\t$('#bt_download_accept').show();\r\n\t\t\t$('#modal_download_layer').modal('show');\r\n\t\t}\r\n\t},\r\n\t\r\n\t_onZoomClick: function(e){\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tif (obj.layer._wmsVersion==undefined){\r\n\t\t\tvar bounds = obj.layer.getBounds();\r\n\t\t\t!estatMapa3D?map.fitBounds(bounds):mapaVista3D._goToBounds(bounds);\r\n\t\t}\r\n\t\telse{\r\n\t\t\tvar instamapsWms = InstamapsWms({\r\n\t\t\t\tloadTemplateParam :false});\r\n\t\t\tvar dataWMS = {url: obj.layer._url};\r\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\r\n\t\t\t\ttry{\r\n\t\t\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\r\n\t\t\t\t\t\tvar bbox = results.Capability.Layer.Layer.LatLonBoundingBox;\r\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar bbox = results.Capability.Layer.LatLonBoundingBox;\r\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tWMS_BBOX=null;\r\n\t\t\t\t\t}\t\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tWMS_BBOX=null;\r\n\t\t\t\t}\r\n\t\t\t\tif (WMS_BBOX !=null) map.fitBounds(WMS_BBOX);\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\t\r\n\t_hideSpiner: function(){\r\n\t\t$(this._spiner).hide();\r\n\t},\r\n\t\r\n\t_showSpiner: function(){\r\n\t\t$(this._spiner).show();\r\n\t},\r\n\t\r\n\t_onEtiquetaClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\r\n\t\tvar lbusinessId = [];\r\n\t\tif (!layerIdParent) {\r\n\t\t\tvar obj = this._layers[layerId];\r\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t\tfor (i in obj._layers) {\r\n\t\t\t\tlbusinessId\r\n\t\t\t\t\t\t.push(obj._layers[i].layer.options.businessId);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tvar objParent = this._layers[layerIdParent];\r\n\t\t\tvar obj = objParent._layers[layerId];\r\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t}\r\n\r\n\t\tif (!obj.overlay) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (typeof url('?businessid') == \"string\") {\r\n\t\t\tvar data = obj.layer.options;\r\n\t\t\tif (data!=undefined){\r\n\t\t\t\tvar dataNames = [];\r\n\t\t\t\tvar fields = {};\r\n\t\t\t\tfields[window.lang.translate('Escull el camp')] = '---';\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tif (data.propName!=undefined && data.propName!='null' && data.propName!='') {\r\n\t\t\t\t\tvar propName = data.propName;\r\n\t\t\t\t\tif(typeof (propName)==\"string\"){\t\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tdataNames = JSON.parse(propName);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcatch (err) {\r\n\t\t\t\t\t\t\tdataNames = propName;\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\t\t\t\r\n\t\t\t\t\t\tdataNames = propName;\t\r\n\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t\tif (typeof (dataNames)==\"string\"){\r\n\t\t\t\t\t\t var dataNamesSplit=dataNames.split(\",\");\r\n\t\t\t\t\t\t jQuery.each(dataNamesSplit, function( index, value ) {\r\n\t\t\t\t\t\t\t\tif (value!='') \tfields[value] = value;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\t\t\t\t\tif (value!='') \tfields[value] = value;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfields['nom']='nom';\r\n\t\t\t\t\tfields['text']='text';\r\n\t\t\t\t}\r\n\t\t\t\t//creamos el select con los campos\r\n\t\t\t\tvar source1 = jQuery(\"#etiquetes-layers-fields\").html();\r\n\t\t\t\tvar template1 = Handlebars.compile(source1);\r\n\t\t\t\tvar html1 = template1({fields:fields});\r\n\t\t\t\tjQuery('#dataFieldEtiqueta').html(html1);\r\n\t\t\t\t$('#dialog_etiquetes_capa').modal('show');\r\n\t\t\t\t//console.debug(obj.layer.options);\r\n\t\t\t\t$('#dialog_etiquetes_capa #nom_capa_etiqueta').text(obj.layer.options.nom);\r\n\t\t\t\t//console.debug(obj.layer);\r\n\t\t\t\t$('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(obj.layer.options.businessId);\r\n\t\t\t\t$('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val(obj.layer._leaflet_id);\r\n\t\t\t\t$('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val(layerId);\r\n\t\t\t\t//Si tenim al camp options informació de les etiquetes ho marquem en el formulari\r\n\t\t\t\tif (obj.layer.options.campEtiqueta!=undefined)\t$('#dataFieldEtiqueta option[value='+obj.layer.options.campEtiqueta+']').attr('selected','selected');\r\n\t\t\t\telse $('#dataFieldEtiqueta option[value=---]').attr('selected','selected');\r\n\t\t\t\tif (obj.layer.options.fontFamily!=undefined)\t$('#font-family option[value='+obj.layer.options.fontFamily+']').attr('selected','selected');\r\n\t\t\t\telse $('#font-family option[value='+obj.layer.options.fontFamily+']').attr('selected','selected');\r\n\t\t\t\tif (obj.layer.options.fontSize!=undefined)\t$('#font-size option[value='+obj.layer.options.fontSize+']').attr('selected','selected');\r\n\t\t\t\telse $('#font-size option[value=Arial]').attr('selected','selected');\r\n\t\t\t\tif (obj.layer.options.fontStyle!=undefined)\t$('#font-style option[value='+obj.layer.options.fontStyle+']').attr('selected','selected');\r\n\t\t\t\telse $('#font-style option[value=10px]').attr('selected','selected');\r\n\t\t\t\tif (obj.layer.options.fontColor!=undefined)\t$('#dv_color_etiqueta').css('background-color',obj.layer.options.fontColor);\r\n\t\t\t\telse \t$('#dv_color_etiqueta').css('background-color','#000000');\r\n\t\t\t\tif (obj.layer.options.caixaColor!=undefined)\t$('#dv_color_caixa_etiqueta').css('background-color',obj.layer.options.caixaColor);\r\n\t\t\t\telse \t$('#dv_color_caixa_etiqueta').css('background-color','#000000');\r\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined) $('input:radio[name=etiqueta][value='+obj.layer.options.opcionsVisEtiqueta+']').attr('checked', true);\r\n\t\t\t\telse $('input:radio[name=etiqueta][value=etiquetageom]').attr('checked', true);\r\n\t\t\t\tvar zoomInicial = \"2\";\r\n\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\r\n\t\t \t\tvar zoomFinal = \"19\";\r\n\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\r\n\t\t \t\t//Omplim els camps amb el que hi ha guardat a la BBDD\r\n\t\t \t\t var tooltip = function(sliderObj, ui){\r\n\t\t \t\t\t \t\r\n\t\t                val1            = '<div id=\"slider_tooltip\" style=\"font-size:10px;\">'+ zoomInicial +'</div>';\r\n\t\t                val2            = '<div id=\"slider_tooltip\" style=\"font-size:10px;\">'+ zoomFinal +'</div>';\r\n\t\t                if (ui.values[0]==zoomInicial)  sliderObj.children('.ui-slider-handle').first().html(val1);\r\n\t\t                else  sliderObj.children('.ui-slider-handle').first().html('');\r\n\t\t                if (ui.values[1]==zoomFinal)   sliderObj.children('.ui-slider-handle').last().html(val2);\r\n\t\t                else  sliderObj.children('.ui-slider-handle').last().html('');\r\n\t\t            };\r\n\t\t\t\t$( \"#slider\" ).slider({\r\n\t\t\t\t\trange:true,\r\n\t\t\t        min: 2,\r\n\t\t\t        max: 19,\t\t\t \r\n\t\t\t        values: [parseInt(zoomInicial),parseInt(zoomFinal)],\r\n\t\t\t        change:function(event,ui){\r\n\t\t            \t//tooltip($(this),ui);  \r\n\t\t            },\r\n\t\t\t        start: function( event, ui ) {\r\n\t\t\t        \t$('#slider .ui-slider-handle').first().tooltip('destroy');\t\t\t        \r\n\t\t\t        \t$('#slider .ui-slider-handle').last().tooltip('destroy');\r\n\t\t\t        \t\r\n\t\t\t        },\r\n\t\t\t        stop: function( event, ui ) {\r\n\t\t\t        \t$('#slider .ui-slider-handle').first().html('');\r\n\t\t\t        \t$('#slider .ui-slider-handle').last().html('');\t\r\n\t\t\t            //alert(  ui.values[ 0 ] + \" - \" + ui.values[ 1 ] );\r\n\t\t\t             $('#slider .ui-slider-handle').first().tooltip({title: ui.values[0], trigger: 'manual', placement: 'bottom'}).tooltip(\"show\");\r\n\t\t\t            $('#slider .ui-slider-handle').last().tooltip({title: ui.values[1], trigger: 'manual', placement: 'bottom'}).tooltip(\"show\");\r\n\t\t\t         }    \r\n\t\t\t       }\r\n\t\t\t\t);\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t$('#dialog_etiquetes_capa .btn-success').on('click', function (e) {\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\tif (jQuery('#dataFieldEtiqueta').val()!=undefined && jQuery('#dataFieldEtiqueta').val()==\"---\"){\r\n\t\t\t\t\t\talert(\"Cal escollir un camp per etiquetar\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tvar capaLeafletId = $('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val();\r\n\t\t\t\t\t\tvar capaLeafletIdControl = $('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val();\r\n\t\t\t\t\t\tvar color = rgb2hex($('#dv_color_etiqueta').css('background-color'));\r\n\t\t\t\t\t\tvar caixaColor  = rgb2hex($('#dv_color_caixa_etiqueta').css('background-color'));\r\n\t\t\t\t\t\tvar sliderVals =$(\"#slider\").slider(\"values\");\r\n\t\t\t\t\t\tvar options = {\r\n\t\t\t\t\t\t\t\tcampEtiqueta:jQuery('#dataFieldEtiqueta').val(),\r\n\t\t\t\t\t\t\t\tfontFamily:jQuery('#font-family').val(),\r\n\t\t\t\t\t\t\t\tfontSize:jQuery('#font-size').val(),\r\n\t\t\t\t\t\t\t\tfontStyle:jQuery('#font-style').val(),\r\n\t\t\t\t\t\t\t\tfontColor:color,\r\n\t\t\t\t\t\t\t\topcionsVis:$(\"input[name=etiqueta]:checked\").val(),\r\n\t\t\t\t\t\t\t\tcaixaColor: caixaColor,\r\n\t\t\t\t\t\t\t\tcontorn:$(\"input[name=contorn]:checked\").val(),\r\n\t\t\t\t\t\t\t\tcaixa:$(\"input[name=caixeti]:checked\").val(),\r\n\t\t\t\t\t\t\t\tzoomInicial:sliderVals[0],\r\n\t\t\t\t\t\t\t\tzoomFinal:sliderVals[1]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar layerMap=map._layers[capaLeafletId];\r\n\t\t\t\t\t\tvar optionsMap;\r\n\t\t\t\t\t\tif (layerMap==undefined) {\r\n\t\t\t\t\t\t\tlayerMap = controlCapes._layers[capaLeafletId];\r\n\t\t\t\t\t\t\toptionsMap=layerMap.layer.options;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse optionsMap=layerMap.options;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar data={\r\n\t\t\t\t\t\t\t\tbusinessId: $('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(),\r\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\toptions:  JSON.stringify(options),\r\n\t\t\t\t\t\t\t\tnom:optionsMap.nom,\r\n\t\t\t\t\t\t\t\ttipus:optionsMap.tipusRang,\r\n\t\t\t\t\t\t\t\tgeometryType:optionsMap.geometryType\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tupdateVisualitzacioLayer(data).then(function(results){\r\n\t\t\t\t\t\t\t$('#dialog_etiquetes_capa').modal('hide');\r\n\t\t\t\t\t\t\treloadVisualitzacioLayer(layerMap, results.visualitzacio, results.layer, map).then(function(results) {\r\n\t\t\t\t\t\t\t\t//refresh zoom etiquetes\r\n\t\t\t\t\t\t\t\trefrescarZoomEtiquetes(results);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\r\n\t_onRefreshClick : function(e) {\r\n\t\t$('.tooltip').hide();\r\n\t\tconsole.debug(e.currentTarget);\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\r\n\t\tconsole.debug(this._layers);\r\n\t\tvar obj = this._layers[layerIdParent]._layers[layerId];\r\n\t\t//Refrescar els temàtics: eliminem sublayer del mapa, i recarreguem\r\n\t\tmap.removeLayer(obj.layer);\r\n\t\tloadVisualitzacioLayer(obj.layer);\r\n\t},\r\n\r\n\t_showOptions : function(e) {\r\n\t\tvar layerId = e.currentTarget.layerId;\r\n\t\tvar inputs = this._form.getElementsByTagName('input');\r\n\t\tvar obj = this._layers[layerId];\r\n\t\tshowConfOptions(obj.layer.options.businessId);\r\n\t},\r\n\r\n\t_expand : function() {\r\n\t\tL.DomUtil.addClass(this._container,\r\n\t\t\t\t'leaflet-control-layers-expanded');\r\n\t},\r\n\r\n\t_collapse : function() {\r\n\t\tthis._container.className = this._container.className.replace(\r\n\t\t\t\t' leaflet-control-layers-expanded', '');\r\n\t}\r\n});\r\n\t\t\t\t\t\t\r\nL.control.orderlayers = function(baseLayers, overlays, options) {\r\n\treturn new L.Control.OrderLayers(baseLayers, overlays, options);\r\n};\r\n\r\nfunction isHeat(obj) {\r\n\treturn (obj.layer.options.tipusRang && obj.layer.options.tipusRang\r\n\t\t\t.indexOf('heatmap') != -1);\r\n}\r\n\r\nfunction showConfOptions(businessId) {\r\n\tjQuery(\".conf-\" + businessId + \"\").toggle(\"fast\");\r\n\taddTooltipsConfOptions(businessId);\r\n}\r\n\r\nfunction updateCheckStyle() {\r\n\t$('.leaflet-input input').iCheck({\r\n\t\tcheckboxClass : 'icheckbox_flat-blue',\r\n\t\tradioClass : 'iradio_flat-blue'\r\n\t});\r\n}\r\n\r\nfunction thisFillModalDataTable(obj) {\r\n\tfillModalDataTable(obj);\r\n}\r\n\r\nfunction thisLoadMapLegendEdicio(obj) {\r\n\tif (getModeMapa()){\r\n\t\tloadMapLegendEdicio(obj);\r\n\t}\r\n}\r\n\r\nfunction thisLoadMapLegendEdicioDinamic(obj) {\r\n\tif (getModeMapa()){\r\n\t\tloadMapLegendEdicioDinamics(obj);\r\n\t}\r\n}\r\n\r\nfunction thisEmptyMapLegendEdicio(obj,isOrigen) {\r\n\tif (getModeMapa()){\r\n\t\temptyMapLegendEdicio(obj,isOrigen);\r\n\t}\r\n}\r\n","/*\r\nBased on git@github.com:stefanocudini/leaflet-search.git \r\n\r\n*/\r\n\r\n\r\n(function() {\r\n\r\nL.Control.Search = L.Control.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\turl: '',\t\t\t\t\t//url for search by ajax request, ex: \"search.php?q={s}\"\r\n\t\tjsonpParam: null,\t\t\t//jsonp param name for search by jsonp service, ex: \"callback\"\r\n\t\tlayer: null,\t\t\t\t//layer where search markers(is a L.LayerGroup)\t\t\r\n\t\tcallData: null,\t\t\t\t//function that fill _recordsCache, passed searching text by first param and callback in second\r\n\t\t//TODO important! implements uniq option 'sourceData' that recognizes source type: url,array,callback or layer\t\t\r\n\t\t//TODO implement can do research on multiple sources\r\n\t\tpropertyName: 'title',\t\t//property in marker.options(or feature.properties for vector layer) trough filter elements in layer\r\n\t\tpropertyLoc: 'loc',\t\t\t//field name for remapping location, using array: ['latname','lonname'] for select double fields(ex. ['lat','lon'] )\r\n\t\t//TODO implement sub property filter for propertyName,propertyLoc like this:  \"prop.subprop.title\"\r\n\t\tcallTip: null,\t\t\t\t//function that return row tip html node(or html string), receive text tooltip in first param\r\n\t\tfilterJSON: null,\t\t\t//callback for filtering data to _recordsCache\r\n\t\tminLength: 1,\t\t\t\t//minimal text length for autocomplete\r\n\t\tinitial: true,\t\t\t\t//search elements only by initial text\r\n\t\tautoType: true,\t\t\t//complete input with first suggested result and select this filled-in text.\r\n\t\tdelayType: 400,\t\t\t\t//delay while typing for show tooltip\r\n\t\ttooltipLimit: -1,\t\t\t//limit max results to show in tooltip. -1 for no limit.\r\n\t\ttipAutoSubmit: true,  \t\t//auto map panTo when click on tooltip\r\n\t\tautoResize: true,\t\t\t//autoresize on input change\r\n\t\tautoCollapse: true,\t\t//collapse search control after submit(on button or on tips if enabled tipAutoSubmit)\r\n\t\t//TODO add option for persist markerLoc after collapse!\r\n\t\tautoCollapseTime: 1200,\t\t//delay for autoclosing alert and collapse after blur\r\n\t\tanimateLocation: true,\t\t//animate a circle over location found\r\n\t\tcircleLocation: true,\t\t//draw a circle in location found\r\n\t\tmarkerLocation: false,\t\t//draw a marker in location found\r\n\t\tzoom: null,\t\t\t\t\t//zoom after pan to location found, default: map.getZoom()\r\n\t\tidInputText : null,\r\n\t\ttext: 'Cercar...',\t\t\t//placeholder value\t\r\n\t\ttextCancel: 'Cancel',\t\t//title in cancel button\r\n\t\ttextErr: 'No trobat',\r\n\t\ttextEdit:'Edit',//error message\r\n\t\ttextLoad:'',\r\n\t\tscope:'visor',\r\n\t\tposition: 'topcenter'\r\n\t\t//TODO add option collapsed, like control.layers\r\n\t},\r\n//FIXME option condition problem {autoCollapse: true, markerLocation: true} not show location\r\n//FIXME option condition problem {autoCollapse: false }\r\n\r\n\tinitialize: function(options) {\r\n\t\tL.Util.setOptions(this, options || {});\r\n\t\tthis._inputMinSize = this.options.text ? this.options.text.length : 10;\r\n\t\tthis._layer = this.options.layer || new L.LayerGroup();\r\n\t\tthis._filterJSON = this.options.filterJSON || this._defaultFilterJSON;\r\n\t\tthis._autoTypeTmp = this.options.autoType;\t//useful for disable autoType temporarily in delete/backspace keydown\r\n\t\tthis._countertips = 0;\t\t//number of tips items\r\n\t\tthis._recordsCache = {};\t//key,value table! that store locations! format: key,latlng\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\t\r\n\t\t var $controlContainer = map._controlContainer,\r\n         nodes = $controlContainer.childNodes,\r\n         topCenter = false;\r\n\r\n\t     for (var i = 0, len = nodes.length; i < len; i++) {\r\n\t         var klass = nodes[i].className;\r\n\t         if (/leaflet-top/.test(klass) && /leaflet-center/.test(klass)) {\r\n\t             topCenter = true;\r\n\t             break;\r\n\t         }\r\n\t     }\r\n\r\n\t     if (!topCenter) {\r\n\t         var tc = document.createElement('div');\r\n\t         tc.className += 'leaflet-top leaflet-center';\r\n\t         \r\n\t         if(this.options.idInputText==null){\r\n\t        \t $controlContainer.appendChild(tc); \r\n\t         }else{\r\n\t        \t jQuery(this.options.idInputText).append(tc);\r\n\t         }\r\n\t         map._controlCorners.topcenter = tc;\r\n\t     }\r\n\t\t\r\n\t\tthis._map = map;\r\n\t\tthis._container = L.DomUtil.create('div', 'leaflet-control-search');\r\n\t\t\r\n\t\tthis._cancel = this._createCancel(this.options.textCancel, 'search-cancel');\r\n//\t\tthis._button = this._createButton(this.options.text, 'search-button glyphicon glyphicon-search grisfort');\r\n\t\tthis._input = this._createInput(this.options.text, 'search-input');\r\n\t\tthis._icon= this._createIcon('fa fa-search iconSearch');\r\n\t\tthis._tooltip = this._createTooltip('search-tooltip');\r\n\t\tthis._alert = this._createAlert('search-alert');\r\n\t\tthis._edit = this._createEdit(this.options.textEdit,'search-edit');\r\n\t\tthis._loadv = this._createLoad(this.options.textLoad,'search-load');\r\n\t\t\r\n\t\t\r\n\t\tif(this.options.circleLocation || this.options.markerLocation) {\r\n\t\t\t//this._markerLoc = new SearchMarker([0,0], {marker: this.options.markerLocation});//see below\r\n\t\t\t//Mira si és icona\r\n\t\t\tvar defaultPunt= L.AwesomeMarkers.icon(default_marker_style);\r\n//\t\t\tconsole.debug(defaultPunt);\r\n\t\t\tif(!defaultPunt.options.isCanvas){\r\n\t\t\t\tthis._markerLoc=L.marker([0,0],\r\n\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t tipus: t_marker});\r\n\t\t\t}else{\r\n\t\t\t\t//Si és cercle sense glifon\r\n\t\t\t\tthis._markerLoc= L.circleMarker([0,0],\r\n\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \r\n\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\r\n\t\t\t\t\t\t  color :  defaultPunt.options.color,\r\n\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\r\n\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\r\n\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\r\n\t\t\t\t\t\t  tipus: t_marker}\r\n\t\t\t\t\t\t\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t    }\r\n\t\t\r\n\t\t//this.setLayer( this._layer );\r\n\t\t\r\n\t\tmap.on({'resize':this._handleAutoresize()}, this);\r\n\t\t \r\n\t\treturn this._container;\r\n\t},\r\n\r\n\tonRemove: function(map) {\r\n\t\tthis._recordsCache = {};\r\n\t\t// map.off({\r\n\t\t// \t\t'layeradd': this._onLayerAddRemove,\r\n\t\t// \t\t'layerremove': this._onLayerAddRemove\r\n\t\t// \t}, this);\r\n\t},\r\n\r\n\t// _onLayerAddRemove: function(e) {\r\n\t// \t//console.info('_onLayerAddRemove');\r\n\t// \t//without this, run setLayer also for each Markers!! to optimize!\r\n\t// \tif(e.layer instanceof L.LayerGroup)\r\n\t// \t\tif( L.stamp(e.layer) != L.stamp(this._layer) )\r\n\t// \t\t\tthis.setLayer(e.layer);\r\n\t// },\r\n\t\r\n\tsetLayer: function(layer) {\t//set search layer at runtime\r\n\t\t//this.options.layer = layer; //setting this, run only this._recordsFromLayer()\r\n\t\tthis._layer = layer;\r\n\t\tthis._layer.addTo(this._map);\r\n\t\tif(this._markerLoc)\r\n\t\t\tthis._layer.addLayer(this._markerLoc);\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\tshowAlert: function(text) {\r\n\t\ttext = text || this.options.textErr;\r\n\t\tthis._alert.style.display = 'block';\r\n\t\tthis._alert.innerHTML = text;\r\n\t\tclearTimeout(this.timerAlert);\r\n\t\tvar that = this;\t\t\r\n\t\tthis.timerAlert = setTimeout(function() {\r\n\t\t\tthat.hideAlert();\r\n\t\t},this.options.autoCollapseTime);\r\n\t\t$.publish('analyticsEvent',{event:[this.options.scope,'input#cercaTopoFAIL',this._input.value, 8]});\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\t\r\n\tshowLoad: function(text) {\r\n\t\ttext = text || this.options.textLoad;\r\n\t\tthis._loadv.style.display = 'block';\r\n\t\tthis._loadv.innerHTML = text;\r\n\t\tclearTimeout(this.timerAlert);\r\n\t\tvar that = this;\t\t\r\n\t\tthis.timerAlert = setTimeout(function() {\r\n\t\t\tthat.hideAlert();\r\n\t\t},this.options.autoCollapseTime);\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\thideLoad: function() {\r\n\t\tthis._loadv.style.display = 'none';\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\t\r\n\tshowEdit: function(text) {\r\n\t\ttext = text || this.options.textEdit;\r\n\t\t\r\n\t\tthis._edit.style.display = 'block';\r\n\t\tthis._edit.innerHTML = text;\r\n\t\t//clearTimeout(this.timerAlert);\r\n\t\tvar that = this;\t\t\r\n\t\t\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\thideAlert: function() {\r\n\t\tthis._alert.style.display = 'none';\r\n\t\treturn this;\r\n\t},\r\n\t\t\r\n\thideEdit: function() {\r\n\t\tthis._edit.style.display = 'none';\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\tcancel: function() {\r\n\t\tthis._input.value = '';\r\n\t\t//this._handleKeypress({keyCode:46});//simulate backspace keypress\r\n\t\t//this._input.focus();\r\n\t\tthis._cancel.style.display = 'none';\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\texpand: function() {\t\t\r\n\t\tthis._input.style.display = 'block';\r\n\t\tL.DomUtil.addClass(this._container, 'search-exp');\t\r\n\t\tthis._input.focus();\r\n\t\tthis._map.on('dragstart', this.collapse, this);\r\n\t\treturn this;\t\r\n\t},\r\n\r\n\tcollapse: function() {\r\n\t\tthis._hideTooltip();\r\n\t\tthis.cancel();\r\n\t\tthis._alert.style.display = 'none';\r\n\t\tthis._input.style.display = 'block';\r\n\t\tthis._input.blur();\r\n\t\tthis._cancel.style.display = 'none';\r\n\t\tL.DomUtil.removeClass(this._container, 'search-exp');\t\t\r\n\t\t//this._markerLoc.hide();//maybe unuseful\r\n\t\tthis._map.off('dragstart', this.collapse, this);\r\n\t\tthis.fire('search_collapsed');\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\tcollapseDelayed: function() {\t//collapse after delay, used on_input blur\r\n\t\tif (!this.options.autoCollapse) return this;\r\n\t\tvar that = this;\r\n\t\tclearTimeout(this.timerCollapse);\r\n\t\tthis.timerCollapse = setTimeout(function() {\r\n\t\t\tthat.collapse();\r\n\t\t}, this.options.autoCollapseTime);\r\n\t\treturn this;\t\t\r\n\t},\r\n\r\n\tcollapseDelayedStop: function() {\r\n\t\tclearTimeout(this.timerCollapse);\r\n\t\treturn this;\t\t\r\n\t},\r\n\r\n////start DOM creations\r\n\t_createAlert: function(className) {\r\n\t\tvar alert = L.DomUtil.create('div', className, this._container);\r\n\t\talert.style.display = 'none';\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.on(alert, 'click', L.DomEvent.stop, this)\r\n\t\t\t.on(alert, 'click', this.hideAlert, this);\r\n\r\n\t\treturn alert;\r\n\t},\r\n\t\r\n\t_createEdit: function(text,className) {\r\n\t\tvar edit = L.DomUtil.create('div', className, this._container);\r\n\t\tedit.style.display = 'none';\r\n\t\tedit.innerHTML = text;\r\n\t\t//L.DomEvent.on(edit, 'click', L.DomEvent.stop, this);\r\n\t\t\t//.on(edit, 'click', this.hideEdit, this);\r\n\r\n\t\treturn edit;\r\n\t},\r\n\t\r\n\t_createLoad: function(text,className) {\r\n\t\tvar loadv = L.DomUtil.create('div', className, this._container);\r\n\t\tloadv.style.display = 'none';\r\n\t\tloadv.innerHTML = text;\r\n\t\t//L.DomEvent.on(load, 'click', L.DomEvent.stop, this);\r\n\t\t\t//.on(edit, 'click', this.hideEdit, this);\r\n\r\n\t\treturn loadv;\r\n\t},\r\n\r\n\t_createInput: function (text, className) {\r\n\t\tvar input = L.DomUtil.create('input', className, this._container);\r\n\t\tinput.type = 'text';\r\n\t\tinput.size = this._inputMinSize;\r\n\t\tinput.value = '';\r\n\t\tinput.autocomplete = 'off';\r\n\t\tinput.placeholder = text;\r\n\t\tinput.style.display = 'block';\r\n\t\tinput.lang = 'ca';\r\n\t\tinput.id = 'search-input';\r\n\t\t\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.disableClickPropagation(input)\r\n\t\t\t.on(input, 'keyup', this._handleKeypress, this)\r\n\t\t\t.on(input, 'keydown', this._handleAutoresize, this)\r\n\t\t\t.on(input, 'blur', this.collapseDelayed, this)\r\n\t\t\t.on(input, 'focus', this.collapseDelayedStop, this);\r\n\t\t\r\n\t\treturn input;\r\n\t},\r\n\r\n\t_createCancel: function (title, className) {\r\n\t\tvar cancel = L.DomUtil.create('a', className, this._container);\r\n\t\tcancel.href = '#';\r\n\t\tcancel.title = title;\r\n\t\tcancel.style.display = 'none';\r\n\t\tcancel.innerHTML = \"<span>&otimes;</span>\";//imageless(see css)\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.on(cancel, 'click', L.DomEvent.stop, this)\r\n\t\t\t.on(cancel, 'click', this.cancel, this);\r\n\r\n\t\treturn cancel;\r\n\t},\r\n\t\r\n\t_createButton: function (title, className) {\r\n\t\tvar button = L.DomUtil.create('a', className, this._container);\r\n\t\tbutton.href = '#';\r\n\t\tbutton.title = title;\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.on(button, 'click', L.DomEvent.stop, this)\r\n\t\t\t.on(button, 'click', this._handleSubmit, this)\t\t\t\r\n\t\t\t.on(button, 'focus', this.collapseDelayedStop, this)\r\n\t\t\t.on(button, 'blur', this.collapseDelayed, this);\r\n\r\n\t\treturn button;\r\n\t},\r\n\r\n\t_createTooltip: function(className) {\r\n\t\tvar tool = L.DomUtil.create('div', className, this._container);\r\n\t\ttool.style.display = 'none';\r\n\r\n\t\tvar that = this;\r\n\t\tL.DomEvent\r\n\t\t\t.disableClickPropagation(tool)\r\n\t\t\t.on(tool, 'blur', this.collapseDelayed, this)\r\n\t\t\t.on(tool, 'mousewheel', function(e) {\r\n\t\t\t\tthat.collapseDelayedStop();\r\n\t\t\t\tL.DomEvent.stopPropagation(e);//disable zoom map\r\n\t\t\t}, this)\r\n\t\t\t.on(tool, 'mouseover', function(e) {\r\n\t\t\t\tthat.collapseDelayedStop();\r\n\t\t\t}, this);\r\n\t\treturn tool;\r\n\t},\r\n\r\n\t_createTip: function(text, val) {//val is object in recordCache, usually is Latlng\r\n\t\tvar tip;\r\n\t\t\r\n\t\tif(this.options.callTip)\r\n\t\t{\r\n\t\t\ttip = this.options.callTip(text,val); //custom tip node or html string\r\n\t\t\tif(typeof tip === 'string')\r\n\t\t\t{\r\n\t\t\t\tvar tmpNode = L.DomUtil.create('div');\r\n\t\t\t\ttmpNode.innerHTML = tip;\r\n\t\t\t\ttip = tmpNode.firstChild;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\ttip = L.DomUtil.create('a', '');\r\n\t\t\ttip.href = '#';\r\n\t\t\ttip.innerHTML = text;\r\n\t\t}\r\n\t\t\r\n\t\tL.DomUtil.addClass(tip, 'search-tip');\r\n\t\ttip._text = text; //value replaced in this._input and used by _autoType\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.disableClickPropagation(tip)\t\t\r\n\t\t\t.on(tip, 'click', L.DomEvent.stop, this)\r\n\t\t\t.on(tip, 'click', function(e) {\r\n\t\t\t\tthis._input.value = text;\r\n\t\t\t\tthis._handleAutoresize();\r\n\t\t\t\tthis._input.focus();\r\n\t\t\t\tthis._hideTooltip();\t\r\n\t\t\t\tif(this.options.tipAutoSubmit)//go to location at once\r\n\t\t\t\t\tthis._handleSubmit();\r\n\t\t\t}, this);\r\n\r\n\t\treturn tip;\r\n\t},\r\n\r\n\t_createIcon: function ( className) {\r\n\t\tvar icon = L.DomUtil.create('i', className, this._container);\r\n\t\ticon.id = 'searchIcon';\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t.disableClickPropagation(icon)\r\n\t\t.on(icon, 'click', this._makeSearch,this);\r\n\t\treturn icon;\r\n\t},\r\n//////end DOM creations\r\n\r\n\t_filterRecords: function(text) {\t//Filter this._recordsCache case insensitive and much more..\r\n\t\r\n\t\tvar regFilter = new RegExp(\"^[.]$|[\\[\\]|()*]\",'g'),\t//remove . * | ( ) ] [\r\n\t\t\tI, regSearch,\r\n\t\t\tfrecords = {};\r\n\r\n\t\ttext = text.replace(regFilter,'');\t  //sanitize text\r\n\t\tI = this.options.initial ? '^' : '';  //search only initial text\r\n\t\t//TODO add option for case sesitive search, also showLocation\r\n\t\tregSearch = new RegExp(I + text,'i');\r\n\r\n\t\t//TODO use .filter or .map\r\n\t\tfor(var key in this._recordsCache)\r\n\t\t\tif( regSearch.test(key) )\r\n\t\t\t\tfrecords[key]= this._recordsCache[key];\r\n\t\t\r\n\t\treturn frecords;\r\n\t},\r\n\r\n\tshowTooltip: function() {\r\n\t\t\r\n\t\tvar filteredRecords, newTip;\r\n\r\n\t\tthis._countertips = 0;\r\n\t\t\r\n\t//FIXME problem with jsonp/ajax when remote filter has different behavior of this._filterRecords\r\n\t\tif(this.options.layer)\r\n\t\t\tfilteredRecords = this._filterRecords( this._input.value );\r\n\t\telse\r\n\t\t\tfilteredRecords = this._recordsCache;\r\n\t\t\t\r\n\t\tthis._tooltip.innerHTML = '';\r\n\t\tthis._tooltip.currentSelection = -1;  //inizialized for _handleArrowSelect()\r\n\r\n\t\tfor(var key in filteredRecords)//fill tooltip\r\n\t\t{\r\n\t\t\tif(++this._countertips == this.options.tooltipLimit) break;\r\n\r\n\t\t\tnewTip = this._createTip(key, filteredRecords[key] );\r\n\r\n\t\t\tthis._tooltip.appendChild(newTip);\r\n\t\t}\r\n\t\t\r\n\t\tif(this._countertips > 0)\r\n\t\t{\r\n\t\t\tthis._tooltip.style.display = 'block';\r\n\t\t\tif(this._autoTypeTmp)\r\n\t\t\t\tthis._autoType();\r\n\t\t\tthis._autoTypeTmp = this.options.autoType;//reset default value\r\n\t\t}\r\n\t\telse\r\n\t\t\tthis._hideTooltip();\r\n\r\n\t\tthis._tooltip.scrollTop = 0;\r\n\t\treturn this._countertips;\r\n\t},\r\n\r\n\t_hideTooltip: function() {\r\n\t\tthis._tooltip.style.display = 'none';\r\n\t\tthis._tooltip.innerHTML = '';\r\n\t\treturn 0;\r\n\t},\r\n\r\n\t_defaultFilterJSON: function(json) {\t//default callback for filter data\t\r\n\t\t\r\n\t\tvar jsonret = {},\r\n\t\t\tpropName = this.options.propertyName;\r\n\t\t\tpropLoc = this.options.propertyLoc;\r\n\r\n\t\tif( L.Util.isArray(propLoc) )\r\n\t\t\tfor(var i in json)\r\n\t\t\t\tjsonret[ json[i][propName] ]= L.latLng( json[i][ propLoc[0] ], json[i][ propLoc[1] ] );\r\n\t\telse\r\n\t\t\tfor(var n in json)\r\n\t\t\t\tjsonret[ json[n][propName] ]= L.latLng( json[n][ propLoc ] );\r\n\t\t//TODO verify json[n].hasOwnProperty(propName)\r\n\t\t//throw new Error(\"propertyName '\"+propName+\"' not found in JSON data\");\r\n\t\treturn jsonret;\r\n\t},\r\n\r\n\t_recordsFromJsonp: function(text, callAfter) {  //extract searched records from remote jsonp service\r\n\t\t//TODO remove script node after call run\r\n\t\tvar that = this;\r\n\t\tL.Control.Search.callJsonp = function(data) {\t//jsonp callback\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar fdata = that._filterJSON(data);//_filterJSON defined in inizialize...\r\n\t\t\t\r\n\t\t\tcallAfter(fdata);\r\n\t\t}\r\n\t\tif (this.options.url.indexOf(\"geocodificador\")>-1) {\r\n\t\t\t\r\n\t\t\ttext=escape(text);\r\n\t\t\t\r\n\t\t}\r\n\t\t\t\t\r\n\t\tvar script = L.DomUtil.create('script','search-jsonp', document.getElementsByTagName('body')[0] ),\t\r\n\t\t\turl = L.Util.template(this.options.url+'&'+this.options.jsonpParam+'=L.Control.Search.callJsonp', {s: text}); //parsing url\r\n\t\t\t//rnd = '&_='+Math.floor(Math.random()*10000);\r\n\t\t\t//TODO add rnd param or randomize callback name! in recordsFromJsonp\r\n\t\tscript.type = 'text/javascript';\r\n\t\tscript.src = url;\r\n\t\treturn this;\r\n\t\t//may be return {abort: function() { script.parentNode.removeChild(script); } };\r\n\t},\r\n\r\n\t_recordsFromAjax: function(text, callAfter) {\t//Ajax request\r\n\t\tif (window.XMLHttpRequest === undefined) {\r\n\t\t\twindow.XMLHttpRequest = function() {\r\n\t\t\t\ttry { return new ActiveXObject(\"Microsoft.XMLHTTP.6.0\"); }\r\n\t\t\t\tcatch  (e1) {\r\n\t\t\t\t\ttry { return new ActiveXObject(\"Microsoft.XMLHTTP.3.0\"); }\r\n\t\t\t\t\tcatch (e2) { throw new Error(\"XMLHttpRequest is not supported\"); }\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t}\r\n\t\tvar request = new XMLHttpRequest(),\r\n\t\t\turl = L.Util.template(this.options.url, {s: text}), //parsing url\r\n\t\t\t//rnd = '&_='+Math.floor(Math.random()*10000);\r\n\t\t\t//TODO add rnd param or randomize callback name! in recordsFromAjax\t\t\t\r\n\t\t\tresponse = {};\r\n\t\t\r\n\t\trequest.open(\"GET\", url);\r\n\t\tvar that = this;\r\n\t\trequest.onreadystatechange = function() {\r\n\t\t    if(request.readyState === 4 && request.status === 200) {\r\n\t\t    \tresponse = JSON.parse(request.responseText);\r\n\t\t    \tvar fdata = that._filterJSON(response);//_filterJSON defined in inizialize...\r\n\t\t        callAfter(fdata);\r\n\t\t    }\r\n\t\t};\r\n\t\trequest.send();\r\n\t\treturn this;   \r\n\t},\t\r\n\r\n\t_recordsFromLayer: function() {\t//return table: key,value from layer\r\n\t\tvar retRecords = {},\r\n\t\t\tpropName = this.options.propertyName,\r\n\t\t\tloc;\r\n\t\t\r\n\t\tthis._layer.eachLayer(function(layer) {\r\n\r\n\t\t\tif(layer instanceof SearchMarker) return;\r\n\r\n\t\t\tif(layer instanceof L.Marker)\r\n\t\t\t{\r\n\t\t\t\tif(layer.options.hasOwnProperty(propName))\r\n\t\t\t\t{\r\n\t\t\t\t\tloc = layer.getLatLng();\r\n\t\t\t\t\tloc.layer = layer;\r\n\t\t\t\t\tretRecords[ layer.options[propName] ] = loc;\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t}else if(layer.feature.properties.hasOwnProperty(propName)){\r\n\r\n\t\t\t\t\tloc = layer.getLatLng();\r\n\t\t\t\t\tloc.layer = layer;\r\n\t\t\t\t\tretRecords[ layer.feature.properties[propName] ] = loc;\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.log(\"propertyName '\"+propName+\"' not found in marker\", layer);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if(layer.hasOwnProperty('feature'))//GeoJSON layer\r\n\t\t\t{\r\n\t\t\t\tif(layer.feature.properties.hasOwnProperty(propName))\r\n\t\t\t\t{\r\n\t\t\t\t\tloc = layer.getBounds().getCenter();\r\n\t\t\t\t\tloc.layer = layer;\t\t\t\r\n\t\t\t\t\tretRecords[ layer.feature.properties[propName] ] = loc;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t\tconsole.log(\"propertyName '\"+propName+\"' not found in feature\", layer);\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t},this);\r\n\t\t\r\n\t\treturn retRecords;\r\n\t},\r\n\r\n\t_autoType: function() {\r\n\t\t\r\n\t\t//TODO implements autype without selection(useful for mobile device)\r\n\t\t\r\n\t\tvar start = this._input.value.length,\r\n\t\t\tfirstRecord = this._tooltip.firstChild._text,\r\n\t\t\tend = firstRecord.length;\r\n\r\n\t\tif (firstRecord.indexOf(this._input.value) === 0) { // If prefix match\r\n\t\t\tthis._input.value = firstRecord;\r\n\t\t\tthis._handleAutoresize();\r\n\r\n\t\t\tif (this._input.createTextRange) {\r\n\t\t\t\tvar selRange = this._input.createTextRange();\r\n\t\t\t\tselRange.collapse(true);\r\n\t\t\t\tselRange.moveStart('character', start);\r\n\t\t\t\tselRange.moveEnd('character', end);\r\n\t\t\t\tselRange.select();\r\n\t\t\t}\r\n\t\t\telse if(this._input.setSelectionRange) {\r\n\t\t\t\tthis._input.setSelectionRange(start, end);\r\n\t\t\t}\r\n\t\t\telse if(this._input.selectionStart) {\r\n\t\t\t\tthis._input.selectionStart = start;\r\n\t\t\t\tthis._input.selectionEnd = end;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_hideAutoType: function() {\t// deselect text:\r\n\r\n\t\tvar sel;\r\n\t\tif ((sel = this._input.selection) && sel.empty) {\r\n\t\t\tsel.empty();\r\n\t\t}\r\n\t\telse if (this._input.createTextRange) {\r\n\t\t\tsel = this._input.createTextRange();\r\n\t\t\tsel.collapse(true);\r\n\t\t\tvar end = this._input.value.length;\r\n\t\t\tsel.moveStart('character', end);\r\n\t\t\tsel.moveEnd('character', end);\r\n\t\t\tsel.select();\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif (this._input.getSelection) {\r\n\t\t\t\tthis._input.getSelection().removeAllRanges();\r\n\t\t\t}\r\n\t\t\tthis._input.selectionStart = this._input.selectionEnd;\r\n\t\t}\r\n\t},\r\n\t\r\n\t_handleKeypress: function (e) {\t//run _input keyup event\r\n\t\tswitch(e.keyCode)\r\n\t\t{\r\n\t\t\tcase 27: //Esc\r\n\t\t\t\tthis.collapse();\r\n\t\t\tbreak;\r\n\t\t\tcase 13: //Enter\r\n\t\t\t\tthis._makeSearch(this);\t\t\t\t\r\n\t\t\tbreak;\r\n\t\t\tcase 38://Up\r\n\t\t\t\tthis._handleArrowSelect(-1);\r\n\t\t\tbreak;\r\n\t\t\tcase 40://Down\r\n\t\t\t\tthis._handleArrowSelect(1);\r\n\t\t\tbreak;\r\n\t\t\tcase 37://Left\r\n\t\t\tcase 39://Right\r\n\t\t\tcase 16://Shift\r\n\t\t\tcase 17://Ctrl\r\n\t\t\t//case 32://Space\r\n\t\t\tbreak;\r\n\t\t\tcase 8://backspace\r\n\t\t\tcase 46://delete\r\n\t\t\t\tthis._autoTypeTmp = false;//disable temporarily autoType\r\n\t\t\tbreak;\r\n\t\t\tdefault://All keys\r\n\r\n\t\t}\r\n\t},\r\n\t\r\n\t_makeSearch: function(){\r\n\t\tif(this._input.value.length)\r\n\t\t\tthis._cancel.style.display = 'block';\r\n\t\telse\r\n\t\t\tthis._cancel.style.display = 'none';\r\n\r\n\t\tif(this._input.value.length >= this.options.minLength)\r\n\t\t{\r\n\t\t\tvar that = this;\r\n\t\t\tclearTimeout(this.timerKeypress);\t//cancel last search request while type in\t\t\t\t\r\n\t\t\t//this.timerKeypress = setTimeout(function() {\t//delay before request, for limit jsonp/ajax request\r\n\r\n\t\t\t\tthat._fillRecordsCache();\r\n\t\t\t\r\n\t\t\t//}, this.options.delayType);\r\n\t\t}\r\n\t\telse\r\n\t\t\tthis._hideTooltip();\r\n\t},\r\n\t\r\n\t_fillRecordsCache: function() {\r\n\t\t//that.hideAlert();\r\n//TODO important optimization!!! always append data in this._recordsCache\r\n//  now _recordsCache content is emptied and replaced with new data founded\r\n//  always appending data on _recordsCache give the possibility of caching ajax, jsonp and layersearch!\r\n//\r\n//TODO here insert function that search inputText FIRST in _recordsCache keys and if not find results.. \r\n//  run one of callbacks search(callData,jsonpUrl or options.layer) and run this.showTooltip\r\n//\r\n//TODO change structure of _recordsCache\r\n//\tlike this: _recordsCache = {\"text-key1\": {loc:[lat,lng], ..other attributes.. }, {\"text-key2\": {loc:[lat,lng]}...}, ...}\r\n//\tin this mode every record can have a free structure of attributes, only 'loc' is required\r\n\t\tvar inputText = this._input.value,\r\n\t\t\tthat;\r\n\t\t\r\n\t\tL.DomUtil.addClass(this._container, 'search-load');\r\n\r\n\t\tif(this.options.callData)\t//CUSTOM SEARCH CALLBACK(USUALLY FOR AJAX SEARCHING)\r\n\t\t{\r\n\t\t\tthat = this;\r\n\t\t\tthis.options.callData(inputText, function(jsonraw) {\r\n\r\n\t\t\t\tthat._recordsCache = that._filterJSON(jsonraw);\r\n\r\n\t\t\t\tthat.showTooltip();\r\n\r\n\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if(this.options.url)\t//JSONP/AJAX REQUEST\r\n\t\t{\tif(this.options.jsonpParam)\r\n\t\t\t{\r\n\t\t\t\tthat = this;\r\n\t\t\t\t\r\n\t\t\t\tthis._recordsFromJsonp(inputText, function(data) {// is async request then it need callback\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tthat._recordsCache = data;\r\n\t\t\t\t\tthat.showTooltip();\r\n\t\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthat = this;\r\n\t\t\t\tthis._recordsFromAjax(inputText, function(data) {// is async request then it need callback\r\n\t\t\t\t\tthat._recordsCache = data;\r\n\t\t\t\t\tthat.showTooltip();\r\n\t\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(this.options.layer)\t//SEARCH ELEMENTS IN PRELOADED LAYER\r\n\t\t{\r\n\t\t\tthis._recordsCache = this._recordsFromLayer();\t//fill table key,value from markers into layer\t\t\t\t\r\n\t\t\tthis.showTooltip();\r\n\t\t\tL.DomUtil.removeClass(this._container, 'search-load');\r\n\t\t}\r\n\t},\r\n\t\r\n\t_handleAutoresize: function() {\t//autoresize this._input\r\n\t    //TODO refact _handleAutoresize now is not accurate\r\n\t    if (this._input.style.maxWidth != this._map._container.offsetWidth) //If maxWidth isn't the same as when first set, reset to current Map width\r\n\t        this._input.style.maxWidth = L.DomUtil.getStyle(this._map._container, 'width');\r\n\r\n\t\tif(this.options.autoResize && (this._container.offsetWidth + 45 < this._map._container.offsetWidth))\r\n\t\t\tthis._input.size = this._input.value.length<this._inputMinSize ? this._inputMinSize : this._input.value.length;\r\n\t},\r\n\r\n\t_handleArrowSelect: function(velocity) {\r\n\t\r\n\t\tvar searchTips = this._tooltip.hasChildNodes() ? this._tooltip.childNodes : [];\r\n\t\t\t\r\n\t\tfor (i=0; i<searchTips.length; i++)\r\n\t\t\tL.DomUtil.removeClass(searchTips[i], 'search-tip-select');\r\n\t\t\r\n\t\tif ((velocity == 1 ) && (this._tooltip.currentSelection >= (searchTips.length - 1))) {// If at end of list.\r\n\t\t\tL.DomUtil.addClass(searchTips[this._tooltip.currentSelection], 'search-tip-select');\r\n\t\t}\r\n\t\telse if ((velocity == -1 ) && (this._tooltip.currentSelection <= 0)) { // Going back up to the search box.\r\n\t\t\tthis._tooltip.currentSelection = -1;\r\n\t\t}\r\n\t\telse if (this._tooltip.style.display != 'none') { // regular up/down\r\n\t\t\tthis._tooltip.currentSelection += velocity;\r\n\t\t\t\r\n\t\t\tL.DomUtil.addClass(searchTips[this._tooltip.currentSelection], 'search-tip-select');\r\n\t\t\t\r\n\t\t\tthis._input.value = searchTips[this._tooltip.currentSelection]._text;\r\n\r\n\t\t\t// scroll:\r\n\t\t\tvar tipOffsetTop = searchTips[this._tooltip.currentSelection].offsetTop;\r\n\t\t\t\r\n\t\t\tif (tipOffsetTop + searchTips[this._tooltip.currentSelection].clientHeight >= this._tooltip.scrollTop + this._tooltip.clientHeight) {\r\n\t\t\t\tthis._tooltip.scrollTop = tipOffsetTop - this._tooltip.clientHeight + searchTips[this._tooltip.currentSelection].clientHeight;\r\n\t\t\t}\r\n\t\t\telse if (tipOffsetTop <= this._tooltip.scrollTop) {\r\n\t\t\t\tthis._tooltip.scrollTop = tipOffsetTop;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_handleSubmit: function() {\t//button and tooltip click and enter submit\r\n\r\n\t\tthis._hideAutoType();\r\n\t\t\r\n\t\tthis.hideAlert();\r\n\t\tthis._hideTooltip();\r\n\r\n\t\tif(this._input.style.display == 'none')\t//on first click show _input only\r\n\t\t\tthis.expand();\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(this._input.value === '')\t//hide _input only\r\n\t\t\t\tthis.collapse();\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tvar loc = this._getLocation(this._input.value);\r\n\t\t\t\t$.publish('analyticsEvent',{event:[this.options.scope,'input#cercaTopoOK',this._input.value, 8]});\r\n\t\t\t\t\r\n\t\t\t\t\tthis.showLocation(loc, this._input.value,this._input.value);\r\n\t\t\t\t\tthis.fire('search_locationfound', {\r\n\t\t\t\t\t\t\tlatlng: loc,\r\n\t\t\t\t\t\t\ttext: this._input.value,\r\n\t\t\t\t\t\t\tlayer: loc.layer ? loc.layer : null\r\n\t\t\t\t\t\t});\r\n\t\t\t\t//}\r\n\t\t\t\t//this.collapse();\r\n\t\t\t\t//FIXME if collapse in _handleSubmit hide _markerLoc!\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_getLocation: function(key) {\t//extract latlng from _recordsCache\r\n\r\n\t\tif( this._recordsCache.hasOwnProperty(key) )\r\n\t\t\treturn this._recordsCache[key];//then after use .loc attribute\r\n\t\telse\r\n\t\t\treturn false;\r\n\t},\r\n\r\n\tshowLocation: function(latlng, title,nom) {\t//set location on map from _recordsCache\r\n\t\tif(this.options.zoom)\r\n\t\t\tthis._map.setView(latlng, this.options.zoom);\r\n\t\telse\r\n\t\t\tthis._map.panTo(latlng);\r\n\t\r\n\t\tvar v_url = window.location.href;\r\n\t\tvar defaultPunt= L.AwesomeMarkers.icon(default_marker_style);\t\r\n\t\tif(this._markerLoc)\r\n\t\t{\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif(v_url.indexOf('visor')==-1){\r\n\t\t\t\t\r\n\t\t\t\tvar marker;\r\n\t\t\t\t//this._markerLoc.setLatLng(latlng);  //show circle/marker in location found\r\n\t\t\t\tif(defaultPunt.options.markerColor!=\"punt_r\"){\t\t\t\t\t\r\n\t\t\t\t\tmarker=L.marker([0,0],\r\n\t\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t tipus: t_marker});\r\n\t\t\t\t}else{\r\n\t\t\t\t\t//Si és cercle sense glifon\r\n\t\t\t\t\tmarker= L.circleMarker([0,0],\r\n\t\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \r\n\t\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\r\n\t\t\t\t\t\t\t  color :  defaultPunt.options.color,\r\n\t\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\r\n\t\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\r\n\t\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\r\n\t\t\t\t\t\t\t  tipus: t_marker}\t\t\t\t\t\t\t\r\n\t\t\t\t\t);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tmarker.setLatLng(latlng);\r\n\t\t\t\tmarker.addTo(map);\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nom,\r\n\t\t\t\t\tzIndex :  -1,\r\n\t//\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_marker\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t\tmarker.properties={\r\n\t\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\r\n\t\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\r\n\t\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\r\n\t\t\t\t\t\t'tipusFeature':t_marker};\t\r\n\t\t\t\t\r\n\t\t\t\tmarker.properties.data={\r\n\t\t\t\t\t\t'nom':nom,\r\n\t\t\t\t\t\t'text':title,\r\n\t\t\t\t};\r\n\t\t\t\tcapaUsrActiva.addLayer(marker);\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tvar marker=null;\r\n\t\t\t\tif(!defaultPunt.options.isCanvas){\r\n\t\t\t\t\tmarker=L.marker([0,0],\r\n\t\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t tipus: t_marker});\r\n\t\t\t\t}else{\r\n\t\t\t\t\t//Si és cercle sense glifon\r\n\t\t\t\t\tmarker= L.circleMarker([0,0],\r\n\t\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \r\n\t\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\r\n\t\t\t\t\t\t\t  color :  defaultPunt.options.color,\r\n\t\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\r\n\t\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\r\n\t\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\r\n\t\t\t\t\t\t\t  tipus: t_marker}\t\t\t\t\t\t\t\r\n\t\t\t\t\t);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tmarker.setLatLng(latlng); \r\n\t\t\t\t\r\n\t\t\t\t//console.debug(\"createPopupWindowData\");\r\n\t\t\t\tvar html='';\r\n\t\t\t\t\r\n\t\t\t\thtml+='<h4>'+nom+'</h4>';\t\t\t\t\r\n\t\t\t\thtml+='<div>'+title+'</div>';\r\n\t\t\t\t\r\n\t\t\t\tmarker.bindPopup(html,{'offset':[0,-25]});\r\n\t\t\t\t\r\n\t\t\t\tthis._layer.addLayer(marker);\r\n\t\t\t\tmap.addLayer(this._layer);\r\n\t\t\t\t//map.addLayer(this._layer);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\t\tclearTimeout(this.timerKeypress);\r\n\t\t\r\n\t\t//FIXME autoCollapse option hide this._markerLoc before that visualized!!\r\n\t\tif(this.options.autoCollapse)\r\n\t\t\tthis.collapse();\r\n\t\treturn this;\r\n\t}\r\n});\r\n\r\n/*\r\nvar SearchMarker = L.Marker.extend({\r\n\r\n\tincludes: L.Mixin.Events,\r\n\t\r\n\toptions: {\r\n\t\tradius: 10,\r\n\t\tweight: 3,\r\n\t\tcolor: '#e03',\r\n\t\tstroke: true,\r\n\t\tfill: false,\r\n\t\ttitle: '',\r\n\t\t//TODO add custom icon!\t\r\n\t\tmarker: false\t//show icon optional, show only circleLoc\r\n\t},\r\n\t\r\n\tinitialize: function (latlng, options) {\r\n\t\tL.setOptions(this, options);\r\n\t\tL.Marker.prototype.initialize.call(this, latlng, options);\r\n\t\tthis._circleLoc = new L.CircleMarker(latlng, this.options);\r\n\t\t//TODO add inner circle\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tL.Marker.prototype.onAdd.call(this, map);\r\n\t\tmap.addLayer(this._circleLoc);\r\n\t\tthis.hide();\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tL.Marker.prototype.onRemove.call(this, map);\r\n\t\tmap.removeLayer(this._circleLoc);\r\n\t},\t\r\n\t\r\n\tsetLatLng: function (latlng) {\r\n\t\tL.Marker.prototype.setLatLng.call(this, latlng);\r\n\t\tthis._circleLoc.setLatLng(latlng);\r\n\t\treturn this;\r\n\t},\r\n\t\r\n\tsetTitle: function(title) {\r\n\t\ttitle = title || '';\r\n\t\tthis.options.title = title;\r\n\t\tif(this._icon)\r\n\t\t\tthis._icon.title = title;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tshow: function() {\r\n\t\tif(this.options.marker)\r\n\t\t{\r\n\t\t\tif(this._icon)\r\n\t\t\t\tthis._icon.style.display = 'block';\r\n\t\t\tif(this._shadow)\r\n\t\t\t\tthis._shadow.style.display = 'block';\r\n\t\t\t//this._bringToFront();\r\n\t\t}\r\n\t\tif(this._circleLoc)\r\n\t\t{\r\n\t\t\tthis._circleLoc.setStyle({fill: this.options.fill, stroke: this.options.stroke});\r\n\t\t\t//this._circleLoc.bringToFront();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\thide: function() {\r\n\t\tif(this._icon)\r\n\t\t\tthis._icon.style.display = 'none';\r\n\t\tif(this._shadow)\r\n\t\t\tthis._shadow.style.display = 'none';\r\n\t\tif(this._circleLoc)\t\t\t\r\n\t\t\tthis._circleLoc.setStyle({fill: false, stroke: false});\r\n\t\treturn this;\r\n\t},\r\n\r\n\tanimate: function() {\r\n\t//TODO refact animate() more smooth! like this: http://goo.gl/DDlRs\r\n\t\tvar circle = this._circleLoc,\r\n\t\t\ttInt = 200,\t//time interval\r\n\t\t\tss = 10,\t//frames\r\n\t\t\tmr = parseInt(circle._radius/ss),\r\n\t\t\toldrad = this.options.radius,\r\n\t\t\tnewrad = circle._radius * 2.5,\r\n\t\t\tacc = 0;\r\n\r\n\t\tcircle._timerAnimLoc = setInterval(function() {\r\n\t\t\tacc += 0.5;\r\n\t\t\tmr += acc;\t//adding acceleration\r\n\t\t\tnewrad -= mr;\r\n\t\t\t\r\n\t\t\tcircle.setRadius(newrad);\r\n\r\n\t\t\tif(newrad<oldrad)\r\n\t\t\t{\r\n\t\t\t\tclearInterval(circle._timerAnimLoc);\r\n\t\t\t\tcircle.setRadius(oldrad);//reset radius\r\n\t\t\t\t//if(typeof afterAnimCall == 'function')\r\n\t\t\t\t\t//afterAnimCall();\r\n\t\t\t\t\t//TODO use create event 'animateEnd' in SearchMarker \r\n\t\t\t}\r\n\t\t}, tInt);\r\n\t\t\r\n\t\treturn this;\r\n\t }\r\n});*/\r\n\r\nL.Map.addInitHook(function () {\r\n    if (this.options.searchControl) {\r\n        this.searchControl = L.control.search(this.options.searchControl);\r\n        this.addControl(this.searchControl);\r\n    }\r\n});\r\n\r\nL.control.search = function (options) {\r\n    return new L.Control.Search(options);\r\n};\r\n\r\n}).call(this);\r\n\r\n","var catContorn= [new L.LatLng( 41.07088, 1.94891 ), new L.LatLng( 41.07066, 1.94848 ), new L.LatLng( 41.07029, 1.94621 ), new L.LatLng( 41.06905, 1.94367 ), new L.LatLng( 41.06713, 1.93675 ), new L.LatLng( 41.05791, 1.87074 ), new L.LatLng( 41.05638, 1.86145 ), new L.LatLng( 41.05579, 1.85968 ), new L.LatLng( 41.05556, 1.85833 ), new L.LatLng( 41.05496, 1.85716 ), new L.LatLng( 41.05338, 1.84738 ), new L.LatLng( 41.04211, 1.82503 ), new L.LatLng( 41.03047, 1.75295 ), new L.LatLng( 41.03017, 1.75238 ), new L.LatLng( 41.02522, 1.72904 ), new L.LatLng( 41.02165, 1.71546 ), new L.LatLng( 41.02054, 1.71000 ), new L.LatLng( 41.01991, 1.70398 ), new L.LatLng( 41.01716, 1.69107 ), new L.LatLng( 41.01614, 1.68140 ), new L.LatLng( 41.01540, 1.66879 ), new L.LatLng( 41.00953, 1.64076 ), new L.LatLng( 41.00927, 1.63811 ), new L.LatLng( 41.00774, 1.61073 ), new L.LatLng( 41.00850, 1.60525 ), new L.LatLng( 41.00479, 1.59129 ), new L.LatLng( 41.00432, 1.58899 ), new L.LatLng( 41.00139, 1.56170 ), new L.LatLng( 41.00127, 1.56126 ), new L.LatLng( 40.99840, 1.55401 ), new L.LatLng( 40.99766, 1.55231 ), new L.LatLng( 40.99613, 1.54940 ), new L.LatLng( 40.99011, 1.54026 ), new L.LatLng( 40.98790, 1.53625 ), new L.LatLng( 40.98159, 1.52171 ), new L.LatLng( 40.96908, 1.49789 ), new L.LatLng( 40.95415, 1.40729 ), new L.LatLng( 40.95429, 1.40623 ), new L.LatLng( 40.95333, 1.40037 ), new L.LatLng( 40.95358, 1.39427 ), new L.LatLng( 40.95240, 1.38521 ), new L.LatLng( 40.95153, 1.37995 ), new L.LatLng( 40.93441, 1.34544 ), new L.LatLng( 40.93174, 1.34319 ), new L.LatLng( 40.89157, 1.26717 ), new L.LatLng( 40.88362, 1.21949 ), new L.LatLng( 40.88046, 1.20519 ), new L.LatLng( 40.87964, 1.19827 ), new L.LatLng( 40.87936, 1.19403 ), new L.LatLng( 40.87647, 1.17674 ), new L.LatLng( 40.88188, 1.11723 ), new L.LatLng( 40.86572, 1.10366 ), new L.LatLng( 40.86152, 1.09612 ), new L.LatLng( 40.84059, 1.06246 ), new L.LatLng( 40.81600, 1.08618 ), new L.LatLng( 40.80741, 1.09173 ), new L.LatLng( 40.80384, 1.09288 ), new L.LatLng( 40.80047, 1.09598 ), new L.LatLng( 40.75908, 1.11247 ), new L.LatLng( 40.75148, 1.11422 ), new L.LatLng( 40.72426, 1.11772 ), new L.LatLng( 40.66538, 1.10647 ), new L.LatLng( 40.64644, 1.09849 ), new L.LatLng( 40.64205, 1.09506 ), new L.LatLng( 40.63611, 1.09369 ), new L.LatLng( 40.59434, 1.06348 ), new L.LatLng( 40.58387, 1.05334 ), new L.LatLng( 40.56637, 1.03402 ), new L.LatLng( 40.55067, 1.01163 ), new L.LatLng( 40.53803, 0.99111 ), new L.LatLng( 40.52596, 0.96516 ), new L.LatLng( 40.51864, 0.95244 ), new L.LatLng( 40.50554, 0.91975 ), new L.LatLng( 40.49942, 0.91443 ), new L.LatLng( 40.49605, 0.51561 ), new L.LatLng( 40.50384, 0.47462 ), new L.LatLng( 40.52674, 0.41491 ), new L.LatLng( 40.54219, 0.40244 ), new L.LatLng( 40.56436, 0.39892 ), new L.LatLng( 40.57879, 0.37796 ), new L.LatLng( 40.58118, 0.33371 ), new L.LatLng( 40.59385, 0.33076 ), new L.LatLng( 40.59590, 0.31505 ), new L.LatLng( 40.60164, 0.30290 ), new L.LatLng( 40.59405, 0.29124 ), new L.LatLng( 40.60640, 0.26035 ), new L.LatLng( 40.62209, 0.24270 ), new L.LatLng( 40.63681, 0.23201 ), new L.LatLng( 40.64621, 0.23026 ), new L.LatLng( 40.67282, 0.23709 ), new L.LatLng( 40.68064, 0.21382 ), new L.LatLng( 40.69748, 0.20113 ), new L.LatLng( 40.70252, 0.16895 ), new L.LatLng( 40.71180, 0.14707 ), new L.LatLng( 40.71979, 0.13857 ), new L.LatLng( 40.74909, 0.12487 ), new L.LatLng( 40.76740, 0.13317 ), new L.LatLng( 40.77494, 0.14585 ), new L.LatLng( 40.78385, 0.18409 ), new L.LatLng( 40.79314, 0.20019 ), new L.LatLng( 40.80563, 0.20865 ), new L.LatLng( 40.82283, 0.23139 ), new L.LatLng( 40.84643, 0.21806 ), new L.LatLng( 40.86268, 0.21600 ), new L.LatLng( 40.87335, 0.20621 ), new L.LatLng( 40.87854, 0.20181 ), new L.LatLng( 40.86693, 0.17371 ), new L.LatLng( 40.86768, 0.15376 ), new L.LatLng( 40.87628, 0.13789 ), new L.LatLng( 40.89037, 0.12675 ), new L.LatLng( 40.93069, 0.12701 ), new L.LatLng( 40.93586, 0.14132 ), new L.LatLng( 40.93462, 0.22399 ), new L.LatLng( 40.96669, 0.24835 ), new L.LatLng( 41.00875, 0.22405 ), new L.LatLng( 41.02249, 0.19535 ), new L.LatLng( 41.03394, 0.18475 ), new L.LatLng( 41.06212, 0.18202 ), new L.LatLng( 41.07289, 0.16923 ), new L.LatLng( 41.08339, 0.16509 ), new L.LatLng( 41.13481, 0.16710 ), new L.LatLng( 41.15500, 0.18661 ), new L.LatLng( 41.16105, 0.19742 ), new L.LatLng( 41.16311, 0.22196 ), new L.LatLng( 41.17445, 0.23796 ), new L.LatLng( 41.17683, 0.26081 ), new L.LatLng( 41.18126, 0.26958 ), new L.LatLng( 41.22862, 0.28506 ), new L.LatLng( 41.23914, 0.29212 ), new L.LatLng( 41.24944, 0.30833 ), new L.LatLng( 41.25760, 0.34015 ), new L.LatLng( 41.27565, 0.34467 ), new L.LatLng( 41.29262, 0.33239 ), new L.LatLng( 41.30309, 0.32927 ), new L.LatLng( 41.31729, 0.31527 ), new L.LatLng( 41.37445, 0.29692 ), new L.LatLng( 41.38371, 0.28770 ), new L.LatLng( 41.39397, 0.28454 ), new L.LatLng( 41.41183, 0.29192 ), new L.LatLng( 41.42874, 0.31040 ), new L.LatLng( 41.43934, 0.30858 ), new L.LatLng( 41.44989, 0.31216 ), new L.LatLng( 41.47845, 0.30308 ), new L.LatLng( 41.48896, 0.30343 ), new L.LatLng( 41.50086, 0.31042 ), new L.LatLng( 41.50979, 0.32438 ), new L.LatLng( 41.51419, 0.34728 ), new L.LatLng( 41.51271, 0.37362 ), new L.LatLng( 41.52597, 0.38375 ), new L.LatLng( 41.53111, 0.41768 ), new L.LatLng( 41.53786, 0.42032 ), new L.LatLng( 41.54628, 0.41848 ), new L.LatLng( 41.55040, 0.41113 ), new L.LatLng( 41.54994, 0.40109 ), new L.LatLng( 41.56688, 0.39509 ), new L.LatLng( 41.57427, 0.33683 ), new L.LatLng( 41.57986, 0.32493 ), new L.LatLng( 41.58843, 0.31678 ), new L.LatLng( 41.62090, 0.31046 ), new L.LatLng( 41.63113, 0.31251 ), new L.LatLng( 41.65111, 0.29444 ), new L.LatLng( 41.66940, 0.28989 ), new L.LatLng( 41.69024, 0.29387 ), new L.LatLng( 41.71067, 0.31125 ), new L.LatLng( 41.71054, 0.28554 ), new L.LatLng( 41.72891, 0.28472 ), new L.LatLng( 41.73349, 0.29896 ), new L.LatLng( 41.73285, 0.32387 ), new L.LatLng( 41.72738, 0.33322 ), new L.LatLng( 41.73694, 0.33663 ), new L.LatLng( 41.77656, 0.37329 ), new L.LatLng( 41.78293, 0.38660 ), new L.LatLng( 41.79109, 0.43810 ), new L.LatLng( 41.81989, 0.45765 ), new L.LatLng( 41.84449, 0.49398 ), new L.LatLng( 41.84957, 0.51674 ), new L.LatLng( 41.86123, 0.52064 ), new L.LatLng( 41.87098, 0.56885 ), new L.LatLng( 41.89931, 0.59511 ), new L.LatLng( 41.91544, 0.59548 ), new L.LatLng( 41.92084, 0.57851 ), new L.LatLng( 41.92307, 0.53454 ), new L.LatLng( 41.93185, 0.52630 ), new L.LatLng( 41.94391, 0.52686 ), new L.LatLng( 41.96049, 0.53666 ), new L.LatLng( 41.98417, 0.55990 ), new L.LatLng( 41.99400, 0.58192 ), new L.LatLng( 42.00941, 0.59480 ), new L.LatLng( 42.01837, 0.61688 ), new L.LatLng( 42.03007, 0.61628 ), new L.LatLng( 42.04842, 0.62272 ), new L.LatLng( 42.06060, 0.63378 ), new L.LatLng( 42.10284, 0.65188 ), new L.LatLng( 42.11482, 0.66318 ), new L.LatLng( 42.13940, 0.65938 ), new L.LatLng( 42.18102, 0.66337 ), new L.LatLng( 42.21911, 0.67801 ), new L.LatLng( 42.23517, 0.68061 ), new L.LatLng( 42.26368, 0.70083 ), new L.LatLng( 42.28983, 0.70381 ), new L.LatLng( 42.31359, 0.71338 ), new L.LatLng( 42.33039, 0.70630 ), new L.LatLng( 42.34224, 0.70647 ), new L.LatLng( 42.35548, 0.69007 ), new L.LatLng( 42.37054, 0.68697 ), new L.LatLng( 42.36935, 0.58727 ), new L.LatLng( 42.36066, 0.55420 ), new L.LatLng( 42.36924, 0.48478 ), new L.LatLng( 42.42879, 0.48808 ), new L.LatLng( 42.45198, 0.52073 ), new L.LatLng( 42.45867, 0.65592 ), new L.LatLng( 42.47682, 0.65662 ), new L.LatLng( 42.49173, 0.65520 ), new L.LatLng( 42.50566, 0.66459 ), new L.LatLng( 42.51975, 0.68541 ), new L.LatLng( 42.53645, 0.68815 ), new L.LatLng( 42.55578, 0.70254 ), new L.LatLng( 42.56377, 0.71435 ), new L.LatLng( 42.58657, 0.72388 ), new L.LatLng( 42.60167, 0.68326 ), new L.LatLng( 42.60908, 0.67230 ), new L.LatLng( 42.61987, 0.66401 ), new L.LatLng( 42.61760, 0.59368 ), new L.LatLng( 42.62180, 0.58646 ), new L.LatLng( 42.64319, 0.58506 ), new L.LatLng( 42.65763, 0.58830 ), new L.LatLng( 42.66089, 0.61333 ), new L.LatLng( 42.66075, 0.64249 ), new L.LatLng( 42.67625, 0.62776 ), new L.LatLng( 42.69016, 0.62346 ), new L.LatLng( 42.70055, 0.62585 ), new L.LatLng( 42.71190, 0.63770 ), new L.LatLng( 42.72096, 0.63661 ), new L.LatLng( 42.72687, 0.63339 ), new L.LatLng( 42.73575, 0.61189 ), new L.LatLng( 42.75328, 0.60200 ), new L.LatLng( 42.76367, 0.60439 ), new L.LatLng( 42.77301, 0.61227 ), new L.LatLng( 42.78267, 0.60936 ), new L.LatLng( 42.79306, 0.61175 ), new L.LatLng( 42.81130, 0.62806 ), new L.LatLng( 42.83789, 0.62241 ), new L.LatLng( 42.85370, 0.62909 ), new L.LatLng( 42.87402, 0.65098 ), new L.LatLng( 42.88012, 0.66267 ), new L.LatLng( 42.88246, 0.68464 ), new L.LatLng( 42.88885, 0.70785 ), new L.LatLng( 42.88603, 0.73190 ), new L.LatLng( 42.86489, 0.78227 ), new L.LatLng( 42.86706, 0.80978 ), new L.LatLng( 42.86346, 0.82600 ), new L.LatLng( 42.85611, 0.84146 ), new L.LatLng( 42.85135, 0.87194 ), new L.LatLng( 42.82354, 0.92631 ), new L.LatLng( 42.83100, 0.94767 ), new L.LatLng( 42.83247, 0.96166 ), new L.LatLng( 42.82784, 0.98160 ), new L.LatLng( 42.81703, 0.99833 ), new L.LatLng( 42.81757, 1.01035 ), new L.LatLng( 42.81030, 1.05644 ), new L.LatLng( 42.81542, 1.07678 ), new L.LatLng( 42.81359, 1.09254 ), new L.LatLng( 42.77932, 1.14903 ), new L.LatLng( 42.76121, 1.16591 ), new L.LatLng( 42.74590, 1.16879 ), new L.LatLng( 42.74125, 1.17361 ), new L.LatLng( 42.75430, 1.22646 ), new L.LatLng( 42.75320, 1.24123 ), new L.LatLng( 42.74518, 1.26557 ), new L.LatLng( 42.74586, 1.30283 ), new L.LatLng( 42.75024, 1.31610 ), new L.LatLng( 42.75117, 1.33716 ), new L.LatLng( 42.74512, 1.37040 ), new L.LatLng( 42.73924, 1.38315 ), new L.LatLng( 42.73059, 1.39131 ), new L.LatLng( 42.71780, 1.39486 ), new L.LatLng( 42.70787, 1.41311 ), new L.LatLng( 42.69654, 1.42299 ), new L.LatLng( 42.70299, 1.48050 ), new L.LatLng( 42.69861, 1.52276 ), new L.LatLng( 42.69900, 1.55742 ), new L.LatLng( 42.69577, 1.56697 ), new L.LatLng( 42.67829, 1.56699 ), new L.LatLng( 42.67587, 1.47123 ), new L.LatLng( 42.66270, 1.47063 ), new L.LatLng( 42.66013, 1.44930 ), new L.LatLng( 42.64028, 1.45352 ), new L.LatLng( 42.60832, 1.47904 ), new L.LatLng( 42.58542, 1.47428 ), new L.LatLng( 42.57006, 1.48036 ), new L.LatLng( 42.55757, 1.47789 ), new L.LatLng( 42.51370, 1.50397 ), new L.LatLng( 42.50250, 1.50264 ), new L.LatLng( 42.49359, 1.49659 ), new L.LatLng( 42.48053, 1.47661 ), new L.LatLng( 42.46117, 1.48398 ), new L.LatLng( 42.45867, 1.52059 ), new L.LatLng( 42.46796, 1.52463 ), new L.LatLng( 42.47854, 1.53618 ), new L.LatLng( 42.48124, 1.56348 ), new L.LatLng( 42.48634, 1.56995 ), new L.LatLng( 42.48083, 1.57416 ), new L.LatLng( 42.47981, 1.58406 ), new L.LatLng( 42.48182, 1.62970 ), new L.LatLng( 42.48907, 1.63280 ), new L.LatLng( 42.49918, 1.64986 ), new L.LatLng( 42.50093, 1.65870 ), new L.LatLng( 42.51496, 1.65740 ), new L.LatLng( 42.52250, 1.64167 ), new L.LatLng( 42.53054, 1.65732 ), new L.LatLng( 42.53081, 1.68070 ), new L.LatLng( 42.52262, 1.69775 ), new L.LatLng( 42.52749, 1.70981 ), new L.LatLng( 42.52965, 1.72722 ), new L.LatLng( 42.52789, 1.73885 ), new L.LatLng( 42.52127, 1.75192 ), new L.LatLng( 42.51291, 1.78418 ), new L.LatLng( 42.51707, 1.80639 ), new L.LatLng( 42.51088, 1.83754 ), new L.LatLng( 42.50361, 1.85641 ), new L.LatLng( 42.49134, 1.87401 ), new L.LatLng( 42.48338, 1.89869 ), new L.LatLng( 42.47583, 1.91121 ), new L.LatLng( 42.47954, 1.92570 ), new L.LatLng( 42.49384, 1.93299 ), new L.LatLng( 42.51272, 1.95286 ), new L.LatLng( 42.51816, 1.96315 ), new L.LatLng( 42.52090, 1.98903 ), new L.LatLng( 42.51669, 2.00823 ), new L.LatLng( 42.49052, 2.03759 ), new L.LatLng( 42.48699, 2.05246 ), new L.LatLng( 42.47121, 2.05982 ), new L.LatLng( 42.46611, 2.04484 ), new L.LatLng( 42.44685, 2.04971 ), new L.LatLng( 42.42988, 2.03842 ), new L.LatLng( 42.42351, 2.02505 ), new L.LatLng( 42.41997, 1.99421 ), new L.LatLng( 42.39893, 1.99768 ), new L.LatLng( 42.40635, 2.00360 ), new L.LatLng( 42.40898, 2.01123 ), new L.LatLng( 42.40337, 2.08053 ), new L.LatLng( 42.43217, 2.10357 ), new L.LatLng( 42.44865, 2.14305 ), new L.LatLng( 42.45148, 2.16868 ), new L.LatLng( 42.44542, 2.19491 ), new L.LatLng( 42.45314, 2.22342 ), new L.LatLng( 42.46357, 2.24134 ), new L.LatLng( 42.46584, 2.25716 ), new L.LatLng( 42.45463, 2.29521 ), new L.LatLng( 42.45603, 2.30948 ), new L.LatLng( 42.45376, 2.32546 ), new L.LatLng( 42.44374, 2.34567 ), new L.LatLng( 42.43806, 2.36767 ), new L.LatLng( 42.44010, 2.38897 ), new L.LatLng( 42.43819, 2.38994 ), new L.LatLng( 42.44616, 2.40222 ), new L.LatLng( 42.43756, 2.41382 ), new L.LatLng( 42.43974, 2.44057 ), new L.LatLng( 42.43635, 2.45653 ), new L.LatLng( 42.43034, 2.45964 ), new L.LatLng( 42.41286, 2.45766 ), new L.LatLng( 42.40472, 2.46607 ), new L.LatLng( 42.39336, 2.47088 ), new L.LatLng( 42.37954, 2.49202 ), new L.LatLng( 42.37017, 2.50069 ), new L.LatLng( 42.36580, 2.52122 ), new L.LatLng( 42.37825, 2.53773 ), new L.LatLng( 42.38488, 2.56695 ), new L.LatLng( 42.38329, 2.59452 ), new L.LatLng( 42.37495, 2.61825 ), new L.LatLng( 42.38650, 2.61512 ), new L.LatLng( 42.39832, 2.61853 ), new L.LatLng( 42.42131, 2.64526 ), new L.LatLng( 42.43640, 2.63571 ), new L.LatLng( 42.45003, 2.63569 ), new L.LatLng( 42.45111, 2.64871 ), new L.LatLng( 42.44558, 2.66714 ), new L.LatLng( 42.44540, 2.68171 ), new L.LatLng( 42.44578, 2.69700 ), new L.LatLng( 42.45023, 2.69734 ), new L.LatLng( 42.45164, 2.70447 ), new L.LatLng( 42.44805, 2.71025 ), new L.LatLng( 42.45262, 2.75639 ), new L.LatLng( 42.44775, 2.77648 ), new L.LatLng( 42.46454, 2.80081 ), new L.LatLng( 42.47833, 2.81359 ), new L.LatLng( 42.48421, 2.82541 ), new L.LatLng( 42.48597, 2.84289 ), new L.LatLng( 42.49250, 2.85583 ), new L.LatLng( 42.49467, 2.87023 ), new L.LatLng( 42.48787, 2.90052 ), new L.LatLng( 42.50627, 2.93086 ), new L.LatLng( 42.50899, 2.94456 ), new L.LatLng( 42.50711, 2.96091 ), new L.LatLng( 42.49983, 2.97434 ), new L.LatLng( 42.50215, 2.98996 ), new L.LatLng( 42.49890, 3.01500 ), new L.LatLng( 42.50190, 3.03199 ), new L.LatLng( 42.49906, 3.05361 ), new L.LatLng( 42.48951, 3.07003 ), new L.LatLng( 42.46693, 3.08312 ), new L.LatLng( 42.45993, 3.09467 ), new L.LatLng( 42.46535, 3.12097 ), new L.LatLng( 42.46289, 3.29906 ), new L.LatLng( 42.43429, 3.36389 ), new L.LatLng( 42.39945, 3.40221 ), new L.LatLng( 42.35343, 3.43178 ), new L.LatLng( 41.89415, 3.43270 ), new L.LatLng( 41.87526, 3.43273 ), new L.LatLng( 41.83873, 3.42726 ), new L.LatLng( 41.81802, 3.42107 ), new L.LatLng( 41.81669, 3.42082 ), new L.LatLng( 41.81665, 3.42081 ), new L.LatLng( 41.81351, 3.41935 ), new L.LatLng( 41.81154, 3.41894 ), new L.LatLng( 41.81149, 3.41892 ), new L.LatLng( 41.80253, 3.41457 ), new L.LatLng( 41.80199, 3.41444 ), new L.LatLng( 41.80194, 3.41442 ), new L.LatLng( 41.80159, 3.41411 ), new L.LatLng( 41.79632, 3.41156 ), new L.LatLng( 41.79429, 3.41100 ), new L.LatLng( 41.78530, 3.40486 ), new L.LatLng( 41.78169, 3.40260 ), new L.LatLng( 41.78164, 3.40257 ), new L.LatLng( 41.78093, 3.40187 ), new L.LatLng( 41.77013, 3.39450 ), new L.LatLng( 41.77009, 3.39446 ), new L.LatLng( 41.75453, 3.37803 ), new L.LatLng( 41.74983, 3.37424 ), new L.LatLng( 41.74978, 3.37419 ), new L.LatLng( 41.74267, 3.36552 ), new L.LatLng( 41.73598, 3.35846 ), new L.LatLng( 41.73423, 3.35494 ), new L.LatLng( 41.72154, 3.33555 ), new L.LatLng( 41.72151, 3.33550 ), new L.LatLng( 41.71071, 3.31047 ), new L.LatLng( 41.70206, 3.29422 ), new L.LatLng( 41.70203, 3.29414 ), new L.LatLng( 41.70102, 3.28827 ), new L.LatLng( 41.70054, 3.28733 ), new L.LatLng( 41.70052, 3.28726 ), new L.LatLng( 41.70046, 3.28694 ), new L.LatLng( 41.69715, 3.28027 ), new L.LatLng( 41.69549, 3.27140 ), new L.LatLng( 41.69530, 3.27101 ), new L.LatLng( 41.69529, 3.27095 ), new L.LatLng( 41.69514, 3.26983 ), new L.LatLng( 41.69204, 3.25784 ), new L.LatLng( 41.69024, 3.25648 ), new L.LatLng( 41.68929, 3.25554 ), new L.LatLng( 41.67334, 3.24261 ), new L.LatLng( 41.67323, 3.24248 ), new L.LatLng( 41.66116, 3.22771 ), new L.LatLng( 41.66009, 3.22555 ), new L.LatLng( 41.65732, 3.22060 ), new L.LatLng( 41.65629, 3.21968 ), new L.LatLng( 41.65584, 3.21877 ), new L.LatLng( 41.65392, 3.21705 ), new L.LatLng( 41.63677, 3.18904 ), new L.LatLng( 41.63606, 3.18801 ), new L.LatLng( 41.63447, 3.18546 ), new L.LatLng( 41.63416, 3.18479 ), new L.LatLng( 41.63154, 3.18050 ), new L.LatLng( 41.63151, 3.18045 ), new L.LatLng( 41.63147, 3.18035 ), new L.LatLng( 41.63141, 3.18026 ), new L.LatLng( 41.63138, 3.18018 ), new L.LatLng( 41.62625, 3.16731 ), new L.LatLng( 41.62480, 3.16412 ), new L.LatLng( 41.61812, 3.15267 ), new L.LatLng( 41.61806, 3.15254 ), new L.LatLng( 41.61073, 3.13306 ), new L.LatLng( 41.60801, 3.12706 ), new L.LatLng( 41.60541, 3.12474 ), new L.LatLng( 41.60311, 3.12014 ), new L.LatLng( 41.59989, 3.11726 ), new L.LatLng( 41.59898, 3.11545 ), new L.LatLng( 41.59431, 3.11128 ), new L.LatLng( 41.59335, 3.10971 ), new L.LatLng( 41.59260, 3.10860 ), new L.LatLng( 41.58967, 3.10598 ), new L.LatLng( 41.58623, 3.09910 ), new L.LatLng( 41.58110, 3.09147 ), new L.LatLng( 41.58106, 3.09140 ), new L.LatLng( 41.57840, 3.08540 ), new L.LatLng( 41.57193, 3.07487 ), new L.LatLng( 41.57190, 3.07481 ), new L.LatLng( 41.56438, 3.05605 ), new L.LatLng( 41.56360, 3.05465 ), new L.LatLng( 41.56359, 3.05462 ), new L.LatLng( 41.56263, 3.05311 ), new L.LatLng( 41.56260, 3.05306 ), new L.LatLng( 41.55981, 3.04635 ), new L.LatLng( 41.55066, 3.02812 ), new L.LatLng( 41.55007, 3.02453 ), new L.LatLng( 41.54811, 3.02091 ), new L.LatLng( 41.54810, 3.02086 ), new L.LatLng( 41.54752, 3.01759 ), new L.LatLng( 41.54746, 3.01747 ), new L.LatLng( 41.54729, 3.01633 ), new L.LatLng( 41.54267, 3.00524 ), new L.LatLng( 41.54253, 3.00433 ), new L.LatLng( 41.53698, 2.98190 ), new L.LatLng( 41.53640, 2.98034 ), new L.LatLng( 41.53610, 2.97835 ), new L.LatLng( 41.53591, 2.97757 ), new L.LatLng( 41.53509, 2.97454 ), new L.LatLng( 41.53451, 2.97333 ), new L.LatLng( 41.53449, 2.97328 ), new L.LatLng( 41.53422, 2.97126 ), new L.LatLng( 41.53290, 2.96634 ), new L.LatLng( 41.53287, 2.96623 ), new L.LatLng( 41.53266, 2.96436 ), new L.LatLng( 41.53122, 2.95904 ), new L.LatLng( 41.53119, 2.95894 ), new L.LatLng( 41.53078, 2.95532 ), new L.LatLng( 41.52788, 2.95279 ), new L.LatLng( 41.52374, 2.94746 ), new L.LatLng( 41.52292, 2.94586 ), new L.LatLng( 41.52167, 2.94475 ), new L.LatLng( 41.48255, 2.86706 ), new L.LatLng( 41.47716, 2.83959 ), new L.LatLng( 41.47556, 2.83523 ), new L.LatLng( 41.46486, 2.81246 ), new L.LatLng( 41.46471, 2.81151 ), new L.LatLng( 41.46432, 2.81073 ), new L.LatLng( 41.44002, 2.73160 ), new L.LatLng( 41.43966, 2.72916 ), new L.LatLng( 41.43925, 2.72726 ), new L.LatLng( 41.43595, 2.71920 ), new L.LatLng( 41.43518, 2.71417 ), new L.LatLng( 41.42533, 2.68612 ), new L.LatLng( 41.42051, 2.67377 ), new L.LatLng( 41.41075, 2.65454 ), new L.LatLng( 41.40862, 2.64533 ), new L.LatLng( 41.40473, 2.63050 ), new L.LatLng( 41.39620, 2.60917 ), new L.LatLng( 41.39188, 2.60068 ), new L.LatLng( 41.39147, 2.59795 ), new L.LatLng( 41.39140, 2.59780 ), new L.LatLng( 41.39113, 2.59604 ), new L.LatLng( 41.37554, 2.56528 ), new L.LatLng( 41.37539, 2.56502 ), new L.LatLng( 41.35440, 2.52958 ), new L.LatLng( 41.34020, 2.49829 ), new L.LatLng( 41.33548, 2.48597 ), new L.LatLng( 41.32463, 2.46471 ), new L.LatLng( 41.32164, 2.45326 ), new L.LatLng( 41.31940, 2.44527 ), new L.LatLng( 41.31806, 2.43978 ), new L.LatLng( 41.31800, 2.43930 ), new L.LatLng( 41.31685, 2.43486 ), new L.LatLng( 41.31567, 2.42914 ), new L.LatLng( 41.31549, 2.42743 ), new L.LatLng( 41.30591, 2.42018 ), new L.LatLng( 41.29560, 2.40976 ), new L.LatLng( 41.28848, 2.40157 ), new L.LatLng( 41.26931, 2.39438 ), new L.LatLng( 41.21058, 2.34321 ), new L.LatLng( 41.20502, 2.33237 ), new L.LatLng( 41.17843, 2.30530 ), new L.LatLng( 41.17501, 2.29863 ), new L.LatLng( 41.17080, 2.29472 ), new L.LatLng( 41.15886, 2.27715 ), new L.LatLng( 41.13858, 2.23501 ), new L.LatLng( 41.12893, 2.21681 ), new L.LatLng( 41.11451, 2.17514 ), new L.LatLng( 41.11398, 2.17202 ), new L.LatLng( 41.11252, 2.16919 ), new L.LatLng( 41.10426, 2.13750 ), new L.LatLng( 41.09444, 2.08910 ), new L.LatLng( 41.09226, 2.06812 ), new L.LatLng( 41.08936, 2.05358 ), new L.LatLng( 41.08682, 2.02335 ), new L.LatLng( 41.08577, 2.00088 ), new L.LatLng( 41.08572, 2.00058 ), new L.LatLng( 41.08568, 1.99687 ), new L.LatLng( 41.08484, 1.99525 ), new L.LatLng( 41.08430, 1.99183 ), new L.LatLng( 41.07956, 1.97402 ), new L.LatLng( 41.07282, 1.96104 ), new L.LatLng( 41.07088, 1.94891 ) ];\r\nvar catContorn5k= [ new L.LatLng( 42.09360, 3.20674 ), new L.LatLng( 42.07406, 3.22457 ), new L.LatLng( 42.06212, 3.22768 ), new L.LatLng( 42.05299, 3.23920 ), new L.LatLng( 42.04368, 3.24213 ), new L.LatLng( 42.03702, 3.23826 ), new L.LatLng( 42.03400, 3.22791 ), new L.LatLng( 42.04381, 3.21041 ), new L.LatLng( 42.00509, 3.21105 ), new L.LatLng( 41.98528, 3.22157 ), new L.LatLng( 41.97466, 3.24404 ), new L.LatLng( 41.95904, 3.24792 ), new L.LatLng( 41.94878, 3.24574 ), new L.LatLng( 41.93804, 3.23337 ), new L.LatLng( 41.91704, 3.23194 ), new L.LatLng( 41.91195, 3.22500 ), new L.LatLng( 41.88994, 3.21519 ), new L.LatLng( 41.87850, 3.19473 ), new L.LatLng( 41.87313, 3.19270 ), new L.LatLng( 41.86400, 3.20086 ), new L.LatLng( 41.85738, 3.19728 ), new L.LatLng( 41.85246, 3.15852 ), new L.LatLng( 41.84512, 3.15457 ), new L.LatLng( 41.83506, 3.13636 ), new L.LatLng( 41.83717, 3.10777 ), new L.LatLng( 41.82731, 3.10263 ), new L.LatLng( 41.81549, 3.08290 ), new L.LatLng( 41.79902, 3.07889 ), new L.LatLng( 41.78238, 3.06646 ), new L.LatLng( 41.76437, 3.03590 ), new L.LatLng( 41.76549, 3.01705 ), new L.LatLng( 41.75865, 3.00855 ), new L.LatLng( 41.75465, 2.99316 ), new L.LatLng( 41.74692, 2.98019 ), new L.LatLng( 41.72648, 2.96344 ), new L.LatLng( 41.70876, 2.94079 ), new L.LatLng( 41.69446, 2.89291 ), new L.LatLng( 41.69204, 2.85659 ), new L.LatLng( 41.68288, 2.82980 ), new L.LatLng( 41.66874, 2.81319 ), new L.LatLng( 41.66427, 2.79914 ), new L.LatLng( 41.64957, 2.79125 ), new L.LatLng( 41.64053, 2.77943 ), new L.LatLng( 41.63599, 2.75154 ), new L.LatLng( 41.62279, 2.72472 ), new L.LatLng( 41.59318, 2.62619 ), new L.LatLng( 41.57705, 2.58029 ), new L.LatLng( 41.56857, 2.56649 ), new L.LatLng( 41.56839, 2.55195 ), new L.LatLng( 41.54966, 2.51253 ), new L.LatLng( 41.53787, 2.47135 ), new L.LatLng( 41.52166, 2.45413 ), new L.LatLng( 41.51957, 2.44176 ), new L.LatLng( 41.48230, 2.37632 ), new L.LatLng( 41.47529, 2.33876 ), new L.LatLng( 41.46707, 2.31798 ), new L.LatLng( 41.46742, 2.30801 ), new L.LatLng( 41.45380, 2.27564 ), new L.LatLng( 41.44020, 2.25986 ), new L.LatLng( 41.40951, 2.23938 ), new L.LatLng( 41.37454, 2.20377 ), new L.LatLng( 41.34954, 2.18780 ), new L.LatLng( 41.33056, 2.18145 ), new L.LatLng( 41.32883, 2.16783 ), new L.LatLng( 41.29836, 2.14355 ), new L.LatLng( 41.28452, 2.12243 ), new L.LatLng( 41.26996, 2.08039 ), new L.LatLng( 41.25971, 2.03029 ), new L.LatLng( 41.25523, 1.94026 ), new L.LatLng( 41.25005, 1.92881 ), new L.LatLng( 41.24897, 1.91359 ), new L.LatLng( 41.24215, 1.90608 ), new L.LatLng( 41.23763, 1.87985 ), new L.LatLng( 41.23010, 1.87180 ), new L.LatLng( 41.22720, 1.85466 ), new L.LatLng( 41.22877, 1.83673 ), new L.LatLng( 41.22488, 1.82537 ), new L.LatLng( 41.22723, 1.81703 ), new L.LatLng( 41.21729, 1.79443 ), new L.LatLng( 41.21061, 1.75072 ), new L.LatLng( 41.19929, 1.73551 ), new L.LatLng( 41.20297, 1.71736 ), new L.LatLng( 41.20066, 1.70051 ), new L.LatLng( 41.19071, 1.67876 ), new L.LatLng( 41.18663, 1.65963 ), new L.LatLng( 41.18308, 1.61919 ), new L.LatLng( 41.17892, 1.60849 ), new L.LatLng( 41.18126, 1.59887 ), new L.LatLng( 41.17558, 1.54459 ), new L.LatLng( 41.16945, 1.52967 ), new L.LatLng( 41.17079, 1.52006 ), new L.LatLng( 41.15893, 1.47166 ), new L.LatLng( 41.14837, 1.44502 ), new L.LatLng( 41.13653, 1.41792 ), new L.LatLng( 41.12599, 1.40770 ), new L.LatLng( 41.12649, 1.38149 ), new L.LatLng( 41.11759, 1.34533 ), new L.LatLng( 41.12097, 1.33530 ), new L.LatLng( 41.12060, 1.30241 ), new L.LatLng( 41.10678, 1.27633 ), new L.LatLng( 41.10531, 1.26505 ), new L.LatLng( 41.09462, 1.25268 ), new L.LatLng( 41.09416, 1.24509 ), new L.LatLng( 41.07722, 1.22682 ), new L.LatLng( 41.07897, 1.21380 ), new L.LatLng( 41.08969, 1.21067 ), new L.LatLng( 41.07330, 1.19429 ), new L.LatLng( 41.06042, 1.19179 ), new L.LatLng( 41.04829, 1.17656 ), new L.LatLng( 41.04923, 1.15747 ), new L.LatLng( 41.05824, 1.14995 ), new L.LatLng( 41.06717, 1.12583 ), new L.LatLng( 41.05443, 1.08500 ), new L.LatLng( 41.05775, 1.07301 ), new L.LatLng( 41.05275, 1.06176 ), new L.LatLng( 41.05558, 1.05297 ), new L.LatLng( 41.03674, 1.00961 ), new L.LatLng( 41.03299, 0.99080 ), new L.LatLng( 41.00546, 0.95438 ), new L.LatLng( 40.98394, 0.94058 ), new L.LatLng( 40.97947, 0.92133 ), new L.LatLng( 40.94762, 0.88502 ), new L.LatLng( 40.94231, 0.87293 ), new L.LatLng( 40.92181, 0.86045 ), new L.LatLng( 40.91493, 0.84897 ), new L.LatLng( 40.86211, 0.80175 ), new L.LatLng( 40.85191, 0.77852 ), new L.LatLng( 40.84217, 0.77239 ), new L.LatLng( 40.83494, 0.75609 ), new L.LatLng( 40.81905, 0.75103 ), new L.LatLng( 40.80086, 0.71480 ), new L.LatLng( 40.79470, 0.71897 ), new L.LatLng( 40.80193, 0.73174 ), new L.LatLng( 40.80432, 0.74769 ), new L.LatLng( 40.80060, 0.77713 ), new L.LatLng( 40.74344, 0.83708 ), new L.LatLng( 40.74472, 0.87796 ), new L.LatLng( 40.73140, 0.89009 ), new L.LatLng( 40.72037, 0.89288 ), new L.LatLng( 40.69796, 0.88417 ), new L.LatLng( 40.68451, 0.87157 ), new L.LatLng( 40.67009, 0.84798 ), new L.LatLng( 40.63604, 0.76675 ), new L.LatLng( 40.57591, 0.71162 ), new L.LatLng( 40.55356, 0.67506 ), new L.LatLng( 40.54601, 0.64224 ), new L.LatLng( 40.54682, 0.61277 ), new L.LatLng( 40.56480, 0.58808 ), new L.LatLng( 40.58296, 0.58407 ), new L.LatLng( 40.58796, 0.59029 ), new L.LatLng( 40.58789, 0.60619 ), new L.LatLng( 40.59387, 0.60945 ), new L.LatLng( 40.59668, 0.61770 ), new L.LatLng( 40.59272, 0.63194 ), new L.LatLng( 40.59578, 0.64803 ), new L.LatLng( 40.60237, 0.65949 ), new L.LatLng( 40.60395, 0.67325 ), new L.LatLng( 40.59972, 0.69247 ), new L.LatLng( 40.60196, 0.70517 ), new L.LatLng( 40.63160, 0.72935 ), new L.LatLng( 40.62923, 0.69592 ), new L.LatLng( 40.61578, 0.64520 ), new L.LatLng( 40.61543, 0.62068 ), new L.LatLng( 40.60261, 0.61044 ), new L.LatLng( 40.60436, 0.59722 ), new L.LatLng( 40.57779, 0.56736 ), new L.LatLng( 40.56700, 0.56602 ), new L.LatLng( 40.56204, 0.54885 ), new L.LatLng( 40.55050, 0.54629 ), new L.LatLng( 40.54087, 0.53437 ), new L.LatLng( 40.52150, 0.52691 ), new L.LatLng( 40.51649, 0.52071 ), new L.LatLng( 40.52273, 0.48359 ), new L.LatLng( 40.53509, 0.44508 ), new L.LatLng( 40.54771, 0.42645 ), new L.LatLng( 40.56735, 0.42286 ), new L.LatLng( 40.57378, 0.42605 ), new L.LatLng( 40.59025, 0.39791 ), new L.LatLng( 40.59602, 0.39436 ), new L.LatLng( 40.59960, 0.38545 ), new L.LatLng( 40.60211, 0.33399 ), new L.LatLng( 40.60729, 0.31242 ), new L.LatLng( 40.62536, 0.27177 ), new L.LatLng( 40.64685, 0.25460 ), new L.LatLng( 40.66597, 0.25892 ), new L.LatLng( 40.68580, 0.27749 ), new L.LatLng( 40.69647, 0.26360 ), new L.LatLng( 40.69824, 0.25717 ), new L.LatLng( 40.69339, 0.23800 ), new L.LatLng( 40.69981, 0.22696 ), new L.LatLng( 40.72225, 0.21555 ), new L.LatLng( 40.71756, 0.19412 ), new L.LatLng( 40.73084, 0.16039 ), new L.LatLng( 40.74863, 0.14967 ), new L.LatLng( 40.75850, 0.15182 ), new L.LatLng( 40.76587, 0.18769 ), new L.LatLng( 40.77782, 0.20780 ), new L.LatLng( 40.77762, 0.22043 ), new L.LatLng( 40.79465, 0.22644 ), new L.LatLng( 40.80930, 0.25089 ), new L.LatLng( 40.82391, 0.26299 ), new L.LatLng( 40.83664, 0.25003 ), new L.LatLng( 40.85386, 0.24123 ), new L.LatLng( 40.87265, 0.24283 ), new L.LatLng( 40.87741, 0.23327 ), new L.LatLng( 40.88602, 0.22801 ), new L.LatLng( 40.90075, 0.23891 ), new L.LatLng( 40.91432, 0.23825 ), new L.LatLng( 40.92652, 0.24509 ), new L.LatLng( 40.93621, 0.25315 ), new L.LatLng( 40.93919, 0.26218 ), new L.LatLng( 40.95001, 0.26160 ), new L.LatLng( 40.96403, 0.27387 ), new L.LatLng( 40.98391, 0.27103 ), new L.LatLng( 40.99616, 0.25870 ), new L.LatLng( 41.00419, 0.25869 ), new L.LatLng( 41.01132, 0.24942 ), new L.LatLng( 41.02412, 0.25113 ), new L.LatLng( 41.02762, 0.24570 ), new L.LatLng( 41.02832, 0.22896 ), new L.LatLng( 41.04306, 0.20727 ), new L.LatLng( 41.05683, 0.21183 ), new L.LatLng( 41.07310, 0.20756 ), new L.LatLng( 41.08022, 0.19360 ), new L.LatLng( 41.08650, 0.18985 ), new L.LatLng( 41.10406, 0.18966 ), new L.LatLng( 41.11656, 0.19680 ), new L.LatLng( 41.12189, 0.19121 ), new L.LatLng( 41.13162, 0.19093 ), new L.LatLng( 41.14761, 0.21101 ), new L.LatLng( 41.14118, 0.24018 ), new L.LatLng( 41.15796, 0.24558 ), new L.LatLng( 41.15990, 0.26798 ), new L.LatLng( 41.17058, 0.28992 ), new L.LatLng( 41.23151, 0.31367 ), new L.LatLng( 41.24125, 0.33887 ), new L.LatLng( 41.23865, 0.35419 ), new L.LatLng( 41.24967, 0.36288 ), new L.LatLng( 41.27971, 0.37290 ), new L.LatLng( 41.30183, 0.35477 ), new L.LatLng( 41.31432, 0.35811 ), new L.LatLng( 41.32077, 0.34368 ), new L.LatLng( 41.33083, 0.33738 ), new L.LatLng( 41.34902, 0.35145 ), new L.LatLng( 41.35323, 0.36191 ), new L.LatLng( 41.36703, 0.35112 ), new L.LatLng( 41.39002, 0.31296 ), new L.LatLng( 41.39630, 0.30920 ), new L.LatLng( 41.42945, 0.33790 ), new L.LatLng( 41.43840, 0.33400 ), new L.LatLng( 41.45151, 0.34232 ), new L.LatLng( 41.46568, 0.33091 ), new L.LatLng( 41.48611, 0.32846 ), new L.LatLng( 41.49707, 0.34590 ), new L.LatLng( 41.49590, 0.37623 ), new L.LatLng( 41.49919, 0.39010 ), new L.LatLng( 41.54705, 0.43326 ), new L.LatLng( 41.56682, 0.41882 ), new L.LatLng( 41.59177, 0.42358 ), new L.LatLng( 41.58538, 0.40377 ), new L.LatLng( 41.59218, 0.34641 ), new L.LatLng( 41.59690, 0.33972 ), new L.LatLng( 41.62374, 0.33542 ), new L.LatLng( 41.63240, 0.34090 ), new L.LatLng( 41.65498, 0.32553 ), new L.LatLng( 41.66067, 0.31645 ), new L.LatLng( 41.67944, 0.31559 ), new L.LatLng( 41.70398, 0.33391 ), new L.LatLng( 41.72001, 0.35788 ), new L.LatLng( 41.73246, 0.36146 ), new L.LatLng( 41.74759, 0.37759 ), new L.LatLng( 41.75028, 0.38709 ), new L.LatLng( 41.76561, 0.39112 ), new L.LatLng( 41.77589, 0.44835 ), new L.LatLng( 41.77496, 0.45981 ), new L.LatLng( 41.79347, 0.46392 ), new L.LatLng( 41.80913, 0.47511 ), new L.LatLng( 41.81574, 0.49087 ), new L.LatLng( 41.83228, 0.51136 ), new L.LatLng( 41.83195, 0.53838 ), new L.LatLng( 41.86176, 0.54823 ), new L.LatLng( 41.86345, 0.56953 ), new L.LatLng( 41.87089, 0.57264 ), new L.LatLng( 41.87770, 0.59028 ), new L.LatLng( 41.88625, 0.58181 ), new L.LatLng( 41.90954, 0.58869 ), new L.LatLng( 41.92042, 0.58447 ), new L.LatLng( 41.92799, 0.55558 ), new L.LatLng( 41.94363, 0.55082 ), new L.LatLng( 41.97454, 0.57930 ), new L.LatLng( 41.97832, 0.59981 ), new L.LatLng( 41.99906, 0.61494 ), new L.LatLng( 42.00912, 0.64862 ), new L.LatLng( 42.02807, 0.64092 ), new L.LatLng( 42.04524, 0.64646 ), new L.LatLng( 42.05141, 0.65848 ), new L.LatLng( 42.06482, 0.65929 ), new L.LatLng( 42.08284, 0.67097 ), new L.LatLng( 42.09325, 0.67249 ), new L.LatLng( 42.11030, 0.68865 ), new L.LatLng( 42.15365, 0.68450 ), new L.LatLng( 42.16443, 0.69343 ), new L.LatLng( 42.17365, 0.68633 ), new L.LatLng( 42.19438, 0.69189 ), new L.LatLng( 42.20123, 0.69793 ), new L.LatLng( 42.22927, 0.70416 ), new L.LatLng( 42.25639, 0.72409 ), new L.LatLng( 42.28722, 0.72750 ), new L.LatLng( 42.30599, 0.73449 ), new L.LatLng( 42.31924, 0.74570 ), new L.LatLng( 42.32453, 0.73379 ), new L.LatLng( 42.33830, 0.72936 ), new L.LatLng( 42.35095, 0.74119 ), new L.LatLng( 42.36536, 0.71273 ), new L.LatLng( 42.37427, 0.71396 ), new L.LatLng( 42.38690, 0.73249 ), new L.LatLng( 42.39479, 0.72867 ), new L.LatLng( 42.40343, 0.71644 ), new L.LatLng( 42.41032, 0.71619 ), new L.LatLng( 42.41632, 0.72205 ), new L.LatLng( 42.43398, 0.70071 ), new L.LatLng( 42.46187, 0.69702 ), new L.LatLng( 42.47138, 0.68732 ), new L.LatLng( 42.48860, 0.67998 ), new L.LatLng( 42.50582, 0.69660 ), new L.LatLng( 42.50238, 0.71477 ), new L.LatLng( 42.50596, 0.71943 ), new L.LatLng( 42.51105, 0.71024 ), new L.LatLng( 42.52982, 0.71070 ), new L.LatLng( 42.54188, 0.71838 ), new L.LatLng( 42.54916, 0.73057 ), new L.LatLng( 42.57411, 0.74708 ), new L.LatLng( 42.60503, 0.75359 ), new L.LatLng( 42.60572, 0.73483 ), new L.LatLng( 42.61438, 0.70478 ), new L.LatLng( 42.62724, 0.68836 ), new L.LatLng( 42.64253, 0.68969 ), new L.LatLng( 42.65396, 0.68455 ), new L.LatLng( 42.66639, 0.66836 ), new L.LatLng( 42.68984, 0.64898 ), new L.LatLng( 42.69894, 0.65224 ), new L.LatLng( 42.70229, 0.66330 ), new L.LatLng( 42.71025, 0.66770 ), new L.LatLng( 42.72051, 0.66184 ), new L.LatLng( 42.72574, 0.66389 ), new L.LatLng( 42.74445, 0.65191 ), new L.LatLng( 42.74842, 0.63486 ), new L.LatLng( 42.75620, 0.62816 ), new L.LatLng( 42.77426, 0.64391 ), new L.LatLng( 42.78136, 0.63545 ), new L.LatLng( 42.78825, 0.63519 ), new L.LatLng( 42.80861, 0.65697 ), new L.LatLng( 42.81591, 0.65377 ), new L.LatLng( 42.82284, 0.65688 ), new L.LatLng( 42.82890, 0.65083 ), new L.LatLng( 42.84243, 0.64864 ), new L.LatLng( 42.85515, 0.66691 ), new L.LatLng( 42.86526, 0.67388 ), new L.LatLng( 42.86601, 0.69007 ), new L.LatLng( 42.87231, 0.70992 ), new L.LatLng( 42.86414, 0.74128 ), new L.LatLng( 42.85761, 0.74795 ), new L.LatLng( 42.84704, 0.78101 ), new L.LatLng( 42.85103, 0.80590 ), new L.LatLng( 42.83948, 0.83725 ), new L.LatLng( 42.83716, 0.86111 ), new L.LatLng( 42.80194, 0.92806 ), new L.LatLng( 42.81142, 0.94220 ), new L.LatLng( 42.81679, 0.96063 ), new L.LatLng( 42.81201, 0.97540 ), new L.LatLng( 42.79781, 0.99120 ), new L.LatLng( 42.80166, 1.00662 ), new L.LatLng( 42.79347, 1.05611 ), new L.LatLng( 42.79865, 1.08417 ), new L.LatLng( 42.78666, 1.09708 ), new L.LatLng( 42.77995, 1.11813 ), new L.LatLng( 42.76219, 1.13971 ), new L.LatLng( 42.75233, 1.14598 ), new L.LatLng( 42.74611, 1.14340 ), new L.LatLng( 42.73456, 1.14769 ), new L.LatLng( 42.72052, 1.16989 ), new L.LatLng( 42.73859, 1.22983 ), new L.LatLng( 42.73293, 1.25254 ), new L.LatLng( 42.72692, 1.26114 ), new L.LatLng( 42.72879, 1.30980 ), new L.LatLng( 42.73550, 1.33292 ), new L.LatLng( 42.72970, 1.34728 ), new L.LatLng( 42.72783, 1.36703 ), new L.LatLng( 42.71689, 1.37084 ), new L.LatLng( 42.70851, 1.36548 ), new L.LatLng( 42.70549, 1.38234 ), new L.LatLng( 42.69288, 1.40095 ), new L.LatLng( 42.67869, 1.40169 ), new L.LatLng( 42.66081, 1.42595 ), new L.LatLng( 42.63176, 1.43302 ), new L.LatLng( 42.62623, 1.44041 ), new L.LatLng( 42.61430, 1.44428 ), new L.LatLng( 42.60745, 1.45520 ), new L.LatLng( 42.59272, 1.45266 ), new L.LatLng( 42.58413, 1.44224 ), new L.LatLng( 42.57741, 1.45539 ), new L.LatLng( 42.56624, 1.45674 ), new L.LatLng( 42.55413, 1.43783 ), new L.LatLng( 42.54819, 1.46053 ), new L.LatLng( 42.51208, 1.48135 ), new L.LatLng( 42.50489, 1.47679 ), new L.LatLng( 42.48800, 1.44533 ), new L.LatLng( 42.48126, 1.45345 ), new L.LatLng( 42.47020, 1.45403 ), new L.LatLng( 42.46559, 1.45962 ), new L.LatLng( 42.44657, 1.45959 ), new L.LatLng( 42.43988, 1.51665 ), new L.LatLng( 42.44465, 1.54190 ), new L.LatLng( 42.45946, 1.54589 ), new L.LatLng( 42.46872, 1.55684 ), new L.LatLng( 42.46709, 1.57680 ), new L.LatLng( 42.47907, 1.60018 ), new L.LatLng( 42.47540, 1.61000 ), new L.LatLng( 42.47882, 1.64986 ), new L.LatLng( 42.49768, 1.65189 ), new L.LatLng( 42.51323, 1.66193 ), new L.LatLng( 42.51597, 1.67048 ), new L.LatLng( 42.51343, 1.67914 ), new L.LatLng( 42.50585, 1.68553 ), new L.LatLng( 42.50291, 1.70332 ), new L.LatLng( 42.51167, 1.71499 ), new L.LatLng( 42.51398, 1.72658 ), new L.LatLng( 42.51143, 1.73524 ), new L.LatLng( 42.50488, 1.73976 ), new L.LatLng( 42.50542, 1.75283 ), new L.LatLng( 42.49902, 1.76789 ), new L.LatLng( 42.49654, 1.79053 ), new L.LatLng( 42.50095, 1.80481 ), new L.LatLng( 42.49581, 1.81845 ), new L.LatLng( 42.49598, 1.82962 ), new L.LatLng( 42.48456, 1.85384 ), new L.LatLng( 42.47589, 1.85901 ), new L.LatLng( 42.46924, 1.88794 ), new L.LatLng( 42.46086, 1.89534 ), new L.LatLng( 42.45817, 1.91577 ), new L.LatLng( 42.46525, 1.93232 ), new L.LatLng( 42.46278, 1.94569 ), new L.LatLng( 42.48389, 1.95276 ), new L.LatLng( 42.49376, 1.96625 ), new L.LatLng( 42.50307, 1.97144 ), new L.LatLng( 42.50567, 1.98214 ), new L.LatLng( 42.50201, 1.99857 ), new L.LatLng( 42.49064, 2.01067 ), new L.LatLng( 42.48375, 2.01078 ), new L.LatLng( 42.47486, 2.00085 ), new L.LatLng( 42.46311, 2.02098 ), new L.LatLng( 42.45073, 2.02651 ), new L.LatLng( 42.44260, 2.01853 ), new L.LatLng( 42.44002, 2.00404 ), new L.LatLng( 42.44019, 1.98120 ), new L.LatLng( 42.44764, 1.95567 ), new L.LatLng( 42.43742, 1.95518 ), new L.LatLng( 42.42972, 1.97061 ), new L.LatLng( 42.41422, 1.96924 ), new L.LatLng( 42.38627, 1.97804 ), new L.LatLng( 42.37102, 1.99616 ), new L.LatLng( 42.36366, 2.01379 ), new L.LatLng( 42.36875, 2.03201 ), new L.LatLng( 42.36936, 2.05742 ), new L.LatLng( 42.37596, 2.06896 ), new L.LatLng( 42.37638, 2.07792 ), new L.LatLng( 42.38194, 2.08151 ), new L.LatLng( 42.39026, 2.10358 ), new L.LatLng( 42.39988, 2.10477 ), new L.LatLng( 42.42195, 2.12300 ), new L.LatLng( 42.43391, 2.15369 ), new L.LatLng( 42.43536, 2.16846 ), new L.LatLng( 42.42889, 2.18536 ), new L.LatLng( 42.42817, 2.20233 ), new L.LatLng( 42.43609, 2.22114 ), new L.LatLng( 42.43840, 2.23852 ), new L.LatLng( 42.44966, 2.25765 ), new L.LatLng( 42.43506, 2.29629 ), new L.LatLng( 42.43912, 2.30292 ), new L.LatLng( 42.43862, 2.31834 ), new L.LatLng( 42.42714, 2.33283 ), new L.LatLng( 42.42508, 2.35353 ), new L.LatLng( 42.41553, 2.35878 ), new L.LatLng( 42.41292, 2.36692 ), new L.LatLng( 42.41057, 2.39162 ), new L.LatLng( 42.40271, 2.41456 ), new L.LatLng( 42.40366, 2.43776 ), new L.LatLng( 42.39525, 2.44707 ), new L.LatLng( 42.38267, 2.44720 ), new L.LatLng( 42.37730, 2.46474 ), new L.LatLng( 42.35186, 2.48815 ), new L.LatLng( 42.35339, 2.50555 ), new L.LatLng( 42.34402, 2.53286 ), new L.LatLng( 42.34937, 2.54189 ), new L.LatLng( 42.36235, 2.54643 ), new L.LatLng( 42.36904, 2.57198 ), new L.LatLng( 42.36693, 2.59359 ), new L.LatLng( 42.35742, 2.61493 ), new L.LatLng( 42.35168, 2.66448 ), new L.LatLng( 42.36411, 2.65121 ), new L.LatLng( 42.37318, 2.65136 ), new L.LatLng( 42.38840, 2.64054 ), new L.LatLng( 42.39878, 2.65000 ), new L.LatLng( 42.39820, 2.66172 ), new L.LatLng( 42.40698, 2.66119 ), new L.LatLng( 42.41405, 2.66915 ), new L.LatLng( 42.41712, 2.68755 ), new L.LatLng( 42.43101, 2.71296 ), new L.LatLng( 42.43536, 2.73356 ), new L.LatLng( 42.43572, 2.76224 ), new L.LatLng( 42.42422, 2.77339 ), new L.LatLng( 42.42885, 2.79070 ), new L.LatLng( 42.44099, 2.79675 ), new L.LatLng( 42.45031, 2.81304 ), new L.LatLng( 42.45065, 2.82135 ), new L.LatLng( 42.45948, 2.82458 ), new L.LatLng( 42.46940, 2.83590 ), new L.LatLng( 42.46750, 2.85274 ), new L.LatLng( 42.47847, 2.87140 ), new L.LatLng( 42.46749, 2.91425 ), new L.LatLng( 42.48108, 2.92319 ), new L.LatLng( 42.49229, 2.94343 ), new L.LatLng( 42.49229, 2.95274 ), new L.LatLng( 42.47813, 2.97384 ), new L.LatLng( 42.48530, 2.99001 ), new L.LatLng( 42.47993, 3.01370 ), new L.LatLng( 42.48558, 3.03232 ), new L.LatLng( 42.48424, 3.04542 ), new L.LatLng( 42.45667, 3.06536 ), new L.LatLng( 42.43623, 3.09143 ), new L.LatLng( 42.44486, 3.10477 ), new L.LatLng( 42.44881, 3.12074 ), new L.LatLng( 42.44471, 3.14632 ), new L.LatLng( 42.44552, 3.18039 ), new L.LatLng( 42.43680, 3.18860 ), new L.LatLng( 42.41476, 3.18332 ), new L.LatLng( 42.40863, 3.17736 ), new L.LatLng( 42.39073, 3.18107 ), new L.LatLng( 42.38223, 3.17498 ), new L.LatLng( 42.36530, 3.18167 ), new L.LatLng( 42.35725, 3.20011 ), new L.LatLng( 42.36240, 3.23048 ), new L.LatLng( 42.36052, 3.24053 ), new L.LatLng( 42.35717, 3.24796 ), new L.LatLng( 42.34815, 3.25260 ), new L.LatLng( 42.35058, 3.27351 ), new L.LatLng( 42.33019, 3.33835 ), new L.LatLng( 42.32232, 3.34579 ), new L.LatLng( 42.31401, 3.34092 ), new L.LatLng( 42.30439, 3.31390 ), new L.LatLng( 42.29693, 3.32216 ), new L.LatLng( 42.28874, 3.32226 ), new L.LatLng( 42.27394, 3.30024 ), new L.LatLng( 42.25216, 3.29385 ), new L.LatLng( 42.24560, 3.27963 ), new L.LatLng( 42.23110, 3.27085 ), new L.LatLng( 42.23061, 3.25809 ), new L.LatLng( 42.23767, 3.24049 ), new L.LatLng( 42.22709, 3.22677 ), new L.LatLng( 42.22585, 3.21460 ), new L.LatLng( 42.24077, 3.17513 ), new L.LatLng( 42.25582, 3.16364 ), new L.LatLng( 42.24691, 3.14951 ), new L.LatLng( 42.22740, 3.13309 ), new L.LatLng( 42.20274, 3.12392 ), new L.LatLng( 42.14981, 3.12989 ), new L.LatLng( 42.13915, 3.13706 ), new L.LatLng( 42.13189, 3.14843 ), new L.LatLng( 42.11976, 3.18648 ), new L.LatLng( 42.09360, 3.20674 ) ];\r\nvar CatPol= [ [ 0.83496, 42.75105 ], [ 0.78552, 41.90228 ], [ 0.32959, 40.75974 ], [0.47790,40.56389 ], [0.70861,40.48455 ], [0.95581,40.66397 ], [1.08215,40.95501 ], [2.12036,41.19105 ], [3.05419,41.60722 ], [3.38928,41.78360 ], [3.33435,42.13896 ], [3.43322,42.26104 ], [3.32336,42.42751 ], [1.88415,42.35448 ], [ 0.83496, 42.75105 ]  ] ;\r\nvar CatBounds = L.latLngBounds(L.latLng(40.47, 0.1087), L.latLng(42.8855, 3.33669));\r\n\r\n//var CatBounds = L.latLngBounds(L.latLng(40.47, 0.77), L.latLng(42.45, 3.33669));\r\n\r\nvar MQ_ATTR='Font:<a  href=\"https://www.openstreetmap.org/\" target=\"_blank\">OpenStreetMap </a>';\r\nvar ESRI_ATTR='Tiles © Esri  Sources: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping,Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';\r\nvar ESRI_ATTR_TERRAIN=\"Tiles © Esri Sources: Esri, USGS, NOAA\";\r\nvar ICGC='Font:<a  href=\"http://www.icc.cat\" target=\"_blank\">Institut Cartogràfic i Geològic de Catalunya</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>';\r\nvar ICGC_MON='Font:Mapa del Món (<a  href=\"http://www.icc.cat\" target=\"_blank\">ICGC</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>)';\r\nvar ICGC_HISTO='Font:Mapa de Catalunya 1936 (<a  href=\"http://www.icc.cat\" target=\"_blank\">ICGC</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>)';\r\nvar ICGC_HISTOOrto='Font:Vol americà 1956-57 Ministerio de Defensa';\r\nvar ICGC_HISTOOrto46='Font:Vol Americà A 1946-47 Ministerio de Defensa';\r\nvar _topoLayers=null,TOPO_ICC_L0_6,TOPO_MQ_L7_19,TOPO_ICC_L7_10,TOPO_ICC_L11_12,TOPO_ICC_L12_19;\r\nvar _topoLayersGeo=null,TOPO_GEO_MQ_L15_18,TOPO_GEO_MON_L0_14,TOPO_GEO_ICC_L8_12,TOPO_GEO_OMBRA_L8_12,TOPO_GEO_ICC_L8_17,TOPO_GEO_ICC_L8_17_TOPONIMS;\r\nvar _ortoLayers=null,ORTO_ESRI_L0_19,ORTO_ICC_L0_11,ORTO_ICC_L12_19,ORTO_ICC_L9_12;\r\n\r\n\r\nvar _ortoAurgmentada=null,ORTO_ESRI_L0_19,ORTO_AUGMENTADA_L4_17,ORTO_ICC_L18_20;\r\nvar _hibridLayers=null,HIBRID_MQ_L0_18,HIBRID_ICGC_L0_18,HIBRID_ICGC_L13_18;\r\nvar _histoMap=null;\r\nvar _histoOrtoMap=null;\r\nvar _histoOrtoMap46=null;\r\nvar _alcadesMap=null;\r\nvar _naturalMap=null;\r\nvar _divadminMap=null;\r\nvar _colorBlankMap=null;\r\nvar _hibridTerrainMap=null;\r\n\r\n\r\nvar ESRI_RELLEU_L0_13;\r\nvar ICC_RELLEU_L0_14;\r\nvar MQ_TOPO_GRIS_L15_19,ICC_TOPO_GRIS_L7_10,ICC_TOPO_GRIS_L11_19,ICC_MON_L0,MQ_TOPO_GRIS_L0_14;\r\nvar COLOR_TOPO_ICC_L0_6,COLOR_TOPO_MQ_L7_19,COLOR_TOPO_ICC_L11_19;\r\nvar HISTO_ICC_L0_14;\r\nvar HISTOOrto_ICC_L0_14;\r\nvar HISTOOrto46_ICC_L0_14;\r\nvar ALCADAMAPA_ICGC_L0_17;\r\nvar DIVADMIN_L0_14;\r\nvar DIVADMIN_L14_18;\r\nvar DIVADMIN_L14_18_TOPO;\r\n\r\nvar ORTO_HIBRID_8_18_VECTOR;\r\nvar ORTO_HIBRID_L8_17_TOPONIMS;\r\nvar TERRAIN_HIBRID_8_18_VECTOR;\r\nvar _terrainLayers=null;\r\nvar _topoColorLayers=null;\r\nvar _grisLayers=null;\r\nvar _ombraLayer=null;\r\n//var subDomains=['otile1','otile2','otile3','otile4'];0\r\nvar subDomains=['a','b','c'];\r\nvar subDomainsA=['a','b','c'];\r\n//var urlServerTiles=\"http://www.{s}.instamaps.cat\"\r\n//var urlServerTilesW=\"http://www.instamaps.cat\"\r\n\r\nvar urlServerTiles=\"http://{s}.tilemaps.icgc.cat\";\r\nvar urlServerTilesW=\"http://{s}.tilemaps.icgc.cat\";\r\n\r\n\r\nvar urlApp=document.location.href;\r\n\r\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)||(urlApp.indexOf('172.70.1.11')!=-1)){\r\n\r\n\t//urlServerTiles=\"http://imtilemapsdev.icgc.local\";\r\n\turlServerTilesW=\"http://imtilemapsdev.icgc.local\";\r\n\turlServerTiles=\"http://imtilemapsdev.icgc.local\";\r\n\t//urlServerTilesW=\"http://{s}.tilemaps.icgc.cat\";\r\n\r\n\r\n\r\n}\r\n\r\n\r\nvar FONS_TOPOMAP='topoMap';\r\nvar FONS_TOPOMAP_GEO='topoMapGeo';\r\nvar FONS_ORTOMAP='ortoMap';\r\nvar FONS_ORTOAUGMENTADA='ortoAugmentada';\r\nvar FONS_HIBRIDMAP='hibridMap';\r\nvar FONS_TERRAINMAP='terrainMap';\r\nvar FONS_TOPOGISMAP='topoGrisMap';\r\nvar FONS_COLORMAP='colorMap';\r\nvar FONS_HISTORICMAP='historicMap';\r\nvar FONS_HISTORICORTOMAP='historicOrtoMap';\r\nvar FONS_HISTORICORTOMAP46='historicOrtoMap46';\r\nvar FONS_ALCADAMAP='alcadaMap';\r\nvar FONS_NATURAL='naturalMap';\r\nvar FONS_DIVADMIN='divadminMap';\r\nvar FONS_COLORBLANK='colorBlankMap';\r\nvar FONS_HIBRIDTERRAIN='hibridTerrainMap';\r\n\r\nvar URL_MQ='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n\r\n//Nou osm_suau_fast\r\n\r\nvar mapaUrl = {\r\n\ttopoMapMON:urlServerTiles+'/mapfactory/wmts/mon_cat/MON3857/{z}/{x}/{y}.png',\r\n\ttopoMapOSM:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n\ttopoMapICGC:'http://mapcache.{s}.icc.cat/map/bases_noutm/wmts/topo/GRID3857/{z}/{x}/{y}.jpeg',\r\n\ttopoMapSuauOSM:urlServerTiles+'/mapfactory/wmts/osm_suau/CAT3857_15/{z}/{x}/{y}.png',\r\n\ttopoMapSuauICGC:urlServerTiles+'/mapfactory/wmts/topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\tortoEsri:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\r\n\tortoInstamaps:urlServerTiles+'/mapfactory/wmts/orto_8_12/CAT3857/{z}/{x}/{y}.png',\r\n\tortoAugmentada:urlServerTilesW+'/mapfactory/wmts/orto_augmentada/CAT3857/{z}/{x}/{y}.jpeg',\r\n\tortoICGC:\"http://mapcache.{s}.icc.cat/map/bases_noutm/wmts/orto/GRID3857/{z}/{x}/{y}.jpeg\",\r\n\thibridInstamaps:urlServerTiles+'/mapfactory/wmts/hibrida/CAT3857/{z}/{x}/{y}.png',\r\n\tterrainEsri:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',\r\n\tterrainInstamaps:urlServerTiles+'/mapfactory/wmts/relleu/CAT3857/{z}/{x}/{y}.png',\r\n\tombraInstamaps:urlServerTiles+'/mapfactory/wmts/h_ombra/CAT3857/{z}/{x}/{y}.png',\r\n\torto46ICGC:urlServerTiles+'/mapfactory/wmts/orto46/CAT3857/{z}/{x}/{y}.png',\r\n\torto55ICGC:urlServerTiles+'/mapfactory/wmts/orto55/CAT3857/{z}/{x}/{y}.png',\r\n\ttopo36ICGC:urlServerTiles+'/mapfactory/wmts/cat1936/CAT3857/{z}/{x}/{y}.png',\r\n\ttopoGrisOSM:urlServerTiles+'/mapfactory/wmts/gris_osm_suau/CAT3857_15/{z}/{x}/{y}.png',\r\n\ttopoGrisICGC:urlServerTiles+'/mapfactory/wmts/gris_topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\ttopoNaturalOSM:'http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png',\r\n\ttopoNaturalSuau:urlServerTiles+'/mapfactory/wmts/natural_suau/CAT3857/{z}/{x}/{y}.png',\r\n\ttoponimsNaturalSuau:urlServerTiles+'/mapfactory/wmts/toponimia/CAT3857/{z}/{x}/{y}.png',\r\n    topoLimitsSuau:urlServerTiles+'/mapfactory/wmts/limits/CAT3857/{z}/{x}/{y}.png',\r\n\tfonsBlank:'',\r\n\thibridTotal:urlServerTiles+'/mapfactory/wmts/hibrida_total/CAT3857/{z}/{x}/{y}.png',\r\n\ttopoSuauColor:{\r\n\t\tzombie:{suau:urlServerTiles+'/mapfactory/wmts/coure_topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\t\t\t\tosm:urlServerTiles+'/mapfactory/wmts/coure_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\r\n\t\tnit:{suau:urlServerTiles+'/mapfactory/wmts/nit_topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\t\t\t osm:urlServerTilesW+'/mapfactory/wmts/nit_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\r\n\t\torquidea:{suau:urlServerTiles+'/mapfactory/wmts/blueprint_topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\t\t\t\t  osm:urlServerTiles+'/mapfactory/wmts/blueprint_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\r\n\t\tsepia:{suau:urlServerTiles+'/mapfactory/wmts/sepia_topo_suau/CAT3857/{z}/{x}/{y}.png',\r\n\t\t\t   osm:urlServerTilesW+'/mapfactory/wmts/sepia_osm_suau/CAT3857_15/{z}/{x}/{y}.png'}\r\n\t}\r\n}\r\n\r\n\r\nL.IM_Map = L.Map.extend({\r\n\r\n\toptions: {\r\n\t\ttypeMap:FONS_TOPOMAP,\r\n\t\tmapColor: '',\r\n\t\tmeasureControl:true\r\n\t},\r\n\r\n\tinitialize: function(id,options) {\r\n\t\tL.Map.prototype.initialize.call(this,id,options);\r\n\t\tL.Util.setOptions(this, options);\r\n\r\n\t\tthis.activeMap=this.options.typeMap;\r\n\r\n\t\tif(this.options.typeMap==FONS_TOPOMAP){this.topoMap();\r\n\t\t}else if(this.options.typeMap==FONS_ORTOMAP){this.ortoMap();\r\n\t\t}else if(this.options.typeMap==FONS_ORTOAUGMENTADA){this.ortoAugmentada();\r\n\t\t}else if(this.options.typeMap==FONS_HIBRIDMAP){this.hibridMap();\r\n\t\t}else if(this.options.typeMap==FONS_TOPOMAP_GEO){this.topoMapGeo();\r\n\t\t}else if(this.options.typeMap==FONS_TERRAINMAP){this.terrainMap();\r\n\t\t}else if(this.options.typeMap==FONS_TOPOGISMAP){this.topoGrisMap();\r\n\t\t}else if(this.options.typeMap==FONS_COLORMAP){this.colorMap();\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICMAP){this.historicMap();\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP){this.historicOrtoMap();\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP46){this.historicOrtoMap46();\r\n\t\t}else if(this.options.typeMap==FONS_ALCADAMAP){this.alcadaMap();\r\n\t\t}else if(this.options.typeMap==FONS_NATURAL){this.naturalMap();\r\n\t\t}else if(this.options.typeMap==FONS_DIVADMIN){this.divadminMap();\r\n\t\t}else if(this.options.typeMap==FONS_COLORBLANK){this.colorBlankMap();\r\n\t\t}else if(this.options.typeMap==FONS_HIBRIDTERRAIN){this.hibridTerrainMap();\r\n\t\t}else{\r\n\t\tthis.activeMap=FONS_TOPOMAP;this.topoMap();\r\n\t\t}\r\n\r\n\r\n\t\tthis.on('moveend', function(){\r\n\t\t\tthis.gestionaFons(false);\r\n\t\t});\r\n\r\n\t\tthis.on('layeradd', function(){\r\n\t\t\tthis.gestionaFons(true);\r\n\t\t});\r\n\r\n\r\n\r\n\t},\r\n\t//Funcio nova 3D\r\n\tgetLGActiveMap:function(){\r\n\r\n\t\tif(this.options.typeMap==FONS_TOPOMAP){return _topoLayers;\r\n\t\t}else if(this.options.typeMap==FONS_ORTOMAP){return _ortoLayers;\r\n\r\n\t\t}else if(this.options.typeMap==FONS_ORTOAUGMENTADA){return _ortoAurgmentada;\r\n\t\t}else if(this.options.typeMap==FONS_HIBRIDMAP){return _hibridLayers;\r\n\t\t}else if(this.options.typeMap==FONS_TOPOMAP_GEO){return _topoLayersGeo;\r\n\t\t}else if(this.options.typeMap==FONS_TERRAINMAP){return _terrainLayers;\r\n\t\t}else if(this.options.typeMap==FONS_TOPOGISMAP){return _grisLayers;\r\n\t\t}else if(this.options.typeMap==FONS_COLORMAP){return _topoColorLayers;\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICMAP){return _histoMap;\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP){return _histoOrtoMap;\r\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP46){return _histoOrtoMap46;\r\n\t\t}else if(this.options.typeMap==FONS_ALCADAMAP){return _alcadesMap;\r\n\t\t}else if(this.options.typeMap==FONS_NATURAL){return _naturalMap;\r\n\t\t}else if(this.options.typeMap==FONS_DIVADMIN){return _divadminMap;\r\n\t\t}else if(this.options.typeMap==FONS_COLORBLANK){return _colorBlankMap;\r\n\t\t}else if(this.options.typeMap==FONS_HIBRIDTERRAIN){return _hibridTerrainMap;\r\n\t\t}else{\r\n\t\treturn _topoLayers;\r\n\t\t}\r\n\r\n\t},\r\n\tgetActiveMap:function(){\r\n\t\treturn this.options.typeMap;\r\n\t},\r\n\r\n\tgetCurrentZoomLevel:function(){\r\n\r\n\t\tif(estatMapa3D){\r\n\r\n\t\t\treturn \"\";\r\n\t\t}else{\r\n\r\n\t\t\treturn \" ZL:\"+this.getZoom();\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t},\r\n\tsetActiveMap:function(typeMap){\r\n\t\tthis.options.typeMap = typeMap;\r\n\r\n\t\t//Activa mapa vista 3D\r\n\t\tif(estatMapa3D){\r\n\r\n\t\t\tmapaVista3D.addBaseLayersCesium();\r\n\t\t}\r\n\t},\r\n\r\n\tgetMapColor:function(){\r\n\r\n\t\treturn this.options.mapColor;\r\n\t},\r\n\r\n\tsetMapColor:function(mapColor){\r\n\t\tthis.options.mapColor = mapColor;\r\n\r\n\t},\r\n\tmiraCentreDins:function(x,y){\r\n\t\tvar x0=0.1087; //0.7525\r\n\t\tvar y0=40.4763; // 40.5263\r\n\t\tvar x1=3.33669; // 3.3563\r\n\t\tvar y1=42.8855;  // 42.3748\r\n\t\tif(x>=x0&&x<=x1&&y>=y0&&y<=y1){return true;}else{return false;}\r\n\t},\r\n\r\n\tdinsCatalunya:function(MapBounds){\r\n\r\n\r\n\t\tvar x = MapBounds.getWest(), y =MapBounds.getNorth();\r\n\r\n\t    var inside = false;\r\n\t    for (var i = 0, j = CatPol.length - 1; i < CatPol.length; j = i++) {\r\n\t        var xi = CatPol[i][0], yi = CatPol[i][1];\r\n\t        var xj = CatPol[j][0], yj = CatPol[j][1];\r\n\r\n\t        var intersect = ((yi > y) != (yj > y))\r\n\t            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n\t        if (intersect) inside = !inside;\r\n\t    }\r\n\r\n\t    return inside;\r\n\r\n\r\n\t},\r\n\r\n\r\n\tmiraBBContains:function(MapBounds){\r\n\r\n\r\n\t\tvar cas=0;\r\n\t\tvar vC=CatBounds.intersects(MapBounds);// True es veu Cat\r\n\t\tvar nC=CatBounds.contains(MapBounds);//True nomes Cat\r\n\t\t   if(!vC){\r\n\t\t\tcas=0; //Estic fora de Cat\r\n\t\t   }else if(vC && !nC){ //veig Cat i altres\r\n\t\t\t//cas=1;\r\n\r\n\t\t\t   this.dinsCatalunya(MapBounds)?cas=2:cas=1\r\n\r\n\t\t   }else if (vC && nC){ //Nomes veig cat\r\n\r\n\r\n\t\t\tthis.dinsCatalunya(MapBounds)?cas=2:cas=1;\r\n\r\n\t\t   }\r\n\r\n\r\n\t\treturn cas;\r\n\t},\r\n\tmirarActivarHill:function(hoMiro,zoom,sC){\r\n\r\n\r\n\t},\r\n\tsetHillActiu:function(grup,actiu){\r\n\r\n\r\n\t},\r\n\tsetTransActiveMap:function(trans,hillActiu){\r\n\r\n\r\n\r\n\t},\r\n\tgestionaFons:function(layerAdd){\r\n\t\tvar sC=this.miraBBContains(this.getBounds());\r\n\t\tvar f=this.getActiveMap();\r\n\t\tvar zT=14;\r\n\r\n\t\tif(f==FONS_TOPOMAP){ //_topoLayers=null,TOPO_ICC_L0_6,TOPO_MQ_L7_19,TOPO_ICC_L7_10,TOPO_ICC_L11_19;\r\n\r\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\r\n\r\n\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(1);\r\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=19;\r\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=zT;\r\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=zT;\r\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=zT;\r\n\t\t\t\tif(this.getZoom() > 6){\r\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\t//TOPO_ICC_L0_6\r\n\t\t\t\t\t_topoLayers.removeLayer(TOPO_ICC_L0_6);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\r\n\t\t\t\t\t_topoLayers.addLayer(TOPO_ICC_L0_6);\r\n\t\t\t\t}\r\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\t\t\t}else if(sC==1){\r\n\r\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(1);\r\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=19;\r\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=12;\r\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=10;\r\n\t\t\t\tif(this.getZoom() > 6){\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \" - \"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\t_topoLayers.removeLayer(TOPO_ICC_L0_6);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\r\n\t\t\t\t\t_topoLayers.addLayer(TOPO_ICC_L0_6);\r\n\t\t\t\t}\r\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\t\t\t}else if(sC==2){\r\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(0);\r\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=zT;\r\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=12;\r\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=10;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\tjQuery('#map').css('backgroundColor','#E0EAF3');\r\n\r\n\t\t\t}\r\n\r\n\t\t//var _topoLayersGeo=null,TOPO_GEO_MQ_L15_18,TOPO_GEO_ICC_L8_12,TOPO_GEO_ICC_L8_17;\r\n\t\t}else if(f==FONS_TOPOMAP_GEO){\r\n\r\n\t\t\t\tif(sC==0){\r\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(1);\r\n\t\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\r\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=18;\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\r\n\t\t\t\t}else if(sC==1){\r\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(0.7);\r\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=18;\r\n\t\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\r\n\t\t\t\t}else if(sC==2){\r\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=14;\r\n\t\t\t\t\t//TOPO_GEO_MQ_L15_18.setOpacity(0);\r\n\t\t\t\t\t//TOPO_GEO_MON_L0_14.setOpacity(0);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\r\n\t\t\t\t}\r\n\r\n\r\n\t\t}else if(f==FONS_NATURAL){\r\n\r\n\r\n\r\n\t\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)|| (sC==1)){\r\n\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(1);\r\n\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\t\t\t}else if(sC==2){\r\n\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(0);\r\n\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(0);\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t}else if(f==FONS_ORTOMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){ //Fora Cat\r\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=19;\r\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=zT;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=zT;\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(1);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\t\t\t\t}else if(sC==1){ //Cat i altres\r\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=17;\r\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=12;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0.8);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\r\n\t\t\t\t}else if(sC==2){ //Nomes cat\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0);\r\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=12;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\r\n\t\t\t\t}\r\n\r\n\r\n\t\t}else if(f==FONS_HIBRIDMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){ //Fora Cat\r\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=19;\r\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=zT;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=zT;\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(1);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\r\n\t\t\t\t}else if(sC==1){ //Cat i altres\r\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=17;\r\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=17;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0.8);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\r\n\t\t\t\t}else if(sC==2){ //Nomes cat\r\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0);\r\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=17;\r\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\tif((parseInt(this.getZoom()) >= 7) &&(parseInt(this.getZoom()) <= 11)) {\r\n\r\n\r\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.4);\r\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(0.8);\r\n\r\n\t\t\t}else if ((parseInt(this.getZoom()) >= 12) &&(parseInt(this.getZoom()) <= 13)) {\r\n\r\n\r\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.5);\r\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(0.8);\r\n\r\n\t\t\t}else{\r\n\r\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.8);\r\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(1);\r\n\t\t\t}\r\n\r\n\r\n\t\t/*\r\n\r\n\t\t}else if(f==FONS_HIBRIDMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){ //Fora Cat\r\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=18;\r\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=zT;\r\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=zT;\r\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(1);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t}else if(sC==1){ //Cat i altres\r\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=18;\r\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=18;\r\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=18;\r\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(0.8);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#192A46');\r\n\t\t\t\t}else if(sC==2){ //Nomes cat\r\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=zT;\r\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=18;\r\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=18;\r\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(0);\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#192A46');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t*/\r\n\t\t}else if(f==FONS_TERRAINMAP){\r\n\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\r\n\t\t\tif((this.getZoom() > 17)&& (layerAdd)){\r\n\t\t\t\tthis.setZoom(17);\r\n\t\t\t}\r\n\r\n\t\t\tif((sC==0)){ //Fora Cat\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=zT;\r\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(1);\r\n\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==1){ //Cat i altres\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\r\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(0.8);\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==2){ //Nomes cat\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t}\r\n\r\n\t\t}else if(f.indexOf('colorBlankMap')!=-1){\r\n\r\n\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\r\n\r\n\t\t}else if(f==FONS_HIBRIDTERRAIN){\r\n\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\r\n\t\t\tif((this.getZoom() > 17)&& (layerAdd)){\r\n\t\t\t\tthis.setZoom(17);\r\n\t\t\t}\r\n\r\n\t\t\tif((sC==0)){ //Fora Cat\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=zT;\r\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(1);\r\n\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==1){ //Cat i altres\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\r\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(0.8);\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==2){ //Nomes cat\r\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\r\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t}\r\n\r\n\t\t}else if(f==FONS_TOPOGISMAP){\r\n\r\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\r\n\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tMQ_TOPO_GRIS_L15_19.setOpacity(1);\r\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=18;\r\n\t\t\t\tMQ_TOPO_GRIS_L0_14.options.maxZoom=14;\r\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=zT;\r\n\t\t\t\t//ICC_TOPO_GRIS_L7_10.options.maxZoom=zT;\r\n\t\t\t\tif(this.getZoom() <= 6){\r\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\r\n\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\r\n\r\n\t\t\t\t}\r\n\t\t\t}else if(sC==1){\r\n\t\t\t\tMQ_TOPO_GRIS_L15_19.setOpacity(1);\r\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=18;\r\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=18;\r\n\t\t\t//\tICC_TOPO_GRIS_L7_10.options.maxZoom=10;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==2){\r\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=zT;\r\n\t\t\t\tMQ_TOPO_GRIS_L0_14.options.maxZoom=zT;\r\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=18;\r\n\t\t\t\t//ICC_TOPO_GRIS_L7_10.options.maxZoom=10;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t}\r\n\t\t}else if(f==FONS_COLORMAP){\r\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.setOpacity(1);\r\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=18;\r\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=zT;\r\n\r\n\t\t\t\tif(this.getZoom() <= 6){\r\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\r\n\t\t\t\t}\r\n\t\t\t}else if(sC==1){\r\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.setOpacity(1);\r\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=18;\r\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=18;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\t\t\t}else if(sC==2){\r\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=zT;\r\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=18;\r\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t\t}\r\n\r\n\t\t}else if(f==FONS_HISTORICMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif(this.getZoom() > 14){\r\n\t\t\t\tmap.setZoom(14);\r\n\t\t\t}\r\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTO +this.getCurrentZoomLevel());\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tthis.fitBounds(CatBounds);\r\n\t\t\t}\r\n\r\n\r\n\t\t}else if(f==FONS_DIVADMIN){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif(this.getZoom() > 18){\r\n\t\t\t\tmap.setZoom(18);\r\n\t\t\t}\r\n\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\r\n\r\n\r\n\t\t}else if(f==FONS_HISTORICORTOMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTOOrto +this.getCurrentZoomLevel());\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tthis.fitBounds(CatBounds);\r\n\t\t\t}\r\n\t\t}else if(f==FONS_HISTORICORTOMAP46){\r\n\t\t\t////this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tthis.fitBounds(CatBounds);\r\n\r\n\t\t\t}\r\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTOOrto46 +this.getCurrentZoomLevel());\r\n\r\n\t\t}else if(f==FONS_ALCADAMAP){\r\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\r\n\t\t\tif((sC==0)){\r\n\t\t\t\tthis.fitBounds(CatBounds);\r\n\r\n\t\t\t}\r\n\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\r\n\t\t}else{\r\n\r\n\t\t}\r\n\t},\r\n\r\n\ttopoMap: function (print){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.options.typeMap=FONS_TOPOMAP;\r\n\t\tthis.ajustaZoom(20);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_topoLayers=L.layerGroup();\r\n\t\tTOPO_ICC_L0_6=  new L.TileLayer(mapaUrl.topoMapMON, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 6,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: false,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\tworldCopyJump: false,\r\n\t\t}).addTo(_topoLayers);\r\n\t\tTOPO_MQ_L7_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\r\n\t\t\tminZoom: 7,\r\n\t\t\tmaxZoom:19,\r\n\t\t\tsubdomains:subDomains}\r\n\t\t).addTo(_topoLayers);\r\n\t\tif(print){\r\n\t\t\tTOPO_ICC_L7_10 = new L.TileLayer(mapaUrl.topoMapICGC,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 7,\r\n\t\t\t\tmaxZoom: 10,\r\n\t\t\t\tboundary: catContorn,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tsubdomains:subDomainsA,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_topoLayers);\r\n\r\n\t\t\tTOPO_ICC_L11_12 = new L.TileLayer(mapaUrl.topoMapICGC,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 11,\r\n\t\t\t\tmaxZoom: 12,\r\n\t\t\t\tboundary: catContorn,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tsubdomains:subDomainsA,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_topoLayers);\r\n\r\n\t\t}else{ //no es true\r\n\r\n\t\t\tTOPO_ICC_L7_10 = new L.TileLayer.boundaryCanvas(mapaUrl.topoMapICGC,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 7,\r\n\t\t\t\tmaxZoom: 10,\r\n\t\t\t\tboundary: catContorn,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tsubdomains:subDomainsA,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_topoLayers);\r\n\r\n\r\n\t\t\tTOPO_ICC_L11_12 = new L.TileLayer.boundaryCanvas(mapaUrl.topoMapICGC,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 11,\r\n\r\n\t\t\t\tmaxZoom: 12,\r\n\t\t\t\tboundary: catContorn,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tsubdomains:subDomainsA,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_topoLayers);\r\n\r\n\t\t}\r\n\r\n\t\tTOPO_ICC_L12_19 = new L.TileLayer(mapaUrl.topoMapICGC,{\r\n\t\t\ttms:false,\r\n\t\t\tminZoom: 13,\r\n\t\t\tmaxZoom: 20,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\tworldCopyJump: false\r\n\t\t}).addTo(_topoLayers);\r\n\t\tthis.addLayer(_topoLayers,true);\r\n\t\tthis.setActiveMap(FONS_TOPOMAP);\r\n\t},\r\n\r\n\r\n\r\n\ttopoMapGeo: function (){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.options.typeMap=FONS_TOPOMAP_GEO;\r\n\t\tthis.ajustaZoom(18);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_topoLayersGeo=L.layerGroup();\r\n\r\n\r\n\t\tTOPO_GEO_MON_L0_14=  new L.TileLayer(mapaUrl.topoMapSuauOSM, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 14,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: false,\r\n\t\t\tworldCopyJump: false,\r\n\t\t}).addTo(_topoLayersGeo);\r\n\r\n\r\n\t\tTOPO_GEO_MQ_L15_18 = new L.TileLayer(mapaUrl.topoMapOSM,{\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom:18,\r\n\r\n\t\t\tsubdomains:subDomains}\r\n\t\t).addTo(_topoLayersGeo);\r\n\r\n\r\n\r\n\r\n\t\tTOPO_GEO_ICC_L8_17 = new L.TileLayer(mapaUrl.topoMapSuauICGC,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom: 18\r\n\r\n\t\t}).addTo(_topoLayersGeo);\r\n\t\tthis.addLayer(_topoLayersGeo,true);\r\n\t\tthis.setActiveMap(FONS_TOPOMAP_GEO);\r\n\t},\r\n\r\n\r\n\tajustaZoom:function (maxZoom){\r\n\tthis.options.maxZoom=maxZoom;\r\n\tthis.getZoom() > maxZoom ?  this.setZoom(maxZoom) : null;\r\n\r\n\t},\r\n\r\n\tortoMap: function (print){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(20);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_ORTOMAP;\r\n\t\t_ortoLayers=L.layerGroup();\r\n\r\n\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\r\n\t\t   minZoom: 0,\r\n\t\t   maxZoom:19}\r\n\t\t).addTo(_ortoLayers);\r\n\r\n\r\n\r\n\t\tORTO_ICC_L0_11 = new L.TileLayer(mapaUrl.ortoInstamaps,{\r\n\t\t\ttms:false,\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 12,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false\r\n\t\t}).addTo(_ortoLayers);\r\n\r\n\r\n\r\n\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\r\n\t\t\ttms:false,\r\n\t\t\tminZoom: 13,\r\n\t\t\tmaxZoom: 20,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false\r\n\t\t}).addTo(_ortoLayers);\r\n\r\n\t\tthis.addLayer(_ortoLayers,true);\r\n\t\tthis.setActiveMap(FONS_ORTOMAP);\r\n\t},\r\n\r\n\t\tortoAugmentada:function(print){\r\n\r\n\t\t\tthis.deletePreviousMap();\r\n\t\t\tthis.ajustaZoom(20);\r\n\t\t\tthis.setMapColor(null);\r\n\t\t\tthis.options.typeMap=FONS_ORTOAUGMENTADA;\r\n\t\t\t_ortoAurgmentada=L.layerGroup();\r\n\r\n\t\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\r\n\t\t\t   minZoom: 0,\r\n\t\t\t   maxZoom:19}\r\n\t\t\t).addTo(_ortoAurgmentada);\r\n\r\n\r\n\r\n\t\t\tif(print){\r\n\t\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer(mapaUrl.ortoAugmentada,{\r\n\t\t\t\t\ttms:false,\r\n\t\t\t\t\tminZoom: 4,\r\n\t\t\t\t\tmaxZoom: 17,\r\n\t\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\t\tworldCopyJump: false\r\n\t\t\t\t}).addTo(_ortoAurgmentada);\r\n\r\n\t\t\t}else{ //no es true\r\n\r\n\r\n\r\n\t\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer.boundaryCanvas(mapaUrl.ortoAugmentada,{\r\n\t\t\t\t\ttms:false,\r\n\t\t\t\t\tminZoom: 4,\r\n\t\t\t\t\tmaxZoom: 17,\r\n\t\t\t\t\tboundary: catContorn5k,\r\n\t\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\t\tworldCopyJump: false\r\n\t\t\t\t}).addTo(_ortoAurgmentada);\r\n\r\n\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 18,\r\n\t\t\t\tmaxZoom: 20,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_ortoAurgmentada);\r\n\r\n\t\t\tthis.addLayer(_ortoAurgmentada,true);\r\n\t\t\tthis.setActiveMap(FONS_ORTOAUGMENTADA);\r\n\r\n\r\n\t\t},\r\n\r\n\r\n\tnaturalMap: function (){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.options.typeMap=FONS_NATURAL;\r\n\t\tthis.ajustaZoom(18);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_naturalMap=L.layerGroup();\r\n\r\n\t\tTOPO_GEO_MON_L0_14=  new L.TileLayer(mapaUrl.topoMapSuauOSM, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 14,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: false,\r\n\t\t\tworldCopyJump: false,\r\n\t\t}).addTo(_naturalMap);\r\n\r\n\r\n\t\tTOPO_GEO_MQ_L15_18 = new L.TileLayer(mapaUrl.topoNaturalOSM,{\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom:18,\r\n\r\n\t\t\tsubdomains:subDomainsA}\r\n\t\t).addTo(_naturalMap);\r\n\r\n\t\tTOPO_GEO_ICC_L8_17 = new L.TileLayer(mapaUrl.topoNaturalSuau,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 18\r\n\r\n\t\t}).addTo(_naturalMap);\r\n\r\n\r\n\t\tTOPO_GEO_ICC_L8_17_TOPONIMS = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 18\r\n\r\n\t\t}).addTo(_naturalMap);\r\n\r\n\r\n\r\n\r\n\r\n\r\n\t\tthis.addLayer(_naturalMap,true);\r\n\t\t\tthis.setActiveMap(FONS_NATURAL);\r\n\t},\r\n\r\n\r\n\tajustaZoom:function (maxZoom){\r\n\tthis.options.maxZoom=maxZoom;\r\n\tthis.getZoom() > maxZoom ?  this.setZoom(maxZoom) : null;\r\n\r\n\t},\r\n\r\n/*\r\n\r\n\thibridMap: function (print){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(18);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_HIBRIDMAP;\r\n\t\t_hibridLayers=L.layerGroup();\r\n\r\n\t\tHIBRID_MQ_L0_18 = new L.TileLayer(mapaUrl.ortoEsri,{\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom:18,\r\n\t\t\tsubdomains:subDomains\r\n\t\t}).addTo(_hibridLayers);\r\n\r\n\r\n\r\n\t\t\tHIBRID_ICGC_L0_18 = new L.TileLayer(mapaUrl.hibridInstamaps,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 0,\r\n\t\t\t\tmaxZoom: 18,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_hibridLayers);\r\n\r\n\t\tthis.addLayer(_hibridLayers,true);\r\n\tthis.setActiveMap(FONS_HIBRIDMAP);\r\n\t},\r\n\r\n*/\r\n\r\n\thibridMap:function(print){\r\n\r\n\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(19);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_HIBRIDMAP;\r\n\t\t_hibridLayers=L.layerGroup();\r\n\r\n\r\n\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\r\n\t\t   minZoom: 0,\r\n\t\t   maxZoom:19}\r\n\t\t).addTo(_hibridLayers);\r\n\r\n\r\n\t\tif(print){\r\n\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer(mapaUrl.ortoAugmentada,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 4,\r\n\t\t\t\tmaxZoom: 16,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_hibridLayers);\r\n\r\n\t\t}else{ //no es true\r\n\r\n\r\n\r\n\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer.boundaryCanvas(mapaUrl.ortoAugmentada,{\r\n\t\t\t\ttms:false,\r\n\t\t\t\tminZoom: 4,\r\n\t\t\t\tmaxZoom: 16,\r\n\t\t\t\tboundary: catContorn5k,\r\n\t\t\t\tcontinuousWorld: true,\r\n\t\t\t\tworldCopyJump: false\r\n\t\t\t}).addTo(_hibridLayers);\r\n\r\n\r\n\t\t}\r\n\r\n\r\n\r\n\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\r\n\t\t\ttms:false,\r\n\t\t\tminZoom: 17,\r\n\t\t\tmaxZoom: 20,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false\r\n\t\t}).addTo(_hibridLayers);\r\n\r\n\r\n\r\n\t\tORTO_HIBRID_8_18_VECTOR = new L.TileLayer(mapaUrl.hibridTotal,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\topacity:0.5,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 17\r\n\t\t}).addTo(_hibridLayers);\r\n\r\n\r\n\r\n\r\n\t\tORTO_HIBRID_L8_17_TOPONIMS = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tminZoom: 8,\r\n\t\t\topacity:0.8,\r\n\t\t\tmaxZoom: 18\r\n\r\n\t\t}).addTo(_hibridLayers);\r\n\r\n\r\n\r\n\t\tthis.addLayer(_hibridLayers,true);\r\n\t\tthis.setActiveMap(FONS_HIBRIDMAP);\r\n\r\n\r\n\t},\r\n\r\n\thibridTerrainMap: function (){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(17);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_hibridTerrainMap=L.layerGroup();\r\n\r\n\t\tESRI_RELLEU_L0_13 =new L.TileLayer(mapaUrl.terrainEsri,{\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom:9}\r\n\t\t).addTo(_hibridTerrainMap);\r\n\r\n\t\tICC_RELLEU_L0_14= new L.TileLayer(mapaUrl.terrainInstamaps, {\r\n\t\t   minZoom: 0,\r\n\t\t   maxZoom: 17,\r\n\t\t   tms:false,\r\n\t\t   continuousWorld: true,\r\n\t\t   worldCopyJump: false,\r\n\t\t}).addTo(_hibridTerrainMap);\r\n\r\n\r\n\r\n\t\tTERRAIN_HIBRID_8_18_VECTOR = new L.TileLayer(mapaUrl.hibridTotal,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 17\r\n\r\n\t\t}).addTo(_hibridTerrainMap);\r\n\r\n\r\n\r\n\t\t/*\r\n\t\tTERRAIN_HIBRID_8_18_TOPO1 = new L.TileLayer(mapaUrl.topoNaturalSuau,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tsubdomains:subDomainsA,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 17\r\n\r\n\t\t}).addTo(_hibridTerrainMap);\r\n*/\r\n\r\n\t\tTERRAIN_HIBRID_8_18_TOPO2 = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tminZoom: 8,\r\n\t\t\tmaxZoom: 17\r\n\r\n\t\t}).addTo(_hibridTerrainMap);\r\n\r\n\r\n\t\tthis.addLayer(_hibridTerrainMap,true);\r\n\t\t\tthis.setActiveMap(FONS_HIBRIDTERRAIN);\r\n\t},\r\n\r\n\r\n\r\n\tterrainMap: function (){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(17);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_terrainLayers=L.layerGroup();\r\n\r\n\t\tESRI_RELLEU_L0_13 =new L.TileLayer(mapaUrl.terrainEsri,{\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom:9}\r\n\t\t).addTo(_terrainLayers);\r\n\r\n\t\tICC_RELLEU_L0_14= new L.TileLayer(mapaUrl.terrainInstamaps, {\r\n\t\t   minZoom: 0,\r\n\t\t   maxZoom: 17,\r\n\t\t   tms:false,\r\n\t\t   continuousWorld: true,\r\n\t\t   worldCopyJump: false,\r\n\t\t}).addTo(_terrainLayers);\r\n\r\n\t\tthis.addLayer(_terrainLayers,true);\r\n\t\t\tthis.setActiveMap(FONS_TERRAINMAP);\r\n\t},\r\n\r\n\ttopoGrisMap: function (print){\r\n\t\tthis.deletePreviousMap();\r\n\t\tthis.ajustaZoom(18);\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\t_grisLayers=L.layerGroup();\r\n\r\n\r\n\t\tMQ_TOPO_GRIS_L0_14 =new L.TileLayer(mapaUrl.topoGrisOSM,{\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom:14,\r\n\t\t\tcolor:'gris',\r\n\t\t\tsubdomains:subDomains\r\n\t\t}).addTo(_grisLayers);\r\n\r\n\t\tMQ_TOPO_GRIS_L15_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom:18,\r\n\t\t\tcolor:'gris',\r\n\t\t\tsubdomains:subDomains\r\n\t\t}).addTo(_grisLayers);\r\n\r\n\t\tICC_TOPO_GRIS_L11_19 = new L.TileLayer(mapaUrl.topoGrisICGC,{\r\n\t\t\ttms:false,\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom: 18,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false\r\n\t\t}).addTo(_grisLayers);\r\n\r\n\t\t//_grisLayers.addTo(this);\r\n\r\n\t\tthis.addLayer(_grisLayers,true);\r\n\t\t\tthis.setActiveMap(FONS_TOPOGISMAP);\r\n\t},\r\n\r\n\tcolorMap: function (color){\r\n\t\t//this.options.maxZoom=19;\r\n\t\tthis.ajustaZoom(18);\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(color);\r\n\t\t_topoColorLayers=L.layerGroup();\r\n\r\n\r\n\t\tCOLOR_TOPO_ICC_L0_6= new L.TileLayer(mapaUrl.topoSuauColor[color].osm, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 14,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tcolor:color\r\n\t\t}).addTo(_topoColorLayers);\r\n\r\n\t\tCOLOR_TOPO_MQ_L7_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom:18,\r\n\t\t\tcolor:color,\r\n\t\t\tsubdomains:subDomains\r\n\t\t}).addTo(_topoColorLayers);\r\n\r\n\t\tCOLOR_TOPO_ICC_L11_19= new L.TileLayer(mapaUrl.topoSuauColor[color].suau, {\r\n\t\t\tminZoom: 15,\r\n\t\t\tmaxZoom: 18,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t\tcolor:color\r\n\t\t}).addTo(_topoColorLayers);\r\n\r\n\t\tthis.addLayer(_topoColorLayers,true);\r\n\t\t\tthis.setActiveMap(FONS_COLORMAP);\r\n\t},\r\n\r\n\thistoricMap:function(){\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_HISTORICMAP;\r\n\t\tthis.ajustaZoom(14);\r\n\t\t_histoMap=L.layerGroup();\r\n\r\n\t\tHISTO_ICC_L0_14= new L.TileLayer(mapaUrl.topo36ICGC, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 14,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false,\r\n\t\t}).addTo(_histoMap);\r\n\r\n\t\tthis.addLayer(_histoMap,true);\r\n\tthis.setActiveMap(FONS_HISTORICMAP);\r\n\t},\r\n\r\n\tcolorBlankMap:function(color){\r\n\r\n\t\tthis.deletePreviousMap();\r\n\t\tFONS_COLORBLANK=color;\r\n\t\tcolor=color.replace('colorBlankMap','');\r\n\t\tthis.setMapColor(null);\r\n\r\n\t\tthis.options.typeMap=FONS_COLORBLANK;\r\n\t\t//this.ajustaZoom(14);\r\n\t\t_colorBlankMap=L.layerGroup();\r\n\r\n\t\t new L.TileLayer(mapaUrl.fonsBlank, {\r\n\t\t\tminZoom: 2,\r\n\t\t\tmaxZoom: 19,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false,\r\n\t\t}).addTo(_colorBlankMap);\r\n\r\n\t\tthis.addLayer(_colorBlankMap,true);\r\n\tthis.setActiveMap(FONS_COLORBLANK);\r\n\tjQuery('#map').css('backgroundColor',color);\r\n\r\n\r\n\t},\r\n\r\n\tdivadminMap:function(){\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_DIVADMIN;\r\n\t\tthis.ajustaZoom(18);\r\n\t\t_divadminMap=L.layerGroup();\r\n\r\n\r\n\t\tDIVADMIN_L0_14= new L.TileLayer(mapaUrl.topoLimitsSuau, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 13,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false,\r\n\t\t}).addTo(_divadminMap);\r\n\r\n\r\n\r\n\r\n\r\n\t\tDIVADMIN_L14_18= new L.TileLayer(mapaUrl.topoGrisICGC, {\r\n\t\t\tminZoom: 14,\r\n\t\t\tmaxZoom: 18,\r\n\t\t\ttms:false,\r\n\t\t\tcolor:'gris',\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t}).addTo(_divadminMap);\r\n\r\n\r\n\t\tDIVADMIN_L14_18_TOPO= new L.TileLayer(mapaUrl.toponimsNaturalSuau, {\r\n\t\t\tminZoom: 14,\r\n\t\t\tmaxZoom: 18,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump: false,\r\n\t\t}).addTo(_divadminMap);\r\n\r\n\r\n\t\tthis.addLayer(_divadminMap,true);\r\nthis.setActiveMap(FONS_DIVADMIN);\r\n\t},\r\n\r\n\thistoricOrtoMap:function(){\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_HISTORICORTOMAP;\r\n\r\n\t\tthis.ajustaZoom(17);\r\n\t\t_histoOrtoMap=L.layerGroup();\r\n\r\n\t\tHISTOOrto_ICC_L0_14= new L.TileLayer(mapaUrl.orto55ICGC, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 17,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false\r\n\r\n\t\t}).addTo(_histoOrtoMap);\r\n\t\t/*\r\n\t\tHISTOOrto_ICC_L0_14= new L.tileLayer.wms(mapaUrl.orto55ICGC, {\r\n\t\t\tlayers: 'ovab5m',\r\n\t\t\tformat: 'image/png',\r\n\t\t\ttransparent: true,\r\n\t\t\texceptions:'application/vnd.ogc.se_xml'\r\n\t\t}).addTo(_histoOrtoMap);\r\n\t\t*/\r\n\t\tthis.addLayer(_histoOrtoMap,true);\r\n\tthis.setActiveMap(FONS_HISTORICORTOMAP);\r\n\t},\r\n\r\n\thistoricOrtoMap46:function(){\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_HISTORICORTOMAP46;\r\n\r\n\t\tthis.ajustaZoom(17);\r\n\r\n\t\t_histoOrtoMap46=L.layerGroup();\r\n\r\n\t\tHISTOOrto46_ICC_L0_14= new L.TileLayer(mapaUrl.orto46ICGC, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 17,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false\r\n\t\t\t//attribution:'Font:Ministerio de Defensa'\r\n\t\t}).addTo(_histoOrtoMap46);\r\n\r\n\r\n\r\n\t\tthis.addLayer(_histoOrtoMap46,true);\r\n\tthis.setActiveMap(FONS_HISTORICORTOMAP46);\r\n\t},\r\n\r\n\talcadaMap:function(){\r\n\t\tthis.deletePreviousMap();\r\n\r\n\t\tthis.setMapColor(null);\r\n\t\tthis.options.typeMap=FONS_ALCADAMAP;\r\n\r\n\t\tthis.ajustaZoom(16);\r\n\t\t_alcadesMap=L.layerGroup();\r\n\r\n\t\tALCADAMAPA_ICGC_L0_17= new L.TileLayer(mapaUrl.ombraInstamaps, {\r\n\t\t\tminZoom: 0,\r\n\t\t\tmaxZoom: 16,\r\n\t\t\ttms:false,\r\n\t\t\tcontinuousWorld: true,\r\n\t\t\tworldCopyJump:false\r\n\t\t\t//attribution:'Font:Ministerio de Defensa'\r\n\t\t}).addTo(_alcadesMap);\r\n\r\n\r\n\r\n\t\tthis.addLayer(_alcadesMap,true);\r\n\tthis.setActiveMap(FONS_ALCADAMAP);\r\n\t},\r\n\r\n\r\n\r\n\trmCapa: function (grup,layer){\r\n\r\n\t\tif(grup.hasLayer(layer)){grup.removeLayer(layer);return}\r\n\r\n\t},\r\n\r\n\taddCapa: function (grup,layer){\r\n\r\n\t\tif(!grup.hasLayer(layer)){grup.addLayer(layer,true);return}\r\n\r\n\t},\r\n\r\n\tdeletePreviousMap: function () {\r\n\r\n\t\tif(this.hasLayer(_topoLayers)){this.removeLayer(_topoLayers);return}\r\n\t\telse if(this.hasLayer(_topoLayersGeo)){this.removeLayer(_topoLayersGeo);return}\r\n\t\telse if(this.hasLayer(_ortoLayers)){this.removeLayer(_ortoLayers);return}\r\n\t\telse if(this.hasLayer(_hibridLayers)){this.removeLayer(_hibridLayers);return}\r\n\t\telse if(this.hasLayer(_terrainLayers)){this.removeLayer(_terrainLayers);return}\r\n\t\telse if(this.hasLayer(_topoColorLayers)){this.removeLayer(_topoColorLayers);return}\r\n\t\telse if(this.hasLayer(_grisLayers)){this.removeLayer(_grisLayers);return}\r\n\t\telse if(this.hasLayer(_histoMap)){this.removeLayer(_histoMap);return}\r\n\t\telse if(this.hasLayer(_histoOrtoMap)){this.removeLayer(_histoOrtoMap);return}\r\n\t\telse if(this.hasLayer(_histoOrtoMap46)){this.removeLayer(_histoOrtoMap46);return}\r\n\t\telse if(this.hasLayer( _naturalMap)){this.removeLayer( _naturalMap);return}\r\n\t\telse if(this.hasLayer(_divadminMap)){this.removeLayer(_divadminMap);return}\r\n\t\telse if(this.hasLayer(_alcadesMap)){this.removeLayer(_alcadesMap);return}\r\n\t\telse if(this.hasLayer(_colorBlankMap)){this.removeLayer(_colorBlankMap);return}\r\n\t\telse if(this.hasLayer(_hibridTerrainMap)){this.removeLayer(_hibridTerrainMap);return}\r\n\r\n\t}\r\n\t//fi default metode\r\n});\r\n","/*\n * L.IM_ColorLayer is a regular tilelayer with grayscale makeover.\n */\n\nL.IM_ColorLayer = L.TileLayer.extend({\n\toptions: {\n\t\tenableCanvas: true,\n\t\tcolor:'gris'\n\t},\n\n\tinitialize: function (url, options) {\n\t\tvar canvasEl = document.createElement('canvas');\n\t\tif( !(canvasEl.getContext && canvasEl.getContext('2d')) ) {\n\t\t\toptions.enableCanvas = false;\n\t\t}\n\n\t\tL.TileLayer.prototype.initialize.call(this, url, options);\n\t},\n\n\t_loadTile: function (tile, tilePoint) {\n\t\ttile.setAttribute('crossorigin', 'anonymous');\n\t\tL.TileLayer.prototype._loadTile.call(this, tile, tilePoint);\n\t},\n\n\t_tileOnLoad: function () {\n\t\tif (this._layer.options.enableCanvas && !this.canvasContext) {\n\t\t\tvar canvas = document.createElement(\"canvas\");\n\t\t\tcanvas.width = canvas.height = this._layer.options.tileSize;\n\t\t\tthis.canvasContext = canvas.getContext(\"2d\");\n\t\t}\n\t\tvar ctx = this.canvasContext;\n\n\t\tif (ctx) {\n\t\t\tthis.onload  = null; // to prevent an infinite loop\n\t\t\tctx.drawImage(this, 0, 0);\n\t\t\tvar imgd = ctx.getImageData(0, 0, this._layer.options.tileSize, this._layer.options.tileSize);\n\t\t\tvar d = imgd.data;\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris'){\n\t\t\t\t\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t\t  d[i] = d[i + 1] = d[i + 2] = (r+g+b)/3;\n\t\t\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='grisClar'){\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\tvar brightness = 0.44 * d[i] + 0.5 * d[i + 1] + 0.16 * d[i + 2];\n\t\t\t          // r\n\t\t\t          d[i] = brightness;\n\t\t\t          // green\n\t\t\t          d[i + 1] = brightness;\n\t\t\t          // blue\n\t\t\t          d[i + 2] = brightness;\n\t\t\t        }\n\t\t}\n\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='sepia'){\n\t\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t  d[i]     = (r * 0.393)+(g * 0.769)+(b * 0.189); // red\n\t\t\t\t\t  d[i + 1] = (r * 0.349)+(g * 0.686)+(b * 0.168); // green\n\t\t\t\t\t  d[i + 2] = (r * 0.272)+(g * 0.534)+(b * 0.131); // blue\n\t\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='orquidea'){\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t        r = d[i];\n\t\t\t        g = d[i + 1];\n\t\t\t        b = d[i + 2];\n\n\t\t\t        d[i] = (r * 0.393 + g * 0.769 + b * 0.189 ) / 1.351;\n\t\t\t        d[i + 1] = (r * 0.349 + g * 0.686 + b * 0.168 ) / 1.203;\n\t\t\t        d[i + 2] = (r * 0.272 + g * 0.534 + b * 0.131 ) / 2.140;\n\t\t\t      }\n\t\t\t\t*/\n\t\t\t\t\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t        avg = 0.25  * d[i] + 0.59 * d[i + 1] + 0.11 * d[i + 2];\n\t\t\t\t        d[i] = avg + 250;\n\t\t\t\t        d[i + 1] = avg + 20;\n\t\t\t\t        d[i + 2] = avg + 200;\n\t\t\t\t      }\n\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\t\n\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t  \n\t\t\t\t\t  d[i]     = (r * 0.95)+(g * 2.169)+(b * 2.989); // red\n\t\t\t\t\t  d[i + 1] = (r * 0.26)+(g * 0.5)+(b * 0.168); // green\n\t\t\t\t\t  d[i + 2] = (r * 0.96)+(g * 2.734)+(b * 2); // blue\n\t\t\t\t\t  \n\t\t\t\t\t  \n\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\t*/\n\t\t\t\n}\n\t\t\t\n\t\t\t\t\t\t\n\t\t\tif(this._layer.options.color=='zombie'){\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t        avg = 0.2  * d[i] + 0.49 * d[i + 1] + 0.21 * d[i + 2];\n\t\t\t        d[i] = avg + 255;\n\t\t\t        d[i + 1] = avg + 1;\n\t\t\t        d[i + 2] = avg + 20;\n\t\t\t      }\n\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  d[i] = (r+g+b)/2.5;      \t\t\t\t  \n\t\t\t\t  d[i + 1] = d[i + 2] = 50; // zero out green and blue channel\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t*/\n\t\t\t\t\n\t\t\t}\n\t\t\tif(this._layer.options.color=='nit'){\n\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t // red\n\t\t\t\td[i] = 255 - d[i];\n          // green\n\t\t\t\td[i + 1] = 255 - d[i + 1];\n          // blue\n\t\t\t\td[i + 2] = 255 - d[i + 2];\n\t\t\t}\n\t\t\t}\n\t\t\tif(this._layer.options.color=='brillant'){\n\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t  var brightness = 0.54 * d[i] + 0.7 * d[i + 1] + 0.16 * d[i + 2];\n          // red\n\t\t\t\td[i] = brightness;\n          // green\n\t\t\t\td[i + 1] = d[i + 1];\n          // blue\n\t\t\t\td[i + 2] =d[i + 2];\n\t\t\t}\n\t\t\t}\n\t\t\tif(this._layer.options.color=='negre_blau'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=0 && r <=100) && (g >=0 && g <=100) && (b >=0 && b <=100)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 0\n\t\t\t\t  d[i + 1] = 0;\n\t\t\t\t  d[i + 2] = 255;\n\t\t\t\t  \n\t\t\t\t  }else{\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t\t // d[i] = r;    // apply average to red channel\n\t\t\t\t  //d[i + 1] = g;\n\t\t\t\t  //d[i + 2] = b;\n\n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  // zero out green and blue channel\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris_verd'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=120 && r <=190) && (g >=120 && g <=190) && (b >=120 && b <=190)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 9\n\t\t\t\t  d[i + 1] = 190;\n\t\t\t\t  d[i + 2] = 0;\n\t\t\t\t  \n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris_vermell_tot'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=120 && r <=190) && (g >=120 && g <=190) && (b >=120 && b <=190)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 255\n\t\t\t\t  d[i + 1] = 204;\n\t\t\t\t  d[i + 2] = 0;\n\t\t\t\t  \n\t\t\t\t  }else{\n\t\t\t\t    d[i] = 230\n\t\t\t\t  d[i + 1] = 230;\n\t\t\t\t  d[i + 2] = 230;\n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t}\n\t\t\t}\n\t\t\t//rgb(220, 185, 185)\n\t\t\t//rgb(255, 197, 0)\n\t\t\tif(this._layer.options.color=='mb'){\n\t\t\t\t\n\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t  var r = d[i];\t\t \n\t\t  var g = d[i + 1];\n\t\t  var b = d[i + 2];\n\t\t  \n\t\t // rgb(244, 245, 228)\n\t\t // rgb(245, 246, 227)\n\t\t  \n\t\t  if((r>=243 && r <=246) && (g >=243 && g <=247) && (b >=226 && b <=229)){\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t  d[i] = 245;\n\t\t\t\t  d[i + 1] = 175;\n\t\t\t\t  d[i + 2] = 5;\n\t\t\t\t  d[i + 3] = 0;\n\t\t\t\t  }\n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  if((r>=250 && r <=255) && (g >=250 && g <=255) && (b >=250 && b <=255)){\n\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t // console.info(r);\n\t\t\t  //rgb(204, 231, 252)\n\t\t  d[i] = 204;\n\t\t  d[i + 1] = 231;\n\t\t  d[i + 2] = 252;\n\t\t  d[i + 3] = 0;\n\t\t  }\n\t\t  \n\t\t \n\t\t  \n\t\t  \n\t}\n\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t/*Gris\n\t\t\t if(imageData.data[i]==oldRed &&\n         imageData.data[i+1]==oldGreen &&\n         imageData.data[i+2]==oldBlue\n      ){\n          // change to your new rgb\n          imageData.data[i]=newRed;\n          imageData.data[i+1]=newGreen;\n          imageData.data[i+2]=newBlue;\n      }\n\t\t\t \n\t\t\t\n\t\t\t*/\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t/*\n\t\t\tfor (var i = 0, n = pix.length; i < n; i += 4) {\n\t\t\t\tpix[i] = pix[i + 1] = pix[i + 2] = (3 * pix[i] + 4 * pix[i + 1] + pix[i + 2]) / 8;\n\t\t\t}\n\t\t\t*/\n\t\t\tctx.putImageData(imgd, 0, 0);\n\t\t\tthis.removeAttribute(\"crossorigin\");\n\t\t\tthis.src = ctx.canvas.toDataURL();\n\t\t}\n\n\t\tL.TileLayer.prototype._tileOnLoad.call(this);\n\t}\n});\n\n/*\nL.IM_ColorLayer = function (url, options) {\n\treturn new L.IM_ColorLayer(url, options);\n};\n*/\n","/*\r\nExemple \r\nL.control.coordinates({\r\n\t\t\tposition : 'bottomright', \r\n\t\t\t'emptystring':' ',\r\n\t\t\t'numDigits': 2,\r\n\t\t\t'prefix': 'ETRS89 UTM 31N',\r\n\t\t\t'separator': ' '\r\n\t\t}).addTo(map);\r\n*/\r\n\r\nL.Control.Coordinates = L.Control.extend({\r\n  options: {\r\n    position: 'bottomleft',\r\n    separator: ' : ',\r\n    emptyString: '',\r\n    lngFirst: true, //modifiquem el paràmetre per mostrar les coordenades igual que el Vissir (issue #554)\r\n    numDigits: 2,\r\n    numDigits2: 6,\r\n\tcrs:new L.Proj.CRS('EPSG:25831',  '+proj=utm +zone=31 +ellps=GRS80 +datum=WGS84 +units=m +no_defs'),\r\n    lngFormatter: undefined,\r\n    latFormatter: undefined,\r\n    prefix: \"\",\r\n    prefix2: \"\",\r\n    showETRS89: true\r\n  },\r\n\r\n  onAdd: function (map) {\r\n\tvar self = this,\r\n\tcontainer = L.DomUtil.create('div', 'leaflet-control-mouseposition');\r\n\t\r\n\tcontainer.innerHTML=self.options.emptyString;\r\n\t\r\n\tself._container = container;\r\n\tself._div = self._container;\r\n\t\r\n\tmap.on('mousemove', self._onMouseMove, self);\r\n\t   \r\n\tL.DomEvent.disableClickPropagation(self._container);\r\n   \r\n    return self._container;\r\n  },\r\n\r\n  hideBtn: function(){\r\n\tvar self = this;\r\n\t$(self._div).hide();\r\n  },\r\n\r\n  showBtn: function(){\r\n\tvar self = this;\r\n\t$(self._div).show();\r\n  },\r\n  \r\n  onRemove: function (map) {\r\n    map.off('mousemove', this._onMouseMove);\r\n  },\r\n\r\n  _onMouseMove: function (e) {\r\n\tvar map = this._map;  \r\n\t\r\n\tvar sC=map.miraBBContains(map.getBounds());\r\n  \r\n    \r\n\tvar _CRS=this.options.crs.project( {lat:e.latlng.lat,lng:e.latlng.lng});\r\n  \r\n    //var lng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits);\r\n    //var lat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits);\r\n    \r\n\tvar lng = this.options.lngFormatter ? this.options.lngFormatter(_CRS.x) : L.Util.formatNum(_CRS.x, this.options.numDigits);\r\n    var lat =this.options.latFormatter ? this.options.latFormatter(_CRS.y) : L.Util.formatNum(_CRS.y, this.options.numDigits);\r\n\t\r\n\tvar value = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;\r\n\t\r\n\tlng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits2);\r\n\tlat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits2);\r\n\t\r\n\tvar value2 = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;\r\n\t\r\n    var prefixAndValue = this.options.prefix + ' ' + value;\r\n    var prefixAndValue2 = this.options.prefix2 + ' ' +value2;\r\n    if((sC===0)){\r\n    \tthis._container.innerHTML = prefixAndValue2;\r\n    }\r\n    else if((sC==1 || sC==2)){  \r\n\t    if (this.options.showETRS89) this._container.innerHTML = prefixAndValue + '<br/>'+ prefixAndValue2;\r\n\t    else this._container.innerHTML = prefixAndValue2;\r\n    }\r\n  }\r\n\r\n});\r\n\r\nL.Map.mergeOptions({\r\n    positionControl: false\r\n});\r\n\r\nL.Map.addInitHook(function () {\r\n    if (this.options.positionControl) {\r\n        this.positionControl = new L.Control.Coordinates();\r\n        this.addControl(this.positionControl);\r\n    }\r\n});\r\n\r\nL.control.coordinates = function (options) {\r\n    return new L.Control.Coordinates(options);\r\n};\r\n","/**\r\n * L.Control.OpenInstamaps permite abrir un visor embed en un iframe en un visor de Instamaps en una nueva ventana.\r\n */\r\n\r\nL.Control.OpenInstamaps = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\turl: 'http://instamaps.cat/geocatweb/visor.html?',\r\n\t\tid: 'div-linkViewMap',\r\n\t\tclassName: 'control-linkViewMap',\r\n\t\ttitle: 'Veure a InstaMaps',\r\n\t\tlangTitle: 'Veure a InstaMaps',\r\n\t\thtml: '&nbsp;<span class=\"glyphicon glyphicon-fullscreen grisfort bt-expand\"></span>',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\t\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tif (options.businessid){\r\n\t\t\toptions.url += '&businessid='+options.businessid;\r\n\t\t}\r\n\t\tif(options.urlwms){\r\n\t\t\toptions.url += '&urlwms='+options.urlwms+'&layername='+options.layername;\r\n\t\t}\r\n\t\t\r\n\t\tself._button = self._createButton(options.html, options.title, '', options.url, container, options.fn);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\t_createButton: function (html, title, className, url, container, fn) {\r\n\t\tvar link = L.DomUtil.create('a', className, container),\r\n\t\t\tstop = L.DomEvent.stopPropagation;\r\n\t\tlink.innerHTML = html;\r\n\t\tlink.setAttribute(\"target\", \"_blank\");\r\n\t\tlink.href = url;\r\n\t\tlink.title = title;\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.on(link, 'click', stop)\r\n\t\t\t.on(link, 'mousedown', stop)\r\n\t\t\t.on(link, 'dblclick', stop)\r\n\t\t\t.on(link, 'click', fn, this);\r\n\t\t\r\n\t\treturn link;\r\n\t}\r\n});\r\n\r\nL.control.openInstamaps = function(options){\r\n\treturn new L.Control.OpenInstamaps(options);\r\n};","/**\r\n * L.Control.Home control que permite volver a la vista inicial del mapa\r\n */\r\nL.Control.Home = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tid: 'dv_bt_vistaInicial',\r\n\t\tclassName: 'leaflet-bar  btn btn-default btn-sm',\r\n\t\ttitle: 'Vista inicial',\r\n\t\tlangTitle: 'Vista inicial',\r\n\t\thtml: '<span id=\"span_bt_vistaInicial\" class=\"fa fa-home grisfort\"></span>',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\t\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\r\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._goHome, self);\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tmap.off('loadconfig', this._updateMapConfig, this);\r\n\t\tmap.off('visorconfig', this._updateMapConfig, this);\r\n\t},\r\n\t\r\n\t_goHome: function(e){\r\n\t\tvar _mapConfig = this.options.mapConfig,\r\n\t\t\t_map = this._map;\r\n\t\t\r\n\t\t\r\n\t\tif(_mapConfig){\r\n\t\t\tif (_mapConfig.options.bbox){\r\n\t\t\t\tvar bbox = _mapConfig.options.bbox.split(\",\");\r\n\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]);\r\n\t\t\t    var northEast = L.latLng(bbox[3], bbox[2]);\r\n\t\t\t    var bounds = L.latLngBounds(southWest, northEast);\r\n\t\t\t    _map.fitBounds( bounds );\r\n\t\t\t}\r\n\t\t\telse if (_mapConfig.options.center){\r\n\t\t\t\tvar opcenter = _mapConfig.options.center.split(\",\");\r\n\t\t\t\t_map.setView(L.latLng(opcenter[0], opcenter[1]), _mapConfig.options.zoom);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#home','label home']});\r\n\t\t\r\n\t\t\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\t_updateMapConfig: function(config){\r\n\t\tthis.options.mapConfig = config;\r\n\t}\r\n});\r\n\r\nL.control.home = function(options){\r\n\treturn new L.Control.Home(options);\r\n};","/**\r\n *\r\n */\r\nL.Control.Share = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tid: 'dv_bt_Share',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\r\n\t\ttitle: 'Compartir',\r\n\t\tlangTitle: 'Compartir',\r\n\t\thtml: '<span id=\"span_bt_Share\" class=\"fa fa-share-alt\"></span>',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\toptions = self.options,\r\n\t\tstop = L.DomEvent.stopPropagation,\r\n\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\r\n\t\tself._div = container;\r\n\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\r\n\t\t\t.on(container, 'click', self._toggle, self);\r\n\r\n\t\treturn container;\r\n\t},\r\n\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\r\n\thide: function() {\r\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\r\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\r\n\t\t$('#socialShare_visor').hide();\r\n\t},\r\n\r\n\tshow: function(e){\r\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\r\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\r\n\t\tvar offset = $(this._div).offset();\r\n\t\t$('#socialShare_visor').css('top', (offset.top - 15) +'px');\r\n\t\t$('#socialShare_visor').css('left', (offset.left + 35) +'px');\r\n\t\t$('#socialShare_visor').show();\r\n\t\t$.publish('analyticsEvent',{event:['visor','button#share','label share', 9]});\r\n\r\n\t\t$('#socialShare_visor .pop-social').on('click', function(event){\r\n\t\t\t$.publish('analyticsEvent',{event:['visor', 'compartir-publicar', $(this).attr('data-type'), 1]});\r\n\t\t});\r\n\r\n\r\n\r\n\t},\r\n\r\n\t_toggle: function(e){\r\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\r\n\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t},\r\n\r\n});\r\n\r\nL.control.share = function(options){\r\n\treturn new L.Control.Share(options);\r\n};\r\n","/**\r\n * L.Control.RoutingControl control de routing basado en el leaflet-routing-machine\r\n */\r\n\r\nL.Control.RoutingControl = L.Control.extend({\r\n\tincludes: L.Mixin.Events,\r\n\t\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tlang: 'ca',\r\n\t\tid: 'dv_bt_Routing',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\r\n\t\ttitle: 'Routing',\r\n\t\tlangTitle: 'Routing',\r\n\t\thtml: '<span id=\"span_bt_Routing\" class=\"t\" style=\"font-size:16px; margin-top:-2px;\">'+\r\n\t\t'<i class=\"t-square-rounded\" style=\"-webkit-transform:scale(1.25) scale(0.65) rotate(45deg);-moz-transform:scale(1.25) scale(0.65) rotate(45deg);transform:scale(1.25) scale(0.65) rotate(45deg)\"></i>'+\r\n\t\t'<i class=\"t-turn-90-l t-c-white\" style=\"-webkit-transform:scale(-1.3, 1.3);-moz-transform:scale(-1.3, 1.3);transform:scale(-1.3, 1.3)\"></i>'+\r\n\t\t'</span>',\r\n\t\ttooltip: 'right',\r\n\t\tmarker_style_origen: {\r\n\t\t\ticon : '',\r\n\t\t\tmarkerColor : 'green',\r\n\t\t\tdivColor:'transparent',\r\n\t\t\ticonAnchor : new L.Point(14, 42),\r\n\t\t\ticonSize : new L.Point(28, 42),\r\n\t\t\ticonColor : '#000000',\r\n\t\t\tprefix : 'fa',\r\n\t\t\tisCanvas:false,\r\n\t\t\tradius:6,\r\n\t\t\topacity:1,\r\n\t\t\tweight : 2,\r\n\t\t\tfillOpacity : 0.9,\r\n\t\t\tcolor : \"#ffffff\",\r\n\t\t\tfillColor :\"transparent\"\r\n\t\t},\r\n\t\tmarker_style_desti: {\r\n\t\t\ticon : '',\r\n\t\t\tmarkerColor : 'red',\r\n\t\t\tdivColor:'transparent',\r\n\t\t\ticonAnchor : new L.Point(14, 42),\r\n\t\t\ticonSize : new L.Point(28, 42),\r\n\t\t\ticonColor : '#000000',\r\n\t\t\tprefix : 'fa',\r\n\t\t\tisCanvas:false,\r\n\t\t\tradius:6,\r\n\t\t\topacity:1,\r\n\t\t\tweight : 2,\r\n\t\t\tfillOpacity : 0.9,\r\n\t\t\tcolor : \"#ffffff\",\r\n\t\t\tfillColor :\"transparent\"\r\n\t\t},\r\n\t\tmarker_style_intermig: {\r\n\t\t\ticon : '',\r\n\t\t\tmarkerColor : 'orange',\r\n\t\t\tdivColor:'transparent',\r\n\t\t\ticonAnchor : new L.Point(14, 42),\r\n\t\t\ticonSize : new L.Point(28, 42),\r\n\t\t\ticonColor : '#000000',\r\n\t\t\tprefix : 'fa',\r\n\t\t\tisCanvas:false,\r\n\t\t\tradius:6,\r\n\t\t\topacity:1,\r\n\t\t\tweight : 2,\r\n\t\t\tfillOpacity : 0.9,\r\n\t\t\tcolor : \"#ffffff\",\r\n\t\t\tfillColor :\"transparent\"\r\n\t\t},\r\n\t\toriginTexts: {\r\n\t\t\ttitle: \"Càlcul de rutes\",\r\n\t\t\tbtnStart: \"Defineix com a origen\",\r\n\t\t\tbtnEnd: \"Defineix com a destí\",\r\n\t\t\tbtnReverse: \"Ruta inversa\",\r\n\t\t\tbtnAdd: \"Afegir punts\",\r\n\t\t\tstart: \"Inici\",\r\n\t\t\tend: \"Destí\"\r\n\t\t},\r\n\t\ttexts: {\r\n\t\t\ttitle: \"Càlcul de rutes\",\r\n\t\t\tbtnStart: \"Defineix com a origen\",\r\n\t\t\tbtnEnd: \"Defineix com a destí\",\r\n\t\t\tbtnReverse: \"Ruta inversa\",\r\n\t\t\tbtnAdd: \"Afegir punts\",\r\n\t\t\tstart: \"Inici\",\r\n\t\t\tend: \"Destí\"\r\n\t\t}\r\n\t},\r\n\t\r\n\t//TODO ver el tema del lang para poder cambiar el idioma del control\r\n\t\r\n\tinitialize: function(options) {\r\n\t\tL.setOptions(this, options);\r\n\t\t\r\n\t\tvar self = this,\r\n\t\t\toptions = this.options,\r\n\t\t\tlang = options.lang,\r\n\t\t\tpuntIntermig = L.AwesomeMarkers.icon(options.marker_style_intermig),\r\n\t\t\tpuntDesti = L.AwesomeMarkers.icon(options.marker_style_desti),\r\n\t\t\tpuntOrigen = L.AwesomeMarkers.icon(options.marker_style_origen);\r\n\t\t\r\n\t\tthis._reversablePlan = L.Routing.Plan.extend({\r\n\t\t    createGeocoders: function() {\r\n\t\t        var container = L.Routing.Plan.prototype.createGeocoders.call(this),\r\n\t\t        title = (window.lang) ? window.lang.translate(options.originTexts.btnReverse) : options.texts.btnReverse,\r\n\t\t        reverseButton = self._createButton('<span class=\"glyphicon glyphicon-sort\" style=\"font-size:14px;\"></span>', container, title, lang);\r\n\t\t        L.DomEvent.on(reverseButton, 'click', function() {\r\n\t\t            var waypoints = this.getWaypoints();\r\n\t\t            this.setWaypoints(waypoints.reverse());\r\n\t\t        }, this);\r\n\t\t        return container;\r\n\t\t    }\r\n\t\t});\r\n\t\t\r\n\t\tvar createMarker = function(i, wp) {\r\n        \tvar numWp = this._route.getWaypoints().length;\r\n        \tif(i == 0){\r\n        \t\treturn L.marker(wp.latLng, {\r\n    \t\t\t\tdraggable: true,\r\n    \t\t\t\ticon: puntOrigen\r\n    \t\t\t});\r\n        \t}\r\n        \telse if (i === (numWp - 1)){\r\n        \t\treturn L.marker(wp.latLng, {\r\n    \t\t\t\tdraggable: true,\r\n    \t\t\t\ticon: puntDesti\r\n    \t\t\t});\r\n        \t}\r\n        \telse {\r\n        \t\treturn L.marker(wp.latLng, {\r\n    \t\t\t\tdraggable: true,\r\n    \t\t\t\ticon: puntIntermig\r\n    \t\t\t});\r\n        \t}\r\n        };\r\n\t\t\r\n\t\tthis._plan = new this._reversablePlan([], {\r\n\t        geocoder: L.Control.Geocoder.icgc(),\r\n\t        routeWhileDragging: true,\r\n\t        language: lang,\r\n\t        createMarker: createMarker.bind(self)\r\n\t    });\r\n\t\t\r\n\t\tvar language=\"ca-ES\";\r\n\t\tif (lang==\"ca\") language=\"ca-ES\";\r\n\t\telse if (lang=\"es\") language=\"es-ES\";\r\n\t\telse language=\"en-US\";\r\n\t\t\r\n\t\tthis._route = L.Routing.control({\r\n\t\t\trouter: L.Routing.mapzen('mapzen-aMHsmLA', {\r\n\t\t\t\tlanguage: lang,\r\n\t\t\t\t    costing:'auto',\r\n\t\t\t\t    directions_options: {\r\n\t\t\t\t        language: language\r\n\t\t\t\t      }\r\n\t\t\t\t    }),\r\n\t\t\t formatter: new L.Routing.mapzenFormatter(),\r\n\t         routeWhileDragging: true,\r\n\t         plan: this._plan,\r\n\t         position: 'topleft',\r\n\t         language: language,\r\n\t\t     showAlternatives: true,\r\n\t\t     lineOptions: {\r\n\t            styles: [\r\n\t              {color: '#00B3FD', opacity: 1, weight: 4},\r\n\t            ]\r\n\t           },\r\n\t         altLineOptions:{\r\n\t        \tstyles: [\r\n\t     \t      {color: 'black', opacity: 1, weight: 2},\r\n\t     \t    ]\r\n\t         }\r\n\t\t});\r\n\t\t\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\t\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\tself._map = map;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\r\n\t\t\t.on(container, 'click', self._toggle, self);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tshow: function() {\r\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\r\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\r\n\t\tvar _map = this._map,\r\n\t\t\toptions = this.options,\r\n\t\t\t_texts = options.texts,\r\n\t\t\t_route = this._route;\r\n\t\t\r\n\t\t_map.fire('showRouting'); //to track ga events\r\n\t\t\r\n\t\t_map.on('click', this._routingPopup, this);\r\n\t\t_route.addTo(_map);\r\n\t\t\r\n\t\tif(window.lang){\r\n\t\t\t_texts.title = window.lang.translate(options.originTexts.title);\r\n\t\t\t_texts.btnReverse = window.lang.translate(options.originTexts.btnReverse);\r\n\t\t\t_texts.btnAdd = window.lang.translate(options.originTexts.btnAdd);\r\n\t\t\t_texts.start = window.lang.translate(options.originTexts.start);\r\n\t\t\t_texts.end = window.lang.translate(options.originTexts.end);\r\n\t\t}\r\n\t\t\r\n\t\t$('.leaflet-routing-geocoders').before( '<div class=\"div-routing-title\"><span lang=\"ca\" class=\"routing-title\">'+_texts.title+'</span>&nbsp;<a href=\"http://www.liedman.net/leaflet-routing-machine/\" target=\"_blank\" class=\"div-routing-title\" style=\"display:inline;\"><span class=\"glyphicon glyphicon-info-sign white\" style=\"font-size:14px;\"></a></div>' );\r\n\t\t$('.leaflet-routing-add-waypoint').attr('title',_texts.btnAdd);\r\n\t\t$('.leaflet-routing-add-waypoint').attr('lang',options.lang);\r\n\t\t$('.leaflet-routing-geocoder').first().find('input').attr('placeholder',_texts.start);\r\n\t\t$('.leaflet-routing-geocoder').last().find('input').attr('placeholder',_texts.end);\r\n\t\t\r\n\t\tvar offset = $(this._div).offset();\r\n\t\t\r\n\t\tjQuery('.leaflet-routing-container').css('top', (offset.top-60)+'px');\r\n\t\tjQuery('.leaflet-routing-container').css('left', (offset.left + 35)+'px');\r\n\t\tjQuery('.leaflet-routing-container').css('position','absolute');\r\n\t\tjQuery('.leaflet-routing-container').css('z-index','100');\r\n\t\t\r\n\t},\r\n\r\n\thide: function() {\r\n\t\tvar self = this,\r\n\t\t_map = self._map,\r\n\t\t_route = self._route;\r\n\t\t\r\n\t\t\r\n\t\tL.DomUtil.removeClass(self._div, 'greenfort');\r\n\t\tL.DomUtil.addClass(self._div, 'grisfort');\r\n\t\tconsole.debug(\"AQUI\");\r\n\t\ttry{\r\n\t\t\t_route.removeFrom.call(_route,_map);\r\n\t\t}catch(e){\r\n\t\t\tconsole.debug(e);\r\n\t\t}finally{\r\n\t\t\t_map.off('click',self._routingPopup, self);\r\n\t\t}\r\n\t\t\r\n\t},\r\n\t\r\n\t_toggle: function(e){\r\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\r\n\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t}, \r\n\t\r\n\t_routingPopup: function(e) {\r\n\t\tconsole.debug(\"routing\");\r\n\t\tvar options = this.options,\r\n\t\t_texts = options.texts;\r\n\t\t\r\n\t\tif(window.lang){\r\n\t\t\t_texts.title = window.lang.translate(options.originTexts.title);\r\n\t\t\t_texts.btnStart = window.lang.translate(options.originTexts.btnStart);\r\n\t\t\t_texts.btnEnd = window.lang.translate(options.originTexts.btnEnd);\r\n\t\t}\r\n\t\t\r\n\t\tvar container ='<div id=\"contentRoutingPopup\" class=\"contentRoutingPopup\">';\r\n\t\tcontainer +='<h4 style=\"border-bottom:0px;\" lang=\"ca\">'+_texts.title+'</h4>';\r\n\t\tcontainer +='<button class=\"btn startBtn\" lang=\"ca\" type=\"button\" id=\"startBtn\">'+_texts.btnStart+'</button>'+\r\n\t\t  \t'<span class=\"awesome-marker-icon-green awesome-marker leaflet-zoom-hide leaflet-clickable leaflet-marker-draggable icona icona-origen\" id=\"icona-origen\"></span>'+\r\n\t\t   \t'<button class=\"btn endBtn\" lang=\"ca\" type=\"button\" id=\"destBtn\">'+_texts.btnEnd+'</button>'+\r\n\t\t   \t'<span class=\"awesome-marker-icon-red awesome-marker leaflet-zoom-hide leaflet-clickable leaflet-marker-draggable icona icona-desti\" id=\"icona-desti\"></span>';\r\n\t\tcontainer += \"</div>\";\r\n\t\t\r\n\t\tvar _map = this._map,\r\n\t\t\t_route = this._route;\r\n\t\t\r\n\t\tL.popup().setContent(container).setLatLng(e.latlng).openOn(_map);\r\n\r\n\t\tjQuery(\".leaflet-popup-content\").css('width','184px');\r\n\t\tjQuery(\".leaflet-popup-content\").css('margin','5px 15px');\r\n\r\n\t    jQuery('#startBtn').on('click', function() {\r\n\t    \t_route.spliceWaypoints(0, 1, e.latlng);\r\n\t    \t_map.closePopup();\r\n\t    });\r\n\r\n\t    jQuery('#destBtn').on('click', function() {\r\n\t    \t_route.spliceWaypoints(_route.getWaypoints().length - 1, 1, e.latlng);\r\n\t        _map.closePopup();\r\n\t    });\r\n\r\n\t    jQuery('#icona-origen').on('click', function() {\r\n\t    \t_route.spliceWaypoints(0, 1, e.latlng);\r\n\t    \t_map.closePopup();\r\n\t    });\r\n\r\n\t    jQuery('#icona-desti').on('click', function() {\r\n\t    \t_route.spliceWaypoints(_route.getWaypoints().length - 1, 1, e.latlng);\r\n\t        _map.closePopup();\r\n\t    });\r\n\r\n\t}, \r\n\t\r\n\t_createButton: function(label, container, title, lang) {\r\n\t    var btn = L.DomUtil.create('button', '', container);\r\n\t    btn.setAttribute('type', 'button');\r\n\t    btn.setAttribute('lang', lang);\r\n\t    btn.setAttribute('title', title);\r\n\t    btn.innerHTML = label;\r\n\t    return btn;\r\n\t},\r\n\r\n\t_createSpan: function(label, container) {\r\n\t    var span = L.DomUtil.create('span', '', container);\r\n\t    span.innerHTML = label;\r\n\t    return span;\r\n\t}\r\n});\r\n\r\nL.control.routingControl = function(options){\r\n\treturn new L.Control.RoutingControl(options);\r\n};","/**\r\n * L.Control.SearchControl control que permite hacer busquedas con caja única \r\n */\r\nL.Control.SearchControl = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tid: 'dv_bt_Find',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\r\n\t\ttitle: 'Cercar',\r\n\t\tlangTitle: 'Cercar',\r\n\t\thtml: '<span id=\"span_bt_Find\" class=\"fa fa-search\"></span>',\r\n\t\tidInputText: 'ctr_cerca',\r\n\t\tinputplaceholderText: 'Cercar llocs al món o coordenades  ...',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\t\r\n\tinitialize: function(options){\r\n\t\tL.setOptions(this, options);\r\n\t\t\r\n\t\tvar self = this,\r\n\t\toptions = this.options,\r\n\t\tinputText = L.DomUtil.create('div', options.idInputText);\r\n\t\t\r\n\t\tinputText.id = options.idInputText;\r\n\t\tjQuery('#searchBar').addClass(\"input-group\").append(inputText);\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\toptions = self.options,\r\n\t\tstop = L.DomEvent.stopPropagation,\r\n\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\t//agregar el boton\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\t\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\r\n\t\t\t.on(container, 'click', self._toggle, self);\r\n\t\t\r\n\t\t//agregar el control\r\n\t\t//TODO extender el control de origen en lugar de modificarlo\r\n\t\tself.control = new L.Control.Search({url: options.searchUrl,\r\n\t\t\tposition:'topcenter',\r\n\t\t\tfilterJSON: self._filterJSON,\r\n\t\t\tanimateLocation: false,\r\n\t\t\tmarkerLocation: false,\r\n\t\t\tzoom: 12,\r\n\t\t\tminLength: 3,\r\n\t\t\tautoType: false,\r\n\t\t\ttext:options.inputplaceholderText,\r\n\t\t\tidInputText : '#'+options.idInputText,\r\n\t\t\tzoom : 14,\r\n\t\t\ttextSize : 22,\r\n\t\t\tautoCollapseTime: 3200\r\n\t\t}).addTo(map);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\t_filterJSON: function(rawjson){\r\n\t\tvar self = this,\r\n\t\tjsonData = JSON.parse(rawjson.resposta),\r\n\t\tjson = {},\r\n\t\tkey, \r\n\t\tloc, \r\n\t\tdisp = [];\r\n\t\t\r\n\t\tif (jsonData.resultats.length>1){\r\n\t\t\tfor (var i = 0; i < jsonData.resultats.length; i++) {\r\n\t\t\t    var resultat = jsonData.resultats[i];\r\n\t\t\t    var coordsSplit = resultat.coordenades.split(\",\");\r\n\t\t\t    json[ resultat.nom ] = L.latLng(coordsSplit[0], coordsSplit[1]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif (jsonData.resultats.length>0){\r\n\t\t\t\tvar coords= jsonData.resultats[0].coordenades;\r\n\t\t\t\tvar nom = jsonData.resultats[0].nom;\r\n\t\t\t\tvar coordsSplit = [];\r\n\t\t\t\tif (coords) {\r\n\t\t\t\t\tcoordsSplit = coords.split(\",\");\r\n\t\t\t\t\tloc = L.latLng(coordsSplit[0], coordsSplit[1] );\r\n\t\t\t\t\tconsole.debug(self);\r\n\t\t\t\t\tself.showLocation(loc,coords,nom); \r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\t\r\n\t\t\tself.showAlert(window.lang.translate(\"No trobat\"));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn json;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\thide: function() {\r\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\r\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\r\n\t\t$('#searchBar').hide();\r\n\t},\r\n\t\r\n\tshow: function(e){\r\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\r\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\r\n\t\tvar offset = $(this._div).offset();\r\n\t\t$('#searchBar').css('top', (offset.top - 15) +'px');\r\n\t\t$('#searchBar').css('left', (offset.left + 35) +'px');\r\n\t\t$('#searchBar').show();\r\n\t}, \r\n\t\r\n\t_toggle: function(e){\r\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\r\n\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t\t$.publish('analyticsEvent',{event:['visor','button#cercaTopo','label cercaTopo', 6]});\r\n\t},\r\n});\r\n\r\nL.control.searchControl = function(options){\r\n\treturn new L.Control.SearchControl(options);\r\n};","/**\r\n * L.Control.Snapshot control que permite obtener una captura de pantalla del mapa\r\n * \r\n * require: geocat.mapa.canvas\r\n */\r\nL.Control.Snapshot = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_captura',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_captura',\r\n\t\ttitle: 'Capturar la vista del mapa',\r\n\t\tlangTitle: 'Capturar la vista del mapa',\r\n\t\thtml: '<span class=\"glyphicon glyphicon-camera grisfort\"></span>',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._captureMap, self);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tmap.off('mapsnapshot', this._map, this);\r\n\t},\r\n\t\r\n\t_captureMap: function(e){\r\n\t\tvar _map = this._map;\r\n\t\t_map.fire('mapsnapshot'); //to track ga events\r\n\t\t//TODO crear el modulo de captura\r\n\t\tcapturaPantalla(CAPTURA_MAPA);  //geocat.mapa.canvas\r\n\t}\r\n});\r\n\r\nL.control.snapshot = function(options){\r\n\treturn new L.Control.Snapshot(options);\r\n};","/**\r\n * L.Control.Like control que permite sumar/restar uno a los like de los mapas\r\n */\r\nL.Control.Like = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tid: 'dv_bt_likeMap',\r\n\t\tclassName: 'leaflet-bar  btn btn-default btn-sm',\r\n\t\ttitle: 'Vista inicial',\r\n\t\tlangTitle: 'Vista inicial',\r\n\t\thtml: '<span id=\"span_bt_likeMap\" class=\"fa fa-heart-o grisfort\"></span>',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\t\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\r\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._like, self);\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tvar self = this;\r\n\t\tmap.off('loadconfig', self._updateMapConfig, self);\r\n\t\tmap.off('visorconfig', self._updateMapConfig, self);\r\n\t},\r\n\t\r\n\t_like: function(e){\r\n\t\tvar self = this;\r\n\t\t\r\n\t\t_mapConfig = self.options.mapConfig;\r\n\t\t\r\n\t\tvar data = {\r\n\t\t\tbusinessId: _mapConfig.businessId\r\n\t\t};\r\n\t\t\r\n\t\tif(self._isLiked()){\r\n\t\t\tdata.rank = -1;\r\n\t\t\tself._unLiked();\r\n\t\t}else{\r\n\t\t\tdata.rank = 1;\r\n\t\t\tself._liked();\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tself._updateRankAplicacio(data).then(function(results){\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\tvar btnSpan = $(self._div).find('span');\r\n\t\t\t\tbtnSpan.tooltip({\r\n\t\t\t\t\tplacement: 'right',\r\n\t\t\t        title: results.results,\r\n\t\t\t        \r\n\t\t\t    }).tooltip('show');\r\n\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\tbtnSpan.tooltip('destroy');\r\n\t\t\t    }, 800);\r\n\t\t\t\t\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#like','label like']});\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\t\r\n\t_updateRankAplicacio: function(params){\r\n\t\treturn $.ajax({\r\n\t\t\turl: paramUrl.updateRankAplicacio, //geocat.config-1.0.0\r\n\t  \t\tdata: params,\r\n\t  \t\tmethod: 'post',\r\n\t  \t\tdataType: 'jsonp'\r\n\t\t}).promise();\r\n\t},\r\n\t\r\n\t_isLiked: function(){\r\n\t\tvar self = this,\r\n\t\tliked = false;\r\n\t\t\r\n\t\tvar btnSpan = $(self._div).find('span');\r\n\t\t\r\n\t\tif($(btnSpan).hasClass('fa-heart-o')){\r\n\t\t\tliked = false;\r\n\t\t}else if($(btnSpan).hasClass('fa-heart')){\r\n\t\t\tliked = true;\r\n\t\t} \r\n\t\treturn liked;\r\n\t},\r\n\t\r\n\t_liked: function(){\r\n\t\tvar self = this;\r\n\t\tvar btnSpan = $(self._div).find('span');\r\n\t\t$(btnSpan).removeClass('fa-heart-o').addClass('fa-heart');\r\n\t},\r\n\t\r\n\t_unLiked: function(){\r\n\t\tvar self = this;\r\n\t\tvar btnSpan = $(self._div).find('span');\r\n\t\t$(btnSpan).removeClass('fa-heart').addClass('fa-heart-o');\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\t_updateMapConfig: function(config){\r\n\t\tthis.options.mapConfig = config;\r\n\t}\r\n});\r\n\r\nL.control.like = function(options){\r\n\treturn new L.Control.Like(options);\r\n};","/**\r\n * L.Control.Printmap control que permite obtener una impresion del mapa\r\n * \r\n * require: geocat.mapa.canvas\r\n */\r\nL.Control.Printmap = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_captura',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_print',\r\n\t\ttitle: 'Imprimir la vista del mapa',\r\n\t\tlangTitle: 'Imprimir la vista del mapa',\r\n\t\thtml: '<span class=\"glyphicon glyphicon-print grisfort\"></span>',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._printMap, self);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tmap.off('mapprint', this._map, this);\r\n\t},\r\n\t\r\n\t_printMap: function(e){\r\n\t\tvar _map = this._map;\r\n\t\t_map.fire('mapprint'); //to track ga events\r\n\t\t//TODO crear el modulo de captura\r\n\t\tcapturaPantalla(CAPTURA_INFORME);  //geocat.mapa.canvas\r\n\t}\r\n});\r\n\r\nL.control.printmap = function(options){\r\n\treturn new L.Control.Printmap(options);\r\n};\r\n","/**\r\n * L.Control.Geopdf control que permite obtener un geopdf del mapa\r\n * \r\n * require: geocat.mapa.canvas\r\n */\r\nL.Control.Geopdf = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_geopdf',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_geopdf',\r\n\t\ttitle: 'Descarrega mapa en format GeoPDF',\r\n\t\tlangTitle: 'Descarrega mapa en format GeoPDF',\r\n\t\thtml: '<span class=\"fa fa-file-pdf-o geopdf\"></span>',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._geoPdfMap, self);\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tmap.off('mapgeopdf', this._map, this);\r\n\t},\r\n\t\r\n\t_geoPdfMap: function(e){\r\n\t\tvar _map = this._map;\r\n\t\t_map.fire('mapgeopdf'); //to track ga events\r\n\t\t//TODO crear el modulo de captura\r\n\t\tcapturaPantalla(CAPTURA_GEOPDF);  //geocat.mapa.canvas\r\n\t}\r\n});\r\n\r\nL.control.geopdf = function(options){\r\n\treturn new L.Control.Geopdf(options);\r\n};\r\n","/**\r\n * L.Control.Control3D control que permite cambiar entre la vista 2d y 3d del mapa.\r\n * \r\n * requiere: instamaps.mapa.3D\r\n */\r\nL.Control.Control3D = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_3d_2d',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_3D_2D',\r\n\t\ttitle: 'Canviar vista',\r\n\t\tlangTitle: 'Canviar vista',\r\n\t\thtml: '<span class=\"text3D\">3D</span>',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._toggleView, self);\r\n\t\t\r\n\t\tmap.on('loadconfig', self._addModul3D, self);\r\n\t\tmap.on('visorconfig', self._addModul3D, self);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tvar self = this;\r\n\t\tmap.off('map3dmode', self._map, self);\r\n\t\tmap.off('loadconfig', self._addModul3D, self);\r\n\t\tmap.off('visorconfig', self._addModul3D, self);\r\n\t},\r\n\t\r\n\t_toggleView: function(e){\r\n\t\tvar _map = this._map;\r\n\t\t_map.fire('map3dmode'); //to track ga events\r\n\t\t//TODO crear el modulo\r\n\t\t//activaVista3d_2d(this._div) //instamaps.mapa.3D\r\n\t},\r\n\t\r\n\t_addModul3D: function(config){\r\n\t\t//TODO crear el control del modulo de 3D\r\n\t\taddModul3D(config);\r\n\t}\r\n});\r\n\r\nL.control.control3d = function(options){\r\n\treturn new L.Control.Control3D(options);\r\n};","/**\r\n * L.Control.LegendBtn\r\n */\r\nL.Control.LegendBtn = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'bottomright',\r\n\t\tid: 'mapLegend',\r\n\t\tclassName: 'info legend visor-legend mCustomScrollbar',\r\n\t\ttitle: 'Llegenda',\r\n\t\tlangTitle: 'Llegenda',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\r\n\t\t\t.on(container, 'click', self._toggle, self);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\thide: function() {\r\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\r\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\r\n\t\tthis.options.control.hide();\r\n\t},\r\n\t\r\n\tshow: function(e){\r\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\r\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\r\n\t\tthis.options.control.show();\r\n\t},\r\n\t\r\n\t_toggle: function(e){\r\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\r\n\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t}\r\n\t\r\n});\r\n\r\nL.control.legenbtn = function(options){\r\n\treturn new L.Control.LegendBtn(options);\r\n};","/**\r\n * L.Control.Legend control que crea el boton de la legenda y agrega la legenda al mapa\r\n * \r\n * require /geocatweb/js/leaflet/L.IM_LegendDivControl.js\r\n * require /geocatonline/llibreries/js/jquery/plugins/jquery.transit.js\r\n */\r\nL.Control.Legend = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'bottomright',\r\n\t\tidBtn: 'dv_bt_legend',\r\n\t\tclassNameBtn: 'leaflet-bar btn btn-default btn-sm bt_legend grisfort',\r\n\t\ttitle: 'Llegenda',\r\n\t\thtml: '<span class=\"fa fa-list-alt\"></span>',\r\n\t\tid: 'mapLegend',\r\n\t\tclassName: 'info legend visor-legend ',\r\n\t\ttipusllegenda: 'dinamica',\r\n\t\tllegendaOpt: 'tancada',\r\n\t\ttransition: true\r\n\t},\r\n\t\r\n\tinitialize: function(options){\r\n\t\tL.setOptions(this, options);\r\n\t\r\n\t\tvar self = this,\r\n\t\toptions = self.options;\r\n\t\t\r\n\t\tself.button = L.control.legenbtn({\r\n\t\t\tposition: options.position,\r\n\t\t\tid: options.idBtn,\r\n\t\t\tclassName: options.classNameBtn,\r\n\t\t\thtml: options.html,\r\n\t\t\ttitle: options.title,\r\n\t\t\tcontrol: self\r\n\t\t}).addTo(map);\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tmap.on('loadconfig', self._updateLegend, self);\r\n\t\tmap.on('visorconfig', self._updateLegend, self);\t\t\t\t\r\n\t\tmap.on('activaLegendTab', self._updateTabLegend, self);\r\n\t\tmap.on('onRedrawLegend', self._redraw, self);\r\n\t\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault);\r\n\t\t\r\n\t\tself.hide();\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tvar self = this;\r\n\t\tmap.off('loadconfig', self._updateLegend, self);\r\n\t\tmap.off('visorconfig', self._updateLegend, self);\t\t\t\t\r\n\t\tmap.off('activaLegendTab', self._updateTabLegend, self);\r\n\t\tmap.off('onRedrawLegend', self._redraw, self);\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\tself.button.hideBtn();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\tself.button.showBtn();\r\n\t},\r\n\t\r\n\thide: function() {\r\n\t\tvar _$this = $(this._div),\r\n\t\ty2 = _$this.height() +50;\r\n\t\tif(this.options.transition){\r\n\t\t\t//_$this.fadeOut({duration: 'fast'});\r\n\t\t\t_$this.hide();\r\n\t\t}else{\r\n\t\t\t_$this.hide();\r\n\t\t}\r\n\t\tthis._redrawTabs();\r\n\t},\r\n\t\r\n\tshow: function(e){\r\n\t\tvar self = this;\r\n\t\tvar _$this = $(self._div);\r\n\t\t_$this.show();\r\n\t\tif(self.options.transition){\r\n\t\t\t_$this.fadeIn({duration: 'fast'});\r\n\t\t}\r\n\t\tself._redrawTabs();\r\n\t\t$.publish('analyticsEvent',{event:['visor','button#llegenda','label llegenda', 4]});\r\n\t},\r\n\t\r\n\t_updateLegend: function(config){\r\n\t\tvar self = this;\r\n\t\tself.servidorsWMS=config.servidorsWMS;\t\t\r\n\t\tself.legend = (config.legend? $.parseJSON( config.legend):\"\");\t\t\r\n\t\t\r\n\t\tself._draw();\r\n\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\r\n\t},\r\n\t\t\r\n\t_redraw: function(config){\r\n\t\tvar self = this;\r\n\t\t//this.servidorsWMS=config.servidorsWMS;\t\t\t\t\t\t\r\n\t\tif(self.options && self.options.origenllegenda==\"mapa\"){\r\n\t\t\tself.legend=generallegendaMapaEdicio();\r\n\t\t}else{\r\n\t\t\tself.legend = (config.legend? $.parseJSON( config.legend):\"\");\t\t\t\r\n\t\t}\t\t\t\t\r\n\t\t$(self._div).html('');\t\r\n\t\tself._draw();\r\n\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\r\n\t},\r\n\t\r\n\t_redrawTabs: function(){\r\n\t\tvar self = this;\r\n\t\tif(!$('#nav_legend li:first-child').hasClass('dropdown') || $(\"#nav_legend li\").length > 1){\r\n\t\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\r\n\t\t}\r\n\t},\r\n\t\r\n\t_updateTabLegend:function(obje){\r\n\t\t\r\n\t\tvar self = this;\r\n\t\tself.fromLayer = true;\r\n\t\tif(obje.activo){\r\n\t\t\t$('#nav_legend a[href=\"#tab'+obje.id+'\"]').tab('show');\t\r\n\t\t}else{\t\t\t\r\n\t\t\tvar lastActive=controlCapes.getCountActiveLayers();\t\r\n\t\t\tlastActive.total >0?$('#nav_legend a[href=\"#tab'+lastActive.lastActive+'\"]').tab('show'):$('#nav_legend a[href=\"#tab'+obje.id+'\"]').tab('show');\t\t\t\t\t\t\t\t\t\t\r\n\t\t}\r\n\t},\t\r\n\t\r\n\t_getLastActived:function(){\t\r\n\t\tvar self = this,\r\n\t\tmapLegend = self.legend;\r\n\t\tvar lastPos={indexPos:0};\r\n\t\tvar indexPos=0;\t\t\t\r\n\t\tvar k=0;\r\n\t\t\r\n\t\ttry{\r\n\t\tjQuery.each(self.servidorsWMS, function(j, row){\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (self.servidorsWMS[j].capesActiva==\"true\"){\r\n\t\t\t\tk=0;\r\n\t\t\t\tjQuery.each(mapLegend, function(index, row){\r\n\t\t\t\t\tk++;\r\n\t\t\t\t\tfor (var i = 0; i < row.length; i++) {\t\t\t\t\t\t\t\r\n\t\t\t    \t\tif(row[i].chck){\r\n\t\t\t    \t\t\tif (self.servidorsWMS[j].businessId==index){\t\t\t\t    \t\t\t\t\r\n\t\t\t    \t\t\t\tlastPos.indexPos=k-1;\r\n\t\t\t    \t\t\t}\r\n\t\t\t    \t\t}\r\n\t\t\t    \t}\r\n\t\t\t\t});\r\n\t\t\t}\t\t\t\r\n\t\t});\t\t\t\t\r\n\t\t\r\n\t\tif(lastPos.indexPos==-1){lastPos.indexPos=0}\r\n\t\t\treturn lastPos;\t\t\r\n\t\t}catch(Err){\r\n\t\t\treturn lastPos;\r\n\t\t}\t\r\n\t\t\r\n\t},\r\n\t\r\n\t_draw: function(){\r\n\t\tvar self = this,\r\n\t\tmapLegend = self.legend,\r\n\t\tdiv = self._div;\r\n\t\tif (self._checkEmptyMapLegend()){\r\n\t\t\tvar legendhtml = [];\r\n\t\t\tif (self.options.tipusllegenda && self.options.tipusllegenda==\"estatica\"){\r\n\t\t\t\tjQuery.each(mapLegend, function(i, row){\r\n\t\t\t\t\tvar layerType=self._getNameLayer(i);\r\n\t\t\t\t\tvar serverName=\"\";\r\n\t\t\t\t\tfor (var k = 0; k < row.length; k++) {\r\n\t\t\t\t\t\tif (row[k].chck) {\r\n\t\t\t\t\t\t\tserverName=layerType.serverName;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (row.length>=1 && undefined!=serverName && \"\"!=serverName){\r\n\t\t\t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\r\n\t\t\t    \t\t\t'<div class=\"visor-legend-name\">'+layerType.serverName+'</div>'+\r\n\t\t\t    \t\t\t'</div>'+\r\n\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (row.length>=1 && \"\"!=row[0].name) {\r\n\t\t\t\t\t\tvar name=row[0].name;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\r\n\t\t\t\t    \t\t\t'<div class=\"visor-legend-name\">'+name.substring(0,name.indexOf(\"(\"))+'</div>'+\r\n\t\t\t\t    \t\t\t'</div>'+\r\n\t\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (var i = 0; i < row.length; i++) {\r\n\t\t\t    \t\tif(row[i].chck){\r\n\t\t\t    \t\t\tif (row[i].symbol.indexOf(\"circle\")>-1){\r\n\t\t\t    \t\t\t\tvar padding_left=\"0px\";\r\n\t\t\t    \t\t\t\tvar midaStr = row[i].symbol.substring(row[i].symbol.indexOf(\"r=\"),row[i].symbol.indexOf(\"style\"));\r\n\t\t\t    \t\t\t\tmidaStr=midaStr.substring(midaStr.indexOf(\"=\")+2,midaStr.length-2);\r\n\t\t\t    \t\t\t\tvar mida=parseFloat(midaStr);\r\n\t\t\t    \t\t\t\tif (mida>0 && mida<=6) padding_left=\"15px\";\r\n\t\t\t    \t\t\t\telse if (mida>6 && mida<=14) padding_left=\"10px\";\r\n\t\t\t    \t\t\t\telse if (mida>14 && mida<=22) padding_left=\"5px\";\r\n\t\t\t    \t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\r\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\" style=\"padding-left:'+padding_left+'\">'+row[i].symbol+'</div>'+\r\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"float:right;width:40%\">'+row[i].name+'</div>'+\r\n\t\t\t\t\t    \t\t\t'</div>'+\r\n\t\t\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\r\n\t\t\t    \t\t\t} else{\r\n\t\t\t    \t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\r\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\">'+row[i].symbol+'</div>'+\r\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"float:right;\">'+row[i].name+'</div>'+\r\n\t\t\t\t\t\t\t\t\t'</div>'+\r\n\t\t\t\t\t\t\t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\r\n\t\t\t    \t\t\t}\t    \t\t\t\r\n\t\t\t    \t\t}\r\n\t\t\t    \t}\r\n\t\t\t    });\r\n\t\t\t\t$(div).append(legendhtml);\r\n\t\t\t\t$(div).mCustomScrollbar();\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tvar legendTab=[];\r\n\t\t\t\tvar legendCont=[];\r\n\t\t\t\tvar legendTabContent=[];\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tlegendCont.push('<div id=\"legend_cont\">');\r\n\t\t\t\tlegendTab.push('<div id=\"legend_cont\"><ul id=\"nav_legend\" class=\"nav nav-tabs\">');\r\n\t\t\t\tlegendTabContent.push('<div class=\"legendTabCont tab-content\">');\r\n\t\t\t\t\r\n\t\t\t\tvar index=0;\r\n\t\t\t\t\r\n\t\t\t\tvar lastPos=self._getLastActived();\r\n\t\t\t\t\r\n\t\t\t\tjQuery.each(mapLegend, function(j, row){\r\n\t\t\t\tvar layerType=self._getNameLayer(j);\r\n\t\t\t\tindex==lastPos.indexPos?active=' active':active=\"\";\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tif(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\r\n\t\t\t\t\tlegendTabContent.push('<div style=\"padding-top:10px;\" class=\"dv_lleg tab-pane'+active+'\" id=\"tab'+j+'\">');\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tvar serverName=\"\";\r\n\t\t\t\tvar posServerName=-1;\r\n\t\t\t\tfor (var i = 0; i < row.length; i++) {\r\n\t\t\t\t\tif(row[i].chck || self.options.origenllegenda=='mapa'){\r\n\t\t\t\t\t\tif ((undefined==serverName && \"\"==serverName) || (undefined!=layerType.serverName && layerType.serverName!=serverName)) {\r\n\t\t\t\t\t\t\tposServerName=i;\r\n\t\t\t\t\t\t\tserverName=layerType.serverName;\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tposServerName=i;\r\n\t\t\t\t\t\t\tvar name=row[i].name;\r\n\t\t\t\t\t\t\tserverName=name.substring(0,name.indexOf(\"(\"));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar padding_left=\"\";\r\n\t\t\t\t\t\tvar textalg='left';\r\n\t\t\t\t\t\tif (row[i].symbol.indexOf(\"circle\")>-1){\r\n\t\t\t\t\t\t\tpadding_left=\"padding-left:0px\";\r\n\t\t\t\t\t\t\ttextalg='center';\r\n\t\t\t\t    \t\tvar midaStr = row[i].symbol.substring(row[i].symbol.indexOf(\"r=\"),row[i].symbol.indexOf(\"style\"));\r\n\t\t\t\t    \t\tmidaStr=midaStr.substring(midaStr.indexOf(\"=\")+2,midaStr.length-2);\r\n\t\t\t\t    \t\tvar mida=parseFloat(midaStr);\r\n\t\t\t\t    \t\tif (mida>0 && mida<=6) padding_left=\"padding-left:15px\";\r\n\t\t\t\t    \t\telse if (mida>6 && mida<=14) padding_left=\"padding-left:10px\";\r\n\t\t\t\t    \t\telse if (mida>14 && mida<=22) padding_left=\"padding-left:5px\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar isWMS=false;\r\n\t\t\t\t\t\tif (row[i].symbol.indexOf(\"GetLegendGraphic\")>-1){\r\n\t\t\t\t\t\t\tisWMS=true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tindex==lastPos.indexPos?active=' active':active=\"\";\r\n\t\t\t\t\t\tindex==lastPos.indexPos?self.options.currentTab=j:null;\t\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tif(i==posServerName){legendTab.push('<li class=\"'+active+'\"><a href=\"#tab'+j+'\" data-toggle=\"tab\">'+shortString(serverName,25)+'</a></li>');}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*if(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\r\n\t\t\t\t\t\t\tlegendTabContent.push(row[i].symbol);\r\n\t\t\t\t\t\t\tlegendTabContent.push('<br/>');\r\n\t\t\t\t\t\t}else{*/\r\n\t\t\t\t\t\t\tif(i==posServerName){legendTabContent.push('<div  class=\"dv_lleg tab-pane'+active+'\" id=\"tab'+j+'\">');}\r\n\t\t\t\t\t\t\tlegendTabContent.push('<div class=\"visor-legend-row\">'+\r\n\t\t\t\t\t\t    \t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\" style=\"padding-top:1px;'+padding_left+'\">'+row[i].symbol+'</div>');\r\n\t\t\t\t\t\t\tif (isWMS){\r\n\t\t\t\t\t\t\t\tlegendTabContent.push('</div><div class=\"visor-separate-legend-row\"></div>');\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tlegendTabContent.push('<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"text-align:'+textalg+' ;padding-top:5px;\">'+row[i].name+'</div>'+\r\n\t\t\t\t\t\t    \t'</div><div class=\"visor-separate-legend-row\"></div>');\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(i==row.length-1){legendTabContent.push('</div>');}\t\t\t\r\n\t\t\t\t\t\t//}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tindex=index+1;\r\n\t\t\t\tif(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\r\n\t\t\t\t\tlegendTabContent.push('</div>');\r\n\t\t\t\t}\r\n\t\t\t    });\r\n\t\t\t\t\r\n\t\t\t\tlegendTab.push('</ul>');\r\n\t\t\t\tlegendTabContent.push('</div></div>');\r\n\t\t\t\t\r\n\t\t\t\t$(div).append(legendTab.join(\"\"));\r\n\t\t\t\t$(div).append(legendTabContent.join(\"\"));\r\n\t\t\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\r\n\t\t\t\r\n\t\t\t\t$(\"#nav_legend\").on('click', function(event){ //enables click event\r\n\t\t\t\t\t$(\"#nav_legend .dropdown-menu\").toggle();\t\t\t\r\n\t\t\t\t});\r\n\t\t\t\t$(\"#nav_legend .dropdown-menu a\").on('click', function(event){\r\n\t\t\t\t\tvar href = $(location).attr('href');\r\n\t\t\t\t\thref=href.substring(0,href.indexOf(\"#\"));\r\n\t\t\t\t    var objecthref=event.target.href;\r\n\t\t\t\t    objecthref= objecthref.replace(href+'#tab',\"\");\r\n\t\t\t\t    $('#nav_legend a[href=\"#tab'+objecthref+'\"]').tab('show');\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\t$(div).on('click', function(e){\t\t\t\r\n\t\t\t\t\tchangeWMSQueryable(false);\r\n\t\t\t\t});\t\r\n\t\t\t\t \r\n\t\t\t\t$(div).on('mouseout', function(e){\t\t\t\t\r\n\t\t\t\t\tchangeWMSQueryable(true);\r\n\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t$('.dv_lleg').on('click', function(e){\t\t\t\r\n\t\t\t\t\taturaClick(e);\r\n\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t$('.legendTabCont').on('click', function(e){\t\t\t\r\n\t\t\t\t\taturaClick(e);\r\n\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t$('.legendTabCont').on('mousedown', function(e){\t\t\t\r\n\t\t\t\t\taturaClick(e);\r\n\t\t\t\t});\t\r\n\t\t\t\r\n\t\t\t\t$(' #nav_legend a[data-toggle=\"tab\"]').on('shown.bs.tab', self._activaCapaTab.bind(self));\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\r\n\t_activaCapaTab: function(e){\r\n\t\tvar self = this;\r\n\t\tself._redrawTabs();\r\n\t\tif(!self.fromLayer){\r\n\t\t\tvar idLayer=$(e.target).attr('href').replace('#tab','');\r\n\t\t\t$( \"#input-\"+idLayer).attr(\"checked\")==undefined ? $(\"#input-\"+idLayer).click():null;\r\n\t\t}else{\r\n\t\t\tself.fromLayer = false;\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t},\r\n\t\r\n\t_getNameLayer:function(idLayer){\t\t\r\n\t\tvar self = this;\r\n\t\tservidorsWMS = self.servidorsWMS;\r\n\t\tvar layerType={};\r\n\t\tif(typeof servidorsWMS === \"string\" ){servidorsWMS = [servidorsWMS]};\r\n\t\t$.each(servidorsWMS, function(i, row){\t\t\t\r\n\t\t\t\tif(row.businessId==idLayer){\r\n\t\t\t\t\tlayerType.serverName=row.serverName.replace('##1','');\r\n\t\t\t\t\tlayerType.capesOrdre=row.capesOrdre;\r\n\r\n\t\t\t\t}\t\t\t\t\t\t\r\n\t\t});\t\r\n\r\n\tif(!layerType.serverName && getModeMapa()){\r\n\t\t\r\n\t\tlayerType=obteLListatCapesEditor(idLayer);\r\n\t}\t\r\n\t\t\r\n\t\t\r\n\t\treturn layerType;\t\t\r\n\t},\t\r\n\r\n\t_checkEmptyMapLegend: function(){\r\n\t\tvar trobat = false,\r\n\t\tself = this,\r\n\t\tmapLegend = self.legend;\r\n\t\tif(typeof mapLegend === \"string\" ){mapLegend = [mapLegend]};\r\n\t\t$.each(mapLegend, function(i, row){\r\n\t    \tfor (var i = 0; i < row.length && !trobat; i++) {\r\n\t    \t\tif(row[i].chck){\r\n\t    \t\t\ttrobat = true;\r\n\t    \t\t}\r\n\t    \t}\r\n\t\t});\r\n\t\treturn trobat;\r\n\t},\r\n});\r\n\r\nL.control.legend = function(options){\r\n\treturn new L.Control.Legend(options);\r\n};","/**\r\n * L.Control.LayersBtn control que agrega el control de capas\r\n * \r\n * require /geocatonline/geocatweb/js/leaflet/L.IM_ControlLayerManager.js\r\n * require /geocatonline/llibreries/js/jquery/plugins/jquery.transit.js\r\n */\r\nL.Control.LayersBtn = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_layers',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\r\n\t\ttitle: 'Llista de capes',\r\n\t\tlangTitle: 'Llista de capes',\r\n\t\thtml: '<span class=\"glyphicon glyphicon-th-list\"></span>',\r\n\t\ttransition: true,\r\n\t\tbutton: true,\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tcontainer,\r\n\t\t\tstop = L.DomEvent.stopPropagation;\r\n\t\t\r\n\t\tif(options.button){\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\tcontainer.id = options.id;\r\n\t\t\tcontainer.innerHTML = options.html;\r\n\t\t\tcontainer.title = options.title;\r\n\t\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t}else{\r\n\t\t\tcontainer = L.DomUtil.create('div', '');\r\n\t\t}\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\r\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\r\n\t\t\t.on(container, 'click', self._toggle, self);\r\n\t\t\r\n\t\tself.control = L.control.orderlayers(null, null, {\r\n\t\t\tcollapsed : false,\r\n\t\t\tid : 'div_capes',\r\n\t\t\teditMode: false,\r\n\t\t\tautoUpdate: false,\r\n\t\t\tmapConfig: self.options.mapConfig\r\n\t\t}).addTo(map);\r\n\t\t\r\n\t\tcontrolCapes = self.control;\r\n\r\n\t\tmap.on('addItemFinish',function(){\r\n\t\t\t$(\".layers-list\").mCustomScrollbar(\"destroy\");\r\n\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n\t\t\t   advanced:{\r\n\t\t\t     autoScrollOnFocus: false,\r\n\t\t\t     updateOnContentResize: true\r\n\t\t\t   }\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t\tself.hide();\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tvar self = this;\r\n\t\tmap.off('loadconfig', self._updateMapConfig, self);\r\n\t\tmap.off('visorconfig', self._updateMapConfig, self);\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t\tvar div = self.control.getContainer();\r\n\t\t$(div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t\tif(!self.control.options.collapsed){\r\n\t\t\tvar div = self.control.getContainer();\r\n\t\t\t$(div).show();\r\n\t\t\t\r\n\t\t}\r\n\t},\r\n\t\r\n\thide: function() {\r\n\t\tvar self = this;\r\n\t\tL.DomUtil.removeClass(self._div, 'greenfort');\r\n\t\tL.DomUtil.addClass(self._div, 'grisfort');\r\n\t\tvar div = self.control.getContainer();\r\n\t\tself.control.options.collapsed = true;\r\n\t\tif(self.options.transition){\r\n\t\t\t$(div).fadeOut({duration: 'fast'});\r\n\t\t}else{\r\n\t\t\t$(div).hide();\r\n\t\t}\r\n\t},\r\n\t\r\n\tshow: function(e){\r\n\t\tvar self = this;\r\n\t\tL.DomUtil.removeClass(self._div, 'grisfort');\r\n\t\tL.DomUtil.addClass(self._div, 'greenfort');\r\n\t\tvar div = self.control.getContainer();\r\n\t\tself.control.options.collapsed = false;\r\n\t\tif(self.options.transition){\r\n\t\t\t$(div).fadeIn({duration: 'fast'});\r\n\t\t}else{\r\n\t\t\t$(div).show();\r\n\t\t}\r\n\t\t$.publish('analyticsEvent',{event:['visor','button#llistaCapes','label llistaCapes', 3]});\r\n\t},\r\n\t\r\n\t_toggle: function(e){\r\n\t\tvar self = this;\r\n\t\tvar collapsed = L.DomUtil.hasClass(self._div, 'grisfort');\r\n\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t\t\r\n\t},\r\n\t\r\n\t_updateMapConfig: function(config){\r\n\t\tthis.options.mapConfig = config;\r\n\t}\r\n});\r\n\r\nL.control.layersBtn = function(options){\r\n\treturn new L.Control.LayersBtn(options);\r\n};","/**\r\n * L.Control.LocationControl control que hace lo mismo que el L.Control.Gps\r\n * \r\n * require L.Control.Gps\r\n */\r\nL.Control.LocationControl = L.Control.Gps.extend({\r\n\t\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tid: 'dv_bt_Location',\r\n\t\ttitle: 'Centrar mapa a la seva ubicació',\r\n\t\tlangTitle: 'Centrar mapa a la seva ubicació',\r\n\t\ttooltip: 'right'\r\n\t},\r\n\t\r\n\tinitialize: function(options){\r\n\t\tvar self = this,\r\n\t\t_options = self.options;\r\n\t\t\r\n\t\tif(options){\r\n\t\t\toptions = L.Util.extend({}, _options, options);\r\n\t\t}\r\n\t\tL.Util.setOptions(self, options);\r\n\t\tL.Control.Gps.prototype.initialize.call(self, options);\r\n\t},\r\n\t\r\n\tonAdd: function(map) {\r\n\t\tvar self = this,\r\n\t\toptions = self.options;\r\n\t\tvar container = L.Control.Gps.prototype.onAdd.call(self, map);\r\n\t\t\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._map\r\n\t\t\t.on('locationfound', this._publishFound, self)\r\n\t\t\t.on('locationerror', this._publishError, self);\r\n\t\t\r\n\t\tself._div = container;\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\t_publishFound:function(){\r\n\t\t$.publish('analyticsEvent',{event:['visor','input#GPS_OK','label GPS', 10]});\r\n\t},\t\r\n\t\r\n\t_publishError:function(){\r\n\t\t$.publish('analyticsEvent',{event:['visor','input#GPS_FAIL','label GPS', 10]});\r\n\t},\t\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n});\r\n\r\nL.control.locationControl = function(options){\r\n\treturn new L.Control.LocationControl(options);\r\n};","/**\r\n * L.Control.Escala hace lo mismo que el L.Control.Scale\r\n * \r\n * require L.Control.Scale\r\n */\r\nL.Control.Escala = L.Control.Scale.extend({\r\n\tonAdd: function(map) {\r\n\t\tvar self = this;\r\n\t\tvar container = L.Control.Scale.prototype.onAdd.call(self, map);\r\n\t\tself._div = container;\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t}\r\n});\r\n\r\nL.control.escala = function(options){\r\n\treturn new L.Control.Escala(options);\r\n};","/**\r\n * L.Control.Minimapa igual que el L.Control.MiniMap\r\n * \r\n * require L.Control.MiniMap\r\n */\r\nL.Control.Minimapa = L.Control.MiniMap.extend({\r\n\tonAdd: function(map) {\r\n\t\tvar self = this;\r\n\t\tvar container = L.Control.MiniMap.prototype.onAdd.call(self, map);\r\n\t\tself._div = container;\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t\t$.publish('analyticsEvent',{event:['visor','button#miniMapa','label miniMapa', 5]});\r\n\t}\r\n});\r\n\r\nL.control.minimapa = function(layer, options){\r\n\treturn new L.Control.Minimapa(layer, options);\r\n};\r\n","/**\r\n * L.Control.Logos control para crear logos.\r\n */\r\nL.Control.Logos = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'bottomleft',\r\n\t\tid: 'dv_logos',\r\n\t\tclassName: 'logos_footer',\r\n\t\tchildClassName: 'logo_footer'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\toptions = self.options,\r\n\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tif (L.DomEvent) {\r\n\t\t\tL.DomEvent.disableClickPropagation(container);\r\n\t\t}\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tself.addLogo({\r\n\t\t\tclassName: 'logo_icgc',\r\n\t\t\tid: 'logo_icgc',\r\n\t\t\ttitle: 'Institut Cartogràfic i Geològic de Catalunya',\r\n\t\t\turl: 'http://www.icgc.cat',\r\n\t\t\thtml: '<img height=\"45\" src=\"/llibreries/img/icgc.png\">'\r\n\t\t});\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\taddLogo: function(options){\r\n\t\tvar self = this,\r\n\t\tcontainer = self._div,\r\n\t\tclassName = self.options.childClassName;\r\n\t\t\r\n\t\tif(options.className){\r\n\t\t\tclassName += \" \" + options.className;\r\n\t\t}\r\n\t\t\r\n\t\tvar link = L.DomUtil.create('a', className, container);\r\n\t\tlink.id = options.id;\r\n\t\tlink.innerHTML = options.html;\r\n\t\tlink.href = options.url;\r\n\t\tlink.title = options.title;\r\n\t\tlink.target = \"_blank\";\r\n\t\t\t\t\r\n\t\treturn link;\r\n\t},\r\n\t\r\n\taddLogoHtml: function(html){\r\n\t\tvar self = this,\r\n\t\tcontainer = self._div;\r\n\t\tcontainer.insertAdjacentHTML('beforeend', html);\r\n\t},\r\n\t\r\n\tremoveLogo: function(options){\r\n\t\tvar self = this,\r\n\t\tcontainer = self._div;\r\n\t\tif(options.id){\r\n\t\t\tvar logo = L.DomUtil.get(options.id);\r\n\t\t\tcontainer.removeChild(logo);\r\n\t\t}\r\n\t\tif(options.className){\r\n\t\t\tvar elements = container.getElementsByClassName(options.className);\r\n\t\t\tfor(var i = 0, length = elements.length; i < length; i++){\r\n\t\t\t\tcontainer.removeChild(elements[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n});\r\n\r\nL.control.logos = function(options){\r\n\treturn new L.Control.Logos(options);\r\n};","/**\r\n * \r\n */\r\nL.Control.Widgets = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topright',\r\n\t\tid: 'dv_bt_widgets',\r\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_widgets',\r\n\t\ttitle: 'Ginys',\r\n\t\tlangTitle: 'Ginys',\r\n\t\thtml: '<span class=\"fa fa-cogs widgets\"></span>',\r\n\t\tmodalContainer: '#mapa_modals',\r\n\t\ttooltip: 'left'\r\n\t},\r\n\t\r\n\tonAdd: function(map){\r\n\t\tvar self = this,\r\n\t\t\toptions = self.options,\r\n\t\t\tstop = L.DomEvent.stopPropagation,\r\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\r\n\t\t\r\n\t\tcontainer.id = options.id;\r\n\t\tcontainer.innerHTML = options.html;\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\t\t\r\n\t\tself._div = container;\r\n\t\t\r\n\t\tL.DomEvent\r\n\t\t\t.on(container, 'click', stop)\r\n\t\t\t.on(container, 'mousedown', stop)\r\n\t\t\t.on(container, 'dblclick', stop)\r\n\t\t\t.on(container, 'click', self._showWidgets, self);\r\n\t\t\r\n\t\tself.widgets = {};\r\n\t\tself.subscriptions();\r\n\t\tself._addModalWidgets();\r\n\t\t\r\n\t\t//iniciar la lista de municipios\r\n\t\t$.publish('mapMoveend', map);\r\n\t\t\r\n\t\treturn container;\r\n\t},\r\n\t\r\n\thideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n\t\r\n\tonRemove: function (map) {\r\n\t\tmap.off('mapprint', this._map, this);\r\n\t\t\r\n\t\t//remove dialog\r\n\t\t$('.dialgo_widgets').remove();\r\n\t\t\r\n\t},\r\n\t\r\n\t_showWidgets: function(e){\r\n\t\tvar _map = this._map;\r\n\t\t\r\n\t\t$('.dialgo_widgets').modal('show');\r\n\t\t//TODO crear los eventos\r\n\t\t_map.fire('showwigets'); //to track ga events\r\n\t\t//TODO crear el modulo de captura\r\n\t\t//capturaPantalla(CAPTURA_INFORME);  //geocat.mapa.canvas\r\n\t}, \r\n\t\r\n\t_addModalWidgets: function(){\r\n\t\t\r\n\t\t\r\n    \tvar that = this;\r\n    \t$.get(\"templates/modalWidgets.html\",function(data){\r\n\t\t\t//TODO ver como pasar el modal container\r\n    \t\t$(that.options.modalContainer).append(data);\r\n    \t\tvar modalbody = $('.dialgo_widgets div.widgets-list');\r\n    \t\tvar selectdiv = $('.dialgo_widgets div.selectMunicipi');\r\n    \t\tvar listdiv = $('.dialgo_widgets div.listMunicipis');\t\t\t\r\n    \t\tthat._addSelectMunicipis(selectdiv);\r\n    \t\tthat._addListViewMunicipis(listdiv);\r\n    \t\tthat._addIdescatWidget(modalbody);\r\n    \t\tthat._addRPUCWidget(modalbody);\r\n    \t\tthat._addCartotecaWidget(modalbody);\r\n    \t\tthat._addMeteoWidget(modalbody);\r\n        \tthat._addCadastreWidget(modalbody);\r\n        \tthat._addInfoParcelaWidget(modalbody);\r\n\t\t\tthat._addMascaraWidget(selectdiv);\r\n        });\r\n    },\r\n    \r\n    _addSelectMunicipis: function(container){\r\n    \tvar select = SelectMunicipis.createSelect();\r\n    \tcontainer.append(select);\r\n    \t$(select).addClass(\"selectpicker\").selectpicker({liveSearch:true});\r\n\t\t\r\n    },\r\n    \r\n    _addListViewMunicipis: function(container){\r\n    \tvar _map = this._map;\r\n    \tListViewMunicipis.createList(container);\r\n    \t_map.on('moveend',function(e){\r\n      \t\t$.publish('mapMoveend', this);\r\n      \t});\r\n    },\r\n    \r\n\t\r\n    _addMeteoWidget: function(container){\r\n    \tthis.widgets.meteo = WidgetMeteo.getWidget();\r\n    \tWidgetMeteo.drawButton(container);\r\n    },\r\n    \r\n    _addIdescatWidget: function(container){\r\n    \tthis.widgets.idescat = WidgetIdescat.getWidget();\r\n    \tWidgetIdescat.drawButton(container);\r\n    \tWidgetIdescat.activate();\r\n    \t$('.widgets-list .widget-idescat').addClass(\"widget-button-active\");\r\n    },\r\n    \r\n    _addCadastreWidget: function(container){\r\n    \tthis.widgets.cadastre = WidgetCadastre.getWidget();\r\n    \tWidgetCadastre.drawButton(container);\r\n    },\r\n    \r\n    _addRPUCWidget: function(container){\r\n    \tthis.widgets.rpuc = WidgetRPUC.getWidget();\r\n    \tWidgetRPUC.drawButton(container);\r\n    },\r\n    \r\n    _addInfoParcelaWidget: function(container){\r\n    \tthis.widgets.rpuc = WidgetInfoparcela.getWidget();\r\n    \tWidgetInfoparcela.drawButton(container);\r\n    },\r\n\t\r\n\t\r\n\t _addMascaraWidget: function(container){\r\n    \tWidgetMascara.getWidget();\r\n    \tWidgetMascara.drawButton(container);\r\n    },\r\n\t\r\n\t\r\n\t\r\n\t\r\n    \r\n    _addCartotecaWidget: function(container){\r\n    \tthis.widgets.cartoteca = WidgetCartoteca.getWidget();\r\n    \tWidgetCartoteca.drawButton(container);\r\n    },\r\n    \r\n    deactivateWidgets: function(){\r\n    \tvar that = this;\r\n    \tfor(var widget in that.widgets){\r\n    \t\tthat.widgets[widget].deactivate();\r\n    \t}\r\n    \t$('.widgets-list .widget-button').removeClass(\"widget-button-active\");\r\n    },\r\n    \r\n    getWidgets: function(){\r\n    \tvar that = this;\r\n    \treturn that.widgets;\r\n    },\r\n    \r\n    subscriptions: function() {\r\n    \tvar that = this,\r\n    \t\t_map = this._map;\r\n    \t\r\n    \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n\t\t\t\r\n\t\t\r\n\t\t\t\r\n    \t\tthat.activeMunicipi = data;\r\n    \t\t//zoom al municipio\r\n    \t\tif(data && _map){\r\n    \t\t\tvar bbox = data.bbox.split(\",\");\r\n    \t\t\tvar southWest = L.latLng(bbox[1], bbox[0]),\r\n    \t\t    northEast = L.latLng(bbox[3], bbox[2]),\r\n    \t\t    bounds = L.latLngBounds(southWest, northEast);\r\n    \t\t\t_map.fitBounds(bounds)\r\n    \t\t}\r\n    \t});\r\n    \t\r\n    \t$.subscribe('widgetActivated',function(e, data){\r\n    \t\tthat.deactivateWidgets();\r\n    \t\tvar classWidget = $(data.target).attr('class').split(\" \")[1];\r\n    \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widgets', classWidget, 1]});\r\n    \t\t$(data.target).addClass(\"widget-button-active\");\r\n    \t\tdata.widget.activate();\r\n    \t\tif(that.activeMunicipi){\r\n\t\t\t\tconsole.info(that.activeMunicipi);\r\n    \t\t\tdata.widget.draw(that.activeMunicipi);\r\n    \t\t}\r\n    \t});\r\n    \t\r\n    }\r\n});\r\n\r\nL.control.widgets = function(options){\r\n\treturn new L.Control.Widgets(options);\r\n};","/**\r\n * \r\n */\r\nL.Control.MapExport = L.Control\r\n\t\t.extend({\r\n\t\t\toptions : {\r\n\t\t\t\tposition : 'topright',\r\n\t\t\t\tid : 'dv_bt_mapExport',\r\n\t\t\t\tclassName : 'leaflet-bar btn btn-default btn-sm bt_exportfile grisfort',\r\n\t\t\t\ttitle : 'Exportar i imprimir mapa',\r\n\t\t\t\tlangTitle : 'Exportar i imprimir mapa',\r\n\t\t\t\thtml : '<span class=\"glyphicon glyphicon-paste\"></span>',\r\n\t\t\t\ttooltip : 'bottom'\r\n\t\t\t},\r\n\r\n\t\t\tonAdd : function(map) {\r\n\t\t\t\tvar self = this, options = self.options, stop = L.DomEvent.stopPropagation, container = L.DomUtil\r\n\t\t\t\t\t\t.create('div', options.className);\r\n\r\n\t\t\t\tcontainer.id = options.id;\r\n\t\t\t\tcontainer.innerHTML = options.html;\r\n\t\t\t\tcontainer.title = options.title;\r\n\r\n\t\t\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\t\t\tcontainer.dataset.placement = window.lang.translate(options.tooltip);\r\n\t\t\t\tcontainer.dataset.langTitle = window.lang.translate(options.langTitle);\r\n\r\n\t\t\t\tself._div = container;\r\n\t\t\t\tself._map=map;\r\n\r\n\t\t\t\tvar _scope = 'visor';\r\n\t\t\t\tvar tipus_user = \"\";\r\n\t\t\t\tgetModeMapa() ? _scope = 'mapa' : _scope = 'visor';\r\n\r\n\t\t\t\tif (_scope == 'mapa') {\r\n\t\t\t\t\ttipus_user = defineTipusUser();\r\n\t\t\t\t}else{\r\n\t\t\t\t\ttipus_user =\"button#\";\r\n\t\t\t\t}\t\r\n\r\n\t\t\t\tthis._div_H_Export = L.DomUtil.create('div',\r\n\t\t\t\t\t\t'div_barraexport div_gr40');\r\n\r\n\t\t\t\tvar btcamera = jQuery(\r\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_captura\\\" title=\\\"Capturar la vista del mapa\\\" data-lang-title=\\\"Capturar la vista del mapa\\\"><span class='glyphicon glyphicon-camera grisfort'></span></div>\")\r\n\t\t\t\t\t\t.on(\r\n\t\t\t\t\t\t\t\t'click',\r\n\t\t\t\t\t\t\t\tfunction(event) {\r\n\t\t\t\t\t\t\t\t\taturaClick(event);\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'captura pantalla',\r\n\t\t\t\t\t\t\t\t\t\t\t'label captura', 1]});\r\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA);\r\n\t\t\t\t\t\t\t\t\tself.hide()\r\n\t\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\tthis._div_H_Export.appendChild(btcamera[0]);\r\n\r\n\t\t\t\tvar btprint = jQuery(\r\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_print\\\" title=\\\"Imprimir la vista del mapa\\\" data-lang-title=\\\"Imprimir la vista del mapa\\\"><span class='glyphicon glyphicon-print grisfort'></span></div>\")\r\n\t\t\t\t\t\t.on(\r\n\t\t\t\t\t\t\t\t'click',\r\n\t\t\t\t\t\t\t\tfunction(event) {\r\n\r\n\t\t\t\t\t\t\t\t\taturaClick(event);\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'print',\r\n\t\t\t\t\t\t\t\t\t\t\t'label print', 1]});\r\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_INFORME);\r\n\t\t\t\t\t\t\t\t\tself.hide();\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\tthis._div_H_Export.appendChild(btprint[0]);\r\n\r\n\t\t\t\tvar btgeopdf = jQuery(\r\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geopdf\\\" title=\\\"Descarrega mapa en format GeoPDF\\\" data-lang-title=\\\"Descarrega mapa en format GeoPDF\\\"><span class='fa fa-file-pdf-o geopdf'></span></div>\")\r\n\t\t\t\t\t\t.on(\r\n\t\t\t\t\t\t\t\t'click',\r\n\t\t\t\t\t\t\t\tfunction(event) {\r\n\r\n\t\t\t\t\t\t\t\t\taturaClick(event);\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geopdf',\r\n\t\t\t\t\t\t\t\t\t\t\t'label geopdf', 1]});\r\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_GEOPDF);\r\n\t\t\t\t\t\t\t\t\tself.hide();\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\tthis._div_H_Export.appendChild(btgeopdf[0]);\r\n\r\n\t\t\t\tvar btgeotiff = jQuery(\r\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geotiff\\\" title=\\\"Descarrega mapa en format GeoTiff\\\" data-lang-title=\\\"Descarrega mapa en format GeoTiff\\\"><span class='fa fa-file-image-o grisfort'></span></div>\")\r\n\t\t\t\t\t\t.on(\r\n\t\t\t\t\t\t\t\t'click',\r\n\t\t\t\t\t\t\t\tfunction(event) {\r\n\t\t\t\t\t\t\t\t\taturaClick(event);\r\n\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geotiff',\r\n\t\t\t\t\t\t\t\t\t\t\t'label geotiff', 1]});\r\n\r\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA_GEOTIFF);\r\n\t\t\t\t\t\t\t\t\tself.hide();\r\n\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\tthis._div_H_Export.appendChild(btgeotiff[0]);\r\n\r\n\t\t\t\tvar btgeopkg = jQuery(\r\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geopkg\\\" title=\\\"Descarrega vectors en format GeoPackage\\\" data-lang-title=\\\"Descarrega vectors en format GeoPackage\\\"><span class='fa fa-database grisfort'></span></div>\")\r\n\t\t\t\t\t\t.on('click',\r\n\t\t\t\t\t\t\t\tfunction(event) {\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taturaClick(event);\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geopkg',\r\n\t\t\t\t\t\t\t\t\t\t\t'label geopkg', 1]});\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA_GEOPACKAGE);\r\n\t\t\t\t\t\t\t\t\tself.hide()\r\n\t\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\tthis._div_H_Export.appendChild(btgeopkg[0]);\r\n\r\n\t\t\t\tjQuery('body').append(this._div_H_Export);\r\n\r\n\t\t\t\tL.DomEvent.on(container, 'click', stop).on(container,\r\n\t\t\t\t\t\t'mousedown', stop).on(container, 'dblclick', stop).on(\r\n\t\t\t\t\t\tcontainer, 'click', L.DomEvent.preventDefault).on(\r\n\t\t\t\t\t\tcontainer, 'click', self._toggle, self);\r\n\r\n\t\t\t\treturn container;\r\n\t\t\t},\r\n\r\n\t\t\thideBtn : function() {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\t$(self._div).hide();\r\n\t\t\t},\r\n\r\n\t\t\tshowBtn : function() {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\t$(self._div).show();\r\n\t\t\t},\r\n\r\n\t\t\thide : function() {\r\n\t\t\t\tL.DomUtil.removeClass(this._div, 'greenfort');\r\n\t\t\t\tL.DomUtil.addClass(this._div, 'grisfort');\r\n\t\t\t\t$('.div_barraexport').hide();\r\n\t\t\t},\r\n\r\n\t\t\tshow : function(e) {\r\n\t\t\t\tvar _map = this._map;\r\n\t\t\t\tL.DomUtil.removeClass(this._div, 'grisfort');\r\n\t\t\t\tL.DomUtil.addClass(this._div, 'greenfort');\r\n\t\t\t\tvar leftO = ($(this._div_H_Export).width() + parseInt(10));\r\n\t\t\t\tvar offset = $(this._div).offset();\r\n\t\t\t\t$('.div_barraexport').css('top', (offset.top - 10) + 'px');\r\n\t\t\t\t$('.div_barraexport').css('left', (offset.left - leftO) + 'px');\r\n\t\t\t\t$('.div_barraexport').show();\t\t\t\t\r\n\t\t\t\tjQuery('.leaflet-control-layers').hide();\r\n\t\t\t\t\r\n\t\t\t\tvar _scope = 'visor';\r\n\t\t\t\tvar tipus_user = \"\";\r\n\t\t\t\tgetModeMapa() ? _scope = 'mapa' : _scope = 'visor';\r\n\t\t\t\t\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\r\n\t\t\t\t\ttipus_user + 'exportmapa', 'label exportmap', 1]});\t\t\r\n\t\t\t},\r\n\r\n\t\t\t_toggle : function(e) {\r\n\t\t\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\r\n\t\t\t\tthis[collapsed ? 'show' : 'hide']();\r\n\t\t\t},\r\n\r\n\t\t});\r\n\r\nL.control.mapExport = function(options) {\r\n\treturn new L.Control.MapExport(options);\r\n};","L.Spinner = {\r\n\tspin: function (state, _options) {\r\n    \tif (!!state) {\r\n            // start spinning !\r\n    \t\tif (!this._spinner) {\r\n    \t\t\tthis._spinner = L.DomUtil.get(this.options.spinerDiv);\r\n    \t\t\tthis._spinning = 0;\r\n    \t\t}\r\n    \t\tif (this._spinner) {\r\n    \t\t\tthis._spinner.style.display = 'flex';\r\n    \t\t}\r\n    \t\tthis._spinning++;\r\n        }\r\n        else {\r\n            this._spinning--;\r\n            if (this._spinning <= 0) {\r\n                // end spinning !\r\n            \tif (this._spinner) {\r\n            \t\tthis._spinner.style.display = 'none';\r\n            \t\tthis._spinner = null;\r\n            \t}\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nL.Map.include(L.Spinner);\r\n\r\nL.Map.addInitHook(function () {\r\n\tthis.on('layeradd',function(e){\r\n\t\tif( e.layer instanceof L.TileLayer ){\r\n\t\t\tif (e.layer.loading) this.spin(true);\r\n\t\t\tif (typeof e.layer.on != 'function') return;\r\n\t        e.layer.on('data:loading', function () { this.spin(true); }, this);\r\n\t        e.layer.on('data:loaded',  function () { this.spin(false); }, this);\r\n\t\t}\r\n\t});\r\n\t\r\n\tthis.on('layerremove', function (e) {\r\n        // Clean-up\r\n        if (e.layer.loading) this.spin(false);\r\n        if (typeof e.layer.on != 'function') return;\r\n        e.layer.off('data:loaded');\r\n        e.layer.off('data:loading');\r\n    }, this);\r\n});","/**\r\n * Classe propia, layer de wikipedia\r\n */\r\n\r\nL.Wikipedia = L.FeatureGroup.extend({\r\n\toptions: {\r\n\t\tkey: ''\r\n\t},\r\n\r\n\tinitialize: function(options) {\r\n\t\tL.FeatureGroup.prototype.initialize.call(this);\r\n\t\tL.Util.setOptions(this, options);\r\n\t},\r\n\r\n\t\r\n\tonAdd: function(map, insertAtTheBottom) {\r\n\t\tthis._map = map;\r\n\t\tthis._insertAtTheBottom = insertAtTheBottom;\r\n\t\tthis._update('map');\r\n\t\tmap.on('moveend', this._update, this);\r\n\t\tthis.fire('add');\r\n\t},\r\n\r\n\tonRemove: function(map) {\r\n\t\tmap.off('moveend', this._update, this);\r\n\t\tthis.eachLayer(map.removeLayer, map);\r\n\t\tthis.fire('remove');\r\n\t},\r\n\r\n\t_load: function(data) {\r\n\t\tfor (var i = 0; i < data.geonames.length; i++) {\r\n\t\t\tvar wikiL = data.geonames[i];\r\n\t\t\tvar icoWikipedia = L.AwesomeMarkers.icon({\r\n\t\t\t\ticon : 'book',\r\n\t\t\t\tmarkerColor : 'gray',\r\n\t\t\t\ticonAnchor : new L.Point(14, 42),\r\n\t\t\t\ticonSize : new L.Point(28, 42),\r\n\t\t\t\ticonColor : '#000000',\r\n\t\t\t\tprefix : 'fa'\r\n\t\t\t});\t\t\t\t\r\n\t\t\tvar m = new L.Marker([wikiL.lat,wikiL.lng], {icon: icoWikipedia});\r\n\t\t\tm.bindPopup('<a  href=\"http://'+wikiL.wikipediaUrl+'\" target=\"_new\">'+wikiL.title+'</a><br/>');\r\n\t\t\tthis.fire('addlayer', {\r\n\t\t\t\tlayer: m\r\n\t\t\t});\r\n\t\t\tthis.addLayer(m);\r\n\t\t}\r\n\t\t/*SENSE MAXIM\r\n\t\tvar ks = [];\r\n\t\tfor(var key in this._layers)\r\n\t\t\tks.push(key);\r\n\t\tfor(var i = 0; i < ks.length-this.options.maxTotal; i++)\r\n\t\t\tthis.removeLayer(this._layers[ks[i]]);*/\r\n\t\tthis.fire(\"loaded\");\r\n\t},\r\n\r\n\t_update: function() {\r\n\t\tvar zoom = this._map.getZoom();\r\n\t\tvar bounds = this._map.getBounds();\r\n\t\tvar minll = bounds.getSouthWest();\r\n\t\tvar maxll = bounds.getNorthEast();\r\n  \t\t/*if(this._zoom && this._bbox)\r\n    \t\t\tif(this._zoom == zoom && minll.lng >= this._bbox[0] && minll.lat >= this._bbox[1] && maxll.lng <= this._bbox[2] && maxll.lat <= this._bbox[3])\r\n      \t\t\t\treturn;*/\r\n\t\t\r\n\t\t//Abans de recarregar elimino tots els markers\r\n\t\tthis.clearLayers();\r\n\t\t\r\n  \t\tvar bbox = [];\r\n  \t\tbbox[0] = minll.lng;\r\n  \t\tbbox[1] = minll.lat;\r\n  \t\tbbox[2] = maxll.lng;\r\n  \t\tbbox[3] = maxll.lat;\r\n\t\tthis._bbox = bbox;\r\n\t\tthis._zoom = zoom;\r\n\t\tvar _this = this;\r\n\t\t\r\n\t\tvar language = Cookies.get(\"langCookie\"); \r\n\t\tif (language == null || language == \"null\") language = 'ca';\r\n\t\tvar data={\r\n\t\t\t\tnorth: maxll.lat,\r\n\t\t\t\tsouth: minll.lat,\r\n\t\t\t\teast: maxll.lng,\r\n\t\t\t\twest: minll.lng,\r\n\t\t\t\tusername: 'geostarters',\r\n\t\t\t\tlang: language\r\n\t\t};\r\n\t\t\r\n\t\tgetWikipediaLayer(data).then(function(results){\r\n\t\t\t\t\t_this._load(results);\r\n\t\t\t},function(results){\r\n//\t\t\t\tconsole.debug('error getting wikipedia layer:'+results);\r\n\t\t});\r\n\t}\r\n\r\n});\r\n","/**\n * Classe propia, layer de twitter\n */\nL.Twitter = L.FeatureGroup.extend({\n\toptions: {\n\t\thashtag: 'Instamapes', \n\t\tgeocode: '41.387,2.168,100' \n\t},\n\n\tinitialize: function(options) {\n\t\tL.FeatureGroup.prototype.initialize.call(this);\n\t\tL.Util.setOptions(this, options);\n\t},\n\n\tonAdd: function(map, insertAtTheBottom) {\n\t\tthis._map = map;\n\t\tthis._insertAtTheBottom = insertAtTheBottom;\n\t\tthis._update('map');\n\t\tmap.on('moveend', this._update, this);\n\t\tthis.fire('add');\n\t},\n\n\tonRemove: function(map) {\n\t\tmap.off('moveend', this._update, this);\n\t\tthis.eachLayer(map.removeLayer, map);\n\t\tthis.fire('remove');\n\t},\t\n\n\t_load: function(data) {\n\t\tfor (var i = 0; i < data.length; i++) {\n\t\t\tvar obj = data[i];\n\t\t\tvar icoTwitter = L.AwesomeMarkers.icon({\n\t\t\t\ticon : 'twitter',\n\t\t\t\tmarkerColor : 'blue',\n\t\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\t\ticonSize : new L.Point(28, 42),\n\t\t\t\ticonColor : '#000000',\n\t\t\t\tprefix : 'fa'\n\t\t\t});\n\t\t\tvar coord = obj.coord;\n\t\t\tif (coord.indexOf(\"[\") != -1){\n\t\t\t\tcoord = coord.replace(\"[\",\"\");\n\t\t\t\tcoord = coord.replace(\"]\",\"\");\n\t\t\t}\n\t\t\tcoord = coord.split(\",\");\n\t\t\tvar m = new L.Marker([coord[1],coord[0]], {icon: icoTwitter});\n\t\t\tvar text = parseTwitterText(obj.text_message);\n\t\t\tm.bindPopup('<div class=\"twitter_layer_popup\"><a href=\"'+obj.profile_url+'\" target=\"_new\"><img src=\"'+obj.profile_image_url+'\"/></a></div><br><div>'+text+'</div>');\n\t\t\tthis.fire('addlayer', {\n\t\t\t\tlayer: m\n\t\t\t});\n\t\t\tthis.addLayer(m);\t\t\t\n\t\t}\n\t\t\n\t\t/*SENSE MAXIM\n\t\tvar ks = [];\n\t\tfor(var key in this._layers)\n\t\t\tks.push(key);\n\t\tfor(var i = 0; i < ks.length-this.options.maxTotal; i++)\n\t\t\tthis.removeLayer(this._layers[ks[i]]);*/\n\t\tthis.fire(\"loaded\");\n\t},\n\n\t_update: function() {\n\t\tvar zoom = this._map.getZoom();\n\t\tvar bounds = this._map.getBounds();\n\t\tvar minll = bounds.getSouthWest();\n\t\tvar maxll = bounds.getNorthEast();\n  \t\t/*if(this._zoom && this._bbox)\n    \t\t\tif(this._zoom == zoom && minll.lng >= this._bbox[0] && minll.lat >= this._bbox[1] && maxll.lng <= this._bbox[2] && maxll.lat <= this._bbox[3])\n      \t\t\t\treturn;*/\n  \t\t\n\t\t//Abans de recarregar elimino tots els markers\n\t\tthis.clearLayers();  \t\t\n  \t\t\n  \t\tvar bbox = [];\n  \t\tbbox[0] = minll.lng;\n  \t\tbbox[1] = minll.lat;\n  \t\tbbox[2] = maxll.lng;\n  \t\tbbox[3] = maxll.lat;\n\t\tthis._bbox = bbox;\n\t\tthis._zoom = zoom;\n\t\tvar _this = this;\n\t\n\t\tvar data = {\n\t\t\thashtag: this.options.hashtag,\n\t\t\tmapCenter: map.getCenter().lat+','+map.getCenter().lng,\n\t\t\tmapBbox: map.getBounds().toBBoxString()\n\t\t};\n\t\t\n\t\tgetTwitterLayer(data).then(function(results){\n\t\t\tif(results.status==='OK'){\n//\t\t\t\tconsole.debug('twitter ok');\n\t\t\t\t_this._load(results.results);\n\t\t\t}else{\n\t\t\t\tconsole.debug('Error al carregar capa twitter');\n\t\t\t}\t\t\t\t\n\t\t},function(results){\n\t\t\t//$('#modal_login_ko').modal('toggle');\n\t\t\tconsole.debug('Error al carregar capa twitter');\n\t\t});\t\t\t\n\n\t}\n\n});\n\n//function parseTwitterText(ptext){\n//\t\n////\tvar lwords = ptext.split(\" \"); \n//\tvar twitterText = \"\";\n//\t\n//\tfor(var i; i<ptext.lenght; i++){\n//\t\tvar text;\n//\t\tvar word = lwords[index];\n//\t\tif(ptext[i] == \"#\"){\n//\t\t\twhile()\n//\t\t\tword = word.replace(\"#\", \"\");\n//\t\t\ttext = \"<a href=\\\"https://twitter.com/hashtag/\"+word+\"\\\" target=\\\"_blank\\\">#\"+word+\"</a>\";\n//\t\t}else if(word.indexOf(\"@\") == 0){\n//\t\t\t\n//\t\t}else if(word.indexOf(\"http:/\") == 0){\n//\t\t\t\n//\t\t}else{\n//\t\t\ttext = word;\n//\t\t}\n//\t\ttwitterText+=\" \"+text;\n//\t}\n//\t\n//\treturn twitterText;\n//}\n\nfunction parseTwitterText(ptext){\n\t\n\tvar lwords = ptext.split(\" \"); \n\tvar twitterText = \"\";\n\tfor(index in lwords){\n\t\tvar text;\n\t\tvar word = lwords[index];\n\t\tif(word.indexOf(\"#\") == 0){\n\t\t\tword = word.replace(\"#\", \"\");\n\t\t\ttext = \"<a href=\\\"https://twitter.com/hashtag/\"+word+\"\\\" target=\\\"_blank\\\">#\"+word+\"</a>\";\n\t\t}else if(word.indexOf(\"@\") == 0){\n\t\t\tword = word.replace(\"@\", \"\");\n\t\t\ttext = \"<a href=\\\"https://twitter.com/\"+word+\"\\\" target=\\\"_blank\\\">@\"+word+\"</a>\";\t\t\t\n\t\t}else if(word.indexOf(\"http:/\") == 0){\n//\t\t\tword = word.replace(\"http://\", \"\");\n\t\t\ttext = \"<a href=\\\"\"+word+\"\\\" target=\\\"_blank\\\">\"+word.replace(\"http://\", \"\")+\"</a>\";\t\t\t\t\t\n\t\t}else{\n\t\t\ttext = word;\n\t\t}\n\t\ttwitterText+=\" \"+text;\n\t}\n\treturn twitterText;\n}\n","(function (window, document, undefined) {\r\n\tL.Polyline.include({\r\n\t    bindLabelEx: function (map,content, options) {\r\n\t    \tthis._map=map;\r\n\t      if (!this.label || this.label.options !== options) {\r\n\t        this.label = new L.Label(options, this);\r\n\t      }\r\n\t      this\r\n\t  \t\t.on('remove', this.hideLabel, this)\r\n\t  \t\t.on('move', this._moveLabel, this)\r\n\t  \t\t.on('add', this._onPolylineAdd, this);\r\n\t      var latlngs = this.getLatLngs();\r\n\t      var nPoint = latlngs.length;\r\n\r\n\t      var lats = [];\r\n\t      var lngs = [];\r\n\t      for(var i = 0; i < nPoint; i++) {\r\n\t        lats.push(latlngs[i].lat);\r\n\t        lngs.push(latlngs[i].lng);\r\n\t      }\r\n\r\n\t      var minLat = Math.min.apply(null, lats);\r\n\t      var maxLat = Math.max.apply(null, lats);\r\n\t      var minLng = Math.min.apply(null, lngs);\r\n\t      var maxLng = Math.max.apply(null, lngs);\r\n\r\n\t      var pointM = {\r\n\t        lat: (minLat + maxLat) / 2,\r\n\t        lng: (minLng + maxLng) / 2\r\n\t      };\r\n\t      //console.debug(pointM);\r\n\t      this.label.setContent(content);\r\n\t      this._showLabelAdded = true;\r\n\t      this._showLabel({\r\n\t        latlng: pointM\r\n\t      });\r\n\t    },\r\n\t    unbindLabel: function () {\r\n\t    \tthis\r\n\t\t\t.off('remove', this.hideLabel, this)\r\n\t\t\t.off('move', this._moveLabel, this)\r\n\t\t\t.off('add', this._onPolylineAdd, this);\r\n\t    \tif (this.label) {\r\n\t\t\t\tthis._hideLabel();\r\n\t\t\t\tthis.label = null;\r\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\r\n\t\t\t}\r\n\t    \t\r\n\t\t\treturn this;\r\n\t\t},\r\n\t    hideLabel: function () {\r\n\t\t\tif (this.label) {\r\n\t\t\t\tthis.label.close();\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_showLabel: function (e) {\r\n\t\t\tthis.label.setLatLng(e.latlng);\r\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\r\n\t\t},\r\n\t\t_onPolylineAdd: function () {\r\n\t\t\tif (this._labelNoHide) {\r\n\t\t\t\tthis._showLabel();\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tL.Polygon.include({\r\n\t    bindLabelExPolygon: function (map,content, options) {\r\n\t       this._map=map;\r\n\t      if (!this.label || this.label.options !== options) {\r\n\t        this.label = new L.Label(options, this);\r\n\t      }\r\n\t  \t this\r\n\t  \t\t.on('remove', this.hideLabel, this)\r\n\t  \t\t.on('move', this._moveLabel, this)\r\n\t  \t\t.on('add', this._onPolygonAdd, this);\r\n\t     \r\n\t  \t var pointM = this.getBounds().getCenter();\r\n\t     \r\n\t      this.label.setContent(content);\r\n\t      this._showLabelAdded = true;\r\n\t      this._showLabel({\r\n\t        latlng: pointM\r\n\t      });\r\n\t    },\r\n\t    unbindLabel: function () {\r\n\t    \tthis\r\n\t\t\t.off('remove', this.hideLabel, this)\r\n\t\t\t.off('move', this._moveLabel, this)\r\n\t\t\t.off('add', this._onPolygonAdd, this);\r\n\t    \tif (this.label) {\r\n\t\t\t\tthis._hideLabel();\r\n\t\t\t\tthis.label = null;\r\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\thideLabel: function () {\r\n\t\t\tif (this.label) {\r\n\t\t\t\tthis.label.close();\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_showLabel: function (e) {\r\n\t\t\tthis.label.setLatLng(e.latlng);\r\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\r\n\t\t},\r\n\t\t_onPolygonAdd: function () {\r\n\t\t\tif (this._labelNoHide) {\r\n\t\t\t\tthis._showLabel();\r\n\t\t\t}\r\n\t\t}\r\n\t  });\r\n\t\r\n\tL.MultiPolygon.include({\r\n\t    bindLabelExPolygon: function (map,content, options) {\r\n\t       this._map=map;\r\n\t      if (!this.label || this.label.options !== options) {\r\n\t        this.label = new L.Label(options, this);\r\n\t      }\r\n\t  \t this\r\n\t  \t\t.on('remove', this.hideLabel, this)\r\n\t  \t\t.on('move', this._moveLabel, this)\r\n\t  \t\t.on('add', this._onPolygonAdd, this);\r\n\t     \r\n\t  \t var pointM = this.getBounds().getCenter();\r\n\t     \r\n\t      this.label.setContent(content);\r\n\t      this._showLabelAdded = true;\r\n\t      this._showLabel({\r\n\t        latlng: pointM\r\n\t      });\r\n\t    },\r\n\t    unbindLabel: function () {\r\n\t    \tthis\r\n\t\t\t.off('remove', this.hideLabel, this)\r\n\t\t\t.off('move', this._moveLabel, this)\r\n\t\t\t.off('add', this._onPolygonAdd, this);\r\n\t    \tif (this.label) {\r\n\t\t\t\tthis._hideLabel();\r\n\t\t\t\tthis.label = null;\r\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\thideLabel: function () {\r\n\t\t\tif (this.label) {\r\n\t\t\t\tthis.label.close();\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_showLabel: function (e) {\r\n\t\t\tthis.label.setLatLng(e.latlng);\r\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\r\n\t\t},\r\n\t\t_onPolygonAdd: function () {\r\n\t\t\tif (this._labelNoHide) {\r\n\t\t\t\tthis._showLabel();\r\n\t\t\t}\r\n\t\t}\r\n\t  });\r\n}(window, document));","var HOST_APP = \"http://www.instamaps.cat/\";\r\nvar GEOCAT02 = \"http://www.instamaps.cat\";\r\nvar HOST_APP2 = \"http://www.instamaps.cat/\";\r\nvar HOST_GEOLOCAL = \"http://www.geolocal.cat/\";\r\nvar proxydir = \"maps\";\r\nvar tmpdir = \"/opt/geocat/maps/tmp/\";\r\nvar tmpdirPolling = \"poll/\";\r\nvar renovarPassword = \"/geocatweb/renovar.html?token=\";\r\n\r\nvar urlApp=document.location.href;\r\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)){\r\n//\tHOST_APP = \"http://172.70.1.12/\";\r\n//\tHOST_APP = \"http://localhost:8080/\";\r\n//\tHOST_APP = \"http://nicosia.icgc.local/\";//Local Jess\r\n//\tHOST_APP2 = \"http://nicosia.icgc.local/\";\r\n\tHOST_APP = \"http://localhost/\";//Local Jess\r\n\tHOST_APP2 = \"http://localhost/\";\r\n\r\n//\tHOST_APP = \"http://localhost/\";//Local Jess\r\n//\tGEOCAT02 = \"http://localhost:8181\";\r\n\tGEOCAT02 = \"http://localhost\";\r\n\t//GEOCAT02 = \"http://localhost\";\r\n\thttp://172.70.1.11\r\n\t//HOST_GEOLOCAL = \"http://localhost/\";\r\n\tHOST_GEOLOCAL = \"http://geolocaldev.icgc.local/\";\r\n\tproxydir=\"maps\"; //he creat un director maps al meu Apache\r\n\t//tmpdir=\"E://temp//\";\r\n}\r\n\r\nvar DOMINI = \"www.instamaps.cat\";\r\nif(urlApp.indexOf('172.70.1.11')!=-1){\r\n\tHOST_APP = \"http://172.70.1.11/\";\r\n\tHOST_APP2 = \"http://172.70.1.11/\";\r\n//\tHOST_APP = \"http://localhost:8080/\";\r\n\tGEOCAT02 = \"http://172.70.1.11\";\r\n\tHOST_GEOLOCAL = \"http://geolocaldev.icgc.local/\";\r\n\tproxydir=\"maps\"; //he creat un director maps al meu Apache\r\n}\r\n\r\n\r\n\r\n\r\nvar DOMINI = \"www.instamaps.cat\";\r\n\r\nvar paramUrl = {\r\n\tproxy:\"/\"+proxydir+\"/proxy.cgi\",\r\n\tuploadproxy:\"/\"+proxydir+\"/upload.cgi\",\r\n\tproxy_download:\"/\"+proxydir+\"/download.cgi\",\r\n\tproxy_betterWMS:\"/\"+proxydir+\"/proxy_betterWMS.cgi\",\r\n\tmainPage:\"/index.html\",\r\n\tloginPage:\"/geocatweb/sessio.html\",\r\n\tloginGeolocalPage:\"/geocatweb/sessio_geolocal.html\",\r\n\tmapaPage:\"/geocatweb/mapa.html\",\r\n\tvisorPage:\"/geocatweb/visor.html\",\r\n\tinstaVisorFolder:\"instavisor/\",\r\n\tvisorCloudifier:\"/geocatweb/visor_cloudifier.html\",\r\n\tregistrePage:\"/geocatweb/registre.html\",\r\n\tgaleriaPage:\"/geocatweb/galeria.html\",\r\n\tperfilPage:\"/geocatweb/perfil.html\",\r\n\toblidatPage:\"/geocatweb/oblidat.html\",\r\n\tcomentarisPage:\"http://betaportal.icgc.cat\",\r\n\twmsOpenData:\"/dadesobertes/wms/service?\",\r\n\ttmsOpenData:\"/geocatcache/?\",\r\n\tgetAllMapsByUser: HOST_APP+\"geocat/aplications/map/getAllMapsByUser.action?\",\r\n\t//getAllPublicsMaps: HOST_APP+\"geocat/aplications/map/getAllPublicsMaps.action?\",\r\n\tgetAllPublicsMaps: HOST_APP+\"geocat/aplications/map/getAllGaleriaMaps.action?\",\r\n\tsearchGaleriaMaps: HOST_APP+\"geocat/aplications/map/searchGaleriaMaps.action?\",\r\n\tgetNumGaleria: HOST_APP+\"geocat/aplications/map/getNumGaleria.action?\",\r\n\tloadPrivateMapByBusinessId: HOST_APP+\"geocat/aplications/map/loadPrivateMapByBusinessId.action?\",\r\n\tdeleteMap: HOST_APP+\"geocat/aplications/map/deleteMap.action?\",\r\n\tresetClauMapa: HOST_APP+\"geocat/aplications/map/resetClauMapa.action?\",\r\n\tloginUser: HOST_APP+\"geocat/login.action?\",\r\n\tloginToken: HOST_APP+\"geocat/loginToken.action?\",\r\n\tloginUserIcgc: HOST_APP+\"geocat/loginIcgc.action?\",\r\n\tlogoutUser: HOST_APP+\"geocat/logout.action?\",\r\n\tsigninUser: HOST_APP+\"geocat/registreUser.action?\",\r\n\tsigninSocial: HOST_APP+\"geocat/social/createUser.action?\",\r\n\tsocialAuth: HOST_APP+\"geocat/social/auth.action?\",\r\n\tvalidateUsername: HOST_APP+\"geocat/validateUid?\",\r\n\tvalidateEmail: HOST_APP+\"geocat/validateEmail?\",\r\n\tgetUser: HOST_APP+\"geocat/user/getUser.action?\",\r\n\tgetUserSimple: HOST_APP+\"geocat/user/getUserSimple.action?\",\r\n\tupdateUser: HOST_APP+\"geocat/user/updateUser.action?\",\r\n\tdeleteUser: HOST_APP+\"geocat/user/deleteUser.action?\",\r\n\tupdatePassword: HOST_APP+\"geocat/user/updatePassword.action?\",\r\n\tcreateTematicLayerFeature: HOST_APP+\"geocat/layers/tematic/createTematicLayerFeature.action?\",\r\n\tdragFile: HOST_APP+\"share/jsp/upload.jsp?\",\r\n\tcreateRang: HOST_APP+\"geocat/layers/tematic/createRang.action?\",\r\n\tcreateData: HOST_APP+\"geocat/layers/data/createData.action?\",\r\n\tcreateFeature: HOST_APP+\"geocat/layers/feature/createFeature.action?\",\r\n\tgetTematicLayerByBusinessId:HOST_APP+\"geocat/layers/tematic/getTematicLayerByBusinessId.action?\",\r\n\tgetCacheVisualitzacioLayerByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getCacheVisualitzacioLayerByBusinessId.action?\",\r\n\tdadesObertes:GEOCAT02+\"/share/jsp/dadesObertes.jsp?\",\r\n\turlFile:GEOCAT02+\"/share/jsp/urlFile.jsp?\",\r\n\turlFileProves:GEOCAT02+\"/share/jsp/urlFileProves.jsp?\",\r\n\turlFileNoDin:GEOCAT02+\"/share/jsp/urlFileNoDin.jsp?\",\r\n\turlFileDin:GEOCAT02+\"/share/jsp/urlFileDin.jsp?\",\r\n\t//getMapById: HOST_APP+\"geocat/aplications/map/getMapById.action?\",\r\n\tgetMapByBusinessId: HOST_APP+\"geocat/aplications/map/getMapByBusinessId.action?\",\r\n\tupdateMap: HOST_APP+\"geocat/aplications/map/updateMap.action?\",\r\n\tcreateMap: HOST_APP+\"geocat/aplications/map/createMap.action?\",\r\n\tgetAllServidorsWMSByUser: HOST_APP+\"geocat/layers/servidor/wms/getAllServidorsWMSByUser.action?\",\r\n\taddServerToMap: HOST_APP+\"geocat/aplications/map/addServerToMap.action?\",\r\n\tgetAllTematicLayerByUid: HOST_APP+\"geocat/layers/tematic/getAllTematicLayerByUid.action?\",\r\n\tdeleteTematicLayerAll: HOST_APP+\"geocat/layers/tematic/deleteTematicLayerAll.action?\",\r\n\tupdateMap: HOST_APP+\"geocat/aplications/map/updateMap.action?\",\r\n\tgetTwitterLayer: HOST_APP+\"geocat/layers/getTwitterLayer.action?\",\r\n\tupdateServersOrderToMap: HOST_APP+\"geocat/aplications/map/updateServersOrderToMap.action?\",\r\n\tupdateServerOrderToMap: HOST_APP+\"geocat/aplications/map/updateServerOrderToMap.action?\",\r\n\tupdateMapName: HOST_APP+\"geocat/aplications/map/updateMapName.action?\",\r\n\tremoveServerToMap: HOST_APP+\"geocat/aplications/map/removeServerToMap.action?\",\r\n\tdeleteServerRemoved: HOST_APP+\"geocat/aplications/map/deleteServerRemoved.action?\",\r\n\tupdateServidorWMSName: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSName.action?\",\r\n\r\n\r\n\t//nous updates\r\n\tupdateServidorWMSOptions: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSOptions.action?\",\r\n\tupdateServidorWMSGroup: HOST_APP+\"geocat/aplications/map/updateServidorWMSGroup.action?\",\r\n\tupdateServidorWMSOpacity: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSOpacity.action?\",\r\n\r\n\r\n\taddServerToMap: HOST_APP+\"geocat/aplications/map/addServerToMap.action?\",\r\n\tcreateServidorInMap: HOST_APP+\"geocat/layers/servidor/wms/createServidorInMap.action?\",\r\n\treadFile: HOST_APP+\"geocat/upload/readFile.action?\",\r\n\tuploadFile:  HOST_APP+\"geocat/upload/uploadFile.action?\",\r\n\turlGeoCoder:\"http://www.icc.cat/geocodificador/json?maxresultats=10&obtenirCoordGeografiques=si&metode=localitzaToponim&ordre=alfabetic&trobaTots=no&nom={s}&\",\r\n\tows2json:GEOCAT02+\"/share/jsp/ows2json.jsp?\",\r\n\tjson2jsonp:HOST_APP+\"share/jsp/json2jsonp.jsp?\",\r\n\tgetDownloadLayer:GEOCAT02+\"/share/jsp/download_layer.jsp?\",\r\n\tdeleteServidorWMS: HOST_APP+\"geocat/layers/servidor/wms/deleteServidorWMS.action?\",\r\n\taddFeatureToTematic: HOST_APP+\"geocat/layers/tematic/addFeatureToTematic.action?\",\r\n\tcreateTematicLayerEmpty: HOST_APP+\"geocat/layers/tematic/createTematicLayerEmpty.action?\",\r\n\tmoveFeatureToTematic: HOST_APP+\"geocat/layers/tematic/moveFeatureToTematic.action?\",\r\n\tdeleteFeature: HOST_APP+\"geocat/layers/feature/deleteFeature.action?\",\r\n\tupdateFeature: HOST_APP+\"geocat/layers/feature/updateFeature.action?\",\r\n\tshortUrl : \"https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDUUud-qayDcS4jmAUpr2PPjxHxu_qVbk0\",\r\n\tgetWikipediaLayer: \"http://api.geonames.org/wikipediaBoundingBoxJSON?\",\r\n\tupdateTematicRangs: HOST_APP+\"geocat/layers/tematic/updateTematicRangs.action\",\r\n\tcreateRandomUser: HOST_APP+\"geocat/createRandomUser.action?\",\r\n\tupdateServidorWMS: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMS.action?\",\r\n\tdeleteRandomUser: HOST_APP+\"geocat/deleteRandomUser.action?\",\r\n\tduplicateTematicLayer: HOST_APP+\"geocat/layers/tematic/duplicateTematicLayer.action?\",\r\n\treminderMail: HOST_APP+\"geocat/user/reminderMail.action?\",\r\n\trenewPassword: HOST_APP+\"geocat/user/renewPassword.action?\",\r\n\tgetNumEntitatsActives: HOST_APP+\"geocat/stats/getNumEntitatsActives.action?\",\r\n\tgetNumMapes: HOST_APP+\"geocat/stats/getNumMapes.action?\",\r\n\tgetNumCapes: HOST_APP+\"geocat/stats/getNumCapes.action?\",\r\n\tdownload_layer: HOST_APP+\"share/jsp/download_layer.jsp?\",\r\n\tupload_gdal: HOST_APP+\"share/jsp/upload_gdal.jsp?\",\r\n\tupload_gdal_nou: HOST_APP+\"share/jsp/upload_gdal_nou.jsp?\",\r\n\tupload_gdal_2015: HOST_APP+\"share/jsp/upload_gdal_2015.jsp?\",\r\n\tpolling: HOST_APP+\"share/jsp/polling.jsp?\",\r\n\tpublicarCapesMapa: HOST_APP+\"geocat/aplications/map/publicarCapesMapa.action?\",\r\n\tpresidentJSON: \"http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json\",\r\n\tdeleteUser: HOST_APP+\"geocat/user/deleteUser.action?\",\r\n\tgetUserSimple: HOST_APP+\"geocat/user/getUserSimple.action?\",\r\n\tpublicarMapConfig: HOST_APP+\"geocat/aplications/map/publicarMapConfig.action?\",\r\n\tgetCacheMapByBusinessId: HOST_APP+\"geocat/aplications/map/getCacheMapByBusinessId.action?\",\r\n\turluploadBase64:\"/share/jsp/uploadBase64.jsp?\",\r\n\turlgetMapImage:\"/share/jsp/getMapImage.jsp?\",\r\n\turlgetImageProxy:\"/share/jsp/getImageProxy.jsp?\",\r\n\r\n\turlMapToWMS:\"/share/jsp/getMapToWMS.jsp?\",\r\n\r\n\tupdatePasswordIcgc: HOST_APP+\"geocat/user/updatePasswordIcgc.action?\",\r\n\tsigninUserIcgc: HOST_APP+\"geocat/registreUserIcgc.action?\",\r\n\tsigninInstamaper: HOST_APP+\"geocat/registreInstamaper.action?\",\r\n\tupdateMapVisibility: HOST_APP+\"geocat/aplications/map/updateVisibility.action?\",\r\n\tsendMail: HOST_APP+\"geocat/mail/sendMail.action?\",\r\n\tgetEntitatsAplicacioRolByUidColaborador:  HOST_APP+\"geocat/entitatAplicacio/getEntitatsAplicacioRolByUidColaborador.action?\",\r\n\tgetEntitatsColaboradorsByAplicacio:  HOST_APP+\"geocat/entitatAplicacio/getAllEntitatsColaboradorsByAplicacio.action?\",\r\n\tgetConvidatsByBusinessId: HOST_APP+\"geocat/aplications/map/getConvidatsByBusinessId.action?\",\r\n\tdeleteConvidatByBusinessId: HOST_APP+\"geocat/aplications/map/deleteConvidatByBusinessId.action?\",\r\n\tupdateGeometria: HOST_APP+\"geocat/layers/geometriesColleccio/updateGeometria.action?\",\r\n\tcreateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioLayer.action?\",\r\n\tupdateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/updateVisualitzacioLayer.action?\",\r\n\tupdateNameVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/updateNameVisualitzacioLayer.action?\",\r\n\tgetVisualitzacioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getVisualitzacioByBusinessId.action?\",\r\n\tgetAllVisualitzacioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getAllVisualitzacioByBusinessId?\",\r\n\tgetAllVisualitzacioLayerByUid: HOST_APP+\"geocat/layers/visualitzacio/getAllVisualitzacioLayerByUid.action?\",\r\n\taddGeometriaToVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToVisualitzacio.action?\",\r\n\tmoveGeometriaToVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/moveGeometriaToVisualitzacio.action?\",\r\n\tduplicateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/duplicateVisualitzacioLayer.action?\",\r\n\tdeleteVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/deleteVisualitzacioLayer.action?\",\r\n\tdeleteVisualitzacioLayerAll: HOST_APP+\"geocat/layers/visualitzacio/deleteVisualitzacioLayerAll.action?\",\r\n\tcreateEstil: HOST_APP+\"geocat/layers/visualitzacio/createEstil.action?\",\r\n\tupdateEstil: HOST_APP+\"geocat/layers/visualitzacio/updateEstil.action?\",\r\n\tdeleteEstil: HOST_APP+\"geocat/layers/visualitzacio/deleteEstil.action?\",\r\n\taddGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToEstil.action?\",\r\n\tremoveGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaToEstil.action?\",\r\n\tmoveGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/moveGeometriaToEstil.action?\",\r\n\tmodificarEstiloGeometria: HOST_APP+\"geocat/layers/visualitzacio/modificarEstiloGeometria.action?\",\r\n\tremoveGeometriaFromVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaFromVisualitzacio.action?\",\r\n\tcreateVisualitzacioSimple: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioSimple.action?\",\r\n\tcreateVisualitzacioTematica: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioTematica.action?\",\r\n\tcreateVisualitzacioHeatCluster: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioHeatCluster.action?\",\r\n\tgetGeometriesColleccioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getGeometriesColleccioByBusinessId.action?\",\r\n\tgetGeometriesPropertiesLayer: HOST_APP+\"geocat/layers/visualitzacio/getGeometriesPropertiesLayer.action?\",\r\n\tremoveGeometriaFromProperties: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaFromProperties.action?\",\r\n\tupdateGeometriaProperties: HOST_APP+\"geocat/layers/geometriesColleccio/updateGeometriaProperties.action?\",\r\n\tupdateRankAplicacio: HOST_APP+\"geocat/aplications/map/updateRankAplicacio.action?\",\r\n\tcreateMapFile:  HOST_APP+\"geocat/layers/visualitzacio/createMapFile.action?\",\r\n\tsearchAction: HOST_APP+\"geocat/aplications/map/search.action?\",\r\n\tbuffer: HOST_APP+\"geocat/aplications/map/buffer.action?\",\r\n\tcentroid: HOST_APP+\"geocat/aplications/map/centroid.action?\",\r\n\tintersection: HOST_APP+\"geocat/aplications/map/intersection.action?\",\r\n\tunion: HOST_APP+\"geocat/aplications/map/union.action?\",\r\n\ttag: HOST_APP+\"geocat/aplications/map/tag.action?\",\r\n\tunionLayers: HOST_APP+\"geocat/aplications/map/unionLayers.action?\",\r\n\tgetVisualitzacioSimpleByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getVisualitzacioSimpleByBusinessId.action?\",\r\n\tfilterVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/filterVisualitzacio.action?\",\r\n\tcrearFitxerPolling: HOST_APP+\"/geocat/aplications/map/crearFitxerPolling.action?\",\r\n\tfilter: HOST_APP+\"geocat/aplications/map/filter.action?\",\r\n\tcallActions:\"/share/jsp/callActions.jsp?\",\r\n\t//loadAplicacionsUser: \"/geocatweb/dades/aplicacions_geolocal.json\",\r\n\tgetConfiguradesUser: HOST_GEOLOCAL+\"PRG/eines/getConfiguradesUser.action?\",\r\n\tprgIncasol: HOST_GEOLOCAL,\r\n\tcreateToken: HOST_APP +\"/geocat/createToken.action?\",\r\n\tuploadLogo: HOST_APP +\"share/jsp/uploadLogo.jsp?\",\r\n\tgetValuesFromKeysProperty: HOST_APP +\"geocat/aplications/map/getValuesFromKeysProperty.action?\",\r\n\tcolumnJoin: HOST_APP +\"geocat/aplications/map/columnJoin.action?\",\r\n\tspatialJoin: HOST_APP +\"geocat/aplications/map/spatialJoin.action?\",\r\n\tsearchCapesPubliques: HOST_APP+\"geocat/aplications/map/searchCapesPubliques.action?\",\r\n\taddServerDuplicateToMap: HOST_APP+\"geocat/aplications/map/addServerDuplicateToMap.action?\",\r\n\tduplicateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/duplicateVisualitzacioLayer.action?\",\r\n\tsearchCatalegIdec: HOST_APP+\"geocat/aplications/map/searchCatalegIdec.action?\",\r\n\tsearchGaleriaMapsByUser: HOST_APP+\"geocat/aplications/map/searchGaleriaMapsByUser.action?\",\r\n\teacat: \"https://idp.eacat.net/Logon.aspx?providerID=IDEC\",\r\n\turl_mapserver:HOST_APP+\"/geoservicelocal/\",\r\n\taddGeometriaToVisualitzacioTematic: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToVisualitzacioTematic.action?\",\r\n\tduplicateMap: HOST_APP+\"geocat/aplications/map/duplicateMap.action?\",\r\n\t//urlgetInspireCatalog:HOST_APP +\"/share/jsp/getInspireCatalog.jsp?\",\r\n\turlgetInspireCatalog:\"http://inspire-geoportal.ec.europa.eu/solr/select?\",\r\n\turlJsonPCC:\"/geocatweb/dades/pcc.json\",\r\n\tdesbloquejarMapa: HOST_APP+\"/geocat/aplications/map/desbloquejar.action?\",\r\n\tcrearFitxerSocrata:  HOST_APP+\"geocat/upload/crearFitxerSocrata.action?\",\r\n\tgenerateTokenRemember: HOST_APP+\"geocat/user/generateTokenRemember.action?\"\r\n\r\n}\r\n\r\nvar paramAplications = {\r\n\t'pcivil':{\r\n\t\t\"nom\":\"Protecció civil\",\r\n\t\t\"description\":\"Gestiona la informació relativa a Protecció civil per augmentar la seguretat dels ciutadans. Identifica els punts d'actuació prioritària en cas d'una emergència.\",\r\n\t\t\"img\":\"img/thumb_ed_pcivil.png\",\r\n\t\t\"url\":HOST_GEOLOCAL+\"geoLocal/crearAplicacionEditorPcivil.jsp?codiUsuari=\"\r\n\t},\r\n    'infoparcela':{\r\n    \t\"nom\":\"InfoParcela\",\r\n    \t\"description\":\"Permet realitzar un document amb informació referent a la parcel·la.\",\r\n    \t\"img\":\"img/thumb_ed_infoparcela.png\",\r\n    \t\"url\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela.action?fallback=infoparcela&codiUsuari=\",\r\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela/eliminar_geolocal.action?businessId=\",\r\n    \t\"editor\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela/modificar.action?businessId=\"\r\n    },\r\n    'peolics':{\r\n    \t\"nom\":\"Editor de Parcs Eòlics\",\r\n    \t\"description\":\"Actualitza la informació dels parcs eòlics. Col·labora mantenint la informació.\",\r\n    \t\"img\":\"img/thumb_ed_peolics.png\",\r\n    \t\"url\":HOST_GEOLOCAL+\"geoLocal/crearAplicacionEditorParcsEolics.jsp?codiUsuari=\"\r\n    },\r\n    'carrerer':{\r\n    \t\"nom\":\"Gestor de canvis carrerer\",\r\n    \t\"description\":\"Gestiona els canvis del carrerer. Ajuda a mantenir la base de carrers de l'ICGC.\",\r\n    \t\"img\":\"img/thumb_ed_carrerer.png\",\r\n    \t\"url\":HOST_GEOLOCAL+\"EdCarrerer/editorCarrerer.action?codiUsuari=\"\r\n    },\r\n    'incasol':{\r\n    \t\"nom\":\"Visors INCASÒL\",\r\n    \t\"description\":\"Ja pots tenir un visor de mapes a la teva web!. Crea els teus propis visors personalitzats i afegeix-hi la teva cartografia.\",\r\n    \t\"img\":\"img/thumb_ed_incasol.png\",\r\n    \t\"url\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol.action?\",\r\n    \t\"editor\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol/modificar.action?businessId=\",\r\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol/eliminar_geolocal.action?businessId=\"\r\n    },\r\n    'atles':{\r\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/atles/eliminar_geolocal.action?businessId=\"\r\n    }\r\n};\r\n\r\nvar perfilConfig = {\r\n\t\"0\":[paramAplications.pcivil, paramAplications.infoparcela, paramAplications.peolics, paramAplications.carrerer, paramAplications.incasol],\r\n\t\"1\":[],\r\n\t\"2\":[paramAplications.pcivil, paramAplications.infoparcela, paramAplications.carrerer],\r\n\t\"3\":[paramAplications.pcivil],\r\n\t\"4\":[],\r\n\t\"5\":[],\r\n\t\"6\":[],\r\n\t\"7\":[paramAplications.peolics],\r\n\t\"8\":[paramAplications.incasol],\r\n\t\"9\":[paramAplications.pcivil]\r\n};\r\n\r\n$( document ).ajaxSend(function( event, jqxhr, settings ) {\r\n\t//$('.waiting_animation').show();\r\n\tif (typeof map !== 'undefined'){\r\n\t\ttry {map.spin(true);} catch (Err) {}\r\n\r\n\t}\r\n});\r\n\r\n$( document ).ajaxComplete(function( event, jqxhr, settings ) {\r\n\tif (typeof map !== 'undefined'){\r\n\t\ttry {map.spin(false);} catch (Err) {}\r\n\t}\r\n\tif (jqxhr.responseJSON){\r\n\t\tif (jqxhr.responseJSON.status == \"ERROR\" && jqxhr.responseJSON.results == \"expired\"){\r\n\t\t\tsessionExpired();\r\n\t\t}\r\n\t}\r\n});\r\n\r\n$( document ).ajaxStop(function() {\r\n\t//$('.waiting_animation').hide();\r\n\tif (typeof map !== 'undefined'){\r\n\t\ttry {map.spin(false);} catch (Err) {\r\n\t\t\t//console.error(Err);\r\n\t\t}\r\n\t}\r\n\tsetTimeout(function(){\r\n\t\ttry {map.spin(false);} catch (Err) {\r\n\t\t\t//console.error(Err);\r\n\t\t}\r\n\t},10000);\r\n});\r\n","//Global vars\r\nvar map, controlCapes, hashControl;\r\nvar mapConfig = {};\r\n\r\nvar factorH = 50;\r\nvar factorW = 0;\r\n\r\nvar capaUsrPunt, capaUsrLine, capaUsrPol,capaUsrActiva;\r\n\r\nvar initMevesDades = false;\r\nvar download_layer;\r\nvar lsublayers = [];\r\nvar tipus_user;\r\n\r\n//Arrays control elements repetits a la llegenda\r\nvar controlLegendPoint = [];//Boles\r\nvar controlLegendMarker = [];//Pintxos\r\nvar controlLegendLine = [];\r\nvar controlLegendPol = [];\r\nvar mapLegend = {};\r\nvar downloadableData = {};\r\nvar _UsrID;\r\n\r\nvar dades1;\r\n\r\n\r\n//Contants del mapa 3D\r\nvar estatMapa3D=false;\r\n\r\n//Evitem error javascript a les pagines html que no carreguen la llibreria de leaflet\r\nif((urlApp.indexOf('mapa')!=-1)||(urlApp.indexOf('visor')!=-1)){\r\n//default geometries style\r\nvar estilP={\r\n\t\ticon : '',\r\n\t\ticonFons:'awesome-marker-web awesome-marker-icon-orange',\r\n\t\ticonGlif:'fa fa-',\r\n\t\tcolorGlif:'#333333',\r\n\t\tfontsize:'14px',\r\n\t\tsize:'28'\r\n\t};\r\n\r\nvar default_line_style = {\r\n\t    weight: 3,\r\n\t    color: '#FFC400',\r\n\t    opacity:1,\r\n\t    dashArray: '3',\r\n\t    lineCap:'round',\r\n\t    lineJoin:'round'\r\n\t};\r\n\r\nvar default_area_style = {\r\n\t    weight: 3,\r\n\t    opacity: 1,\r\n\t    color: '#FFC400',\r\n\t    dashArray: '3',\r\n\t    fillColor: \"rgb(255,196,0)\",//hexToRgb('#FFC400'),\r\n\t    borderColor: '#FFC400',\r\n\t    borderWidth: '3',\r\n\t    fillOpacity: 0.5\r\n\t};\r\n\r\nvar default_marker_style = {\r\n\t\ticon : '',\r\n\t\tmarkerColor : 'orange',\r\n\t\tdivColor:'transparent',\r\n\t\ticonAnchor : new L.Point(14, 42),\r\n\t\ticonSize : new L.Point(28, 42),\r\n\t\ticonColor : '#000000',\r\n\t\tprefix : 'fa',\r\n\t\tisCanvas:false,\r\n\t\tradius:6,\r\n\t\topacity:1,\r\n\t\tweight : 2,\r\n\t\tfillOpacity : 0.9,\r\n\t\tcolor : \"#ffffff\",\r\n\t\tfillColor :\"transparent\"\r\n\t};\r\n\r\nvar default_circulo_style = {\r\n\t\tisCanvas:true,\r\n\t\tsimbolSize: 6,\r\n\t\tborderWidth: 2,\r\n\t\topacity: 90,\r\n\t\tborderColor : \"#ffffff\",\r\n\t\tcolor :\"#FFC500\",\r\n\t\tlineWidth: 3,\r\n\t};\r\n\r\nvar default_circuloglyphon_style = {\r\n\t\ticon : '',\r\n\t\tmarkerColor: 'punt_r',\r\n\t\tprefix : 'fa',\r\n\t\tdivColor:'transparent',\r\n\t\ticonAnchor : new L.Point(15, 15),\r\n\t\ticonSize : new L.Point(30, 30),\r\n\t\ticonColor : '#000000',\r\n\t\tisCanvas:false,\r\n\t\tradius:6,\r\n\t\topacity:1,\r\n\t\tweight : 2,\r\n\t\tfillOpacity : 0.9,\r\n\t\tcolor : \"#ffffff\",\r\n\t\tfillColor :\"#FFC500\"\r\n\t};\r\n\r\nvar default_onsoc_style = {\r\n\t\ticon : '',\r\n\t\tmarkerColor : 'red',\r\n\t\tdivColor:'transparent',\r\n\t\ticonAnchor : new L.Point(14, 42),\r\n\t\ticonSize : new L.Point(28, 42),\r\n\t\ticonColor : '#000000',\r\n\t\tprefix : 'fa',\r\n\t\tisCanvas:false,\r\n\t\tradius:6,\r\n\t\topacity:1,\r\n\t\tweight : 2,\r\n\t\tfillOpacity : 0.9,\r\n\t\tcolor : \"#ffffff\",\r\n\t\tfillColor :\"transparent\"\r\n\t};\r\n}\r\n\r\n//constants\r\nvar t_geojsonvt = \"geojsonvt\";\r\nvar t_dades_obertes = \"dades obertes\";\r\nvar t_wms = \"wms\";\r\nvar t_json = \"json\";\r\nvar t_xarxes_socials = \"xarxes socials\";\r\nvar t_tematic = \"tematic\";\r\nvar t_visualitzacio = \"visualitzacio\";\r\nvar t_url_file = \"url_file\";\r\nvar t_vis_wms = \"vis_wms\";\r\nvar t_vis_wms_noedit = \"vis_wms_noeditable\";\r\n\r\n/**tipus estandar instamaps**/\r\nvar t_polyline = \"polyline\";\r\nvar t_polygon = \"polygon\";\r\nvar t_marker = \"marker\";\r\n/************************/\r\n\r\nvar t_multiple = \"multiple\";\r\nvar t_point = \"point\";\r\nvar t_multipoint = \"multipoint\";\r\nvar t_linestring = \"linestring\";\r\nvar t_multilinestring = \"multilinestring\";\r\nvar t_multipolygon = \"multipolygon\";\r\nvar t_heatmap = \"heatmap\";\r\nvar t_cluster = \"cluster\";\r\nvar t_size = \"size\";\r\nvar tem_origen = \"origenTematic\";\r\nvar tem_simple = \"simpleTematic\";\r\nvar tem_clasic = \"clasicTematic\";\r\nvar tem_size = \"sizeTematic\";\r\nvar tem_heatmap = \"heatmapTematic\";\r\nvar tem_cluster = \"clusterTematic\";\r\nvar tem_heatmap_wms = \"heatmapTematic_wms\";\r\nvar tem_cluster_wms = \"clusterTematic_wms\";\r\nvar from_creaPopup = \"creaPopup\";\r\nvar from_creaCapa = \"creaCapa\";\r\nvar visibilitat_open = 'O';\r\nvar visibilitat_privat = 'P';\r\n\r\nvar t_file_csv = \".csv\";\r\nvar t_file_txt = \".txt\";\r\nvar t_file_gpx = \".gpx\";\r\nvar t_file_kml = \".kml\";\r\nvar t_file_gml = \".gml\";\r\nvar t_file_wkt = \".wkt\";\r\nvar t_file_json = \".json\";\r\nvar t_file_geojson = \".geojson\";\r\nvar t_file_topojson = \".topojson\";\r\nvar t_file_shp = \".shp\";\r\nvar t_file_dxf = \".dxf\";\r\nvar t_file_dgn = \".dgn\";\r\nvar t_file_xls = \".xls\";\r\nvar t_file_xlsx = \".xlsx\";\r\n\r\nvar t_user_loginat = '1#';\r\nvar t_user_random = '0#';\r\n\r\nvar num_max_pintxos = 250;\r\nvar capesOrdre_sublayer = \"sublayer\";//10000;\r\n\r\nvar msg_noguarda = \"Per publicar o compartir el mapa has d'iniciar sessió\";\r\n\r\nvar CAPTURA_MAPA = \"captura_mapa\";\r\nvar CAPTURA_GALERIA = \"captura_galeria\";\r\nvar CAPTURA_INFORME = \"captura_informe\";\r\nvar CAPTURA_FONS = \"captura_fons\";\r\nvar CAPTURA_GEOPDF = \"captura_geopdf\";\r\nvar CAPTURA_MAPA_GEOTIFF=\"captura_mapa_geotiff\";\r\nvar CAPTURA_MAPA_GEOPACKAGE=\"captura_mapa_geopackage\";\r\nvar NODATA_VALUE = \"nodata\";\r\nvar NODATA_COLOR = \"#CCCCCC\";\r\nvar NODATA_MIDA = 10;\r\n\r\nvar TIPUS_APLIACIO_INSTAMAPS = 1;\r\nvar TIPUS_APLIACIO_GEOLOCAL = 2;\r\nvar TIPUS_APLIACIO_AOC = 3;\r\n\r\n//VAR per nou model de dades\r\nvar nou_model = true;\r\n\r\nvar instamaps_email = \"instamapes@icgc.cat\";\r\n//var curs_instamaps = \"1er curs InstaMaps\";\r\n//var curs_instamaps = \"2n curs InstaMaps\";\r\n//var curs_instamaps = \"3r curs InstaMaps\";\r\n//var curs_instamaps = \"4rt curs InstaMaps\";\r\nvar curs_instamaps = \"5e curs InstaMaps\";\r\n\r\n\r\n//Llistat exemples de dades externes\r\nvar llista_dadesExternes = {\r\n\t\t\"dadesExternes\" : [\r\n\r\n\t\t\t\t{\r\n\t                \"titol\" : \"Actes president.cat\",\r\n\t                \"ORGANITZAC\" : \"president.cat\",\r\n\t                \"urlOrganitzacio\" : \"http://www.president.cat\",\r\n\t                \"urlDadesExternes\" : \"http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json?\"\r\n\t\t\t\t},\r\n   \t\t\t\t{\r\n\t                \"titol\" : \"Plaques Tectòniques\",\r\n\t                \"ORGANITZAC\" : \"earthquake.usgs.gov\",\r\n\t                \"urlOrganitzacio\" : \"http://earthquake.usgs.gov\",\r\n\t                \"urlDadesExternes\" : \"http://earthquake.usgs.gov/learn/plate-boundaries.kmz\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_kml,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t},\r\n\r\n\r\n\t\t\t\t{\r\n\t\t\t\t\t\"titol\" : \"Ciutats del món\",\r\n\t\t\t\t\t\"ORGANITZAC\" : \"Wikipedia\",\r\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://en.wikipedia.org/wiki/List_of_cities_by_longitude\",\r\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/mahemoff/geodata/master/cities.geojson\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\t\"titol\" : \"Països del món\",\r\n\t\t\t\t\t\"ORGANITZAC\" : \"Wikimedia Foundation\",\r\n\t\t\t\t\t\"urlOrganitzacio\" : \"https://github.com/wikimedia\",\r\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/wikimedia/limn-data/master/geo/maps/world-countries.json\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\t\"titol\" : \"Huracans a l'Atlàntic al 2004\",\r\n\t\t\t\t\t\"ORGANITZAC\" : \"Unisys weather\",\r\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://weather.unisys.com/hurricane/atlantic/2004H/index.html\",\r\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/colemanm/hurricanes/master/fl_2004_hurricanes.geojson\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t},\r\n\r\n\t\t\t\t{//https://github.com/FCC/lpfmpoints\r\n\t\t\t\t\t\"titol\" : \"U.S. Low Power FM station\",\r\n\t\t\t\t\t\"ORGANITZAC\" : \"LPFM\",\r\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://www.fcc.gov/encyclopedia/low-power-fm-broadcast-radio-stations-lpfm\",\r\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/FCC/lpfmpoints/gh-pages/data/lpfm_points.geojson\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t},\r\n\r\n\t\t\t\t{\r\n\t\t\t\t\t\"titol\" : \"Camí de Sant Jaume\",\r\n\t\t\t\t\t\"ORGANITZAC\" : \"Gencat\",\r\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://www.gencat.cat/\",\r\n\t\t\t\t\t\"urlDadesExternes\" : \"http://www.gencat.cat/opendata/recursos/rutes/cami_de_sant_jaume.kml\",\r\n\t\t\t\t\t\"formatDadesExternes\": t_file_kml,\r\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\r\n\t\t\t\t}\r\n\t\t]\r\n};\r\n\r\nvar TIPUS_ENTITATS_GEOLOCAL = [2,3,4,5,6,7,8,9];\r\nvar TIPUS_ADMIN = 0;\r\nvar TIPUS_INSTAMAPS = 1;\r\nvar TIPUS_AOC = 10;\r\n\r\nvar guideLayers = new Array();\r\n","runningActions = [];\r\n\r\nfunction actionCompleted(jqXHR, status) {\r\n\t//Remove the completed action from the running actions\r\n\tvar index = runningActions.indexOf(jqXHR);\r\n\trunningActions.splice(index, 1);\r\n}\r\n\r\nfunction addXHR(jqXHR, settings)\r\n{\r\n\r\n\trunningActions.push(jqXHR);\r\n\r\n}\r\n\r\nfunction completedWithErrors(jqXHR, status, error)\r\n{\r\n\r\n\tconsole.log(\"!!!!!!!!!!!!!!!\" + error.message + \" stack: \" + error.stack);\r\n\r\n}\r\n\r\nfunction createXHR(inOptions)\r\n{\r\n\r\n\tvar options = {\r\n  \t\tdataType: 'jsonp',\r\n\t\tcomplete: actionCompleted,\r\n\t\tbeforeSend: addXHR,\r\n\t\terror: completedWithErrors\r\n\t};\r\n\r\n\tjQuery.extend(options, inOptions);\r\n\r\n\tvar xhr = jQuery.ajax(options);\r\n\treturn xhr.promise();\r\n\r\n}\r\n\r\nfunction loadPublicGaleria(params){\r\n\treturn createXHR(\r\n\t\t{url: paramUrl.getAllPublicsMaps, \r\n\t\tdata: params\r\n\t});\r\n}\r\n\r\nfunction loadNumGaleria(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getNumGaleria\r\n\t});\r\n}\r\n\r\n\r\nfunction searchGaleriaMaps(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.searchGaleriaMaps, \r\n\t\tdata: params \r\n\t});\r\n}\r\n\r\nfunction searchGaleriaMapsByUser(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.searchGaleriaMapsByUser, \r\n\t\tdata: params\r\n\t});\r\n}\r\n\r\nfunction deleteMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteMap, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\n/* registre.html */\r\n\r\nfunction registerUser(url, dataUrl){\r\n\treturn createXHR({\r\n\t\turl: url, \r\n\t\tdata: dataUrl,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction checkUsername(username){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.validateUsername, \r\n\t\tdata: {uid: username},\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction checkEmail(user_email){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.validateEmail, \r\n\t\tdata: {email: user_email},\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\n/* galeria.html */\r\n\r\n//solo galeria privada de geolocal para obtener las aplicaciones\r\nfunction getUserData(username){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getUserSimple, \r\n\t\tdata: {uid : username},\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\n/* comuns */\r\nfunction doLogout(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.logoutUser, \r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\n/* sessio.html */\r\n\r\nfunction doLogin(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.loginUser, \r\n\t\tdata: data,\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction doLoginIcgc(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.loginUserIcgc, \r\n\t\tdata: data,\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction loginToken(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.loginToken, \r\n\t\tdata: data,\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\n/* map */\r\nfunction createTematicLayerFeature(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createTematicLayerFeature, \r\n\t\tdata: data,\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction addFeatureToTematic(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addFeatureToTematic, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getTematicLayerByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getTematicLayerByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getCacheVisualitzacioLayerByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getCacheVisualitzacioLayerByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createFeature(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createFeature, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createData(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createData, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createRang(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createRang, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getLListaDadesObertes(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.dadesObertes, \r\n\t\tdata: {metode: 'getDatasets'},\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getMapByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getMapByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getCacheMapByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getCacheMapByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateMap, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction createMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getAllServidorsWMSByUser(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getAllServidorsWMSByUser, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction addServerToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addServerToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getAllTematicLayerByUid(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getAllTematicLayerByUid, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction deleteTematicLayerAll(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteTematicLayerAll, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction doUpdateMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateServersOrderToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServersOrderToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\n\r\nfunction updateServerOrderToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServerOrderToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateMapName(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateMapName, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getTwitterLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getTwitterLayer, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction removeServerToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.removeServerToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction deleteServerRemoved(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteServerRemoved, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateServidorWMSName(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServidorWMSName, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\n\r\nfunction updateServidorWMSOptions(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServidorWMSOptions, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateServidorWMSGroup(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServidorWMSGroup, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateServidorWMSOpacity(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServidorWMSOpacity, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\n\r\n\r\nfunction addServerToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addServerToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createServidorInMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createServidorInMap, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getWikipediaLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getWikipediaLayer, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction shortUrl(url){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.shortUrl, \r\n\t\tdataType: 'json',\r\n\t\tcontentType: \"application/json; charset=utf-8\",\r\n\t\tmethod: 'post',\r\n\t\tdata: JSON.stringify({longUrl: url}),\r\n\t});\r\n}\r\n\r\nfunction doReadFile(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.readFile, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction doUploadFile(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.uploadFile, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getDownloadLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.download_layer, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction deleteServidorWMS(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteServidorWMS, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createTematicLayerEmpty(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createTematicLayerEmpty, \r\n\t\tdata: data, \r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction moveFeatureToTematic(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.moveFeatureToTematic, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction deleteFeature(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteFeature, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateFeature(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateFeature, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateTematicRangs(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateTematicRangs, \r\n\t\tdata: data,\r\n\t\tmethod: 'post',\r\n\t\tdataType: ''\r\n\t});\r\n}\r\n\r\nfunction createRandomUser(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createRandomUser\r\n\t});\r\n}\r\n\r\nfunction deleteRandomUser(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteRandomUser, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getJSONPServei(url){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.json2jsonp, \r\n\t\tdata: { url: url},\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateServidorWMS(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateServidorWMS, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction duplicateTematicLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.duplicateTematicLayer, \r\n\t\tdata: data,\r\n\t\tmethod: 'post',\r\n\t\tdataType: ''\r\n\t});\r\n}\r\n\r\nfunction reminderMail(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.reminderMail, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction renewPassword(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.renewPassword, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getNumEntitatsActives(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getNumEntitatsActives\r\n\t});\r\n}\r\n\r\nfunction getNumMapes(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getNumMapes\r\n\t});\r\n}\r\n\r\nfunction getNumCapes(){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getNumCapes\r\n\t});\r\n}\r\n\r\nfunction publicarCapesMapa(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.publicarCapesMapa, \r\n\t\tdata: data, \r\n\t\tmethod: 'post',\r\n\t\tdataType: ''\r\n\t});\r\n}\r\n\r\nfunction publicarMapConfig(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.publicarMapConfig, \r\n\t\tdata: data, \r\n\t\tmethod: 'post',\r\n\t\tdataType: ''\r\n\t});\r\n}\r\n\r\nfunction getUrlFile(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlFile, \r\n\t\tdata: data, \r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction deleteUser(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteUser, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getUrlFileProves(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlFileProves, \r\n\t\tdata: data,\r\n\t\tasync: false, \r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getUrlFileNoDin(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlFileNoDin, \r\n\t\tdata: data,\r\n\t\tasync: false, \r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getUrlFileDin(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlFileDin, \r\n\t\tdata: data,\r\n\t\tasync: false, \r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getUserSimple(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getUserSimple, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction uploadImageBase64(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urluploadBase64, \r\n\t\tdata: data,\r\n\t\tdataType: 'json',\r\n\t\tcontentType: \"application/x-www-form-urlencoded;charset=UTF-8\",\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction createGeoPdfMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlgetMapImage, \r\n\t\tdata: data,\r\n\t\tdataType: 'json',\r\n\t\tcontentType: \"application/x-www-form-urlencoded;charset=UTF-8\",\r\n\t\tmethod: 'post'\r\n\t});\r\n}\t\r\n\r\nfunction createMapToWMS(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlMapToWMS, \r\n\t\tdata: data,\r\n\t\tdataType: 'json',\r\n\t\tcontentType: \"application/x-www-form-urlencoded;charset=UTF-8\",\r\n\t\tmethod: 'post'\r\n\t});\r\n}\t\r\n\r\nfunction deleteImageGaleria(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlgetMapImage, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updatePasswordIcgc(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updatePasswordIcgc, \r\n\t\tdata: data, \r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction createVisualitzacioLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createVisualitzacioLayer, \r\n\t\tdata: data, \r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction addGeometriaToVisualitzacio(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addGeometriaToVisualitzacio, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction moveGeometriaToVisualitzacio(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.moveGeometriaToVisualitzacio, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateGeometria(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateGeometria, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction modificarEstiloGeometria(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.modificarEstiloGeometria, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction removeGeometriaFromVisualitzacio(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.removeGeometriaFromVisualitzacio, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction updateNameVisualitzacioLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateNameVisualitzacioLayer, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction deleteVisualitzacioLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteVisualitzacioLayer, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getVisualitzacioByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getVisualitzacioByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createVisualitzacioSimple(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createVisualitzacioSimple, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction createVisualitzacioTematica(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createVisualitzacioTematica, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction createVisualitzacioHeatCluster(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createVisualitzacioHeatCluster, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getGeometriesColleccioByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getGeometriesColleccioByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction getGeometriesPropertiesLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getGeometriesPropertiesLayer, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction removeGeometriaFromProperties(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.removeGeometriaFromProperties, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateGeometriaProperties(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateGeometriaProperties, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction updateMapVisibility(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateMapVisibility, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction sendMail(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.sendMail, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction loadMapsColaboracio(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getEntitatsAplicacioRolByUidColaborador, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction getEntitatsColaboradorsByAplicacio(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getEntitatsColaboradorsByAplicacio, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction getConvidatsByBusinessId(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getConvidatsByBusinessId, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction deleteConvidatByBusinessId(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteConvidatByBusinessId, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction deleteUser(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.deleteUser, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction buffer(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.buffer, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction centroid(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.centroid, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction intersection(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.intersection, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction union(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.union, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction tag(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.tag, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction getVisualitzacioSimpleByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getVisualitzacioSimpleByBusinessId, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction filterVisualitzacio(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.filterVisualitzacio, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction registreInstamaper(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.signinInstamaper, \r\n\t\tdata: data\r\n\t});\r\n}\r\nfunction crearFitxerPolling(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.crearFitxerPolling, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction resetClauMapa(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.resetClauMapa, \r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction loadPrivateMapByBusinessId(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.loadPrivateMapByBusinessId, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction filter(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.filter, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction callActions(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.callActions, \r\n\t\tdata: data,\r\n\t\tasync: false,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction loadAplicacionsUser(){\r\n\tvar defer = jQuery.Deferred();\r\n\tdefer.resolve(perfilConfig);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction getUser(username){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getUser, \r\n\t\tdata: {uid : username},\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getConfiguradesUser(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getConfiguradesUser, \r\n\t\tdata: data,\r\n\t\tcrossDomain: true,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction deleteAplicacionsGeolocal(url){\r\n\treturn createXHR({\r\n\t\turl: url, \r\n\t\tcrossDomain: true,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction createToken(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.createToken, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction getValuesFromKeysProperty(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.getValuesFromKeysProperty, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction columnJoin(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.columnJoin, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction spatialJoin(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.spatialJoin, \r\n\t\tdata: params,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\nfunction searchCapesPubliques(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.searchCapesPubliques, \r\n\t\tdata: params\r\n\t});\r\n}\r\nfunction addServerDuplicateToMap(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addServerDuplicateToMap, \r\n\t\tdata: data\r\n\t});\r\n}\r\nfunction duplicateVisualitzacioLayer(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.duplicateVisualitzacioLayer, \r\n\t\tdata: data\r\n\t});\r\n}\r\nfunction searchCatalegIdec(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.searchCatalegIdec, \r\n\t\tdata: params\r\n\t});\r\n}\r\nfunction addGeometriaToVisualitzacioTematic(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.addGeometriaToVisualitzacioTematic, \r\n\t\tdata: params\r\n\t});\r\n}\r\nfunction updateVisualitzacioLayer(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.updateVisualitzacioLayer, \r\n\t\tdata: params\r\n\t});\r\n}\r\nfunction searchCatalogInspire(params){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.urlgetInspireCatalog, \r\n\t\tdata: params,\r\n\t\ttraditional: true,\r\n\t\tjsonp: 'json.wrf'\r\n\t});\r\n}\r\nfunction desbloquejarMapa(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.desbloquejarMapa, \r\n\t\tdata: data\r\n\t});\r\n}\r\nfunction crearFitxerSocrata(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.crearFitxerSocrata, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n\r\nfunction generateTokenRemember(data){\r\n\treturn createXHR({\r\n\t\turl: paramUrl.generateTokenRemember, \r\n\t\tdata: data,\r\n\t\tmethod: 'post'\r\n\t});\r\n}\r\n","/**\r\n * Funcions i utilitats vàries\r\n */\r\n\r\n//Varible per esciure debug amb funcion\r\n//  _escriuDebug(_debug,_arxiuJs,_liniacodi)\r\n\r\nvar _globalDebug=false;\r\n\r\n\r\nfunction isValidEmailAddress(emailAddress) {\r\n    var pattern = new RegExp(/^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?$/i);\r\n    return pattern.test(emailAddress);\r\n}\r\n\r\nfunction isValidURL(url) {\r\n\tvar pattern = /((http(s)?|ftp):\\/\\/.)?(www\\.)?[-a-zA-Z0-9:%._\\+~#=]{2,256}\\.[a-z0-9]{2,6}\\b([-a-zA-Z0-9%_:?\\+.~#&//=]*)/;\r\n\treturn pattern.test(url);\r\n}\r\n\r\nfunction isImgURL(str) {\r\n\treturn (/\\.(gif|jpg|jpeg|png)$/i).test(str);\r\n}\r\n\r\nfunction isBusinessId(str){\r\n\tvar pattern = new RegExp('^[0-9a-f]{32}$');\r\n\treturn pattern.test(str);\r\n}\r\n\r\nfunction isBlank(str) {\r\n    return (!str || (/^\\s*$/).test(str));\r\n}\r\n\r\nfunction isHexColor(color){\r\n\tvar pattern = /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i;\r\n\treturn pattern.test(color);\r\n}\r\n\r\nfunction isDefaultMapTitle(str){\r\n//\tvar pattern = new RegExp('^\\d{4}[\\/\\-](0?[1-9]|1[012])[\\/\\-](0?[1-9]|[12][0-9]|3[01])[_](?:2[0-3]|[01]?[0-9]):[0-5][0-9]:[0-5][0-9]$');\r\n\tvar pattern = /^\\d{4}[\\/\\-](0?[1-9]|1[012])[\\/\\-](0?[1-9]|[12][0-9]|3[01])[_](?:2[0-3]|[01]?[0-9]):[0-5][0-9]:[0-5][0-9]$/;\r\n\treturn pattern.test(str);\r\n}\r\n\r\nfunction isValidValue(value){\r\n\treturn (value!==\"undefined\" && value!==undefined && value!==null && value !== \" \" && value !== \"\" && value!==\"null\" && value!==-1 && value!==\"-1\");\r\n}\r\n\r\nfunction toggleCollapseDiv(divName){\r\n\t$(divName).toggle();\r\n}\r\n\r\nfunction getTimeStamp() {\r\n    var now = new Date();\r\n    return (now.getFullYear()+'/'+(\r\n    \t((now.getMonth() + 1) < 10) ? (\"0\" + (now.getMonth() + 1)) : ((now.getMonth() + 1)))\r\n    \t+ '/' +\r\n        now.getDate() +'_'+\r\n        ((now.getHours() < 10) ? (\"0\" + now.getHours()) : (now.getHours()))\r\n        + ':' +\r\n        ((now.getMinutes() < 10) ? (\"0\" + now.getMinutes()) : (now.getMinutes()))\r\n        + ':' +\r\n        ((now.getSeconds() < 10) ? (\"0\" + now.getSeconds()) : (now.getSeconds()))\r\n    );\r\n}\r\n\r\nfunction calculateDistance(lLatLngs){\r\n\tvar totalDistance = 0;\r\n\tvar lastPoint;\r\n\tif(lLatLngs.length>0) lastPoint = lLatLngs[0];\r\n\r\n\tjQuery.each(lLatLngs, function( i, point){\r\n\t\ttotalDistance += point.distanceTo(lastPoint);\r\n\t\tlastPoint = point;\r\n\t});\r\n\treturn L.GeometryUtil.readableDistance(totalDistance, true);\r\n}\r\n\r\nfunction calculateArea(layer){\r\n\tvar totalArea = getAreaLayer(layer);\r\n\treturn L.GeometryUtil.readableArea(totalArea, true);\r\n}\r\n\r\nfunction getAreaLayer(layer){\r\n\tvar totalArea = 0,\r\n\t\tlLatLngs;\r\n\r\n\tif (layer._layers){\r\n\t\tlayer.eachLayer(function (layer) {\r\n\t\t\ttotalArea += getAreaLayer(layer);\r\n\t\t});\r\n\r\n\t}else if(layer.length > 0){\r\n\t\tfor(var i=0; i<layer.length;i++){\r\n\t\t\tlLatLngs = new L.latLng(0,0);\r\n\t\t\tif(layer[i].lat && layer[i].lng){\r\n\t\t\t\tlLatLngs = new L.latLng(layer[i].lat,layer[i].lng);\r\n\t\t\t}\r\n\t\t\ttotalArea += L.GeometryUtil.geodesicArea(lLatLngs);\r\n\t\t}\r\n\r\n\t}else{\r\n\t\tlLatLngs = layer.getLatLngs();\r\n\t\ttotalArea = L.GeometryUtil.geodesicArea(lLatLngs);\r\n\t}\treturn totalArea;\r\n}\r\n\r\nfunction transformTipusGeometry(geometrytype){\r\n\tvar ftype = geometrytype;\r\n\tif (ftype){\r\n\t\tftype = ftype.toLowerCase();\r\n\t\tif (ftype === t_point){\r\n\t\t\tftype = t_marker;\r\n\t\t}else if (ftype === t_linestring){\r\n\t\t\tftype = t_polyline;\r\n\t\t}else if (ftype === t_multilinestring){\r\n\t\t\tftype = t_polyline;\r\n\t\t}else if (ftype === t_multipolygon){\r\n\t\t\tftype = t_polygon;\r\n\t\t}\r\n\t}\r\n\treturn ftype;\r\n}\r\n\r\nfunction hexToRgb(hex) {\r\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n    return result ? {\r\n        r: parseInt(result[1], 16),\r\n        g: parseInt(result[2], 16),\r\n        b: parseInt(result[3], 16)\r\n    } : {r:0,g:0,b:0};\r\n}\r\n\r\nfunction hexToRgba(hex, opacity) {\r\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n    return result ? {\r\n        r: parseInt(result[1], 16),\r\n        g: parseInt(result[2], 16),\r\n        b: parseInt(result[3], 16),\r\n        a: opacity,\r\n    } : {r:0,g:0,b:0,a:1};\r\n}\r\n\r\nfunction hex(x) {\r\n\tvar hexDigits = new Array(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\");\r\n\treturn isNaN(x) ? \"00\" : hexDigits[(x - x % 16) / 16] + hexDigits[x % 16];\r\n}\r\n\r\n/**Function to convert hex format to a rgb color (incloent si passes transparencia o no)*/\r\nfunction rgb2hex(rgb){\r\n rgb = rgb.match(/^rgba?[\\s+]?\\([\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?/i);\r\n return (rgb && rgb.length === 4) ? \"#\" +\r\n  (\"0\" + parseInt(rgb[1],10).toString(16)).slice(-2) +\r\n  (\"0\" + parseInt(rgb[2],10).toString(16)).slice(-2) +\r\n  (\"0\" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';\r\n}\r\n\r\n/**Funcio per obtenir la transparencia d'un rgb*/\r\nfunction getRgbAlpha(rgba){\r\n\t var alpha=rgba.replace(/^.*,(.+)\\)/,'$1');\r\n\t return jQuery.trim(alpha);\r\n}\r\n\r\nfunction getMidaFromRadius(radius){\r\n\tif(radius == 8)return 21;\r\n\telse if(radius == 10)return 24;\r\n\telse if(radius == 12)return 30;\r\n\telse if(radius == 14)return 34;\r\n\telse return 16;\r\n}\r\n\r\nfunction getMidaFromFont(font){\r\n\tif(font == 'font15')return 30;\r\n\telse if(font == 'font12')return 24;\r\n\telse if(font == 'font11')return 21;\r\n\telse if(font == 'font9')return 16;\r\n\telse return 34;\r\n}\r\n\r\nfunction getRadiusFromMida(mida){\r\n\tif(mida == \"21px\")return 8;\r\n\telse if(mida == \"24px\")return 10;\r\n\telse if(mida == \"30px\")return 12;\r\n\telse if(mida == \"34px\")return 14;\r\n\telse return 6;\r\n}\r\n\r\nfunction getColorAwesomeMarker(markerColor, defaultColor){\r\n\tif(markerColor.indexOf(\"punt_r\")!=-1) return defaultColor;\r\n\telse if(markerColor.indexOf(\"orange\")!=-1) return \"#ffc500\";\r\n\telse if(markerColor.indexOf(\"darkorange\")!=-1) return \"#ff7f0b\";\r\n\telse if(markerColor.indexOf(\"red\")!=-1) return \"#ff4b3a\";\r\n\telse if(markerColor.indexOf(\"purple\")!=-1) return \"#ae59b9\";\r\n\telse if(markerColor.indexOf(\"blue\")!=-1) return \"#00afb5\";\r\n\telse if(markerColor.indexOf(\"green\")!=-1) return \"#7cbd00\";\r\n\telse if(markerColor.indexOf(\"darkgray\")!=-1) return \"#90a6a9\";\r\n\telse if(markerColor.indexOf(\"gray\")!=-1) return \"#ebf0f1\";\r\n}\r\n\r\nfunction parseUrlTextPopUp(txt,key){\r\n\t//console.debug(txt);\r\n\tif (key.toLowerCase() != \"geomorigen\"){\r\n\t    var parseText = \"\";\r\n\t    var isWkt=validateWkt(txt);\r\n\t    if (!isWkt) {\r\n\t\t    if(!$.isNumeric(txt) && (key=='link' || key=='Web')){\r\n\t\t          if( isImgURL(txt)){\r\n\t\t        \t  parseText = '<img width=\"100%\" src=\"'+txt+'\"/>';\r\n\t\t          }else if( txt.match(\"^http\")){\r\n\t\t              parseText = '<a target=\"_blank\" href=\"'+txt+'\"/>'+txt+'</a>';\r\n\t\t          }else{\r\n\t\t              parseText = '<a target=\"_blank\" href=\"http://'+txt+'\"/>'+txt+'</a>';\r\n\t\t          }\r\n\t\t          return parseText;\r\n\t\t    }\r\n\t\t\r\n\t\t    if (!$.isNumeric(txt)) {\r\n\t\t          if(txt.indexOf(\"href\")!= -1 || txt.indexOf(\"<a\")!= -1 || \r\n\t\t                 txt.indexOf(\"<img\")!= -1 || txt.indexOf(\"<iframe\")!= -1 ){\r\n\t\t                 return txt;\r\n\t\t          }\r\n\t\t    }\r\n\t\t\r\n\t\t\tvar lines = txt.split(/\\n/);\r\n\t\t\tfor(lineNum in lines)\r\n\t\t\t{\r\n\t\r\n\t\t\t\tvar line = lines[lineNum];\r\n\t\t\t    var lwords = line.split(\" \");\r\n\t\t\t    for(index in lwords){\r\n\t\t\t          var text;\r\n\t\t\t          var word = lwords[index];\r\n\t\t\t          if(!$.isNumeric(txt) ){\r\n\t\t\t                 if (isValidURL(word)){\r\n\t\t\t                 \t\tvar hasProtocol = ((-1 != word.indexOf('http://')) || (-1 != word.indexOf('https://')) || (-1 != word.indexOf('ftp://')))\r\n\t\t\t                        if(isImgURL(word)){\r\n\t\t\t                               text = \"<img src=\\\"\" + (!hasProtocol ? \"http://\" + word : word) + \"\\\" alt=\\\"img\\\" class=\\\"popup-data-img\\\"/>\";\r\n\t\t\t                        }\r\n\t\t\t                        else if (word.indexOf(\"html?\") != -1){\r\n\t\t\t                               text = \"<iframe width=\\\"100%\\\" height=\\\"200\\\" frameborder=\\\"0\\\" marginheight=\\\"0\\\"\"+\r\n\t\t\t                                            \"marginwidth=\\\"0\\\" src=\\\"\"+(!hasProtocol ? \"http://\" + word : word)+\"\\\"></iframe>\";\r\n\t\t\t                        }else if (txt.indexOf(\"<video\")==-1){\r\n\t\t\t                               text = \"<a href=\\\"\"+(!hasProtocol ? \"http://\" + word : word)+\"\\\" target=\\\"_blank\\\">\"+word.replace(\"http://\", \"\")+\"</a>\";\r\n\t\t\t                        }\r\n\t\t\t                        else text=word;\r\n\t\t\t                 }else{\r\n\t\t\t                        text = word;\r\n\t\t\t                 }\r\n\t\t\t\r\n\t\t\t          }else{\r\n\t\t\t                 text = word;\r\n\t\t\t          }\r\n\t\t\t          parseText+=\" \"+text;\r\n\t\t\t    }\r\n\t\r\n\t\t\t    if(\"\" == line)\r\n\t\t\t\t\tparseText += \"<br />\";\r\n\t\t\t\telse\r\n\t\t\t\t\tparseText += \"\\n\";\r\n\t\r\n\t\t\t}\r\n\t\t    return parseText;\r\n\t    }\r\n\t    else {\r\n\t    \treturn \"isWkt\";\r\n\t    }\r\n\t}\r\n}\r\n\r\nfunction redimensioMapa() {\r\n\tjQuery(window).resize(function() {\r\n\t\tvar factorW = 0, \r\n\t\tfactorH = 0;\r\n\t\t\r\n\t\tif(typeof url('?embed') == \"string\"){//Pel cas visor, embeded\r\n\t\t\tfactorH = 0;\r\n\t\t}else{\r\n\t\t\tfactorH = jQuery('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\r\n\t\t}\r\n\t\tjQuery('#map').css('top', factorH + 'px');\r\n\t\tjQuery('#map').height(jQuery(window).height() - factorH);\r\n\t\tjQuery('#map').width(jQuery(window).width() - factorW);\r\n\t});\r\n\tjQuery(window).trigger('resize');\r\n}\r\n\r\nfunction getLeafletIdFromBusinessId(businessId){\r\n\tfor(val in controlCapes._layers){\r\n\t\tif(controlCapes._layers[val].layer.options.businessId == businessId){\r\n\t\t\t//console.debug(\"leaflet Id:\");\r\n\t\t\t//console.debug(val);\r\n\t\t\treturn val;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction activaPanelCapes(obre) {\r\n\t\r\n\tif (obre) {\r\n\t\t\r\n\t\tjQuery('.leaflet-control-layers').toggle();\r\n\t\t\r\n\t\t//jQuery('.leaflet-control-layers').fadeOut({duration: 'fast'});\r\n\t} else {\r\n\t\t//jQuery('.leaflet-control-layers').fadeOut({duration: 'fast'});\r\n\t\tjQuery('.leaflet-control-layers').toggle();\r\n\t}\r\n\tvar cl,\r\n\t btnDiv;\r\n\tif(jQuery('.bt_llista span')){\r\n\t\tbtnDiv = jQuery('.bt_llista span');\r\n\t}else{\r\n\t\tbtnDiv = jQuery('#dv_bt_layers');\r\n\t}\r\n\tcl = btnDiv.attr('class');\r\n\tif (cl && cl.indexOf('grisfort') != -1) {\r\n\t\tbtnDiv.removeClass('grisfort');\r\n\t\tbtnDiv.addClass('greenfort');\r\n\t} else {\r\n\t\tbtnDiv.removeClass('greenfort');\r\n\t\tbtnDiv.addClass('grisfort');\r\n\t}\r\n\r\n\tif(getModeMapa()){updateSortablesElements();}\r\n\r\n}\r\n\r\nfunction gestionaPopOver(pop) {\r\n\t//console.debug(\"gestionaPopOver\");\r\n\tjQuery('.popover').popover('hide');\r\n\tjQuery('.pop').not(pop).popover('hide');\r\n\tjQuery(pop).popover('toggle');\r\n\tjQuery(\".popover\").css('left', pLeft());\r\n\tjQuery('.popover-title').append('<span id=\"popovercloseid#'+jQuery(pop).attr('id')+'\" class=\"glyphicon glyphicon-remove bt_tanca\"></span>');\r\n}\r\n\r\nfunction pLeft() {\r\n\treturn jQuery(\".leaflet-left\").css('left');\r\n}\r\n\r\nfunction gestioCookie(from){\r\n\tvar _cookie = Cookies.get('uid');\r\n\r\n\tswitch(from){\r\n\t\tcase 'createMap':\r\n\t\t\tif (isRandomUser(_cookie)){\r\n\t\t\t\tCookies.remove('uid');\r\n\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t}else{\r\n\t\t\t\twindow.location.href = paramUrl.galeriaPage;\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'createMapError':\r\n\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\tbreak;\r\n\t\tcase 'getMapByBusinessId2':\r\n\t\t\tif (isRandomUser(_cookie)){\r\n\t\t\t\tCookies.remove('uid');\r\n\t\t\t\tjQuery(window).off('beforeunload');\r\n\t\t\t\t//jQuery(window).off('unload');\r\n\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t}else{\r\n\t\t\t\twindow.location.href = paramUrl.galeriaPage+\"?private=1\";\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'getMapByBusinessId':\r\n\t\t\tif (!_cookie){\r\n\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t}else{\r\n\t\t\t\tif (isRandomUser(_cookie)){\r\n\t\t\t\t\tCookies.remove('uid');\r\n\t\t\t\t\tjQuery(window).off('beforeunload');\r\n\t\t\t\t\t//jQuery(window).off('unload');\r\n\t\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t\t}else{\r\n\t\t\t\t\twindow.location.href = paramUrl.galeriaPage;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'loadApp':\r\n\t\t\tif (!_cookie){\r\n\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'diferentUser':\r\n\t\t\tvar mapacolaboratiu = url('?mapacolaboratiu');\r\n\t\t\tif (mapacolaboratiu && mapacolaboratiu=='si'){\r\n\t\t\t\tCookies.set('collaborateuid', url('?uid'));\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tCookies.remove('collaborateuid', { path: '/' });\r\n\t\t\t\tif (mapConfig.entitatUid != _cookie){\r\n\t\t\t\t\tCookies.remove('uid');\r\n\t\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'loadMapConfig':\r\n\t\t\tif (isRandomUser(_cookie) ){\r\n\t\t\t\tCookies.remove('uid');\r\n\t\t\t\tjQuery(window).off('beforeunload');\r\n\t\t\t\twindow.location.href = paramUrl.mainPage;\r\n\t\t\t}else{\r\n\t\t\t\twindow.location.href = paramUrl.galeriaPage;\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'carregaDadesUsuari':\r\n\t\t\twindow.location.href = paramUrl.loginPage;\r\n\t\t\tbreak;\r\n\t\tcase 'refrescaPopOverMevasDades':\r\n\t\t\twindow.location.href = paramUrl.loginPage;\r\n\t\t\tbreak;\r\n\t\tcase 'getMapByBusinessIdError':\r\n\t\t\twindow.location.href = paramUrl.loginPage;\r\n\t\t\tbreak;\r\n\t\tcase 'mapaBloquejat':\r\n\t\t\t//Temps vida cookie bloqueig: 2 hores\r\n\t\t\tCookies.set('lockCookie', _cookie, {\r\n\t\t\t    expires: 1/12\r\n\t\t\t});\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nfunction popUp(f, l) {\r\n\tvar out = [];\r\n\tif (f.properties) {\r\n\t\tfor (key in f.properties) {\r\n\t\t\tif(key!='gml_id'){\r\n\t\t\t\tif(key=='Name' || key=='Description'){\r\n\t\t\t\t\tout.push(f.properties[key]);\r\n\t\t\t\t}else if(key=='link' || key=='Web'){\r\n\t\t\t\t\tll=f.properties[key];\r\n\t\t\t\t\t//if(ll.indexOf('.gif')!=-1 || ll.indexOf('.jpg')!=-1){\r\n\t\t\t\t\tif(isImgURL(ll)){\r\n\t\t\t\t\t\tout.push('<img width=\"100\" src=\"'+ll+'\"/>');\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tout.push('<b>'+key +'</b>: <a target=\"_blank\" href=\"http://'+ll+'\"/>'+ll+'</a>');\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tout.push(\"<b>\"+key + \"</b>: \" + f.properties[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tl.bindPopup(out.join(\"<br />\"));\r\n\t}\r\n}\r\n\r\nfunction aturaClick(event){\r\n\ttry{\r\n\t\tevent.stopImmediatePropagation();\r\n\t}catch(err){\r\n\t\tconsole.info(err);\r\n\t}\r\n}\r\n\r\n//Funcions d'estils\r\nfunction retornaEstilaDO(dataset) {\r\n\tvar estil = { radius : 6, fillColor : \"#FC5D5F\", color : \"#ffffff\", weight : 2, opacity : 1, fillOpacity : 0.8, isCanvas: true };\r\n\tif(dataset==\"radars\"){ estil.fillColor = \"#A00698\";}\r\n\telse if(dataset==\"turisme_rural\"){ estil.fillColor = \"#06A010\";}\r\n\telse if(dataset==\"hotels\"){ estil.fillColor = \"#ED760E\";}\r\n\telse if(dataset==\"incidencies\"){ estil.fillColor = \"#991032\";}\r\n\telse if(dataset==\"cameres\"){ estil.fillColor = \"#495CBC\";}\r\n\telse if(dataset==\"campings\"){ estil.fillColor = \"#62A50B\";}\r\n\telse if(dataset==\"meteo_comarca\"){ estil.fillColor = \"#200BA5\";}\r\n\telse if(dataset==\"meteo_costa\"){ estil.fillColor = \"#E1EA3A\";}\r\n\telse if(dataset==\"json_president\"){ estil.fillColor =\"#0058A5\"; estil.color =\"#0058A5\"; }\r\n\telse{ estil.fillColor = randomColor();}\r\n\treturn estil;\r\n}\r\n\r\nfunction randomColor(){\r\n\treturn '#'+Math.floor(Math.random()*16777215).toString(16);\r\n}\r\n\r\n\r\n\r\nfunction getRamdomColorFromArray() {\r\n\tvar colors = ['#ffc500', '#ff7f0b', '#ff4b3a', '#ae59b9', '#00afb5', '#7cbd00', '#90a6a9', '#ebf0f1'];\r\n   return colors[Math.floor(Math.random() * colors.length)];\r\n}\r\n\r\n//Comptador mida dun objecte\r\n$.extend({\r\n    keyCount : function(o) {\r\n        if(typeof o == \"object\") {\r\n            var i, count = 0;\r\n            for(i in o) {\r\n                if(o.hasOwnProperty(i)) {\r\n                    count++;\r\n                }\r\n            }\r\n            return count;\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n});\r\n\r\n//jQuery.fn.myScrollTo = function(elem) {\r\n//    $(this).scrollTop($(this).scrollTop() - $(this).offset().top + $(elem).offset().top);\r\n//    return this;\r\n//};\r\n\r\nfunction getCodiUnic() {\r\n//\tconsole.debug(\"getCodiUnic\");\r\n    return  randomString(2) + Math.floor(Math.random() * (999 + 1)) + \"_\";\r\n}\r\n\r\nfunction randomString(len, charSet) {\r\n    charSet = charSet || 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';\r\n    var randomString = '';\r\n    for (var i = 0; i < len; i++) {\r\n    \tvar randomPoz = Math.floor(Math.random() * charSet.length);\r\n    \trandomString += charSet.substring(randomPoz,randomPoz+1);\r\n    }\r\n//    console.debug(randomString);\r\n    return randomString;\r\n}\r\n\r\nfunction getRandomInt(min, max) {\r\n    return Math.floor(Math.random() * (max - min + 1)) + min;\r\n}\r\n\r\n//Comprovar i forcar carrega dun script\r\nfunction forceLoadScript(path){\r\n\r\n\tvar len = $('script[src*=\"'+path+'\"]').length;\r\n\tconsole.debug(\"len:\");\r\n\tconsole.debug(len);\r\n\tif (len === 0) {\r\n\t        console.debug('script not loaded');\r\n\t        loadScript(path);\r\n\r\n\t        if ($('script[src*=\"'+path+'\"]').length === 0) {\r\n\t        \tconsole.debug('still not loaded');\r\n\t        }\r\n\t        else {\r\n\t        \tconsole.debug('loaded now');\r\n\t        }\r\n    }else{\r\n    \tconsole.debug('script loaded');\r\n    }\r\n}\r\n\r\nfunction loadScript(scriptLocationAndName) {\r\n    var head = document.getElementsByTagName('head')[0];\r\n    var script = document.createElement('script');\r\n    script.type = 'text/javascript';\r\n    script.src = scriptLocationAndName;\r\n    head.appendChild(script);\r\n}\r\n\r\nfunction htmlentities(string, quote_style, charset, double_encode) {\r\n\t  //  discuss at: http://phpjs.org/functions/htmlentities/\r\n\t  // original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\r\n\t  //  revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\r\n\t  //  revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\r\n\t  // improved by: nobbler\r\n\t  // improved by: Jack\r\n\t  // improved by: Rafał Kukawski (http://blog.kukawski.pl)\r\n\t  // improved by: Dj (http://phpjs.org/functions/htmlentities:425#comment_134018)\r\n\t  // bugfixed by: Onno Marsman\r\n\t  // bugfixed by: Brett Zamir (http://brett-zamir.me)\r\n\t  //    input by: Ratheous\r\n\t  //  depends on: get_html_translation_table\r\n\t  //   example 1: htmlentities('Kevin & van Zonneveld');\r\n\t  //   returns 1: 'Kevin &amp; van Zonneveld'\r\n\t  //   example 2: htmlentities(\"foo'bar\",\"ENT_QUOTES\");\r\n\t  //   returns 2: 'foo&#039;bar'\r\n\r\n\t  var hash_map = this.get_html_translation_table('HTML_ENTITIES', quote_style),\r\n\t    symbol = '';\r\n\t  string = string === null ? '' : string + '';\r\n\r\n\t  if (!hash_map) {\r\n\t    return false;\r\n\t  }\r\n\r\n\t  if (quote_style && quote_style === 'ENT_QUOTES') {\r\n\t    hash_map[\"'\"] = '&#039;';\r\n\t  }\r\n\r\n\t  if ( !! double_encode || double_encode === null) {\r\n\t    for (symbol in hash_map) {\r\n\t      if (hash_map.hasOwnProperty(symbol)) {\r\n\t        string = string.split(symbol)\r\n\t          .join(hash_map[symbol]);\r\n\t      }\r\n\t    }\r\n\t  } else {\r\n\t    string = string.replace(/([\\s\\S]*?)(&(?:#\\d+|#x[\\da-f]+|[a-zA-Z][\\da-z]*);|$)/g, function (ignore, text, entity) {\r\n\t      for (symbol in hash_map) {\r\n\t        if (hash_map.hasOwnProperty(symbol)) {\r\n\t          text = text.split(symbol)\r\n\t            .join(hash_map[symbol]);\r\n\t        }\r\n\t      }\r\n\r\n\t      return text + entity;\r\n\t    });\r\n\t  }\r\n\r\n\t  return string;\r\n\t}\r\n\r\nfunction get_html_translation_table(table, quote_style) {\r\n//discuss at: http://phpjs.org/functions/get_html_translation_table/\r\n//original by: Philip Peterson\r\n//revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\r\n//bugfixed by: noname\r\n//bugfixed by: Alex\r\n//bugfixed by: Marco\r\n//bugfixed by: madipta\r\n//bugfixed by: Brett Zamir (http://brett-zamir.me)\r\n//bugfixed by: T.Wild\r\n//improved by: KELAN\r\n//improved by: Brett Zamir (http://brett-zamir.me)\r\n//input by: Frank Forte\r\n//input by: Ratheous\r\n//note: It has been decided that we're not going to add global\r\n//note: dependencies to php.js, meaning the constants are not\r\n//note: real constants, but strings instead. Integers are also supported if someone\r\n//note: chooses to create the constants themselves.\r\n//example 1: get_html_translation_table('HTML_SPECIALCHARS');\r\n//returns 1: {'\"': '&quot;', '&': '&amp;', '<': '&lt;', '>': '&gt;'}\r\nvar entities = {},\r\nhash_map = {},\r\ndecimal;\r\nvar constMappingTable = {},\r\nconstMappingQuoteStyle = {};\r\nvar useTable = {},\r\nuseQuoteStyle = {};\r\n//Translate arguments\r\nconstMappingTable[0] = 'HTML_SPECIALCHARS';\r\nconstMappingTable[1] = 'HTML_ENTITIES';\r\nconstMappingQuoteStyle[0] = 'ENT_NOQUOTES';\r\nconstMappingQuoteStyle[2] = 'ENT_COMPAT';\r\nconstMappingQuoteStyle[3] = 'ENT_QUOTES';\r\nuseTable = !isNaN(table) ? constMappingTable[table] : table ? table.toUpperCase() : 'HTML_SPECIALCHARS';\r\nuseQuoteStyle = !isNaN(quote_style) ? constMappingQuoteStyle[quote_style] : quote_style ? quote_style.toUpperCase() :\r\n'ENT_COMPAT';\r\nif (useTable !== 'HTML_SPECIALCHARS' && useTable !== 'HTML_ENTITIES') {\r\nthrow new Error('Table: ' + useTable + ' not supported');\r\n//return false;\r\n}\r\nentities['38'] = '&amp;';\r\nif (useTable === 'HTML_ENTITIES') {\r\nentities['160'] = '&nbsp;';\r\nentities['161'] = '&iexcl;';\r\nentities['162'] = '&cent;';\r\nentities['163'] = '&pound;';\r\nentities['164'] = '&curren;';\r\nentities['165'] = '&yen;';\r\nentities['166'] = '&brvbar;';\r\nentities['167'] = '&sect;';\r\nentities['168'] = '&uml;';\r\nentities['169'] = '&copy;';\r\nentities['170'] = '&ordf;';\r\nentities['171'] = '&laquo;';\r\nentities['172'] = '&not;';\r\nentities['173'] = '&shy;';\r\nentities['174'] = '&reg;';\r\nentities['175'] = '&macr;';\r\nentities['176'] = '&deg;';\r\nentities['177'] = '&plusmn;';\r\nentities['178'] = '&sup2;';\r\nentities['179'] = '&sup3;';\r\nentities['180'] = '&acute;';\r\nentities['181'] = '&micro;';\r\nentities['182'] = '&para;';\r\nentities['183'] = '&middot;';\r\nentities['184'] = '&cedil;';\r\nentities['185'] = '&sup1;';\r\nentities['186'] = '&ordm;';\r\nentities['187'] = '&raquo;';\r\nentities['188'] = '&frac14;';\r\nentities['189'] = '&frac12;';\r\nentities['190'] = '&frac34;';\r\nentities['191'] = '&iquest;';\r\nentities['192'] = '&Agrave;';\r\nentities['193'] = '&Aacute;';\r\nentities['194'] = '&Acirc;';\r\nentities['195'] = '&Atilde;';\r\nentities['196'] = '&Auml;';\r\nentities['197'] = '&Aring;';\r\nentities['198'] = '&AElig;';\r\nentities['199'] = '&Ccedil;';\r\nentities['200'] = '&Egrave;';\r\nentities['201'] = '&Eacute;';\r\nentities['202'] = '&Ecirc;';\r\nentities['203'] = '&Euml;';\r\nentities['204'] = '&Igrave;';\r\nentities['205'] = '&Iacute;';\r\nentities['206'] = '&Icirc;';\r\nentities['207'] = '&Iuml;';\r\nentities['208'] = '&ETH;';\r\nentities['209'] = '&Ntilde;';\r\nentities['210'] = '&Ograve;';\r\nentities['211'] = '&Oacute;';\r\nentities['212'] = '&Ocirc;';\r\nentities['213'] = '&Otilde;';\r\nentities['214'] = '&Ouml;';\r\nentities['215'] = '&times;';\r\nentities['216'] = '&Oslash;';\r\nentities['217'] = '&Ugrave;';\r\nentities['218'] = '&Uacute;';\r\nentities['219'] = '&Ucirc;';\r\nentities['220'] = '&Uuml;';\r\nentities['221'] = '&Yacute;';\r\nentities['222'] = '&THORN;';\r\nentities['223'] = '&szlig;';\r\nentities['224'] = '&agrave;';\r\nentities['225'] = '&aacute;';\r\nentities['226'] = '&acirc;';\r\nentities['227'] = '&atilde;';\r\nentities['228'] = '&auml;';\r\nentities['229'] = '&aring;';\r\nentities['230'] = '&aelig;';\r\nentities['231'] = '&ccedil;';\r\nentities['232'] = '&egrave;';\r\nentities['233'] = '&eacute;';\r\nentities['234'] = '&ecirc;';\r\nentities['235'] = '&euml;';\r\nentities['236'] = '&igrave;';\r\nentities['237'] = '&iacute;';\r\nentities['238'] = '&icirc;';\r\nentities['239'] = '&iuml;';\r\nentities['240'] = '&eth;';\r\nentities['241'] = '&ntilde;';\r\nentities['242'] = '&ograve;';\r\nentities['243'] = '&oacute;';\r\nentities['244'] = '&ocirc;';\r\nentities['245'] = '&otilde;';\r\nentities['246'] = '&ouml;';\r\nentities['247'] = '&divide;';\r\nentities['248'] = '&oslash;';\r\nentities['249'] = '&ugrave;';\r\nentities['250'] = '&uacute;';\r\nentities['251'] = '&ucirc;';\r\nentities['252'] = '&uuml;';\r\nentities['253'] = '&yacute;';\r\nentities['254'] = '&thorn;';\r\nentities['255'] = '&yuml;';\r\n}\r\nif (useQuoteStyle !== 'ENT_NOQUOTES') {\r\nentities['34'] = '&quot;';\r\n}\r\nif (useQuoteStyle === 'ENT_QUOTES') {\r\nentities['39'] = '&#39;';\r\n}\r\nentities['60'] = '&lt;';\r\nentities['62'] = '&gt;';\r\n//ascii decimals to real symbols\r\nfor (decimal in entities) {\r\nif (entities.hasOwnProperty(decimal)) {\r\nhash_map[String.fromCharCode(decimal)] = entities[decimal];\r\n}\r\n}\r\nreturn hash_map;\r\n}\r\n\r\nfunction getModeMapa(){\r\n\treturn  ($(location).attr('href').indexOf('/mapa.html')!=-1);\r\n}\r\n\r\nfunction sortByKey(array, key) {\r\n    return array.sort(function(a, b) {\r\n        var x = a[key]; var y = b[key];\r\n        return ((x < y) ? -1 : ((x > y) ? 1 : 0));\r\n    });\r\n}\r\n\r\nfunction sortByKeyPath(array, key) {\r\n\t\r\n\treturn array.sort(function(a, b) {\r\n\t\t var x = a.layer.options[key]; var y = b.layer.options[key];\r\n\t\treturn ((x < y) ? -1 : ((x > y) ? 1 : 0));\r\n    });\r\n}\r\n\r\nfunction sortByValueMax(a, b){\r\n\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\tvar floatRegex2 = new RegExp('(^-?0\\,[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\t\r\n\tif (a!=null && b!=null) {\r\n\t\tvar aValue;\r\n\t\tif (a.value!=undefined) aValue= a.value;\r\n\t\telse if (a.v!=undefined) aValue=a.v;\r\n\t\telse aValue = a;\r\n\t\r\n\t\t\r\n\t\tvar bValue;\r\n\t\tif (b.value!=undefined) bValue= b.value;\r\n\t\telse if (b.v!=undefined) bValue=b.v;\r\n\t\telse bValue =b;\r\n\t\tvar aValueStr = \"\"+aValue;\r\n\t\tvar bValueStr = \"\"+bValue;\r\n\t\tif (floatRegex.test(aValue) && floatRegex.test(bValue)) {\r\n\t\t\tif (aValueStr.indexOf(\",\")>-1){\r\n\t\t\t\tif (aValueStr.indexOf(\".\")>-1){\r\n\t\t\t\t\taValue=aValue.replace(\".\",\"\");\r\n\t\t\t\t\taValue=aValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\taValue = aValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (aValueStr.indexOf(\"-\")>-1 && aValue.substring(0,aValue.indexOf(\"-\"))!=\"\") aValue=aValue.substring(0,aValue.indexOf(\"-\"));\r\n\t\r\n\t\t\tif (bValueStr.indexOf(\",\")>-1){\r\n\t\t\t\tif (bValueStr.indexOf(\".\")>-1){\r\n\t\t\t\t\tbValue=bValue.replace(\".\",\"\");\r\n\t\t\t\t\tbValue=bValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tbValue = bValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (bValueStr.indexOf(\"-\")>-1 && bValue.substring(0,bValue.indexOf(\"-\"))!=\"\") bValue=bValue.substring(0,bValue.indexOf(\"-\"));\r\n\t\t\treturn (aValue-bValue);\r\n\t\t}\r\n\t\telse if (floatRegex2.test(aValue) && floatRegex2.test(bValue)) {\r\n\t\t\tif (aValueStr.indexOf(\",\")>-1){\r\n\t\t\t\tif (aValueStr.indexOf(\".\")>-1){\r\n\t\t\t\t\taValue=aValue.replace(\".\",\"\");\r\n\t\t\t\t\taValue=aValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\taValue = aValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (aValueStr.indexOf(\"-\")>-1 && aValue.substring(0,aValue.indexOf(\"-\"))!=\"\") aValue=aValue.substring(0,aValue.indexOf(\"-\"));\r\n\t\t\tif (bValueStr.indexOf(\",\")>-1){\r\n\t\t\t\tif (bValueStr.indexOf(\".\")>-1){\r\n\t\t\t\t\tbValue=bValue.replace(\".\",\"\");\r\n\t\t\t\t\tbValue=bValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tbValue = bValue.replace(\",\",\".\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (bValueStr.indexOf(\"-\")>-1 && bValue.substring(0,bValue.indexOf(\"-\"))!=\"\") bValue=bValue.substring(0,bValue.indexOf(\"-\"));\r\n\t\t\treturn (aValue-bValue);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tvar aName = aValueStr.toLowerCase();\r\n\t\t\tvar bName = bValueStr.toLowerCase();\r\n\t\t\treturn ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction isMobile() {\r\n\t try {\r\n\t    if(/Android|webOS|iPhone|iPad|iPod|pocket|psp|kindle|avantgo|blazer|midori|Tablet|Palm|maemo|plucker|phone|BlackBerry|symbian|IEMobile|mobile|ZuneWP7|Windows Phone|Opera Mini/i.test(navigator.userAgent)) {\r\n\t     return true;\r\n\t    };\r\n\t    return false;\r\n\t } catch(e){ console.log(\"Error in isMobile\"); return false; }\r\n}\r\n\r\n\r\nfunction isChrome(){\r\n\r\nvar isChromium = window.chrome,\r\nvendorName = window.navigator.vendor;\r\n\t\r\nvar _hoSoc=false;\r\n\t\t\r\n\t\tif(isChromium !== null && isChromium !== undefined && vendorName === \"Google Inc.\") {\r\n\t\t\t_hoSoc=true;\r\n\t\t}\r\n\r\n\treturn _hoSoc;\t\r\n\r\n\t\r\n}\t\r\n\r\nfunction refrescarPopUp(nom,props,_leaflet_id,type,capaLeafletId){\r\n\tvar html='';\r\n\thtml+='<h4 class=\"my-text-center\">'+nom+'</h4>';\r\n\t\r\n\t\r\n\tvar isADrawarker=false;\r\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t$.each(props, function( key, value ) {\r\n\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\r\n\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \r\n\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \r\n\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\r\n\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\r\n\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\tvar txt=value;\r\n\t\t\t\tif (!$.isNumeric(txt)) {\r\n\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\r\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t'</div>';\r\n\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\tif(undefined != capa.isPropertyNumeric && capa.isPropertyNumeric[key] && ((\"\" == origen) || (\"\" != origen && (key == capa.options.trafficLightKey))))\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tvar leafletid = ((\"undefined\" !== typeof player.properties.capaLeafletId) ? player.properties.capaLeafletId : (capa.hasOwnProperty(\"layer\") ? capa.layer._leaflet_id : \"\"));\r\n\t\t\t\t\t\t//Només ensenyem la icona del semafòric si és una capa no temàtica o bé si ho és però és semafòrica sense semàfor fixe (sempre que el camp sigui numèric)\r\n\t\t\t\t\t\thtml+='<div class=\"traffic-light-icon\" data-leafletid=\"' + leafletid + '\" data-origen=\"' + origen + '\" title=\"'+window.lang.translate('Temàtic per escala de color')+'\"></div>';\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\thtml+= '</div>';\r\n\t\t\t\tif (key=='text' || key=='TEXT') isADrawarker=true;\r\n\t\t\t\telse isADrawarker=false;\r\n\t\t\t}\r\n\t\t}\r\n\t});\t\r\n\tconsole.debug(_leaflet_id);\r\n\tconsole.debug(type);\r\n\tconsole.debug(capaLeafletId);\r\n\thtml +='<div id=\"footer_edit\"  class=\"modal-footer\">'\r\n\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\r\n\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\r\n\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\r\n\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>';\r\n\thtml+='<li class=\"edicio-popup\" id=\"feature_data_table_'+_leaflet_id+'\"><a id=\"feature_data_table##'+_leaflet_id+'##'+type+'##'+capaLeafletId+'##\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>';\t\t\t\t\t\r\n\r\n\t\t\r\n\thtml+='<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#finestrapunt\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>';\r\n\t\r\n\thtml+='</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t+'</div>'\r\n\treturn html;\r\n\t\r\n}\r\n\r\nfunction changeWMSQueryable(queryable){\t\r\n\tmap.eachLayer(function (layer) { \r\n\t  try{\t \r\n\t \r\n\t\tlayer.options && layer.options.tipus && layer.options.tipus=='wms'?layer.options.queryable=queryable: null\t \r\n\t  }catch(err){\r\n\t\t  console.debug(err);\r\n\t  }  \r\n\t});\r\n}\t\r\n\r\n\r\n\r\nfunction decimalComa(nStr) {\r\n\tnStr += '';\r\n\tnStr = nStr.replace(\".\", \",\");\r\n\r\n\tx = nStr.split(',');\r\n\tx1 = x[0];\r\n\tx2 = x.length > 1 ? ',' + x[1] : '';\r\n\tvar rgx = /(\\d+)(\\d{3})/;\r\n\twhile (rgx.test(x1)) {\r\n\r\n\t\tx1 = x1.replace(rgx, '$1' + '.' + '$2');\r\n\t}\r\n\treturn x1 + x2;\r\n}\r\n\r\n\r\n\r\n(function($){\r\n\tvar o = $({});\r\n\t$.each({\r\n\t\ttrigger: 'publish',\r\n\t\ton: 'subscribe',\r\n\t\toff: 'unsubscribe'\r\n\t},function(key, val){\r\n\t\t$[val] = function(){\r\n\t\t\to[key].apply(o, arguments);\r\n\t\t};\r\n\t});\r\n\t\r\n\t$('body').on('change', 'input[type=\"text\"], input[type=\"password\"], textarea', function(){\r\n\t\t$(this).val(cleanScriptCode($(this).val()));\r\n\t});\r\n\t\r\n})(jQuery);\r\n\r\nfunction createClass(name,rules){\r\n    var style = document.createElement('style');\r\n    style.type = 'text/css';\r\n    document.getElementsByTagName('head')[0].appendChild(style);\r\n    if(!(style.sheet||{}).insertRule) \r\n        (style.styleSheet || style.sheet).addRule(name, rules);\r\n    else\r\n        style.sheet.insertRule(name+\"{\"+rules+\"}\",0);\r\n}\r\n\r\nfunction cleanScriptCode(txt){\r\n\tvar SCRIPT_REGEX = /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi;\r\n\twhile (SCRIPT_REGEX.test(txt)) {\r\n\t\ttxt = txt.replace(SCRIPT_REGEX, \"\");\r\n\t}\t\r\n\treturn txt;\r\n}\r\n\r\nfunction shortString(str,_length){\r\n\tif(str){\r\n\t\tstr.length > _length ?str=(str.substring(0,_length)+\"...\"):str;\r\n\t}\r\n\treturn str;\t\r\n}\t\r\n\r\nfunction validateWkt(txt){\r\n\tvar isWkt = false;\r\n\tif (typeof (txt) == \"string\") {\r\n\t\tisWkt = txt.indexOf(\"POLYGON\")>-1 || txt.indexOf (\"POINT\")>-1 || txt.indexOf(\"LINE\")>-1;\r\n\t}\t\r\n\treturn isWkt;\r\n}\r\n\r\nString.prototype.replaceAll = function(target, replacement) {\r\n  return this.split(target).join(replacement);\r\n};\r\n\r\n\tvar EuCountryCodes = new Array( 'be','bg', 'cz','dk','de','ee','ie','el','es','fr','it','cy','lv','lt','lu','hu','mt','nl','at','pl','pt','ro','si','sk','fi','se','uk','is','no','hr');\r\n\tvar EuCountryNamesEN = {'be': 'Belgium','bg': 'Bulgaria','cz': 'Czech Republic','dk': 'Denmark','de': 'Germany','ee': 'Estonia','ie': 'Ireland','el': 'Greece','es': 'Spain','fr': 'France','it': 'Italy','cy': 'Cyprus','lv': 'Latvia','lt': 'Lithuania','lu': 'Luxembourg','hu': 'Hungary','mt': 'Malta','nl': 'Netherlands','at': 'Austria','pl': 'Poland','pt': 'Portugal','ro': 'Romania','si': 'Slovenia','sk': 'Slovakia','fi': 'Finland','se': 'Sweden','uk': 'United Kingdom','is': 'Iceland','no': 'Norway','hr': 'Croatia','li': 'Liechtenstein','tr': 'Turkey','ch': 'Switzerland','eu': 'European Union' };\r\n\tvar EuCountryNames = { \t'be':'Bèlgica', 'bg':'Bulgària', 'cz':'República Txeca', 'dk':'Dinamarca', 'de':'Alemanya', 'ee':'Estònia', 'ie':'Irlanda', 'el':'Grècia', 'es':'Espanya', 'fr':'França', 'it':'Itàlia', 'cy':'Xipre', 'lv':'Letònia', 'lt':'Lituània', 'lu':'Luxemburg', 'hu':'Hongria', 'mt':'Malta', 'nl':'Països Baixos', 'at':'Àustria', 'pl':'Polònia', 'pt':'Portugal', 'ro':'Romania', 'si':'Eslovènia', 'sk':'Eslovàquia', 'fi':'Finlàndia', 'se':'Suècia', 'uk':'Regne Unit', 'is':'Islàndia', 'no':'Noruega', 'hr':'Croàcia', 'li':'Liechtenstein', 'tr':'Turquia', 'ch':'Suïssa', 'eu':'Unió Europea' };\r\n\tvar EuCountryBBOX = {\"al\":\"19.28168,39.64765,21.05782,42.66108\",\"at\":\"9.52998,46.37245,17.16080,49.01529\", \"ba\":\"15.72873,42.55977,19.62363,45.27632\", \"be\":\"2.54601,49.49724,6.40503,51.50246\", \"bg\":\"22.35718,41.23593,28.60746,44.21566\", \"by\":\"23.17834,51.26285,32.76946,56.17222\", \"ch\":\"5.95607,45.82264,10.49204,47.80146\", \"cy\":\"32.27442,34.56750,34.58717,35.69489\", \"cz\":\"12.09221,48.55176,18.84376,51.05495\", \"de\":\"5.86632,47.27013,15.04180,54.91165\", \"dk\":\"8.07534,54.80484,10.95898,57.07808\", \"ee\":\"23.40401,57.50931,28.20842,59.66855\", \"el\":\"20.00881,37.65570,26.62996,41.74850\", \"el\":\"21.10524,36.38543,23.52390,38.33868\", \"es\":\"-9.29803,36.00705,3.32232,43.78991\", \"fi\":\"20.55038,59.81231,31.58627,70.09227\", \"hr\":\"13.48987,42.93842,19.44735,46.54657\", \"hu\":\"16.11385,45.73705,22.89627,48.58523\", \"ie\":\"-10.48000,51.45107,-6.01468,55.38264\", \"is\":\"-24.53084,63.39450,-13.49510,66.53758\", \"it\":\"6.63000,37.91603,18.52059,47.09173\", \"li\":\"9.47605,47.05180,9.63326,47.27094\", \"lt\":\"21.04881,53.89667,26.83181,56.44985\", \"lu\":\"5.73576,49.45110,6.52973,50.18278\", \"lv\":\"20.97068,55.67687,28.24145,58.08558\", \"md\":\"26.61875,45.46630,30.16649,48.49196\", \"me\":\"18.43355,41.85313,20.35293,43.55870\", \"mk\":\"20.45242,40.85490,23.03406,42.37160\", \"nl\":\"3.43372,50.75345,7.22750,53.46593\", \"no\":\"4.94090,57.98025,31.06381,71.13312\", \"pl\":\"14.12762,49.00248,24.14578,54.83409\", \"pt\":\"-9.50053,36.96317,-6.18935,42.15442\", \"ro\":\"20.26430,43.62074,29.68696,48.26064\", \"rs\":\"18.84816,41.85779,23.00583,46.18793\", \"se\":\"11.11105,55.33685,24.15514,69.06008\", \"si\":\"13.37549,45.42493,16.59681,46.87630\", \"sk\":\"16.83326,47.73140,22.56684,49.61377\", \"tr\":\"26.06056,35.80857,44.81861,42.09693\", \"tr\":\"26.03482,40.04417,29.11728,42.09850\", \"ua\":\"22.13799,44.38787,40.22820,52.37523\", \"uk\":\"-6.22738,49.95864,1.76303,58.67236\", \"mt\":\"14.1311,35.8161,15.5685,36.0557\", \"fr\":\"-4.79544,42.33339,8.23257,51.08938\"}\r\n\t\r\n\t\r\nfunction stringBBOXtoArray(strBBOX){\r\n\tvar _BBOX=strBBOX.split(\",\");\r\n\treturn _BBOX;\r\n}\t\r\n\r\n\r\nfunction treuAccentsiEspais(nomIndexacio){\r\n\r\n\tnomIndexacio=nomIndexacio.replace(/[^0-9a-zA-Z ]/g, \"\");\r\n\tnomIndexacio=nomIndexacio.replace(/\\s/g, \"-\");\r\n\r\nreturn nomIndexacio;\t\r\n\t\r\n}\t\r\n\r\n\r\n\r\nfunction _escriuDebug(_debug, _scope,_linia){\r\n\t\r\n\tif(_globalDebug){\t\r\n\t\tconsole.debug(_scope +\" Linia:\"+_linia);\r\n\t\tconsole.debug(_debug);\r\n\t\tconsole.debug(\"****************\");\r\n\t}\t\r\n\t\r\n}\r\nfunction controlarBloqueigMapa(){\r\n\t lockController = SessionTimeout({\r\n\t\t warnAfter: 28700000, //desenv: 10000,//prod: 28700000,\r\n\t\t redirAfter: 28800000, //desenv: 15000,//prod: 8 hores = 28800000 ms\r\n         ignoreUserActivity: true,\r\n         keepAlive: false,\r\n         logoutButton: window.lang.translate('Sortir'),\r\n         title: window.lang.translate('Desbloquejar mapa'),\r\n         message: window.lang.translate('Han transcorregut 8 hores des que heu iniciat la sessió de treball. Premeu \"Continuar treballant\" per mantenir-la  oberta, o \"desbloquejar\" per alliberar el mapa. '+\r\n        \t\t \t\t\t\t\t\t'Si no responeu, el mapa quedarà alliberat en 3 minuts.'),\r\n         onWarn: function(){\r\n         },\r\n         onRedir: function () {\r\n        \t timeoutBloqueig = window.setTimeout(\"treureBloqueigMapa()\", 28980000);//desenv: 30000); //prod: 8 hores i 3 minuts = 28980000 ms\r\n        \t $('#dialog_bloqueig_mapa').modal('show');   \r\n        \t\r\n         }\r\n   });\r\n}\r\n\r\nfunction treureBloqueigMapa(){\r\n\tvar mapData = {\r\n  \t\t\tbusinessId: url('?businessid'),\r\n  \t\t\tuid: Cookies.get('uid')\r\n  \t };\r\n\t desbloquejarMapa(mapData).then(function(results){\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\t$.when.apply(null, runningActions).done(function() {\r\n\t\t\t\t\tlockController.stop();\r\n\t\t\t\t\t$('#dialog_bloqueig_mapa').modal('hide');\r\n\t\t\t\t\twindow.location.href = paramUrl.galeriaPage+\"?private=1\";\r\n        \t\t});\r\n\t\t\t}\r\n\t});\r\n}\r\n\r\nfunction generarScriptMarkupGoogle(url,nom,urlImage,autor,dataPublicacio,descripcio){\r\n\tvar generatedScript = \"{\\\"@context\\\":\\\"http://schema.org\\\",\"+\r\n\t    \"\\\"@type\\\": \\\"Map\\\",\"+\r\n\t    \"\\\"name\\\":\\\"\"+nom+\"\\\",\"+\r\n\t    \"\\\"url\\\":\\\"\"+url+\"\\\",\"+\r\n\t    \"\\\"image\\\":\\\"\"+urlImage+\"\\\",\"+\r\n\t    \"\\\"thumbnailUrl\\\":\\\"\"+urlImage+\"\\\",\"+\r\n\t    \"\\\"author\\\": {\"+\r\n\t    \t\"\\\"@type\\\":  \\\"Person\\\",\"+\r\n\t    \t\"\\\"name\\\":\\\"\"+autor+\"\\\"\"+\r\n\t  \t\"},\"+\r\n\t   \"\\\"datePublished\\\":\\\"\"+dataPublicacio+\"\\\",\"+\r\n\t   \"\\\"description\\\":\\\"\"+descripcio+\"\\\"\"+\r\n\t\t\"}\";\r\n\treturn generatedScript;\r\n}","window.lang = new Lang();\r\n\r\nvar lsLang;\r\nvar Cookies = Cookies.withConverter({\r\n\twrite: function (value, name) {\r\n\t\tif ( name === 'uid' ) {\r\n\t\t\t//Add \" to the string because @ is only a valid Cookie character if it goes between them\r\n\t\t\treturn '\"' + encodeURIComponent(value + \"\").replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,\r\n\t\t\t\tdecodeURIComponent) + '\"';\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\treturn value;\r\n\t\t}\r\n\t},\r\n\tread: function (value, name) {\r\n\t\tif ( name === 'uid' ) {\r\n\t\t\t//Add \" to the string because @ is only a valid Cookie character if it goes between them\r\n\t\t\treturn value.replace(/(%[0-9A-Z]{2})+/g, decodeURIComponent).replace(/\\\"/g, '');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n});\r\n\r\njQuery(document).ready(function() {\r\n\t\r\n\r\n\tweball_tornarInici();\r\n\tlang.dynamic('en', '/geocatweb/js/language/en.json');\r\n\tlang.dynamic('es', '/geocatweb/js/language/es.json');\r\n\twindow.lang.init({\r\n        defaultLang: 'ca'\r\n    });\r\n\tlsLang=web_determinaIdioma();\r\n\tisEditing = edit = (\"mapa\" == url('filename'));\r\n\tif (lsLang == null || lsLang == \"null\"){\r\n\t\tlsLang = \"ca\";\r\n\t\tcanviaIdioma(lsLang);\r\n\t}\r\n\tweb_menusIdioma(lsLang);\r\n\t\r\n\tinitHover();\r\n\tcheckUserLogin();\r\n    //dialeg expired\r\n    jQuery('#dialog_session_expired').on('hidden.bs.modal', function (e) {\r\n    \tlogoutUser();\r\n    });\r\n    initCookies();\r\n    \r\n    if ($(\".centered-form\").length > 0){\r\n    \tcontrolLandingForm();\r\n    }\r\n    cambiarTitle();\r\n});\r\n\r\nfunction initCookies(){\r\n\twindow.cookieconsent.initialise({\r\n\t\tcookies: {domain: 'instamaps.cat', analytics: {}},\r\n\t\tposition: 'bottom',\r\n\t    palette:{\r\n\t      popup: {background: \"#222222\"},\r\n\t      button: {background: \"#00b050\"}\r\n\t    },\r\n\t    content: {\r\n    \t  message: window.lang.translate(\"Per tal de fer el seguiment de visites al nostre lloc web, utilitzem galetes. En cap cas emmagatzemem la vostra informació personal\"),\r\n    \t  dismiss: window.lang.translate(\"Acceptar\")\r\n    \t},\r\n\t    showLink: false,\r\n\t    dismissOnScroll: true,\r\n\t    law: {\r\n\t      regionalLaw: false,\r\n\t    }\r\n\t});\r\n}\r\n\r\nfunction controlLandingForm(){\r\n\t$('.centered-form').transition({ opacity: 100, delay: 600  });\r\n\t//intro per enviament del form\r\n\tjQuery(document).keypress(function(e) {\r\n\t    if(e.which == 13 ) {\r\n\t    \te.preventDefault();\r\n\t    \tif($(\"#landing-form-email\").is(\":focus\")){\r\n\t    \t\tlandingFormButtonClick(\"\");  \r\n\t    \t}else if($(\"#landing-form-email-xs\").is(\":focus\")){\r\n\t    \t\tlandingFormButtonClick(\"-xs\");  \r\n\t    \t}\r\n\t    }\r\n\t});\t\r\n    \r\n    $('#landing-form-email, #landing-form-email-xs').focus(function(){\r\n    \t$('#landing-form-message').html('');\r\n    \t$('#landing-form-email').removeClass(\"invalid-landing-form\");\r\n    \t$('#landing-form-message-xs').html('');\r\n    \t$('#landing-form-email-xs').removeClass(\"invalid-landing-form\");\r\n    });\r\n    \r\n    $('#id-btn-landing-form').on(\"click\", function(){\r\n    \tlandingFormButtonClick(\"\"); \r\n    });\r\n    \r\n    $('#id-btn-landing-form-xs').on(\"click\", function(){\r\n    \tlandingFormButtonClick(\"-xs\");    \t\r\n    });\t\r\n}\r\n\r\nfunction insertDataInstamaper(email){\r\n\tvar defer = $.Deferred();\r\n\t\r\n\tvar dataInsert = {\r\n\t\temail: email,\r\n\t\toptions: curs_instamaps\r\n\t};\r\n\tvar insert_error = \"\";\r\n\tregistreInstamaper(dataInsert).then(function(results){\r\n\t\tif (results.status==\"ERROR\") {\r\n\t\t\t\r\n\t\t\tif(results.results == \"ORA-00001\"){\r\n\t\t\t\tinsert_error = \" (email ja inserit un cop durant el dia d'avui a la taula INSTAMAPERS)\";\r\n\t\t\t\tdefer.reject(insert_error);\r\n\t\t\t}else{\r\n\t\t\t\tinsert_error = \" (email no inserit correctament a la taula INSTAMAPERS)\";\r\n\t\t\t\tdefer.resolve(insert_error);\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tdefer.resolve(insert_error);\r\n\t\t}\r\n\t},function(results){\r\n\t\tinsert_error = \" (email no inserit correctament a la taula INSTAMAPERS)\";\r\n\t\tdefer.resolve(insert_error);\r\n\t});\t\r\n\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction sendEmailInstamaper(email,insert_error, type){//type per saber si es per pantalles petites o grans\r\n\tvar data = {\r\n\t\tuid: Cookies.get('uid'),\r\n\t\tto: instamaps_email,// to,\r\n\t\tsubject: curs_instamaps,\r\n\t\tcontent: email + insert_error,//contingut,\r\n\t\tesColaboratiu: 'N',\r\n\t\tbusinessId: \"\"\r\n\t};\r\n\tsendMail(data).then(function(results){\r\n\t\tif (results.status==\"OK\") {\r\n\t\t\t$('#landing-form-message'+type).html(\r\n\t\t\t\t\t'<div class=\"alert alert-success alert-dismissible\" role=\"alert\">'+\r\n\t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n\t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-ok\"></span></strong> '+window.lang.translate(\"Gràcies. Prenem nota del teu correu i t'avisarem quan comencem el proper taller.\")+'</div>'\r\n\t\t\t);\t\t\t\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\t$('#landing-form-message'+type).html(\r\n\t\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\r\n\t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n\t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"Hi ha hagut un problema amb l'enviament del correu. Torni a intentar-ho.\")+'</div>'\r\n\t\t\t);\r\n\t\t}\r\n\t},function(results){\r\n\t\t$('#landing-form-message'+type).html(\r\n\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\r\n\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"Hi ha hagut un problema amb l'enviament del correu. Torni a intentar-ho.\")+'</div>'\r\n\t\t);\r\n\t});\t\r\n\t\r\n}\r\n\r\nfunction landingFormButtonClick(type){\r\n\r\n\tvar email =  $('#landing-form-email'+type).val();\r\n\t\r\n\tif(isBlank(email)){\r\n\t\t$('#landing-form-email'+type).addClass(\"invalid-landing-form\");\r\n\t\t$('#landing-form-message'+type).html(\r\n\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\r\n\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"El camp no pot estar buit\")+'</div>'\r\n\t\t);\t\t\t\r\n\t}else if(!isValidEmailAddress(email)){\r\n\t\t$('#landing-form-email'+type).addClass(\"invalid-landing-form\");\r\n\t\t$('#landing-form-message'+type).html(\r\n\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\r\n\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"El correu no és correcte\")+'</div>'\r\n\t\t);\t\r\n\t}else{\r\n\r\n    \t$('#landing-form-message'+type).html(\r\n    \t\t\t'<div class=\"three-quarters-loader\">'+\r\n    \t\t\t'  Loading…'+\r\n    \t\t\t'</div>'\r\n    \t);\r\n\r\n    \tinsertDataInstamaper(email).then(function(results){\r\n    \t\t\tsendEmailInstamaper(email,results, type);\r\n    \t\t},function(results){\r\n    \t\t\t$('#landing-form-message'+type).html(\r\n    \t\t\t\t\t'<div class=\"alert alert-success alert-dismissible\" role=\"alert\">'+\r\n    \t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\r\n    \t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-ok\"></span></strong> '+window.lang.translate(\"Gràcies. Prenem nota del teu correu i t'avisarem quan comencem el proper taller.\")+'</div>'\r\n    \t\t\t);\t    \t\t\t\r\n    \t\t}\r\n    \t);\r\n\t}\t\r\n}\r\n\r\nfunction initHover(){\r\n\t$(\"#div_V\").hover(function(){\r\n\t\t$(\"#img_V\").attr('src','llibreries/img/Visualitza_pujat.jpg');\r\n\t},function(){\r\n\t\t$(\"#img_V\").attr('src','llibreries/img/Visualitza_.jpg');\r\n\t});\r\n\t\r\n\t$(\"#div_C\").hover(function(){\r\n\t\t$(\"#img_C\").attr('src','llibreries/img/Crea_pujat.jpg');\r\n\t},function(){\r\n\t\t$(\"#img_C\").attr('src','llibreries/img/Crea_.jpg');\r\n\t});\r\n\t\r\n\t$(\"#div_E\").hover(function(){\r\n\t\t$(\"#img_E\").attr('src','llibreries/img/Explora_pujat.jpg');\r\n\t},function(){\r\n\t\t$(\"#img_E\").attr('src','llibreries/img/Explora_.jpg');\r\n\t});\r\n\t\r\n\t$(\"#div_C1\").hover(function(){\r\n\t\t$(\"#img_C1\").attr('src','llibreries/img/Comparteix_pujat.jpg');\r\n\t},function(){\r\n\t\t$(\"#img_C1\").attr('src','llibreries/img/Comparteix_.jpg');\r\n\t});\r\n\t\r\n\t/*langing geolocal*/\r\n\t$(\"#div_PC\").hover(function(){\r\n\t\t//$(\"#img_PC\").attr('src','geocatweb/img/thumb_ed_pcivil.png');\r\n\t\t$(this).fadeTo( 0, 0.7 );\r\n\t},function(){\r\n\t\t//$(\"#img_PC\").attr('src','geocatweb/img/thumb_ed_pcivil.png');\r\n\t\t$(this).fadeTo( 0, 1 );\r\n\t});\r\n\t\r\n\t$(\"#div_IP\").hover(function(){\r\n\t\t//$(\"#img_IP\").attr('src','geocatweb/img/thumb_ed_infoparcela.png');\r\n\t\t$(this).fadeTo( 0, 0.7 );\r\n\t},function(){\r\n\t\t//$(\"#img_IP\").attr('src','geocatweb/img/thumb_ed_infoparcela.png');\r\n\t\t$(this).fadeTo( 0, 1 );\r\n\t});\r\n\t\r\n\t$(\"#div_CC\").hover(function(){\r\n\t\t//$(\"#img_CC\").attr('src','geocatweb/img/thumb_ed_carrerer.png');\r\n\t\t$(this).fadeTo( 0, 0.7 );\r\n\t},function(){\r\n\t\t//$(\"#img_CC\").attr('src','geocatweb/img/thumb_ed_carrerer.png');\r\n\t\t$(this).fadeTo( 0, 1 );\r\n\t});\r\n\t\r\n\tjQuery('#div_PC').on('click', function(e) {\r\n\t\te.preventDefault();\r\n\t\tconsole.debug(this);\r\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'protecció civil']});\r\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=pcivil\";\r\n\t});\r\n\tjQuery('#div_IP').on('click', function(e) {\r\n\t\te.preventDefault();\r\n\t\tconsole.debug(this);\r\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'infoParcela']});\r\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=infoparcela\";\r\n\t});\r\n\tjQuery('#div_CC').on('click', function(e) {\r\n\t\te.preventDefault();\r\n\t\tconsole.debug(this);\r\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'carrerer']});\r\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=carrerer\";\r\n\t});\r\n}\r\n\r\nfunction checkUserLogin(){\r\n\tvar uid = Cookies.get('uid');\r\n\tif (uid===undefined) uid=_UsrID;\r\n\tvar tipusEntitat = parseInt(Cookies.get('tipusEntitat'));\r\n\tvar logged = false;\r\n\tif(!uid || isRandomUser(uid)){\r\n\t\t$(\"#menu_login\").show();\r\n\t\t$(\"#menu_user\").hide();\r\n\t\t$(\"#text_username\").remove();\r\n\t}else {\r\n\t\tlogged = true;\r\n\t\t$(\"#menu_login\").hide();\r\n\t\t$(\"#menu_user\").show();\t\r\n\t\tvar nomUser = uid.split(\"@\");\r\n\t\t$(\"#text_username\").text(\" \"+nomUser[0]);\r\n\t\t\r\n\t\tvar galeria_url = paramUrl.galeriaPage + \"?private=1\";\r\n\t\t$(\"#galeria a\").attr('href', galeria_url);\r\n\t\t$(\"#aplicacions a\").attr('href', galeria_url + \"&aplicacions=1\");\r\n\t}\r\n\tif($.inArray(tipusEntitat,TIPUS_ENTITATS_GEOLOCAL) != -1){\r\n\t\t$(\"#aplicacions\").show();\r\n\t}else{\r\n\t\t$(\"#aplicacions\").hide();\r\n\t}\r\n\t\r\n\tif(url('file') === \"galeria_geolocal.html\" || \r\n\t\turl('file') === \"sessio_geolocal.html\" ||\r\n\t\turl('file') === \"geolocal.html\" \r\n\t){\r\n\t\tCookies.set('perfil', 'geolocal');\r\n\t}else if(url('file') === \"galeria.html\" ||\r\n\t\turl('file') === \"sessio.html\" ||\r\n\t\turl('file') === \"index.html\"\r\n\t){\r\n\t\tCookies.set('perfil', 'instamaps');\r\n\t}\r\n\t\r\n\tif(!tipusEntitat){\r\n\t\tvar perfil = Cookies.get('perfil');\r\n\t\tswitch(perfil){\r\n\t\t\tcase 'instamaps':\r\n\t\t\t\ttipusEntitat = 1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'geolocal':\r\n\t\t\t\ttipusEntitat = 2;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault: tipusEntitat = 1;\r\n\t\t}\r\n\t}\r\n\t\r\n\tvar instamapsOptions = {\r\n\t\tuid: uid,\r\n\t\ttipusEntitat: tipusEntitat,\r\n\t\tlogged: logged\r\n\t};\r\n\tvar instamaps = Instamaps(instamapsOptions);\r\n\tinstamaps.changeBrand('.brand-txt').changeBrandLink('.navbar-brand')\r\n\t.changeGaleria('.instamaps_galeria').changeSession('.instamaps_sessio')\r\n\t.changeFooter('.instamaps_footer').changeContact('#hl_contact');\r\n}\r\n\r\nfunction web_menusIdioma(lsLang){\r\n\tjQuery('#ch_idioma li').each(function() {\r\n\t\tjQuery(this).removeClass('active');\r\n\t\tif (jQuery(this).attr('id') == lsLang){\r\n\t\t\tjQuery(this).addClass('active');\r\n\t\t}\r\n\t\tjQuery(this).click(function() {\r\n\t\t\tjQuery('#ch_idioma li').removeClass('active');\r\n\t\t\tjQuery(this).addClass('active');\r\n\t\t\tcanviaIdioma(jQuery(this).attr('id'));\r\n\t    });\r\n  });\r\n}\r\n\r\nfunction canviaIdioma(lsLang){\r\n\twindow.lang.change(lsLang);\r\n\t$(\"body\").trigger( \"change-lang\", lsLang );\r\n\t$.publish('change-lang',{lang: lsLang});\r\n}\r\n\r\nfunction web_determinaIdioma(){//Determinar idioma per paràmetre\r\n\tif (url('?hl')){\r\n\t\tvar lsLang = url('?hl');//obteValorURL(\"hl\");\r\n\t\twindow.lang.change(lsLang);\t\t\r\n\t\tjQuery(\"a[id^='hl_']\").each(function(index){\r\n\t\t\tvar _href=jQuery(this).attr('href');\r\n\t\t\t_href.indexOf('?') == -1 ? jQuery(this).attr('href',_href+'?hl='+lsLang): jQuery(this).attr('href',_href+'&hl='+lsLang);\r\n\t\t});\r\n\t}\r\n\telse if (Cookies.get(\"langCookie\")){\r\n\t\tvar lsLang = Cookies.get(\"langCookie\");\r\n\t\tif (lsLang != null && lsLang != \"null\"){\r\n\t\t\twindow.lang.change(lsLang);\r\n\t\t}\r\n\t}\r\n\treturn lsLang;\r\n}\r\n\r\nfunction web_roundCircles(){\r\n\tjQuery('#div_E').on('click', function() {\r\n\t\tdocument.location.href = \"#row_E\";\r\n\t});\r\n\tjQuery('#div_C').on('click', function() {\r\n\t\tdocument.location.href = \"#row_C\";\r\n\t});\r\n\tjQuery('#div_V').on('click', function() {\r\n\t\tdocument.location.href = \"#row_V\";\r\n\t});\r\n\tjQuery('#div_C1').on('click', function() {\r\n\t\tdocument.location.href = \"#row_C1\";\r\n\t});\r\n}\r\n\t\r\n\t\r\n\t\r\nfunction weball_tornarInici(){\r\n\t\r\njQuery(\"#back-top\").hide();\r\njQuery('#fes-mapa-inici').hide();\r\n\t\r\n\tjQuery(function () {\r\n\t\tjQuery(window).scroll(function () {\r\n\t\t\tif (jQuery(this).scrollTop() > 150) {\r\n\t\t\t\tjQuery('#back-top').fadeIn();\r\n\t\t\t\tjQuery('#fes-mapa-inici').fadeIn();\r\n\t\t\t} else {\r\n\t\t\t\tjQuery('#back-top').fadeOut();\r\n\t\t\t\tjQuery('#fes-mapa-inici').fadeOut();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tjQuery('#back-top button').click(function () {\r\n\t\t\tjQuery('body,html').animate({\r\n\t\t\t\tscrollTop: 0\r\n\t\t\t}, 800);\r\n\t\t\treturn false;\r\n\t\t});\r\n\t\tjQuery('#fes-mapa-inici').click(function () {\r\n\t\t\twindow.open(\"../geocatweb/mapa.html\",\"_self\");\r\n\t\t});\r\n\t});\r\n}\t\r\n\r\nfunction defineTipusUser(){\r\n\tif(!Cookies.get('uid') || Cookies.get('uid').indexOf('random')!=-1){\r\n\t\ttipus_user = t_user_random;\r\n\t}else{\r\n\t\ttipus_user = t_user_loginat;\r\n\t}\r\n\treturn tipus_user;\r\n}\r\n\r\nfunction logoutUser(){\r\n\tif (isRandomUser(Cookies.get('uid'))){\r\n\t\tdeleteRandomUser({uid: Cookies.get('uid')});\r\n\t}\r\n\tvar redirect = \"/index.html\";\r\n\tif(isGeolocalUser()){\r\n\t\tredirect = \"/geolocal.html\";\r\n\t}\r\n\tCookies.remove('uid');\r\n\tCookies.remove('tipusEntitat');\r\n\tCookies.remove('token');\r\n\tdoLogout().then(function(results){\r\n\t\tif(results.status==='OK'){\r\n\t\t\tCookies.remove('uid');\r\n\t\t\tCookies.remove('tipusEntitat');\r\n\t\t\tCookies.remove('token');\r\n\t\t\twindow.location.href=redirect;\r\n\t\t}else{\r\n\t\t\talert(\"no logout\");\r\n\t\t}\t\t\t\r\n\t},function(results){\r\n\t\talert(\"no logout\");\r\n\t\t//jQuery('#div_msg').html('<div class=\"alert alert-danger my-alert\" lang=\"ca\">No s\\'ha iniciat la sessi&oacute;. <strong>Torni a intentar.</strong></div>');\r\n\t});\r\n}\r\n\r\nfunction sessionExpired(){\r\n\tjQuery('#dialog_session_expired').modal('show');\r\n}\r\n\r\nfunction isRandomUser(user){\r\n\tvar isRandom = false;\r\n\tif (user && user.indexOf(\"random_\") != -1 && user.indexOf(\"random_\") == 0){\r\n\t\tisRandom = true;\r\n\t}\r\n\treturn isRandom;\r\n}\r\n\r\n//Funcions afegir modals\r\nfunction addHtmlModalMessages(){\r\n\tjQuery('#mapa_modals').append(\r\n\t\t'\t<!-- Modal messages -->'+\r\n\t\t'\t<div id=\"dialgo_messages\" class=\"modal fade\">'+\r\n\t\t'\t<div class=\"modal-dialog\">'+\r\n\t\t'\t\t<div class=\"modal-content\">'+\r\n\t\t'\t\t\t<div class=\"modal-header\">'+\r\n\t\t'\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t\t'\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t\t'\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">&nbsp;</h4>'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t\t<div class=\"modal-body\">'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t\t<div class=\"modal-footer\">'+\r\n\t\t'\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Acceptar</button>'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t</div>'+\r\n\t\t'\t\t<!-- /.modal-content -->'+\r\n\t\t'\t</div>'+\r\n\t\t'\t<!-- /.modal-dialog -->'+\r\n\t\t'</div>'+\r\n\t\t'<!-- fi messages -->'\r\n\t);\r\n}\r\n\r\nfunction addHtmlModalExpire(){\r\n\tjQuery('#mapa_modals').append(\r\n\t\t'\t<!-- Modal expired -->'+\r\n\t\t'\t<div class=\"modal fade\" id=\"dialog_session_expired\">'+\r\n\t\t'\t<div class=\"modal-dialog\">'+\r\n\t\t'\t\t<div class=\"modal-content\">'+\r\n\t\t'\t\t\t<div class=\"modal-header\">'+\r\n\t\t'\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t\t'\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t\t'\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Sessió caducada</h4>'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t\t<div lang=\"ca\" class=\"modal-body\">'+\r\n\t\t'\t\t\t\tHa caducat la sessió. Si vols continuar treballant torna a iniciar la sessió'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t\t<div class=\"modal-footer\">'+\r\n\t\t'\t\t    \t<button id=\"bt_upload_cancel\" lang=\"ca\" type=\"button\" class=\"btn\" data-dismiss=\"modal\">Acceptar</button>'+\r\n\t\t'\t\t    </div>'+\r\n\t\t'\t\t</div>'+\r\n\t\t'\t\t<!-- /.modal-content -->'+\r\n\t\t'\t</div>'+\r\n\t\t'\t<!-- /.modal-dialog -->'+\r\n\t\t'</div>'+\r\n\t\t'<!-- /.modal -->'+\r\n\t\t'<!-- fi Modal expired -->'\t\r\n\t);\r\n}\r\n\r\n\r\nfunction addHtmlModalLeave(){\r\n\tjQuery('#mapa_modals').append(\r\n\t\t'\t<!-- Modal Leave -->'+\r\n\t\t'\t\t<div id=\"dialgo_leave\" class=\"modal fade\">'+\r\n\t\t'\t\t<div class=\"modal-dialog\">'+\r\n\t\t'\t\t\t<div class=\"modal-content\">'+\r\n\t\t'\t\t\t\t<div class=\"modal-header\">'+\r\n\t\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Edició en mode demostració</h4>'+\r\n\t\t'\t\t\t\t</div>'+\r\n\t\t'\t\t\t\t<div class=\"modal-body\" lang=\"ca\">'+\r\n\t\t'\t\t\t\t\tPer poder guardar les dades has d\\'entrar com un usuari registrat'+\r\n\t\t'\t\t\t\t</div>'+\r\n\t\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn bt-sessio\"'+ \r\n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'inici sessio\\', \\'modal inici mapa\\']);\">Inicia la sessió</button>'+\r\n\t\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn bt_orange\"'+ \r\n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'registre\\', \\'modal inici mapa\\']);\">Crea un compte</button>'+\r\n\t\t'\t\t\t\t\t<button id=\"btn-guest\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\"'+ \r\n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'guest\\', \\'modal inici mapa\\']);\">Més tard</button>'+\r\n\t\t'\t\t\t\t</div>'+\r\n\t\t'\t\t\t</div>'+\r\n\t\t'\t\t\t<!-- /.modal-content -->'+\r\n\t\t'\t\t</div>'+\r\n\t\t'\t\t<!-- /.modal-dialog -->'+\r\n\t\t'\t</div>'+\r\n\t\t'\t<!-- fi Modal Leave -->'\t\t\r\n\t);\r\n}\r\n\r\n\r\nfunction addHtmlModalOldBrowser(){\r\n\tjQuery('#mapa_modals').append(\r\n\t'\t<!-- Modal Old Browser -->'+\r\n\t'\t\t<div id=\"dialgo_old_browser\" class=\"modal\">'+\r\n\t'\t\t<div class=\"modal-dialog\">'+\r\n\t'\t\t\t<div class=\"modal-content\">'+\r\n\t'\t\t\t\t<div class=\"modal-header\">'+\r\n\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Sabia vostè que el seu navegador no està actualitzat?</h4>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-body\">'+\r\n\t'\t\t\t\t\t<div lang=\"ca\">Per aconseguir la millor experiència possible utilitzant el nostre lloc web nosaltres recomanem que vostè actualitzeu a una nova versió d\\'Internet Explorer o utilitzi un altre navegador web. Una llista dels navegadors web més populars pot ser trobada sota.</div>'+\r\n\t'\t\t\t\t\t<div>'+\r\n\t'\t\t\t\t\t<a href=\"http://www.microsoft.com/windows/Internet-explorer/default.aspx\" target=\"_blank\"><div class=\\'ie_img browser_img\\'></div></a>'+\r\n\t'\t\t\t\t\t<a href=\"http://www.mozilla.com/firefox/\" target=\"_blank\"><div class=\\'firefox_img browser_img\\'></div></a>'+\r\n\t'\t\t\t\t\t<a href=\"http://www.apple.com/safari/download/\" target=\"_blank\"><div class=\\'safari_img browser_img\\'></div></a>'+\r\n\t'\t\t\t\t\t<a href=\"http://www.opera.com/download/\" target=\"_blank\"><div class=\\'opera_img browser_img\\'></div></a>'+\r\n\t'\t\t\t\t\t<a href=\"http://www.google.com/chrome\" target=\"_blank\"><div class=\\'chrome_img browser_img\\'></div></a>'+\r\n\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t\t<div lang=\"ca\">Només faci clic a les icones per anar a la pàgina de descàrrega</div>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t'\t\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Continuar</button>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t<!-- /.modal-content -->'+\r\n\t'\t\t</div>'+\r\n\t'\t\t<!-- /.modal-dialog -->'+\r\n\t'\t</div>'+\r\n\t'\t<!-- fi Modal Old Browser -->'\t\t\r\n\t);\r\n}\r\n\r\nfunction isGeolocalUser(){\r\n\tvar isGeolocal = false;\r\n\t\r\n\t\r\n\tif(Cookies.get('tipusEntitat')){\r\n\t\tif($.inArray(parseInt(Cookies.get('tipusEntitat')),TIPUS_ENTITATS_GEOLOCAL) != -1){\r\n\t\t\tisGeolocal = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn isGeolocal;\r\n}\r\n\r\nfunction cambiarTitle(){\r\n\tif(Cookies.get('tipusEntitat')){\r\n\t\tif(isGeolocalUser()){\r\n\t\t\t$('.brand-txt').text(\"InstaMaps.GeoLocal\");\r\n\t\t\t$('.navbar-brand').prop('href','/geolocal.html');\r\n\t\t}else{\r\n\t\t\t$('.brand-txt').text(\"InstaMaps\");\r\n\t\t\t$('.navbar-brand').prop('href','/index.html');\r\n\t\t}\r\n\t}\r\n\telse if (typeof url('?tipus') == \"string\" && url('?tipus')==\"geolocal\"){\r\n\t\t$('.brand-txt').text(\"InstaMaps.GeoLocal\");\r\n\t\t$('.navbar-brand').prop('href','/geolocal.html');\r\n\t}\r\n}\r\n","/**\r\n * Funcionalitat compartir en xarxes socials\r\n */\r\n\r\nfunction addCompartirMapa(){\r\n\t\r\n\taddHtmlInterficieCompartirMapa();\r\n\t\r\n\tvar v_url = window.location.href;\r\n\tif (!url('?id')){\r\n\t\tv_url += \"&id=\"+jQuery('#userId').val();\r\n\t}\r\n\tv_url = v_url.replace('localhost',DOMINI);\r\n\tv_url = v_url.replace('mapa','visor');\t\r\n\t\r\n\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\r\n\t\r\n\t\r\n\t//Compartir en xarxes socials\r\n\tif (isRandomUser(Cookies.get('uid'))){\r\n\t\r\n\t\tjQuery(window).on('beforeunload',function(event){\r\n\t\t\treturn 'Are you sure you want to leave?';\r\n\t\t});\t\t\t\t\t\t\t\r\n\t\r\n\t\tjQuery('#socialShare').share({\r\n\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\r\n\t\t\ttheme: 'square'\r\n\t\t});\r\n\t\t\r\n\t\tjQuery('#socialShare .pop-social').off('click').on('click', function(event){\r\n\t\t\tevent.preventDefault();\r\n\t\t\tjQuery('.modal').modal('hide');\r\n\t\t\t$('#dialgo_messages').modal('show');\r\n\t\t\t$('#dialgo_messages .modal-body').html(window.lang.translate(msg_noguarda));\r\n\t\t});\r\n\t}else{\r\n\t\tshortUrl(v_url).then(function(results){\r\n\t\t\tjQuery('#socialShare').share({\r\n\t\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\r\n\t\t\t\ttheme: 'square',\r\n\t\t\t\turlToShare: results.id\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tjQuery('#socialShare .pop-social').on('click', function(event){\r\n//\t\t\t\tconsole.debug(\"social share click, publiquem!\");\r\n\t\t\t\tpublicarMapa(true);\r\n\t\t\t});\t\t\t\t\r\n\t\t});\r\n\t}\t\r\n}\r\n\r\nfunction addCompartirVisor(){\r\n\tvar v_url = window.location.href;\r\n\tif(v_url.indexOf('localhost')!=-1){\r\n\t\tv_url = v_url.replace('localhost',DOMINI);\r\n\t}\r\n\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\r\n\t\r\n\tshortUrl(v_url).then(function(results){\r\n\t\tjQuery('#socialShare_visor').share({\r\n\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\r\n\t\t\t//orientation: 'vertical',\r\n\t\t\t//affix: 'left center',\r\n\t\t\ttheme: 'square',\r\n\t\t\turlToShare: results.id\r\n\t\t});\r\n\t});\t\r\n\t\r\n\tjQuery('.share-square a').attr('target','_blank');\r\n\t\r\n\t/*\r\n\t * se declara el evento en el control \r\n\tjQuery(\"#dv_bt_Share\").on('click',function(e){\r\n\t\tposaClassActiu('#span_bt_Share');\r\n\t\tjQuery('#socialShare_visor').css('top', (e.clientY - 30) +'px');\r\n\t\tjQuery('#socialShare_visor').css('left', (e.clientX + 20) +'px');\r\n\t\tjQuery('#socialShare_visor').toggle();\r\n\t\taturaClick(e);\r\n\t});\r\n\t*/\r\n}\r\n\r\nfunction posaClassActiu(_element){\r\n\tvar cl = jQuery(_element).attr('class');\r\n\tif (cl.indexOf('grisfort') != -1) {\r\n\t\tjQuery(_element).removeClass('grisfort');\r\n\t\tjQuery(_element).addClass('greenfort');\r\n\t} else {\r\n\t\tjQuery(_element).removeClass('greenfort');\r\n\t\tjQuery(_element).addClass('grisfort');\r\n\t}\r\n}\r\n\r\nfunction addHtmlInterficieCompartirMapa(){\r\n\tjQuery(\"#funcio_compartir\").append(\r\n\t\t\t'<div id=\"socialShare\" class=\"div_gr5_social\">'+\r\n\t\t\t\t'<h5 lang=\"ca\">Compartir</h5>'+\r\n\t\t\t'</div>'\r\n\t);\r\n}","\r\n\r\nvar _gaq = _gaq || [];\r\n//var ga;\r\n(function() {\r\n\t$.subscribe('loadConfig', function(e, data){\r\n\r\n\t\tvar _mapConfig = {};\r\n\t\tvar perfil = Cookies.get('perfil');\r\n\t\tvar _userID=\"0000\";\r\n\t\tvar _userDimension=window.location.href;\r\n\t\tvar visibilitat=\"none\";\r\n\t\tif(data){\r\n\t\t\t_mapConfig =data;\r\n\t\t\tdata.id?_userID=data.id:_userID=_userID;\r\n\t\t\tdata.entitatUid?_userDimension=data.entitatUid:_userDimension=_userDimension;\r\n\t\t\tdata.visibilitat?visibilitat=data.visibilitat:visibilitat=visibilitat;\r\n\t\t\t}\r\n\r\n\r\n\t\tif (isGeolocalUser() || $(location).attr('href').indexOf('geolocal.html') != -1 || perfil === 'geolocal') {\r\n\t\t\tga('create', 'UA-46332195-6', 'auto');\r\n\t\t}else if (_mapConfig && _mapConfig.tipusAplicacioId == TIPUS_APLIACIO_GEOLOCAL || _mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC){\r\n\t\t\tga('create', 'UA-46332195-6', 'auto');\r\n\t\t}else{\r\n\t\t\tga('create', 'UA-46332195-3', 'auto');\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\tga('set', 'transport', 'beacon');\r\n\t\tga('send', 'pageview');\r\n\t\tga('set', 'dimension1', _userDimension);\r\n\t\tga('set', 'userId', _userID);\r\n\t\t\r\n\r\n\t\t//TODO poner el subscriber\r\n\t\t$.publish('loadGaEvents');\r\n\t});\r\n\r\n\t$.subscribe('trackEvent', function(e, data){\r\n\t\tcheckIfAnalyticsLoaded(data);\r\n\r\n\t});\r\n\r\n\t$.subscribe('trackPageview', function(e, data){\r\n\r\n\t\t ga('send', 'pageview');\r\n\t});\r\n\r\n\t$.subscribe('analyticsEvent', function(e, data){\r\n\r\n\t\taddAnalyticsEvent(data);\r\n\t});\r\n\r\n\r\n\r\n\r\n\r\n})();\r\n\r\n//$.publish('analyticsEvent',{event:['mapa', tipus_user+'fons', fons, 1]});\r\n\r\n//_gaq.push(['_trackEvent', 'galeria privada', tipus_user+'veure mapa']);\r\n\r\n\r\nfunction addAnalyticsEvent(dataEvents){\r\n\t\tvar dataEventArray=[];\r\n\t\ttry{\r\n\t\t\tdataEvents.event?dataEventArray=dataEvents.event:dataEventArray=dataEvents;\r\n\t\t\tvar label_num=1;\r\n\t\t\tvar event_label=\"\";\r\n\t\t\tdataEventArray.length==4?label_num=dataEventArray[3]:label_num=label_num;\r\n\t\t\tdataEventArray.length<=2?event_label=event_label:event_label=dataEventArray[2];\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t// category,action,label\r\n\t\t\t/*\r\n\t\t\tconsole.info(dataEventArray[0])\t;\r\n\t\t\tconsole.info(dataEventArray[1])\t;\r\n\t\t\tconsole.info(event_label)\t;\r\n\t\t\t*/\r\n\t\t\tga('send', 'event', dataEventArray[0],dataEventArray[1],event_label,label_num);\r\n\t\t}catch(err){\r\n\r\n\r\n\t\t\tga('send', 'event', 'error','addAnalyticsEvent',err);\r\n\t\t}\r\n\r\n}\r\n\r\n\r\nfunction checkIfAnalyticsLoaded(data) {\r\n\tif($.isArray(_gaq)){\r\n\t\tsetTimeout(function(){\r\n\t\t\tcheckIfAnalyticsLoaded(data);\r\n\t\t}, 500);\r\n\t}else{\r\n\t\t//_gaq.push(data.event);\r\n\t\taddAnalyticsEvent(data);\r\n\t}\r\n}\r\n\r\n\r\n\r\n(function() {\r\n\r\n\r\n  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\r\n  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\r\n  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\r\n  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');\r\n\r\n\r\n\r\n})();\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/*\r\n\r\nvar dimensionValue = 'SOME_DIMENSION_VALUE';\r\nga('set', 'dimension1', dimensionValue);\r\nga('send', 'event', 'Videos', 'play', 'Fall Campaign',1);\r\n\r\nga('set', 'userId', {{USER_ID}}); // Set the user ID using signed-in user_id.\r\n\r\n*/\r\n","var group_sortable1=null;\r\nvar group_sortable2=null;\r\n\r\n/**\r\n * Funcionalitat edicio nom del mapa\r\n * */\r\nfunction addFuncioRenameMap(){\r\n\t$('#nomAplicacio').editable({\r\n\t\ttype: 'text',\r\n\t\tmode: 'inline',\r\n\t\tvalidate: function(value) {\r\n\t\t\tif($.trim(value) == '') {\r\n\t\t\t\treturn {newValue: this.innerHTML};\r\n\t\t\t}\r\n\t\t},\r\n\t\tsuccess: function(response, newValue) {\r\n\t\t\tvar data = {\r\n\t\t\t\tbusinessId: url('?businessid'),\r\n\t\t\t \tnom: newValue,\r\n\t\t\t \tuid: Cookies.get('uid')\r\n\t\t\t}\r\n\t\t\tupdateMapName(data).then(function(results){\r\n\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'editar nom aplicacio', 'label editar nom', 1]});\r\n\r\n\t\t\t\tif(results.status=='OK'){\r\n\t\t\t\t\t$('#dialgo_publicar #nomAplicacioPub').val(results.results);\r\n\t\t\t\t\tmapConfig.nomAplicacio = results.results;\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\t$('#nomAplicacio').val(mapConfig.nomAplicacio);\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n\r\n\r\nfunction reOrderGroupsAndLayers(action){\r\n\tvar z_order=-1,\r\n\t_groupName, \r\n\t_groupId, \r\n\t_groupSubId, \r\n\t_businessId, \r\n\t_expanded;\r\n\t\r\n\t$(\"div.leaflet-control-accordion-layers\").each(function( index, element ) {\r\n\t\tvar $this = $(this);\r\n\t\tvar gr=$this.children(\"label\").children('span.span_ac');\r\n\t\t_groupId=index;\r\n\t\t_groupName=gr.text();\r\n\t\tvar _exp=$this.children(\"label\").children('i.label_gl');\r\n\t\tvar _id=$(_exp).attr(\"id\");\r\n\t\t_expanded=true;\r\n\t\tif($('#'+_id).hasClass('glyphicon-triangle-right')){\r\n\t\t\t_expanded=false;\r\n\t\t}\r\n\t\t$this.children(\"ol.ac-large\").children(\"li.leaflet-row\").each(function(){\r\n\t\t\t$this; // parent li\r\n\t\t\t_businessId=this.id.replace(\"LI-\",\"\"); // child li\r\n\t\t\tz_order=z_order+1;\r\n\t\t\t\r\n\t\t\tif(action){\r\n\t\t\t\tcontrolCapes.updateTreeGroupLayers(_groupId,_groupName,_businessId,z_order,_expanded).then(function(resp_Layer){\r\n\t\t\t\tif(resp_Layer){\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\tbusinessId: resp_Layer.options.businessId, //url('?businessid')\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\toptions: JSON.stringify(resp_Layer.options.group)\r\n\t\t\t\t\t };\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar data2 = {\r\n\t\t\t\t\t\tservidorWMSbusinessId:resp_Layer.options.businessId,\r\n\t\t\t\t\t\tbusinessId:url('?businessid'), //url('?businessid')\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\torder: z_order\r\n\t\t\t\t\t };\r\n\t\t\r\n\t\t\t\t\tupdateGroupsLayerGroup(data,data2);\r\n\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction updateGroupsLayerGroup(data,data2){\r\n\tupdateServidorWMSGroup(data).then(function(results){\r\n\t\tif(results.status==='OK'){\r\n\t\t\tif(data2){\r\n\t\t\t\t//TODO validar si es necesario hacer esta llamada\r\n\t\t\t\tupdateServerOrderToMap(data2).then(function(results) {\r\n\t\t\t\t\tif (results.status != 'OK')\r\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\r\n\t\t\t\t\t\t\t\t// no es faci tampoc a client, i es\r\n\t\t\t\t\t\t\t\t// mostri un error\r\n\t\t\t\t}, function(results) {\r\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\r\n\t\t\t\t\t\t\t// faci tampoc a client, i es mostri un\r\n\t\t\t\t\t\t\t// error\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction refreshSortablesElements(){\r\n\tupdateSortablesElements();\r\n}\r\n\r\nfunction updateSortablesElements(){\r\n\tif(getModeMapa()){\r\n\t\tgroup_sortable1 = $(\"ol.leaflet-control-layers-overlays\").sortable({\r\n\t\t\tconnectWith: \"ol.leaflet-control-layers-overlays\",\r\n\t\t\thandle: \".label_ac\", //hadle para el drag issue 540\r\n\t\t\tchange: function( event, ui ) {\r\n\t\t\t\tsetTimeout(function(){ reOrderGroupsAndLayers(true); }, 1000);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tgroup_sortable2 = $(\"ol.ac-large\").sortable({\r\n\t\t\tconnectWith: \"ol.ac-large\",\r\n\t\t\tstop: function( event, ui ) {\r\n\t\t\t\treOrderGroupsAndLayers(true);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * Funcionalitats edicio noms capes\r\n * */\r\nfunction updateEditableElements(){\r\n\t$('.label_ac .editable').editable({\r\n\t\ttype: 'text',\r\n\t\tmode: 'inline',\r\n\t\tvalidate: function(value) {\r\n\t\t\tif($.trim(value) == '') {\r\n\t\t\t\treturn {newValue: this.innerHTML};\r\n\t\t\t}\r\n\t\t},\r\n\t\tsuccess: function(response, newName) {\r\n\t\t\tvar oldName=this.groupName;\r\n\t\t\tvar resp_Layer=\tcontrolCapes.updateGroupName(oldName,newName,this.groupId);\r\n\t\t\tfor(i=0;i < resp_Layer.length;i++){\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t \tbusinessId: resp_Layer[i].options.businessId, //url('?businessid')\r\n\t\t\t\t \tuid: Cookies.get('uid'),\r\n\t\t\t\t \toptions: JSON.stringify(resp_Layer[i].options.group)\r\n\t\t\t\t };\r\n\t\t\t\tupdateGroupsLayerGroup(data,null);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\t $('.label_ac .editable').on('shown', function(e, editable) {\r\n\t\t jQuery('.group-conf').hide();\r\n\t });\r\n\t\t\r\n\t $('.label_ac .editable').on('hidden', function(e, editable) {\r\n\t\t jQuery('.group-conf').show();\r\n\t });\r\n\r\n\t $('.leaflet-name .editable').editable({\r\n\t\t type: 'text',\r\n\t\t mode: 'inline',\r\n\t\t validate: function(value) {\r\n\t\t\t if($.trim(value) == '') {\r\n\t\t\t\t return {newValue: this.innerHTML};\r\n\t\t\t }\r\n\t\t },\r\n\t\t success: function(response, newValue) {\r\n\t\t\t map.closePopup();//Perque no queden desactualitzats\r\n\t\t\t var id = this.id;\r\n\t\t\t var idParent = this.idParent;\r\n\t\t\t //Controlem si es sublayer\r\n\t\t\t var editableLayer;\r\n\t\t\t if(idParent){\r\n\t\t\t\t editableLayer = controlCapes._layers[this.idParent]._layers[this.id];\r\n\t\t\t }else{\r\n\t\t\t\t editableLayer = controlCapes._layers[this.id];\r\n\t\t\t }\r\n\t\t\t var op=\"\";\r\n\t\t\t if(editableLayer.layer.options.tipus.indexOf(t_wms) != -1){\r\n\t\t\t\t op=\"##\"+ editableLayer.layer.options.opacity;\r\n\t\t\t }\r\n\t\t\t var data = {\r\n\t\t\t\tbusinessId: editableLayer.layer.options.businessId, //url('?businessid')\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tserverName: newValue + op\r\n\t\t\t };\r\n\t\t\t var oldName = this.innerHTML;\r\n\t\t\t \r\n\t\t\t updateServidorWMSName(data).then(function(results){\r\n\t\t\t\t if(results.status==='OK'){\r\n\t\t\t\t\t $.publish('analyticsEvent',{event:['mapa', tipus_user+'editar nom capa', 'label editar nom', 1]});\r\n\r\n\t\t\t\t\t var layerName=newValue;\t\t\t\r\n\t\t\t\t    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\r\n\t\t\t\t    \t\r\n\t\t\t\t\t //editableLayer.name = newValue;\r\n\t\t\t\t     editableLayer.name = layerName;\t\r\n\t\t\t\t\t editableLayer.layer.options.nom = newValue;\r\n\t\t\t\t\t $('.leaflet-name label span#'+id).text(layerName);\r\n\t\t\t\t\t if(editableLayer.layer.options.businessId == $(\"#mapLegendEdicio\").data(\"businessid\")){\r\n\t\t\t\t\t\t $(\".titol-legend\").html(newValue);\r\n\t\t\t\t\t }\r\n\t\t\t\t }else{\r\n\t\t\t\t\t editableLayer.name = oldName;\r\n\t\t\t\t\t $('.leaflet-name label span#'+id).text(results.results.nom);\r\n\t\t\t\t }\r\n\t\t\t },function(results){\r\n\t\t\t\t editableLayer.name = oldName;\r\n\t\t\t\t var obj = $('.leaflet-name label span#'+id).text();\r\n\t\t\t\t $('.leaflet-name label span#'+id).text(oldName);\r\n\t\t\t });\r\n\t\t }\r\n\t });\r\n\r\n\t $('.leaflet-name .editable').on('shown', function(e, editable) {\r\n\t\t jQuery('.opcio-conf').hide();\r\n\t\t jQuery('.subopcio-conf').hide();\r\n\t\t jQuery('.leaflet-data-table').hide();\r\n\t });\r\n\t $('.leaflet-name .editable').on('hidden', function(e, editable) {\r\n\t\t jQuery('.opcio-conf').show();\r\n\t\t jQuery('.leaflet-data-table').show();\r\n\t });\r\n}\r\n\r\n/**\r\n * Funcionalitat de descarrega de capes\r\n * */\r\nfunction addFuncioDownloadLayer(from){\r\n\taddHtmlModalDownloadLayer(from);\r\n}\r\n\r\n/**\r\n * Funcionalitat remove layers\r\n **/\r\nfunction removeAtomicLayer(data,matriuObj){\r\n\tremoveServerToMap(data).then(function(results){\r\n\t\tif(results.status==='OK'){\r\n\t\t\tfor(var j=0; j < matriuObj.length;j++){\r\n\t\t\tvar obj=matriuObj[j];\r\n\t\t\tmap.closePopup();\r\n\t\t\tmap.removeLayer(obj.layer);\r\n\t\t\t//Eliminem la capa de controlCapes\r\n\t\t\tcontrolCapes.removeLayer(obj);\r\n\t\t\t//Esborrem la llegenda de la capa eliminada\r\n\t\t\t////emptyMapLegendEdicio(obj.layer);\r\n\t\t\t//actualitzem valors zindex de la resta si no es sublayer\r\n\t\t\tif(!obj.sublayer){\r\n\t\t\t\tvar removeZIndex = obj.layer.options.zIndex;\r\n\t\t\t\tcontrolCapes._lastZIndex--;\r\n\t\t\t\tvar aux = controlCapes._layers;\r\n\t\t\t\tfor (var i in aux) {\r\n\t\t\t\t\tif (aux[i].layer.options.zIndex > removeZIndex) aux[i].layer.options.zIndex--;\r\n\t\t\t\t}\r\n\t\t\t\t//Eliminem les seves sublayers en cas que tingui\r\n\t\t\t\tfor(indexSublayer in obj._layers){\r\n\t\t\t\t\tmap.removeLayer(map._layers[indexSublayer]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//Actualitzem capaUsrActiva\r\n\t\t\tif(capaUsrActiva!=null && capaUsrActiva.options.businessId == obj.layer.options.businessId){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\tcapaUsrActiva = null;\r\n\t\t\t}\r\n\r\n\t\t\tdeleteServerRemoved(data).then(function(results){\r\n\t\t\t\t//se borran del listado de servidores\r\n\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\r\n\t\t}\r\n\t},function(results){\r\n\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\r\n\t});\r\n}\r\n\r\nfunction addFuncioRemoveLayer(){\r\n\taddHtmlModalRemoveLayer();\r\n\taddHtmlModalRemoveGroup();\r\n}\r\n\r\n/**\r\n * Funcionalitat addToolTips Panell de capes\r\n **/\r\nfunction addTooltipsConfOptions(businessId){\r\n\r\n\t$(\".conf-\"+businessId+\".leaflet-up\").tooltip({\r\n\t\tplacement : 'bottom',\r\n\t\tcontainer : 'body',\r\n\t\ttitle : window.lang.translate(\"puja\")\r\n\t});\r\n\r\n\t$(\".conf-\"+businessId+\".leaflet-down\").tooltip({\r\n\t\tplacement : 'bottom',\r\n\t\tcontainer : 'body',\r\n\t\ttitle : window.lang.translate(\"baixa\")\r\n\t});\r\n\r\n\t$(\".conf-\"+businessId+\".leaflet-remove\").tooltip({\r\n\t\tplacement : 'bottom',\r\n\t\tcontainer : 'body',\r\n\t\ttitle : window.lang.translate(\"elimina\")\r\n\t});\r\n\r\n\t$(\".conf-\"+businessId+\".leaflet-download\").tooltip({\r\n\t\tplacement : 'bottom',\r\n\t\tcontainer : 'body',\r\n\t\ttitle : window.lang.translate(\"descarrega\")\r\n\t});\r\n\r\n\t$(\".data-table-\"+businessId+\".leaflet-data-table\").tooltip({\r\n\t\tplacement : 'bottom',\r\n\t\tcontainer : 'body',\r\n\t\ttitle : window.lang.translate(\"dades\")\r\n\t});\r\n}\r\n\r\nfunction addFuncioEtiquetesCapa(){\r\n\taddHtmlModalEtiquetesLayer();\r\n}\r\n\r\nfunction addHtmlModalDownloadLayer(from){\r\n\t$.get(\"/geocatweb/templates/modalDownloadLayer.html\",function(data){\r\n\t\t//TODO ver como pasar el modal container\r\n\t\t$('#mapa_modals').append(data);\r\n\t\t\r\n\t\t//Si la capa conté polígons no es podrà descarregar en format GPX\r\n\t\t$('#modal_download_layer').on('show.bs.modal', function (e) {\r\n\t\t\t  if(download_layer.layer.options.geometryType\r\n\t\t\t\t\t  && download_layer.layer.options.geometryType==t_polygon){\r\n\t\t\t\t  $(\"#select-download-format option[value='GPX#.gpx']\").attr('disabled','disabled');\r\n\t\t\t  }else{\r\n\t\t\t\t  $(\"#select-download-format option[value='GPX#.gpx']\").removeAttr('disabled');\r\n\t\t\t  }\r\n\r\n\t\t\t  //Reset the modal values\r\n\t\t\t  $(\"#input-download-name\").val(\"\");\r\n\t\t\t  $(\"#select-download-format\").val($(\"#select-download-format option:first\").val());\r\n\t\t\t  $(\"#select-download-epsg\").val($(\"#select-download-epsg option:first\").val());\r\n\t\t});\r\n\r\n\t\tjQuery('#select-download-format').change(function() {\r\n\t\t\tvar ext = jQuery(this).val();\r\n\t\t\tif ((ext==\"KML#.kml\")||(ext==\"GPX#.gpx\")){\r\n\t\t\tjQuery(\"#select-download-epsg\").val(\"EPSG:4326\").attr('disabled',true);\r\n\t\t\t}else{\r\n\t\t\t\tjQuery(\"#select-download-epsg\").attr('disabled',false);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$('#bt_download_accept').on('click', function(evt){\r\n\t\t\tvar formatOUT = $('#select-download-format').val();\r\n\t\t\tvar epsgOUT = $('#select-download-epsg').val();\r\n\t\t\tvar filename = $('#input-download-name').val();\r\n\t\t\tvar layer_GeoJSON = download_layer.layer.toGeoJSONcustom();\r\n\r\n\t\t\tvar data = {\r\n\t\t\t\tcmb_formatOUT: formatOUT,\r\n\t\t\t\tcmb_epsgOUT: epsgOUT,\r\n\t\t\t\tlayer_name: filename,\r\n\t\t\t\tfileIN: JSON.stringify(layer_GeoJSON)\r\n\t\t\t};\r\n\r\n\t\t\t$.publish('analyticsEvent',{event:[from, tipus_user+'descarregar capa', formatOUT+\"-\"+epsgOUT, 1]});\r\n\r\n\t\t\tgetDownloadLayer(data).then(function(results){\r\n\t\t\t\tresults = results.trim();\r\n\t\t\t\tif (results == \"ERROR\"){\r\n\t\t\t\t\t$('#modal-body-download-error').show();\r\n\t\t\t\t\t$('#modal-body-download').hide();\r\n\t\t\t\t\t$('#modal_download_layer .modal-footer').hide();\r\n\t\t\t\t\t$('#modal_download_layer').modal('show');\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar iframe = $(\"#downloadFrame\");\r\n\t\t\t\t\tif(0 == iframe.length)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tiframe = $(\"<iframe/>\").attr({\r\n\t\t\t\t\t\t\tid: \"downloadFrame\",\r\n\t\t\t\t\t\t\tstyle: \"visibility:hidden;display:none\"\r\n\t\t\t\t\t\t}).appendTo('#modal_download_layer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tiframe.attr(\"src\", GEOCAT02 + results)\r\n\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\t$('#modal-body-download-error').show();\r\n\t\t\t\t$('#modal-body-download').hide();\r\n\t\t\t\t$('#modal_download_layer .modal-footer').hide();\r\n\t\t\t\t$('#modal_download_layer').modal('show');\r\n\t\t\t});\r\n\r\n\t\t});\r\n\t\t\r\n\t});\r\n}\r\n\r\nfunction addHtmlModalRemoveLayer(){\r\n\t$.get(\"templates/modalRemoveLayer.html\",function(data){\r\n\t\t//TODO ver como pasar el modal container\r\n\t\t$('#mapa_modals').append(data);  \r\n\t\t\r\n\t\t$('#dialog_delete_capa .btn-danger').on('click', function(event){\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar data = $this.data(\"data\");\r\n\t\t\tvar obj = $this.data(\"obj\");\r\n\t\t\tvar matriuObj=[];\r\n\t\t\tmatriuObj.push(obj);\r\n\t\t\tremoveAtomicLayer(data,matriuObj);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction addHtmlModalRemoveGroup(){\r\n\t$.get(\"templates/modalRemoveGroup.html\",function(data){\r\n\t\t//TODO ver como pasar el modal container\r\n\t\t$('#mapa_modals').append(data); \r\n\t\t\r\n\t\t//Esborra grup capes\r\n\t\t$('#dialog_delete_group .btn-danger').on('click', function(event){\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar group = $this.data(\"group\");\r\n\t\t\tvar matriuCapesGroup=controlCapes.getLayersFromGroupId(group.groupId,group.groupName);\r\n\t\t\tvar lbusinessId = [];\r\n\t\t\tvar matriuObj=[];\r\n\t\t\t\tfor(i=0; i < matriuCapesGroup.length;i++){\r\n\t\t\t\t\tvar obj;\r\n\t\t\t\t\tvar layerIdParent = matriuCapesGroup[i].layerIdParent;\r\n\t\t\t\t\tif(!layerIdParent){\r\n\t\t\t\t\t\tobj = matriuCapesGroup[i];\r\n\t\t\t\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t\t\t\t\tfor(j in obj._layers){\r\n\t\t\t\t\t\t\tlbusinessId.push(obj._layers[j].layer.options.businessId);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tobj =matriuCapesGroup[i];\r\n\t\t\t\t\t\tlbusinessId.push(obj.layer.options.businessId);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmatriuObj.push(obj);\r\n\t\t\t\t\tif(!obj.overlay) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(typeof url('?businessid') == \"string\"){\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tbusinessId: url('?businessid'),\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\tservidorWMSbusinessId:lbusinessId.toString()\r\n\t\t\t\t\t};\r\n\t\t\t\t\tremoveAtomicLayer(data,matriuObj);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcontrolCapes.removeGroup(group.groupName,group.groupId);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction addHtmlModalEtiquetesLayer(){\r\n\t$.get(\"templates/modalEtiquetesLayer.html\",function(data){\r\n\t\t//TODO ver como pasar el modal container\r\n\t\t$('#mapa_modals').append(data); \r\n\t\t\r\n\t\t$('#colorpalette_etiqueta').colorPalette().on('selectColor', function(e) {   \t\r\n\t\t\t$('#dv_color_etiqueta').css('background-color',e.color);\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$('#colorpalette_caixa_etiqueta').colorPalette().on('selectColor', function(e) {   \t\r\n\t\t\t$('#dv_color_caixa_etiqueta').css('background-color',e.color);\t\t\r\n\t\t});\r\n\t\t\r\n\t\t/*$('#dialog_etiquetes_capa .btn-success').on('click', function (e) {\r\n\t\t\t\r\n\t\t\tif (jQuery('#dataFieldEtiqueta').val()!=undefined && jQuery('#dataFieldEtiqueta').val()==\"---\"){\r\n\t\t\t\talert(\"Cal escollir un camp per etiquetar\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tvar capaLeafletId = $('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val();\r\n\t\t\t\tvar capaLeafletIdControl = $('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val();\r\n\t\t\t\tvar color = rgb2hex($('.color_etiqueta').css('background-color'));\r\n\t\t\t\tvar zoomInicial = $( \"#slider\" ).slider( \"values\", 0 );\r\n\t\t\t\tvar zoomFinal = $( \"#slider\" ).slider( \"values\", 1 );\r\n\t\t\t\tvar options = {\r\n\t\t\t\t\t\tcampEtiqueta:jQuery('#dataFieldEtiqueta').val(),\r\n\t\t\t\t\t\tfontFamily:jQuery('#font-family').val(),\r\n\t\t\t\t\t\tfontSize:jQuery('#font-size').val(),\r\n\t\t\t\t\t\tfontStyle:jQuery('#font-style').val(),\r\n\t\t\t\t\t\tfontColor:color,\r\n\t\t\t\t\t\topcionsVis:$(\"input[name=etiqueta]:checked\").val(),\r\n\t\t\t\t\t\tzoomInicial:zoomInicial,\r\n\t\t\t\t\t\tzoomFinal:zoomFinal\r\n\t\t\t\t};\r\n\t\t\t\tvar layerMap=map._layers[capaLeafletId];\r\n\t\t\t\tvar optionsMap;\r\n\t\t\t\tif (layerMap==undefined) {\r\n\t\t\t\t\tlayerMap = controlCapes._layers[capaLeafletId];\r\n\t\t\t\t\toptionsMap=layerMap.layer.options;\r\n\t\t\t\t}\r\n\t\t\t\telse optionsMap=layerMap.options;\r\n\t\t\t\t\r\n\t\t\t\tvar data={\r\n\t\t\t\t\t\tbusinessId: $('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(),\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\toptions:  JSON.stringify(options),\r\n\t\t\t\t\t\tnom:optionsMap.nom,\r\n\t\t\t\t\t\ttipus:optionsMap.tipusRang,\r\n\t\t\t\t\t\tgeometryType:optionsMap.geometryType\r\n\t\t\t\t};\r\n\t\t\t\tupdateVisualitzacioLayer(data).then(function(results){\r\n\t\t\t\t\treloadVisualitzacioLayer(layerMap, results.visualitzacio, results.layer, map);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});*/\r\n\t});\r\n}\r\n","/**\r\n * Funcionalitats d'afegir features al mapa (punts, línies poligons) i\r\n * edició de les seves característiques: estils, coordenades, \r\n * dades, capa on pertanyen...\r\n * */\r\n\r\nvar drawControl;\r\nvar featureActive,crt_Editing,crt_Remove;\r\nvar defaultPunt;\r\nvar canvas_linia={\"id\":\"cv_linia\",\"strokeStyle\":\"#FFC500\",\"lineWidth\":\"3\",\"tipus\":\"linia\",\"opacity\":\"100\"};\r\nvar canvas_pol={\"id\":\"cv_pol\",\"strokeStyle\":\"#FFC500\",\"opacity\":\"0.5\",\"fillStyle\":\"rgba(255, 197, 0,0.5)\",\"lineWidth\":\"3\",\"tipus\":\"pol\"};\r\nvar canvas_obj_l,cv_ctx_l;\r\nvar canvas_obj_p,cv_ctx_p;\r\nvar objEdicio={'esticEnEdicio':false,'obroModalFrom':'creaCapa','featureID':null,'esticSobre':false,'edicioPopup':'textFeature'};\r\n\r\nvar drawnItems = new L.FeatureGroup();\r\n\r\nfunction changeRandomDefaults(){\r\n\r\n\tvar randomColorInit=getRamdomColorFromArray();\r\n\tcanvas_linia.strokeStyle=randomColorInit;\r\n\tcanvas_pol.strokeStyle=randomColorInit;\r\n\tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(randomColorInit).r+\", \"+hexToRgb(randomColorInit).g+\", \"+hexToRgb(randomColorInit).b+\",0.5)\";\r\n\tvar colorText=getClassFromColor(randomColorInit)\t\r\n\tdefault_marker_style.markerColor = colorText,\r\n\tdefault_line_style.color=randomColorInit;\r\n\tdefault_area_style.color=randomColorInit;\r\n\tdefault_area_style.borderColor=randomColorInit;\r\n\tdefault_area_style.fillColor=\"rgb(\"+hexToRgb(randomColorInit).r+\", \"+hexToRgb(randomColorInit).g+\", \"+hexToRgb(randomColorInit).b+\")\";\t\r\n\testilP.colorGlif=\"#000000\";\r\n\testilP.iconFons=\"awesome-marker-web awesome-marker-icon-\"+colorText;\r\n\r\n}\r\n\r\nfunction addRandomStyleInit(){\r\n\r\n\tjQuery('#div_punt').removeClass();\r\n\tjQuery('#div_punt').addClass('awesome-marker-web awesome-marker-icon-'+default_marker_style.markerColor+' fa fa-');\t\r\n\tjQuery('#div_punt').css({\"font-size\":\"14px\", \"width\": \"28px\", \"height\": \"42px\", \"color\": \"rgb(0, 0, 0)\", \"background-color\": \"transparent\"});\t\r\n\tchangeDefaultLineStyle(canvas_linia);\r\n\tchangeDefaultPointStyle(estilP);\r\n\tchangeDefaultAreaStyle(canvas_pol);\r\n\r\n}\r\n\r\nfunction addDialegEstilsDraw() {\r\n\t\r\n\tchangeRandomDefaults();\r\n\taddHtmlInterficieDraw();\r\n\t\r\n\tjQuery('#div_mes_punts').on(\"click\", function(e) {\t\r\n\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaCapa);\r\n\t});\r\n\r\n\tjQuery('#div_mes_linies').on(\"click\", function(e) {\t\t\t\r\n\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaCapa);\r\n\t});\r\n\t\r\n\tjQuery('#div_mes_arees').on(\"click\", function(e) {\t\r\n\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaCapa);\r\n\t});\r\n\r\n\t\r\n\r\n}\r\n\r\n/**\r\n * Funcio que obre el menu dialeg d'estils per punts, linies i poligons\r\n * */\r\nfunction obrirMenuModal(_menuClass,estat,_from){\r\n\tobjEdicio.obroModalFrom=_from;\r\n\t//console.debug(_menuClass+\",\"+estat+\",\"+_from);\r\n\t//Udate dialog estils a mostrar\r\n\tif(_from == from_creaCapa){\r\n\t\t\r\n\t\tif(_menuClass.indexOf(\"arees\")!=-1){\r\n\t\t\tvar defPol = document.getElementById(\"cv_pol\").getContext(\"2d\");\r\n\t\t\tvar fillColor = defPol.fillStyle;\r\n\t\t\tif(fillColor.indexOf(\"rgb\")!=-1) fillColor = rgb2hex(defPol.fillStyle);\r\n\t\t\tvar icon = {color: defPol.strokeStyle,\r\n\t\t\t\t\t\tfillOpacity : getRgbAlpha(defPol.fillStyle),\r\n\t\t\t\t\t\tfillColor: fillColor,//rgb2hex(defPol.fillStyle),\r\n\t\t\t\t\t\tweight: defPol.lineWidth,\r\n\t\t\t\t\t\ttipus: t_polygon\r\n\t\t\t\t\t};\r\n\t\t\tupdateDialogStyleSelected(icon);\r\n\t\t\t\r\n\t\t}else if(_menuClass.indexOf(\"linies\")!=-1){\r\n\t\t\tvar defLine = document.getElementById(\"cv_linia\").getContext(\"2d\");\r\n\t\t\tvar icon = {color: defLine.strokeStyle,\r\n\t\t\t\t\t\tweight: defLine.lineWidth,\r\n\t\t\t\t\t\ttipus: t_polyline\r\n\t\t\t\t\t};\r\n\t\t\tupdateDialogStyleSelected(icon);\t\t\t\r\n\t\t\r\n\t\t}else{//es t_marker\r\n\r\n\t\t\t var styleProps = $(\"#div_punt\").css([\"width\",\"height\",\"color\",\"background-color\",\"font-size\"]);\r\n\t\t\t var punt_class = $(\"#div_punt\").attr(\"class\");\r\n\t\t\t \r\n\t\t\t console.info(punt_class);\r\n\t\t\t var lclass = punt_class.split(\" \");\r\n\t\t\t //console.debug(punt_class);\r\n\t\t\t //Si es punt inicial per defecte\r\n\t\t\t if(punt_class == \"dibuix_punt\"){\r\n\t\t\t\t\tvar icon = {icon: \"\",//glyph\r\n\t\t\t\t\t\t \ticonColor: \"#000000\",\r\n\t\t\t\t\t\t \tisCanvas: false,\r\n\t\t\t\t\t\t \tclassName: \"awesome-marker\",\r\n\t\t\t\t\t\t \tmarkerColor: 'orange',\r\n\t\t\t\t\t\t \ttipus: t_marker\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tconsole.info(icon);\r\n\t\t\t\tupdateDialogStyleSelected(icon);\t\t\t\t \r\n\t\t\t }else if (punt_class.indexOf(\"punt_r\")!=-1){\r\n\t\t\t\t \t\r\n\r\n\t\t\t\t \t//Es punt sense glyphon, CANVAS\r\n\t\t\t\t \tif(!lclass[3] || lclass[3] === \"fa-\"){\r\n\t\t\t\t\t\tvar icon = {icon: \"\",//glyph\r\n\t\t\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\r\n\t\t\t\t\t\t\t\t \tfillColor: rgb2hex(styleProps[\"background-color\"]),\r\n\t\t\t\t\t\t\t\t \tradius: getRadiusFromMida(styleProps.width),\r\n\t\t\t\t\t\t\t\t \tisCanvas: true,\r\n\t\t\t\t\t\t\t\t \ttipus: t_marker\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tupdateDialogStyleSelected(icon);\r\n\t\t\t\t\t\t\r\n\t\t\t\t \t}else{//Es punt amb glyphon\r\n\t\t\t\t\t \tvar iconGlyph = \"\";\r\n\t\t\t\t\t \tif(lclass[3]) iconGlyph = lclass[3];\r\n\t\t\t\t\t \t\r\n\t\t\t\t\t \tvar font = \" font\"+styleProps[\"font-size\"].substring(0,2);\r\n\t\t\t\t\t\tvar icon = {icon: iconGlyph.substring(3) + font,//glyph\r\n\t\t\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\r\n\t\t\t\t\t\t\t\t \tdivColor: rgb2hex(styleProps[\"background-color\"]),\r\n\t\t\t\t\t\t\t\t \tisCanvas: false,\r\n\t\t\t\t\t\t\t\t \tmarkerColor: punt_class,\r\n\t\t\t\t\t\t\t\t \ttipus: t_marker\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tupdateDialogStyleSelected(icon);\t\t\t\t\t \t\r\n\t\t\t\t \t}\r\n\t\t\t }else{//Pintxo\r\n\t\t\t\tvar markerColor = (lclass[1].split(\"-\"))[3];\r\n\t\t\t \tvar iconGlyph = \"\";\r\n\t\t\t \tif(lclass[3]) iconGlyph = lclass[3];\r\n\t\t\t \t\r\n\t\t\t\tvar icon = {icon: iconGlyph.substring(3),//glyph\r\n\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\r\n\t\t\t\t\t\t \tisCanvas: false,\r\n\t\t\t\t\t\t \tclassName: \"awesome-marker\",\r\n\t\t\t\t\t\t \tmarkerColor: markerColor,\r\n\t\t\t\t\t\t \ttipus: t_marker\r\n\t\t\t\t};\r\n\t\t\t\tupdateDialogStyleSelected(icon);\r\n\t\t\t }\r\n\t\t}\r\n\t}\t\r\n\t\r\n    if (jQuery.isPlainObject( _from )){\r\n    \tif (_from.from == tem_clasic){\r\n    \t\t//TODO\r\n    \t\t/*\r\n    \t\tjQuery('.fila-awesome-markers').hide();\r\n            activaPuntZ();\r\n            jQuery('#dialog_tematic_rangs').modal('hide');\r\n            jQuery(_menuClass).modal(estat);\r\n            */\r\n    \t}else{\r\n    \t\t\r\n\r\n    \t\t\r\n    \t\tvar layers_from = controlCapes._layers[_from.leafletid].layer.getLayers();\r\n        \tif( layers_from.length > num_max_pintxos || _from.tipus == t_url_file){\r\n                jQuery('.fila-awesome-markers').hide();\r\n                jQuery('#filaM').hide();\r\n                estilP.iconGlif = \"fa fa-\";\r\n                activaPuntZ();\r\n        \t}else{\r\n        \t\tjQuery('#filaM').show();\r\n                jQuery('.fila-awesome-markers').show();\r\n               \r\n        \t}\r\n        \tjQuery('.modal').modal('hide');     \r\n            jQuery(_menuClass).modal(estat);\r\n    \t}\r\n    }else{\r\n    \tjQuery('.fila-awesome-markers').show();\r\n    \tjQuery('#filaM').show();\r\n    \tjQuery('.modal').modal('hide');     \r\n        jQuery(_menuClass).modal(estat);\r\n    }\r\n    \r\n}\r\n\r\nfunction initCanvas(){\r\n\taddGeometryInitP(document.getElementById(canvas_pol.id),\"inicial\");\r\n\taddGeometryInitP(document.getElementById(canvas_pol.id+\"0\"));\r\n\taddGeometryInitL(document.getElementById(canvas_linia.id),\"inicial\");\t\r\n\taddGeometryInitL(document.getElementById(canvas_linia.id+\"0\"));\r\n\t\r\n    $('#colorpalette_pf').colorPalette().on('selectColor', function(e) {   \t\r\n    \t$('.fill_color_pol').css('background-color',e.color);\r\n        $('.fill_color_pol').css('color',e.color);\r\n        canvas_pol.opacity=jQuery('#cmb_trans').val();//Forcem el valor de opacity pq en Chrome no anava bé\r\n        canvas_pol.fillStyle=\"rgba(\"+hexToRgb(e.color).r+\", \"+hexToRgb(e.color).g+\", \"+hexToRgb(e.color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\r\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\r\n    });\t\r\n    \r\n    $('#colorpalette_pl').colorPalette().on('selectColor', function(e) {    \t\r\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\r\n    \t$('.border_color_pol').css('border-color',e.color);\r\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();//Forcem el valor de opacity pq en Chrome no anava bé\r\n    \tcanvas_pol.strokeStyle=e.color;\r\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\r\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));  \r\n    });\r\n\t\r\n\t$('#colorpalette_ll').colorPalette().on('selectColor', function(e) {   \t\r\n    $('.border_color_linia').css('background-color',e.color);\r\n\t\tcanvas_linia.strokeStyle=e.color;\r\n\t\taddGeometryInitL(document.getElementById(\"cv_linia0\"));\r\n\t});\r\n \r\n\t$('#colorpalette_icon').colorPalette().on('selectColor', function(e) {  \r\n\t\t $('.fill_color_icon').css('background-color',e.color);\r\n\t\t\testilP.colorGlif=e.color;\t\t\t\r\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\r\n\t\t\tif(e.color==\"#FFFFFF\"){\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\r\n\t\t\t}else{\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\r\n\t\t\t}\r\n\t\t\tjQuery('#div_punt0').css('color',estilP.colorGlif);\r\n\t\t\tjQuery(this).addClass(\"estil_selected\");\r\n\t});\r\n\t\r\n\r\n\r\n\t$('#colorpalette_punt').colorPalette().on('selectColor', function(e) {  \r\n\t\t $('.fill_color_punt').css('background-color',e.color);\t\t\t\r\n\t\t if(!jQuery('#div_puntZ').hasClass(\"estil_selected\")){\r\n\t\t\t\tactivaPuntZ();\t\t\t\t\r\n\t\t }else{\t\t \r\n\t\t\testilP.divColor=e.color;\t\t\t\t\r\n\t\t\tjQuery('#div_punt0').css('background-color',estilP.divColor);\r\n\t\t }\r\n\t\t    jQuery('#div_punt9').css('background-color',e.color);\t\t\r\n\t\t});\r\n\t\r\n\tvar options = {\r\n\t\t\tcolors:[['#ffc500', '#ff7f0b', '#ff4b3a', '#ae59b9', '#00afb5', '#7cbd00', '#90a6a9', '#ebf0f1']]\r\n\t};\r\n\t\r\n\t$('#colorpalette_marker').colorPalette(options).on('selectColor', function(e) {  \r\n\t\t $('.fill_color_marker').css('background-color',e.color);\t\r\n\t\t activaPuntM(e.color);\r\n\t});\t\r\n\r\n\tjQuery(\"#cmb_trans\").on('change', function(e) { \r\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\r\n    \tcanvas_pol.opacity=jQuery(this).val();\r\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\r\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\r\n    });\r\n    \r\n    jQuery(\"#cmb_gruix\").on('change', function(e) { \r\n    \tcanvas_pol.lineWidth=jQuery(this).val();\r\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\r\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();\r\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\r\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\r\n    });\r\n    \r\n    jQuery(\"#cmb_gruix_l\").on('change', function(e) { \r\n    \tcanvas_linia.lineWidth=jQuery(this).val();\r\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\r\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();\r\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\r\n    \taddGeometryInitL(document.getElementById(\"cv_linia0\"));\r\n    });\r\n}\r\n\r\nfunction addGeometryInitL(canvas,inicial){\r\n\tvar\tcv_ctx_l=canvas.getContext(\"2d\");\r\n\tcv_ctx_l.clearRect(0, 0, canvas.width, canvas.height);\r\n\tcv_ctx_l.moveTo(0.7,39.42);\r\n\tcv_ctx_l.lineTo(2.05,34.43);\r\n\tcv_ctx_l.lineTo(3.62,31.00);\r\n\tcv_ctx_l.lineTo(5.95,27.72);\r\n\tcv_ctx_l.lineTo(8.17,25.61);\r\n\tcv_ctx_l.lineTo(10.72,23.84);\r\n\tcv_ctx_l.lineTo(13.059,22.73);\r\n\tcv_ctx_l.lineTo(15.32,22.28);\r\n\tcv_ctx_l.lineTo(17.76,22.08);\r\n\tcv_ctx_l.lineTo(20.30,21.47);\r\n\tcv_ctx_l.lineTo(23.28,20.51);\r\n\tcv_ctx_l.lineTo(25.88,18.90);\r\n\tcv_ctx_l.lineTo(28.265,16.83);\r\n\tcv_ctx_l.lineTo(29.9,14.71);\r\n\tcv_ctx_l.lineTo(31.89,12.195);\r\n\tcv_ctx_l.lineTo(33.62,9.42);\r\n\tcv_ctx_l.lineTo(34.81,6.64);\r\n\tcv_ctx_l.lineTo(35.46,3.92);\r\n\tcv_ctx_l.lineTo(35.52,0.54);\r\n\tcv_ctx_l.strokeStyle=canvas_linia.strokeStyle;\r\n\tcv_ctx_l.lineWidth=canvas_linia.lineWidth;\r\n\tvar idLinia = canvas.id;\r\n\tif ((inicial==null || inicial==undefined) && idLinia=='cv_linia0'){\r\n\t\tcv_ctx_l.shadowColor = '#999999';\r\n\t\tcv_ctx_l.shadowBlur = 20;\r\n\t\tcv_ctx_l.shadowOffsetX = 15;\r\n\t\tcv_ctx_l.shadowOffsetY = 15;\r\n\t\tcv_ctx_l.stroke(); \t\r\n\t\tcv_ctx_l.shadowOffsetX = -15;\r\n\t\tcv_ctx_l.stroke(); \t\r\n\t\tcv_ctx_l.shadowOffsetY = -15;\r\n\t\tcv_ctx_l.stroke(); \r\n\t\tcv_ctx_l.shadowOffsetX = 15;\r\n\t}\r\n\tcv_ctx_l.stroke(); \t\r\n}\r\n\r\nfunction addGeometryInitP(canvas,inicial){\r\n\tvar\tcv_ctx_p=canvas.getContext(\"2d\");\r\n\tcv_ctx_p.clearRect(0, 0, canvas.width, canvas.height);\r\n\tcv_ctx_p.moveTo(5.13,15.82);\r\n\tcv_ctx_p.lineTo(25.49,5.13);\r\n\tcv_ctx_p.lineTo(37.08,13.16);\r\n\tcv_ctx_p.lineTo(20.66,38.01);\r\n\tcv_ctx_p.lineTo(2.06,33.67);\r\n\tcv_ctx_p.closePath();\r\n\tcv_ctx_p.strokeStyle=canvas_pol.strokeStyle;\r\n//\tconsole.debug(canvas_pol);\r\n\tif(canvas_pol.fillStyle.indexOf(\"rgb\")!= -1) cv_ctx_p.fillStyle = canvas_pol.fillStyle;\r\n\telse cv_ctx_p.fillStyle=hexToRgba(canvas_pol.fillStyle,canvas_pol.opacity );\r\n\t\r\n//\tcv_ctx_p.fillStyle=canvas_pol.fillStyle;\r\n\tcv_ctx_p.lineWidth=canvas_pol.lineWidth;\r\n//\tcv_ctx_p.opacity=canvas_pol.opacity;\r\n\tvar idPol = canvas.id;\r\n\tif ((inicial==null || inicial==undefined) && idPol=='cv_pol0'){\r\n\t\tcv_ctx_p.shadowColor = '#999999';\r\n\t\tcv_ctx_p.shadowBlur = 20;\r\n\t\tcv_ctx_p.shadowOffsetX = 15;\r\n\t\tcv_ctx_p.shadowOffsetY = 18;\t\r\n\t\tcv_ctx_p.fill();\r\n\t\tcv_ctx_p.stroke(); \r\n\t\tcv_ctx_p.shadowOffsetX = -15;\r\n\t\tcv_ctx_p.fill();\r\n\t\tcv_ctx_p.stroke(); \t\r\n\t\tcv_ctx_p.shadowOffsetY = -18;\r\n\t\tcv_ctx_p.fill();\r\n\t\tcv_ctx_p.stroke(); \r\n\t\tcv_ctx_p.shadowOffsetX = 15;\r\n\t}\r\n\t\tcv_ctx_p.fill();\r\n\t\tcv_ctx_p.stroke(); \r\n}\r\n\r\n//Funcio inicialitzar i afegir drawControl\r\nfunction addDrawToolbar() {\r\n\tinitCanvas();\r\n\t\r\n\tvar ptbl = L.Icon.extend({\r\n\t\toptions : {\r\n\t\t\tshadowUrl : null,\r\n\t\t\ticonAnchor : new L.Point(14, 40),\r\n\t\t\ticonSize : new L.Point(28, 40)\r\n\t\t}\r\n\t});\r\n\r\n\tdefaultPunt= L.AwesomeMarkers.icon(default_marker_style);\r\n\tmap.addLayer(drawnItems);\r\n\t\r\n\tvar options = {\r\n\t\tdraw : false,\r\n\t\tpolyline : {\r\n\t\t\tguidelineDistance : 2,\r\n\t\t\trepeatMode:false,\r\n\t\t\tshapeOptions : {\r\n\t\t\t\tcolor : '#FFC400',\r\n\t\t\t\tweight : 3,\r\n\t\t\t\topacity : 1,\r\n\t\t\t\ttipus: t_polyline\r\n\t\t\t},\r\n\t\t\tguideLayers: guideLayers\r\n\t\t},\r\n\t\tpolygon : {\r\n\t\t\tallowIntersection : true, // Restricts shapes\r\n\t\t\trepeatMode:false,\r\n\t\t\tguidelineDistance : 2,\t\t\t\r\n\t\t\tshapeOptions : {\r\n\t\t\t\tcolor : '#FFC400',\r\n\t\t\t\tfillColor: '#FFC400',\r\n\t\t\t\tweight : 3,\r\n\t\t\t\tfillOpacity : 0.5,\r\n\t\t\t\ttipus: t_polygon\r\n\t\t\t},\r\n\t\t\tsnapDistance: 10,\r\n\t\t\tguideLayers: guideLayers\r\n\t\t},\r\n\t\tmarker:{repeatMode:false,\r\n\t\t\ticon:L.icon({iconUrl:'/geocatweb/css/images/blank.gif'}),\t\t\r\n\t\t\tsnapDistance: 10,\r\n\t\t\tsnapVertices: false,\r\n\t\t\tguideLayers: guideLayers\r\n\t\t},\r\n\t\tedit :{\r\n\t\t    featureGroup: drawnItems, //REQUIRED!!\r\n\t\t    remove: false,\r\n\t\t    edit:false\r\n\t\t    }\r\n\t};\r\n\tdrawControl = new L.Control.Draw(options);\r\n\t\r\n\tmap.addControl(drawControl);\r\n\taddDrawTooltips();\r\n\taddRandomStyleInit();\r\n}\r\n\r\n//function showEditText(accio){\r\n//\tjQuery('.search-edit').animate({\r\n//\t\theight :accio\r\n//\t});\r\n//}\r\n\r\nfunction activaEdicioUsuari() {\r\n\tjQuery('#div_punt').on('click', function() {\r\n\t\tif(featureActive){featureActive.disable();}\r\n\t\tfeatureActive = new L.Draw.Marker(map, drawControl.options.marker);\t\t \r\n\t\tfeatureActive.enable();\r\n\t});\r\n\r\n\tjQuery('#div_linia').on('click', function() {\r\n\t\tif(featureActive){featureActive.disable();}\r\n\t\tfeatureActive = new L.Draw.Polyline(map, drawControl.options.polyline);\r\n\t\tfeatureActive.enable();\r\n\t});\r\n\r\n\tjQuery('#div_area').on('click', function() {\r\n\t\tif(featureActive){featureActive.disable();}\r\n\t\tfeatureActive = new L.Draw.Polygon(map, drawControl.options.polygon);\r\n\t\tfeatureActive.enable();\r\n\t});\r\n\r\n\tmap.on('draw:drawstart',function(e){\r\n\t\tmap.off('click',L.TileLayer.BetterWMS.getFeatureInfo);\t\t\r\n\t});\r\n\t\r\n\t//Edicio de feature existent\r\n\tmap.on('click',function(e){\r\n\t\tfor(var i = 0;i < guideLayers.length; i++) {\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\tif (guideLayers[i].snapediting!=undefined)  guideLayers[i].snapediting.disable();\r\n\t\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\r\n\t\t\t\ttry{\r\n\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.disable();\r\n\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif(objEdicio.esticEnEdicio){\t\t\t\r\n\t\t\ttry{\r\n\t\t\t\tupdateFeatureMove(objEdicio.featureID, crt_Editing._featureGroup._leaflet_id, objEdicio.capaEdicioLeafletId);\r\n\t\t\t}catch(exc){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\tif(crt_Editing){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tcrt_Editing.disable();\r\n\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n//\t\t\tupdateFeatureMove(objEdicio.featureID, objEdicio.capaEdicioLeafletId);\t\t\r\n\t\t}\r\n\t\tif(crt_Editing){\r\n\t\t\ttry{\r\n\t\t\t\tcrt_Editing.disable();\r\n\t\t\t}catch(exc){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\t\r\n\t//Controlem que si hi ha un click en un altre lloc del mapa l'edició de features es desactiva\r\n\t$('body').click(function(event) {\t\t\r\n\t\tif(objEdicio.esticEnEdicio){\r\n\t\t\t var target = $(event.target);\r\n\t\t\t for(var i = 0;i < guideLayers.length; i++) {\t\t\t\r\n\t\t\t\t \t\r\n\t\t\t\t\t\tif (guideLayers[i].snapediting!=undefined)  guideLayers[i].snapediting.disable();\r\n\t\t\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.disable();\r\n\t\t\t\t \t}catch(exc){\r\n\t\t\t\t \t\t\r\n\t\t\t\t \t}\r\n\t\t\t}\r\n\t\t\t if(objEdicio.esticEnEdicio){\t\t\t\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tupdateFeatureMove(objEdicio.featureID, crt_Editing._featureGroup._leaflet_id, objEdicio.capaEdicioLeafletId);\r\n\t\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(crt_Editing){\r\n\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\tcrt_Editing.disable();\r\n\t\t\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n//\t\t\t\t\tupdateFeatureMove(objEdicio.featureID, objEdicio.capaEdicioLeafletId);\t\t\r\n\t\t\t\t}\r\n\t\t\r\n\t\t\tif(crt_Editing){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tcrt_Editing.disable();\r\n\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttarget.click();\r\n\t\t}\r\n\t});\r\n\t\r\n\tmap.on('preclick',function(e){\r\n\t\tif(crt_Editing){\r\n\t\t\tcrt_Editing.disable();\r\n\t\t}\r\n\t});\r\n\t\r\n\t//Afegir features: point, lines and polygons\r\n\tmap.on('draw:created', function(e) {\r\n\t\tvar type = e.layerType, layer = e.layer;\r\n\t\tvar totalFeature;\r\n\t\tvar tipusCat,tipusCatDes;\r\n\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dibuixar geometria', type, 1]});\r\n\t\t//_kmq.push(['record', 'dibuixar geometria', {'from':'mapa', 'tipus user':tipus_user, 'type':type}]);\r\n\t\t drawnItems.addLayer(layer);\r\n\t\tif (type === t_marker) {\r\n\t\t\ttipusCat=window.lang.translate('Títol Punt');\r\n\t\t\ttipusCatDes=window.lang.translate('Descripció Punt');\r\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Punt');\r\n\t\t\t\r\n\t\t\t//Mira si és icona\r\n\t\t\tif(!defaultPunt.options.isCanvas){\r\n\t\t\t\t var divIcon = L.divIcon({ \r\n\t\t\t\t\t  html: \"<span style='color:blue;'>textToDisplay</span>\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tlayer=L.marker([layer.getLatLng().lat,layer.getLatLng().lng],\r\n\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t tipus: t_marker}).addTo(map);//.bindLabel('Look revealing label!', { noHide: true , direction: 'center',className: \"my-label\", offset: [0, 0]}).addTo(map);\r\n\t\t\t}else{\r\n\t\t\t\t//Si és cercle sense glifon\r\n\t\t\t\tlayer= L.circleMarker([layer.getLatLng().lat,layer.getLatLng().lng],\r\n\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \r\n\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\r\n\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\r\n\t\t\t\t\t\t  color :  defaultPunt.options.color,\r\n\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\r\n\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\r\n\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\r\n\t\t\t\t\t\t  tipus: t_marker}\r\n\t\t\t\t\t\t\r\n\t\t\t\t).addTo(map);//.bindLabel('Look revealing label!', { noHide: true, direction: 'center',className: \"my-label\", offset: [0, 0] }).addTo(map);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_marker){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+ index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_marker\r\n\t\t\t\t};\t\t\t\t\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t\t\r\n\t\t\t}else if(capaUsrActiva == null){\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_marker\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlayer.properties={\r\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\r\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\r\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\r\n\t\t\t\t\t'tipusFeature':t_marker};\t\r\n\t\t\t\r\n\t\t\tlayer.properties.data={\r\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t};\r\n\t\t\t/*try{\r\n\t\t\t\t//Active snapping\r\n\t\t\t\t//layer.snapediting = new L.Handler.MarkerSnap(map, layer,{snapDistance:10});\r\n\t\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\r\n\t\t\t\t        // Add every already drawn layer to snap list\r\n\t\t\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\r\n\t\t\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\r\n\t\t\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\r\n\t\t\t\t        guideLayers[i].snapediting.disable();\r\n\t\t\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \r\n\t\t\t\t }\r\n\t\t\t}catch(exc){\r\n\t\t\t\t\r\n\t\t\t}*/\r\n\t\t\t\r\n\t\t\t  // Add to drawnItems\r\n\t\t\t drawnItems.addLayer(layer);\r\n\t\t\t // Add newly drawn feature to list of snappable features\r\n\t\t\t  guideLayers.push(layer);\r\n\t\t    \r\n\t\t\tcapaUsrActiva.addLayer(layer);\r\n\t\t\t\r\n\t\t} else if (type === t_polyline) {\r\n\t\t\ttipusCat=window.lang.translate('Títol Línia');\r\n\t\t\ttipusCatDes=window.lang.translate('Descripció Línia');\r\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Línia');\r\n\t\t\t\r\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_polyline){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_polyline\r\n\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t}else if(capaUsrActiva == null){\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_polyline\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlayer.properties={\r\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\r\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\r\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\r\n\t\t\t\t\t'tipusFeature':t_polyline,\r\n\t\t\t\t\t'mida': calculateDistance(layer.getLatLngs()) };\t\r\n\t\t\t\r\n\t\t\tlayer.properties.data={\r\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t};\t\r\n\t\t\t//Activate snapping\r\n\t\t\t/*layer.snapediting = new L.Handler.PolylineSnap(map, layer,{snapDistance:10});\r\n\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\r\n\t\t        // Add every already drawn layer to snap list\r\n\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\r\n\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\r\n\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\r\n\t\t        guideLayers[i].snapediting.disable();\r\n\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \r\n\t\t\t }*/\r\n\t\t\t \r\n\t\t\t // Add to drawnItems\r\n\t\t\t drawnItems.addLayer(layer);\r\n\t\t\t // Add newly drawn feature to list of snappable features\r\n\t\t\t  guideLayers.push(layer);\r\n\t\t   \r\n\t\t\tcreateClass('.polyline-style',\"font-family:Verdana;font-size:20px;color:red;\");\r\n\t\t\tcapaUsrActiva.addLayer(layer);\r\n\t\t\t\r\n\t\t} else if (type === t_polygon) {\r\n\t\t\ttipusCat=window.lang.translate('Títol Polígon');\r\n\t\t\ttipusCatDes=window.lang.translate('Descripció Polígon');\t\r\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Polígon');\r\n\t\t\tvar mida = L.GeometryUtil.geodesicArea(layer.getLatLngs());\r\n\t\t\tmida = L.GeometryUtil.readableArea(mida,true);\r\n\t\t\t\r\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_polygon){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_polygon\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\t\t\t\t\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t}else if(capaUsrActiva == null){\r\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\r\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\r\n\t\t\t\tcapaUsrActiva.options = {\r\n\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\r\n\t\t\t\t\tzIndex :  -1,\r\n//\t\t\t\t\ttipus : t_tematic,\r\n\t\t\t\t\ttipus : t_visualitzacio,\r\n\t\t\t\t\tgeometryType: t_polygon\r\n\t\t\t\t};\r\n\t\t\t\tmap.addLayer(capaUsrActiva);\r\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\r\n\t\t\t}\r\n\t\t\tlayer.properties={\r\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\r\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\r\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\r\n\t\t\t\t\t'tipusFeature':t_polygon,\r\n\t\t\t\t\t'mida': calculateArea(layer)};\r\n\t\t\t\r\n\t\t\tlayer.properties.data={\r\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\r\n\t\t\t};\t\t\r\n\t\t\t//Activate snapping\r\n\t\t\t/*layer.snapediting = new L.Handler.PolylineSnap(map, layer,{snapDistance:10});\r\n\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\r\n\t\t        // Add every already drawn layer to snap list\r\n\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\r\n\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\r\n\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\r\n\t\t        guideLayers[i].snapediting.disable();\r\n\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \r\n\t\t\t }\r\n\t\t\t*/\r\n\t\r\n\t\t\t  // Add to drawnItems\r\n\t\t\t drawnItems.addLayer(layer);\r\n\t\t\t // Add newly drawn feature to list of snappable features\r\n\t\t\tguideLayers.push(layer);\r\n\t\t\tcapaUsrActiva.addLayer(layer);\t\t\t\r\n\t\t}\r\n\t});\r\n\t\r\n}\r\n\r\n//Funcio que crea Pop up de la feature quan te opcio d'edicio\r\nfunction createPopupWindow(layer,type){\r\n//\tconsole.debug('createPopupWindow');\r\n\tvar html = createPopUpContent(layer,type);\r\n\tlayer.bindPopup(html,{'offset':[0,-25]});\r\n\t\r\n\t//eventos del popup\r\n\tjQuery(document).on('click', \"#titol_pres\", function(e) {\r\n\t\tmodeEditText();\r\n\t});\r\n\t\r\n\tjQuery(document).on('click', \"#des_pres\", function(e) {\r\n\t\tmodeEditText();\r\n\t});\r\n\r\n\tjQuery(document).on('click', \".bs-ncapa li a\", function(e) {\r\n\t\te.preventDefault();\r\n\t\tvar accio;\r\n\t\tif(jQuery(this).attr('id').indexOf('#')!=-1){\t\t\t\r\n\t\t\taccio=jQuery(this).attr('id').split(\"#\");\t\t\t\t\r\n\t\t}\r\n\t\t\r\n\t\tobjEdicio.featureID=accio[1];\r\n\t\tif(accio[0].indexOf(\"layer_edit\")!=-1){\r\n\t\t\tobjEdicio.edicioPopup='textCapa';\r\n\t\t\tjQuery('#layer_accio').text(window.lang.translate('Canviar el nom de la capa'))\r\n\t\t\tjQuery('#capa_edit').val(jQuery('#cmbCapesUsr').val());\r\n\t\t\tmodeLayerTextEdit();\r\n\r\n\t\t}else if(accio[0].indexOf(\"layer_add\")!=-1){\r\n\t\t\tobjEdicio.edicioPopup='nouCapa';\r\n\t\t\tjQuery('#layer_accio').text(window.lang.translate('Nom nova capa'))\r\n\t\t\tjQuery('#capa_edit').val(\"\").attr('placeholder',window.lang.translate('Nova capa'));\r\n\t\t\tmodeLayerTextEdit();\r\n\t\t}else{\r\n\t\t\t\r\n\t\t}\r\n\t});\r\n\t\r\n\t jQuery(document).on('focus', \".bs-ncapa li select\", function(e) {\r\n\t\t $(this).data('cmbCapesUsr_old',$(this).val());\r\n\t });\t \r\n\t \r\n\t jQuery(document).on('change', \".bs-ncapa li select\", function(e) {\r\n\t\t    e.stopImmediatePropagation();\r\n\t\t    \r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\t\t    \r\n//\t\t    console.debug('on change select cmbusrcapa');\r\n\t\t\tvar accio;\r\n\t\t\tif(jQuery(this).attr('id').indexOf('-')!=-1){\t\t\t\r\n\t\t\t\taccio=jQuery(this).attr('id').split(\"-\");\t\t\t\t\r\n\t\t\t}\r\n\t\t\tobjEdicio.featureID=accio[1];\r\n\t\t\t\t\t\t\r\n\t\t\tvar toBusinessId = jQuery(this).val().split(\"#\");\r\n\t\t\tvar fromBusinessId = $(this).data('cmbCapesUsr_old').split(\"#\");\r\n\t\t\t//Actualitzem valor antic\r\n\t\t\t$(this).data('cmbCapesUsr_old',$(this).val());\r\n\t\t\t\r\n\t\t\tobjEdicio.featureID=accio[1];\r\n\t\t\tvar obj = map._layers[objEdicio.featureID];\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t/*NOU MODEL*/\r\n\t\t\tvar features = {\r\n\t\t\t\t\ttype: obj.properties.tipusFeature,\r\n\t\t\t\t\tid:3124,\r\n\t\t\t\t\tbusinessId: obj.properties.businessId,//Bid de la geometria q estas afegint\r\n\t\t\t\t\tproperties: obj.properties.data,\r\n\t\t\t\t\testil: obj.properties.estil,\r\n\t\t\t\t\tgeometry: obj.properties.feature.geometry\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\tfeatures = JSON.stringify(features);\r\n\t\t\t\r\n\t\t\tdata= {\r\n\t\t\t\ttoBusinessId: toBusinessId[0],//bID de la visualitzacio-capa\r\n\t\t\t\tfromBusinessId: fromBusinessId[0],//bID de la visualitzacio-capa\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tfeatures: features\r\n\t\t\t}\t\r\n\t\t\t\r\n\t\t\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\r\n//\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\r\n\t\t\t\tif(resultsMove.status === 'OK'){\r\n\t\t\t\t\tvar toLayer = controlCapes._layers[''+toBusinessId[1]+''].layer;//map._layers[''+toBusinessId[1]+''];\r\n\t\t\t\t\tvar fromLayer = map._layers[''+fromBusinessId[1]+''];\r\n\t\t\t\t\tfromLayer.removeLayer(obj);\r\n\t\t\t\t\t//Actualitzem capa activa\r\n\t\t\t\t\t//Primer desactivo l'event, per si la capaActiva coincideix amb la capa toLayer\r\n\t\t\t\t\tif(toLayer) toLayer.removeEventListener('layeradd');\r\n\t\t\t\t\t\r\n\t\t\t\t\ttoLayer.addLayer(obj);\r\n\t\t\t\t\t//Refresh de la capa\r\n\t\t\t\t\tcontrolCapes._map.removeLayer(toLayer);\r\n\t\t\t\t\tcontrolCapes._map.addLayer(toLayer);\t\t\t\t\t\r\n\t\t\t\t\tcapaUsrActiva = toLayer;\r\n\t\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tobj.properties.capaBusinessId = capaUsrActiva.options.businessId;\r\n\t\t\t\t\tobj.properties.capaNom = capaUsrActiva.options.nom;\r\n\t\t\t\t\tobj.properties.capaLeafletId = capaUsrActiva._leaflet_id;\r\n\t\t\t\t\tobj.properties.estil.businessId = resultsMove.estilBid;\r\n\t\t\t\t\t//Actualitzem popup del marker\r\n\t\t\t\t\t//var html = createPopUpContent(obj,obj.options.tipus);\r\n\t\t\t\t\t//obj.setPopupContent(html);\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar nom=resultsMove.results.properties.nom;\r\n\t\t\t\t\tvar props=resultsMove.results.properties;\r\n\t\t\t\t\tvar html = refrescarPopUp(nom,props,obj._leaflet_id,obj.properties.tipusFeature,obj.properties.capaLeafletId);\r\n\t\t\t\t\tmap.closePopup();\r\n\t\t\t\t\tobj.closePopup();\r\n\t\t\t\t\tconsole.debug(obj);\r\n\t\t\t\t\tobj.bindPopup(html,{'offset':[0,-25]});\t\t\t\t\t\r\n\t\t\t\t\tobj.openPopup();\r\n\t\t\t\t\tvar toLayer1 = controlCapes._layers[''+toBusinessId[1]+''];\r\n\t\t\t\t\t\r\n\t\t\t\t\tactualitzacioTematic(toLayer1,toLayer.options.businessId,\"3124\",obj,features,\"modificacio\");\r\n\t\t\t\r\n\t\t\t\t\t//Actualitzem l'enllaç d'obrir la finestra de dades\r\n\t\t\t\t\tvar htmlDataTable =jQuery(\"#feature_data_table_\"+accio[1]).html();\r\n\t\t\t\t\tif (undefined != htmlDataTable){\r\n\t\t\t\t\t\tvar stringsDataTableA = htmlDataTable.split(\"##\");\r\n\t\t\t\t\t\tjQuery(\"#feature_data_table_\"+accio[1]).html(stringsDataTableA[0]+\"##\"+stringsDataTableA[1]+\"##\"+stringsDataTableA[2]+\"##\"+toLayer._leaflet_id+\"##\"+stringsDataTableA[4]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//NO CAL: com cridem addLayer, de controlCapes, ja s'actualitzen els comptadors de les capes\r\n\t\t\t\t\t//updateFeatureCount(fromBusinessId, toBusinessId);\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t\t\t});\t\t\t\t\t\r\n\t });\r\n\t \r\n\tjQuery(document).on('click', \".bs-popup li a\", function(e) {\r\n\t\te.stopImmediatePropagation();\r\n\t\tvar accio;\r\n\t\tif(jQuery(this).attr('id').indexOf('#')!=-1){\t\t\t\r\n\t\t\tif (jQuery(this).attr('id').indexOf('##')>-1) accio=jQuery(this).attr('id').split(\"##\");\t\t\t\r\n\t\t\telse accio=jQuery(this).attr('id').split(\"#\");\t\t\t\t\r\n\t\t}\r\n\t\tobjEdicio.featureID=accio[1];\r\n\t\t\r\n\t\tif(accio[0].indexOf(\"feature_edit\")!=-1){\r\n\r\n\t\t\t//Update modal estils, amb estil de la feature seleccionada\r\n\t\t\tvar obj = map._layers[accio[1]];\r\n\t\t\tif(obj.options.icon /*|| obj.options.icon.options.markerColor.indexOf(\"punt_r\")!=-1*/){\r\n\t\t\t\tvar icon = obj.options.icon.options;\t\r\n\t\t\t}else if(obj._options){\r\n\t\t\t\tvar icon = obj._options;\r\n\t\t\t}else{\r\n\t\t\t\tvar icon = obj.options;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\r\n\t\t\tupdateDialogStyleSelected(icon);\r\n\r\n\t\t\t\r\n\t\t\tif(accio[2].indexOf(\"marker\")!=-1){\r\n\t\t\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaPopup);\r\n\t\t\t}else if(accio[2].indexOf(\"polygon\")!=-1){\r\n\t\t\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaPopup);\r\n\t\t\t}else{\r\n\t\t\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaPopup);\r\n\t\t\t}\r\n\t\t}else if(accio[0].indexOf(\"feature_remove\")!=-1){\r\n\t\t\tmap.closePopup();\r\n\t\t\tvar data = {\r\n\t            businessId: map._layers[objEdicio.featureID].properties.businessId,\r\n\t            uid: Cookies.get('uid')\r\n\t        };\r\n\t\t\t\r\n\t\t\tvar features = {\r\n\t\t\t\t\ttype:\"Feature\",\r\n\t\t\t\t\tid: 3124,\r\n\t\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.businessId,\r\n\t\t\t\t\tproperties: map._layers[objEdicio.featureID].properties.data,\r\n\t\t\t\t\testil: map._layers[objEdicio.featureID].properties.estil,\r\n\t\t\t\t\tgeometry: map._layers[objEdicio.featureID].properties.feature.geometry\r\n\t\t\t\t};\t\t\t\t\r\n\t\t\t\r\n\t\t\tfeatures = JSON.stringify(features);\r\n\t\t\t\r\n\t\t\tvar data = {\r\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.capaBusinessId,//bID de la visualitzacio-capa\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tfeatures: features\r\n\t\t\t};\r\n\t\t\tvar businessIdCapaOrigen=map._layers[objEdicio.featureID].properties.capaBusinessId;\r\n\t\t\tremoveGeometriaFromVisualitzacio(data).then(function(results){\r\n\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t/*var capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\r\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\r\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\r\n\t\t\t\t\t//Actualitzem comptador de la capa\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) updateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\r\n\t\t\t\t\telse {\t\t\t\t\t\t\r\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\r\n\t\t\t\t\t}*/\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\r\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\r\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) {\r\n\t\t\t\t\t\tupdateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\t\t\t\t\t\t\r\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\r\n\t\t\t\t\t}\t\t\r\n\t\t\t\t\t var layer = controlCapes._layers[capaLeafletId];\r\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\r\n\t\t\t\t\tactualitzacioTematic(layer,businessIdCapaOrigen,null,null,null,\"baixa\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\r\n\t\t\t});\t\t\r\n\t\t\t\r\n\t\t}else if(accio[0].indexOf(\"feature_text\")!=-1){\r\n\t\t\tmodeEditText();\r\n\t\t}else if(accio[0].indexOf(\"feature_move\")!=-1){\r\n\t\t\tobjEdicio.esticEnEdicio=true;\r\n\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\r\n\t\t\tif (capaLeafletId==undefined) capaLeafletId =  map._layers[objEdicio.featureID]._leaflet_id;\r\n\t\t\tobjEdicio.capaEdicioLeafletId = capaLeafletId;\r\n\t\t\t//Actualitzem capa activa\r\n\t\t\tif (capaUsrActiva){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t}\r\n\t\t\tcapaUsrActiva = map._layers[capaLeafletId];\r\n\t\t\tvar capaEdicio = new L.FeatureGroup();\r\n\t\t\tcapaEdicio.addLayer(map._layers[objEdicio.featureID]);\r\n\t\t\t\r\n\t\t\ttry{\r\n\t\t\t\tcapaUsrActiva.removeLayer(map._layers[objEdicio.featureID]);\r\n\t\t\t}\r\n\t\t\tcatch(ex){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\tmap.addLayer(capaEdicio);\r\n\t\t\t\r\n\t\t\tvar opcionsSel={\r\n\t\t\t\t\tcolor: '#FF1EE5',\r\n\t\t\t\t\t\"weight\": 7,\r\n\t\t\t\t\topacity: 0.6,\r\n\t\t\t\t\tdashArray: '1, 1',\r\n\t\t\t\t\tfill: true,\r\n\t\t\t\t\tfillColor: '#fe57a1',\r\n\t\t\t\t\tfillOpacity: 0.1\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\r\n\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\tselectedPathOptions: opcionsSel\r\n\t\t\t});\r\n\t\t\tcrt_Editing.enable();\r\n\t\t\r\n\t\t\r\n\t\t/*\tif(map._layers[objEdicio.featureID].properties.tipusFeature==\"marker\" && map._layers[objEdicio.featureID].options.isCanvas){\r\n\t\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\r\n\t\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\t\tselectedPathOptions: opcionsSel\r\n\t\t\t\t});\r\n\t\t\t\tcrt_Editing.enable();\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tcrt_Editing=new L.EditToolbar.SnapEdit(map, {\r\n\t\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\t\tselectedPathOptions: opcionsSel,\r\n\t\t\t\t\tsnapOptions: {\r\n\t\t\t\t\t\tguideLayer: guideLayers\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tcrt_Editing.enable();\r\n\t\t\t\t//activarSnapping(capaEdicio);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tmap.closePopup();\r\n\t\t\t\r\n\t\t\t\r\n\t\t}else if(accio[0].indexOf(\"feature_no\")!=-1){\r\n\t\t\tjQuery('.popup_pres').show();\r\n\t\t\tjQuery('.popup_edit').hide();\r\n\t\t\t\r\n\t\t}else if(accio[0].indexOf(\"feature_ok\")!=-1){\r\n\t\t\tif(objEdicio.edicioPopup=='textFeature'){\r\n\t\t\t\tvar txtTitol=jQuery('#titol_edit').val();\r\n\t\t\t\tvar txtDesc=jQuery('#des_edit').val();\r\n\t\t\t\tif (txtDesc.indexOf(\"'\")>-1) txtDesc = txtDesc.replaceAll(\"'\",'\"');\r\n\t\t\t\tupdateFeatureNameDescr(map._layers[objEdicio.featureID],txtTitol,txtDesc);\r\n\r\n\t\t\t}else if(objEdicio.edicioPopup=='textCapa'){\r\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\r\n\t\t\t\t\tjQuery('#cmbCapesUsr option:selected').text(jQuery('#capa_edit').val());\t\r\n\t\t\t\t\tjQuery('.popup_pres').show();\r\n\t\t\t\t\tjQuery('.popup_edit').hide();\r\n\t\t\t\t}else{\r\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\r\n\t\t\t\t}\r\n\t\t\t}else if(objEdicio.edicioPopup=='nouCapa'){\r\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\r\n\t\t\t\t\tgeneraNovaCapaUsuari(map._layers[objEdicio.featureID],jQuery('#capa_edit').val());\r\n\t\t\t\t}else{\r\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else if(accio[0].indexOf(\"feature_data_table\")!=-1){\r\n\t\t\t$('#modal_data_table').modal('show');\r\n\t\t\tvar featureId=objEdicio.featureID;\r\n\t\t\tif (featureId==undefined) featureId=accio[2];\r\n\t\t\t\r\n\t\t\tif (map._layers[featureId]==undefined) {\r\n\t\t\t\ttry{\r\n\t\t\t\t\tif (accio[6]!=undefined) featureId=accio[6];\r\n\t\t\t\t\tvar props=map._layers[featureId].properties;\r\n\t\t\t\t\tif (props==undefined) props=map._layers[featureId].options;\r\n\t\t\t\t\tif (accio[3]==undefined)  fillModalDataTable(controlCapes._layers[accio[2]],props.businessId);\r\n\t\t\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],props.businessId);\r\n\t\t\t\t}\r\n\t\t\t\tcatch(err){\r\n\t\t\t\t\t$.publish('analyticsEvent',{event:['erro', 'feature_data_table',err]});\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],map._layers[featureId].properties.businessId);\r\n\t\t\r\n\t\t\r\n\t\t}else{\r\n\t\t//accio tanca\r\n\t\t\tmap.closePopup();\r\n\t\t}\r\n\t});\t\r\n\r\n\tlayer.on('popupopen', function(e){\r\n\t\tif(objEdicio.esticEnEdicio){//Si s'esta editant no es pot editar altre element\r\n\t\t\tmap.closePopup();\r\n\t\t}else{\r\n\t\t\t//actualitzem popup\r\n\t\t\tjQuery('#cmbCapesUsr-'+layer._leaflet_id+'-'+layer.options.tipus+'').html(reFillCmbCapesUsr(layer.options.tipus, layer.properties.capaBusinessId));\r\n\t\t\tif (layer.properties.data.nom){\r\n\t\t\t\tjQuery('#titol_pres').text(layer.properties.data.nom).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t}\r\n\t\t\tif (layer.properties.data.text){\r\n\t\t\t\tvar txt = layer.properties.data.text;\r\n\t\t\t\t\r\n\t\t\t\tif (!$.isNumeric(txt) && !validateWkt(txt)) {\r\n\t\t\t\t\ttxt = parseUrlTextPopUp(txt,\"\");\r\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\r\n\t\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\r\n\t\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\r\n\t\t\t\t\tjQuery('#des_pres').text(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n\r\n\t\t\tif(layer.properties.mida)\t\r\n\t\t\t{\r\n\r\n\t\t\t\tvar text = window.lang.translate(\"Longitud\");\r\n\t\t\t\tif(layer.properties.tipusFeature == t_polygon)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\ttext = window.lang.translate(\"Àrea\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(\"#mida_pres\").html(\"<b>\" + text + \":</b> \" + layer.properties.mida);\r\n\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\treturn html;\r\n}\r\n\r\nfunction reFillCmbCapesUsr(type, businessIdCapa){\r\n\tvar html = \"\";\r\n\t$.each( controlCapes._layers, function(i,val) {\r\n\t\tvar layer = val.layer.options;\r\n\t\tif(layer.tipus==t_tematic && layer.geometryType==type ){\r\n\t        html += \"<option value=\\\"\";\r\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\r\n\t        if(businessIdCapa == layer.businessId) html += \" selected\";\r\n\t        html += \">\"+ layer.nom + \"</option>\";            \t\t\r\n\t\t}else if(layer.tipus==t_visualitzacio && layer.geometryType==type ){\r\n\t        html += \"<option value=\\\"\";\r\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\r\n\t        if(businessIdCapa == layer.businessId) html += \" selected\";\r\n\t        html += \">\"+ layer.nom + \"</option>\";            \t\t\r\n\t\t}\r\n\t});\t\t\r\n\treturn html;\r\n}\r\n\r\n\r\nfunction objecteUserAdded(f){\r\n\t\r\n\tvar fId = this.toGeoJSON().features.length;\r\n\t\r\n\tvar feature = f.layer.toGeoJSON();\r\n\t\r\n//\t//Invertim lng,lat perque es recuperi be desde el servidor despres\r\n//    if(f.layer.options.tipus == t_marker){\r\n//          var lng = feature.geometry.coordinates[0]\r\n//          feature.geometry.coordinates[0] = feature.geometry.coordinates[1];\r\n//          feature.geometry.coordinates[1] = lng;         \r\n//    }else if(f.layer.options.tipus==t_polyline){\r\n//          for(var i=0;i<feature.geometry.coordinates.length;i++){\r\n//                var lng = feature.geometry.coordinates[i][0]\r\n//                feature.geometry.coordinates[i][0] = feature.geometry.coordinates[i][1];\r\n//                feature.geometry.coordinates[i][1] = lng;\r\n//          }\r\n//    }else if(f.layer.options.tipus==t_polygon){\r\n//          var lcoordinates = [];\r\n//          $.each( feature.geometry.coordinates[0], function(i,val) {\r\n//                lcoordinates.push([val[1], val[0]]);\r\n//          }); \r\n//          feature.geometry.coordinates[0] = lcoordinates;                  \r\n//    }       \r\n\r\n\tfeature.properties.data = f.layer.properties.data;    \t\r\n\r\n\tvar features = JSON.stringify(feature);\r\n\r\n\tvar rangsJSON = getFeatureStyle(f,fId);\r\n\tvar rangs = JSON.stringify(rangsJSON);\r\n\t\r\n\tif (fId == 1) {\r\n\t\t\r\n\t\tvar _this = this;\r\n\t\t\r\n\t\t/*NOU MODEL: Crear nova visualització*/\r\n\t\tvar data ={\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tnom: f.layer.properties.capaNom,\r\n\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\tgeometryType: f.layer.options.tipus,\r\n//\t\t\t\t\ttipus : tem_origen,//no cal, per defecte li posa origen a servidor\r\n//\t\t\t\t\tcalentas: false,\r\n//\t\t\t\t\torder: controlCapes._lastZIndex+1,\r\n\t\t\t\tactivas: true,\r\n\t\t\t\tvisibilitats: true,\t\t\t\t\r\n\t\t\t\tpublica : true\r\n\t\t};\t\t\r\n\t\t\r\n\t\tcreateVisualitzacioLayer(data).then(function(results) {\r\n\t\t\t\r\n\t\t\tif(results.status === 'OK'){\r\n\t\t\t\t\r\n\t\t\t\t_this.options.businessId = results.results.businessId;\r\n\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\r\n\t\t\t\t//Ara afegim nova geometria\r\n\t\t\t\tvar features = {\r\n\t\t\t\t\t\ttype:f.layer.options.tipus,\r\n\t\t\t\t\t\tid:fId,\r\n\t\t\t\t\t\tproperties: feature.properties.data,\r\n\t\t\t\t\t\testil: rangsJSON,\r\n\t\t\t\t\t\tgeometry: feature.geometry\r\n\t\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tfeatures = JSON.stringify(features);\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tdata = {\r\n\t\t\t\t\t\tbusinessId: f.layer.properties.capaBusinessId,//Bid de la visualitzacio\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\tfeatures: features,\r\n\t\t\t\t\t\tgeometryType: f.layer.options.tipus,\r\n\t\t\t\t\t\toptions: \"text,nom\"\r\n//\t\t\t\t\t\t\tgeometriaBusinessId: '4c216bc1cdd8b3a69440b45b2713b014'//Bid de la geometria q estas afegint\t\t\t\t\t\t\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\taddGeometriaToVisualitzacio(data).then(function(results) {\r\n\t\t\t\t\tif(results.status === 'OK'){\r\n\t\t\t\t\t\r\n//\t\t\t\t\t\t\t_this.options.businessId = results.results.businessId;\r\n//\t\t\t\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\r\n\t\t\t\t\t\tf.layer.properties.businessId = results.feature.businessId;\r\n\t\t\t\t\t\tf.layer.properties.estil = results.results.estil[0];\r\n\t\t\t\t\t\tf.layer.properties.feature = results.feature;\t\r\n\t\t\t\t\t\tfinishAddFeatureToTematic(f.layer);\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\r\n\t\t\t\t\t}\r\n\t\t\t\t},function(results){\r\n\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t}else{//ERROR: control Error\r\n\t\t\t\tconsole.debug('createVisualitzacioLayer ERROR');\r\n\t\t\t}\r\n\t\t},function(results){//ERROR: control Error\r\n\t\t\tconsole.debug('createVisualitzacioLayer ERROR');\r\n\t\t});\t\t\t\r\n\r\n\t} else if (this.getLayers().length > 1) {\r\n\t\r\n\t\tvar features = {\r\n\t\t\t\ttype:f.layer.options.tipus,\r\n\t\t\t\tid:fId,\r\n\t\t\t\tproperties: feature.properties.data,\r\n\t\t\t\testil: rangsJSON,\r\n\t\t\t\tgeometry: feature.geometry\r\n\t\t\t};\r\n\t\tfeatures = JSON.stringify(features);\t\t\t\t\r\n\t\t\r\n\t\tdata = {\r\n\t\t\t\tbusinessId: this.options.businessId,//f.layer.properties.capaBusinessId,//Bid de la visualitzacio\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tfeatures: features\r\n//\t\t\t\t\tgeometriaBusinessId: '4c216bc1cdd8b3a69440b45b2713b014'//Bid de la geometria q estas afegint\t\t\t\t\t\t\r\n\t\t};\t\t\r\n\t\tvar businessIdCapaOrigen = data.businessId;\r\n\t\taddGeometriaToVisualitzacio(data).then(function(results) {\r\n\t\t\tif(results.status === 'OK'){\r\n\t\t\t\t\r\n//\t\t\t\t\t_this.options.businessId = results.results.businessId;\r\n//\t\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\r\n\t\t\t\tf.layer.properties.businessId = results.feature.businessId;\r\n\t\t\t\tf.layer.properties.estil = results.results.estil[0];\r\n\t\t\t\tf.layer.properties.feature = results.feature;\r\n\t\t\t\tfinishAddFeatureToTematic(f.layer);\t\t\r\n\t\t\t\t\r\n\t\t\t\tvar capaEdicio = controlCapes._layers[capaUsrActiva._leaflet_id];\r\n\t\t\t\tif (capaEdicio!=undefined) {\r\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\r\n\t\t\t\t\tactualitzacioTematic(capaEdicio,businessIdCapaOrigen,fId,f,features,\"alta\");\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\r\n\t\t\t}\r\n\t\t},function(results){\r\n\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\r\n\t\t});\t\t\t\r\n\t}\r\n}\r\n\r\nfunction getFeatureStyle(f, fId){\r\n\tvar rangs = {};\r\n\t//ESTIL MARKER\r\n\tif(f.layer.options.tipus == t_marker){\r\n\t\tif (!f.layer._ctx && f.layer.options.icon!= undefined){\r\n\t\t\trangs = {\r\n\t\t\t\tcolor : f.layer.options.icon.options.fillColor,//Color principal\r\n\t\t\t\tmarker: f.layer.options.icon.options.markerColor,//Si es de tipus punt_r o el color del marker\r\n\t\t\t\tsimbolColor: f.layer.options.icon.options.iconColor,//Glyphon\r\n\t\t\t\tradius : f.layer.options.icon.options.radius,//Radius\r\n\t\t\t\ticonSize : f.layer.options.icon.options.iconSize.x+\"#\"+f.layer.options.icon.options.iconSize.y,//Size del cercle\r\n\t\t\t\ticonAnchor : f.layer.options.icon.options.iconAnchor.x+\"#\"+f.layer.options.icon.options.iconAnchor.y,//Anchor del cercle\r\n\t\t\t\tsimbol : jQuery.trim(f.layer.options.icon.options.icon),//tipus glyph\r\n\t\t\t\tsimbolSize : f.layer.options.icon.options.simbolSize,//mida glyphon\r\n//\t\t\t\tpuntTMP.options.symbolSize = style.symbolSize;//mida glyphon\r\n\t\t\t\topacity : (f.layer.options.opacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000',\r\n\t\t\t};\r\n\t\t}else{\r\n\t\t\trangs = {\r\n\t\t\t\tcolor : f.layer.options.fillColor,\r\n\t\t\t\tsimbolSize : f.layer.options.radius,\r\n\t\t\t\topacity : (f.layer.options.fillOpacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000',\r\n\t\t\t\tborderWidth : f.layer.options.weight,\r\n\t\t\t\tborderColor : f.layer.options.color,\r\n\t\t\t};\r\n\t\t}\r\n\t//ESTIL LINE\r\n\t}else if(f.layer.options.tipus == t_polyline){\r\n\t\trangs = {\r\n\t\t\tcolor : f.layer.options.color,\r\n\t\t\tlineWidth : f.layer.options.weight,\r\n\t\t\tlineStyle : 'solid',\r\n\t\t\tborderWidth : 2,\r\n\t\t\tborderColor : f.layer.options.color,\r\n\t\t\topacity : (f.layer.options.opacity * 100),\r\n\t\t\tlabel : false,\r\n\t\t\tlabelSize : 10,\r\n\t\t\tlabelFont : 'arial',\r\n\t\t\tlabelColor : '#000000',\r\n\t\t};\t\r\n\t//ESTIL POLIGON\t\t\r\n\t}else{\r\n\t\tvar fillColor = f.layer.options.color;\r\n\t\tif(f.layer.options.fillColor) fillColor = rgb2hex(f.layer.options.fillColor);\t\r\n\t\tvar fillOpacity = f.layer.options.fillOpacity;\r\n\t\trangs = {\r\n\t\t\t\tcolor : fillColor,\r\n\t\t\t\tfillColor: fillColor,\r\n\t\t\t\tfillOpacity: fillOpacity,\r\n\t\t\t\tlineWidth : f.layer.options.dashArray,\r\n\t\t\t\tlineStyle : 'solid',\r\n\t\t\t\tborderWidth : f.layer.options.dashArray,\r\n\t\t\t\tborderColor : f.layer.options.color,\r\n\t\t\t\topacity : (f.layer.options.fillOpacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000'\r\n\t\t\t};\t\t\t\t\r\n\t}\r\n\treturn rangs;\r\n}\r\n\r\n\r\nfunction getFeatureStyle2(estil,tipus){\r\n\tvar rangs = {};\r\n\t//ESTIL MARKER\r\n\tif( tipus == t_marker){\r\n\t\tif (estil.icon!= undefined){\r\n\t\t\trangs = {\r\n\t\t\t\tcolor : estil.icon.options.fillColor,//Color principal\r\n\t\t\t\tmarker:estil.icon.options.markerColor,//Si es de tipus punt_r o el color del marker\r\n\t\t\t\tsimbolColor:estil.icon.options.iconColor,//Glyphon\r\n\t\t\t\tradius :estil.icon.options.radius,//Radius\r\n\t\t\t\ticonSize :estil.icon.options.iconSize.x+\"#\"+estil.icon.options.iconSize.y,//Size del cercle\r\n\t\t\t\ticonAnchor :estil.icon.options.iconAnchor.x+\"#\"+estil.icon.options.iconAnchor.y,//Anchor del cercle\r\n\t\t\t\tsimbol : jQuery.trim(estil.icon.options.icon),//tipus glyph\r\n\t\t\t\tsimbolSize : estil.icon.options.simbolSize,//mida glyphon\r\n//\t\t\t\tpuntTMP.options.symbolSize = style.symbolSize;//mida glyphon\r\n\t\t\t\topacity : (estil.opacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000',\r\n\t\t\t\tbusinessId: estil.businessId\r\n\t\t\t};\r\n\t\t}else{\r\n\t\t\trangs = {\r\n\t\t\t\tcolor : estil.fillColor,\r\n\t\t\t\tsimbolSize : estil.radius,\r\n\t\t\t\topacity : (estil.fillOpacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000',\r\n\t\t\t\tborderWidth : estil.weight,\r\n\t\t\t\tborderColor : estil.color,\r\n\t\t\t\tbusinessId: estil.businessId\r\n\t\t\t};\r\n\t\t}\r\n\t//ESTIL LINE\r\n\t}else if(tipus == t_polyline){\r\n\t\trangs = {\r\n\t\t\tcolor : estil.color,\r\n\t\t\tlineWidth : estil.weight,\r\n\t\t\tlineStyle : 'solid',\r\n\t\t\tborderWidth : 2,\r\n\t\t\tborderColor : estil.color,\r\n\t\t\topacity : (estil.opacity * 100),\r\n\t\t\tlabel : false,\r\n\t\t\tlabelSize : 10,\r\n\t\t\tlabelFont : 'arial',\r\n\t\t\tlabelColor : '#000000',\r\n\t\t\tbusinessId: estil.businessId\r\n\t\t};\t\r\n\t//ESTIL POLIGON\t\t\r\n\t}else{\r\n\t\tvar fillColor = estil.color;\r\n\t\tif(estil.fillColor) fillColor = rgb2hex(estil.fillColor);\t\r\n\t\tvar fillOpacity = estil.fillOpacity;\r\n\t\trangs = {\r\n\t\t\t\tcolor : fillColor,\r\n\t\t\t\tfillColor: fillColor,\r\n\t\t\t\tfillOpacity: fillOpacity,\r\n\t\t\t\tlineWidth : estil.dashArray,\r\n\t\t\t\tlineStyle : 'solid',\r\n\t\t\t\tborderWidth : estil.dashArray,\r\n\t\t\t\tborderColor : estil.color,\r\n\t\t\t\topacity : (estil.fillOpacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000',\r\n\t\t\t\tbusinessId: estil.businessId\r\n\t\t\t};\t\t\t\t\r\n\t}\r\n\treturn rangs;\r\n}\r\n\r\nfunction finishAddFeatureToTematic(layer){\r\n\t\r\n\tvar type = layer.options.tipus;\r\n\t//Afegir capa edicio a control de capes en cas que sigui nova\r\n\tif (capaUsrActiva.toGeoJSON().features.length == 1 ) {\r\n\t\t//Actualitzem zIndex abans d'afegir al control de capes\r\n\t\tcapaUsrActiva.options.zIndex = controlCapes._lastZIndex+1; \t\t\t\t\t\t\t\t\r\n\t\tcontrolCapes.addOverlay(capaUsrActiva,\tcapaUsrActiva.options.nom, true);\r\n\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t}else{\r\n\t\t\t//Actualitzem comptador de la capa\r\n\t\t\tupdateFeatureCount(null, capaUsrActiva.options.businessId);\r\n\t}\r\n\t\t\r\n\tcreatePopupWindow(layer,type);\r\n\tlayer.openPopup();\r\n\tmap.eachLayer(function(layer) {\r\n\t\tif (layer.options\r\n\t\t\t\t&& layer.options.tipus == \"wms\") {\r\n\t\t\tmap.on('click',layer.getFeatureInfo,layer);\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction updateFeatureNameDescr(layer, titol, descr){\r\n\t\r\n\tlayer.properties.data.nom=titol;\r\n\tlayer.properties.data.text=descr;\r\n\t\r\n//\t//VELL!!\r\n//\tif(!nou_model){\r\n//\t\tif (layer.properties.feature.properties){\r\n//\t\t\tlayer.properties.feature.properties.nom = titol;\r\n//\t\t\tlayer.properties.feature.properties.text = descr;\r\n//\t\t}\r\n//\t\t\t\r\n//\t\tvar feature = layer.toGeoJSON();\r\n//\t\tfeature.geometry = layer.properties.feature.geometry;\r\n//\t\t//CAL???\r\n//\t\tif (layer.properties.feature.properties){\t\r\n//\t\t\tfeature.properties = layer.properties.feature.properties;\r\n//\t\t}else{\r\n//\t\t\t//Obsolet a nou model\r\n//\t\t\tfeature.properties = layer.properties;\r\n//\t\t\t//\r\n//\t\t}\t\t\r\n//\t}\r\n\r\n\tvar features = {\r\n\t\t\ttype: layer.properties.tipusFeature,\r\n\t\t\tid:3124,\r\n\t\t\tbusinessId: layer.properties.businessId,//Bid de la geometria q estas afegint\r\n\t\t\tproperties: layer.properties.data,\r\n\t\t\testil: layer.properties.estil,\r\n\t\t\tgeometry: layer.properties.feature.geometry\r\n\t\t};\r\n\t\r\n\tfeatures = JSON.stringify(features);\r\n\t\r\n    var data = {\r\n            uid : Cookies.get('uid'),\r\n            features : features,\r\n            businessId: layer.properties.businessId\r\n        };      \t\r\n\t\r\n    \r\n    updateGeometria(data).then(function(results){\r\n\t    if(results.status == 'OK'){\r\n\t\t\tjQuery('#titol_pres').text(titol).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\tvar txt = descr;\t\t\t\r\n\t\t\tif (!$.isNumeric(txt) && !validateWkt(txt)) {\r\n\t\t\t\ttxt = parseUrlTextPopUp(txt,\"\");\r\n\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\r\n\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t\t}else{\r\n\t\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\r\n\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#des_pres').html('');\r\n\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\r\n\t\t\t\tjQuery('#des_pres').text(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tjQuery('.popup_pres').show();\r\n\t\t\tjQuery('.popup_edit').hide();   \r\n\t\t\t\t\t\t\r\n\t\t\t//recarrego les sublayers de la capa modificada\r\n\t\t\tvar capaEdicio = controlCapes._layers[layer.properties.capaLeafletId];\r\n\t\t\tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,\"3124\",null,features,\"modificacioInfo\");\r\n\t    }else{\r\n\t        console.debug(\"updateGeometria ERROR\");\r\n\t    }\r\n\t}, function(results){\r\n\t\t  console.debug(\"updateGeometria ERROR\");\r\n\t}); \t\t\r\n        \r\n}\r\n\r\nfunction updateFeatureMove(featureID, capaEdicioID, capaEdicioLeafletId){\r\n\t\r\n    var layer = map._layers[featureID];\r\n    \r\n    var feature = layer.toGeoJSON();\r\n    \r\n    feature.geometry = layer.properties.feature.geometry;      \r\n        \r\n    if(layer.properties.tipusFeature == t_marker){\r\n        var newLatLng = layer.getLatLng();\r\n        feature.geometry.coordinates[1] = newLatLng.lat;\r\n        feature.geometry.coordinates[0] = newLatLng.lng;           \r\n    }else{\r\n\t    var lcoordinates = [];\r\n\t    $.each(layer._latlngs, function(i,val) {\r\n\t    \tlcoordinates.push([val.lng, val.lat]);\r\n\t    });              \r\n\t    if(layer.properties.tipusFeature == t_polyline){\r\n\t    \tfeature.geometry.coordinates = lcoordinates;\r\n\t    \tlayer.properties.mida = calculateDistance(layer.getLatLngs());\r\n\t    }else{\r\n\t    \tlcoordinates.push(lcoordinates[0]);\r\n\t    \tfeature.geometry.coordinates[0] = lcoordinates;\r\n\t    \tlayer.properties.mida = calculateArea(layer);\r\n\t    }\r\n    }\r\n\t\r\n\tvar features = {\r\n\t\t\ttype: layer.properties.tipusFeature,\r\n\t\t\tid:3124,\r\n\t\t\tbusinessId: layer.properties.businessId,//Bid de la geometria q estas afegint\r\n\t\t\tproperties: layer.properties.data,\r\n\t\t\testil: layer.properties.estil,\r\n\t\t\tgeometry: feature.geometry\r\n\t\t};\r\n\tfeatures = JSON.stringify(features);\r\n\t\r\n    var data = {\r\n            uid : Cookies.get('uid'),\r\n            features : features,\r\n            businessId: layer.properties.businessId\r\n        };      \t\r\n\t\r\n    updateGeometria(data).then(function(results){\r\n\t    if(results.status == 'OK'){\r\n\t    \tif (layer.properties.tipusFeature==\"marker\" && layer.properties.data.nom &&  layer.properties.data.text) createPopupWindow(layer,\"marker\");\r\n\t    \tjQuery('.popup_pres').show();\r\n\t    \t//Actualitzem visualitzacions de la capa on estava la geometria modificada\r\n\t    \tvar capaEdicio = controlCapes._layers[capaEdicioLeafletId];\r\n\t    \t//recarrego les sublayers de la capa modificada\t\r\n\t    \tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,null,null,null,\"baixa\");\r\n\t\t\t/*jQuery.each(capaEdicio._layers, function(i, sublayer){\r\n            \tif(jQuery.type(sublayer.layer.options)== \"string\"){\r\n\t\t\t\t\tsublayer.layer.options = $.parseJSON(sublayer.layer.options);\r\n\t\t\t\t}\t            \t  \r\n\t\t\t\t//Sublayer visualitzacio, carrego la capa\r\n\t\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\r\n            \t\t  \r\n            \t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\r\n            \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\r\n            \t\t  sublayer.layer.capesActiva = \"true\";\r\n            \t\t  sublayer.layer.options.origen = layer.properties.capaBusinessId;//BusinessIdCapaorigen\r\n            \t\t  //tipusRang\r\n            \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\r\n            \t\t  sublayer.layer.options = JSON.stringify(sublayer.layer.options);\r\n            \t\t  loadVisualitzacioLayer(sublayer.layer).then(function(results){\r\n            \t\t\t//console.debug(\"LoadVisualitzacio despres de update Geometria\"); \r\n\t\t\t\t\t\tmap.closePopup();\r\n\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\r\n\t\t\t\t\t\t//Eliminem la capa de controlCapes\r\n\t\t\t\t\t\tcontrolCapes.removeLayer(sublayer);\r\n            \t\t  });\r\n            \t  }\r\n            \t\r\n              });*/\r\n\t    \r\n\t    \t\r\n\t    }else{\r\n\t        console.debug(\"updateFeature ERROR\");\r\n\t    }\r\n\t}, function(results){\r\n\t\t  console.debug(\"updateFeature ERROR\");\r\n\t});      \t\r\n  \r\n    //Retornem la geometria a la seva capa original\r\n    capaUsrActiva.addLayer(layer);\r\n    capaUsrActiva.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\r\n    map._layers[capaEdicioID].removeLayer(layer);\r\n    //Refresh de la capa\r\n    controlCapes._map.removeLayer(capaUsrActiva);\r\n\tcontrolCapes._map.addLayer(capaUsrActiva);\r\n\tmap.removeLayer(map._layers[capaEdicioID]);\r\n    \r\n    //Fi edicio\r\n    objEdicio.esticEnEdicio=false;\r\n}\r\n\r\nfunction fillCmbCapesUsr(type){\r\n\tvar html = \"\";\r\n\t$.each( controlCapes._layers, function(i,val) {\r\n\t\tvar layer = val.layer.options;\r\n\t\tif(layer.tipus==t_tematic && layer.geometryType==type ){\r\n\t        html += \"<option value=\\\"\";\r\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\r\n\t        if(capaUsrActiva && (capaUsrActiva.options.businessId == layer.businessId)) html += \" selected\";\r\n\t        html += \">\"+ layer.nom + \"</option>\";\r\n\t    //nou model    \r\n\t\t}else if(layer.tipus==t_visualitzacio && layer.geometryType==type /*&& !layer.source*/){\r\n\t        html += \"<option value=\\\"\";\r\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\r\n\t        if(capaUsrActiva && (capaUsrActiva.options.businessId == layer.businessId)) html += \" selected\";\r\n\t        html += \">\"+ layer.nom + \"</option>\";\r\n\t\t}\r\n\t});\t\t\r\n\treturn html;\r\n}\r\n\r\nfunction createPopUpContent(player,type){\r\n\t\r\n\tvar auxNom = window.lang.translate('Nom');\r\n\tvar auxText = window.lang.translate('Descripció');\r\n\tvar auxLon,auxLat;\r\n\tif(player.properties.data.nom) auxNom = player.properties.data.nom;\r\n\tif(player.properties.data.text) auxText = player.properties.data.text;\r\n\tif (player.options.tipus==\"marker\" && player._latlng) {\r\n\t\tauxLat = player._latlng.lat;\r\n\t\tauxLat= auxLat.toFixed(5);\r\n\t\tauxLon = player._latlng.lng;\r\n\t\tauxLon= auxLon.toFixed(5);\r\n\t}\r\n\tvar html='<div class=\"div_popup\">' \r\n\t+'<div class=\"popup_pres\">'\t\t\t\t\t\t\t\r\n\t+'<div id=\"titol_pres\">'+auxNom+' <i class=\"glyphicon glyphicon-pencil blau\"></i></div>'\t\r\n\t+'<div id=\"des_pres\">'+auxText+' <i class=\"glyphicon glyphicon-pencil blau\"></i></div>';\r\n\t\r\n\tif (player.options.tipus==\"marker\" && auxLat!=undefined && auxLon!=undefined) {\r\n\t\thtml+='<div id=\"auxLat\">'+auxLat+'</div>'\r\n\t\t+'<div id=\"auxLon\">'+auxLon+'</div>';\r\n\t}\r\n\r\n\t\r\n\tif(type == t_polyline && player.properties.mida){\r\n\t\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Longitud')+':</b> '+player.properties.mida+'</div>';\t\r\n\t}else if(type == t_polygon && player.properties.mida){\r\n\t\tif (player.properties.mida.indexOf(\"NaN\")==-1)\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+player.properties.mida+'</div>';\r\n\t\telse html+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+L.GeometryUtil.readableArea(L.GeometryUtil.geodesicArea(player.getLatLngs()),true)+'</div>';\r\n\t}\r\n\t\r\n\t//+'<div id=\"capa_pres\">'\r\n\thtml+='<ul class=\"bs-ncapa\">'\r\n\t\t+'<li><span lang=\"ca\" class=\"small\">'+window.lang.translate('Capa actual:')+'</span>'\r\n\t\t\t+'<select id=\"cmbCapesUsr-'+player._leaflet_id+'-'+type+'\" data-leaflet_id='+player._leaflet_id+'>';\r\n\t\t\thtml+= fillCmbCapesUsr(type);\r\n\t\t\thtml+= '</select></li>'\r\n\t\t//+'<li><a id=\"layer_edit#'+player._leaflet_id+'#'+type+'\" lang=\"ca\" title=\"Canviar el nom de la capa\" href=\"#\"><span class=\"glyphicon glyphicon-pencil blau12\"></span></a></li>'\r\n\t+'<li><a id=\"layer_add#'+player._leaflet_id+'#'+type+'\" lang=\"ca\" title=\"Crear una nova capa\" href=\"#\"><span class=\"glyphicon glyphicon-plus verd12\"></span></a></li>'\r\n\t+'</ul>'\t\r\n\t//'</div>'\t\r\n\t+'<div id=\"footer_edit\"  class=\"modal-footer\">'\r\n\t\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\r\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\r\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\r\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>';\r\n\t\r\n\tif (player.properties.estil) {\r\n\t\thtml+='<li class=\"edicio-popup\" id=\"feature_data_table_'+player._leaflet_id+'\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+player.properties.capaLeafletId+'##\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>';\t\t\t\t\t\r\n\t}\r\n\telse {\r\n\t\thtml+='<li class=\"edicio-popup\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span>  </li>';\t\t\t\t\t\r\n\t}\r\n\t\r\n\thtml+='<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#finestrapunt\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>';\r\n\t\r\n\thtml+='</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t+'</div>'\r\n\t\r\n\t+'</div>'\t\r\n\t+'<div class=\"popup_edit\">'\r\n\t+'<div style=\"display:block\" id=\"feature_txt\">'\r\n\t+'<input class=\"form-control\" id=\"titol_edit\" type=\"text\" value=\"'+auxNom+'\" placeholder=\"\">'\r\n\t+'<textarea id=\"des_edit\" class=\"form-control\" rows=\"2\">'+auxText+'</textarea>'\t;\r\n\tif (player.options.tipus==\"marker\" && auxLat!=undefined && auxLon!=undefined) {\r\n\t\thtml+='<input class=\"form-control\" id=\"lat\" type=\"text\" value=\"'+auxLat+'\" placeholder=\"\" disabled>'\r\n\t\t+'<input class=\"form-control\" id=\"lon\" type=\"text\" value=\"'+auxLon+'\" placeholder=\"\" disabled>';\r\n\t}\r\n\thtml+='</div>'\t\r\n\t+'<div  style=\"display:block\" id=\"capa_txt\">'\r\n\t+'<div id=\"layer_accio\"></div>'\r\n\t+'<input class=\"form-control\" id=\"capa_edit\" type=\"text\" value=\"'+player.properties.capaGrup+'\" placeholder=\"\">'\r\n\t+'</div>'\r\n\t+'<div class=\"modal-footer\">'\r\n\t+'<ul class=\"bs-popup\">'\r\n\t+'<li><a id=\"feature_no##'+player._leaflet_id+'##'+type+'\"  class=\"btn btn-default btn-xs\">'+window.lang.translate('Cancel·lar')+'</a></li>'\t\t\t\r\n\t+'<li><a id=\"feature_ok##'+player._leaflet_id+'##'+type+'\"  class=\"btn btn-success btn-xs\">'+window.lang.translate('Acceptar')+'</a></li>'\t\t\t\t\t\t\t\t\r\n\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t+'</div>'\t\t\t\t\t\t\t\t\r\n\t+'</div>'\t\t\t\t\t\t\t\t\r\n\t+'</div>';\r\n\treturn html;\r\n}\r\n\r\nfunction generaNovaCapaUsuari(feature,nomNovaCapa){\r\n\t\r\n\t/*NOU MODEL: Crear nova visualització*/\r\n\tvar data ={\r\n\t\t\tuid: Cookies.get('uid'),\r\n\t\t\tnom: nomNovaCapa,\r\n\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\tgeometryType: feature.properties.tipusFeature,\r\n//\t\t\t\ttipus : tem_origen,//no cal, per defecte li posa origen a servidor\r\n//\t\t\t\tcalentas: false,\r\n//\t\t\t\torder: controlCapes._lastZIndex+1,\r\n\t\t\tactivas: true,\r\n\t\t\tvisibilitats: true,\t\t\t\t\r\n\t\t\tpublica : true\t\t\t\t\r\n\t};\t\t\r\n\t\r\n\tcreateVisualitzacioLayer(data).then(function(results){\r\n//\t\t\t\r\n\t\tif(results.status === 'OK'){\r\n\t\t\t\r\n\t\t\tcapaUsrActiva2= new L.FeatureGroup();\r\n\t\t\tcapaUsrActiva2.options = {\r\n\t\t\t\tbusinessId : results.results.businessId,\r\n\t\t\t\tnom : nomNovaCapa,\r\n//\t\t\t\ttipus: t_tematic,\r\n\t\t\t\ttipus: t_visualitzacio,\r\n\t\t\t\tgeometryType : feature.properties.tipusFeature\r\n//\t\t\t\t\tzIndex : controlCapes._lastZIndex//+1\t\t\r\n\t\t\t};\r\n\t\t\t//Afegim nova capa al combo\r\n\t\t\tjQuery('#cmbCapesUsr-'+feature._leaflet_id+'-'+feature.properties.tipusFeature+'').append(\"<option selected value=\\\"\"+results.results.businessId+\"\\\">\"+nomNovaCapa+\"</option>\");\t\r\n\t\t\tjQuery('.popup_pres').show();\r\n\t\t\tjQuery('.popup_edit').hide();\r\n\t\t\t\r\n\t\t\tmap.addLayer(capaUsrActiva2);\r\n\t\t\tcapaUsrActiva2.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\t\tcontrolCapes.addOverlay(capaUsrActiva2,\tcapaUsrActiva2.options.nom, true);\r\n\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\tactivaPanelCapes(true);\t\t\t\r\n\t\t\t\r\n\t\t\tvar features = {\r\n\t\t\t\t\ttype: feature.properties.tipusFeature,\r\n\t\t\t\t\tid:3124,\r\n\t\t\t\t\tbusinessId: feature.properties.businessId,//Bid de la geometria q estas afegint\r\n\t\t\t\t\tproperties: feature.properties.data,\r\n\t\t\t\t\testil: feature.properties.estil,\r\n\t\t\t\t\tgeometry: feature.properties.feature.geometry\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\tfeatures = JSON.stringify(features);\r\n\t\t\t\r\n\t\t\tdata= {\r\n\t\t\t\ttoBusinessId: results.results.businessId,//'4c216bc1cdd8b3a69440b45b2713b000',//bID de la visualitzacio-capa\r\n\t\t\t\tfromBusinessId: feature.properties.capaBusinessId,//'4c216bc1cdd8b3a69440b45b2713b001',//bID de la visualitzacio-capa\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tfeatures: features\r\n\t\t\t}\t\r\n\t\t\t\r\n\t\t\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\r\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\r\n\t\t\t\tif(resultsMove.status === 'OK'){\r\n\t\t\t\t\tvar layer=feature._leaflet_id;\r\n\t\t\t\t\tif(capaUsrActiva) capaUsrActiva.removeLayer(feature);\r\n\t\t\t\t\tcapaUsrActiva2.addLayer(feature);//.on('layeradd', objecteUserAdded);\r\n\t\t\t\t\t//feature.openPopup();\r\n\t\t\t\t\t//Actualitzem capa activa\r\n\t\t\t\t\tif(capaUsrActiva) capaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\t\tcapaUsrActiva = capaUsrActiva2;//map._layers[capaUsrActiva2._leaflet_id];;\r\n\t\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\r\n\t\t\t\t\t//Actualitzem properties de la layer\r\n\t\t\t\t\tfeature.properties.capaBusinessId = capaUsrActiva.options.businessId;\r\n\t\t\t\t\tfeature.properties.capaNom = capaUsrActiva.options.nom;\t\r\n\t\t\t\t\tfeature.properties.capaLeafletId = capaUsrActiva._leaflet_id;\r\n\t\t\t\t\tfeature.properties.estil.businessId = resultsMove.estilBid;\r\n\t\t\t\t\t//Actualitzem popup del marker\r\n//\t\t\t\t\t\tvar html = createPopUpContent(feature,feature.options.tipus);\r\n\t\t\t\t\t//feature.setPopupContent(html);\r\n\t\t\t\t\tmap.closePopup();\r\n\t\t\t\t\tfeature.openPopup();\r\n\t\t\t\t\t\r\n\t\t\t\t\t//update rangs\r\n\t\t\t\t    //getRangsFromLayer(capaUsrActiva);\r\n\t\t\t\t    \r\n\t\t\t\t\t//Actualitzem comptador de la capa\r\n\t\t\t\t    updateFeatureCount(data.fromBusinessId, data.toBusinessId);\t\t\r\n\t\t\t\t    \r\n\t\t\t\t    //actualitzacioTematic(toLayer1,toLayer.options.businessId,\"3124\",obj,features,\"modificacio\");\r\n\t\t\t\t  //Actualitzem l'enllaç d'obrir la finestra de dades\r\n\t\t\t\t    console.debug(layer);\r\n\t\t\t\t   var htmlDataTable =jQuery(\"#feature_data_table_\"+layer).html();\r\n\t\t\t\t\tvar stringsDataTableA = htmlDataTable.split(\"##\");\r\n\t\t\t\t\tjQuery(\"#feature_data_table_\"+layer).html(stringsDataTableA[0]+\"##\"+stringsDataTableA[1]+\"##\"+stringsDataTableA[2]+\"##\"+capaUsrActiva._leaflet_id+\"##\"+stringsDataTableA[4]);\r\n\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t\t\t});\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"createVisualitzacioLayer ERROR\");\r\n\t\t}\r\n\t});\t\t\r\n\r\n}\r\n\r\nfunction moveFeatureToLayer(feature_businessId,layer_fromBusinessId,layer_toBusinessId){\r\n\r\n\t/*NOU MODEL*/\r\n\tvar features = {\r\n\t\t\ttype: feature.options.tipus,\r\n\t\t\tid:3124,\r\n\t\t\tbusinessId: feature.properties.businessId,//Bid de la geometria q estas afegint\r\n\t\t\tproperties: feature.properties.feature.properties,\r\n\t\t\testil: feature.properties.estil,\r\n\t\t\tgeometry: feature.properties.feature.geometry\r\n\t\t};\r\n\t\r\n\tfeatures = JSON.stringify(features);\r\n\t\r\n\tdata= {\r\n\t\ttoBusinessId: results.results.businessId,//'4c216bc1cdd8b3a69440b45b2713b000',//bID de la visualitzacio-capa\r\n\t\tfromBusinessId: feature.properties.capaBusinessId,//'4c216bc1cdd8b3a69440b45b2713b001',//bID de la visualitzacio-capa\r\n\t\tuid: Cookies.get('uid'),\r\n\t\tfeatures: features\r\n\t}\t\r\n\t\r\n\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\r\n\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\r\n\t\tif(resultsMove.status === 'OK'){\r\n\t\t\t\r\n\t\t\tif(capaUsrActiva) capaUsrActiva.removeLayer(feature);\r\n\t\t\tcapaUsrActiva2.addLayer(feature);//.on('layeradd', objecteUserAdded);\r\n\t\t\t//feature.openPopup();\r\n\t\t\t//Actualitzem capa activa\r\n\t\t\tif(capaUsrActiva) capaUsrActiva.removeEventListener('layeradd');\r\n\t\t\tcapaUsrActiva = capaUsrActiva2;//map._layers[capaUsrActiva2._leaflet_id];;\r\n\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\r\n\t\t\t//Actualitzem properties de la layer\r\n\t\t\tfeature.properties.capaBusinessId = capaUsrActiva.options.businessId;\r\n\t\t\tfeature.properties.capaNom = capaUsrActiva.options.nom;\t\r\n\t\t\tfeature.properties.capaLeafletId = capaUsrActiva._leaflet_id;\r\n\t\t\t//Actualitzem popup del marker\r\n//\t\t\tvar html = createPopUpContent(feature,feature.options.tipus);\r\n\t\t\t//feature.setPopupContent(html);\r\n\t\t\tmap.closePopup();\r\n\t\t\tfeature.openPopup();\r\n\t\t\t\r\n\t\t\t//update rangs\r\n\t\t    //getRangsFromLayer(capaUsrActiva);\r\n\t\t    \r\n\t\t\tvar capaEdicio = controlCapes._layers[capaUsrActiva._leaflet_id];\r\n\t\t\t//recarrego les sublayers de la capa modificada\t\r\n\t\t\tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,\"3124\",feature,features,\"modificacio\");\r\n\t\t\t\r\n\t\t\t//Actualitzem comptador de la capa\r\n\t\t    updateFeatureCount(data.fromBusinessId, data.toBusinessId);\t\t\t\t\t\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t\t}\r\n\t},function(results){\r\n\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\r\n\t});\t\t\r\n\r\n}\r\n\r\nfunction modeLayerTextEdit(){\r\n\tjQuery('#capa_txt').show();\r\n\tjQuery('#feature_txt').hide();\r\n\tjQuery('.popup_pres').hide();\r\n\tjQuery('.popup_edit').show();\t\r\n}\r\n\r\nfunction modeEditText(){\r\n\tobjEdicio.edicioPopup='textFeature';\r\n\tjQuery('#capa_txt').hide();\r\n\tjQuery('#feature_txt').show();\r\n\tvar txtTitol=jQuery('#titol_pres').text();\r\n\tvar txtDesc=jQuery('#descrText').html();\r\n\tjQuery('#titol_edit').val(txtTitol);\t\r\n\tjQuery('#des_edit').val(txtDesc);\r\n\tjQuery('.popup_pres').hide();\r\n\tjQuery('.popup_edit').show();\t\r\n}\r\n\r\n/*funcio que actulitza l'estil seleccionat al dialeg d'estils, \r\n * amb el de la feature que es col editar \r\n * */\r\nfunction updateDialogStyleSelected(icon){\r\n  \r\n\tif(icon.tipus == t_polyline){\r\n\t\t\r\n\t\tcanvas_linia.lineWidth = icon.weight;\r\n\t\tcanvas_linia.strokeStyle = icon.color;\r\n\t\t\r\n\t\t$(\"#cmb_gruix_l option[value='\"+icon.weight+\"']\").prop(\"selected\", \"selected\");\r\n\t\t$('.border_color_linia').css('background-color',icon.color);\r\n\t\taddGeometryInitL(document.getElementById(\"cv_linia0\"));\t\t\t\r\n\t\t\r\n\t}else if(icon.tipus == t_polygon){\r\n\t\t\r\n\t\tcanvas_pol.strokeStyle = icon.color;\r\n\t\tcanvas_pol.opacity = icon.fillOpacity;\r\n\t\tcanvas_pol.fillStyle = icon.fillColor; //rgb2hex(icon.fillColor);\r\n\t\tcanvas_pol.lineWidth = icon.weight;\r\n\t\t\r\n\t\t$('.border_color_pol').css('border-color',icon.color);\r\n\t\t$('.fill_color_pol').css('color',icon.fillColor);\r\n\t\t$('.fill_color_pol').css('background-color',icon.fillColor);\r\n\t\t$(\"#cmb_gruix option[value='\"+icon.weight+\"']\").prop(\"selected\", \"selected\");\r\n\t\t$(\"#cmb_trans option[value='\"+icon.fillOpacity+\"']\").prop(\"selected\", \"selected\");\r\n\t\t\r\n\t    addGeometryInitP(document.getElementById(\"cv_pol0\"));\r\n\t    \r\n\t}else{//es t_marker\r\n\t\t\r\n\t\t//Deselecciono estil al modal \r\n\t\tjQuery(\"#div_puntM\").removeClass(\"estil_selected\");\r\n\t\tjQuery(\"#div_puntZ\").removeClass(\"estil_selected\");\r\n\t\tjQuery(\".bs-glyphicons li\").removeClass(\"estil_selected\");\t\t\r\n\t\t\r\n\t\t\r\n\t\tif(icon.isCanvas){//Si es un punt\r\n\t\t\t\r\n\t\t\tvar midaPunt = getMidaFromRadius(icon.radius);\r\n\t\t\t\r\n\t\t\testilP.iconFons = 'awesome-marker-web awesome-marker-icon-punt_r';\r\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\r\n\t\t\testilP.colorGlif = icon.iconColor;\r\n\t\t\testilP.divColor = icon.fillColor;\r\n\t\t\testilP.width = midaPunt+'px';\r\n\t\t\testilP.height = midaPunt+'px';\r\n\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tjQuery(\"#div_puntZ\").addClass(\"estil_selected\");\r\n\t\t\tjQuery(\"#div_punt9\").css(\"background-color\",icon.fillColor);\r\n\t\t\t$('#cmb_mida_Punt option[value=\"'+midaPunt+'\"]').prop(\"selected\", \"selected\");\r\n\t\t\tjQuery(\"#dv_fill_color_punt\").css(\"background-color\",icon.fillColor);\r\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",icon.iconColor);\r\n//\t\t\t\r\n\t\t}else if(icon.markerColor.indexOf(\"punt_r\")!=-1){\r\n\t\t\t\r\n\t\t\tvar licon = icon.icon.split(\" \");\r\n\t\t\tmidaPunt = getMidaFromFont(licon[1]);\r\n\t\t\t\r\n\t\t\testilP.iconFons = 'awesome-marker-web awesome-marker-icon-punt_r';\r\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\r\n\t\t\testilP.colorGlif =icon.iconColor;\r\n\t\t\testilP.fontsize = licon[1];\t\r\n\t\t\testilP.width = midaPunt+'px';\r\n\t\t\testilP.height = midaPunt+'px';\r\n\t\t\testilP.divColor = icon.divColor;\r\n\t\t\t\r\n\t\t\r\n\t\t\tjQuery(\"#div_puntZ\").addClass(\"estil_selected\");\r\n\t\t\tjQuery(\"#div_punt9\").css(\"background-color\",icon.divColor);\r\n\t\t\t$('#cmb_mida_Punt option[value=\"'+midaPunt+'\"]').prop(\"selected\", \"selected\");\r\n\t\t\t\r\n\t\t\tjQuery(\"#dv_fill_color_punt\").css(\"background-color\",icon.divColor);\r\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",icon.iconColor);\t\t\t\t\r\n\t\t\t\r\n\t\t\tjQuery(\".bs-glyphicons li .fa-\"+licon[0]).parent('li').addClass(\"estil_selected\");\r\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",estilP.colorGlif);\t\r\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\r\n\t\t\tif(estilP.colorGlif==\"#FFFFFF\"){\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\r\n\t\t\t}else{\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\r\n\t\t\t}\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t}else{//Si es marker\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\testilP.iconFons = icon.className+'-web awesome-marker-icon-'+icon.markerColor;\r\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\r\n\t\t\testilP.colorGlif = icon.iconColor;\r\n\t\t\testilP.fontsize = '14px';\r\n\t\t\testilP.divColor = 'transparent';\r\n\t\t\testilP.width = '28px';\r\n\t\t\testilP.height = '42px';\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tjQuery(\"#div_puntM\").addClass(\"estil_selected\");\r\n\t\t\tjQuery(\"#dv_fill_color_marker\").css(\"background-color\",getColorFromClass(icon.markerColor));\r\n\t\t\tjQuery('#div_punt_1').removeClass().addClass('awesome-marker-web awesome-marker-icon-'+icon.markerColor);\r\n\t\t\t\r\n\t\t\tjQuery(\".bs-glyphicons li .fa-\"+icon.icon).parent('li').addClass(\"estil_selected\");\r\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",estilP.colorGlif);\r\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\r\n\t\t\tif(estilP.colorGlif==\"#FFFFFF\"){\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\r\n\t\t\t}else{\r\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\t\t\r\n\t\tjQuery('#div_punt0').removeClass();\r\n\t\tjQuery('#div_punt0').addClass(estilP.iconFons+\" \"+estilP.iconGlif);\r\n\t\tjQuery('#div_punt0').css('width',estilP.width);\r\n\t\tjQuery('#div_punt0').css('height',estilP.height);\t\r\n\t\tjQuery('#div_punt0').css('font-size',estilP.fontsize);\r\n\t\tjQuery('#div_punt0').css('background-color',estilP.divColor);\r\n\t\tjQuery('#div_punt0').css('color',estilP.colorGlif);\t\t\t\r\n\t}\r\n}\r\n\r\nfunction getColorFromClass(classe){\r\n\tswitch (classe)\r\n\t{\r\n\t\tcase 'orange':\r\n\t\t  return '#ffc500';\r\n\t\tcase 'darkorangeb':\r\n\t\t  return '#ff7f0b';\r\n\t\tcase 'red':\r\n\t\t  return '#ff4b3a';\r\n\t\tcase 'purple':\r\n\t\t  return '#ae59b9';\t\r\n\t\tcase 'blue':\r\n\t\t  return '#00afb5';\r\n\t\tcase 'green':\r\n\t\t  return '#7cbd00';\r\n\t\tcase 'darkgray':\r\n\t\t  return '#90a6a9';\r\n\t\tcase 'gray':\r\n\t\t  return '#ebf0f1';\t\t  \r\n\t\t default:\r\n\t\t\t return '#ffc500';\r\n\t} \t\t\r\n}\r\n\r\nfunction updateFeatureCount(fromBusinessId, toBusinessId){\r\n\t\r\n\t//Actualitzem comptador de la capa\r\n\tif(fromBusinessId){\r\n\t\tvar sFromCount = $(\"#count-\"+fromBusinessId).html();\r\n\t\tif (sFromCount!=undefined){\r\n\t\t\tsFromCount = sFromCount.replace(\"(\", \" \");\r\n\t\t\tsFromCount = sFromCount.replace(\")\", \" \");\t\r\n\t\t\tvar fromCount = parseInt(sFromCount.trim());\r\n\t\t\tfromCount=fromCount-1;\r\n\t\t\t$(\"#count-\"+fromBusinessId).html(' ('+fromCount+')');\r\n\t\t}\r\n\t}\r\n\r\n\tif(toBusinessId){\r\n\t\tvar sToCount = $(\"#count-\"+toBusinessId).html();\r\n\t\tif (sToCount!=undefined){\r\n\t\t\tsToCount = sToCount.replace(\"(\", \" \");\r\n\t\t\tsToCount = sToCount.replace(\")\", \" \");\t\r\n\t\t\tvar toCount = parseInt(sToCount.trim());\r\n\t\t\ttoCount=toCount+1;\r\n\t\t\t$(\"#count-\"+toBusinessId).html(' ('+toCount+')');\t\t\r\n\t\t}\r\n\t}\r\n//\tconsole.debug(\"Fi updateFeatureCount\");\r\n}\r\n\r\nfunction addDrawTooltips() {\r\n\tL.drawLocal = {\r\n\t\tdraw : {\r\n\t\t\thandlers : {\r\n\t\t\t\tmarker : {\r\n\t\t\t\t\t\r\n\t\t\t\t\ttooltip : {\r\n\t\t\t\t\t\tstart : window.lang.translate('Fes clic al mapa per posar un punt')\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tpolygon : {\r\n\t\t\t\t\ttooltip : {\r\n\t\t\t\t\t\tstart : window.lang.translate('Clica per començar a dibuixar una àrea'),\r\n\t\t\t\t\t\tcont : window.lang.translate('Clica per continuar dibuixant una àrea'),\r\n\t\t\t\t\t\tend : window.lang.translate('Clica el primer punt per tancar aquesta àrea')\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tpolyline : {\r\n\t\t\t\t\terror : '<strong>Error:</strong> àrees no es poden creuar!',\r\n\t\t\t\t\t\r\n\t\t\t\t\ttooltip : {\r\n\t\t\t\t\t\tstart : window.lang.translate('Clica per començar a dibuixar una línia'),\r\n\t\t\t\t\t\tcont : window.lang.translate('Clica per continuar dibuixant una línia'),\r\n\t\t\t\t\t\tend : window.lang.translate('Clica el darrer punt per acabar la línia')\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tedit : {\r\n\t\t\thandlers : {\r\n\t\t\t\tedit : {\r\n\t\t\t\t\t\r\n\t\t\t\t\ttooltip : {\r\n\t\t\t\t\t\ttext : window.lang.translate(\"Arrossega els vèrtex o el punt per editar l'objecte\"),\r\n\t\t\t\t\t\tsubtext : window.lang.translate('Fes clic sobre el mapa per finalitzar')\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\treturn L.drawLocal;\r\n}\r\n\r\nfunction addHtmlInterficieDraw(){\r\n\tjQuery(\"#funcio_draw\").append(\r\n\t\t'<h5 lang=\"ca\" id=\"funcio_draw_titol_1\">Situar un punt</h5>'+\r\n\t\t'\t<div class=\"add_costat_r\" style=\"margin-right: 33%;\">'+\r\n\t\t'\t<div lang=\"ca\" id=\"div_mes_punts\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més tipus de punts\" title=\"Més tipus de punts\"></div>'+\r\n\t\t'</div>'+\r\n\t\t'<div style=\"height:50px \">'+\r\n\t\t'\t<div id=\"div_punt\" class=\"dibuix_punt\" data-toggle=\"tooltip\" data-lang-title=\"Clica per situar un punt\" title=\"Clica per situar un punt\">'+\r\n\t\t'\t</div>'+\r\n\t\t'</div>'+\r\n\t\t'<h5 lang=\"ca\" id=\"funcio_draw_titol_2\">Dibuixar una línia o un polígon</h5>'+\r\n\t\t'<div class=\"div_auto\">'+\r\n\t\t'\t<div id=\"div_linia\" class=\"dibuix_linia\" data-toggle=\"tooltip\" data-lang-title=\"Clica per començar a dibuixar una línia\" title=\"Clica per començar a dibuixar una línia\">'+\r\n\t\t'\t<canvas id=\"cv_linia\" width=\"40\" height=\"40\"></canvas>'+\r\n\t\t'\t</div>'+\r\n\t\t'\t<div class=\"add_costat\">'+\r\n\t\t'\t\t<div lang=\"ca\" id=\"div_mes_linies\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més estils de línia\" title=\"Més estils de línia\"></div>'+\r\n\t\t'\t</div>'+\r\n\t\t'</div>'+\r\n\t\t'<div class=\"div_auto\">'+\r\n\t\t'\t<div id=\"div_area\" class=\"dibuix_poligon\" data-toggle=\"tooltip\" data-lang-title=\"Clica per començar a dibuixar una àrea\" title=\"Clica per començar a dibuixar una àrea\">'+\r\n\t\t'\t<canvas id=\"cv_pol\" width=\"40\" height=\"40\"></canvas>'+\r\n\t\t'\t</div>'+\r\n\t\t'\t<div class=\"add_costat\">'+\r\n\t\t'\t\t<div lang=\"ca\" id=\"div_mes_arees\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més estils d\\'àrees\" title=\"Més estils d\\'àrees\"></div>'+\r\n\t\t'\t</div>'+\r\n\t\t'</div>'\r\n\t);\r\n\t\r\n\t$('#div_punt').tooltip({placement : 'bottom',container : 'body'});\r\n\t$('#div_linia').tooltip({placement : 'bottom',container : 'body'});\r\n\t$('#div_area').tooltip({placement : 'bottom',container : 'body'});\t\r\n\t\r\n\t$('#div_mes_punts').tooltip({placement : 'right',container : 'body'});\r\n\t$('#div_mes_linies').tooltip({placement : 'right',container : 'body'});\r\n\t$('#div_mes_arees').tooltip({placement : 'right',container : 'body'});\t\r\n}\r\n\r\nfunction activarSnapping(capaEdicio){\r\n\tif (capaEdicio.getLayers()[0].snapediting==undefined){\r\n\t\t//Activate snapping\r\n\t\tif (capaEdicio.getLayers()[0].properties.tipusFeature != undefined && capaEdicio.getLayers()[0].properties.tipusFeature==\"marker\"){\r\n\t\t\ttry{\r\n\t\t\t\tcapaEdicio.getLayers()[0].editing = new L.Handler.MarkerSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\r\n\t\t\t\tcapaEdicio.getLayers()[0].snapediting = new L.Handler.MarkerSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\r\n\t\t\t}catch(exc){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t\telse{\t\t\t\t\t\r\n\t\t\tcapaEdicio.getLayers()[0].editing = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\r\n\t\t\tcapaEdicio.getLayers()[0].snapediting = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\r\n\t\t}\r\n\t}\r\n\t\tfor(var i = 0;i < guideLayers.length; i++) {\r\n\t\t\t // Add every already drawn layer to snap list\r\n\t\t\tcapaEdicio.getLayers()[0].snapediting.addGuideLayer(guideLayers[i]);\r\n\t        // Add the currently drawn layer to the snap list of the already drawn layers\r\n\t\t\tif ( guideLayers[i].snapediting!=undefined){\r\n\t\t\t\tguideLayers[i].snapediting.addGuideLayer(capaEdicio.getLayers()[0]);\r\n\t\t\t\tguideLayers[i].snapediting.enable();\r\n\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\r\n\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (guideLayers[i].properties.tipusFeature != undefined && guideLayers[i].properties.tipusFeature==\"marker\"){\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tguideLayers[i].snapediting = new L.Handler.MarkerSnap(map, layer,{snapDistance:10});\r\n\t\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tguideLayers[i].snapediting = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\r\n\t\t\t\t}\r\n\t\t\t\tif (guideLayers[i].snapediting!=undefined) {\r\n\t\t\t\t\tguideLayers[i].snapediting.addGuideLayer(capaEdicio.getLayers()[0]);\r\n\t\t\t\t\tguideLayers[i].snapediting.enable();\r\n\t\t\t\t}\r\n\t\t\t\tif (guideLayers[i].editing!=undefined)  guideLayers[i].editing.disable();\r\n\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \r\n\t\t\t}\r\n\t\t\tif (capaEdicio.getLayers()[0].properties.tipusFeature != undefined && capaEdicio.getLayers()[0].properties.tipusFeature==\"marker\"){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tif (guideLayers[i].editing!=undefined)  guideLayers[i].editing.disable();\r\n\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable();\r\n\t\t\t\t}catch(exc){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t }\r\n\t\ttry{\r\n\t\t\tcapaEdicio.getLayers()[0].snapediting.enable();\r\n\t\t}\r\n\t\tcatch(exc){\r\n\t\t\t\r\n\t\t}\r\n\t\t// capaEdicio.getLayers()[0].editing.enable();\r\n\t\t  // Add to drawnItems\r\n\t\t drawnItems.addLayer(capaEdicio.getLayers()[0]);\r\n\t\t // Add newly drawn feature to list of snappable features\r\n\t\tguideLayers.push(capaEdicio.getLayers()[0]);\r\n}\r\n\r\n\r\n\r\n","var _htmlServeisWMS = [],\r\n_NomServer2 = \"\",\r\nWMS_BBOX,\r\nActiuWMS = {\r\n\t\"servidor\" : \"servidor\",\r\n\t\"url\" : \"url\",\r\n\t\"layers\" : \"layers\",\r\n\t\"epsg\" : 'L.CRS.EPSG4326',\r\n\t\"tileSize\":\"512\",\r\n\t\"wmstime\":false\r\n};\r\n\r\nfunction generaLlistaServeisWMS() {\r\n\t_htmlServeisWMS.push('<div class=\"panel-success\"><ul class=\"bs-dadesO panel-heading\">');\r\n\tvar llista_servidorsWMS = {\r\n\t\t\"WMS\" : [\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Base municipal\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\r\n\t\t\t\t\"IDARXIU\" : \"http://galileo.icc.cat/arcgis/services/icc_limadmin_v_r/MapServer/WMSServer?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:761da3ce-233c-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Delimitació municipal\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\r\n\t\t\t\t\"IDARXIU\" : \"http://geoserveis.icc.cat/icc_atlm/wms/service?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:761da3ce-233c-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Mapa Urbanístic\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\r\n\t\t\t\t\"IDARXIU\" : \"http://dtes.gencat.cat/webmap/MUC/service.svc/get?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:e7a15a72-233b-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Mapa Cadastral\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Dirección General del Catastro\",\r\n\t\t\t\t\"IDARXIU\" : \"http://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:260c0ccb-233c-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\t{ \r\n\t\t\t\t\"TITOL\" : \"Atermenament i usos de costes\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\r\n\t\t\t\t\"IDARXIU\" : \"http://sig.gencat.cat/ows/COSTES/wms?\", \r\n\t\t\t\t\"URN\" :\"urn:uuid:873ee728-cc2c-11e2-a37e-f96b77832722\"\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\t{ \r\n\t\t\t\t\"TITOL\" : \"Població de Catalunya 2014 \",\r\n\t\t\t\t\"ORGANITZAC\" : \"Institut d'Estadistica de Catalunya\",\r\n\t\t\t\t\"IDARXIU\" :  HOST_APP2+\"geotimeservices/idescat\", \r\n\t\t\t\t\"URN\" :\"urn:uuid:873ee728-cc2c-11e2-a37e-f96b77832722\"\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Establiments industrials\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Direccio General de Difusio\",\r\n\t\t\t\t\"IDARXIU\" : \"http://pcivil.icgc.cat/ogc/geoservei?map=/opt/idec/dades/pcivil/risc_quimic.map&amp\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:0a71e360-7f73-11e4-b2ac-e7f91a2c3576\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Mapes Medi Natural\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Departament d'Agricultura, Ramaderia, Pesca, Alimentació i Medi Natural\",\r\n\t\t\t\t\"IDARXIU\" : \"http://magrana.gencat.cat/SIG_ws/services/PUBLIC_OGC/MapServer/WMSServer?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:6661c209-1462-11e3-8d85-e315c0a1d933\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Ortofotos històriques\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\r\n\t\t\t\t\"IDARXIU\" : \"http://historics.icc.cat:80/lizardtech/iserv/ows?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:6434ad48-66df-11e2-8be5-bd1ed7ebebe1\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Risc Sísmic\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Direccio General de Difusio\",\r\n\t\t\t\t\"IDARXIU\" : \"http://pcivil.icgc.cat/ogc/geoservei?map=/opt/idec/dades/pcivil/risc_sismic.map&\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:09e7f2c8-7f73-11e4-b2ac-e7f91a2c3576\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Cobertes del Sòl\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Centre de Recerca Ecològica i Aplicacions Forestals (CREAF) - UAB\",\r\n\t\t\t\t\"IDARXIU\" : \"http://www.opengis.uab.es/cgi-bin/MCSC/MiraMon.cgi?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:54012596-233b-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Mapes Ambientals\",\r\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\r\n\t\t\t\t\"IDARXIU\" : \"http://sima.gencat.cat/DMAH_ws/SIMA_OGC/MapServer/WMSServer?\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:e84cb5ba-233b-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"TITOL\" : \"Nodes guifi.net\",\r\n\t\t\t\t\"ORGANITZAC\" : \"GUIFI.NET\",\r\n\t\t\t\t\"IDARXIU\" : \"http://guifi.net/cgi-bin/mapserv?map=/home/guifi/maps.guifi.net/guifimaps/GMap.map&\",\r\n\t\t\t\t\"URN\" : \"urn:uuid:63013742-233c-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t{\r\n                \"TITOL\" : \"Mapa trànsit en temps real\",\r\n                \"ORGANITZAC\" : \"Servei Català de Trànsit \",\r\n                \"IDARXIU\" : \"http://sctwms.gencat.cat/WMS/mapserv.exe?map=//sctbrsscc05/AGATA/EstatdelTransit.map&amp\",\r\n                \"URN\" : \"urn:uuid:fe8365ca-233c-11e2-a4dd-13da4f953834\"\r\n\t\t\t},\r\n\t\t\t{\r\n                \"TITOL\" : \"Mapa Cadastral per anys\",\r\n                \"ORGANITZAC\" : \"Dirección General de Cadastro\",\r\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/catastro_dgc\",\r\n                \"WMST\" : true\r\n\t\t\t},\r\n\t\t\t{\r\n                \"TITOL\" : \"Ortofotos per anys\",\r\n                \"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\r\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/orto_icgc\",\r\n                \"WMST\" : true\r\n\t\t\t},\r\n\t\t\t{\r\n                \"TITOL\" : \"Seccions Censals per anys\",\r\n                \"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\r\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/seccionsc_icgc\",\r\n                \"WMST\" : true\r\n\t\t\t}\r\n\t\t]\r\n\t};\t\r\n\t\r\n\tjQuery.each(llista_servidorsWMS.WMS, function(key, WMS) {\r\n\t\tif(WMS.WMST){\r\n\t\t\t_htmlServeisWMS.push('<li><a class=\"label-wms\" href=\"#\" id=\"' +\r\n\t\t\t\tWMS.IDARXIU +\r\n\t\t\t\t'\">' +\r\n\t\t\t\twindow.lang.translate(WMS.TITOL) +\r\n\t\t\t\t'</a>' +\r\n\t\t\t\t'<a target=\"_blank\" lang=\"ca\" title=\"Servei WMS-TIME\" href=\"' +\r\n\t\t\t\tWMS.IDARXIU +'?&Request=GetCapabilities&service=WMS' +\r\n\t\t\t\t'\"><span class=\"glyphicon glyphicon-time info-wms\"></span></a>' +\r\n\t\t\t\t'</li>');\r\n\t\t}else{\r\n\t\t\t_htmlServeisWMS.push('<li><a class=\"label-wms\" href=\"#\" id=\"' +\r\n\t\t\t\tWMS.IDARXIU +\r\n\t\t\t\t'\">' +\r\n\t\t\t\twindow.lang.translate(WMS.TITOL) +\r\n\t\t\t\t'</a>' +\r\n\t\t\t\t//'<a target=\"_blank\" lang=\"ca\" title=\"Informació dels serveis\" href=\"http://www.geoportal.cat/wefex/client?idioma=ca&do=cercaAssociacions&resposta=detall&id=' +\r\n\t\t\t\t//WMS.URN +\r\n\t\t\t\t'<a target=\"_blank\" lang=\"ca\" title=\"'+WMS.ORGANITZAC+'\" href=\"' +\r\n\t\t\t\tWMS.IDARXIU +'?Request=GetCapabilities&service=WMS' +\r\n\t\t\t\t'\"><span class=\"glyphicon glyphicon-info-sign info-wms\"></span></a>' +\r\n\t\t\t\t'</li>');\r\n\t\t}\r\n\t});\r\n\t//TODO cambiar y cargar algun template externo\r\n\t_htmlServeisWMS.push('<li></li>');\r\n\t_htmlServeisWMS.push('<li><div class=\"input-group txt_ext\"><input type=\"text\" lang=\"ca\" id=\"txt_URLWMS_cataleg\" style=\"height:33px\" placeholder=\"Cercar catàleg IDEC\" class=\"form-control\">');\r\n\t_htmlServeisWMS.push('<span class=\"input-group-btn\"><button class=\"btn btn-success\" id=\"bt_cercaWMS\"  type=\"button\"><span class=\"glyphicon glyphicon-search\"></span></button></span>');\r\n\t_htmlServeisWMS.push('</div></li>');\r\n\t_htmlServeisWMS.push('</ul></div>');\r\n\t_htmlServeisWMS.push('<div id=\"resultats_idec\">');\r\n\t_htmlServeisWMS.push('</div>');\r\n\t_htmlServeisWMS.push('<div id=\"div_controlWMS\"></div>');\r\n\t_htmlServeisWMS.push('<div id=\"div_emptyWMS\"></div>');\r\n}\r\n\r\njQuery(document).on('keyup', \"#txt_URLWMS_cataleg\", function(e) {\r\n    var code = e.which; // recommended to use e.which, it's normalized across browsers\r\n    if(code==13) {//enter\r\n    \te.preventDefault();\r\n    \te.stopImmediatePropagation();\r\n    \tvar cerca = $.trim(jQuery('#txt_URLWMS_cataleg').val());\r\n    \tif (cerca === \"\") {\r\n    \t\talert(window.lang.translate(\"Has d'introduïr un valor per fer la cerca\"));\r\n    \t} else {\r\n    \t\tcercaCataleg(cerca);\r\n    \t\t\r\n    \t}\r\n    }\r\n});\r\n\r\njQuery(document).on('click', \"#bt_cercaWMS\", function(e) {\r\n\tvar cerca = $.trim(jQuery('#txt_URLWMS_cataleg').val());\r\n\tif (cerca === \"\") {\r\n\t\talert(window.lang.translate(\"Has d'introduïr un valor per fer la cerca\"));\r\n\t} else {\r\n\t\tcercaCataleg(cerca);\r\n\t}\r\n});\r\n\r\nfunction cercaCataleg(cerca){\r\n\tcerca = encodeURI(cerca);\r\n\tvar data ={\r\n\t\tsearchInput : cerca\t\r\n\t};\r\n\t//Cerca catàleg IDEC\r\n\tsearchCatalegIdec(data).then(function(results){\r\n\t\tvar resultats = JSON.parse(results.resultats);\r\n\t\tjQuery('#div_layersWMS').attr(\"style\",\"display:none;\");\r\n\t\tvar lDadesIdec = '<ul class=\"panel-heading llista-dadesIdec\">';\r\n\t\tjQuery.each(resultats.aaData, function( index, wmsidec ) {\r\n\t\t\tvar titol=wmsidec.TITOL;\r\n\t\t\tvar titolShort=shortString(titol,27);\r\n\t\t\tvar desc=wmsidec.DESCRIPCIO;\r\n\t\t\tvar org =wmsidec.ORGANITZAC;\r\n\t\t\tvar idarxiu=wmsidec.IDARXIU;\r\n\t\t\tvar classificaico=wmsidec.CLASSIFICA;\r\n\t\t\tvar urn=wmsidec.URN;\r\n\t\t\tvar xmin=wmsidec.XMIN;\r\n\t\t\tvar xmax=wmsidec.XMAX;\r\n\t\t\tvar ymin=wmsidec.YMIN;\r\n\t\t\tvar ymax=wmsidec.YMAX;\r\n\t\t\tvar escala=wmsidec.ESCALA;\r\n\t\t\tvar conjunt=wmsidec.CONJUNT;\r\n\t\t\tvar temes=wmsidec.TEMES;\r\n\t\t\tlDadesIdec += '<li><a class=\"label-dadesIdec\" href=\"#\" title=\"'+titol+'\"  data-nom=\"'+titol+'\" data-wms_url=\"'+idarxiu+'\">'+titolShort;\r\n\t\t\tlDadesIdec += '<a lang=\"ca\" href=\"http://www.geoportal.cat/wefex/client?idioma=ca&do=cercaAssociacions&resposta=detall&id='+urn+'&idioma=ca&\" target=\"_blank\">';\r\n\t\t\tlDadesIdec += '&nbsp;<span class=\"glyphicon glyphicon-info-sign\"></span></a></li>';\r\n\t\t});\r\n\t\tlDadesIdec += '</ul>';\r\n\t\tif (resultats.aaData.length>0) {\r\n\t\t\tjQuery('#resultats_idec').html(lDadesIdec);\r\n\t\t\t//TODO llamar al control\r\n\t\t\tjQuery('#txt_URLWMS').attr(\"style\",\"display:none\");\r\n\t\t\tjQuery('#bt_connWMS').attr(\"style\",\"display:none\");\r\n\t\t\tjQuery(\".label-dadesIdec\").on('click', function(e) {\r\n\t\t\t\tjQuery('#resultats_idec').empty();\r\n\t\t\t\tvar urlWMS= this.dataset.wms_url;\r\n\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'afegir WMS catàleg IDEC', this.dataset.nom, 1]});\r\n\t\t\t\tjQuery('#txt_URLWMS').attr(\"style\",\"display:block;height:33px;\");\r\n\t\t\t\tjQuery('#bt_connWMS').attr(\"style\",\"display:inline\");\r\n\t\t\t\tjQuery('#txt_URLWMS').val(urlWMS);\r\n\t\t\t\tjQuery('#bt_connWMS').click();\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction getCapabilitiesWMS(url, servidor) {\r\n\tvar _htmlLayersWMS = [];\r\n\tvar instamapsWms = InstamapsWms({\r\n\t\tloadTemplateParam :false});\r\n\tvar dataWMS = {url: url};\r\n\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\r\n\t\tvar bbox,\r\n\t\tsouce_capabilities_template = $(\"#capabilities-template\").html(),\r\n\t\tcapabilities_template = Handlebars.compile(souce_capabilities_template);\r\n\t\t\r\n\t\tHandlebars.registerPartial( \"list-template\", $( \"#list-template\" ).html() );\r\n\t\tHandlebars.registerHelper('layer', function(context, options) {\r\n\t\t  var ret = \"\";\r\n\t\t  if (!Handlebars.Utils.isArray(context)){\r\n\t\t\t  context = [context];\r\n\t\t  }\r\n\t\t  for(var i=0, j=context.length; i<j; i++) {\r\n\t\t\t  if (!Handlebars.Utils.isArray(context[i])){\r\n\t\t\t\t  ret = ret + options.fn(context[i]);\r\n\t\t\t  }else{\r\n\t\t\t\t  for(var k=0, l=context.length; k<l; k++) {\r\n\t\t\t\t\t  ret = ret + options.fn(context[i][k]);\r\n\t\t\t\t  }\r\n\t\t\t  }\r\n\t\t  }\r\n\t\t  return ret;\r\n\t\t});\r\n\t\t\r\n\t\tjQuery('#div_layersWMS').html('');\r\n\t\tjQuery(\"#div_layersWMS\").show();\r\n\t\tjQuery('#div_emptyWMS').empty();\r\n\r\n\t\tif (servidor === null) {\r\n\t\t\tservidor = results.Service.Title;\r\n\t\t}\r\n\t\ttry{\r\n\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\r\n\t\t\t\tbbox = results.Capability.Layer.Layer.LatLonBoundingBox;\r\n\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\r\n\t\t\t\tbbox = results.Capability.Layer.LatLonBoundingBox;\r\n\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t}else{\r\n\t\t\t\tWMS_BBOX=null;\r\n\t\t\t}\t\r\n\t\t} catch (err) {\r\n\t\t\tWMS_BBOX=null;\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\tvar matriuEPSG = results.Capability.Layer.CRS,\r\n\t\t\tepsg = [],\r\n\t\t\thtml = capabilities_template({Layer: [results.Capability.Layer]});\r\n\t\t\t\r\n\t\t\tActiuWMS.servidor = servidor;\r\n\t\t\t_NomServer2=ActiuWMS.servidor;\r\n\t\t\tActiuWMS.url = jQuery.trim(url);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (!matriuEPSG) {\r\n\t\t\t\tmatriuEPSG = results.Capability.Layer.SRS;\r\n\t\t\t\tif (!matriuEPSG) {\r\n\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].CRS;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (!matriuEPSG) {\r\n\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].SRS;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (jQuery.isArray(matriuEPSG)){\r\n\t\t\t\tjQuery.each(matriuEPSG, function(index, value) {\r\n\t\t\t\t\tepsg.push(value);\r\n\t\t\t\t});\r\n\t\t\t}else{\r\n\t\t\t\tepsg.push(matriuEPSG);\r\n\t\t\t}\r\n\t\r\n\t\t\tif (jQuery.inArray('EPSG:3857', epsg) != -1) {\r\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\r\n\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\r\n\t\t\t} else if (jQuery.inArray('EPSG:900913', epsg) != -1) {\r\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\r\n\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\r\n\t\t\t} else if (jQuery.inArray('EPSG:4326', epsg) != -1) {\r\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\r\n\t\t\t\tActiuWMS.epsgtxt = '4326';\r\n\t\t\t} else if (jQuery.inArray('CRS:84', epsg) != -1) {\r\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\r\n\t\t\t\tActiuWMS.epsgtxt = '4326';\r\n\t\t\t} else if (jQuery.inArray('EPSG:4258', epsg) != -1) {\r\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\r\n\t\t\t\tActiuWMS.epsgtxt = '4326';\t\r\n\t\t\t} else {\r\n\t\t\t\talert(window.lang.translate(\"No s'ha pogut visualitzar aquest servei: Instamaps només carrega serveis WMS globals en EPSG:3857 i EPSG:4326\"));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tjQuery('#div_layersWMS').empty().append(html);\r\n\t\t\taddTreeEvents();\r\n\t\t\tjQuery('#div_emptyWMS').empty();\r\n\t\t\tjQuery('#div_emptyWMS').html(\r\n\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" id=\"bt_addWMS\" class=\"btn btn-success\" >' +\r\n\t\t\t\twindow.lang.translate(\"Afegir capes\") + '</button></div>');\r\n\t\t} catch (err) {\r\n\t\t\tjQuery('#div_layersWMS').html('<hr>Error interpretar capabilities: ' + err + '</hr>');\r\n\t\t}\r\n\t},function(){ console.info(\"time out\")});\r\n}\r\n\r\nfunction addWmsToMap(wms){\r\n\t\r\n\r\n\t\r\n\tvar wmsLayer,\r\n\ttipus_user = defineTipusUser();  //geocat.web-1.0.0\r\n\t//$.publish('analyticsEvent',{event:[ 'mapa', tipus_user+'wms', wms.url, 1]});\r\n\t//TODO eliminar esto pero primero hay que cargar el instamaps.google-analytics.js en lugar del geocat.google-analytics.js\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wms', wms.url, 1]});\r\n\t\t\r\n\r\n\t\r\n\r\n\t\r\n\tif(wms.wmstime){\r\n\t\twmsLayer = L.tileLayer.wms(wms.url, {\r\n\t\t\tlayers : wms.layers,\r\n\t\t\tcrs : wms.epsg,\r\n\t\t\ttransparent : true,\r\n\t\t\tformat : 'image/png',\r\n\t\t\twmstime:wms.wmstime,\r\n\t\t\ttileSize:512\r\n\t\t});\r\n\t}else{\r\n\t\twmsLayer = L.tileLayer.betterWms(wms.url, {\r\n\t\t\tlayers : wms.layers,\r\n\t\t\tcrs : wms.epsg,\r\n\t\t\ttransparent : true,\r\n\t\t\t//exceptions:'application/vnd.ogc.se_blank',\r\n\t\t\texceptions:checkExceptionsType(wms.url),\r\n\t\t\tformat : 'image/png',\r\n\t\t\twmstime:wms.wmstime,\r\n\t\t\ttileSize:512\r\n\t\t});\r\n\t}\r\n\t\r\n\twmsLayer.options.businessId = '-1';\r\n\twmsLayer.options.nom = wms.servidor;\r\n\twmsLayer.options.tipus = t_wms;\r\n\t\r\n\tif(typeof url('?businessid') == \"string\"){\r\n\t\tvar data = {\r\n\t\t\tuid:Cookies.get('uid'),\r\n\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\tserverName: wms.servidor,\r\n\t\t\tserverType: t_wms,\r\n\t\t\tversion: wmsLayer.wmsParams.version,\r\n\t\t\tcalentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n            order: controlCapes._lastZIndex+1,\r\n            epsg: ActiuWMS.epsgtxt,\r\n            imgFormat: 'image/png',\r\n            infFormat: 'text/html',\r\n            tiles: true,\t            \r\n            transparency: true,\r\n            opacity: 1,\r\n            visibilitat: 'O',\r\n            url: wms.url,\r\n            layers: JSON.stringify([{name:wms.layers,title:wms.layers,group:0,check:true,query:true}]),\r\n            calentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n\t\t\toptions: '{\"url\":\"'+wms.url+'\",\"layers\":\"'+wms.layers+'\",\"opacity\":\"'+1+'\",\"wmstime\":'+wms.wmstime+'}'\r\n\t\t};\r\n\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\tmap.spin(false);\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\twmsLayer.options.businessId = results.results.businessId;\r\n\t\t\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,wms.servidor);\r\n\t\t\t\t//dfd.resolve(true);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('createServidorInMap ERROR');\r\n\t\t\t\t//dfd.resolve(false);\r\n\t\t\t}\r\n\t\t});\r\n\t}else{\r\n\t\t//dfd.reject();\r\n\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,wms.servidor);\r\n\t}\r\n\t\r\n}\r\n\r\n/*\r\n * fromParam = true -> Si afegim WMS directamente dun parametre de la url\r\n * fromParam = false -> Si afegim WMS des de la interficie dInstaMaps\r\n * */\r\nfunction addExternalWMS(fromParam) {\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wms', ActiuWMS.url, 1]});\r\n\t\r\n\tvar dfd = $.Deferred();\r\n\tvar _dateFormat=false,\r\n\tnomCapaWMS,\r\n\twmsLayer;\r\n\t\r\n\tif(!fromParam){\r\n\t\tvar cc = $('#div_layersWMS input:checked').map(function(){\r\n\t\t\tif($('#geoservicetime_'+this.value).length > 0){\r\n\t\t\t\t_dateFormat=true;\r\n\t\t\t}\r\n\t\t\treturn this.value;\r\n\t\t});\r\n\t\tcc = jQuery.makeArray(cc);\r\n\t\tActiuWMS.layers = cc.join(',');\r\n\t\t\r\n\t\tvar _nomCapesWMS=[];\r\n\t\tvar cc1 = $('#div_layersWMS input:checked').map(function(){\t\t\t\r\n\t\t\treturn this.id;\r\n\t\t});\r\n\t\t\r\n\t\tcc1 = jQuery.makeArray(cc1);\t\r\n\t\t\r\n\t\tif(cc1.length==1){\r\n\t\t\tActiuWMS.servidor=cc1.join(\" \");\r\n\t\t}else{\r\n\t\t\tActiuWMS.servidor=_NomServer2;\t\t\r\n\t\t}\r\n\t\t\r\n\r\n\t\tActiuWMS.wmstime=_dateFormat;\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t}\r\n\tif(ActiuWMS.wmstime){\r\n\t\twmsLayer =L.tileLayer.wms(ActiuWMS.url, {\r\n\t\t\tlayers : ActiuWMS.layers,\r\n\t\t\tcrs : ActiuWMS.epsg,\r\n\t\t\ttransparent : true,\r\n\t\t\tformat : 'image/png',\r\n\t\t\twmstime:ActiuWMS.wmstime,\r\n\t\t\ttileSize:512\r\n\t\t});\r\n\t}else{\r\n\t\twmsLayer = L.tileLayer.betterWms(ActiuWMS.url, {\r\n\t\t\tlayers : ActiuWMS.layers,\r\n\t\t\tcrs : ActiuWMS.epsg,\r\n\t\t\ttransparent : true,\r\n\t\t\t//exceptions:'application/vnd.ogc.se_blank',\r\n\t\t\texceptions:checkExceptionsType(ActiuWMS.url),\r\n\t\t\tformat : 'image/png',\r\n\t\t\twmstime:ActiuWMS.wmstime,\r\n\t\t\ttileSize:512\r\n\t\t});\r\n\t}\r\n\t\r\n\tnomCapaWMS=ActiuWMS.servidor;\t\r\n\t\r\n\t\r\n\twmsLayer.options.businessId = '-1';\r\n\twmsLayer.options.nom = nomCapaWMS;\r\n\twmsLayer.options.tipus = t_wms;\r\n\tif(typeof url('?businessid') == \"string\"){\r\n\t\tvar data = {\r\n\t\t\tuid:Cookies.get('uid'),\r\n\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\tserverName: ActiuWMS.servidor,\r\n\t\t\tserverType: t_wms,\r\n\t\t\tversion: wmsLayer.wmsParams.version,\r\n\t\t\tcalentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n            order: controlCapes._lastZIndex+1,\r\n            epsg: ActiuWMS.epsgtxt,\r\n            imgFormat: 'image/png',\r\n            infFormat: 'text/html',\r\n            tiles: true,\t            \r\n            transparency: true,\r\n            opacity: 1,\r\n            visibilitat: 'O',\r\n            url: ActiuWMS.url,\r\n            layers: JSON.stringify([{name:ActiuWMS.layers,title:ActiuWMS.layers,group:0,check:true,query:true}]),\r\n            calentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n\t\t\toptions: '{\"url\":\"'+ActiuWMS.url+'\",\"layers\":\"'+ActiuWMS.layers+'\",\"opacity\":\"'+1+'\",\"wmstime\":'+ActiuWMS.wmstime+'}'\r\n\t\t};\r\n\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\tmap.spin(false);\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\twmsLayer.options.businessId = results.results.businessId;\r\n\t\t\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,ActiuWMS.servidor);\r\n\t\t\t\t//Issue #581: zoom capa cloudifier\r\n\t\t\t\tif (results.results!=undefined && results.results.url!=undefined && results.results.url.indexOf(\"http://betaserver.icgc.cat/geoservice/\")!=-1){\r\n\t\t\t\t\tvar instamapsWms = InstamapsWms({\r\n\t\t\t\t\t\tloadTemplateParam :false});\r\n\t\t\t\t\tvar dataWMS = {url: results.results.url};\r\n\t\t\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results2) {\r\n\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\tif(results2.Capability.Layer.Layer.LatLonBoundingBox){\r\n\t\t\t\t\t\t\t\tvar bbox = results2.Capability.Layer.Layer.LatLonBoundingBox;\r\n\t\t\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t\t\t\t\t}else if(results2.Capability.Layer.LatLonBoundingBox){\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tvar bbox = results2.Capability.Layer.LatLonBoundingBox;\r\n\t\t\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tWMS_BBOX=null;\r\n\t\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\tWMS_BBOX=null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (WMS_BBOX !=null) map.fitBounds(WMS_BBOX);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tdfd.resolve(true);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('createServidorInMap ERROR');\r\n\t\t\t\tdfd.resolve(false);\r\n\t\t\t}\r\n\t\t});\r\n\t}else{\r\n\t\tdfd.reject();\r\n\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,ActiuWMS.servidor);\r\n\t}\r\n\t\r\n\t return dfd.promise();\r\n}\r\n\r\nfunction showTimeControl(show){\r\n\tshow ? $('.barra_temps').show() : $('.barra_temps').hide();\r\n}\r\n\r\nfunction checkAndAddTimeDimensionLayer(wmsLayer,ckeckCapaActiva,_nomServidor,capesActiva,_map){\r\n\tvar DL= wmsLayer.options.wmstime;\r\n\t\r\n\t_map = _map || map;\r\n\t\r\n\tif(wmsLayer.options.wmstime) {\r\n\t\tvar dimensionsTimeLayer  = L.timeDimension.layer.wms(wmsLayer, {\r\n\t\t    proxy: paramUrl.proxy_betterWMS,\r\n\t\t    updateTimeDimension: true,\r\n\t\t    updateTimeDimensionMode:'intersect',//replace, union,intersect\r\n\t\t    tileSize:512,\r\n\t\t    setDefaultTime:false,\r\n\t\t    tipus : t_wms\r\n\t\t});\r\n\t\tdimensionsTimeLayer.options=wmsLayer.options;\r\n\t\tdimensionsTimeLayer.addTo(_map);\r\n\t\tdimensionsTimeLayer.bringToFront();\r\n\t\tdimensionsTimeLayer.options.zIndex = controlCapes._lastZIndex+ 1;\r\n\t\tif(controlCapes){\r\n\t\t\tcontrolCapes.addOverlay(dimensionsTimeLayer, _nomServidor, true);\r\n\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\tactivaPanelCapes(true);\r\n\t\t}\r\n\t\tjQuery('#dialog_dades_ex').modal('hide');\t\r\n\t\t\r\n\t\tshowTimeControl(true);\r\n\t}else{\r\n\t\tif(ckeckCapaActiva){\r\n\t\t\tif (capesActiva === true || capesActiva === 'true' ){\r\n\t\t\t\twmsLayer.addTo(_map);\r\n\t\t\t}\r\n\t\t\tif(controlCapes){\r\n\t\t\t\tcontrolCapes.addOverlay(wmsLayer, _nomServidor, true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\t\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\t_map.addLayer(wmsLayer);\r\n\t\t\twmsLayer.bringToFront();\r\n\t\t\twmsLayer.options.zIndex = controlCapes._lastZIndex+ 1;\r\n\t\t\tif(controlCapes){\r\n\t\t\t\tcontrolCapes.addOverlay(wmsLayer, _nomServidor, true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t}\r\n\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\nfunction loadWmsLayer(layer, _map){\r\n\tvar op = layer.opacity,\r\n\tjsonOptions,\r\n\tnewWMS,\r\n\tnomServidor = layer.serverName;\r\n\t\r\n\tif(layer.serverName.indexOf('##') !=-1){\r\n\t\tvar valors = layer.serverName.split(\"##\");\r\n\t\top = valors[1];\r\n\t\tnomServidor=valors[0];\r\n\t}  \r\n\tif(typeof (layer.options)==\"string\"){\r\n\t\ttry {\r\n\t\t\tjsonOptions = JSON.parse(layer.options);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\tjsonOptions = layer.options;\t\r\n\t\t}\r\n\t}else{\r\n\t\tjsonOptions = layer.options;\t\r\n\t}\r\n\tif(!layer.options){\r\n\t\tjsonOptions=layer;\r\n\t}\r\n\tvar wmsOptions = {\r\n\t    layers: layer.layers,\r\n\t    format: layer.imgFormat,\r\n\t    transparent: layer.transparency,\r\n\t    version: layer.version,\r\n\t    opacity:op ,\r\n\t    crs: layer.epsg,\r\n\t\tnom :nomServidor ,\r\n\t\ttipus: layer.serverType,\r\n\t\tzIndex :  parseInt(layer.capesOrdre),\r\n\t    businessId: layer.businessId,\r\n\t    tileSize:512\r\n\t};\r\n\tif(layer.random){\r\n\t\twmsOptions.random=layer.random;\r\n\t}\r\n\r\n\tif(layer.hasOwnProperty(\"capesOrdre\"))\r\n\t\twmsOptions.zIndex = layer.capesOrdre;\r\n\r\n\tnewWMS = L.tileLayer.betterWms(layer.url, wmsOptions);\r\n\tnewWMS.options.wmstime=jsonOptions.wmstime;\r\n\tnewWMS.options.group=jsonOptions.group;\r\n\t\t\r\n\tcheckAndAddTimeDimensionLayer(newWMS,true,nomServidor,layer.capesActiva, _map);\r\n}\r\n\r\n\r\nfunction checkExceptionsType(_server){\r\n\t\t\r\n\tvar exceptions='application/vnd.ogc.se_blank';\r\n\r\n\t\tif(_server.indexOf('instamaps.cat')==-1 ||\r\n\t\t _server.indexOf('betaserver.icgc')==-1 ||\r\n\t\t _server.indexOf('localhost')==-1 ||\r\n\t\t _server.indexOf('172.70.1.11')==-1){\r\n\t\t\t\r\n\t\t\texceptions='application/vnd.ogc.se_inimage';\r\n\r\n\t\t}\r\n\t\t\r\n\t\treturn exceptions;\r\n}","\r\n/**\r\n * Funcions tematics generals*\r\n * */\r\n\r\n\r\nfunction initButtonsTematic(){\r\n\t\r\n\taddHtmlInterficieTematics();\r\n\taddHtmlModalLayersTematic();\r\n\taddHtmlModalCategories();\r\n\taddHtmlModalBubbles();\r\n\t\r\n\t//botons tematic\r\n\tjQuery('#st_Color').on('click',function(){\r\n\t\tshowTematicLayersModal(tem_simple,jQuery(this).attr('class'));\r\n\t});\r\n\t\r\n\tjQuery('#st_Tema').on('click',function(){\r\n\t\tshowTematicLayersModal(tem_clasic,jQuery(this).attr('class'));\r\n\t});\r\n\r\n\tjQuery('#st_Size').on('click',function(){\r\n\t\tshowTematicLayersModal(tem_size,jQuery(this).attr('class'));\r\n\t});\r\n\t\r\n\tjQuery('#st_Heat').on('click',function(e) {\r\n\t\tshowTematicLayersModal(tem_heatmap,jQuery(this).attr('class'));\r\n\t\t\r\n\t});\t\r\n\r\n\tjQuery('#st_Clust').on('click',function(e) {\t\t\r\n\t\tshowTematicLayersModal(tem_cluster,jQuery(this).attr('class'));\r\n\t\t\r\n\t});\t\r\n}\r\n\r\nfunction showTematicLayersModal(tipus,className){\r\n//\tconsole.debug(\"showTematicLayersModal\");\r\n\tvar warninMSG=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest estil no es pot aplicar a cap capa de les que tens en el mapa')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\r\n\tvar warninMSG3D=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest estil no es pot aplicar amb modus 3D')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\r\n\t\r\n\t\r\n\tjQuery('.modal').modal('hide');\r\n\t\r\n\tjQuery('#dialog_layers_tematic').modal('show');\r\n\t\r\n\tjQuery('#stActiu').removeClass();\r\n\tjQuery('#stActiu').addClass(className);\r\n\t\r\n\tvar basicHTML ='<span lang=\"ca\">L\\'estil bàsic genera una visualització dels elements d\\'una capa uniformement per al conjunt.</span>'+\r\n\t\t\t\t\t'<br><br>'+\r\n\t\t\t\t\t'<div class=\"imagePeu\">'+\r\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\r\n\t\t\t\t\t'\t<img src=\"css/images/basic.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\r\n\t\t\t\t\t'</div>' ;\r\n\tvar categoriesHTML ='<span lang=\"ca\">L\\'estil categories genera una visualització dels elements d\\'una capa a partir d\\'un camp, numèric o de text, de les dades.</span>'+\r\n\t\t\t\t\t\t'<br><br>'+\r\n\t\t\t\t\t\t'<div class=\"imagePeu\">'+\r\n\t\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\r\n\t\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\r\n\t\t\t\t\t\t'\t<img src=\"css/images/categories.jpg\">'+\r\n\t\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\r\n\t\t\t\t\t\t'</div>' ;\r\n\tvar midesHTML ='<span lang=\"ca\">L\\'estil mides genera una visualització dels elements d\\'una capa a partir d\\'un camp numèric de les dades. Permet escollir entre interval graduat o proporcional al valor.</span>'+\r\n\t\t\t\t\t'<br><br>'+\r\n\t\t\t\t\t'<div class=\"imagePeu\">'+\r\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\r\n\t\t\t\t\t'\t<img src=\"css/images/mides.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\r\n\t\t\t\t\t'</div>' ;\r\n\tvar heatMapHTML='<span lang=\"ca\">L\\'estil concentració genera una visualització dels elements d\\'una capa a partir de la densitat de les dades en forma de mapa de calor (heatmap).</span>'+\r\n\t\t\t\t\t'<br><br>'+\r\n\t\t\t\t\t'<div class=\"imagePeu\">'+\r\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\r\n\t\t\t\t\t'\t<img src=\"css/images/concentracio.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\r\n\t\t\t\t\t'</div>' ;\r\n\tvar clusterHTML ='<span lang=\"ca\">L\\'estil agrupació genera una visualització dels elements d\\'una capa a partir de la densitat de les dades agrupats en grups de proximitat (clusters).</span>'+\r\n\t\t\t\t\t'<br><br>'+\r\n\t\t\t\t\t'<div class=\"imagePeu\">'+\r\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\r\n\t\t\t\t\t'\t<img src=\"css/images/agrupacio.jpg\">'+\r\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\r\n\t\t\t\t\t'</div>' ;\r\n\t\r\n\tif(tipus==tem_simple) jQuery('#txtTematic').html(basicHTML);\r\n\telse if (tipus==tem_clasic) jQuery('#txtTematic').html(categoriesHTML);\r\n\telse if (tipus==tem_size) jQuery('#txtTematic').html(midesHTML);\r\n\telse if (tipus==tem_heatmap)  jQuery('#txtTematic').html(heatMapHTML);\r\n\telse if (tipus==tem_cluster) jQuery('#txtTematic').html(clusterHTML); \r\n\t\r\n\tvar layers = [];\r\n\tjQuery.each( controlCapes._layers, function( key, value ) {\r\n\t\tvar layerOptions = this.layer.options;\r\n\t\t\r\n\t\tvar tipusCapa = layerOptions.tipus;\r\n\t\t//Si la capa no es multigeometrias\r\n\t\tif (layerOptions.geometryType != t_multiple){\r\n\t\t\t//Si la capa no esta tematitzada\r\n\t\t\tif(!layerOptions.tipusRang || layerOptions.tipusRang == tem_origen){\r\n\t\t\t\tif(tipus==tem_simple) {\r\n\t\t\t\t\tif (tipusCapa == t_tematic || tipusCapa == t_json || tipusCapa == t_visualitzacio || tipusCapa == t_url_file){ //tematic\r\n\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t}else if(tipusCapa == t_dades_obertes){ //dades obertes\r\n\t\t\t\t\t\tvar dataset = layerOptions.dataset;\r\n\t\t\t\t\t\tif (dataset != \"incidencies\" &&\r\n\t\t\t\t\t\t\tdataset != \"cameres\" &&\r\n\t\t\t\t\t\t\tdataset != \"meteo_comarca\" &&\r\n\t\t\t\t\t\t\tdataset != \"meteo_costa\"){\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if (tipus==tem_clasic){\r\n\t\t\t\t\tif (tipusCapa == t_tematic || tipusCapa == t_visualitzacio || tipusCapa == t_url_file){ //tematic\r\n\t\t\t\t\t\tif (this.layer.options.dades){\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if (tipus==tem_cluster || tipus==tem_heatmap) {\t\r\n\t\t\t\t\tif(estatMapa3D){\r\n\t\t\t\t\t\t$('#list_tematic_layers').html(warninMSG3D);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tvar ftype = transformTipusGeometry(layerOptions.geometryType);\r\n\t\t\t\t\t\t//var ftype = layerOptions.geometryType;\r\n\t\t\t\t\t\tif(tipusCapa == t_dades_obertes || tipusCapa == t_json ||\r\n\t\t\t\t\t\t\t(tipusCapa == t_tematic && ftype == t_marker) ||\r\n\t\t\t\t\t\t\t(tipusCapa == t_url_file && ftype == t_marker) ||\r\n\t\t\t\t\t\t\t(tipusCapa == t_visualitzacio && ftype == t_marker) ||\r\n\t\t\t\t\t\t\t(tipusCapa == t_vis_wms)){\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if (tipus==tem_size) {\r\n\t\t\t\t\tvar ftype = transformTipusGeometry(layerOptions.geometryType);\r\n\t\t\t\t\tif ((tipusCapa == t_tematic || tipusCapa == t_visualitzacio || tipusCapa == t_url_file) && ftype == t_marker){ //tematic\r\n\t\t\t\t\t\tif (this.layer.options.dades){\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tlayers.push(this);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\t\t\r\n\t\t\t\t\t$('#list_tematic_layers').html(warninMSG);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});// fi each\r\n\tif(layers.length ==0){\r\n\t\t\r\n\t\tif(estatMapa3D){\r\n\t\t\t\t\t\t$('#list_tematic_layers').html(warninMSG3D);\r\n\t\t\t\t\treturn;\r\n\t\t}else{\r\n\t\t$('#list_tematic_layers').html(warninMSG);\t\t\r\n\t\treturn;\r\n\t\t}\r\n\t}\r\n\tlayers = {layers: layers};\r\n\r\n\tvar source = jQuery(\"#tematic-layers-template\").html();\r\n\tvar template = Handlebars.compile(source);\r\n\tvar html = template(layers);\r\n\t$('#list_tematic_layers').html(html);\r\n\t\r\n\t$('.usr_wms_layer').on('click',function(e){\r\n\t\tvar _this = jQuery(this);\r\n\t\tvar data = _this.data();\r\n\t\tdata.from = tipus;\r\n\t\t//Revisar majus minus del \"geometryType\"!\r\n\t\tvar ftype = \"\";\r\n\t\tif(data.geometrytype) ftype = transformTipusGeometry(data.geometrytype);\r\n\t\telse ftype = transformTipusGeometry(data.geometrType);\r\n\t\t\r\n\t\tif (tipus == tem_simple){\r\n\t\t\tif (ftype == t_marker  || data.tipus == t_dades_obertes || data.tipus == t_json ){\r\n\t\t\t\tif (busy){\r\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\r\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\r\n\t\t\t\t}\r\n\t\t\t\telse obrirMenuModal('#dialog_estils_punts','toggle',data);\r\n\t\t\t}else if (ftype == t_polyline){\r\n\t\t\t\tif (busy){\r\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\r\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\r\n\t\t\t\t}\r\n\t\t\t\telse obrirMenuModal('#dialog_estils_linies','toggle',data);\r\n\t\t\t}else if (ftype == t_polygon){\r\n\t\t\t\tif (busy){\r\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\r\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\r\n\t\t\t\t}\r\n\t\t\t\telse obrirMenuModal('#dialog_estils_arees','toggle',data);\r\n\t\t\t}\r\n\t\t}else if(tipus == tem_clasic){\r\n\t\t\tif (busy){\r\n\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\r\n\t\t\t\t$('#dialog_info_upload').modal('show');\r\n\t\t\t}\r\n\t\t\telse showModalTematicCategories(data);\r\n\t\t}else if(tipus == tem_heatmap){\r\n\t\t\tcreateHeatMap(controlCapes._layers[data.leafletid]);\r\n\t\t\tjQuery('#dialog_layers_tematic').modal('hide');\r\n\t\t}else if(tipus == tem_cluster){\r\n\t\t\tcreaClusterMap(controlCapes._layers[data.leafletid]);\r\n\t\t\tjQuery('#dialog_layers_tematic').modal('hide');\r\n\t\t}else if(tipus == tem_size){\r\n\t\t\tif (busy){\r\n\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\r\n\t\t\t\t$('#dialog_info_upload').modal('show');\r\n\t\t\t}\r\n\t\t\telse showModalTematicBubbles(data);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction loadCacheTematicLayer(layer){\r\n\tvar defer = $.Deferred();\r\n\tvar data={\r\n\t\tbusinessId: layer.businessId,\r\n\t\tuid: layer.entitatUid\r\n\t};\r\n\t\r\n\tvar layerWms = layer;\r\n\tgetCacheTematicLayerByBusinessId(data).then(function(results){\r\n\t\tresults.results = jQuery.parseJSON( results.results );\r\n\t\treadTematic(defer, results, layerWms, layer);\r\n\t},function(results){\r\n\t\t//console.debug('getTematicLayerByBusinessId ERROR');\r\n\t\tdefer.reject();\r\n\t});\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction loadTematicLayer(layer){\r\n\ttry {map.spin(true);} catch (Err) {}\r\n\tvar defer = $.Deferred();\r\n\tvar data={\r\n\t\tbusinessId: layer.businessId\r\n\t};\r\n\t\r\n\tvar layerWms = layer;\r\n\t\r\n\t//console.time(\"loadTematicLayer \" + layerWms.serverName);\r\n\tgetTematicLayerByBusinessId(data).then(function(results){\r\n\t\ttry {map.spin(false);} catch (Err) {}\r\n\t\treadTematic(defer, results, layerWms, layer);\r\n\t},function(results){\r\n\t\t//console.debug('getTematicLayerByBusinessId ERROR');\r\n\t\ttry {map.spin(false);} catch (Err) {}\r\n\t\tdefer.reject();\r\n\t});\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction createPopupWindowData(player,type, editable, origen, capa){\r\n//\tconsole.debug(\"createPopupWindowData\");\r\n//\tconsole.debug(player);\r\n\tvar html='';\r\n\tif (player.properties.data.nom && !isBusinessId(player.properties.data.nom)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nom+'</h4>';\r\n\t}else if (player.properties.data.Nom && !isBusinessId(player.properties.data.Nom)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.Nom+'</h4>';\r\n\t}else if (player.properties.data.NOM && !isBusinessId(player.properties.data.NOM)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NOM+'</h4>';\r\n\t}else if(player.properties.name && !isBusinessId(player.properties.name)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.name+'</h4>';\r\n\t}else if(player.properties.data.name && !isBusinessId(player.properties.data.name)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.name+'</h4>';\r\n\t}else if(player.properties.data.Name && !isBusinessId(player.properties.data.Name)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.Name+'</h4>';\r\n\t}else if(player.properties.data.NAME && !isBusinessId(player.properties.data.NAME)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NAME+'</h4>';\r\n\t}else if(player.properties.nom && !isBusinessId(player.properties.nom)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.nom+'</h4>';\r\n\t}else if(player.properties.nombre && !isBusinessId(player.properties.nombre)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.nombre+'</h4>';\r\n\t}else if(player.properties.data.nombre && !isBusinessId(player.properties.data.nombre)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nombre+'</h4>';\r\n\t}else if(player.properties.data.nombre && !isBusinessId(player.properties.data.nombre)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nombre+'</h4>';\r\n\t}else if(player.properties.data.NOMBRE && !isBusinessId(player.properties.data.NOMBRE)){\r\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NOMBRE+'</h4>';\r\n\t}\r\n\t\r\n\t\r\n\tvar isADrawarker=false;\r\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\tvar esVisor = ($(location).attr('href').indexOf('mapa')==-1);\r\n\t$.each( player.properties.data, function( key, value ) {\r\n\t\tif (key.toLowerCase()!=\"geomorigen\"){\r\n\t\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \r\n\t\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \r\n\t\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\r\n\t\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\r\n\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\tvar txt=value;\r\n\t\t\t\t\tif (!$.isNumeric(txt)) {\r\n\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\r\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t\t'</div>';\r\n\t\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\r\n\t\t\t\t\t\tif(undefined != capa.isPropertyNumeric && capa.isPropertyNumeric[key] && \r\n\t\t\t\t\t\t\t(esVisor && visor.colorscalecontrol && (\"\" == origen)) || (!esVisor && (\"\" == origen)) || (\"\" != origen && (key == capa.options.trafficLightKey)))\r\n\t\t\t\t\t\t{\r\n\t\r\n\t\t\t\t\t\t\tvar leafletid = ((\"undefined\" !== typeof player.properties.capaLeafletId) ? player.properties.capaLeafletId : (capa.hasOwnProperty(\"layer\") ? capa.layer._leaflet_id : \"\"));\r\n\t\t\t\t\t\t\t//Només ensenyem la icona del semafòric si és una capa no temàtica o bé si ho és però és semafòrica sense semàfor fixe (sempre que el camp sigui numèric)\r\n\t\t\t\t\t\t\thtml+='<div class=\"traffic-light-icon\" data-leafletid=\"' + leafletid + '\" data-origen=\"' + origen + '\" title=\"'+window.lang.translate('Temàtic per escala de color')+'\"></div>';\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\r\n\t\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\r\n\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\tif (key=='text' || key=='TEXT') isADrawarker=true;\r\n\t\t\t\t\telse isADrawarker=false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\t\r\n\tif (isADrawarker && type==\"marker\") {\r\n\t\tvar auxLat = player._latlng.lat;\r\n\t\tauxLat = auxLat.toFixed(5);\r\n\t\tvar auxLon = player._latlng.lng;\r\n\t\tauxLon = auxLon.toFixed(5);\r\n\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\thtml+='<div class=\"popup_data_key\">Latitud</div>';\r\n\t\thtml+='<div class=\"popup_data_value\">'+auxLat+'</div>';\r\n\t\thtml+= '</div>';\r\n\t\t\r\n\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\thtml+='<div class=\"popup_data_key\">Longitud</div>';\r\n\t\thtml+='<div class=\"popup_data_value\">'+auxLon+'</div>';\r\n\t\thtml+= '</div>';\r\n\t}\r\n\t\r\n\tif(editable){\r\n\t\thtml+= '<div id=\"footer_edit\"  class=\"modal-footer\">'\r\n\t\t\t+'<ul class=\"bs-popup\">'\r\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\r\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\r\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>'\r\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+player.properties.capaLeafletId+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>'\r\n\t\t\t\t+'<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#mapestematics\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>'\r\n\t\t\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t+'</div>';\t\r\n\t}else{\r\n\t\tvar capaLeafletId = player.properties.capaLeafletId;\r\n\t\tif(isValidValue(origen)) {\r\n\t\t\tcapaLeafletId = origen; \r\n\t\t}\r\n\t\thtml+= '<div id=\"footer_edit\"  class=\"modal-footer\">'\r\n\t\t\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\r\n\t\t\t\t+'<li class=\"consulta-popup\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+capaLeafletId+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau-left\" data-toggle=\"tooltip\" data-placement=\"right\" title=\"'+window.lang.translate('Obrir la taula de dades')+'\"></span></a>   </li>'\r\n\t\t\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t+'</div>';\t\t\t\r\n\t}\r\n\r\n\tif(type == t_polyline && player.properties.mida){\r\n\t\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Longitud')+':</b> '+player.properties.mida+'</div>';\t\r\n\t}else if(type == t_polygon && player.properties.mida){\r\n\t\tif (player.properties.mida.indexOf(\"NaN\")==-1)\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+player.properties.mida+'</div>';\r\n\t\telse html+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+L.GeometryUtil.readableArea(L.GeometryUtil.geodesicArea(player.getLatLngs()),true)+'</div>';\r\n\t}\r\n\thtml+='</div>';\r\n\t//he quitado el openPopup() ya que si la capa no està activa no se ha cargado en el mapa y da error.\r\n\tplayer.bindPopup(html,{'offset':[0,-25]});\r\n\r\n\t//Afegim els events de clicks per al semafòric\r\n\tjQuery(document).on('click', \".traffic-light-icon\", function(e) {\r\n\r\n\t\te.stopImmediatePropagation();\r\n\t\tvar layerId = $(this).data(\"leafletid\");\r\n\t\tvar parentId = $(this).data(\"origen\");\r\n\t\tvar key = $(this).prev().prev().text();\r\n\t\tvar value = parseFloat($(this).prev().text());\r\n\t\tvar layer = null;\r\n\t\tvar control = null;\r\n\t\tif(\"\" == parentId)\r\n\t\t{\r\n\r\n\t\t\t//És una capa no temàtica, hem de crear la de previsualització\r\n\t\t\tlayer = controlCapes._layers[layerId].layer;\r\n\t\t\tcontrol = Semaforic(self.isEditing);\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\t//És una capa temàtica, mirem si és una capa semafòrica de previsualització\r\n\t\t\tlayer = controlCapes._layers[parentId].layer;\r\n\t\t\tif(layer.hasOwnProperty(\"semaforics\") && \"undefined\" !== typeof layer.semaforics[layerId])\r\n\t\t\t\tcontrol = layer.semaforics[layerId];\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t//Si hem arribat aquí és que és una capa semafòrica, utilitzem la capa actual\r\n\t\t\t\tcontrol = Semaforic();\r\n\t\t\t\tvar businessId = controlCapes._layers[parentId]._layers[layerId].layer.options.businessId;\r\n\t\t\t\tvar options = JSON.parse(controlCapes._visLayers[businessId].options);\r\n\t\t\t\tvar paletaEstils = [controlCapes._visLayers[businessId].estil[0].color,\r\n\t\t\t\t\tcontrolCapes._visLayers[businessId].estil[1].color,\r\n\t\t\t\t\tcontrolCapes._visLayers[businessId].estil[2].color\r\n\t\t\t\t\t]\r\n\t\t\t\tcontrol.setVisualization(controlCapes._layers[parentId]._layers[layerId]);\r\n\t\t\t\tcontrol.setLayer(controlCapes._visLayers[businessId]);\r\n\t\t\t\tcontrol.setLayerOptions(controlCapes._options[businessId]);\r\n\t\t\t\tcontrol.setPalette(paletaEstils, options.reverse);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tcontrol.render($.Deferred(), key, value, layer).then(function(data) {\r\n\t\t\tif(!layer.hasOwnProperty(\"semaforics\"))\r\n\t\t\t\tlayer.semaforics = {};\r\n\t\t\r\n\t\t\tlayer.semaforics[data] = control;\r\n\t\t\t//Canviem el valor de referència de la capa al control de capes si el conté\r\n\t\t\tvar name = Semaforic.getUpdatedLayerName($(\"#\" + layerId + \".editable\").text(), value);\r\n\t\t\tif(self.isEditing)\r\n\t\t\t\t$(\"#\" + layerId + \".editable\").editable(\"setValue\", name, true);\r\n\t\t\telse\r\n\t\t\t\t$(\"#\" + layerId + \".editable\").text(name);\r\n\r\n\t\t});\r\n\r\n\t});\r\n\t\r\n\t//Afegim events/accions al popUp\r\n\tjQuery(document).on('click', \".bs-popup li a\", function(e) {\r\n\t\te.stopImmediatePropagation();\r\n\t\tvar accio;\r\n\t\tif(undefined != jQuery(this).attr('id') && jQuery(this).attr('id').indexOf('##')!=-1){\t\r\n\t\t\taccio=jQuery(this).attr('id').split(\"##\");\t\t\t\t\r\n\t\t}\r\n\t\t\r\n\t\tif (accio!=undefined && accio[1]!=undefined) objEdicio.featureID=accio[1];\r\n\t\t\r\n\t\tif(undefined != accio[0] && accio[0].indexOf(\"feature_edit\")!=-1){\r\n\r\n\t\t\t//Update modal estils, amb estil de la feature seleccionada\r\n\t\t\tvar obj = map._layers[accio[1]];\r\n\t\t\t//console.debug(obj);\r\n\t\t\tif(obj.options.icon /*|| obj.options.icon.options.markerColor.indexOf(\"punt_r\")!=-1*/){\r\n\t\t\t\tvar icon = obj.options.icon.options;\t\r\n\t\t\t}else if(obj._options){\r\n\t\t\t\tvar icon = obj._options;\r\n\t\t\t}else{\r\n\t\t\t\tvar icon = obj.options;\r\n\t\t\t}\r\n\t\t\tupdateDialogStyleSelected(icon);\r\n\t\t\t\r\n\t\t\tif(accio[2].indexOf(\"marker\")!=-1){\r\n\t\t\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaPopup);\r\n\t\t\t}else if(accio[2].indexOf(\"polygon\")!=-1){\r\n\t\t\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaPopup);\r\n\t\t\t}else{\r\n\t\t\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaPopup);\r\n\t\t\t}\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_data_table\")!=-1){\r\n\t\r\n\t\t\t$('#modal_data_table').modal('show');\r\n\t\t\tvar featureId=objEdicio.featureID;\r\n\t\t\tif (featureId==undefined) featureId=accio[2];\r\n\t\t\tif (map._layers[featureId]==undefined) {\r\n\t\t\t\ttry{\r\n\t\t\t\t\tif (accio[6]!=undefined) featureId=accio[6];\r\n\t\t\t\t\tvar props=map._layers[featureId].properties;\r\n\t\t\t\t\tif (props==undefined) props=map._layers[featureId].options;\r\n\t\t\t\t\tif (accio[3]==undefined)  fillModalDataTable(controlCapes._layers[accio[2]],props.businessId);\r\n\t\t\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],props.businessId);\r\n\t\t\t\t}\r\n\t\t\t\tcatch(err){\r\n\t\t\t\t\tconsole.debug(err);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],map._layers[featureId].properties.businessId);\r\n\t\t\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_remove\")!=-1){\r\n\t\t\tmap.closePopup();\r\n\t\t\tvar data = {\r\n\t            businessId: map._layers[objEdicio.featureID].properties.businessId,\r\n\t            uid: Cookies.get('uid')\r\n\t        };\r\n\t\t\r\n\t\t\tvar features = {\r\n\t\t\t\ttype:\"Feature\",\r\n\t\t\t\tid: 3124,\r\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.businessId,\r\n\t\t\t\tproperties: map._layers[objEdicio.featureID].properties.data,\r\n\t\t\t\testil: map._layers[objEdicio.featureID].properties.estil,\r\n\t\t\t\tgeometry: map._layers[objEdicio.featureID].properties.feature.geometry\r\n\t\t\t};\t\t\t\t\r\n\t\t\t\r\n\t\t\tfeatures = JSON.stringify(features);\r\n\t\t\t\r\n\t\t\tvar data = {\r\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.capaBusinessId,//bID de la visualitzacio-capa\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tfeatures: features\r\n\t\t\t};\r\n\t\t\tvar businessIdCapaOrigen=map._layers[objEdicio.featureID].properties.capaBusinessId;\r\n\t\t\tremoveGeometriaFromVisualitzacio(data).then(function(results){\r\n\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t/*var capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\r\n\t\t\t\t\tvar layer = map._layers[objEdicio.featureID];\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\r\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\r\n\t\t\t\t\tvar layerMap=map._layers[capaLeafletId];\r\n\t\t\t\t\tvar layerMare = controlCapes._layers[capaLeafletId];\r\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\r\n\t\t\t\t\tactualitzacioTematic(layerMare,businessIdCapaOrigen,null,null,null,\"baixa\");  \r\n\t\t\t\t\t*/\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\r\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\r\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\r\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) {\r\n\t\t\t\t\t\tupdateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\t\t\t\t\t\t\r\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\r\n\t\t\t\t\t}\t\t\r\n\t\t\t\t\t var layer = controlCapes._layers[capaLeafletId];\r\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\r\n\t\t\t\t\tactualitzacioTematic(layer,businessIdCapaOrigen,null,null,null,\"baixa\");\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\r\n\t\t\t\t}\r\n\t\t\t},function(results){\r\n\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\r\n\t\t\t});\t\t\t\t\t\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_text\")!=-1){\r\n\t\t\tmodeEditText();\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_move\")!=-1){\r\n\t\t\tobjEdicio.esticEnEdicio=true;\r\n\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\t\r\n\t\t\tobjEdicio.capaEdicioLeafletId = capaLeafletId;//Ho guarda per despres poder actualitzar vis filles\r\n\t\t\t//Actualitzem capa activa\r\n\t\t\tif (capaUsrActiva){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t}\r\n\t\t\tcapaUsrActiva = map._layers[capaLeafletId];\r\n\t\t\t\r\n\t\t\tvar capaEdicio = new L.FeatureGroup();\r\n\t\t\tcapaEdicio.addLayer(map._layers[objEdicio.featureID]);\r\n\t\t\tcapaUsrActiva.removeLayer(map._layers[objEdicio.featureID]);\r\n\t\t\tmap.addLayer(capaEdicio);\r\n\t\t\t\r\n\t\t\tvar opcionsSel={\r\n\t\t\t\t\tcolor: '#FF1EE5',\r\n\t\t\t\t\t\"weight\": 7,\r\n\t\t\t\t\topacity: 0.6,\r\n\t\t\t\t\tdashArray: '1, 1',\r\n\t\t\t\t\tfill: true,\r\n\t\t\t\t\tfillColor: '#fe57a1',\r\n\t\t\t\t\tfillOpacity: 0.1\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\t/*crt_Editing=new L.EditToolbar.SnapEdit(map, {\r\n\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\tselectedPathOptions: opcionsSel,\r\n\t\t\t\tsnapOptions: {\r\n\t\t\t\t\tguideLayer: guideLayers\r\n\t\t\t\t}\r\n\t\t\t});*/\r\n\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\r\n\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\tselectedPathOptions: opcionsSel\r\n\t\t\t});\r\n\t\t\tcrt_Editing.enable();\r\n\t\t\t\r\n\t\t\t//crt_Editing.enable();\r\n\t\t\t\r\n\t\t\t/*if(map._layers[objEdicio.featureID].properties.tipusFeature==\"marker\" && map._layers[objEdicio.featureID].options.isCanvas){\r\n\t\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\r\n\t\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\t\tselectedPathOptions: opcionsSel\r\n\t\t\t\t});\r\n\t\t\t\tcrt_Editing.enable();\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tcrt_Editing=new L.EditToolbar.SnapEdit(map, {\r\n\t\t\t\t\tfeatureGroup: capaEdicio,\r\n\t\t\t\t\tselectedPathOptions: opcionsSel,\r\n\t\t\t\t\tsnapOptions: {\r\n\t\t\t\t\t\tguideLayer: guideLayers\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tcrt_Editing.enable();\r\n\t\t\t\t//activarSnapping(capaEdicio);\r\n\t\t\t}*/\r\n\t\t\t\r\n\t\t\t//activarSnapping(capaEdicio);\t\t\t\r\n\t\t\t\r\n\t\t\tmap.closePopup();\r\n\t\t\t\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_no\")!=-1){\r\n\t\t\tjQuery('.popup_pres').show();\r\n\t\t\tjQuery('.popup_edit').hide();\r\n\t\t\t\r\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_ok\")!=-1){\r\n\t\t\tif(objEdicio.edicioPopup=='textFeature'){\r\n\t\t\t\tvar txtTitol=jQuery('#titol_edit').val();\r\n\t\t\t\tvar txtDesc=jQuery('#des_edit').val();\r\n\t\t\t\tif (txtDesc.indexOf(\"'\")>-1) txtDesc = txtDesc.replaceAll(\"'\",'\"');\r\n\t\t\t\tupdateFeatureNameDescr(map._layers[objEdicio.featureID],txtTitol,txtDesc);\r\n\r\n\t\t\t}else if(objEdicio.edicioPopup=='textCapa'){\r\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\r\n\t\t\t\t\tjQuery('#cmbCapesUsr option:selected').text(jQuery('#capa_edit').val());\t\r\n\t\t\t\t\tjQuery('.popup_pres').show();\r\n\t\t\t\t\tjQuery('.popup_edit').hide();\r\n\t\t\t\t}else{\r\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\r\n\t\t\t\t}\r\n\t\t\t}else if(objEdicio.edicioPopup=='nouCapa'){\r\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\r\n\t\t\t\t\tgeneraNovaCapaUsuari(map._layers[objEdicio.featureID],jQuery('#capa_edit').val());\r\n\t\t\t\t}else{\r\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t//accio tanca\r\n\t\t\tmap.closePopup();\r\n\t\t}\r\n\t});\t\r\n\r\n\tplayer.on('popupopen', function(e){\r\n\t\t//console.debug(e);\r\n\t\tif(objEdicio.esticEnEdicio){//Si s'esta editant no es pot editar altre element\r\n\t\t\tmap.closePopup();\r\n\t\t}\r\n\t});\r\n\r\n\treturn html;\r\n}\r\n\r\n/*****************************/\r\n\r\n\r\n/** Funcions que actualitzen l'estil per defecte, al seleccionat al dialeg d'estils\r\n * \tper punts, línies, i polígons. \r\n * */\r\n\r\nfunction changeDefaultLineStyle(canvas_linia){\r\n\tvar estilTMP = default_line_style;\r\n\testilTMP.color=canvas_linia.strokeStyle;\r\n\testilTMP.weight=canvas_linia.lineWidth;\r\n\testilTMP.tipus=t_polyline;\r\n\t\r\n\t\r\n\t\r\n\tif(objEdicio.obroModalFrom==from_creaCapa){\r\n\t\t drawControl.options.polyline.shapeOptions= estilTMP;\r\n\t}\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction changeDefaultAreaStyle(canvas_pol){\r\n\tvar estilTMP= default_area_style;\r\n\testilTMP.fillColor=canvas_pol.fillStyle;\r\n\testilTMP.fillOpacity=canvas_pol.opacity;\r\n\testilTMP.weight=canvas_pol.lineWidth;\r\n\testilTMP.color=canvas_pol.strokeStyle;\r\n\testilTMP.tipus=t_polygon;\r\n\t\r\n\tif(objEdicio.obroModalFrom==from_creaCapa){\r\n\t\tdrawControl.options.polygon.shapeOptions= estilTMP;\r\n\t}\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction changeDefaultPointStyle(estilP) {\r\n\t//console.debug(\"changeDefaultPointStyle\");\r\n\tvar puntTMP= new L.AwesomeMarkers.icon(default_marker_style);\r\n\tvar _iconFons=estilP.iconFons.replace('awesome-marker-web awesome-marker-icon-','');\r\n\tvar _iconGlif=estilP.iconGlif;\t\r\n\tvar cssText=\"\";\r\n\t\r\n\tif(_iconGlif.indexOf(\"fa fa-\")!=-1){\r\n\t\t_iconGlif=estilP.iconGlif.replace('fa fa-','');\r\n\t};\r\n\t\r\n\tif (_iconGlif.indexOf(\"font\")!=-1){\r\n\t\t_iconGlif = _iconGlif.substring(0,_iconGlif.indexOf(\" \")) ;\r\n\t}\r\n//\tconsole.debug(_iconFons);\r\n\t\r\n\tvar _colorGlif=estilP.colorGlif;\r\n\t\r\n\tif(_iconFons.indexOf(\"_r\")!=-1){ //sóc rodó\t\t\r\n\t\tvar num=estilP.size;\r\n\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\r\n\t\tvar tt=estilP.fontsize;\r\n\t\tpuntTMP.options.divColor=estilP.divColor;\r\n\t\tif(tt==\"9px\" || tt==\"8px\"){\r\n\t\t\tcssText=\"font9\";\t\t\t\r\n\t\t}else if(tt==\"11px\" || tt==\"10.5px\"){\r\n\t\t\tcssText=\"font11\";\r\n\t\t}else if(tt==\"12px\"){\r\n\t\t\tcssText=\"font12\";\r\n\t\t}else if(tt==\"15px\"){\r\n\t\t\tcssText=\"font15\";\r\n\t\t}else if(tt==\"17px\"){\r\n\t\t\tcssText=\"font17\";\t\t\r\n\t\t}\r\n\t\t\t\t\r\n\t\tpuntTMP.options.fillColor =estilP.divColor;\r\n\t\tif(_iconGlif==\"\" || _iconGlif==\"undefined\" || _iconGlif==null){//no tin glif soc Canvas\r\n\t\t\tpuntTMP.options.icon=\"\";\r\n\t\t\tpuntTMP.options.radius = parseInt(estilP.size/2.4);\r\n\t\t\tpuntTMP.options.isCanvas=true;\r\n\t\t}else{\r\n\t\t\tpuntTMP.options.iconAnchor= new L.Point(parseInt(num/2), parseInt(num/2));\r\n\t\t\tpuntTMP.options.iconSize = new L.Point(num, num);\r\n\t\t\tconsole.debug(puntTMP.options.icon);\r\n\t\t\tpuntTMP.options.icon=_iconGlif + \" \"+cssText;\r\n\t\t\tconsole.debug(puntTMP.options.icon);\r\n\t\t\tpuntTMP.options.isCanvas=false;\r\n\t\t}\r\n\t}else{ // sóc pinxo\r\n\t\tpuntTMP.options.iconAnchor= new L.Point(14, 42);\r\n\t\tpuntTMP.options.iconSize = new L.Point(28, 42);\r\n\t\tpuntTMP.options.shadowSize = new L.Point(36, 16);\r\n\t\tpuntTMP.options.divColor='transparent';\r\n\t\tif(_iconGlif==\"\" || _iconGlif==\"undefined\" || _iconGlif==null){\r\n\t\t\tpuntTMP.options.icon=\"\";\r\n\t\t}else{\r\n\t\t\tpuntTMP.options.icon=_iconGlif + \" \"+cssText;\t\t\t\r\n\t\t}\r\n\t\tpuntTMP.options.isCanvas=false;\r\n\t}\r\n\tpuntTMP.options.markerColor=_iconFons;\r\n\tif(puntTMP.options.icon==\"\"){\r\n\t\tpuntTMP.options.iconColor=\"#000000\";\r\n\t}else{\r\n\t\tpuntTMP.options.iconColor=_colorGlif;\r\n\t}\r\n\t\r\n\tif(objEdicio.obroModalFrom==from_creaCapa){\r\n\t\tdefaultPunt=puntTMP;\r\n\t}\r\n\treturn puntTMP;\r\n}\r\n/*****************************/\r\n\r\n/**Funcions per crear un objecte de tipus estil, amb les característiques que li passes\r\n * per punt, línia, poligon */\r\n\r\nfunction createFeatureLineStyle(style){\r\n\tvar estilTMP = default_line_style;\r\n\testilTMP.color=style.color;\r\n\testilTMP.weight=style.lineWidth;\r\n\testilTMP.tipus=t_polyline;\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction createFeatureAreaStyle(style){\r\n\tvar estilTMP= default_area_style;\r\n\testilTMP.fillColor=style.color;\r\n\testilTMP.fillOpacity=style.opacity/100;\r\n\testilTMP.weight=style.borderWidth;\r\n\testilTMP.color=style.borderColor;\r\n\testilTMP.tipus=t_polygon;\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction createFeatureMarkerStyle(style, num_geometries){\r\n\t//console.debug(\"createFeatureMarkerStyle\");\r\n\tif (!num_geometries){\r\n\t\tnum_geometries = num_max_pintxos - 1;\r\n\t}\r\n\tif (style.marker && num_geometries <= num_max_pintxos){\r\n\t\t//Especifiques per cercle amb glyphon\r\n\t\tif(style.marker == 'punt_r'){\r\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_circuloglyphon_style);\r\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\r\n\t\t\tpuntTMP.options.icon = style.simbol;\r\n\t\t\tpuntTMP.options.markerColor = style.marker;\r\n\t\t\tpuntTMP.options.isCanvas=false;\r\n\t\t\tpuntTMP.options.divColor= style.color;\r\n\t\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\r\n\t\t\tpuntTMP.options.radius = style.radius;\r\n\t\t\tvar anchor = style.iconAnchor.split(\"#\");\r\n\t\t\tvar size = style.iconSize.split(\"#\");\r\n\t\t\tpuntTMP.options.iconAnchor.x = parseInt(anchor[0]);\r\n\t\t\tpuntTMP.options.iconAnchor.y = parseInt(anchor[1]);\r\n\t\t\tpuntTMP.options.iconSize.x = size[0];\r\n\t\t\tpuntTMP.options.iconSize.y = size[1];\r\n\t\t}else{\r\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_marker_style);\r\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\r\n\t\t\tpuntTMP.options.icon = style.simbol;\r\n\t\t\tpuntTMP.options.markerColor = style.marker;\r\n\t\t\tpuntTMP.options.isCanvas=false;\r\n\t\t\tpuntTMP.options.iconAnchor.x = 14;\r\n\t\t\tpuntTMP.options.iconAnchor.y = 42;\r\n\t\t\tpuntTMP.options.iconSize.x = 28;\r\n\t\t\tpuntTMP.options.iconSize.y = 42;\r\n\t\t}\r\n\t}else{ //solo circulo\r\n\t\tvar puntTMP = { \r\n\t\t\tradius: style.simbolSize, \r\n\t\t\tisCanvas: true,\r\n\t\t\tfillColor: style.color,\r\n\t\t\tcolor:  style.borderColor,\r\n\t\t\tweight:  style.borderWidth,\r\n\t\t\tfillOpacity: style.opacity/100,\r\n\t\t\topacity: 1,\r\n\t\t\ttipus: t_marker\r\n\t\t};\r\n\t}\r\n\treturn puntTMP;\r\n}\r\n\r\nfunction createRangStyle(ftype, style, num_geometries){\r\n\tvar rangStyle;\r\n\tif (style){\r\n\t\tif (ftype === t_marker){\r\n\t\t\trangStyle = createFeatureMarkerStyle(style, num_geometries);\r\n\t\t}else if (ftype === t_multipoint){\r\n\t\t\trangStyle = createFeatureMarkerStyle(style, num_geometries);\r\n\t\t}else if (ftype === t_polyline){\r\n\t\t\trangStyle = createFeatureLineStyle(style);\r\n\t\t}else if (ftype === t_multilinestring){\r\n\t\t\trangStyle = createFeatureLineStyle(style);\r\n\t\t}else if (ftype === t_polygon){\r\n\t\t\trangStyle = createFeatureAreaStyle(style);\r\n\t\t}else if (ftype === t_multipolygon){\r\n\t\t\trangStyle = createFeatureAreaStyle(style);\r\n\t\t}\r\n\t}else{\r\n\t\tif (ftype === t_marker){\r\n\t\t\trangStyle = L.AwesomeMarkers.icon(default_marker_style);\r\n\t\t}else if (ftype === t_multipoint){\r\n\t\t\trangStyle = L.AwesomeMarkers.icon(default_marker_style);\r\n\t\t}else if (ftype === t_polyline){\r\n\t\t\trangStyle = default_line_style;\r\n\t\t}else if (ftype === t_multilinestring){\r\n\t\t\trangStyle = default_line_style;\r\n\t\t}else if (ftype === t_polygon){\r\n\t\t\trangStyle = default_area_style;\r\n\t\t}else if (ftype === t_multipolygon){\r\n\t\t\trangStyle = default_area_style;\r\n\t\t}\r\n\t}\r\n\treturn rangStyle;\r\n}\r\n/*************************************************/\r\n\r\n/**Funcio que actualitza els rangs de la capa quan: \r\n * - Es canvia l'estil d'una feature\r\n * - Es mou una feature d'una capa a un altre\r\n * - Cada cop que es carrega un fitxer (dragdrop urlfile) i es vol centrar al mapa als features*/\t\r\nfunction getRangsFromLayer(layer){\r\n\t//console.debug(\"getRangsFromLayer\");\r\n\tif (layer.options.tipus == t_tematic){\r\n\t\tvar styles = jQuery.map(layer.getLayers(), function(val, i){\r\n\t\t\treturn {key: val.properties.businessId, style: val};\r\n\t\t});\r\n\t\t\r\n\t\tvar tematic = layer.options;\r\n\t\ttematic.tipusRang = tematic.tipusRang ? tematic.tipusRang : tem_origen;\r\n\t\ttematic.businessid = tematic.businessId; \r\n\t\ttematic.leafletid = layer._leaflet_id;\r\n\t\ttematic.geometrytype = tematic.geometryType;\r\n\t\ttematic.from = tematic.tipusRang;\r\n\t\t\r\n\t\tvar rangs = getRangsFromStyles(tematic, styles);\r\n        rangs = JSON.stringify({rangs:rangs});\r\n        \r\n        var data = {\r\n          businessId: tematic.businessid,\r\n          uid: Cookies.get('uid'),\r\n          tipusRang: tematic.from,\r\n          rangs: rangs\r\n        };\r\n              \r\n        updateTematicRangs(data).then(function(results){\r\n        \t//console.debug(results);\r\n        },function(results){\r\n\t\t\t//TODO error\r\n\t\t\tconsole.debug(\"getRangsFromLayer ERROR\");\r\n\t\t});\r\n\t}\r\n}\r\n\r\n\r\nfunction getMarkerRangFromStyle(styles){\r\n\t\r\n\tif (styles.options.isCanvas){\r\n\t\tvar rang = {\r\n\t\t\tisCanvas: true,\t\r\n\t\t\tsimbolSize : styles.options.radius, \r\n\t\t\tcolor :  jQuery.Color(styles.options.fillColor).toHexString(),\r\n\t\t\tborderColor :  styles.options.color,\r\n\t\t\tborderWidth :  styles.options.weight,\r\n\t\t\topacity: (styles.options.fillOpacity * 100),\r\n\t\t\tlabel : false,\r\n\t\t\tlabelSize : 10,\r\n\t\t\tlabelFont : 'arial',\r\n\t\t\tlabelColor : '#000000',\t\t\t\t\t\r\n\t\t};\r\n\t}else{\r\n\t\t//CAL??\r\n\t\tif(jQuery.type(styles.options.icon) === \"object\"){\r\n\t\t\tvar auxOptions = styles.options.icon.options;\r\n\t\t}else{\r\n\t\t\tvar auxOptions = styles.options;\r\n\t\t}\r\n\t\t\r\n\t\tvar rang = {\r\n\t\t\tisCanvas: false,\r\n\t\t\tcolor : auxOptions.divColor,//auxOptions.fillColor,//Color principal\r\n\t\t\tmarker: auxOptions.markerColor,//Si es de tipus punt_r o el color del marker\r\n\t\t\tsimbolColor: auxOptions.iconColor,//Glyphon\r\n\t\t\tradius : auxOptions.radius,//Radius\r\n\t\t\ticonSize : auxOptions.iconSize.x+\"#\"+auxOptions.iconSize.y,//Size del cercle\r\n\t\t\ticonAnchor : auxOptions.iconAnchor.x+\"#\"+auxOptions.iconAnchor.y,//Anchor del cercle\r\n\t\t\tsimbol : $.trim(auxOptions.icon),//tipus glyph\r\n\t\t\topacity : (auxOptions.opacity * 100),\r\n\t\t\tlabel : false,\r\n\t\t\tlabelSize : 10,\r\n\t\t\tlabelFont : 'arial',\r\n\t\t\tlabelColor : '#000000',\r\n\t\t};\r\n\t}\r\n\treturn rang;\r\n}\r\n\r\nfunction getLineRangFromStyle(styles){\r\n\tvar rang = {\r\n\t\tcolor: styles.strokeStyle,//styles.color,\r\n\t\tlineWidth: styles.lineWidth,//styles.weight,\r\n\t\tlineStyle : 'solid',\r\n\t\tborderWidth : 2,\r\n\t\tborderColor : styles.strokeStyle,\t\t\t\t\r\n\t\t//opacity: (styles.opacity * 100),\r\n\t\topacity: 100,\r\n\t\tlabel : false,\r\n\t\tlabelSize : 10,\r\n\t\tlabelFont : 'arial',\r\n\t\tlabelColor : '#000000'\r\n\t};\t\r\n\treturn rang;\r\n}\r\n\r\nfunction getPolygonRangFromStyle(styles){\r\n\tstyles.fillColor = jQuery.Color(styles.fillColor).toHexString();\r\n\r\n\tvar rang = {\r\n\t\tborderWidth: styles.lineWidth,//styles.weight,\r\n\t\tborderColor: styles.strokeStyle,//styles.color,\r\n\t\tcolor: rgb2hex(styles.fillStyle),//styles.fillColor,\r\n\t\topacity: (styles.opacity * 100),//(styles.fillOpacity * 100),\r\n\t\tlineStyle : 'solid',\r\n\t\tlabel : false,\r\n\t\tlabelSize : 10,\r\n\t\tlabelFont : 'arial',\r\n\t\tlabelColor : '#000000',\r\n\t\tweight: styles.lineWidth\r\n\t};\t\r\n\t\r\n\treturn rang;\r\n}\r\n\r\nfunction getRangsFromStyles(tematic, styles){\r\n\t//console.debug(\"getRangsFromStyles\");\r\n\tif (tematic.tipus == t_dades_obertes){\r\n\t\ttematic.geometrytype = t_marker;\r\n\t}\r\n\t\r\n//\tvar ftype_vell = transformTipusGeometry(tematic.geometrytype);\r\n//\tvar ftype = transformTipusGeometry(tematic.geometryType);\r\n\t\r\n\t//Revisar majus minus del \"geometryType\"!\r\n\tvar ftype = \"\";\r\n\tif(tematic.geometrytype) ftype = transformTipusGeometry(tematic.geometrytype);\r\n\telse if(tematic.geometryType) ftype = transformTipusGeometry(tematic.geometryType);\r\n\telse ftype = transformTipusGeometry(tematic.geometrType);\r\n\t\r\n\t/*Control cas multiple\r\n\tif(ftype == t_multiple && styles.options){\r\n\t\t ftype = transformTipusGeometry(styles.options.tipus);\r\n\t}*/\r\n\t\r\n\tvar rangs = [];\r\n\tif (jQuery.isArray(styles)){\r\n\t\tjQuery.each(styles, function(i, val){\r\n\t\t\tvar rang = getRangsFromStyles(tematic, val.style);\r\n\t\t\tif(rang[0]){\r\n\t\t\t\trang[0].featureLeafletId = val.style._leaflet_id;\r\n\t\t\t\trang = rang[0];\r\n\t\t\t\trang.valorMax = val.key;\r\n\t\t\t\trangs.push(rang);\t\t\t\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}else{\r\n\t\tif (ftype == t_marker){\r\n\t\t\t\r\n\t\t\tif (styles.options.isCanvas){\r\n\t\t\t\tvar rang = {\r\n\t\t\t\t\tisCanvas: true,\t\r\n\t\t\t\t\tsimbolSize : styles.options.radius, \r\n\t\t\t\t\tcolor :  jQuery.Color(styles.options.fillColor).toHexString(),\r\n\t\t\t\t\tborderColor :  styles.options.color,\r\n\t\t\t\t\tborderWidth :  styles.options.weight,\r\n\t\t\t\t\topacity: (styles.options.fillOpacity * 100),\r\n\t\t\t\t\tlabel : false,\r\n\t\t\t\t\tlabelSize : 10,\r\n\t\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\t\tlabelColor : '#000000',\t\t\t\t\t\r\n\t\t\t\t};\r\n\t\t\t}else{\r\n\t\t\t\t\r\n//\t\t\t\tvar auxOptions = styles.options;\r\n//\t\t\t\twhile(jQuery.type(styles.options.icon) === \"object\"){\r\n//\t\t\t\t\t//if(jQuery.trim(styles.options.icon) != \"\" && jQuery.isPlainObject(styles.options.icon)){\r\n//\t\t\t\t\tstyles.options = styles.options.icon.options;\r\n//\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tif(jQuery.type(styles.options.icon) === \"object\"){\r\n\t\t\t\t\tvar auxOptions = styles.options.icon.options;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar auxOptions = styles.options;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tvar rang = {\r\n\t\t\t\t\tisCanvas: false,\r\n\t\t\t\t\t//legenda : 'TODO ficar llegenda',//TODO ficar nom de la feature del popup de victor\r\n//\t\t\t\t\tvalorMax : \"feature\" + fId,\r\n\t\t\t\t\t//Canviat a divColor, si es marker, sera sempre 'transparent'\r\n\t\t\t\t\tcolor : auxOptions.divColor,//auxOptions.fillColor,//Color principal\r\n\t\t\t\t\tmarker: auxOptions.markerColor,//Si es de tipus punt_r o el color del marker\r\n\t\t\t\t\tsimbolColor: auxOptions.iconColor,//Glyphon\r\n\t\t\t\t\tradius : auxOptions.radius,//Radius\r\n\t\t\t\t\ticonSize : auxOptions.iconSize.x+\"#\"+auxOptions.iconSize.y,//Size del cercle\r\n\t\t\t\t\ticonAnchor : auxOptions.iconAnchor.x+\"#\"+auxOptions.iconAnchor.y,//Anchor del cercle\r\n\t\t\t\t\tsimbol : $.trim(auxOptions.icon),//tipus glyph\r\n\t\t\t\t\topacity : (auxOptions.opacity * 100),\r\n\t\t\t\t\tlabel : false,\r\n\t\t\t\t\tlabelSize : 10,\r\n\t\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\t\tlabelColor : '#000000',\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}else if (ftype == t_polyline){\r\n\t\t\t\r\n\t\t\tif (styles._options){\r\n\t\t\t\tstyles.options = styles._options;\r\n\t\t\t}else if(!styles.options) styles.options = styles;\r\n\t\t\t\r\n\t\t\tvar rang = {\r\n\t\t\t\tcolor: styles.options.color,\r\n\t\t\t\tlineWidth: styles.options.weight,\r\n\t\t\t\tlineStyle : 'solid',\r\n\t\t\t\tborderWidth : 2,\r\n\t\t\t\tborderColor : styles.options.color,\t\t\t\t\r\n\t\t\t\topacity: (styles.options.opacity * 100),\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000'\r\n\t\t\t};\r\n\t\t}else if (ftype == t_polygon){\r\n\t\t\tif (styles._options){\r\n\t\t\t\tstyles = styles._options;\r\n\t\t\t}else if(styles.options){\r\n\t\t\t\tstyles = styles.options;\r\n\t\t\t}\r\n\t\t\tstyles.fillColor = jQuery.Color(styles.fillColor).toHexString();\r\n\t\t\tvar rang = {\r\n\t\t\t\tborderWidth: styles.weight,\r\n\t\t\t\tborderColor: styles.color,\r\n\t\t\t\tcolor: styles.fillColor,\r\n\t\t\t\topacity: (styles.fillOpacity * 100),\r\n\t\t\t\tlineStyle : 'solid',\r\n\t\t\t\tlabel : false,\r\n\t\t\t\tlabelSize : 10,\r\n\t\t\t\tlabelFont : 'arial',\r\n\t\t\t\tlabelColor : '#000000'\t\t\t\t\t\r\n\t\t\t};\r\n\t\t}\r\n//\t\trang.businessId = styles.properties.businessId;\r\n//\t\trang.featureLeafletId = styles._leaflet_id;\r\n\t\trangs.push(rang);\r\n\t}\r\n\treturn rangs;\r\n}\r\n\r\n/*******************************************************************/\r\n\r\nfunction canviaStyleSinglePoint(cvStyle,feature,capaMare,openPopup){\r\n\tvar isCanvas=false;\r\n\tif(feature._ctx){isCanvas=true;}\r\n\tvar featureID=feature._leaflet_id\r\n\t\r\n\tvar noCanvi=(isCanvas==cvStyle.options.isCanvas);\r\n\r\n\tif(noCanvi && !isCanvas){//pinxo i/o glifons\r\n\t\tmap._layers[featureID].setIcon(cvStyle);\t\t\r\n\t}else if (noCanvi && isCanvas){//Nomes punt\r\n\t\tmap._layers[featureID].setStyle(cvStyle.options);\r\n\t\tmap._layers[featureID].setRadius(cvStyle.options.radius);\r\n\t}else if (!noCanvi ){\r\n\t\tcapaMare.removeLayer(map._layers[featureID]);\r\n\t\tvar layerTMP;\r\n\t\tif(isCanvas){//hi ha canvi de punt a pinxo i/o glifon\r\n\t\t\tlayerTMP=L.marker([feature.getLatLng().lat,feature.getLatLng().lng],\r\n\t\t\t\t\t{icon: cvStyle,isCanvas:cvStyle.options.isCanvas,\r\n\t\t\t\t\t tipus: t_marker});\r\n\t\t}else{//hi ha canvia de pinxo a punt canvas\r\n\t\t\tlayerTMP= L.circleMarker([feature.getLatLng().lat,feature.getLatLng().lng],\r\n\t\t\t\t{ radius : cvStyle.options.radius, \r\n\t\t\t\t  isCanvas:cvStyle.options.isCanvas,\r\n\t\t\t\t  fillColor : cvStyle.options.fillColor,\r\n\t\t\t\t  color :  cvStyle.options.color,\r\n\t\t\t\t  weight :  cvStyle.options.weight,\r\n\t\t\t\t  opacity :  cvStyle.options.opacity,\r\n\t\t\t\t  fillOpacity : cvStyle.options.fillOpacity,\r\n\t\t\t\t  tipus: t_marker}\t\r\n\t\t\t);\r\n\t\t}\r\n\t\tlayerTMP.properties=feature.properties;\t\r\n\t\tlayerTMP.addTo(capaMare);\r\n\t\tif (capaMare.options.tipus == t_dades_obertes){\r\n\t\t\t//popUp(feature, capaMare);\r\n\t\t}else{\r\n\t\t\tcreatePopupWindow(layerTMP,layerTMP.options.tipus);\t\r\n\t\t\tif(!openPopup){\r\n\t\t\t\t//map.closePopup();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tmap.closePopup();\t\r\n}\r\n\r\nfunction addHtmlInterficieTematics(){\r\n\tjQuery(\"#funcio_tematics\").append(\r\n\t\t\t'<h5 lang=\"ca\">Triar l\\'estil de la capa</h5>'+\r\n\t\t\t'<div class=\"div_gr3_estils\">'+\r\n\t\t\t'\t<div id=\"st_Color\" lang=\"ca\" class=\"div_estil_1\" data-toggle=\"tooltip\" data-lang-title=\"Bàsic\" title=\"Bàsic\"></div>'+\r\n\t\t\t'\t<div id=\"st_Tema\" lang=\"ca\" class=\"div_estil_2\" data-toggle=\"tooltip\" data-lang-title=\"Categories\" title=\"Categories\"></div>'+\r\n\t\t\t'\t<div id=\"st_Size\" lang=\"ca\" class=\"div_estil_3\" data-toggle=\"tooltip\" data-lang-title=\"Mides\" title=\"Mides\"></div>'+\r\n\t\t\t'\t<div id=\"st_Heat\" lang=\"ca\" class=\"div_estil_4\" data-toggle=\"tooltip\" data-lang-title=\"Concentració\" title=\"Concentració\"></div>'+\r\n\t\t\t'\t<div id=\"st_Clust\" lang=\"ca\" class=\"div_estil_5\" data-toggle=\"tooltip\" data-lang-title=\"Agrupació\" title=\"Agrupació\"></div>'+\r\n\t\t\t'</div>'\t\t\t\r\n\t);\r\n\t\r\n\tjQuery('.div_gr3_estils [data-toggle=\"tooltip\"]').tooltip({container : 'body', placement: 'bottom'});\r\n\t\t\r\n\t/*\r\n\t$('#st_Color').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Bàsic\")});\r\n\t$('#st_Tema').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Categories\")});\r\n\t$('#st_Size').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Mides\")});\t\r\n\t$('#st_Heat').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Concentració\")});\r\n\t$('#st_Clust').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Agrupació\")});\r\n\t*/\r\n}\r\n\r\nfunction addHtmlModalLayersTematic(){\r\n\t\r\n\tjQuery('#mapa_modals').append(\r\n\t'\t<!-- Modal Tematics Layers -->'+\r\n\t'\t\t<div class=\"modal fade\" id=\"dialog_layers_tematic\">'+\r\n\t'\t\t<div class=\"modal-dialog\">'+\r\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\r\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\r\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t'\t\t\t\t\t<h4 class=\"modal-title\"><span lang=\"ca\">Triar una capa per aplicar-hi l\\'estil</span><span><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#mapestematics\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></h4>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-body\">'+\r\n\t'\t\t\t\t\t<div class=\"alert alert-success\" id=\"txtTematic\">'+\r\n\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-layers-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<div class=\"panel-warning\">'+\t\t\t\t\t\r\n\t'\t\t\t\t\t<ul class=\"bs-dadesO_USR panel-heading\">'+\r\n\t'\t\t\t\t\t\t{{#each layers}}'+\r\n\t'\t\t\t\t\t\t<li><a class=\"usr_wms_layer lable-usr\" data-leafletid=\"{{layer._leaflet_id}}\" data-businessId=\"{{layer.options.businessId}}\" data-geometryType=\"{{layer.options.geometryType}}\" data-tipus=\"{{layer.options.tipus}}\" data-propName=\"{{layer.options.propName}}\">{{name}}</a></li>'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t</ul>'+\t\r\n\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<div id=\"list_tematic_layers\"></div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t'\t\t\t\t<div style=\"float:right;line-height: 40px;\"><span lang=\"ca\">Estil actiu</span>:  <div style=\"float: right;width:42px;height:42px\" id=\"stActiu\"></div></div>'+\r\n\t'\t\t\t\t\t<!-- <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Tancar</button>'+\r\n\t'        <button type=\"button\" class=\"btn btn-success\">Canviar</button> -->'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t<!-- /.modal-content -->'+\r\n\t'\t\t</div>'+\r\n\t'\t\t<!-- /.modal-dialog -->'+\r\n\t'\t</div>'+\r\n\t'\t<!-- /.modal -->'+\r\n\t'\t<!-- fi Modal Tematics Layers -->'\t\t\r\n\t);\r\n\t\r\n}\r\n\r\nfunction addHtmlModalCategories(){\r\n\t\r\n\tjQuery('#mapa_modals').append(\r\n\t'\t<!-- Modal Tematics Rangs -->'+\r\n\t'\t\t<div class=\"modal fade\" id=\"dialog_tematic_rangs\">'+\r\n\t'\t\t<div class=\"modal-dialog\">'+\r\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\r\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\r\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\r\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\r\n\t'\t\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Defineix les categories</h4>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-body\">'+\r\n\t'\t\t\t\t\t<div class=\"labels_fields\">'+\r\n\t'\t\t\t\t\t\t<span>1.</span><span lang=\"ca\">Escull el camp per simbolitzar</span>:'+\r\n\t'\t\t\t\t\t\t<select name=\"dataField\" id=\"dataField\">'+\r\n\t'\t\t\t\t\t\t</select>'+\r\n\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-layers-fields\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t\t<option value=\"---\" lang=\"ca\">Escull el camp</option>'+\r\n\t'\t\t\t\t\t\t{{#each fields}}'+\r\n\t'\t\t\t\t\t\t<option value=\"{{this}}\">{{@key}}</option>'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<br/>'+\t\t\t\t\t\t\t\t\t\t\r\n\t'\t\t\t\t\t<div id=\"tipus_agrupacio_grp\" class=\"labels_fields\">'+\r\n\t'\t\t\t\t\t\t<span>2.</span><span lang=\"ca\">Escull l\\'interval</span>:'+\r\n\t'\t\t\t\t\t\t<span class=\"rd_separator\"></span>'+\r\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_unic\" name=\"rd_tipus_agrupacio\" value=\"U\">'+\r\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_unic\" lang=\"ca\">'+window.lang.translate(\"únic\")+'</label>'+\r\n\t'\t\t\t\t\t\t<span class=\"rd_separator\"></span>'+\r\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_semaforic\" name=\"rd_tipus_agrupacio\" value=\"S\">'+\r\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_semaforic\" lang=\"ca\">Escala de color</label>'+\r\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_rang\" name=\"rd_tipus_agrupacio\" value=\"R\">'+\r\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_rang\" lang=\"ca\">per intervals</label>'+\r\n\t'<!-- \t\t\t\t\t\t<select id=\"cmb_tipus_agrupacio\"> -->'+\r\n\t'<!-- \t\t\t\t\t\t\t<option lang=\"ca\" value=\"U\">Únic</option> -->'+\r\n\t'<!-- \t\t\t\t\t\t\t<option lang=\"ca\" value=\"R\">Rang</option> -->'+\r\n\t'<!-- \t\t\t\t\t\t</select> -->'+\r\n\t'\t\t\t\t\t</div>'+\t\t\t\r\n\t'\t\t\t\t\t<div id=\"num_rangs_grp\" class=\"labels_fields\" >'+\r\n\t'\t\t\t\t\t\t<select id=\"cmb_num_rangs\">'+\r\n\t'\t\t\t\t\t\t\t<option value=\"---\" selected >Intervals</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"2\">2</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"3\">3</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"4\">4</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"5\">5</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"6\">6</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"7\">7</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"8\">8</option>'+\r\n\t'\t\t\t\t\t\t\t<option value=\"9\">9</option>'+\r\n\t'\t\t\t\t\t\t</select>'+\r\n\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-punt-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\r\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\r\n\t'\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\r\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\r\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\r\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-polyline-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-polygon-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-punt-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<thead>'+\r\n\t'\t\t\t\t\t\t<tr>'+\r\n\t'     \t\t\t\t\t\t<th lang=\"ca\">Valor min</th>'+\r\n\t'     \t\t\t\t\t\t<th lang=\"ca\">Valor max</th>'+\r\n\t'  \t\t\t\t\t\t</tr>'+\r\n\t' \t\t\t\t\t\t</thead>'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'                       {{#if v.nodata}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\r\n\t'\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\r\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\r\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\r\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{else}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\r\n\t'\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\r\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\r\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\r\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\r\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t\t{{/if}}'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{/if}}'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-polyline-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'                       {{#if v.nodata}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{else}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{/if}}'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-polygon-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t{{#each values}}'+\r\n\t'                       {{#if v.nodata}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{else}}'+\r\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'                       {{/if}}'+\r\n\t'\t\t\t\t\t\t{{/each}}'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-punt-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<div id=\"div_punt0\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<div id=\"div_punt1\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<div id=\"div_punt2\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-polyline-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol0\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol1\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol2\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-polygon-template\" type=\"text/x-handlebars-template\">'+\r\n\t'\t\t\t\t\t<table class=\"table\">'+\r\n\t'\t\t\t\t\t\t<tbody>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol0\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol1\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\r\n\t'\t\t\t\t\t\t\t<td>'+\r\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol2\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\r\n\t'\t\t\t\t\t\t</td></tr>'+\r\n\t'\t\t\t\t\t\t</tbody>'+\r\n\t'\t\t\t\t\t</table>'+\t\r\n\t'\t\t\t\t\t</script>'+\r\n\t'\t\t\t\t\t<div id=\"palet_warning\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\r\n\t'\t\t\t\t\t<span lang=\"ca\">Per facilitar la llegibilitat del mapa hem limitat el número màxim de colors per a aquest estil a 9. La resta de categories es simbolitzaran amb color gris</span></div>'+\r\n\t'\t\t\t\t\t<div id=\"list_tematic_values\"></div>'+\r\n\r\n\t'\t\t\t\t\t<div id=\"paletes_colors\">'+\r\n\t'\t\t\t\t\t\t<div><span lang=\"ca\">Tria la paleta de colors</span><span class=\"glyphicon glyphicon-arrow-down btn-reverse-palete\"></span><span lang=\"ca\" class=\"btn-reverse-palete\">Inverteix paleta</span></div>'+\r\n\t'<div class=\"ramp BuGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(237,248,251)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(178,226,226)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(102,194,164)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(44,162,95)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,109,44)\"/></svg></div>'+\r\n\t'<div class=\"ramp BuPu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(237,248,251)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(179,205,227)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(140,150,198)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(136,86,167)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(129,15,124)\"/></svg></div>'+\r\n\t'<div class=\"ramp GnBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(240,249,232)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(186,228,188)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(123,204,196)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(67,162,202)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(8,104,172)\"/></svg></div>'+\r\n\t'<div class=\"ramp OrRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(254,240,217)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,204,138)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(252,141,89)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(227,74,51)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(179,0,0)\"/></svg></div>'+\r\n\t'<div class=\"ramp PuBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(241,238,246)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(189,201,225)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(116,169,207)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(43,140,190)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(4,90,141)\"/></svg></div>'+\r\n\t'<div class=\"ramp PuBuGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(246,239,247)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(189,201,225)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(103,169,207)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(28,144,153)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(1,108,89)\"/></svg></div>'+\r\n\t\r\n\t'<div class=\"ramp PuRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(241,238,246)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(215,181,216)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(223,101,176)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(221,28,119)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(152,0,67)\"/></svg></div>'+\r\n\t'<div class=\"ramp RdPu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(254,235,226)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(251,180,185)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,104,161)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(197,27,138)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(122,1,119)\"/></svg></div>'+\r\n\t'<div class=\"ramp YlGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,204)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(194,230,153)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(120,198,121)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(49,163,84)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,104,55)\"/></svg></div>'+\r\n\t'<div class=\"ramp YlGnBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,204)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(161,218,180)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(65,182,196)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(44,127,184)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(37,52,148)\"/></svg></div>'+\r\n\t'<div class=\"ramp YlOrBr\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,212)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(254,217,142)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(254,153,41)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(217,95,14)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(153,52,4)\"/></svg></div>'+\r\n\t'<div class=\"ramp YlOrRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,178)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(254,204,92)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(253,141,60)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(240,59,32)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(189,0,38)\"/></svg></div>'+\r\n\t\r\n\t'<div class=\"ramp BrBG\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(166,97,26)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(223,194,125)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(245,245,245)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(128,205,193)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(1,133,113)\"/></svg></div>'+\r\n\t'<div class=\"ramp PRGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(123,50,148)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(194,165,207)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,247,247)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(166,219,160)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,136,55)\"/></svg></div>'+\r\n\t'<div class=\"ramp PuOr\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(230,97,1)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,184,99)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,247,247)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(178,171,210)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(94,60,153)\"/></svg></div>'+\r\n\t'<div class=\"ramp RdGy\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(202,0,32)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(244,165,130)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,255)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(186,186,186)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(64,64,64)\"/></svg></div>'+\r\n\t'<div class=\"ramp RdYlBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(171,217,233)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(44,123,182)\"/></svg></div>'+\r\n\t'<div class=\"ramp RdYlGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(166,217,106)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(26,150,65)\"/></svg></div>'+\r\n\t'<div class=\"ramp Spectral\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(171,221,164)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(43,131,186)\"/></svg></div>'+\r\n\t\r\n\t'<div class=\"ramp Paired\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(166,206,227)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(31,120,180)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(178,223,138)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(51,160,44)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(251,154,153)\"/></svg></div>'+\r\n\t'<div class=\"ramp Set3\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(141,211,199)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(255,255,179)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(190,186,218)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(251,128,114)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(128,177,211)\"/></svg></div>'+\r\n\t'<div class=\"ramp Set1\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(228,26,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(55,126,184)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(77,175,74)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(152,78,163)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(255,127,0)\"/></svg></div>'+\r\n\t'<div class=\"ramp Dark2\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(27,158,119)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(217,95,2)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(117,112,179)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(231,41,138)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(102,166,30)\"/></svg></div>'+\r\n\t\r\n//\t'\t\t\t\t\t\t<img id=\"paletaPaired\" src=\"img/paleta2.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Paired\">'+\r\n//\t'\t\t\t\t\t\t<img id=\"paletaPastel\" src=\"img/paleta1.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Pastel\">'+\r\n//\t'\t\t\t\t\t\t<img id=\"paletaDivergent\" src=\"img/paleta_divergent.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Divergent\">'+\r\n//\t'\t\t\t\t\t\t<img id=\"paletaSecuencial\" src=\"img/paleta_sequencial.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Sequencial\">'+\r\n\t'\t\t\t\t\t</div>'+\r\n\t\r\n\t\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\r\n\t'         \t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Canviar</button>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t<!-- /.modal-content -->'+\r\n\t'\t\t</div>'+\r\n\t'\t\t<!-- /.modal-dialog -->'+\r\n\t'\t</div>'+\r\n\t'\t<!-- /.modal -->'+\r\n\t'\t<!-- fi Modal Tematics Rangs -->'\t\t\r\n\t);\r\n}\r\n\r\n\r\nfunction addHtmlModalBubbles(){\r\n\tjQuery('#mapa_modals').append(\r\n\t\t\t'<!-- Modal Tematics Bubble -->'+\r\n\t\t\t'<div class=\"modal fade\" id=\"dialog_tematic_bubble\">'+\r\n\t\t\t'\t<div class=\"modal-dialog\">'+\r\n\t\t\t'\t\t<div class=\"modal-content panel-primary\">'+\r\n\t\t\t'\t\t\t<div class=\"modal-header panel-heading\">'+\r\n\t\t\t'\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>'+\r\n\t\t\t'\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Defineix les categories</h4>'+\r\n\t\t\t'\t\t\t</div>'+\r\n\t\t\t'\t\t\t<div class=\"modal-body\">'+\r\n\t\t\t'\t\t\t\t<div class=\"labels_fields\">'+\r\n\t\t\t'\t\t\t\t\t<span lang=\"ca\">Escull el camp per simbolitzar</span>:'+\r\n\t\t\t'\t\t\t\t\t<select name=\"dataFieldBubble\" id=\"dataFieldBubble\">'+\r\n\t\t\t'\t\t\t\t\t</select>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'                <script id=\"tematic-layers-fields-bubble\" type=\"text/x-handlebars-template\">'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"---\" lang=\"ca\">Escull el camp</option>'+\r\n\t\t\t'\t\t\t\t\t\t{{#each fields}}'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"{{this}}\">{{@key}}</option>'+\r\n\t\t\t'\t\t\t\t\t\t{{/each}}'+\r\n\t\t\t'\t\t\t\t\t</script>'+\r\n\t\t\t'\t\t\t\t<br/>'+\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t'\t\t\t\t<div id=\"tipus_agrupacio_grp_bubble\" class=\"labels_fields\">'+\r\n\t\t\t\"\t\t\t\t\t<span lang='ca'>Escull l'interval</span>:\"+\r\n\t\t\t'\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_graduado\" name=\"rd_tipus_agrupacio_bubble\" value=\"G\">'+\r\n\t\t\t'\t\t\t\t\t<label for=\"rd_tipus_graduado\" lang=\"ca\">graduat</label>'+\r\n\t\t\t'\t\t\t\t\t<span class=\"rd_separator\"></span>'+\r\n\t\t\t'                   <input type=\"radio\" id=\"rd_tipus_proporcional\" name=\"rd_tipus_agrupacio_bubble\" value=\"P\">'+\r\n\t\t\t'\t\t\t\t\t<label for=\"rd_tipus_proporcional\" lang=\"ca\">proporcional</label>'+\r\n\t\t\t'\t\t\t\t</div>'+\t\t\t\r\n\t\t\t'\t\t\t\t<div id=\"num_rangs_grp_bubble\" class=\"labels_fields\" >'+\r\n\t\t\t'\t\t\t\t\t<select id=\"cmb_num_rangs_bubble\">'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"---\" selected >Intervals</option>'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"3\">3</option>'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"4\">4</option>'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"5\">5</option>'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"6\">6</option>'+\r\n\t\t\t'\t\t\t\t\t\t<option value=\"7\">7</option>'+\r\n\t\t\t'\t\t\t\t\t</select>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t<script id=\"tematic-values-rangs-punt-template-bubble\" type=\"text/x-handlebars-template\">'+\r\n\t\t\t'\t\t\t\t<table class=\"table\">'+\r\n\t\t\t'\t\t\t\t\t<thead>'+\r\n\t\t\t'\t\t\t\t\t<tr>'+\r\n\t\t    ' \t\t\t\t\t\t<th lang=\"ca\">Valor min.</th>'+\r\n\t\t    ' \t\t\t\t\t\t<th lang=\"ca\">Valor max.</th>'+\r\n\t\t\t'\t\t\t\t\t\t<th lang=\"ca\">Mida</th>'+\r\n\t\t\t'\t\t\t\t\t\t<th lang=\"ca\"></th>'+\r\n\t\t  \t'\t\t\t\t\t</tr>'+\r\n\t\t \t'\t\t\t\t\t</thead>'+\r\n\t\t\t'\t\t\t\t\t<tbody>'+\r\n\t\t\t'\t\t\t\t\t{{#each values}}'+\r\n\t\t\t'                   {{#if v.nodata}}'+\r\n\t\t\t'\t\t\t\t\t<tr><td class=\"td_15\"><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida nodata\"></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"\">'+\r\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\r\n\t\t\t'\t\t\t\t\t</td></tr>'+\r\n\t\t\t'                   {{else}}'+\r\n\t\t\t'\t\t\t\t\t<tr><td class=\"td_15\"><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida\"></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td class=\"\">'+\r\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\r\n\t\t\t'\t\t\t\t\t</td></tr>'+\r\n\t\t\t'                   {{/if}}'+\r\n\t\t\t'\t\t\t\t\t{{/each}}'+\r\n\t\t\t'\t\t\t\t\t</tbody>'+\r\n\t\t\t'\t\t\t\t</table>\t'+\r\n\t\t\t'\t\t\t\t</script>'+\r\n\t\t\t'\t\t\t\t<script id=\"tematic-values-proportional-punt-template-bubble\" type=\"text/x-handlebars-template\">'+\r\n\t\t\t'\t\t\t\t<table class=\"table text-center buble_table\">'+\r\n\t\t\t'\t\t\t\t\t<tbody>'+\r\n\t\t\t'\t\t\t\t\t{{#each values}}'+\r\n\t\t\t'                   {{#if v.nodata}}'+\r\n\t\t\t'                   <tr><td colspan=\"2\">'+\r\n\t\t\t'                     <div class=\"buble_prop\">'+\r\n\t\t\t'                       <div><label lang=\"ca\">Sense valor</label>&nbsp;{{v.min}}<input type=\"hidden\" value=\"{{v.min}}\" name=\"min\"></div>'+\r\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida nodata\"></div>'+\r\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_nodata\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\r\n\t\t\t'                     </div></td>'+\r\n\t\t\t'                   </td></tr>'+\r\n\t\t\t'                   {{else}}'+\r\n\t\t\t'\t\t\t\t\t<tr><td>'+\r\n\t\t\t'                     <div class=\"buble_prop\">'+\r\n\t\t\t'                       <div><label lang=\"ca\">Valor min.</label>&nbsp;{{v.min}}<input type=\"hidden\" value=\"{{v.min}}\" name=\"min\"></div>'+\r\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida\"></div>'+\r\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_min\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\r\n\t\t\t'                     </div></td>'+\r\n\t\t\t'\t\t\t\t\t\t<td><div class=\"buble_prop\">'+\r\n\t\t\t'                        <div><label lang=\"ca\">Valor max.</label>&nbsp;{{v.max}}<input type=\"hidden\" value=\"{{v.max}}\" name=\"max\"></div>'+\r\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.sizeMax}}\" name=\"mida_max\" class=\"mida\"></div>'+\r\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_max\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \r\n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.sizeMax}}px; height: {{style.sizeMax}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radiusMax}}px\"> </div>'+\r\n\t\t\t'\t\t\t\t\t</td></tr>'+\r\n\t\t\t'                   {{/if}}'+\r\n\t\t\t'\t\t\t\t\t{{/each}}'+\r\n\t\t\t'\t\t\t\t\t</tbody>'+\r\n\t\t\t'\t\t\t\t</table>\t'+\r\n\t\t\t'\t\t\t\t</script>'+\r\n\t\t\t'\t\t\t\t<div id=\"list_tematic_values_bubble\"></div>'+\r\n\t\t\t'\t\t\t\t<div id=\"size_warning_bubble_grad\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\r\n\t\t\t'\t\t\t\t<span lang=\"ca\">Les mides han de ser creixents</span></div>'+\r\n\t\t\t'\t\t\t\t<div id=\"size_warning_bubble_prop\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\r\n\t\t\t'\t\t\t\t<span lang=\"ca\">La mida mínima ha de ser inferior a la màxima</span></div>'+\r\n\t\t\t'\t\t\t\t<div id=\"palet_warning_bubble\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\r\n\t\t\t'\t\t\t\t<span lang=\"ca\">Has de seleccionar un camp amb valors numèrics</span></div>'+\r\n\t\t\t'\t\t\t</div>'+\r\n\t\t\t'\t\t\t<div class=\"modal-footer\">'+\r\n\t\t\t'\t\t\t\t<div id=\"paletes_colors\">'+\r\n\t\t\t'\t\t\t\t\t<div lang=\"ca\">Tria el color</div>'+\r\n\t\t\t'\t\t\t\t\t<div class=\"btn-group\">'+\r\n\t\t\t'\t\t\t\t\t\t<a class=\"btn btn-mini dropdown-toggle\" data-toggle=\"dropdown\">'+\r\n\t\t\t'\t\t\t\t\t\t\t<div id=\"dv_fill_color_punt_bubble\" class=\"fill_color_punt\"></div>'+\r\n\t\t\t'\t\t\t\t\t\t</a>'+\r\n\t\t\t'\t\t\t\t\t\t<ul class=\"dropdown-menu\">'+\r\n\t\t\t'\t\t\t\t\t\t\t<li><div id=\"colorpalette_punt_bubble\"></div></li>'+\r\n\t\t\t'\t\t\t\t\t\t</ul>'+\r\n\t\t\t'\t\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\r\n\t\t    '     \t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Canviar</button>'+\r\n\t\t\t'\t\t\t</div>'+\r\n\t\t\t'\t\t</div>'+\r\n\t\t\t'\t\t<!-- /.modal-content -->'+\r\n\t\t\t'\t</div>'+\r\n\t\t\t'\t<!-- /.modal-dialog -->'+\r\n\t\t\t'</div>'+\r\n\t\t\t'<!-- /.modal -->'+\r\n\t\t\t'<!-- fi Modal Tematics Bubble -->'\r\n\t);\r\n}\r\n\r\n\r\n/*NOU MODEL VISUALITZACIO*/\r\nfunction loadVisualitzacioLayer(layer,removed){\r\n\tvar businessId;\r\n\tif (layer.businessId!=undefined){\r\n\t\tbusinessId=layer.businessId;\r\n\t}else if (layer.options.businessId!=undefined){\r\n\t\tbusinessId = layer.options.businessId;\r\n\t}\r\n\t\r\n\tvar defer = $.Deferred();\r\n\tvar data={\r\n\t\tuid : Cookies.get('uid'),\r\n\t\tbusinessId: businessId\r\n\t};\r\n\t\r\n\tgetVisualitzacioByBusinessId(data).then(function(results){\r\n\t\tif(results.status == \"OK\" ){\r\n\t\t\tif (removed){\r\n\t\t\t\tvar data ={\r\n\t\t\t\t\tbusinessId: businessId,\r\n\t\t\t\t\tuid:Cookies.get('uid')\r\n\t\t\t\t};\r\n\t\t\t\tvar resultats = results.results;\r\n\t\t\t\tgetGeometriesPropertiesLayer(data).then(function(results2){\r\n\t\t\t\t\t readVisualitzacio(defer, resultats, results2.layer);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse \r\n\t\t\t{\r\n\r\n\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\tcontrolCapes._visLayers = {};\r\n\t\t\t\t\tcontrolCapes._options = {};\r\n\t\t\t\t}\r\n\t\t\t\tcontrolCapes._visLayers[businessId] = results.results;\r\n\t\t\t\tcontrolCapes._options[businessId] = layer;\r\n\t\t\t\treadVisualitzacio(defer, results.results, layer);\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\r\n\t\t\tdefer.reject();\r\n\t\t}\r\n\t},function(results){\r\n\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\r\n\t\tdefer.reject();\r\n\t});\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction reloadVisualitzacioLayer(capaVisualitzacio, visualitzacio, layer, map){\r\n\tvar defer = $.Deferred();\r\n\t//update del options de la capa\r\n\tvar optionsVis = getOptions(visualitzacio);\r\n\tcapaVisualitzacio.options = $.extend(capaVisualitzacio.options, optionsVis);\r\n\tif(capaVisualitzacio.options.propName && jQuery.type( capaVisualitzacio.options.propName ) === \"string\"){\r\n\t\tcapaVisualitzacio.options.propName = capaVisualitzacio.options.propName.split(\",\");\r\n\t}\r\n\t\t\r\n\t//limpiar las geometrias\t\r\n\ttry{\r\n\t\tcapaVisualitzacio.clearLayers();\r\n\t}catch(err){\r\n\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.clearLayers();\r\n\t}\r\n\t//cargar las geometrias a la capa\r\n\tvar layOptions = getOptions(layer);\r\n\tvar origen = getOrigenLayer(layer);\r\n\tvar hasSource = (optionsVis && optionsVis.source!=undefined) \r\n\t|| (optionsVis.options && undefined != optionsVis.options.source)\r\n\t|| (layOptions && layOptions.source!=undefined );\r\n\ttry{\r\n\t\tcapaVisualitzacio.off('layeradd',objecteUserAdded);//Deixem desactivat event layeradd, per la capa activa\r\n\t}catch(err){\r\n\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.off('layeradd',objecteUserAdded);//Deixem desactivat event layeradd, per la capa activa\r\n\t}\r\n\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\r\n\t\r\n\ttry{\r\n\t\tcapaVisualitzacio.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\r\n\t}catch(err){\r\n\t\tif (capaVisualitzacio.layer!=undefined) \tcapaVisualitzacio.layer.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\r\n\t}\r\n\t\r\n\tdefer.resolve(capaVisualitzacio);\r\n\t\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction getOptions(visualitzacio){\r\n\tvar visOptions = visualitzacio.options;\r\n\tif(typeof (visOptions)==\"string\"){\t\r\n\t\ttry {\r\n\t\t\toptionsVis = JSON.parse(visOptions);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\toptionsVis = visOptions;\t\t\r\n\t\t}\r\n\t}else{\t\t\t\r\n\t\toptionsVis = visOptions;\t\r\n\t}\r\n\treturn optionsVis;\r\n}\r\n\r\nfunction getOrigenLayer(layer){\r\n\tvar origen = \"\",\r\n\toptions;\r\n\tif (layer.options){\r\n\t\toptions = getOptions(layer);\r\n\t\tif(options.origen){//Si es una sublayer\r\n\t\t\torigen = getLeafletIdFromBusinessId(options.origen);\r\n\t\t}\r\n\t}\r\n\treturn origen;\r\n}\r\n\r\nfunction readVisualitzacio(defer, visualitzacio, layer, geometries){\r\n\tvar layOptions; \r\n\tif(typeof (layer.options)==\"string\"){\t\r\n\t\ttry {\r\n\t\t\tlayOptions = JSON.parse(layer.options);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\tlayOptions = layer.options;\t\t\r\n\t\t}\r\n\t}else{\t\t\t\r\n\t\tlayOptions = layer.options;\t\r\n\t}\r\n\tvar hasSource = (visualitzacio.options && (visualitzacio.options.indexOf(\"source\")!=-1) ) \r\n\t\t|| (layOptions && (layOptions.toString().indexOf(\"source\")!=-1) );\r\n\tif(visualitzacio.tipus == tem_heatmap){\r\n\t\tloadVisualitzacioHeatmap(visualitzacio, layer.capesOrdre, layer.options, layer.capesActiva, defer);\r\n\t}else if(visualitzacio.tipus == tem_cluster){\r\n\t\tloadVisualitzacioCluster(visualitzacio, layer.capesOrdre, layer.options, layer.capesActiva, defer);\r\n\t}else{\r\n\t\tvar capaVisualitzacio = new L.FeatureGroup();\r\n\t\tif(layOptions && layOptions.group){\r\n\t\t\tcapaVisualitzacio.options = {\r\n\t\t\t\tbusinessId : layer.businessId,\r\n\t\t\t\tnom : layer.serverName,\r\n\t\t\t\ttipus : layer.serverType,\r\n\t\t\t\ttipusRang: visualitzacio.tipus, \r\n\t\t\t\tgeometryType: visualitzacio.geometryType,\r\n\t\t\t\testil: visualitzacio.estil,\r\n\t\t\t\tgroup: layOptions.group\r\n\t\t\t};\r\n\t\t}else{\r\n\t\t\tcapaVisualitzacio.options = {\r\n\t\t\t\tbusinessId : layer.businessId,\r\n\t\t\t\tnom : layer.serverName,\r\n\t\t\t\ttipus : layer.serverType,\r\n\t\t\t\ttipusRang: visualitzacio.tipus, \r\n\t\t\t\tgeometryType: visualitzacio.geometryType,\r\n\t\t\t\testil: visualitzacio.estil\r\n\t\t\t};\r\n\t\t}\r\n\t\t\r\n\t\tvar visOptions = visualitzacio.options;\r\n\t\tvar optionsVis = getOptions(visualitzacio);\r\n\t\t\r\n\t\tif(hasSource) {\r\n\t\t\tcapaVisualitzacio.options.source = optionsVis.source;\r\n\t\t}\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir els rangs d'estils\r\n\t\tif(visOptions && visOptions.indexOf(\"estilsRangs\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.estilsRangs = optionsVis.estilsRangs;\r\n\t\t}\r\n\r\n\t\t//Pel cas de del tematic categories, tenir els rangs d'estils\r\n\t\tif(visOptions && visOptions.indexOf(\"rangsEstilsLegend\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.rangsEstilsLegend = optionsVis.rangsEstilsLegend;\r\n\t\t}\t\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir la paleta\r\n\t\tif(visOptions && visOptions.indexOf(\"paleta\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.paleta = optionsVis.paleta;\r\n\t\t}\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir la propietat reverse\r\n\t\tif(visOptions && visOptions.indexOf(\"reverse\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.reverse = optionsVis.reverse;\r\n\t\t}\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir la propietat dataField\r\n\t\tif(visOptions && visOptions.indexOf(\"dataField\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.dataField = optionsVis.dataField;\r\n\t\t}\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir la propietat labelField\r\n\t\tif(visOptions && visOptions.indexOf(\"labelField\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.labelField = optionsVis.labelField;\r\n\t\t}\r\n\t\t\r\n\t\t//Pel cas de del tematic categories, tenir la propietat tipusClasicTematic\r\n\t\tif(visOptions && visOptions.indexOf(\"tipusClasicTematic\")!=-1) {\r\n\t\t\tcapaVisualitzacio.options.tipusClasicTematic = optionsVis.tipusClasicTematic;\r\n\t\t}\r\n\r\n\t\t//Pel cas de del tematic semafòric, tenir la propietat de l'atribut fixat\r\n\t\tif(optionsVis && optionsVis.hasOwnProperty(\"trafficLightKey\")) {\r\n\t\t\tcapaVisualitzacio.options.trafficLightKey = optionsVis.trafficLightKey;\r\n\t\t}\r\n\t\t\r\n\t\t//Per les etiquetes\r\n\t\tvar isCapaAmbEtiquetes=false;\r\n\t\tif(optionsVis && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\tisCapaAmbEtiquetes=true;\r\n\t\t\tcapaVisualitzacio.options.campEtiqueta = optionsVis.campEtiqueta;\r\n\t\t\tif(optionsVis && optionsVis.fontFamily!=undefined) capaVisualitzacio.options.fontFamily = optionsVis.fontFamily;\r\n\t\t\tif(optionsVis && optionsVis.fontSize!=undefined) capaVisualitzacio.options.fontSize = optionsVis.fontSize;\r\n\t\t\tif(optionsVis && optionsVis.fontColor!=undefined) capaVisualitzacio.options.fontColor = optionsVis.fontColor;\r\n\t\t\tif(optionsVis && optionsVis.fontStyle!=undefined) capaVisualitzacio.options.fontFamily = optionsVis.fontStyle;\r\n\t\t\tif(optionsVis && optionsVis.opcionsVis!=undefined) capaVisualitzacio.options.opcionsVisEtiqueta = optionsVis.opcionsVis;\r\n\t\t\tif(optionsVis && optionsVis.zoomInicial!=undefined) capaVisualitzacio.options.zoomInicial = optionsVis.zoomInicial;\r\n\t\t\tif(optionsVis && optionsVis.zoomFinal!=undefined) capaVisualitzacio.options.zoomFinal = optionsVis.zoomFinal;\r\n\t\t\t//Noves opcions de contorn i caixa\r\n\t\t\tif(optionsVis && optionsVis.contorn!=undefined) capaVisualitzacio.options.contorn = optionsVis.contorn;\r\n\t\t\tif(optionsVis && optionsVis.caixa!=undefined) capaVisualitzacio.options.caixa = optionsVis.caixa;\r\n\t\t\tif(optionsVis && optionsVis.caixaColor!=undefined) capaVisualitzacio.options.caixaColor = optionsVis.caixaColor;\r\n\t\t}\r\n\t\t\r\n\t\tvar origen = getOrigenLayer(layer);\r\n\t\t\r\n\t\t//ordenar los estilos de mayor a menor para los bubbles\r\n\t\tif (visualitzacio.tipus == tem_size){\r\n\t\t\tvar estilDesc = visualitzacio.estil.sort(sordDesc(\"simbolSize\"));\r\n\t\t\tvisualitzacio.estil = estilDesc;\r\n\t\t}\r\n\t\t\r\n\t\tvar isCapaActiva=false;\r\n\t\tif (!layer.capesActiva || layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\t\r\n\t\t\t//Afegim geometries a la capa\r\n\t\t\tcapaVisualitzacio.addTo(map);\r\n\t\t\t$.publish(\"addMapLayer\");\r\n\t\t\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\r\n\t\t\t\r\n\t\t\t\r\n\t\t}\t\r\n\t\telse {\r\n\t\t\t//Afegim geometries a la capa pero no la capa al mapa\r\n\t\t\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\r\n\t\t\tif (isCapaAmbEtiquetes){\r\n\t\t\t\tjQuery.each(capaVisualitzacio._layers, function(i, lay){\r\n\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\tlay.label.setOpacity(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t//Afegim num d'elements al nom de la capa, si és un fitxer\r\n\t\tif(layer.dragdrop || layer.urlFile){\r\n\t\t\tcapaVisualitzacio.options.nom = capaVisualitzacio.options.nom;// + \" (\"+capaTematic.getLayers().length+\")\";\r\n\t\t\tvar data = {\r\n\t\t\t \tbusinessId: capaVisualitzacio.options.businessId, //url('?businessid') \r\n\t\t\t \tuid: Cookies.get('uid'),\r\n\t\t\t \tserverName: capaVisualitzacio.options.nom\r\n\t\t\t };\r\n\t\t\t\t\r\n\t\t\tupdateServidorWMSName(data).then(function(results){\r\n\t\t\t\r\n\t\t\t});\t\t\t\t\t\r\n\t\t}\r\n\t\t\t\r\n\t\tif (layer.options){\r\n\t\t\tvar options2;\r\n\t\t\tif(typeof (layer.options)==\"string\"){\t\t\r\n\t\t\t\ttry {\r\n\t\t\t\t\toptions2 = JSON.parse(layer.options);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (err) {\r\n\t\t\t\t\toptions2 = layer.options;\r\n\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t}else{\t\t\t\t\r\n\t\t\t\toptions2 = layer.options;\t\r\n\t\t\t}\r\n\t\t\tif (options2.propName != undefined) {\r\n\t\t\t\tcapaVisualitzacio.options.propName = options2.propName;\r\n\t\t\t}\r\n\t\t\telse if (visualitzacio.options){\r\n\t\t\t\tvar options2;\r\n\t\t\t\tif(typeof (visualitzacio.options)==\"string\"){\t\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\toptions2 = JSON.parse(visualitzacio.options);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch (err) {\r\n\t\t\t\t\t\toptions2 = visualitzacio.options;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t}else{\t\t\t\t\r\n\t\t\t\t\toptions2 = visualitzacio.options;\t\r\n\t\t\t\t}\t\t\r\n\t\t\t\tif (options2.propName != undefined) {\r\n\t\t\t\t\tvar dataNames = options2.propName.split(',');\r\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\r\n\t\t\t\t}\t\t\r\n\t\t\t\telse if (geometries!=undefined){\r\n\t\t\t\t\tif (  geometries.options){\r\n\t\t\t\t\t\tvar dataNames = geometries.options.split(',');\r\n\t\t\t\t\t\t//console.debug(dataNames);\r\n\t\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\t\t\t\r\n\t\t}else{\r\n\t\t\tif (geometries!=undefined){\r\n\t\t\t\tif (  geometries.options){\r\n\t\t\t\t\tvar dataNames = geometries.options.split(',');\r\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (capaVisualitzacio.options.propName== undefined) {\r\n\t\t\tif (visualitzacio.estil!=undefined && visualitzacio.estil[0]!=undefined){\r\n\t\t\t\tif ( visualitzacio.estil[0].geometria!=undefined &&  visualitzacio.estil[0].geometria.features!=undefined &&\r\n\t\t\t\t\t\tvisualitzacio.estil[0].geometria.features.length>0){\r\n\t\t\t\t\t//var props = console.debug(visualitzacio.estil[0].geometria.features[0].properties);\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar props;\r\n\t\t\t\t\tif(typeof (visualitzacio.estil[0].geometria.features[0].properties)==\"string\"){\t\t\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tprops = JSON.parse(visualitzacio.estil[0].geometria.features[0].properties);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcatch (err) {\r\n\t\t\t\t\t\t\tprops = visualitzacio.estil[0].geometria.features[0].properties;\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\t\t\t\t\r\n\t\t\t\t\t\tprops = visualitzacio.estil[0].geometria.features[0].properties;\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar dataNames =\"\";\r\n\t\t\t\t\tjQuery.each(props, function( index, value ) {\r\n\t\t\t\t\t\tdataNames+=index+\",\";\t\t\t\t\t\t\r\n\t\t\t\t\t});\r\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames.substring(0,dataNames.length-1);\r\n\t\t\t\t}\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\t\tif (capaVisualitzacio.options.propName== undefined) {\r\n\t\t\tvar dataNames=[];\r\n\t\t\tdataNames[0]=\"nom\";\r\n\t\t\tdataNames[1]=\"text\";\r\n\t\t\tcapaVisualitzacio.options.propName = dataNames;\r\n\t\t}\r\n\r\n\t\tif(layer.options && origen !== \"\"){//Si es una sublayer\r\n\t\t\tcontrolCapes.addOverlay(capaVisualitzacio, capaVisualitzacio.options.nom, true, origen);\r\n\t\t}else {\r\n\t\t\tif (!layer.capesOrdre){\r\n\t\t\t\tcapaVisualitzacio.options.zIndex = controlCapes._lastZIndex + 1;\r\n\t\t\t}else{\r\n\t\t\t\tcapaVisualitzacio.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\t\t}\r\n\t\t\tcontrolCapes.addOverlay(capaVisualitzacio, capaVisualitzacio.options.nom, true);\r\n\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t}\r\n\t\t\r\n\t\t//Si la capa es tematic categories, afegir llegenda al mode edicio\r\n\t\tif ((visualitzacio.tipus == tem_clasic || visualitzacio.tipus == tem_size) && $(location).attr('href').indexOf('/mapa.html')!=-1){\r\n\t\t\tloadMapLegendEdicio(capaVisualitzacio);\r\n\t\t}\r\n\t\t\r\n\t\tdefer.resolve(capaVisualitzacio);\r\n\t}\t\t\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction loadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource){\r\n\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined){\r\n\t\tvar style = \"font-family:\"+optionsVis.fontFamily+\";font-size:\"+optionsVis.fontSize+\";color:\"+optionsVis.fontColor;\r\n\t\tif (optionsVis.contorn!=undefined && optionsVis.contorn==\"si\") {\r\n\t\t\tstyle+=\";text-shadow:1px 1px #ffffff\";\r\n\t\t}\r\n\t\telse \tstyle+=\";text-shadow:0px 0px #ffffff\";\r\n\t\tif (optionsVis.fontStyle!=undefined){\r\n\t\t\tif (optionsVis.fontStyle==\"normal\" || optionsVis.fontStyle==\"bold\") style+= \";font-weight:\"+optionsVis.fontStyle;\r\n\t\t\telse if (optionsVis.fontStyle==\"italic\") style+= \";font-style:\"+optionsVis.fontStyle;\r\n\t\t}\r\n\t\tif (optionsVis.caixa!=undefined && optionsVis.caixa==\"si\"){\r\n\t\t\tstyle += \";background-color:\"+optionsVis.caixaColor;\r\n\t\t}\r\n\t\telse style += \";background-color:transparent\";\r\n\t\tcreateClass('.etiqueta_style_'+visualitzacio.businessId,style);\r\n\t}\r\n\t\r\n\tvar zoomInicialEtiqueta = \"2\";\r\n\tif (optionsVis!=undefined && optionsVis.zoomInicial!=undefined) zoomInicialEtiqueta=optionsVis.zoomInicial;\r\n\tvar zoomFinalEtiqueta = \"19\";\r\n\tif (optionsVis!=undefined && optionsVis.zoomFinal!=undefined)  zoomFinalEtiqueta=optionsVis.zoomFinal;\r\n\r\n\tvar canSpiderify = (visualitzacio.tipus == tem_clasic || visualitzacio.tipus == tem_simple || visualitzacio.tipus == tem_origen);\r\n\tif(visualitzacio.businessId && optionsVis && optionsVis.hasOwnProperty(\"trafficLightKey\") && optionsVis.hasOwnProperty(\"trafficLightValue\"))\r\n\t{\r\n\r\n\t\t//Canviem la visualització perquè pot ser que la del servidor no estigui bé (passa quan un cop creada la capa es publica el mapa\r\n\t\t//havent canviat el valor pivot de la visualització. En el servidor només s'actualitza el valor i no la geometria associada als estils)\r\n\t\tvar sorted = Semaforic.sortGeometry(visualitzacio.estil, optionsVis.trafficLightKey, optionsVis.trafficLightValue);\r\n\r\n\t\t//Actualitzem la geometria dels estils a partir de les geometries ordenades i els colors que té el semafòric\r\n\t\tvisualitzacio.estil[0].color = optionsVis.trafficLightLowerColor;\r\n\t\tvisualitzacio.estil[1].color = optionsVis.trafficLightEqualColor;\r\n\t\tvisualitzacio.estil[2].color = optionsVis.trafficLightHigherColor;\r\n\t\tvisualitzacio.estil[0].geometria.features = sorted.lowerGeom;\r\n\t\tvisualitzacio.estil[1].geometria.features = sorted.equalGeom;\r\n\t\tvisualitzacio.estil[2].geometria.features = sorted.higherGeom;\r\n\r\n\t\t//Actualitzem el nom de la capa\r\n\t\tvisualitzacio.nom = Semaforic.getUpdatedLayerName(visualitzacio.nom, optionsVis.trafficLightValue);\r\n\t\tcapaVisualitzacio.options.nom = visualitzacio.nom;\r\n\r\n\t}\r\n\t\r\n\tvar props = [];\r\n\tvar checkNumericProperties = false;\r\n\tvar veientMapa = ($(location).attr('href').indexOf('mapa')!=-1);\r\n\tif(\"undefined\" !== typeof optionsVis && optionsVis.hasOwnProperty(\"propName\") && !capaVisualitzacio.hasOwnProperty(\"isPropertyNumeric\"))\r\n\t{\r\n\t\r\n\t\tprops = optionsVis.propName.split(',');\r\n\t\tcapaVisualitzacio.isPropertyNumeric = new Array(props.length);\r\n\t\t$.each(props, function(index, prop) {\r\n\t\t\tcapaVisualitzacio.isPropertyNumeric[prop] = true;\r\n\t\t});\r\n\t\tcheckNumericProperties = true;\r\n\r\n\t}\r\n\t\r\n\t//per cada estil de la visualitzacio\r\n\tjQuery.each(visualitzacio.estil, function(index, estil){\r\n\t\tvar geomTypeVis = visualitzacio.geometryType;\r\n\t\tvar geomStyle;\r\n\t\t\r\n\t\tif (geomTypeVis === t_marker){\r\n\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length);\r\n\t\t}else if (geomTypeVis === t_multipoint){\r\n\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length);\r\n\t\t}else if (geomTypeVis === t_polyline){\r\n\t\t\tgeomStyle = createLineStyle(estil);\r\n\t\t}else if (geomTypeVis === t_multilinestring){\r\n\t\t\tgeomStyle = createLineStyle(estil);\r\n\t\t}else if (geomTypeVis === t_polygon){\r\n\t\t\tgeomStyle = createAreaStyle(estil);\r\n\t\t}else if (geomTypeVis === t_multipolygon){\r\n\t\t\tgeomStyle = createAreaStyle(estil);\r\n\t\t}\r\n\t\t\r\n\t\t//per cada geometria d'aquell estil\r\n\t\tjQuery.each(estil.geometria.features, function(indexGeom, geom){\t\t\t\t\r\n\t\t\tvar featureTem = [];\r\n\t\t\tif (undefined != geom.geometry){\r\n\t\t\tvar geomType = (geom.geometry.type?geom.geometry.type.toLowerCase():geomTypeVis);\r\n\r\n\t\t\t//Actualitzem el vector de propietats de tipus numèrics de la visualització\r\n\t\t\t//Els que són falsos en algun feature ja no cal repassar-los, els eliminem del \r\n\t\t\t//vector de propietats a comprovar\r\n\t\t\t\r\n\t\t\tif(checkNumericProperties)\r\n\t\t\t{\r\n\r\n\t\t\t\t//Actualitzem el vector de propietats de tipus numèrics de la visualització\r\n\t\t\t\t//Els que són falsos en algun feature ja no cal repassar-los, els eliminem del \r\n\t\t\t\t//vector de propietats a comprovar\r\n\t\t\t\tvar toRemove = [];\r\n\t\t\t\t$.each(props, function(index, prop) {\r\n\t\t\t\t\tcapaVisualitzacio.isPropertyNumeric[prop] = capaVisualitzacio.isPropertyNumeric[prop] && $.isNumeric(geom.properties[prop]);\r\n\t\t\t\t\tif(!capaVisualitzacio.isPropertyNumeric[prop])\r\n\t\t\t\t\t\ttoRemove.push(index);\r\n\t\t\t\t});\r\n\t\t\t\tfor(var i=toRemove.length-1; i>=0; i--)\r\n\t\t\t\t\tprops.splice(toRemove[i], 1);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t//MultyPoint\r\n\t\t\tif (geomTypeVis === t_marker && geomType === t_multipoint){\r\n\t\t\t\t//TODO revisar que funcione\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\r\n\t\t\t\t\tvar c=coords[i];\r\n\t\t\t\t\tif(!geomStyle.isCanvas){\r\n\t\t\t\t\t\tfeatureTem.push(new L.marker([c[1], c[0]],\r\n\t\t\t\t\t\t\t{icon: geomStyle, isCanvas:false, tipus: t_marker}));\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tfeatureTem.push(new L.circleMarker([c[1], c[0]],geomStyle));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t//Punt\r\n\t\t\t}else if (geomTypeVis === t_marker || geomType === \"point\"){\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tif(!geomStyle.isCanvas){\r\n\t\t\t\t\tvar marker=new L.marker([coords[1],coords[0]],{icon: geomStyle, isCanvas:false,tipus: t_marker});\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\r\n\t\t\t\t\t\tmarker.setOpacity(0);\r\n\t\t\t\t\t}\t\t\t\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && \r\n\t\t\t\t\t\t\t\t(optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\") && origen==\"\"){\r\n\t\t\t\t\t\t\t\tmarker.bindLabel(geom.properties[optionsVis.campEtiqueta],\r\n\t\t\t\t\t\t\t\t{opacity:1, noHide: true, clickable:true, direction: 'center',className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0]});\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\r\n\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\r\n\t\t\t\t\t\t\tif (marker.label!=undefined) marker.label.setOpacity(0);\r\n\t\t\t\t\t\t\telse marker.hideLabel();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfeatureTem.push(marker);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar markerCircle=new L.circleMarker([coords[1],coords[0]],geomStyle);\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\r\n\t\t\t\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length,0);\r\n\t\t\t\t\t\tmarkerCircle=new L.circleMarker([coords[1],coords[0]],geomStyle);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && \r\n\t\t\t\t\t\t\t\t(optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\") && origen==\"\"){\r\n\t\t\t\t\t\t\tmarkerCircle.bindLabel(geom.properties[optionsVis.campEtiqueta],\r\n\t\t\t\t\t\t\t\t{opacity:1, noHide: true,clickable:true,  direction: 'altre',className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0]});\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\r\n\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\r\n\t\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\t\tif (markerCircle.label!=undefined) markerCircle.label.setOpacity(0);\r\n\t\t\t\t\t\t\t\t\telse markerCircle.hideLabel();\r\n\t\t\t\t\t\t\t\t}catch(err){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfeatureTem.push(markerCircle);\r\n\t\t\t\t}\r\n\t\t\t//MultiPoint\r\n\t\t\t}else if (geomTypeVis === t_polyline && geomType === t_multilinestring){\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tvar llistaLines=[];\r\n\t\t\t\tvar llistaLines2=[];\r\n\t\t\t\t\r\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\r\n\t\t\t\t\tvar lines=coords[i];\r\n\t\t\t\t\tvar llistaPunts=[];\r\n\t\t\t\t\tvar myPolyline = new L.polyline(llistaPunts,geomStyle);\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\r\n\t\t\t\t\t\tvar c=lines[k];\r\n\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\r\n\t\t\t\t\t\tmyPolyline.addLatLng(punt);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfeatureTem.push(myPolyline);\r\n\t\t\t\t}\r\n\r\n\t\t\t//multiLine\r\n\t\t\t}else if (geomTypeVis === t_polyline){\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tvar llistaPunts=[];\r\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\r\n\t\t\t\t\tvar c=coords[i];\r\n\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\r\n\t\t\t\t\tllistaPunts.push(punt);\r\n\t\t\t\t}\r\n\t\t\t\tvar polyline= (new L.polyline(llistaPunts, geomStyle));\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\r\n\t\t\t\t\tgeomStyle = createLineStyle(estil,0);\r\n\t\t\t\t\tpolyline= (new L.polyline(llistaPunts, geomStyle));\r\n\t\t\t\t}\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\r\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\r\n\t\t\t\t\t\t\t\tpolyline.bindLabelEx(map,geom.properties[optionsVis.campEtiqueta], \r\n\t\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId ,offset: [0, 0]});\r\n\t\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\r\n\t\t\t\t\t\t\t\tpolyline.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\r\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\r\n\t\t\t\t\t\t\t\tpolyline.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfeatureTem.push(polyline);\r\n\t\t\t//multiPolygon\r\n\t\t\t}else if(geomTypeVis === t_polygon && geomType === t_multipolygon){\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tvar llistaPoligons=[];\r\n\t\t\t\tfor (var p = 0; p < coords.length; p++){\r\n\t\t\t\t\tvar poligons=coords[p];\r\n\t\t\t\t\tvar llistaLines=[];\r\n\t\t\t\t\tfor (var i = 0; i < poligons.length; i++){\r\n\t\t\t\t\t\tvar lines=poligons[i];\r\n\t\t\t\t\t\tvar llistaPunts=[];\r\n\t\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\r\n\t\t\t\t\t\t\tvar c=lines[k];\r\n\t\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\r\n\t\t\t\t\t\t\tllistaPunts.push(punt);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tllistaLines.push(llistaPunts);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tllistaPoligons.push(llistaLines);\r\n\t\t\t\t}\r\n\t\t\t\tvar multipolygon = new L.multiPolygon(llistaPoligons, geomStyle);\r\n\t\t\t\tmultipolygon._options = jQuery.extend({}, multipolygon._options);\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\r\n\t\t\t\t\tgeomStyle = createAreaStyle(estil,0);\r\n\t\t\t\t\tmultipolygon = new L.multiPolygon(llistaLines, geomStyle);\r\n\t\t\t\t}\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\r\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\r\n\t\t\t\t\t\t\t\tmultipolygon.bindLabelExPolygon(map,geom.properties[optionsVis.campEtiqueta], \r\n\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0] });\r\n\t\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\r\n\t\t\t\t\t\t\t\tmultipolygon.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\r\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\r\n\t\t\t\t\t\t\t\tmultipolygon.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfeatureTem.push(multipolygon);\r\n\t\t\t//polygon\r\n\t\t\t}else if (geomTypeVis === t_polygon){\r\n\t\t\t\tvar coords=geom.geometry.coordinates;\r\n\t\t\t\tvar llistaLines=[];\r\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\r\n\t\t\t\t\tvar lines=coords[i];\r\n\t\t\t\t\tvar llistaPunts=[];\r\n\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\r\n\t\t\t\t\t\tvar c=lines[k];\r\n\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\r\n\t\t\t\t\t\tllistaPunts.push(punt);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tllistaLines.push(llistaPunts);\r\n\t\t\t\t}\r\n\t\t\t\tvar polygon = new L.Polygon(llistaLines, geomStyle);\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\r\n\t\t\t\t\tgeomStyle = createAreaStyle(estil,0);\r\n\t\t\t\t\tpolygon = new L.Polygon(llistaLines, geomStyle);\r\n\t\t\t\t}\r\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\r\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\r\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\r\n\t\t\t\t\t\t\t\tpolygon.bindLabelExPolygon(map,geom.properties[optionsVis.campEtiqueta], \r\n\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0] });\r\n\t\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\r\n\t\t\t\t\t\t\t\tpolygon.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\r\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\r\n\t\t\t\t\t\t\t\tpolygon.hideLabel();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfeatureTem.push(polygon);\r\n\t\t\t}\r\n\t\t\tjQuery.each(featureTem, function(index, feat){\r\n\t\t\t\tfeat.properties = {};\r\n\t\t\t\tfeat.properties.businessId = geom.businessId;\r\n\t\t\t\tfeat.properties.data = geom.properties;\r\n\t\t\t\tfeat.properties.estil = estil;\r\n\t\t\t\tfeat.properties.capaLeafletId = capaVisualitzacio._leaflet_id;\r\n\t\t\t\tfeat.properties.capaNom = capaVisualitzacio.options.nom;\r\n\t\t\t\tfeat.properties.capaBusinessId = capaVisualitzacio.options.businessId;\r\n\t\t\t\tfeat.properties.tipusFeature = geomTypeVis;\r\n\t\t\t\t//Cal??\r\n\t\t\t\tif (feat.options){\r\n\t\t\t\t\tfeat.options.tipus = geomTypeVis;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfeat.options = {tipus: geomTypeVis};\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tfeat.properties.feature = {};\r\n\t\t\t\tfeat.properties.feature.geometry = geom.geometry;\r\n\t\t\t\ttry{\r\n\t\t\t\t\tcapaVisualitzacio.addLayer(feat);\r\n\t\t\t\t}catch(err){\r\n\t\t\t\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.addLayer(feat);\r\n\t\t\t\t}\r\n\t\t\t\r\n\t\t\t\tif(geomTypeVis == t_polygon){\r\n\t\t\t\t\tfeat.properties.mida = calculateArea(feat);\r\n\t\t\t\t}else if(geomTypeVis == t_polyline){\r\n\t\t\t\t\tfeat.properties.mida = calculateDistance(feat.getLatLngs());\r\n\t\t\t\t}\r\n\t\t\t\telse if(geomTypeVis == t_marker && map.hasOwnProperty(\"oms\") && canSpiderify ) {\r\n\t\t\t\t\tmap.oms.addMarker(feat);\r\n\t\t\t\t}\r\n\t\t\t\r\n\t\t\t\tif(!geom.hasOwnProperty(\"popupData\"))\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\t//Si la capa no ve de fitxer\r\n\t\t\t\t\tvar html;\r\n\t\t\t\t\tif(!hasSource){\r\n\t\t\t\t\t\t//\"no te source, no ve de fitxer\");\r\n\t\t\t\t\t\tif(veientMapa && ((capaVisualitzacio.options.tipusRang == tem_origen) || !capaVisualitzacio.options.tipusRang) ){\r\n\t\t\t\t\t\t\thtml = createPopupWindow(feat,geomTypeVis);\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t//\"Estem mode vis i no es tem origen:\"\r\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, false, origen, capaVisualitzacio);\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t//\"Te source, ve de fitxer\";\r\n\t\t\t\t\t\tif(veientMapa && capaVisualitzacio.options.tipusRang == tem_origen){\r\n\t\t\t\t\t\t\t//\"Estem mode mapa i es tem origen\"\r\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, true, origen, capaVisualitzacio);\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t//\"Estem mode vis i no es tem origen:\"\r\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, false, origen, capaVisualitzacio);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tgeom.popupData = html;\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tfeat.bindPopup(geom.popupData, {'offset':[0,-25]});\r\n\r\n\t\t\t\t}\r\n\t\t\t\t/*try{\r\n\t\t\t\t\tif (geomTypeVis===t_marker || geomTypeVis===t_multipoint){\r\n\t\t\t\t\t\tfeat.snapediting = new L.Handler.MarkerSnap(map, feat,{snapDistance:10});\r\n\t\t\t\t\t\tfeat.dragging.disable(); \r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfeat.snapediting = new L.Handler.PolylineSnap(map, feat,{snapDistance:10});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tguideLayers.push(feat);\r\n\t\t\t\t}catch(err){\r\n\t\t\t\t\t\r\n\t\t\t\t}*/\r\n\t\t\t\tmap.closePopup();\t\t\t\t\t\r\n\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t});\t\r\n\t//FIN EACH\r\n}\r\n\r\n/**Funcions per crear un objecte de tipus estil, amb les característiques que li passes\r\n * per punt, línia, poligon */\r\n\r\nfunction createMarkerStyle(style, num_geometries,opacity){\r\n\t//console.debug(\"createFeatureMarkerStyle\");\r\n\tif (!num_geometries){\r\n\t\tnum_geometries = num_max_pintxos - 1;\r\n\t}\r\n\tif (style.marker && num_geometries <= num_max_pintxos){\r\n\t\t//Especifiques per cercle amb glyphon\r\n\t\tif(style.marker == 'punt_r'){\r\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_circuloglyphon_style);\r\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\r\n\t\t\tpuntTMP.options.icon = style.simbol;\r\n\t\t\tpuntTMP.options.markerColor = style.marker;\r\n\t\t\tpuntTMP.options.isCanvas=false;\r\n\t\t\tpuntTMP.options.divColor= style.color;\r\n\t\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\r\n\t\t\tpuntTMP.options.radius = style.radius;\r\n\t\t\tvar anchor = style.iconAnchor.split(\"#\");\r\n\t\t\tvar size = style.iconSize.split(\"#\");\r\n\t\t\tpuntTMP.options.iconAnchor.x = parseInt(anchor[0]);\r\n\t\t\tpuntTMP.options.iconAnchor.y = parseInt(anchor[1]);\r\n\t\t\tpuntTMP.options.iconSize.x = size[0];\r\n\t\t\tpuntTMP.options.iconSize.y = size[1];\r\n\t\t}else{\r\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_marker_style);\r\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\r\n\t\t\tpuntTMP.options.icon = style.simbol;\r\n\t\t\tpuntTMP.options.markerColor = style.marker;\r\n\t\t\tpuntTMP.options.isCanvas=false;\r\n\t\t\tpuntTMP.options.iconAnchor.x = 14;\r\n\t\t\tpuntTMP.options.iconAnchor.y = 42;\r\n\t\t\tpuntTMP.options.iconSize.x = 28;\r\n\t\t\tpuntTMP.options.iconSize.y = 42;\r\n\t\t}\r\n\t}else{ //solo circulo\r\n\t\tvar fillOpacity=style.opacity/100;\r\n\t\tvar opacitat=1;\r\n\t\tif (opacity!=undefined) {\r\n\t\t\tfillOpacity=opacity;\r\n\t\t\topacitat=0;\r\n\t\t}\r\n\t\t\r\n\t\tvar puntTMP = { \r\n\t\t\tradius: style.simbolSize, \r\n\t\t\tisCanvas: true,\r\n\t\t\tfillColor: style.color,\r\n\t\t\tcolor:  style.borderColor,\r\n\t\t\tweight:  style.borderWidth,\r\n\t\t\tfillOpacity: fillOpacity,\r\n\t\t\topacity: opacitat,\r\n\t\t\ttipus: t_marker\r\n\t\t};\r\n\t}\r\n\treturn puntTMP;\r\n}\r\n\r\nfunction createLineStyle(style,opacity){\r\n\tvar estilTMP = default_line_style;\r\n\testilTMP.color=style.color;\r\n\testilTMP.weight=style.lineWidth;\r\n\testilTMP.tipus=t_polyline;\r\n\tif (opacity!=undefined) {\r\n\t\testilTMP.fillOpacity=opacity;\r\n\t\testilTMP.opacity=opacity;\r\n\t}\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction createAreaStyle(style,opacity){\r\n\t\r\n\tvar estilTMP= default_area_style;\r\n\tvar opacitat=style.opacity/100;\r\n\tif (opacity!=undefined) {\r\n\t\topacitat=opacity;\r\n\t\testilTMP.opacity=opacity;\r\n\t}\r\n\testilTMP.fillColor=style.color;\r\n\testilTMP.fillOpacity=opacitat;\r\n\testilTMP.weight=style.borderWidth;\r\n\testilTMP.color=style.borderColor;\r\n\testilTMP.tipus=t_polygon;\r\n\treturn estilTMP;\r\n}\r\n\r\nfunction loadCacheVisualitzacioLayer(layer){\r\n\tvar defer = $.Deferred();\r\n\tvar data={\r\n\t\tbusinessId: layer.businessId,\r\n\t\tuid: layer.entitatUid\r\n\t};\r\n\t\r\n\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\r\n\t{\r\n\t\r\n\t\tcontrolCapes._visLayers = {};\r\n\t\tcontrolCapes._options = {};\r\n\t}\r\n\r\n\t$.get(HOST_APP+'capesuser/'+data.uid+'/'+data.businessId+'.json', function(results) { \r\n\t\tif(results){\r\n\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\r\n\t\t\tcontrolCapes._options[data.businessId] = layer;\r\n\t\t\treadVisualitzacio(defer, results.results, layer);\t\t\t\r\n\t\t}else{\t\t\t\t\r\n\t\t\tgetCacheVisualitzacioLayerByBusinessId(data).then(function(results){\r\n\t\t\t\tif(results.status == \"OK\" ){\r\n\t\t\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\r\n\t\t\t\t\tcontrolCapes._options[data.businessId] = layer;\r\n\t\t\t\t\treadVisualitzacio(defer, results.results, layer);\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\r\n\t\t\t\t\tdefer.reject();\t\r\n\t\t\t\t}\t\r\n\t\t\t});\r\n\t\t}\t\t\r\n\t}).fail(function() {\r\n\t   getCacheVisualitzacioLayerByBusinessId(data).then(function(results){\r\n\t\t\tif(results.status == \"OK\" ){\r\n\t\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\r\n\t\t\t\tcontrolCapes._options[data.businessId] = layer;\r\n\t\t\t\treadVisualitzacio(defer, results.results, layer);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\r\n\t\t\t\tdefer.reject();\t\r\n\t\t\t}\t\r\n\t\t});\r\n\t  });\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction sordDesc(property) {\r\n    var sortOrder = 1;\r\n    if(property[0] === \"-\") {\r\n        sortOrder = -1;\r\n        property = property.substr(1);\r\n    }\r\n    return function (a,b) {\r\n        var result = (a[property] > b[property]) ? -1 : (a[property] < b[property]) ? 1 : 0;\r\n        return result * sortOrder;\r\n    }\r\n}\r\nfunction escapeSpecialChars(jsonString) {\r\n\tvar myJSONString = JSON.stringify(jsonString);\r\n\tvar myEscapedJSONString = myJSONString.replace(/\\n/g, \"\\\\n\");\r\n\t//console.debug(myEscapedJSONString);\r\n\treturn myEscapedJSONString;\r\n  }\r\n\r\nfunction actualitzacioTematic(layerMare,businessIdCapaMare,fId,feature,features,tipusModificacio) {\r\n\t//console.debug(layerMare);\r\n\tvar isClasicTematic=false;\r\n\tif (layerMare!=undefined) {\r\n\t\tjQuery.each(layerMare._layers, function(i, sublayer){\r\n\t\t\t//console.debug(sublayer);\r\n\t\t\tif(jQuery.type(sublayer.layer.options)== \"string\"){\r\n\t\t\t\t\tsublayer.layer.options = $.parseJSON(sublayer.layer.options);\r\n\t\t\t}\t            \t  \r\n\t\t\t//Sublayer visualitzacio, carrego la capa\r\n\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\r\n\t\t\t\t//if (sublayer.layer.options.tipusRang==\"simpleTematic\"){\t\t\r\n\t\t\t\t\tif (tipusModificacio==\"alta\" || tipusModificacio==\"modificacio\"){\r\n\t\t\t\t\t\tif (sublayer.layer.options.tipusRang!=\"clusterTematic\" && sublayer.layer.options.tipusRang!=\"heatmapTematic\"){\r\n\t\t\t\t\t\t\tif (sublayer.layer.options.tipusRang==\"clasicTematic\"){\r\n\t\t\t\t\t\t\t\tvar dataRemove = {\r\n\t\t\t\t\t\t\t\t\t\tbusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\t\t\tservidorWMSbusinessId:sublayer.layer.options.businessId.toString()\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tremoveLayerFromMap(dataRemove,sublayer);\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tvar props;\r\n\t\t\t\t\t\t\t\tif (layerMare.layer.options.propName!=undefined) props = layerMare.layer.options.propName.toString();\r\n\t\t\t\t\t\t\t\telse props='[\"nom\",\"text\"]';\r\n\t\t\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\t\t\tbusinessid: businessIdCapaMare,\r\n\t\t\t\t\t\t\t\t\t\tfrom:\"clasicTematic\",\r\n\t\t\t\t\t\t\t\t\t\tgeometrytype:layerMare.layer.options.geometryType,\r\n\t\t\t\t\t\t\t\t\t\tleafletid:layerMare.layer._leaflet_id,\r\n\t\t\t\t\t\t\t\t\t\tpropname:props,\r\n\t\t\t\t\t\t\t\t\t\ttipus:layerMare.layer.options.tipus\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tbusy=true;\r\n\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\tcreateTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\t\r\n\t\t\t\t\t\t\t\t//Eliminem la capa de controlCapes\r\n\t\t\t\t\t\t\t\tcontrolCapes.removeLayer(sublayer);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tvar rangsJSON2 = getFeatureStyle2(sublayer.layer.options.estil[0],sublayer.layer.options.geometryType);\r\n\t\t\t\t\t\t\t\tif (features==null){\r\n\t\t\t\t\t\t\t\t\tfeatures = {\r\n\t\t\t\t\t\t\t\t\t\t\ttype:feature.layer.options.tipus,\r\n\t\t\t\t\t\t\t\t\t\t\tid:fId,\r\n\t\t\t\t\t\t\t\t\t\t\tproperties: feature.properties.data,\r\n\t\t\t\t\t\t\t\t\t\t\testil: rangsJSON2,\r\n\t\t\t\t\t\t\t\t\t\t\tgeometry: feature.geometry\r\n\t\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\tfeatures = JSON.stringify(features);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\t\t\tbusinessId: sublayer.layer.options.businessId,//f.layer.properties.capaBusinessId,//Bid de la visualitzacio\r\n\t\t\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\t\t\tfeatures: features,\r\n\t\t\t\t\t\t\t\t\t\testilBusinessId: sublayer.layer.options.estil[0].businessId\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\taddGeometriaToVisualitzacioTematic(data).then(function(results) {\r\n\t\t\t\t\t\t\t\t\t\tif(results.status === 'OK'){\r\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.serverName = sublayer.layer.options.nom;\r\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.serverType = sublayer.layer.options.tipus;\r\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.capesActiva = \"true\";\r\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.options.origen = businessIdCapaMare;\t\r\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t//eliminem sublayer del mapa, i recarreguem\r\n\t\t\t\t\t\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\r\n\t\t\t\t\t\t\t\t\t\t\tloadVisualitzacioLayer(sublayer.layer);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tsublayer.layer.serverName = sublayer.layer.options.nom;\r\n\t\t\t\t\t\t\tsublayer.layer.serverType = sublayer.layer.options.tipus;\r\n\t\t\t\t\t\t\tsublayer.layer.capesActiva = \"true\";\r\n\t\t\t\t\t\t\tsublayer.layer.options.origen = businessIdCapaMare;\t\r\n\t\t\t\t\t\t\tsublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\r\n\t\t\t\t\t\t\t//eliminem sublayer del mapa, i recarreguem\r\n\t\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\r\n\t\t\t\t\t\t\tloadVisualitzacioLayer(sublayer.layer);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (tipusModificacio==\"baixa\"){\r\n\t\t\t\t\t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\r\n\t\t\t\t  \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\r\n\t\t\t\t  \t\t  sublayer.layer.capesActiva = \"true\";\r\n\t\t\t\t  \t\t  sublayer.layer.options.origen =businessIdCapaMare;//layer.properties.capaBusinessId;//BusinessIdCapaorigen\r\n\t\t\t\t  \t\t  //tipusRang\r\n\t\t\t\t  \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\r\n\t\t\t\t  \t\t  //console.debug(sublayer);\r\n\t\t\t\t  \t\t  //eliminem sublayer del mapa, i recarreguem\r\n\t\t\t\t  \t\t  map.closePopup();\r\n\t\t\t\t  \t\t  map.removeLayer(sublayer.layer);\r\n\t\t\t\t  \t\t  controlCapes.removeLayer(sublayer);\r\n\t\t\t\t  \t\t  loadVisualitzacioLayer(sublayer.layer);\r\n\t\t\t\t  \t\t  \r\n\t\t\t\t  \t\t  \r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (tipusModificacio==\"modificacioInfo\"){\r\n\t\t\t\t\t\t//Modificació informació d'una geometria - cal refer el temàtic.\r\n\t\t\t\t\t\tvar dataRemove = {\r\n\t\t\t\t\t\t\t\tbusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\tservidorWMSbusinessId:lbusinessId.toString()\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\tremoveLayerFromMap(dataRemove,sublayer);\r\n\t\t\t\t\t\tif (sublayer.layer.options.tipusRang==\"clasicTematic\"){\r\n\t\t\t\t\t\t\tvar props;\r\n\t\t\t\t\t\t\tif (layerMare.layer.options.propName!=undefined) props = layerMare.layer.options.propName.toString();\r\n\t\t\t\t\t\t\telse props='[\"nom\",\"text\"]';\r\n\t\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\t\tbusinessid: businessIdCapaMare,\r\n\t\t\t\t\t\t\t\t\tfrom:\"clasicTematic\",\r\n\t\t\t\t\t\t\t\t\tgeometrytype:layerMare.layer.options.geometryType,\r\n\t\t\t\t\t\t\t\t\tleafletid:layerMare.layer._leaflet_id,\r\n\t\t\t\t\t\t\t\t\tpropname:props,\r\n\t\t\t\t\t\t\t\t\ttipus:layerMare.layer.options.tipus\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\tbusy=true;\r\n\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\tcreateTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t//}\r\n\t\t\t}\r\n\t\t });\r\n\t}\r\n\t\r\n}\r\n\r\nfunction removeLayerFromMap(data,obj){\r\n\tremoveServerToMap(data).then(function(results){\r\n\t\tif(results.status==='OK'){\r\n\r\n\r\n\t\t\tmap.removeLayer(obj.layer);\r\n\t\t\t//Eliminem la capa de controlCapes\r\n\t\t\tcontrolCapes.removeLayer(obj);\r\n\t\t\t//Esborrem la llegenda de la capa eliminada\r\n\t\t\temptyMapLegendEdicio(obj.layer);\r\n\t\t\t//actualitzem valors zindex de la resta si no es sublayer\r\n\t\t\tif(!obj.sublayer){\r\n\t\t\t\tvar removeZIndex = obj.layer.options.zIndex;\r\n\t\t\t\tcontrolCapes._lastZIndex--;\r\n\t\t\t\tvar aux = controlCapes._layers;\r\n\t\t\t\tfor (var i in aux) {\r\n\t\t\t\t\tif (aux[i].layer.options.zIndex > removeZIndex) aux[i].layer.options.zIndex--;\r\n\t\t\t\t}\r\n\t\t\t\t//Eliminem les seves sublayers en cas que tingui\r\n\t\t\t\tfor(indexSublayer in obj._layers){\r\n\t\t\t\t\tmap.removeLayer(map._layers[indexSublayer]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//Actualitzem capaUsrActiva\r\n\t\t\tif(capaUsrActiva!=null && capaUsrActiva.options.businessId == obj.layer.options.businessId){\r\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\r\n\t\t\t\tcapaUsrActiva = null;\r\n\t\t\t}\r\n\r\n\t\t\tdeleteServerRemoved(data).then(function(results){\r\n\t\t\t\t//se borran del listado de servidores\r\n\t\t\t});\r\n\r\n\t\t\t\r\n\r\n\r\n\t\t}else{\r\n\t\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\r\n\t\t}\r\n\t});\r\n}\r\n\r\n\r\n","/**\r\n * \r\n */\r\nfunction createURLfileLayer(urlFile, tipusFile, epsgIN, dinamic, nomCapa, colX, colY, tipusAcc, tipusFont, tipusCodi, nomCampCodi){\r\n\t//Estil defecte\r\n\tvar estil_do = retornaEstilaDO(t_url_file);\r\n\tvar estil_lin_pol = estil_do;\r\n\r\n\t//Recuperem estils de la barra d'eines\r\n\tvar lineStyle = getLineRangFromStyle(canvas_linia);\r\n\tlineStyle.weight = lineStyle.lineWidth;\r\n\r\n\tvar polygonStyle = getPolygonRangFromStyle(canvas_pol);\r\n\tpolygonStyle.weight = polygonStyle.borderWidth;//lineWidth;\r\n\tpolygonStyle.fillColor = polygonStyle.color;\r\n\tpolygonStyle.color = polygonStyle.borderColor;\r\n\tpolygonStyle.fillOpacity = polygonStyle.opacity/100; \r\n\tpolygonStyle.opacity = 1;\r\n\r\n\tvar markerStyle = getMarkerRangFromStyle(defaultPunt);\r\n\r\n\tif(markerStyle.isCanvas){\r\n\t\testil_do.color = markerStyle.borderColor;\r\n\t\testil_do.fillColor = markerStyle.color;\r\n\t\testil_do.fillOpacity = 1;\r\n\t\testil_do.opacity = 1;\r\n\t\testil_do.radius = markerStyle.simbolSize;\r\n\t\testil_do.weight = markerStyle.borderWidth;\r\n\t}else{\r\n\t\testil_do.fillColor = getColorAwesomeMarker(markerStyle.marker, markerStyle.color);\r\n\t}\r\n\r\n\t/***Parseig url en cas google drive****/\r\n\t//https://drive.google.com/file/d/FILE_ID/edit?usp=sharing\r\n\t//https://drive.google.com/uc?export=download&id=FILE_ID\r\n\r\n\tif(urlFile.indexOf(\"https://drive.google.com/file/d/\")!=-1){\r\n\t\turlFile = urlFile.replace(\"https://drive.google.com/file/d/\", \"\");\r\n\t\tvar res = urlFile.split(\"/\");\r\n\t\tvar fileId = res[0];\r\n\t\turlFile = \"https://drive.google.com/uc?export=download&id=\"+fileId;\r\n\t}\r\n\telse if(urlFile.indexOf(\"https://www.dropbox.com\")!=-1){\r\n\t\turlFile = urlFile.replace(\"https://www.dropbox.com\", \"https://dl.dropboxusercontent.com\");\t\t\r\n\t}\r\n\r\n\t/*** DINAMIC ***/\r\n\tif(dinamic){\r\n\t\tbusy = false;\r\n\t\tvar propName = \"\";\r\n\t\tvar param_url = paramUrl.urlFileDin\t+\"tipusFile=\" + tipusFile+\r\n\t\t\"&tipusAcc=\"+tipusAcc+\r\n\t\t\"&tipusCodi=\"+tipusCodi+\r\n\t\t\"&tipusFont=\"+tipusFont+\r\n\t\t\"&nomCampCodi=\"+nomCampCodi+\r\n\t\t\"&urlFile=\"+encodeURIComponent(urlFile)+\r\n\t\t\"&epsgIN=\"+epsgIN+\r\n\t\t\"&dinamic=\"+dinamic+\r\n\t\t\"&uploadFile=\"+paramUrl.uploadFile+\r\n\t\t\"&colX=\"+colX+\r\n\t\t\"&colY=\"+colY+\r\n\t\t\"&uid=\"+Cookies.get('uid');\t\t\r\n\t\t\r\n\t\tif ((urlFile.indexOf(\"socrata\")>-1 || urlFile.indexOf(\"https\")>-1) && (urlFile.indexOf(\"drive\")==-1)\r\n\t\t\t\t&& (urlFile.indexOf(\"dropbox\")==-1)) \t{\r\n\t\t\tparam_url = urlFile;\r\n\t\t}\r\n\r\n\t\t$('#dialog_dades_ex').modal('hide');\r\n\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\tjQuery(\"#div_uploading_txt\").html('<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\"> '+\r\n\t\t\t\twindow.lang.translate('Carregant dades')+\r\n\t\t'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>');\t\t\r\n\t\tjQuery('#info_uploadFile').show();\r\n\r\n\t\tvar capaURLfile = new L.GeoJSON.AJAX(param_url, {\r\n\t\t\tnom : nomCapa,\r\n\t\t\ttipus : t_url_file,\r\n\t\t\testil_do: estil_do,\r\n\t\t\tstyle: estil_lin_pol,//Estil de poligons i linies\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\tpropName = \"\";\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tpropName = propName+key+\",\";\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t\tpropName = propName.substr(0, propName.length-1);\r\n\t\t\t\thtml+='</div></div>'; \r\n\t\t\t\treturn geom.bindPopup(html);\r\n\t\t\t},\r\n\t\t\tonEachFeature : function(feature, latlng) {\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\tpropName = \"\";\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tpropName = propName+key+\",\";\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t\tpropName = propName.substr(0, propName.length-1);\r\n\t\t\t\thtml+='</div></div>'; \r\n\t\t\t\treturn latlng.bindPopup(html);\r\n\t\t\t},\t\t\t  \r\n\t\t\tmiddleware:function(data){\r\n\t\t\t\tif(data.status && data.status.indexOf(\"ERROR\")!=-1){\r\n\t\t\t\t\tprocessFileError(data, urlFile);\r\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar stringData = JSON.stringify(data);\r\n\t\t\t\t\tvar geometryType = defineGeometryType(stringData);\r\n\r\n\t\t\t\t\tif(geometryType.indexOf(\"point\")!=-1){\r\n\t\t\t\t\t\tcapaURLfile.options.style = estil_do;\r\n\t\t\t\t\t}else if(geometryType.indexOf(\"line\")!=-1){\r\n\t\t\t\t\t\tcapaURLfile.options.style = lineStyle;\r\n\t\t\t\t\t}else if(geometryType.indexOf(\"polygon\")!=-1){\r\n\t\t\t\t\t\tcapaURLfile.options.style = polygonStyle;\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tcapaURLfile.addData(data);\r\n\t\t\t\t\t}catch(err){\r\n\t\t\t\t\t\tconsole.debug(err);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar llista_options = '{\"tipusFile\":\"'+tipusFile+\r\n\t\t\t\t\t'\",\"nom\":\"'+nomCapa+\r\n\t\t\t\t\t'\",\"propName\":\"'+propName+\r\n\t\t\t\t\t'\",\"url\":\"'+urlFile+\r\n\t\t\t\t\t'\",\"tipus\":\"'+t_url_file+\r\n\t\t\t\t\t'\",\"epsgIN\":\"'+epsgIN+\r\n\t\t\t\t\t'\", \"geometryType\":\"'+geometryType+\r\n\t\t\t\t\t'\",\"colX\":\"'+colX+\r\n\t\t\t\t\t'\",\"colY\":\"'+colY+\r\n\t\t\t\t\t'\", \"dinamic\":\"'+dinamic+\r\n\t\t\t\t\t'\", \"tipusAcc\":\"'+tipusAcc+\r\n\t\t\t\t\t'\", \"tipusCodi\":\"'+tipusCodi+\r\n\t\t\t\t\t'\", \"tipusFont\":\"'+tipusFont+\r\n\t\t\t\t\t'\", \"nomCampCodi\":\"'+nomCampCodi+\r\n\t\t\t\t\t'\", \"style\":'+JSON.stringify(capaURLfile.options.style)+\r\n\t\t\t\t\t',\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}';\r\n\r\n\t\t\t\t\t//Un cop tinc la capa a client, la creo a servidor\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\tserverName: nomCapa,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\r\n\t\t\t\t\t\tserverType: t_url_file,\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t\t\tactivas: true,\r\n\t\t\t\t\t\tvisibilitats: true,\r\n\t\t\t\t\t\torder: controlCapes._lastZIndex+1,\r\n\t\t\t\t\t\tepsg: '4326',\r\n\t\t\t\t\t\timgFormat: 'image/png',\r\n\t\t\t\t\t\tinfFormat: 'text/html',\r\n\t\t\t\t\t\ttiles: true,\t            \r\n\t\t\t\t\t\ttransparency: true,\r\n\t\t\t\t\t\topacity: 1,\r\n\t\t\t\t\t\tvisibilitat: 'O',\r\n\t\t\t\t\t\turl: urlFile,//Provar jQuery(\"#txt_URLJSON\")\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t\t\tactivas: true,\r\n\t\t\t\t\t\tvisibilitats: true,\r\n\t\t\t\t\t\toptions: llista_options\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques', urlFile, 1]});\r\n\r\n\t\t\t\t\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\tcapaURLfile.options.businessId = results.results.businessId;\r\n\t\t\t\t\t\t\tcapaURLfile.options.nom = nomCapa;\r\n\t\t\t\t\t\t\tcapaURLfile.options.tipus = t_url_file;\r\n\t\t\t\t\t\t\tcapaURLfile.options.url = urlFile;\r\n\t\t\t\t\t\t\tcapaURLfile.options.epsgIN = epsgIN;\r\n\t\t\t\t\t\t\tcapaURLfile.options.tipusFile = tipusFile;\r\n\t\t\t\t\t\t\tcapaURLfile.options.options = jQuery.parseJSON('{\"tipusFile\":\"'+tipusFile+'\"}');\r\n\t\t\t\t\t\t\tcapaURLfile.options.options.estil_do = estil_do;\r\n\t\t\t\t\t\t\tcapaURLfile.options.geometryType = geometryType;\r\n\t\t\t\t\t\t\tcapaURLfile.options.colX = colX;\r\n\t\t\t\t\t\t\tcapaURLfile.options.colY = colY;\r\n\t\t\t\t\t\t\tcapaURLfile.options.dinamic = dinamic;\r\n\t\t\t\t\t\t\tcapaURLfile.options.propName = propName;\r\n\t\t\t\t\t\t\tcapaURLfile.options.tipusAcc = tipusAcc;\r\n\t\t\t\t\t\t\tcapaURLfile.options.tipusCodi = tipusCodi;\r\n\t\t\t\t\t\t\tcapaURLfile.options.tipusFont = tipusFont;\r\n\t\t\t\t\t\t\tcapaURLfile.options.nomCampCodi = nomCampCodi;\r\n\r\n\t\t\t\t\t\t\tcapaURLfile.addTo(map);\r\n\t\t\t\t\t\t\tcapaURLfile.options.zIndex = controlCapes._lastZIndex+1; \r\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(capaURLfile, nomCapa, true);\r\n\t\t\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\t\r\n\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.debug(\"1.Error a createServidorInMap:\"+results.status);\r\n\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error createServidorInMap1', urlFile, 1]});\r\n\t\t\t\t\t\t\tvar txt_error = window.lang.translate(\"Error durant la càrrega de dades. Torni a intentar-ho\");\r\n\t\t\t\t\t\t\tjQuery(\"#div_url_file_message\").html(txt_error);\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\tconsole.debug(\"2.Error a createServidorInMap:\"+results.status);\r\n\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error createServidorInMap2', urlFile, 1]});\r\n\t\t\t\t\t\tvar txt_error = window.lang.translate(\"Error durant la càrrega de dades. Torni a intentar-ho\");\r\n\t\t\t\t\t\tjQuery(\"#div_url_file_message\").html(txt_error);\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\t\t\r\n\r\n\t/*** NO DINAMICA ***/\t\t\r\n\t}else{\r\n\t\t//console.debug(\"getUrlFile PROVES NO DINAMICA\");\r\n\t\tvar codiUnic = getCodiUnic();\r\n\t\tif ((urlFile.indexOf(\"socrata\")>-1 || urlFile.indexOf(\"https\")>-1) && (urlFile.indexOf(\"drive\")==-1)\r\n\t\t\t\t&& (urlFile.indexOf(\"dropbox\")==-1)) {\r\n\t\t\tvar response = $.ajax({ type: \"GET\",   \r\n\t            url: urlFile,   \r\n\t            async: false\r\n\t          }).responseText;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar dataSocrata={\r\n\t\t\t\t\tserverName: nomCapa,\r\n\t\t\t\t\tjsonSocrata: response\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tcrearFitxerSocrata(dataSocrata).then(function(results){\r\n\t\t\t\tif (results.status=\"OK\"){\r\n\t\t\t\t\turlFile =results.filePath;\r\n\t\t\t\t\tvar midaFitxer = results.midaFitxer;\r\n\t\t\t\t\tvar tmpFilePath = results.tmpFilePath;\r\n\t\t\t\t\tvar tmpFileName = results.tmpFileName;\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar data2 = {\r\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\tserverName:nomCapa,\r\n\t\t\t\t\t\t\tpath:urlFile,\r\n\t\t\t\t\t\t\ttmpFilePath:tmpFilePath,\r\n\t\t\t\t\t\t\tmidaFitxer:midaFitxer,\r\n\t\t\t\t\t\t\tsourceExtension:'geojson',\r\n\t\t\t\t\t\t\tmarkerStyle: JSON.stringify(getMarkerRangFromStyle(defaultPunt)),\r\n\t\t\t\t\t\t\tlineStyle: JSON.stringify(getLineRangFromStyle(canvas_linia)),\r\n\t\t\t\t\t\t\tpolygonStyle: JSON.stringify(getPolygonRangFromStyle(canvas_pol))\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t$('#dialog_dades_ex').modal('hide');\r\n\r\n\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Descarregant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>'+\r\n\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'</div>'+\r\n\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\r\n\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t\t\t);\t\t\t\t\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').show();\t\t\t\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').show();\t\t\r\n\r\n\t\t\t\t\t\tvar pollTime = 2000;\r\n\r\n\t\t\t\t\t\t//Fem polling\r\n\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tpoll = function(){\r\n\t\t\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ tmpFileName,\r\n\t\t\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS2\")!=-1){\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"PAS3\")!=-1){\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_current\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1){\r\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_check\" lang=\"ca\">3. '+window.lang.translate('Geometries creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_current\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t//$.get(HOST_APP+tmpdirPolling +codiUnic + url('?businessid')+\"_response.json\", function(data) { \r\n\t\t\t\t\t\t\t\t\t\t\t//if(data.status.indexOf(\"OK\")!=-1){\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t//addDropFileToMap(data);\r\n\t\t\t\t\t\t\t\t\t\t\t\t//\t\t}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t//});\r\n\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlFile, 1]});\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1){\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(\"Error al carregar fitxer:\");\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\t\t\tbusy = false;\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tif(data.codi){\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error '+data.codi, urlFile, 1]});\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Exception durant el tractament del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la càrrega del fitxer.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: Error durant les conversions de format del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[02]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: OGRInfo ha donat resposta fallida\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[03]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: Accedeix a fileDefault_Error, no li ha arribat be el nom del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[06]: \" + window.lang.translate(\"Problema de comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: EnviaFileReady a myUtils.jsp ha donat una excepcio\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[07]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Mida de fitxer supera els 50MB permesos per dades externes dinamiques\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[08]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes no dinàmiques (50MB).\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error sense codi', urlFile, 1]});\r\n\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error en la càrrega de l'arxiu\"));\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\t\t\tpoll();\r\n\t\t\t\t\t\t\t},pollTime);\r\n\r\n\t\t\t\t\t\t})();\t\t\r\n\r\n\t\t\t\t\t\tdoUploadFile(data2).then(function(results){\r\n\t\t\t\t\t\t\taddDropFileToMap(results);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t});\r\n\t\t}\r\n\t\telse {\r\n\t\t\tvar data = {\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\tserverName: nomCapa,\r\n\t\t\t\t\ttipusFile: tipusFile,\r\n\t\t\t\t\turlFile: urlFile,\r\n\t\t\t\t\tepsgIN: epsgIN,\r\n\t\t\t\t\tdinamic: dinamic,\r\n\t\t\t\t\tuploadFile: paramUrl.uploadFile,\r\n\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\tcolX: colX,\r\n\t\t\t\t\tcolY: colY,\r\n\t\t\t\t\ttipusAcc: tipusAcc,\r\n\t\t\t\t\ttipusFont: tipusFont,\r\n\t\t\t\t\ttipusCodi: tipusCodi,\r\n\t\t\t\t\tnomCampCodi: nomCampCodi,\r\n\t\t\t\t\tcodiUnic: codiUnic,\r\n\t\t\t\t\tmarkerStyle: JSON.stringify(getMarkerRangFromStyle(defaultPunt)),\r\n\t\t\t\t\tlineStyle: JSON.stringify(getLineRangFromStyle(canvas_linia)),\r\n\t\t\t\t\tpolygonStyle: JSON.stringify(getPolygonRangFromStyle(canvas_pol))\r\n\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t$('#dialog_dades_ex').modal('hide');\r\n\r\n\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Descarregant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>'+\r\n\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'</div>'+\r\n\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\r\n\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t);\t\t\t\t\r\n\t\t\t\tjQuery('#info_uploadFile').show();\t\t\t\r\n\t\t\t\tjQuery('#info_uploadFile').show();\t\t\r\n\r\n\t\t\t\tvar pollTime = 2000;\r\n\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpoll = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ codiUnic + url('?businessid')+\".json\",\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS2\")!=-1){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"PAS3\")!=-1){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_current\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_check\" lang=\"ca\">3. '+window.lang.translate('Geometries creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_current\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'//+\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$.get(HOST_APP+tmpdirPolling +codiUnic + url('?businessid')+\"_response.json\", function(data) { \r\n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"OK\")!=-1){\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taddDropFileToMap(data);\r\n\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlFile, 1]});\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error al carregar fitxer:\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\r\n\t\t\t\t\t\t\t\t\tif(data.codi){\r\n\r\n\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error '+data.codi, urlFile, 1]});\r\n\r\n\t\t\t\t\t\t\t\t\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Exception durant el tractament del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la càrrega del fitxer.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: Error durant les conversions de format del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[02]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: OGRInfo ha donat resposta fallida\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[03]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: Accedeix a fileDefault_Error, no li ha arribat be el nom del fitxer\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[06]: \" + window.lang.translate(\"Problema de comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: EnviaFileReady a myUtils.jsp ha donat una excepcio\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[07]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Mida de fitxer supera els 50MB permesos per dades externes dinamiques\r\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[08]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes no dinàmiques (50MB).\");\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error sense codi', urlFile, 1]});\r\n\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error en la càrrega de l'arxiu\"));\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpoll();\r\n\t\t\t\t\t},pollTime);\r\n\r\n\t\t\t\t})();\t\t\r\n\r\n\t\t\t\tgetUrlFileNoDin(data);\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t}\r\n}\r\n\r\nfunction processFileError(data, urlFile){\r\n\r\n\tif(data.codi){\r\n\r\n\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error '+data.codi, urlFile, 1]});\r\n\t\tvar txt_error=\"\";\r\n\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Erro al descarregar el fitxer zip (download_zip_file)\r\n\t\t\ttxt_error = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la descàrrega del fitxer.\");\r\n\r\n\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: EnviaFileReadyCodiDin a myUtils.jsp ha donat una excepcio\r\n\t\t\ttxt_error = \"[02]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\r\n\r\n\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: Error de conversio del fitxer\r\n\t\t\ttxt_error = \"[03]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\r\n\t\t\ttxt_error = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\r\n\t\t\ttxt_error = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: OGRInfo ha donat resposta fallida\r\n\t\t\ttxt_error = \"[06]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: Num maxim de punts excedit\r\n\t\t\ttxt_error = \"[07]: \" + window.lang.translate(\"El número de punts supera el màxim permès. Redueixi a 10000 o menys i torni a intentar-ho\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Num maxim de linies/poligons exedit\r\n\t\t\ttxt_error = \"[08]: \" + window.lang.translate(\"El número total de geometries supera el màxim permès. Redueixi a 6000 o menys i torni a intentar-ho.\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\r\n\t\t}else if(data.codi.indexOf(\"09\")!=-1){//cas 09: Mida de fitxer supera els 25MB permesos per dades externes dinamiques\r\n\t\t\ttxt_error = \"[09]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes dinàmiques (25MB).\");\r\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\r\n\t\t}\t\t\t\r\n\r\n\t}else{\r\n\t\tif(data.results && (data.results.indexOf(\"EXCEPTION1\")  != -1))\r\n\t\t\ttxt_error = window.lang.translate(\"No s'ha trobat el fitxer: \") + \"<a href=\\\"\" + urlFile + \"\\\" target=_blank>\" + urlFile + \"</a>\";\r\n\t\telse\r\n\t\t\ttxt_error = window.lang.translate(\"Error durant el tractament de les dades\");\r\n\t}\r\n\r\n\t/*\r\n\tif(data.results.indexOf(\"CONVERT ERROR\")!= -1){\r\n\t\tvar txt_error = window.lang.translate(\"Error de conversió: format o EPSG incorrectes\");\r\n\t}else if(data.results.indexOf(\"501\")!= -1){//+ de 5000 punts\r\n\t\ttxt_error += \": \"+window.lang.translate(\"El número de punts supera el màxim permès. Redueixi a 10000 o menys i torni a intentar-ho\");\r\n\t}else if(data.results.indexOf(\"502\")!= -1){//+ de 1000 features\r\n\t\ttxt_error += \": \"+window.lang.translate(\"El número de línies/polígons supera el màxim permès. Redueixi a 2000 o menys i torni a intentar-ho\");\r\n\t}else if(data.results.indexOf(\"503\")!= -1){//+ de 6000 geometries\r\n\t\ttxt_error += \": \"+window.lang.translate(\"El número total de geometries supera el màxim permès. Redueixi a 6000 o menys i torni a intentar-ho\");\r\n\t}*/\r\n\r\n\t//$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error', data.results, 1]});\r\n\t$('#dialog_error_upload_txt').html(txt_error);\r\n\t$('#dialog_error_upload').modal('show');\r\n}\r\n\r\nfunction loadURLfileLayer(layer){\r\n\r\n\tvar defer = $.Deferred();\r\n\r\n\tvar options;\r\n\tif(typeof (layer.options)==\"string\"){\r\n\t\ttry {\r\n\t\t\toptions = JSON.parse(layer.options);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\toptions = layer.options;\t\r\n\t\t}\r\n\t}else{\r\n\t\toptions = layer.options;\t\r\n\t}\r\n\t\r\n\t//Variables comunes para todos los casos\r\n\tvar style = options.style;\r\n\tvar tipusFile = options.tipusFile;\r\n\tvar geometryType = options.geometryType;\r\n\tvar epsgIN = options.epsgIN;\r\n\tvar colX = options.colX;\r\n\tvar colY = options.colY;\r\n\tvar urlFile = layer.url;\r\n\tvar dinamic = options.dinamic;\r\n\t\r\n\tvar estil_do = options.estil_do;\r\n\tif(options.tem == tem_heatmap){\r\n\t\testil_do = retornaEstilaDO(t_url_file); //TODO revisar si se puede quitar esto\r\n\t}\r\n\t\r\n\tvar param_url = paramUrl.urlFileDin +  \"tipusFile=\" + tipusFile+\r\n\t\t\"&colX=\"+colX+\r\n\t\t\"&colY=\"+colY+\r\n\t\t\"&epsgIN=\"+epsgIN+\r\n\t\t\"&dinamic=\"+dinamic+\r\n\t\t\"&urlFile=\"+encodeURIComponent(urlFile)+\r\n\t\t\"&uploadFile=\"+paramUrl.uploadFile;\r\n\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) { \r\n\t\t\tparam_url +=\"&uid=\"+_UsrID;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tparam_url +=\"&uid=\"+Cookies.get('uid');\t\r\n\t\t}\r\n\t\r\n\tvar capaURLfileLoad;\r\n\t/**\r\n\t * ORIGEN O TEMATIC SIMPLE\r\n\t */\t\r\n\tif(options.tem == null || options.tem == tem_simple){\r\n\t\tvar tipusAcc = options.tipusAcc;\r\n\t\tvar tipusCodi = options.tipusCodi;\r\n\t\tvar tipusFont = options.tipusFont;\r\n\t\tvar nomCampCodi = options.nomCampCodi;\r\n\r\n\t\toptions.nom = layer.serverName;\r\n\t\toptions.businessId = layer.businessId;\r\n\r\n\t\tparam_url += \"&tipusAcc=\"+tipusAcc+\r\n\t\t\t\"&tipusCodi=\"+tipusCodi+\r\n\t\t\t\"&tipusFont=\"+tipusFont+\r\n\t\t\t\"&nomCampCodi=\"+nomCampCodi;\r\n\r\n\t\t//SOCRATA\t\t\r\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\r\n\t\t\r\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\r\n\t\t\tnom : layer.serverName,\r\n\t\t\ttipus : layer.serverType,\r\n\t\t\tgeometryType: geometryType,\r\n\t\t\tbusinessId : layer.businessId,\r\n\t\t\tstyle: style,\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t\thtml+='</div></div>';    \t\r\n\t\t\t\tvar popup = L.popup().setContent(html);\r\n\t\t\t\treturn geom.bindPopup(popup);\r\n\t\t\t},\r\n\t\t\tonEachFeature : function(feature, latlng) {\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\t\r\n\t\t\t\thtml+='</div></div>';\r\n\t\t\t\treturn latlng.bindPopup(html);\r\n\t\t\t}\r\n\t\t});\t\r\n\t}\t\r\n\t/**\r\n\t * TEMATIC CLASIC O MIDES\r\n\t */\t\r\n\telse if(options.tem == tem_clasic || options.tem == tem_size){\r\n\t\tvar tipusAcc = options.tipusAcc;\r\n\t\tvar tipusCodi = options.tipusCodi;\r\n\t\tvar tipusFont = options.tipusFont;\r\n\t\tvar nomCampCodi = options.nomCampCodi;\t\t\r\n\r\n\t\toptions.nom = layer.serverName;\r\n\t\toptions.businessId = layer.businessId;\r\n\r\n\t\tparam_url += \"&tipusAcc=\"+tipusAcc+\r\n\t\t\t\"&tipusCodi=\"+tipusCodi+\r\n\t\t\t\"&tipusFont=\"+tipusFont+\r\n\t\t\t\"&nomCampCodi=\"+nomCampCodi;\r\n\r\n\t\t//SOCRATA\t\t\r\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\r\n\t\t\r\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\r\n\t\t\tnom : layer.serverName,\r\n\t\t\ttipus : layer.serverType,\r\n\t\t\tgeometryType: geometryType,\r\n\t\t\tbusinessId : layer.businessId,\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar dataFieldValue = \"\";\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(key.toLowerCase()==estil_do.dataField) dataFieldValue = value;\r\n\t\t\t\t});\t\r\n\t\t\t\thtml+='</div></div>';    \t\r\n\r\n\t\t\t\tvar estilGeom; //ficat default point style????\r\n\t\t\t\t$.each( estil_do.estils, function( index, estil ) {\r\n\t\t\t\t\tif((estil.valueMax == estil.ValueMin && dataFieldValue == estil.valueMax) || //rang unic\r\n\t\t\t\t\t\t\t(dataFieldValue>=estil.valueMin && dataFieldValue<=estil.valueMax)){//per valors\r\n\t\t\t\t\t\testilGeom = { radius : estil.estil.simbolSize, fillColor : estil.estil.color, color : \"#ffffff\", weight : 2, opacity : 1, fillOpacity : 0.8, isCanvas: true };\r\n\t\t\t\t\t\treturn false;\t\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\t\t\t\tvar geom = L.circleMarker(latlng, estilGeom);\t\t    \t\r\n\t\t\t\tvar popup = L.popup().setContent(html);\r\n\t\t\t\treturn geom.bindPopup(popup);\r\n\t\t\t},\r\n\t\t\tonEachFeature : function(feature, latlng) {\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar dataFieldValue = \"\";\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(key.toLowerCase()==estil_do.dataField) dataFieldValue = value;\r\n\t\t\t\t});\t\r\n\t\t\t\thtml+='</div></div>'; \r\n\t\t\t\t$.each( estil_do.estils, function( index, estil ) {\r\n\t\t\t\t\tif((estil.valueMax == estil.valueMin && dataFieldValue == estil.valueMax) || //rang unic\r\n\t\t\t\t\t\t\t(parseFloat(dataFieldValue)>=parseFloat(estil.valueMin) && parseFloat(dataFieldValue)<=parseFloat(estil.valueMax))){//per valors\t\r\n\r\n\t\t\t\t\t\tif(latlng.feature.geometry.type.toLowerCase() == t_polygon ){\t\t\r\n\t\t\t\t\t\t\tlatlng.setStyle({\r\n\t\t\t\t\t\t\t\tweight: 2,\r\n\t\t\t\t\t\t\t\tfillColor: estil.estil.color,\r\n\t\t\t\t\t\t\t\tcolor: estil.estil.borderColor,\r\n\t\t\t\t\t\t\t\tfillOpacity: 0.5,\r\n\t\t\t\t\t\t\t\topacity: 1\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}else if(latlng.feature.geometry.type.toLowerCase().indexOf(t_polyline)!=-1 \r\n\t\t\t\t\t\t\t\t|| latlng.feature.geometry.type.toLowerCase().indexOf(t_linestring)!=-1){\r\n\t\t\t\t\t\t\tlatlng.setStyle({\r\n\t\t\t\t\t\t\t\tweight: 2,\r\n\t\t\t\t\t\t\t\tcolor: estil.estil.color,\r\n\t\t\t\t\t\t\t\tfillOpacity: 1,\r\n\t\t\t\t\t\t\t\topacity: 1\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}else if(latlng.feature.geometry.type.toLowerCase() == t_multipolygon ){\r\n\t\t\t\t\t\t\tlatlng.setStyle({\r\n\t\t\t\t\t\t\t\tweight: 2,\r\n\t\t\t\t\t\t\t\tfillColor: estil.estil.color,\r\n\t\t\t\t\t\t\t\tcolor: estil.estil.borderColor,\r\n\t\t\t\t\t\t\t\tfillOpacity: 0.5,\r\n\t\t\t\t\t\t\t\topacity: 1\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn false;\t\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t\treturn latlng.bindPopup(html);\r\n\t\t\t}\r\n\t\t});\t\r\n\t}\t\r\n\t/**\r\n\t * TEMATIC CLUSTER\r\n\t */\t\r\n\telse if(options.tem == tem_cluster){\r\n\t\tparam_url += \"&tem=\"+tem_cluster;\t\r\n\t\t//SOCRATA\t\t\r\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\r\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\r\n\t\t\tnom : layer.serverName,\r\n\t\t\ttipus : layer.serverType,\r\n\t\t\tgeometryType: geometryType,\r\n\t\t\testil_do: estil_do,\r\n\t\t\tbusinessId : layer.businessId,\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\t\r\n\t\t\t\thtml+='</div></div>';    \t\r\n\t\t\t\tvar popup = L.popup().setContent(html);\r\n\t\t\t\treturn geom.bindPopup(popup);\r\n\t\t\t},\r\n\t\t\tonEachFeature : function(feature, latlng) {\r\n\t\t\t\tvar pp = feature.properties;\r\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\t\t$.each( pp, function( key, value ) {\r\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\t\r\n\t\t\t\thtml+='</div></div>';\r\n\t\t\t\treturn latlng.bindPopup(html);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t/**\r\n\t * TEMATIC HEATMAP\r\n\t */\r\n\telse if(options.tem == tem_heatmap){\r\n\t\t\t\t\r\n\t\tparam_url += \"&tem=\"+tem_heatmap;\t\r\n\t\t//SOCRATA\t\t\r\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\r\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\r\n\t\t\tnom : layer.serverName,\r\n\t\t\ttipus : layer.serverType,\r\n\t\t\tgeometryType: geometryType,\r\n\t\t\testil_do: estil_do,\r\n\t\t\tbusinessId : layer.businessId,\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\r\n\t\t\t\tvar popup = L.popup().setContent(\"\");\r\n\t\t\t\treturn geom.bindPopup(popup);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t\r\n\tcapaURLfileLoad.on('data:loaded', function(e){\r\n\t\tvar self = this;\r\n\t\t\r\n\t\tif(options.tem == null || options.tem == tem_simple){\r\n\t\t\tself.options = options;\r\n\t\t\taddLayerUrlToMap(self, layer, controlCapes, options.origen, map);\r\n\t\t}else if(options.tem == tem_clasic || options.tem == tem_size){\r\n\t\t\tself.options = options;\r\n\t\t\taddLayerUrlToMap(self, layer, controlCapes, options.origen, map);\r\n\t\t\tif ($(location).attr('href').indexOf('/mapa.html')!=-1){\r\n\t\t\t\tloadMapLegendEdicioDinamics(self);\r\n\t\t\t}\r\n\t\t}else if(options.tem == tem_cluster){\r\n\t\t\tvar clusterLayer = L.markerClusterGroup({\r\n\t\t\t\tsingleMarkerMode : true\r\n\t\t\t});\r\n\t\t\tself.eachLayer(function(layer) {\r\n\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t\t});\r\n\t\t\t\tmarker.bindPopup(layer._popup._content);\r\n\t\t\t\tclusterLayer.addLayer(marker);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tclusterLayer.options.businessId = layer.businessId;\r\n\t\t\tclusterLayer.options.nom = layer.serverName;\r\n\t\t\tclusterLayer.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\t\tclusterLayer.options.tipus = layer.serverType;\r\n\t\t\tclusterLayer.options.dataset = options.dataset;\r\n\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\t\t\tif(self.error){\r\n\t\t\t\tclusterLayer.error = true;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\taddLayerUrlToMap(clusterLayer, layer, controlCapes, options.origen, map);\r\n\t\t\t\r\n\t\t}else if(options.tem == tem_heatmap){\r\n\t\t\tvar arrP=[];\r\n\t\t\tself.options = options;\r\n\t\t\tself.eachLayer(function(layer){\r\n\t\t\t\tvar d = [layer.getLatLng().lat,layer.getLatLng().lng,1];\t\r\n\t\t\t\tarrP.push(d);\t\r\n\t\t\t});\r\n\r\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{\r\n\t\t\t\tradius:20,\r\n\t\t\t\tblur:15,\r\n\t\t\t\tmax:1,\r\n\t\t\t\tgradient: {\t\t\t\r\n\t\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t\t1: \"#720404\"\r\n\t\t\t\t}\t\r\n\t\t\t});\r\n\r\n\t\t\theatLayerActiu.options.businessId = layer.businessId;\r\n\t\t\theatLayerActiu.options.nom = layer.serverName;\r\n\t\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\t\theatLayerActiu.options.tipus = layer.serverType;\r\n\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\tif(self.error){\r\n\t\t\t\theatLayerActiu.error = true;\r\n\t\t\t}\r\n\t\t\taddLayerUrlToMap(heatLayerActiu, layer, controlCapes, options.origen, map);\t\r\n\t\t}\r\n\t\t\r\n\t\tdefer.resolve();\r\n\t});\r\n\t\t\r\n\tcapaURLfileLoad.on('data:progress', function (e) {\r\n\t\tif (e.error) {\r\n\t\t\t// handle error\r\n\t\t\tvar self = this;\r\n\t\t\tself.error = true;\r\n\t\t\tdefer.reject(e.error);\r\n\t\t}\r\n\t});\r\n\t\t\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction addLayerUrlToMap(capaURLfileLoad, layer, controlCapes, origen, map){\r\n\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\tcapaURLfileLoad.addTo(map);\r\n\t}\r\n\r\n\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\r\n\t\tcapaURLfileLoad.options.zIndex = controlCapes._lastZIndex + 1;\r\n\t}else if(layer.capesOrdre != capesOrdre_sublayer){\r\n\t\tcapaURLfileLoad.options.zIndex = parseInt(layer.capesOrdre);\r\n\t}\t\t\r\n\r\n\tif(!origen){\r\n\t\tcapaURLfileLoad.options.businessId = layer.businessId;\r\n\t\tcontrolCapes.addOverlay(capaURLfileLoad, layer.serverName, true);\r\n\t\tcontrolCapes._lastZIndex++;\t\r\n\t}else{//Si te origen es una sublayer\r\n\t\tvar origenL = getLeafletIdFromBusinessId(origen);\r\n\t\tcapaURLfileLoad.options.zIndex = capesOrdre_sublayer;\r\n\t\tcontrolCapes.addOverlay(capaURLfileLoad, layer.serverName, true, origenL);\r\n\t}\r\n}\r\n\r\nfunction constructLayer(layer, estil_do){\r\n\tlayer.eachLayer(function(marker) {\r\n\t\tvar geometryType = transformTipusGeometry(marker.feature.geometry.type);\r\n\t\tif(geometryType == t_marker){\r\n\t\t\tvar geom = L.circleMarker(marker._latlng, estil_do);\r\n\t\t}else if(geometryType == t_polyline){\r\n\t\t\tvar geom = L.polyline(marker._latlngs, {color: estil_do.fillColor, weight: \"3\", opacity: \"1\"});\r\n\t\t}else if(geometryType == t_polygon){\r\n\t\t\tvar geom = L.polygon(marker._latlngs, {color: estil_do.color, fillColor: estil_do.fillColor, fillOpacity: estil_do.fillOpacity, weight: estil_do.weight});\r\n\t\t}\r\n\t\tvar pp = marker.toGeoJSON().properties;\r\n\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t$.each( pp, function( key, value ) {\r\n\t\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\r\n\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t}\r\n\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\t\t\r\n\t\thtml+='</div></div>';    \t\r\n\t\tgeom.bindPopup(html);\r\n\t\tlayer.removeLayer(marker);\r\n\t\tlayer.addLayer(geom);\r\n\t});\r\n}\r\n\r\nfunction loadURLfileLayer2(layer) {\r\n\tvar defer = $.Deferred();\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tvar tipusFile = options.tipusFile;\r\n\tvar estil_do = options.estil_do;\r\n\tvar urlFile = layer.url;\r\n\r\n\tif(tipusFile == t_file_geojson){\r\n\t\tvar capaURLfile = omnivore.geojson(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_topojson){\r\n\t\tvar capaURLfile = omnivore.topojson(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_wkt){\r\n\t\tvar capaURLfile = omnivore.wkt(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_wkt){\r\n\t\tvar capaURLfile = omnivore.wkt(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_kml){\r\n\t\tvar capaURLfile = omnivore.kml(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_gpx){\r\n\t\tvar capaURLfile = omnivore.gpx(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}else if(tipusFile == t_file_csv){\r\n\t\tvar capaURLfile = omnivore.csv(urlFile, null, L.FeatureGroup())\r\n\t\t.on('ready', function() {\r\n\t\t\tconstructLayer(this, estil_do);\r\n\t\t})\r\n\t\t.on('error', function() {\r\n\t\t\tconsole.debug(\"Error omnivore\");\r\n\t\t})\r\n\t\t.addTo(map);\t\t\t\t\t\r\n\t}\r\n\r\n\tcapaURLfile.options.businessId = layer.businessId;\r\n\tcapaURLfile.options.nom = layer.serverName;\r\n\tcapaURLfile.options.tipus = t_url_file;\r\n\tcapaURLfile.options.url = urlFile;\r\n\tcapaURLfile.options.options = jQuery.parseJSON('{\"tipusFile\":\"'+tipusFile+'\"}');\r\n\tcapaURLfile.options.options.estil_do = estil_do;\r\n\tcapaURLfile.options.zIndex = controlCapes._lastZIndex+1; \r\n\tcontrolCapes.addOverlay(capaURLfile, layer.serverName, true);\r\n\tcontrolCapes._lastZIndex++;\r\n\tactivaPanelCapes(true);\t\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction defineGeometryType(data){\r\n\tif(data.indexOf(\"Point\")!=-1){\r\n\t\treturn t_point;\r\n\t}else if(data.indexOf(\"Line\")!=-1){\r\n\t\treturn t_linestring;\r\n\t}else if(data.indexOf(\"Polygon\")!=-1){\r\n\t\treturn t_polygon;\r\n\t}\r\n}\r\n\r\nfunction loadUrlFileHeatmapLayer(layer){\r\n\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tvar style = options.style;\r\n\tvar tipusFile = options.tipusFile;\r\n\tvar geometryType = options.geometryType;\r\n\tvar epsgIN = options.epsgIN;\r\n\tvar colX = options.colX;\r\n\tvar colY = options.colY;\r\n\tvar urlFile = layer.url;\r\n\tvar dinamic = options.dinamic;\r\n\tvar param_url = paramUrl.urlFileDin + \"tipusFile=\" + tipusFile+\"&colX=\"+colX+\"&colY=\"+colY+\"&epsgIN=\"+epsgIN+\"&dinamic=\"+dinamic+\"&urlFile=\"+encodeURIComponent(urlFile);\t\r\n\r\n\tvar capaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\r\n\t\tnom : layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tgeometryType: geometryType,\r\n\t\testil_do: estil_do,\r\n\t\tstyle: style,\r\n\t\tbusinessId : layer.businessId,\r\n\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\tvar geom = L.circleMarker(latlng, estil_do);\r\n\t\t}\r\n\t});\t\t\r\n\r\n\tcapaURLfileLoad.on('data:loaded', function(e){\r\n\r\n\t\tvar arrP=[];\r\n\t\tcapaURLfileLoad.eachLayer(function(layer){\r\n\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\r\n\t\t\tarrP.push(d);\t\t\t\r\n\t\t});\r\n\r\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\t\tgradient: {\t\t\t\r\n\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t1: \"#720404\"\r\n\t\t\t}\t\r\n\t\t});\r\n\r\n\t\theatLayerActiu.options.businessId = layer.businessId;\r\n\t\theatLayerActiu.options.nom = layer.serverName;\r\n\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\theatLayerActiu.options.tipus = layer.serverType;\r\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\r\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t}\r\n\r\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\r\n\t\tactivaPanelCapes(true);\t\t\r\n\t});\r\n\r\n}\r\n\r\n","/**\r\n * \r\n */\r\n\r\nfunction loadVisualitzacioWmsLayer(layer){\r\n\t\r\n//\tconsole.debug(\"loadVisualitzacioWmsLayer\");\r\n//\tconsole.debug(layer);\r\n\t\r\n\tvar jsonOptions;\t\r\n\t\r\n\tif(typeof (layer.options)==\"string\"){\r\n\t\ttry {\r\n\t\t\tjsonOptions = JSON.parse(layer.options);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\tjsonOptions = layer.options;\t\r\n\t\t}\r\n\t}else{\r\n\t\t\r\n\t\tjsonOptions = layer.options;\t\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\tvar optionsWMS = {\r\n\t        layers : layer.businessId,\r\n\t        crs : L.CRS.EPSG3857,\r\n\t        transparent : true,\r\n\t        format : layer.imgFormat,//'image/png'\r\n\t    \tversion: layer.version,\r\n\t    \ttileSize:512,\r\n\t       opacity: layer.opacity,\t    \r\n\t    \tnom : layer.serverName,\r\n\t    \ttipus: layer.serverType,\r\n\t    \tzIndex :  parseInt(layer.capesOrdre),\r\n\t    \tgroup: jsonOptions.group,\r\n\t    \tbusinessId: layer.businessId\t        \t\r\n\t}\r\n\tvar wmsLayer = new L.tileLayer.betterWms(layer.url, optionsWMS);\r\n\r\n\tvar optionsUtfGrid = {\r\n            layers : layer.businessId,\r\n            crs : L.CRS.EPSG4326,\r\n            srs: \"EPSG:4326\",\r\n            transparent : true,\r\n            format : 'utfgrid',\r\n            nom : layer.serverName + \" utfgrid\",\r\n\t    \ttipus: layer.serverType,\r\n\t    \tgroup: jsonOptions.group,\r\n\t    \t//zIndex :  parseInt(layer.capesOrdre),\t    \r\n\t    \tbusinessId: layer.businessId            \r\n\t}\r\n\tvar utfGridLayer = createUtfGridLayer(layer.url,optionsUtfGrid);\r\n\t\r\n//\tvar utfGrid = new L.UtfGrid(layer.url,optionsUtfGrid);\r\n\t//Mostrar informacio\r\n\t/*\r\n\tutfGrid.on('mouseover', function (e) {});\r\n\tutfGrid.on('mouseout', function (e) {});\r\n\r\n\tutfGrid.on('click', function (e) {\r\n\t\tif (e.data!=null){\r\n\t\t\tconsole.debug(e.data);\r\n\t\t\t\r\n\t\t\tjQuery('#bt_info_geojsonvt_close').on('click', function (e) {\r\n//\t\t\t\ttancaFinestra();\r\n\t\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html('');\r\n\t\t\t\tjQuery('#info_geojsonvt').hide();\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tvar html ='';\r\n\t\t\thtml+='<div class=\"popup_pres\">';\r\n\t\t\t$.each( e.data, function( key, value ) {\r\n\t\t\t\tconsole.debug( key + \": \" + value );\r\n\t\t\t\tconsole.debug(\"key : data\");\r\n\t\t\t\tconsole.debug(key);\r\n\t\t\t\tconsole.debug(data);\r\n\t\t\t\tif(key.indexOf(\"slot\")==-1 && value!=undefined && value!=null && value != \" \"){\r\n\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar txt = parseUrlTextPopUp(String(value), key);\r\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t\t'</div>';\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\thtml+= '</div>';\r\n\t\t\t\r\n\t\t\t//var html = '<p>Hello world!<br />This is a nice popup.</p>';\r\n\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html(html);\r\n\t\t\tjQuery('#info_geojsonvt').show();\r\n\t\t\tconsole.debug(\"html:\");\r\n\t\t\tconsole.debug(html);\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"null\");\r\n\t\t}\r\n\t});\r\n\t*/\t\r\n\t\r\n\tif (!layer.capesActiva || layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\tmap.addLayer(wmsLayer).addLayer(utfGridLayer);\r\n\t\twmsLayer.options.utfGridLeafletId = utfGridLayer._leaflet_id; \r\n\t}\r\n\t\r\n\tif (!layer.capesOrdre){\r\n\t\twmsLayer.options.zIndex = controlCapes._lastZIndex + 1;\r\n\t}else{\r\n\t\twmsLayer.options.zIndex = parseInt(layer.capesOrdre);\r\n\t}\r\n\tcontrolCapes.addOverlay(wmsLayer, wmsLayer.options.nom, true);\r\n\tcontrolCapes._lastZIndex++;\t\r\n}\r\n\r\nfunction loadVisualitzacioWmsLayerSenseUtfGrid(layer){\r\n\tvar defer = $.Deferred();\r\n\tvar optionsWMS = {\r\n\t        layers : layer.serverName,\r\n\t        crs : L.CRS.EPSG3857,\r\n\t        transparent : true,\r\n\t        format : layer.imgFormat,//'image/png'\r\n\t    \tversion: layer.version,\r\n\t    \ttileSize:512,\r\n\t    \t//    opacity: layer.opacity,\t    \r\n\t    \tnom : layer.serverName,\r\n\t    \ttipus: layer.serverType,\r\n\t    \tzIndex :  parseInt(layer.capesOrdre),\t    \r\n\t    \tbusinessId: layer.businessId\t        \t\r\n\t}\r\n\tvar wmsLayer =L.tileLayer.betterWms(layer.url, optionsWMS);\r\n\tmap.addLayer(wmsLayer);\r\n\t\r\n\tvar jsonOptions;\r\n\tif(typeof (layer.options)==\"string\"){\r\n\t\ttry {\r\n\t\t\tjsonOptions = JSON.parse(layer.options);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\tjsonOptions = layer.options;\t\r\n\t\t}\r\n\t}else{\t\t\r\n\t\tjsonOptions = layer.options;\t\r\n\t}\t\r\n\t\r\n\tvar origen = getLeafletIdFromBusinessId(jsonOptions.origen);\r\n    wmsLayer.options.zIndex = capesOrdre_sublayer;\r\n\tcontrolCapes.addOverlay(wmsLayer, wmsLayer.options.nom, true,origen);\r\n\tdefer.resolve();\r\n\t\r\n}\r\n\r\nfunction createUtfGridLayer(url,options){\r\n\r\n\tvar utfGrid = new L.UtfGrid(url,options);\r\n\r\n\tutfGrid.on('click', function (e) {\r\n\t\tif (e.data!=null){\r\n//\t\t\tconsole.debug(e.data);\r\n\t\t\t\r\n\t\t\tjQuery('#bt_info_geojsonvt_close').on('click', function (e) {\r\n//\t\t\t\ttancaFinestra();\r\n\t\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html('');\r\n\t\t\t\tjQuery('#info_geojsonvt').hide();\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tvar html ='';\r\n\t\t\thtml+='<div class=\"popup_pres\">';\r\n\t\t\t$.each( e.data, function( key, value ) {\r\n//\t\t\t\tconsole.debug( key + \": \" + value );\r\n\t\t\t\tif(key.indexOf(\"slot\")==-1 && value!=undefined && value!=null && value != \" \"){\r\n\t\t\t\t\t//treiem caracter '_' del nom de la propietat\r\n\t\t\t\t\tkey = key.replace('_', ' ');\r\n\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_row width100\">';\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar txt = value;\r\n\t    \t\t\t\tif (!$.isNumeric(txt) && !validateWkt(value)){\t    \t\t\t\t\r\n\t\t    \t\t\t\ttxt = parseUrlTextPopUp(value,key);\r\n\t\t    \t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t\t\t'</div>';\r\n\t\t    \t\t\t\t}else{\r\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t    \t\t\t\t}\r\n\t    \t\t\t\t}\r\n\t    \t\t\t\telse {\r\n\t    \t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t    \t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t\t\t'</div>';\r\n\t    \t\t\t\t}\r\n\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\thtml+= '</div>';\r\n\t\t\t\r\n\t\t\t//var html = '<p>Hello world!<br />This is a nice popup.</p>';\r\n\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html(html);\r\n\t\t\tjQuery('#info_geojsonvt').show();\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"null\");\r\n\t\t}\r\n\t});\t\r\n\t\r\n\treturn utfGrid;\r\n}","/**\r\n * Gestió de la creació i carrega de capes de tipus social:\r\n * - L.Panoramio.custom.js\r\n * - L.Wikipedia.custom.js\r\n * - L.Twitter.custom.js\r\n */\r\n\r\nfunction addPanoramioLayer(){\r\n\t\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'panoramio', 'label panoramio', 1]});\r\n\t//_kmq.push(['record', 'panoramio', {'from':'mapa', 'tipus user':tipus_user}]);\r\n\t\r\n\tvar panoramio = new L.Panoramio.custom({\r\n\t\tmaxLoad: 10, \r\n\t\tmaxTotal: 250, \r\n\t\tnom : 'panoramio',\r\n\t\tbusinessId: '-1',\r\n\t\ttipus: t_xarxes_socials\r\n\t});\r\n\t\r\n\tif(typeof url('?businessid') == \"string\"){\r\n\t\tvar data = {\r\n\t\t\tuid:Cookies.get('uid'),\r\n\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\tserverName: 'panoramio',\r\n\t\t\tserverType: t_xarxes_socials,\r\n\t\t\tcalentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n            order: controlCapes._lastZIndex+1,\r\n            epsg: '4326',\r\n            transparency: true,\r\n            visibilitat: visibilitat_open,\r\n\t\t\toptions: '{\"xarxa_social\": \"panoramio\"}'\r\n\t\t};\r\n\t\t\r\n\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\tpanoramio.options.businessId = results.results.businessId;\r\n\t\t\t\tpanoramio.options.xarxa_social=\"panoramio\";\r\n\t\t\t\tpanoramio.addTo(map);\r\n\t\t\t\tpanoramio.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\t\t\tcontrolCapes.addOverlay(panoramio, 'panoramio', true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('error create server in map');\r\n\t\t\t}\r\n\t\t});\t\r\n\t}else{\r\n\t\tpanoramio.addTo(map);\r\n\t\tpanoramio.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\tcontrolCapes.addOverlay(panoramio, 'panoramio', true);\r\n\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t}\t\r\n}\r\n\r\nfunction loadPanoramioLayer(layer){\t\r\n\t\r\n\t\r\n\t\r\n\tvar panoramio = new L.Panoramio.custom({\r\n\t\tmaxLoad: 10, \r\n\t\tmaxTotal: 250, \r\n\t\tzIndex: parseInt(layer.capesOrdre),\r\n\t\tnom : layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tbusinessId: layer.businessId,\r\n\t\toptions: '{\"xarxa_social\": \"panoramio\"}'\r\n\t});\t\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tif (options.group){\r\n\t\tpanoramio.options.group=options.group;\r\n\t\tpanoramio.options.xarxa_social=\"panoramio\";\r\n\t}\r\n\t\r\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\tpanoramio.addTo(map);\r\n\t}\r\n\tcontrolCapes.addOverlay(panoramio, layer.serverName, true);\r\n\tcontrolCapes._lastZIndex++;\r\n}\r\n\r\nfunction addTwitterLayer(){\r\n\t\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'twitter', hashtag, 1]});\t\r\n\t//_kmq.push(['record', 'twitter', {'from':'mapa', 'tipus user':tipus_user, 'hashtag':hashtag}]);\r\n\t\r\n\tvar hashtag = $('#twitter-collapse .input-group #hashtag_twitter_layer').val();\r\n\t//Control no afegit #\r\n\tif(hashtag.indexOf(\"#\") == 0) hashtag = hashtag.substr(1);\r\n\t\r\n\tif(hashtag == null || hashtag == \"\") return;\r\n\t\r\n\t$('#twitter-collapse .input-group #hashtag_twitter_layer').val(\"\");\r\n\tvar twitter = new L.Twitter({\r\n\t\thashtag: hashtag,\r\n\t\tnom: 'twitter #'+ hashtag,\r\n\t\tbusinessId: '-1',\r\n\t\ttipus: t_xarxes_socials\r\n\t});\r\n\r\n\t//Si el mapa existeix a BD\r\n\tif(typeof url('?businessid') == \"string\"){\t\r\n\t\tvar data = {\r\n\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\tserverName: 'twitter #'+ hashtag,\r\n\t\t\t\tserverType: t_xarxes_socials,\r\n\t\t\t\tcalentas: false,\r\n\t            activas: true,\r\n\t            visibilitats: true,\r\n\t            order: controlCapes._lastZIndex+1,\r\n\t            epsg: '4326',\r\n\t            transparency: true,\r\n\t            visibilitat: visibilitat_open,\r\n\t\t\t\toptions: '{\"xarxa_social\": \"twitter\", \"hashtag\": \"'+hashtag+'\"}'\r\n\t\t};\r\n\t\t\r\n\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\ttwitter.options.businessId = results.results.businessId;\r\n\t\t\t\ttwitter.options.xarxa_social=\"twitter\";\r\n\t\t\t\ttwitter.options.hashtag=hashtag;\r\n\t\t\t\ttwitter.addTo(map);\r\n\t\t\t\ttwitter.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\t\t\tcontrolCapes.addOverlay(twitter, 'twitter #'+ hashtag, true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('error create server in map');\r\n\t\t\t}\r\n\t\t});\t\r\n\t}else{\r\n\t\ttwitter.addTo(map);\r\n\t\ttwitter.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\tcontrolCapes.addOverlay(twitter, 'twitter #'+ hashtag, true);\r\n\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t}\t\r\n\t//Tanquem input twitter\r\n\t$('#twitter-collapse').hide();\r\n} \r\n\r\nfunction loadTwitterLayer(layer, hashtag){\r\n\tvar twitter = new L.Twitter({\r\n\t\thashtag: hashtag,\r\n\t\tnom: layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tzIndex: parseInt(layer.capesOrdre), \r\n\t\tbusinessId: layer.businessId\r\n\t});\t\r\n\t\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tif (options.group){\r\n\t\ttwitter.options.group=options.group;\r\n\t}\r\n\t\r\n\t\r\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\ttwitter.addTo(map);\r\n\t}\r\n\tcontrolCapes.addOverlay(twitter, layer.serverName, true);\r\n\tcontrolCapes._lastZIndex++;\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction addWikipediaLayer(){\t\r\n\t\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wikipedia', 'label wikipedia', 1]});\r\n\t//_kmq.push(['record', 'wikipedia', {'from':'mapa', 'tipus user':tipus_user}]);\r\n\t\r\n\tvar keyName = $('#wikipedia-collapse .input-group #name_wikipedia_layer').val();\t\r\n\t\r\n\tvar wikipedia = new L.Wikipedia({\r\n\t\tnom : 'wikipedia',\r\n\t\tbusinessId: '-1',\r\n\t\ttipus: t_xarxes_socials,\r\n\t\tkey: keyName\r\n\t});\r\n\t\r\n\tif(typeof url('?businessid') == \"string\"){\r\n\t\t\r\n\t\tvar data = {\r\n\t\t\tuid:Cookies.get('uid'),\r\n\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\tserverName: 'wikipedia',\r\n\t\t\tserverType: t_xarxes_socials,\r\n\t\t\tcalentas: false,\r\n            activas: true,\r\n            visibilitats: true,\r\n            order: controlCapes._lastZIndex+1,\r\n            epsg: '4326',\r\n            transparency: true,\r\n            visibilitat: visibilitat_open,\r\n\t\t\toptions: '{\"xarxa_social\": \"wikipedia\", \"key\": \"'+keyName+'\"}'\r\n\t\t};\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\twikipedia.options.businessId = results.results.businessId;\t\t\t\r\n\t\t\t\twikipedia.options.xarxa_social = \"wikipedia\";\t\t\t\t\r\n\t\t\t\twikipedia.options.key = keyName;\t\t\t\t\t\t\t\t\r\n\t\t\t\twikipedia.addTo(map);\r\n\t\t\t\twikipedia.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\t\t\tcontrolCapes.addOverlay(wikipedia, 'wikipedia', true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('error create server in map');\r\n\t\t\t}\r\n\t\t});\r\n\t}else{\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\twikipedia.addTo(map);\r\n\t\twikipedia.options.zIndex = controlCapes._lastZIndex+1;\r\n\t\tcontrolCapes.addOverlay(wikipedia, 'wikipedia', true);\r\n\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t}\t\r\n}\r\n\r\nfunction loadWikipediaLayer(layer){\r\n\t\r\n\tvar wikipedia = new L.Wikipedia({\r\n\t\tzIndex: parseInt(layer.capesOrdre),\r\n\t\tnom : layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tbusinessId: layer.businessId\r\n\t});\t\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tif (options.group){\r\n\t\twikipedia.options.group=options.group;\r\n\t}\r\n\t\r\n\t\r\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\twikipedia.addTo(map);\r\n\t}\r\n\tcontrolCapes.addOverlay(wikipedia, layer.serverName, true);\r\n\tcontrolCapes._lastZIndex++;\r\n}\r\n","/**\r\n * Gestió de la creació i carrega de capes de Dades obertes\r\n */\r\n\r\nvar _htmlDadesObertes = [];\r\nfunction generaLListaDadesObertes() {\r\n\tgetLListaDadesObertes().then(function(results) {\r\n\t\t_htmlDadesObertes.push('<div class=\"panel-danger\"><ul class=\"bs-dadesO llista-do panel-heading\">');\r\n\t\t$.each(results.dadesObertes, function(key, dataset) {\r\n\t\t\t_htmlDadesObertes.push('<li><a class=\"label-explora\" lang=\"ca\" title=\"Afegir capa\" href=\"#\" id=\"'\r\n\t\t\t\t+ dataset.dataset\r\n\t\t\t\t+ '\">'\r\n\t\t\t\t+ dataset.text\r\n\t\t\t\t+ '</a>'\r\n\t\t\t\t+ '<a target=\"_blank\" lang=\"ca\" title=\"Informació de les dades\" href=\"'+dataset.urn+'\"><span class=\"glyphicon glyphicon-info-sign info-explora\"></span></a>'\t\t\t\t\t\t\t\r\n\t\t\t\t+'</li>');\r\n\t\t});\r\n\t\t_htmlDadesObertes.push('</ul><div id=\"div_do_message\"></div></div>');\r\n\t});\r\n}\r\n\r\nfunction addCapaDadesObertes(dataset,nom_dataset) {\r\n\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades obertes', nom_dataset, 1]});\r\n\r\n\t\r\n\tvar param_url = paramUrl.dadesObertes + \"dataset=\" + dataset;\r\n\tvar estil_do = retornaEstilaDO(dataset);\r\n\t\r\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(param_url, {\r\n\t\tonEachFeature : createPopupWindowDadesObertes,\r\n\t\tnom : dataset,\r\n\t\ttipus : t_dades_obertes,\r\n\t\tdataset: dataset,\r\n\t\testil_do: estil_do,\r\n\t\tbusinessId : '-1',\r\n\t\tgeometryType:t_marker,\r\n\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\tif(dataset.indexOf('meteo')!=-1){\r\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t\t    iconUrl: feature.style.iconUrl,\r\n\t\t\t\t\t    iconSize:     [44, 44], \r\n\t\t\t\t\t    iconAnchor:   [22, 22], \t\t\t\t   \r\n\t\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t\t})});\r\n\t\t\t}else if(dataset.indexOf('incidencies')!=-1){\r\n\t\t\t\tvar inci=feature.properties.descripcio_tipus;\r\n\t\t\t\tvar arr = [\"Obres\", \"Retenció\", \"Cons\", \"Meterologia\" ];\r\n\t\t\t\tvar arrIM = [\"st_obre.png\", \"st_rete.png\", \"st_cons.png\", \"st_mete.png\" ];\r\n\t\t\t\tvar imgInci=\"/geocatweb/img/\"+arrIM[jQuery.inArray( inci, arr )];\r\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t    iconUrl: imgInci,\r\n\t\t\t\t    iconSize:     [30, 26], \r\n\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \r\n\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t})});\r\n\t\t\t}else if(dataset.indexOf('cameres')!=-1){\r\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t    iconUrl: \"/geocatweb/img/st_came.png\",\r\n\t\t\t\t    iconSize:     [30, 26], \r\n\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \r\n\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t})});\r\n\t\t\t}else{\r\n\t\t\treturn L.circleMarker(latlng, estil_do);\r\n\t\t\t}\r\n\t\t},\r\n\t\tmiddleware:function(data){\r\n            \r\n            if(data.status && data.status.indexOf(\"ERROR\")!=-1){\r\n        \t\tif(data.results.indexOf(\"CONVERT ERROR\")!= -1){\r\n    \t\t\tvar txt_error = window.lang.translate(\"Error en el tractament de les dades\");\r\n    \t\t\tjQuery(\"#div_do_message\").html('<div class=\"alert alert-danger\">'+txt_error+'</div>');\r\n\t    \t\t}\r\n\t    \t\telse{\r\n\t    \t\t\tvar txt_error = window.lang.translate(\"Impossible accedir a la font de dades\");\r\n\t    \t\t\tjQuery(\"#div_do_message\").html('<div class=\"alert alert-danger\">'+txt_error+'</div>');\r\n\t    \t\t}            \t\r\n            }else{\r\n            \tif (data!=null && data.features!=\"undefined\"){\r\n            \t\tjQuery(\"#div_do_message\").html(\"\");\r\n\t            \tcapaDadaOberta.addData(data);\r\n\t            \t\r\n\t            \tif(typeof url('?businessid') == \"string\"){\r\n\t    \t\t\t\tvar data = {\r\n\t    \t\t\t\t\tuid:Cookies.get('uid'),\r\n\t    \t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t    \t\t\t\t\tserverName: nom_dataset,\r\n\t    \t\t\t\t\tserverType: t_dades_obertes,\r\n\t    \t\t\t\t\tcalentas: false,\r\n\t    \t\t            activas: true,\r\n\t    \t\t            visibilitats: true,\r\n\t    \t\t            order: controlCapes._lastZIndex+1,\r\n\t    \t\t            epsg: '4326',\r\n\t    \t\t            transparency: true,\r\n\t    \t\t            visibilitat: visibilitat_open,\r\n\t    \t\t\t\t\toptions: '{\"dataset\":\"'+dataset+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\t\t\t\r\n\t    \t\t\t\t};\r\n\t    \t\t\t\t\r\n\t    \t\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t    \t\t\t\t\tif (results.status == \"OK\"){\r\n\t    \t\t\t\t\t\tcapaDadaOberta.nom = nom_dataset;// +\" (\"+datasetLength+\")\";\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t\tcapaDadaOberta.options={\"dataset\":dataset,\r\n\t    \t\t\t\t\t\t\t\t\"estil_do\":{\"radius\":estil_do.radius,\r\n\t    \t\t\t\t\t\t\t\t\t\"fillColor\":estil_do.fillColor,\r\n\t    \t\t\t\t\t\t\t\t\t\"color\":estil_do.color,\r\n\t    \t\t\t\t\t\t\t\t\t\"weight\":estil_do.weight,\r\n\t    \t\t\t\t\t\t\t\t\t\"opacity\":estil_do.opacity,\r\n\t    \t\t\t\t\t\t\t\t\t\"fillOpacity\":estil_do.fillOpacity,\r\n\t    \t\t\t\t\t\t\t\t\t\"isCanvas\":estil_do.isCanvas}};\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t\tcapaDadaOberta.options.businessId = results.results.businessId;\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex+1;\r\n\t    \t\t\t\t\t\tcapaDadaOberta.options.tipus= t_dades_obertes;\r\n\t    \t\t\t\t\t\tcapaDadaOberta.options.nom = nom_dataset;\r\n\t    \t\t\t\t\t\tcapaDadaOberta.addTo(map)\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, nom_dataset, true);\r\n\t    \t\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t    \t\t\t\t\t\tactivaPanelCapes(true);\r\n\t    \t\t\t\t\t\t\r\n\t    \t\t\t\t\t}\r\n\t    \t\t\t\t});\r\n\t    \t\t\t}else{\r\n\t    \t\t\t\tcapaDadaOberta.nom = nom_dataset;// +\" (\"+datasetLength+\")\";\r\n\t    \t\t\t\tcapaDadaOberta.addTo(map);\r\n\t    \t\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex+1;\r\n\t    \t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, nom_dataset, true);\r\n\t    \t\t\t\tcontrolCapes._lastZIndex++;\r\n\t    \t\t\t\tactivaPanelCapes(true);\r\n\t    \t\t\t}\t\r\n            \t}\r\n            }\r\n        }\r\n\t});\r\n}\r\n\r\nfunction loadDadesObertesLayer(layer){\r\n\t\r\n\tvar defer = $.Deferred();\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tif(options.tem == null || options.tem == tem_simple){\r\n\t\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\r\n\t\tvar estil_do = options.estil_do;\r\n\t\t\r\n\t\tif (options.tem == tem_simple){\r\n\t\t\testil_do = createFeatureMarkerStyle(options.style);\r\n\t\t}\r\n\t\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\r\n\t\t\tonEachFeature : createPopupWindowDadesObertes,\r\n\t\t\tnom : layer.serverName,\r\n\t\t\ttipus : layer.serverType,\r\n\t\t\tdataset: options.dataset,\r\n\t\t\tbusinessId : layer.businessId,\r\n\t\t\tdataType : \"jsonp\",\r\n\t\t\testil_do : estil_do, //per la llegenda\r\n\t\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\t\tif(options.dataset.indexOf('meteo')!=-1){\r\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t\t\t    iconUrl: feature.style.iconUrl,\r\n\t\t\t\t\t\t    iconSize:     [44, 44], \r\n\t\t\t\t\t\t    iconAnchor:   [22, 22], \t\t\t\t   \r\n\t\t\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t\t\t})});\r\n\t\t\t\t}else if(options.dataset.indexOf('incidencies')!=-1){\r\n\t\t\t\t\tvar inci=feature.properties.descripcio_tipus;\r\n\t\t\t\t\tvar arr = [\"Obres\", \"Retenció\", \"Cons\", \"Meterologia\" ];\r\n\t\t\t\t\tvar arrIM = [\"st_obre.png\", \"st_rete.png\", \"st_cons.png\", \"st_mete.png\" ];\r\n\t\t\t\t\tvar imgInci=\"/geocatweb/img/\"+arrIM[jQuery.inArray( inci, arr )];\r\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t\t    iconUrl: imgInci,\r\n\t\t\t\t\t    iconSize:     [30, 26], \r\n\t\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \r\n\t\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t\t\t})});\r\n\t\t\t\t}else if(options.dataset.indexOf('cameres')!=-1){\r\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\r\n\t\t\t\t\t    iconUrl: \"/geocatweb/img/st_came.png\",\r\n\t\t\t\t\t    iconSize:     [30, 26], \r\n\t\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \r\n\t\t\t\t\t    popupAnchor:  [-3, -3] \r\n\t\t\t\t\t})});\r\n\t\t\t\t}else{\r\n\t\t\t\t\tif (estil_do.isCanvas){\r\n\t\t\t\t\t\treturn L.circleMarker(latlng, estil_do);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\treturn L.marker(latlng, {icon:estil_do,isCanvas:false, tipus: t_marker});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\t\r\n\t\t\r\n\t\t\r\n\t\t//afegim group\r\n\t\tif (options.group){\r\n\t\t\tcapaDadaOberta.options.group=options.group;\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tcapaDadaOberta.addTo(map);\r\n\t\t}\r\n\t\t\t\t\r\n\t\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\r\n\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex + 1;\r\n\t\t}else{\r\n\t\t\tcapaDadaOberta.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\t}\t\t\r\n\t\t\r\n\t\tif(!options.origen){\r\n\t\t\t//Fins que no estigui carregada del tot no afegim al controlcapes (per tenir be el comptador de features)\r\n\t\t\tcapaDadaOberta.on('data:loaded', function(e){\r\n\t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tdefer.resolve();\r\n\t\t\t});\r\n\t\t}else{//Si te origen es una sublayer\r\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\t\tcapaDadaOberta.options.zIndex = capesOrdre_sublayer;\r\n\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true, origen);\r\n\t\t\tdefer.resolve();\r\n\t\t}\t\t\r\n\t\t\r\n\t}else if(options.tem == tem_cluster){\r\n\t\tloadDadesObertesClusterLayer(layer,defer);\r\n\t}else if(options.tem == tem_heatmap){\r\n\t\tloadDOHeatmapLayer(layer,defer);\r\n\t}\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction createPopupWindowDadesObertes(player,l){\r\n\t//console.debug(\"createPopupWindowData\");\r\n\tvar html='';\r\n\tvar out = [];\r\n\tif (player.properties.nom && !isBusinessId(player.properties.nom)){\r\n\t\thtml+='<h4>'+player.properties.nom+'</h4>';\r\n\t}else if(player.properties.name && !isBusinessId(player.properties.name)){\r\n\t\thtml+='<h4>'+player.properties.name+'</h4>';\r\n\t}else if(player.properties.Name && !isBusinessId(player.properties.Name)){\r\n\t\thtml+='<h4>'+player.properties.Name+'</h4>';\r\n\t}\r\n\tif (player.properties.description){\r\n\t\tif (!$.isNumeric(player.properties.description) && !validateWkt(player.properties.description)) html+='<div>'+parseUrlTextPopUp(player.properties.description)+'</div>';\r\n\t\telse html+='<div>'+player.properties.description+'</div>';\r\n\t}\r\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\tvar pp = player.properties;\r\n\r\n\t$.each( pp, function( key, value ) {\r\n\t\tif(isValidValue(value) && !validateWkt(value)){\r\n\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\r\n\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\tvar txt = value;\r\n\t\t\t\tif (!$.isNumeric(txt)) {\r\n\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t}\r\n\t\t\t\thtml+= '</div>';\r\n\t\t\t}\r\n\t\t}\r\n\t});\t\r\n\t\r\n\thtml+='</div></div>';\r\n\tl.bindPopup(html,{'offset':[0,-25]});\r\n}","//var _htmlServeisJSON = [];\r\n//\r\n//_htmlServeisJSON.push('<div class=\"panel-success\"><div panel-heading\">');\r\n//\r\n//_htmlServeisJSON.push('<div class=\"input-group txt_ext\"><input type=\"text\" lang=\"ca\" id=\"txt_URLJSON\" style=\"height:33px\" placeholder=\"Entrar URL servei JSON\" value=\"\" class=\"form-control\">');\r\n//_htmlServeisJSON.push('<span class=\"input-group-btn\"><button class=\"btn btn-success\" id=\"bt_connJSON\"  type=\"button\"><span class=\"glyphicon glyphicon-play\"></span></button></span>');\r\n//\r\n////_htmlServeisJSON.push('<div class=\"small\"\r\n//\r\n////http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json?\r\n//\r\n//_htmlServeisJSON.push('</div>');\r\n//_htmlServeisJSON.push('</div>');\r\n//_htmlServeisJSON.push('<div style=\"height:230px;overflow:auto\" id=\"div_layersJSON\"  class=\"tbl\"></div>');\r\n//_htmlServeisJSON.push('<div id=\"div_emptyJSON\" style=\"height: 35px;margin-top: 2px\"></div>');\r\n\r\nvar respostaJSON;\r\nvar urlJSON;\r\nfunction getServeiJSONP(purlJson) {\r\n\turlJSON = purlJson;\r\n\tjQuery(\"#txt_URLJSON\");\r\n\tvar _htmlJSONFields = [];\r\n\r\n\r\n\r\n\t\tgetJSONPServei(purlJson).then(function(results) {\r\n\t\t\t\t\t\t\tvar op = [];\r\n\t\t\t\t\t\t\tif (jQuery.isArray(results)) {\r\n\t\t\t\t\t\t\t\trespostaJSON = results;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tfor (key in results) {\r\n\t\t\t\t\t\t\t\t\tif (jQuery.isArray(results[key])) {\r\n\t\t\t\t\t\t\t\t\t\trespostaJSON = results[key];\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tif(purlJson.indexOf(paramUrl.presidentJSON)!= -1){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcreaCapaFromJSON(1);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (!jQuery.isArray(respostaJSON)) {\r\n\t\t\t\t\t\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\r\n\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\top.push(\"<option value='null'>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Selecciona un camp')\r\n\t\t\t\t\t\t\t\t\t+ \"</option>\");\r\n\t\t\t\t\t\t\tfor (key in respostaJSON[0]) {\r\n\t\t\t\t\t\t\t\top.push(\"<option value=\" + key + \">\" + key\r\n\t\t\t\t\t\t\t\t\t\t+ \"</option>\");\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//jQuery('#div_layersJSON').removeClass('waiting_animation');\r\n\t\t\t\t\t\t\tjQuery('#div_layersJSON').empty();\r\n\t\t\t\t\t\t\tjQuery('#div_emptyJSON').empty();\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push('<ul class=\"bs-dadesO_JSON\">');\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><label>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Camps necessaris')\r\n\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><label>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ window.lang\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t.convert('Selecciona el camp corresponent')\r\n\t\t\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ window.lang.translate('Coordenada X o Longitud')\r\n\t\t\t\t\t\t\t\t\t\t\t+ \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_x'>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Coordenada Y o Latitud') + \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><select id='cmd_json_y'>\"\r\n\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><label>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Opcionals')\r\n\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Títol') + \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_titol'>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Descripció')\r\n\t\t\t\t\t\t\t\t\t+ \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_desc'>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Imatge') + \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_img'>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\r\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Vincle') + \"</li>\");\r\n\t\t\t\t\t\t\t_htmlJSONFields\r\n\t\t\t\t\t\t\t\t\t.push(\"<li><select id='cmd_json_vin'>\"\r\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\r\n\r\n\t\t\t\t\t\t\t_htmlJSONFields.push('</ul>');\r\n\r\n\t\t\t\t\t\t\tjQuery('#div_layersJSON').html(\r\n\t\t\t\t\t\t\t\t\t_htmlJSONFields.join(\" \"));\r\n\t\t\t\t\t\t\tjQuery('#div_emptyJSON')\r\n\t\t\t\t\t\t\t\t\t.html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" id=\"bt_addJSON\" class=\"btn btn-success\" >'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ window.lang\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.convert(\"Mapificar\")\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ '</button></div>');\r\n\r\n\t\t\t\t\t\t\t$('#cmd_json_x option:contains(\"long\")').prop(\r\n\t\t\t\t\t\t\t\t\t'selected', true);\r\n\t\t\t\t\t\t\t$('#cmd_json_x option:contains(\"lng\")').prop(\r\n\t\t\t\t\t\t\t\t\t'selected', true);\r\n\r\n\t\t\t\t\t\t\t$('#cmd_json_y option:contains(\"latitu\")').prop(\r\n\t\t\t\t\t\t\t\t\t'selected', true);\r\n\t\t\t\t\t\t\t$('#cmd_json_y option:contains(\"lat\")').prop(\r\n\t\t\t\t\t\t\t\t\t'selected', true);\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t});\r\n\t\t\r\n\t\tjQuery(document).on('click', \"#bt_addJSON\", function(e) {\r\n\t\t\tcreaCapaFromJSON(0);\r\n\t\t});\t\t\r\n\t\t\r\n\r\n//\t} else {\r\n//\r\n//\t\talert(window.lang.translate(\"La URL no sembla vàlida\"));\r\n//\t\treturn;\r\n//\t}\r\n}\r\n\r\n\r\n\r\nfunction creaCapaFromJSON(directe) {\r\n\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlJSON, 1]});\r\n\t\r\n\tvar cmd_json_x = \"longitude\";\r\n\t\t\tvar cmd_json_y = \"latitude\";\r\n\t\t\tvar cmd_json_titol =\"titular\";\r\n\t\t\tvar cmd_json_desc = \"municipio\";\r\n\t\t\tvar cmd_json_img = \"imagen\";\r\n\t\t\tvar cmd_json_vin = \"url\";\r\n\t\r\n\t\r\n\tif(directe!=1){\r\n\t\tcmd_json_x = jQuery('#cmd_json_x').val();\r\n\t\tcmd_json_y = jQuery('#cmd_json_y').val();\r\n\t\tcmd_json_titol = jQuery('#cmd_json_titol').val();\r\n\t\tcmd_json_desc = jQuery('#cmd_json_desc').val();\r\n\t\tcmd_json_img = jQuery('#cmd_json_img').val();\r\n\t\tcmd_json_vin = jQuery('#cmd_json_vin').val();\t\r\n\t}\r\n\t\r\n\tif ((cmd_json_x == \"null\") || (cmd_json_y == \"null\")) {\r\n\r\n\t\talert(window.lang.translate(\"Els camps de coordenades no poden estar buits\"));\r\n\t\treturn;\r\n\r\n\t} else {\r\n\r\n\t\t//nom per defecte agafat de la url del json a mostrar\r\n\t\tvar paraules = urlJSON.split(\"/\");\r\n\t\tvar paraula = paraules[paraules.length-1].split(\".\");\r\n\t\tvar nomCapaJson = paraula[0];\r\n\t\tif(!nomCapaJson) nomCapaJson = 'Capa JSON';\r\n\t\t\r\n\t\tvar capaJSON = new L.FeatureGroup();\r\n\t\tcapaJSON.options = {\r\n\t\t\tbusinessId : -1,\r\n\t\t\tnom : nomCapaJson,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\r\n\t\t\ttipus:t_json,\r\n\t\t\turl: urlJSON\r\n//\t\t\tzIndex : controlCapes._lastZIndex// + 1\r\n\t\t};\r\n\t\t\r\n\t\tvar param_estil = 'json';\r\n\t\tif(urlJSON.indexOf(\"president\")!=-1) param_estil = 'json_president';\r\n\t\tvar estil_do = retornaEstilaDO(param_estil);\r\n\t\t\r\n\t\tif(typeof url('?businessid') == \"string\"){\r\n\t\t\tvar data = {\r\n\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\tserverName: nomCapaJson,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\r\n\t\t\t\tserverType: t_json,\r\n\t\t\t\tcalentas: false,\r\n\t            activas: true,\r\n\t            visibilitats: true,\r\n\t            order: controlCapes._lastZIndex+1,\r\n\t            epsg: '4326',\r\n\t            imgFormat: 'image/png',\r\n\t            infFormat: 'text/html',\r\n\t            tiles: true,\t            \r\n\t            transparency: true,\r\n\t            opacity: 1,\r\n\t            visibilitat: 'O',\r\n\t            url: urlJSON,//Provar jQuery(\"#txt_URLJSON\")\r\n\t            calentas: false,\r\n\t            activas: true,\r\n\t            visibilitats: true,\r\n\t            options: '{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (key in respostaJSON) {\r\n\t\t\t\t\t\tvar lat = respostaJSON[key][cmd_json_y];\r\n\t\t\t\t\t\tvar lon = respostaJSON[key][cmd_json_x];\r\n\t\t\t\t\t\tpp = L.circleMarker([ lat, lon ], estil_do)\r\n\r\n\t\t\t\t\t\tpp.properties = {};\r\n\t\t\t\t\t\tvar empty = true;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (cmd_json_titol == \"null\") {\r\n\t\t\t\t\t\t\tpp.properties.nom = \"\"\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpp.properties.nom = respostaJSON[key][cmd_json_titol];\r\n\t\t\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cmd_json_desc == \"null\") {\r\n\t\t\t\t\t\t\tpp.properties.text = \"\"\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpp.properties.text = respostaJSON[key][cmd_json_desc];\r\n\t\t\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cmd_json_img == \"null\") {\r\n\t\t\t\t\t\t\tpp.properties.img = \"\"\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\r\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_img] + '\">';\r\n\t\t\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cmd_json_vin == \"null\") {\r\n\t\t\t\t\t\t\tpp.properties.vincle = \"\"\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpp.properties.vincle = '<a href=\"'\r\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_vin]\r\n\t\t\t\t\t\t\t\t\t+ '\" target=\"_blank\">'\r\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_vin] + '</a>';\r\n\t\t\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif(!empty){\r\n\t\t\t\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div>\"\r\n\t\t\t\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\r\n\t\t\t\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\r\n\t\t\t\t\t\t\t\t\t+ \"</div>\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpp.addTo(capaJSON);\r\n\t\t\t\t\t}\r\n\r\n//\t\t\t\t\tjQuery('#dialog_dades_ex').modal('toggle');\r\n\t\t\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\r\n\t\t\t\t\tcapaJSON.options.businessId = results.results.businessId;\r\n\t\t\t\t\tcapaJSON.options.options = jQuery.parseJSON('{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\"}');\r\n\t\t\t\t\tcapaJSON.options.options.estil_do = estil_do;\r\n\t\t\t\t\tcapaJSON.addTo(map);\r\n\t\t\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex+1; \r\n\t\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\r\n\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\tactivaPanelCapes(true);\r\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n//\t\t\t\t\t\t   advanced:{\r\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\r\n//\t\t\t\t\t\t     updateOnContentResize: true\r\n//\t\t\t\t\t\t   }           \r\n//\t\t\t\t\t});\t\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tcapaJSON.addTo(map)\r\n\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex+1; \r\n\t\t\tcapaJSON.options.options = jQuery.parseJSON('{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\"}');\r\n\t\t\tcapaJSON.options.options.estil_do = estil_do;\r\n\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\r\n\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\tactivaPanelCapes(true);\r\n//\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n//\t\t\t\t   advanced:{\r\n//\t\t\t\t     autoScrollOnFocus: false,\r\n//\t\t\t\t     updateOnContentResize: true\r\n//\t\t\t\t   }           \r\n//\t\t\t});\t\r\n\t\t}\t\t\r\n\t}\r\n\t\r\n\t//Buidem dialeg creacio capa JSON\r\n//\tjQuery('#div_layersJSON').empty();\r\n//\tjQuery('#txt_URLJSON').val('');\t\r\n\tjQuery('#div_url_file').empty();\r\n\tjQuery('#txt_URLfile').val('');\t\t\r\n}\r\n\r\nfunction loadCapaFromJSON(layer) {\r\n\r\n\tvar defer = $.Deferred();\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\t\r\n\tif(options.tem == tem_heatmap){\r\n\t\tloadJsonHeatmapLayer(layer);\r\n\t\treturn defer.resolve();\r\n\t}else if(options.tem == tem_cluster){\r\n\t\tloadJsonClusterLayer(layer);\r\n\t\treturn defer.resolve();\r\n\t}else{\t\r\n\t\tvar v_respotaJSON;\r\n\t\tgetJSONPServei(layer.url).then(function(results) {\r\n\t\t\tvar op = [];\r\n\t\t\tif (jQuery.isArray(results)) {\r\n\t\t\t\tv_respotaJSON = results;\r\n\t\t\t} else {\r\n\t\t\t\tfor (key in results) {\r\n\t\t\t\t\tif (jQuery.isArray(results[key])) {\r\n\t\t\t\t\t\tv_respotaJSON = results[key];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\r\n\t\t\tif (!jQuery.isArray(v_respotaJSON)) {\r\n\t\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvar capaJSON = new L.FeatureGroup();\r\n\t\t\tcapaJSON.options = {\r\n\t\t\t\tbusinessId : layer.businessId,\r\n\t\t\t\tnom : layer.serverName,\r\n\t\t\t\ttipus:layer.serverType,\r\n\t\t\t\tzIndex : layer.capesOrdre,\r\n\t\t\t\turl: layer.url,\r\n\t\t\t\toptions: options\r\n\t\t\t};\t\t\r\n\t\t\t\r\n\t\t\tif (options.group){\r\n\t\t\t\tcapaJSON.options.group=options.group;\r\n\t\t\t}\r\n\t\t\t\r\n//\t\t\tvar options = jQuery.parseJSON( layer.options );\r\n\t//\t\tvar estil_do = retornaEstilaDO('json');\r\n\t\t\tvar estil_do = options.estil_do;\r\n\t\t\t\r\n\t\t\tfor (key in v_respotaJSON) {\r\n\t\t\t\tvar lat = v_respotaJSON[key][options.y];\r\n\t\t\t\tvar lon = v_respotaJSON[key][options.x];\r\n\t\t\t\tvar pp = L.circleMarker([ lat, lon ], estil_do)\r\n\t\r\n\t\t\t\tpp.properties = {};\r\n\t\t\t\tvar empty = true;\r\n\t\t\t\t\r\n\t\t\t\tif (options.titol == \"null\") {\r\n\t\t\t\t\tpp.properties.nom = \"\"\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpp.properties.nom = v_respotaJSON[key][options.titol];\r\n\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t}\r\n\t\t\t\tif (options.descripcio == \"null\") {\r\n\t\t\t\t\tpp.properties.text = \"\"\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpp.properties.text = v_respotaJSON[key][options.descripcio];\r\n\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t}\r\n\t\t\t\tif (options.imatge == \"null\") {\r\n\t\t\t\t\tpp.properties.img = \"\"\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\r\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.imatge] + '\">';\r\n\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t}\r\n\t\t\t\tif (options.vincle == \"null\") {\r\n\t\t\t\t\tpp.properties.vincle = \"\"\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpp.properties.vincle = '<a href=\"'\r\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle]\r\n\t\t\t\t\t\t\t+ '\" target=\"_blank\">'\r\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle] + '</a>';\r\n\t\t\t\t\tempty = empty && false;\r\n\t\t\t\t}\r\n\t\r\n\t\t\t\tif(!empty){\r\n\t\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div id='text-popup-json'>\"\r\n\t\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\r\n\t\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\r\n\t\t\t\t\t\t\t+ \"</div>\");\r\n\t\t\t\t}\r\n\t\t\t\tpp.addTo(capaJSON);\r\n\t\t\t}\r\n\t\r\n\t\t\tcapaJSON.options.businessId = layer.businessId;\r\n\t\t\t\r\n\t\t\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\t\tcapaJSON.addTo(map)\r\n\t\t\t}\t\t\r\n\t\t\t\r\n\t\t\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\r\n\t\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex + 1;\r\n\t\t\t}else{\r\n\t\t\t\tcapaJSON.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\t\t}\t\t\t\r\n\t\t\t\t\r\n//\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true);\t\r\n//\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\r\n\t\t\tif(!options.origen){\r\n\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\r\n\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t}else{//Si te origen es una sublayer\r\n\t\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\t\t\tcapaJSON.options.zIndex = capesOrdre_sublayer;\r\n\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true, origen);\r\n\t\t\t}\t\t\t\r\n\t\t\t\r\n\t\t\tactivaPanelCapes(true);\t\r\n\t\t\treturn defer.resolve();\r\n\t\t},function(results){\r\n\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\r\n\t\t\treturn defer.reject();\t\t\r\n\t\t});\r\n\t}\r\n\treturn defer.promise();\r\n}\r\n","\r\nfunction createHeatMap(capa,tipus){\r\n\t\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'heatmap', 1]});\r\n\t\r\n\tvar nom = window.lang.translate(\"Concentració\");\r\n\t//Heatmap\r\n\tif (tipus == t_vis_wms){\r\n\t\tvar instamapsWms = InstamapsWms({\r\n\t\t\tloadTemplateParam :false});\r\n\t\tvar dataWMS = {url: capa.layer._url};\r\n\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\r\n\t\t\tvar layers = [];\r\n\t\t\tlayers=results.Capability.Layer.Layer;\r\n\t\t\tfor (var i=0;i<layers.length;i++){\r\n\t\t\t\tvar layer = layers[i];\r\n\t\t\t\tif (layers[i].Name.indexOf(\"heatmap\")>-1) {\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\r\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t            nom: layers[i].Name,//nom nombre de la nueva visualizacion\r\n\t\t\t\t            activas: true,\r\n\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\t\t\ttem: tem_heatmap,\r\n\t\t\t\t\t\t\tserverType: tem_heatmap_wms,//tem_heatmap\r\n\t\t\t\t\t\t\turl: capa.layer._url\r\n//\t\t\t\t            estils: JSON.stringify(rangs[0])\r\n\t\t\t\t\t};\r\n\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\r\n\t\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(results.layer);\t\t\t\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", false );\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\r\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\t\r\n\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse {\r\n\t\t\tvar arrP=[];\r\n\t\t\t\r\n\t\t\tcapa.layer.eachLayer(function(layer){\r\n\t\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\r\n\t\t\t\tarrP.push(d);\t\t\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\t\t\tgradient: {\t\t\t\r\n\t\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t\t1: \"#720404\"\r\n\t\t\t\t\t}\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tif(typeof url('?businessid') == \"string\"){\r\n\t\t\t\t//Si capa origen dades obertes, creem nova capa\r\n\t\t\t\tif(capa.layer.options.tipus == t_dades_obertes){\r\n\t\t\t\t\tdata = {\r\n\t\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n\t\t\t\t\t\t\tserverType: t_dades_obertes,\r\n\t\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t            activas: true,\r\n\t\t\t\t            order: capesOrdre_sublayer,\r\n\t\t\t\t            visibilitats: true,\r\n\t\t\t\t            epsg: '4326',\r\n\t\t\t\t            imgFormat: 'image/png',\r\n\t\t\t\t            infFormat: 'text/html',\r\n\t\t\t\t            tiles: true,\t            \r\n\t\t\t\t            transparency: true,\r\n\t\t\t\t            opacity: 1,\r\n\t\t\t\t            visibilitat: 'O',\r\n\t\t\t\t            options: '{\"dataset\":\"'+capa.layer.options.dataset+'\",\"tem\":\"'+tem_heatmap+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\r\n\t\t\t\t\t};\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_dades_obertes;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\r\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.debug('error create server in map');\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//tipus json \r\n\t\t\t\t}else if(capa.layer.options.tipus == t_json){\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n\t\t\t\t\t\tserverType: t_json,\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t\t    activas: true,\r\n\t\t\t\t\t    visibilitats: true,\r\n\t\t\t\t\t    order: capesOrdre_sublayer,\r\n\t\t\t\t\t    epsg: '4326',\r\n\t\t\t\t\t    imgFormat: 'image/png',\r\n\t\t\t\t\t    infFormat: 'text/html',\r\n\t\t\t\t\t    tiles: true,\t            \r\n\t\t\t\t\t    transparency: true,\r\n\t\t\t\t\t    opacity: 1,\r\n\t\t\t\t\t    visibilitat: 'O',\r\n\t\t\t\t\t    url: capa.layer.options.url,\r\n\t\t\t\t\t    calentas: false,\r\n\t\t\t\t\t    activas: true,\r\n\t\t\t\t\t    visibilitats: true,\r\n\t\t\t\t\t    options: '{\"x\":\"'+capa.layer.options.options.x+'\", \"y\":\"'+capa.layer.options.options.y+'\",\"tem\":\"'+tem_heatmap+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\r\n\t\t//\t\t\t    options: '{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\r\n\t\t\t\t\t};\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_json;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\r\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined)\t$( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n\t\t//\t\t\t\t\t\t   advanced:{\r\n\t\t//\t\t\t\t\t\t     autoScrollOnFocus: false,\r\n\t\t//\t\t\t\t\t\t     updateOnContentResize: true\r\n\t\t//\t\t\t\t\t\t   }           \r\n\t\t//\t\t\t\t\t});\t\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.debug(\"Error add heatmap JSON\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}else if(capa.layer.options.tipus == t_url_file){\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar options = {\r\n\t\t\t\t\t\t\turl: capa.layer.options.url,//capaMare.options.url,\r\n\t\t\t\t\t\t\ttem: tem_heatmap,\r\n\t\t\t\t\t\t\torigen: capa.layer.options.businessId,\r\n\t\t\t\t\t\t\ttipus : t_url_file,\r\n\t\t//\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\t\t\ttipusFile: capa.layer.options.tipusFile,\r\n\t\t//\t\t\t\t\testil_do: estil_do,\r\n\t\t\t\t\t\t\tepsgIN: capa.layer.options.epsgIN,\r\n\t\t\t\t\t\t\tgeometryType: capa.layer.options.geometryType,\r\n\t\t\t\t\t\t\tcolX: capa.layer.options.colX,\r\n\t\t\t\t\t\t\tcolY: capa.layer.options.colY,\r\n\t\t\t\t\t\t\tdinamic: capa.layer.options.dinamic\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t//\t\t\t\tconsole.debug(options);\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n\t\t//\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\t\t\tserverType: capa.layer.options.tipus,\r\n\t\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t            activas: true,\r\n\t\t\t\t            visibilitats: true,\r\n\t\t\t\t            order: capesOrdre_sublayer,\t\t\t\t\r\n\t\t\t\t            epsg: capa.layer.options.epsgIN,\r\n\t\t\t\t            imgFormat: 'image/png',\r\n\t\t\t\t            infFormat: 'text/html',\r\n\t\t//\t\t            tiles: true,\t            \r\n\t\t\t\t            transparency: true,\r\n\t\t\t\t            opacity: 1,\r\n\t\t\t\t            visibilitat: 'O',\r\n\t\t\t\t            url: capa.layer.options.url,//capaMare.options.url,\r\n\t\t\t\t\t\t\toptions: JSON.stringify(options)\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\r\n\t\t\r\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_url_file;\r\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\r\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.debug(\"Error add heatmap URL FILE\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t\t}else if (capa.layer.options.tipus == t_visualitzacio){\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\r\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t            nom: capa.layer.options.nom+\" \"+nom,//nom nombre de la nueva visualizacion\r\n\t\t\t\t            activas: true,\r\n\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\t\t\ttem: tem_heatmap//tem_heatmap\r\n\t\t//\t\t            estils: JSON.stringify(rangs[0])\r\n\t\t\t\t\t\t};\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\r\n\t\t\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.layer.businessId;\r\n\t\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\r\n\t\t\t\t\t\t\t\theatLayerActiu.options.tipus = capa.layer.options.tipus;\r\n\t\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\r\n\t\t//\t\t\t\t\t\tmap.addLayer(heatLayerActiu);Comentat per control de un heatmap actiu alhora\r\n\t\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\r\n\t\t//\t\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).click();\r\n\t\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\r\n\t\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\r\n\t\t\t}else{\r\n\t\t\t\theatLayerActiu.options.businessId = -1;\r\n\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\r\n\t\t\t\theatLayerActiu.options.tipus = capa.layer.options.tipus;\r\n\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\t\t\r\n\t\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\r\n\t\t//\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t}\t\r\n\t}\r\n\t\r\n}\r\n\r\nfunction loadDOHeatmapLayer(layer, dfd){\r\n\t//console.debug(layer);\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tvar estil_do = retornaEstilaDO(options.dataset);\r\n\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\t\r\n\t\r\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\r\n\t\tonEachFeature : popUp,\r\n\t\tnom : layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tdataset: options.dataset,\r\n\t\tbusinessId : layer.businessId,\r\n\t\tdataType : \"jsonp\",\r\n\t\tzIndex: parseInt(layer.capesOrdre),\r\n\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\treturn L.circleMarker(latlng, estil_do);\r\n\t\t}\t\r\n\t});\r\n\t\r\n\tcapaDadaOberta.on('data:loaded', function(e){\r\n\t\t//console.debug(\"data:loaded\");\r\n\t\t\r\n\t\tvar arrP=[];\r\n\t\tcapaDadaOberta.eachLayer(function(layer){\r\n\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\r\n\t\t\tarrP.push(d);\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\t\tgradient: {\t\t\t\r\n\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t1: \"#720404\"\r\n\t\t\t\t}\t\r\n\t\t});\r\n\t\t\r\n\t\theatLayerActiu.options.businessId = layer.businessId;\r\n\t\theatLayerActiu.options.nom = layer.serverName;\r\n\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\r\n\t\theatLayerActiu.options.tipus = layer.serverType;\r\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\r\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t}\r\n\t\t\r\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\r\n//\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t\t\r\n\t\tif(dfd){\r\n\t\t\ttry{\r\n\t\t\t\tdfd.resolve();\r\n\t\t\t}catch(e){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction loadJsonHeatmapLayer(layer){\r\n\tconsole.debug(\"loadJsonHeatmapLayer\");\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\r\n\tvar v_respotaJSON;\r\n\tgetJSONPServei(layer.url).then(function(results) {\r\n\t\tvar op = [];\r\n\t\tif (jQuery.isArray(results)) {\r\n\t\t\tv_respotaJSON = results;\r\n\t\t} else {\r\n\t\t\tfor (key in results) {\r\n\t\t\t\tif (jQuery.isArray(results[key])) {\r\n\t\t\t\t\tv_respotaJSON = results[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!jQuery.isArray(v_respotaJSON)) {\r\n\t\t\talert(window.lang.translate(\"No s'ha interpretat bé l'estructura del JSON\"));\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar arrP=[];\r\n\t\t\r\n\t\tfor (key in v_respotaJSON) {\r\n\t\t\tvar lat = v_respotaJSON[key][options.y];\r\n\t\t\tvar lon = v_respotaJSON[key][options.x];\r\n\t\t\tvar d =[parseFloat(lat),parseFloat(lon),1];\t\r\n\t\t\tarrP.push(d);\r\n\t\t}\r\n\t\t\r\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\t\tgradient: {\t\t\t\r\n\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t1: \"#720404\"\r\n\t\t\t\t}\t\r\n\t\t});\r\n\t\t\r\n\t\theatLayerActiu.options.businessId = layer.businessId;\r\n\t\theatLayerActiu.options.nom = layer.serverName;\r\n\t\theatLayerActiu.options.zIndex = layer.capesOrdre;\r\n\t\theatLayerActiu.options.tipus = layer.serverType;\r\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\r\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t}\r\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\r\n\t\tactivaPanelCapes(true);\r\n\t\tconsole.debug(\"FI loadJsonHeatmapLayer\");\r\n\t});\r\n}\r\n\r\n\r\nfunction loadTematicHeatmap(layer, zIndex, layerOptions, capesActiva){\r\n\t\r\n\tvar options = jQuery.parseJSON(layerOptions);\r\n\t\r\n\tvar arrP=[];\r\n\t$.each(layer.geometries.features.features, function(i, feature) {\r\n\t\tconsole.debug(feature.geometry);\r\n\t\tvar d =[feature.geometry.coordinates[1],feature.geometry.coordinates[0],1];\t\r\n\t\tarrP.push(d);\t\t\t\r\n\t});\r\n\t\r\n\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\tgradient: {\t\t\t\r\n\t\t\t0.35: \"#070751\",\r\n\t\t\t0.40: \"#0095DE\",\r\n\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t0.55: \"#00B43F\",\r\n\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t0.61: \"#FFF800\",\r\n\t\t\t0.65: \"#FF9700\",\r\n\t\t\t0.70: \"#FF0101\",\r\n\t\t\t1: \"#720404\"\r\n\t\t\t}\t\r\n\t});\t\r\n\t\r\n\theatLayerActiu.options.businessId = layer.businessId;\r\n\theatLayerActiu.options.nom = layer.nom;\r\n\theatLayerActiu.options.zIndex = parseInt(zIndex);\r\n\theatLayerActiu.options.tipus = t_tematic;\r\n\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\r\n//\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n//\t\tmap.addLayer(heatLayerActiu);\r\n//\t}\r\n\t\r\n\tif (capesActiva.indexOf(\"false\")==-1){\r\n\t\tmap.addLayer(heatLayerActiu);\r\n\t}\r\n\t\r\n\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\r\n//\tcontrolCapes._lastZIndex++;\r\n\tactivaPanelCapes(true);\t\t\r\n\t\r\n}\r\n\r\nfunction loadVisualitzacioHeatmap(layer, zIndex, layerOptions, capesActiva, dfd){\r\n\t\r\n\t//var options = jQuery.parseJSON(layerOptions);\r\n\t\r\n\tvar options; \r\n\tif(typeof (layerOptions)==\"string\"){\t\r\n\t\ttry {\r\n\t\t\toptions = JSON.parse(layerOptions);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\toptions = layerOptions;\t\t\r\n\t\t}\r\n\t}else{\t\t\t\r\n\t\toptions = layerOptions;\t\r\n\t}\r\n\t\r\n\t\r\n\tvar businessId;\r\n\tif (layer.geometriesBusinessId){\r\n\t\tbusinessId=layer.geometriesBusinessId\r\n\t}\r\n\telse businessId=options.origen;\r\n\tvar data = {\r\n\t\t\tbusinessId: businessId,//businessId id de la visualización de origen\r\n\t\t\tuid: Cookies.get('uid')//uid id de usuario\r\n\t\t};\t\r\n\t\r\n\t//Carrego llistat geometries\r\n\tgetGeometriesColleccioByBusinessId(data).then(function(results){\r\n\t\tif(results.status == 'OK'){\r\n\t\t\t\r\n\t\t\tvar arrP=[];\r\n\t\t\t$.each(results.geometries.geometria.features, function(i, feature) {\r\n\t\t\t\tif (feature.geometry.type==\"MultiPoint\"){\r\n\t\t\t\t\t$.each(feature.geometry.coordinates, function(j, coord) {\t\r\n\t\t\t\t\t\tvar d =[coord[1],coord[0],1];\t\r\n\t\t\t\t\t\tarrP.push(d);\t\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tvar d =[feature.geometry.coordinates[1],feature.geometry.coordinates[0],1];\t\r\n\t\t\t\t\tarrP.push(d);\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t//console.debug(arrP);\r\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\r\n\t\t\t\tgradient: {\t\t\t\r\n\t\t\t\t\t0.35: \"#070751\",\r\n\t\t\t\t\t0.40: \"#0095DE\",\r\n\t\t\t\t\t0.45: \"#02D5FF\",\r\n\t\t\t\t\t0.50: \"#02E0B9\",\r\n\t\t\t\t\t0.55: \"#00B43F\",\r\n\t\t\t\t\t0.60: \"#97ED0E\",\r\n\t\t\t\t\t0.61: \"#FFF800\",\r\n\t\t\t\t\t0.65: \"#FF9700\",\r\n\t\t\t\t\t0.70: \"#FF0101\",\r\n\t\t\t\t\t1: \"#720404\"\r\n\t\t\t\t\t}\t\r\n\t\t\t});\t\r\n\t\t\t\r\n\t\t\theatLayerActiu.options.businessId = layer.businessId;\r\n\t\t\theatLayerActiu.options.nom = layer.nom;\r\n\t\t\theatLayerActiu.options.zIndex = parseInt(zIndex);\r\n\t\t\theatLayerActiu.options.tipus = t_visualitzacio;\r\n\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\r\n\t\t\t\r\n//\t\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n//\t\t\t\tmap.addLayer(heatLayerActiu);\r\n//\t\t\t}\r\n\t\t\t\r\n\t\t\tif (capesActiva!=undefined && capesActiva.indexOf(\"false\")==-1){\r\n\t\t\t\tmap.addLayer(heatLayerActiu);\r\n\t\t\t}\r\n\t\t\telse if (capesActiva==undefined) map.addLayer(heatLayerActiu);\r\n\t\t\t\r\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\r\n//\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\tactivaPanelCapes(true);\r\n\t\t\t\r\n\t\t\tif(dfd){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tdfd.resolve();\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\t\r\n$.publish('analyticsEvent',{event:['error', 'getGeometriesColleccioByBusinessId']});\t\t\t\r\n\t\t}\r\n\t},function(results){\r\n\t\t//TODO error\r\n\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\r\n\t\t$.publish('analyticsEvent',{event:['error', 'getGeometriesColleccioByBusinessId']});\r\n\t});\t\r\n}\r\n\r\n","function creaClusterMap(capa) {\r\n\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'cluster', 1]});\r\n\r\n\t\r\n\tvar nom = window.lang.translate(\"Agrupació\");\r\n\t\r\n\tvar clusterLayer = L.markerClusterGroup({\r\n\t\tsingleMarkerMode : true\r\n\t});\r\n\t\r\n\tif(typeof url('?businessid') == \"string\"){\r\n\t\tvar data;\r\n\t\t//Si capa origen dades obertes, creem nova capa\r\n\t\tif(capa.layer.options.tipus == t_dades_obertes){\r\n\t\t\t\r\n\t\t\tdata = {\r\n\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n\t\t\t\t\tserverType: t_dades_obertes,\r\n\t\t\t\t\tcalentas: false,\r\n\t\t            activas: true,\r\n\t\t            visibilitats: true,\r\n\t\t            order: capesOrdre_sublayer,\r\n\t\t            epsg: '4326',\r\n\t\t            imgFormat: 'image/png',\r\n\t\t            infFormat: 'text/html',\r\n\t\t            tiles: true,\t            \r\n\t\t            transparency: true,\r\n\t\t            opacity: 1,\r\n\t\t            visibilitat: 'O',\r\n\t\t            calentas: false,\r\n\t\t            activas: true,\r\n\t\t            visibilitats: true,\r\n\t\t            options: '{\"dataset\":\"'+capa.layer.options.dataset+'\",\"tem\":\"'+tem_cluster+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\r\n\t\t\t};\t\r\n\t\t\t\r\n\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\r\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\r\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\r\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\r\n\t\t\t\t\t});\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\r\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\r\n\t\t\t\t\tclusterLayer.options.tipus = t_dades_obertes;\r\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\t\t\t\tmap.addLayer(clusterLayer);\r\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\r\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\r\n//\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n//\t\t\t\t\t\t   advanced:{\r\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\r\n//\t\t\t\t\t\t     updateOnContentResize: true\r\n//\t\t\t\t\t\t   }           \r\n//\t\t\t\t\t});\t\t\t\t\t\t\r\n\r\n//\t\t\t\t\tmap.removeLayer(capa.layer);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug('error create server in map');\r\n\t\t\t\t}\r\n\t\t\t});\t\t\t\t\r\n\t\t\t//tipus json\r\n\t\t}else if(capa.layer.options.tipus == t_url_file){\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar options = {\r\n\t\t\t\t\turl: capa.layer.options.url,//capaMare.options.url,\r\n\t\t\t\t\ttem: tem_cluster,\r\n\t\t\t\t\torigen: capa.layer.options.businessId,\r\n\t\t\t\t\ttipus : t_url_file,\r\n//\t\t\t\t\tbusinessId : '-1',\r\n\t\t\t\t\ttipusFile: capa.layer.options.tipusFile,\r\n//\t\t\t\t\testil_do: estil_do,\r\n\t\t\t\t\tepsgIN: capa.layer.options.epsgIN,\r\n\t\t\t\t\tgeometryType: capa.layer.options.geometryType,\r\n\t\t\t\t\tcolX: capa.layer.options.colX,\r\n\t\t\t\t\tcolY: capa.layer.options.colY,\r\n\t\t\t\t\tdinamic: capa.layer.options.dinamic\r\n\t\t\t\t};\r\n\t\t\t\r\n//\t\t\t\tconsole.debug(options);\t\t\t\r\n\t\t\t\r\n\t\t\tvar data = {\r\n\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n//\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\tserverType: capa.layer.options.tipus,\r\n\t\t\t\t\tcalentas: false,\r\n\t\t            activas: true,\r\n\t\t            visibilitats: true,\r\n\t\t            order: capesOrdre_sublayer,\t\t\t\t\r\n\t\t            epsg: capa.layer.options.epsgIN,\r\n\t\t            imgFormat: 'image/png',\r\n\t\t            infFormat: 'text/html',\r\n//\t\t            tiles: true,\t            \r\n\t\t            transparency: true,\r\n\t\t            opacity: 1,\r\n\t\t            visibilitat: 'O',\r\n\t\t            url: capa.layer.options.url,//capaMare.options.url,\r\n\t\t\t\t\toptions: JSON.stringify(options)\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\r\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\r\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\r\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\r\n\t\t\t\t\t});\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\r\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\r\n\t\t\t\t\tclusterLayer.options.tipus = t_url_file;\r\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\t\t\t\tmap.addLayer(clusterLayer);\r\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\r\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\r\n\r\n\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug('error create server in map');\r\n\t\t\t\t}\r\n\t\t\t});\t\t\t\t\r\n\t\t\t//tipus json\r\n\t\t}else if(capa.layer.options.tipus == t_json){\r\n\t\t\t\r\n\t\t\tvar data = {\r\n\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\r\n\t\t\t\tserverType: t_json,\r\n\t\t\t\tcalentas: false,\r\n\t\t\t    activas: true,\r\n\t\t\t    visibilitats: true,\r\n\t\t\t    order: capesOrdre_sublayer,\r\n\t\t\t    epsg: '4326',\r\n\t\t\t    imgFormat: 'image/png',\r\n\t\t\t    infFormat: 'text/html',\r\n\t\t\t    tiles: true,\t            \r\n\t\t\t    transparency: true,\r\n\t\t\t    opacity: 1,\r\n\t\t\t    visibilitat: 'O',\r\n\t\t\t    url: capa.layer.options.url,\r\n\t\t\t    calentas: false,\r\n\t\t\t    activas: true,\r\n\t\t\t    visibilitats: true,\r\n\t\t\t    options: '{\"x\":\"'+capa.layer.options.options.x+'\", \"y\":\"'+capa.layer.options.options.y+'\",\"titol\":\"'+capa.layer.options.options.titol+'\",\"descripcio\":\"'+capa.layer.options.options.descripcio+'\", \"imatge\":\"'+capa.layer.options.options.imatge+'\",\"vincle\":\"'+capa.layer.options.options.vincle+'\",\"tem\":\"'+tem_cluster+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\r\n\t\t\t};\t\t\t\r\n\t\t\t\r\n\t\t\tcreateServidorInMap(data).then(function(results){\r\n\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\r\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\r\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\r\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\r\n\t\t\t\t\t});\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\r\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\r\n\t\t\t\t\tclusterLayer.options.tipus = t_json;\r\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\t\t\t\tmap.addLayer(clusterLayer);\r\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\r\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\r\n//\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\r\n//\t\t\t\t\t\t   advanced:{\r\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\r\n//\t\t\t\t\t\t     updateOnContentResize: true\r\n//\t\t\t\t\t\t   }           \r\n//\t\t\t\t\t});\t\r\n\r\n//\t\t\t\t\tmap.removeLayer(capa.layer);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.debug(\"Error add cluster JSON\");\r\n\t\t\t\t}\r\n\t\t\t});\t\r\n\r\n\t\t}else if (capa.layer.options.tipus == t_visualitzacio){\r\n\t\t\tvar data = {\r\n\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\r\n\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t            nom: capa.layer.options.nom+\" \"+nom,//nom nombre de la nueva visualizacion\r\n\t\t            activas: true,\r\n\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\ttem: tem_cluster//tem_heatmap\r\n//\t\t            estils: JSON.stringify(rangs[0])\r\n\t\t\t\t};\t\r\n\t\t\t\t\r\n\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\r\n\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\r\n\t\t\t\t\t\t\tconsole.debug(layer);\r\n\t\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\t\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tvar html='';\r\n\t\t\t\t\t\t\t$.each( layer.properties.data, function( key, value ) {\r\n\t\t\t\t\t\t\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\r\n\t\t\t\t\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \r\n\t\t\t\t\t\t\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \r\n\t\t\t\t\t\t\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\r\n\t\t\t\t\t\t\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\r\n\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\r\n\t\t\t\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\r\n\t\t\t\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\r\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\r\n\t\t\t\t\t\t\t\t\t\t\t\t'</div>';\r\n\t\t\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\r\n\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\thtml+= '</div>';\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tmarker.bindPopup(html);\r\n\t\t\t\t\t\t\t//marker.bindPopup(\"<b>\"+layer.properties.data.nom+\"</b><br><b>\"+layer.properties.data.text+\"</b>\");\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tclusterLayer.addLayer(marker);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tclusterLayer.options.businessId = results.layer.businessId;\r\n\t\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\r\n\t\t\t\t\t\tclusterLayer.options.tipus = capa.layer.options.tipus;\r\n\t\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tmap.addLayer(clusterLayer);\r\n\t\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\r\n\t\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\r\n//\t\t\t\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t},function(results){\r\n\t\t\t\t\t//TODO error\r\n\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\r\n\t\t\t\t});\t\t\t\r\n\t\t}\r\n\t\telse if (capa.layer.options.tipus == t_vis_wms){\r\n\t\t\tvar instamapsWms = InstamapsWms({\r\n\t\t\t\tloadTemplateParam :false});\r\n\t\t\tvar dataWMS = {url: capa.layer._url};\r\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\r\n\t\t\t\tvar layers = [];\r\n\t\t\t\tlayers=results.Capability.Layer.Layer;\r\n\t\t\t\tfor (var i=0;i<layers.length;i++){\r\n\t\t\t\t\tvar layer = layers[i];\r\n\t\t\t\t\tif (layers[i].Name.indexOf(\"cluster\")>-1) {\r\n\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\r\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t\t            nom: layers[i].Name,//nom nombre de la nueva visualizacion\r\n\t\t\t\t\t            activas: true,\r\n\t\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\t\t\t\ttem: tem_heatmap,\r\n\t\t\t\t\t\t\t\tserverType: tem_cluster_wms,//tem_cluster\r\n\t\t\t\t\t\t\t\turl: capa.layer._url\r\n//\t\t\t\t\t            estils: JSON.stringify(rangs[0])\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\r\n\t\t\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(results.layer);\r\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\r\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", false );\r\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\r\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\r\n\t\t\t\t\t\t\t\tactivaPanelCapes(true);\t\r\n\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\t\t//TODO error\r\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t}else{\r\n\t\t\r\n\t\tclusterLayer.options.businessId = '-1';\r\n\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\r\n\t\tclusterLayer.options.tipus = capa.layer.options.tipus;\r\n\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\tmap.addLayer(clusterLayer);\r\n\t\tclusterLayer.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex + 1;\r\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\r\n//\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\r\n\t\t//Desactivem la capa mare\r\n\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\r\n//\t\t$(\".layers-list\").mCustomScrollbar({\r\n//\t\t\t   advanced:{\r\n//\t\t\t     autoScrollOnFocus: false,\r\n//\t\t\t     updateOnContentResize: true\r\n//\t\t\t   }           \r\n//\t\t});\t\t\t\r\n\t}\t\r\n}\r\n\r\nfunction loadDadesObertesClusterLayer(layer, dfd){\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\tvar estil_do = retornaEstilaDO(options.dataset);\r\n\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\t\r\n\t\r\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\r\n\t\tonEachFeature : popUp,\r\n\t\tnom : layer.serverName,\r\n\t\ttipus : layer.serverType,\r\n\t\tdataset: options.dataset,\r\n\t\tbusinessId : layer.businessId,\r\n\t\tdataType : \"jsonp\",\r\n\t\tzIndex: parseInt(layer.capesOrdre),\r\n\t\tpointToLayer : function(feature, latlng) {\r\n\t\t\treturn L.circleMarker(latlng, estil_do);\r\n\t\t}\t\r\n\t});\r\n\t\r\n//\tmap.addLayer(capaDadaOberta);\r\n\tcapaDadaOberta.on('data:loaded', function(e){\r\n\t\t//console.debug(\"data:loaded\");\r\n\t\tmap.removeLayer(capaDadaOberta);\r\n\t\tvar clusterLayer = L.markerClusterGroup({\r\n\t\t\tsingleMarkerMode : true\r\n\t\t});\r\n\t\t\r\n\t\tcapaDadaOberta.eachLayer(function(layer) {\r\n\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\r\n\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t});\r\n\t\t\tmarker.bindPopup(layer._popup._content);\r\n\t\t\tclusterLayer.addLayer(marker);\r\n\t\t});\t\r\n\t\t\r\n\t\tclusterLayer.options.businessId = layer.businessId;\r\n\t\tclusterLayer.options.nom = layer.serverName;\r\n\t\tclusterLayer.options.zIndex = layer.capesOrdre;\r\n\t\tclusterLayer.options.tipus = layer.serverType;\r\n\t\tclusterLayer.options.dataset = options.dataset;\r\n\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tmap.addLayer(clusterLayer);\r\n\t\t}\r\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\r\n//\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\t\t\r\n\t\t\r\n\t\tif(dfd){\r\n\t\t\ttry{\r\n\t\t\t\tdfd.resolve();\r\n\t\t\t}catch(e){\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t});\t\r\n}\r\n\r\n\r\nfunction loadJsonClusterLayer(layer){\r\n\t\r\n\tvar options = jQuery.parseJSON( layer.options );\r\n\r\n\tvar v_respotaJSON;\r\n\tgetJSONPServei(layer.url).then(function(results) {\r\n\t\tvar op = [];\r\n\t\tif (jQuery.isArray(results)) {\r\n\t\t\tv_respotaJSON = results;\r\n\t\t} else {\r\n\t\t\tfor (key in results) {\r\n\t\t\t\tif (jQuery.isArray(results[key])) {\r\n\t\t\t\t\tv_respotaJSON = results[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!jQuery.isArray(v_respotaJSON)) {\r\n\t\t\talert(window.lang.translate(\"No s'ha interpretat bé l'estructura del JSON\"));\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tvar clusterLayer = L.markerClusterGroup({\r\n\t\t\tsingleMarkerMode : true\r\n\t\t});\t\t\r\n\t\t\r\n\t\tfor (key in v_respotaJSON) {\r\n\t\t\t\r\n\t\t\tvar lat = v_respotaJSON[key][options.y];\r\n\t\t\tvar lon = v_respotaJSON[key][options.x];\r\n\t\t\tvar pp = L.marker(new L.LatLng(parseFloat(lat), parseFloat(lon)), {\r\n\t\t\t\ttitle : layer._leaflet_id\r\n\t\t\t});\r\n//\t\t\tmarker.bindPopup(layer._popup._content);\r\n//\t\t\tvar pp = L.circleMarker([ lat, lon ], estil_do);\r\n\r\n\t\t\tpp.properties = {};\r\n\t\t\tvar empty = true;\r\n\t\t\tif (options.titol == \"null\") {\r\n\t\t\t\tpp.properties.nom = \"\"\r\n\t\t\t} else {\r\n\t\t\t\tpp.properties.nom = v_respotaJSON[key][options.titol];\r\n\t\t\t\tempty = empty && false;\r\n\t\t\t}\r\n\t\t\tif (options.descripcio == \"null\") {\r\n\t\t\t\tpp.properties.text = \"\"\r\n\t\t\t} else {\r\n\t\t\t\tpp.properties.text = v_respotaJSON[key][options.descripcio];\r\n\t\t\t\tempty = empty && false;\r\n\t\t\t}\r\n\t\t\tif (options.imatge == \"null\") {\r\n\t\t\t\tpp.properties.img = \"\"\r\n\t\t\t} else {\r\n\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\r\n\t\t\t\t\t\t+ v_respotaJSON[key][options.imatge] + '\">';\r\n\t\t\t\tempty = empty && false;\r\n\t\t\t}\r\n\t\t\tif (options.vincle == \"null\") {\r\n\t\t\t\tpp.properties.vincle = \"\"\r\n\t\t\t} else {\r\n\t\t\t\tpp.properties.vincle = '<a href=\"'\r\n\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle]\r\n\t\t\t\t\t\t+ '\" target=\"_blank\">'\r\n\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle] + '</a>';\r\n\t\t\t\tempty = empty && false;\r\n\t\t\t}\r\n\r\n\t\t\tif(!empty){\r\n\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div id='text-popup-json'>\"\r\n\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\r\n\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\r\n\t\t\t\t\t\t+ \"</div>\");\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tclusterLayer.addLayer(pp);\r\n\t\t}\r\n\t\t\r\n\t\tclusterLayer.options.businessId = layer.businessId;\r\n\t\tclusterLayer.options.nom = layer.serverName;\r\n\t\tclusterLayer.options.zIndex = layer.capesOrdre;\r\n\t\tclusterLayer.options.tipus = layer.serverType;\r\n\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\r\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\r\n\t\t\tmap.addLayer(clusterLayer);\r\n\t\t}\r\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\r\n//\t\tcontrolCapes._lastZIndex++;\r\n\t\tactivaPanelCapes(true);\t\r\n\r\n\t});\r\n}\r\n\r\nfunction loadTematicCluster(layer, zIndex, layerOptions, capesActiva){\r\n\t\r\n\tvar options = jQuery.parseJSON(layerOptions);\r\n\t\r\n\tvar clusterLayer = L.markerClusterGroup({\r\n\t\tsingleMarkerMode : true\r\n\t});\t\r\n\t\r\n\t$.each(layer.geometries.features.features, function(i, feature) {\r\n\t\tvar marker = L.marker(new L.LatLng(feature.geometry.coordinates[1],feature.geometry.coordinates[0]), {\r\n\t\t\t//title : layer._leaflet_id\r\n\t\t});\r\n\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\r\n\t\tclusterLayer.addLayer(marker);\r\n\t});\r\n\t\r\n\tclusterLayer.options.businessId = layer.businessId;\r\n\tclusterLayer.options.nom =layer.nom;\r\n\tclusterLayer.options.zIndex = parseInt(zIndex);\r\n\tclusterLayer.options.tipus = t_tematic;\r\n\tclusterLayer.options.tipusRang = tem_cluster;\r\n\t\r\n\tif (capesActiva.indexOf(\"false\")==-1){\r\n\t\tmap.addLayer(clusterLayer);\r\n\t}\t\t\r\n\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\tcontrolCapes.addOverlay(clusterLayer,\tclusterLayer.options.nom, true, origen);\r\n//\tcontrolCapes._lastZIndex++;\r\n\tactivaPanelCapes(true);\t\t\r\n}\r\n\r\nfunction loadVisualitzacioCluster(layer, zIndex, layerOptions, capesActiva, dfd){\r\n\tvar options; \r\n\tif(typeof (layerOptions)==\"string\"){\t\r\n\t\ttry {\r\n\t\t\toptions = JSON.parse(layerOptions);\r\n\t\t}\r\n\t\tcatch (err) {\r\n\t\t\toptions = layerOptions;\t\t\r\n\t\t}\r\n\t}else{\t\t\t\r\n\t\toptions = layerOptions;\t\r\n\t}\r\n\r\n\tvar businessId;\r\n\tif (layer.geometriesBusinessId){\r\n\t\tbusinessId=layer.geometriesBusinessId\r\n\t}\r\n\telse businessId=options.origen;\r\n\t\r\n\tvar data = {\r\n\t\t\tbusinessId: businessId,//businessId id de la visualización de origen\r\n\t\t\tuid: Cookies.get('uid')//uid id de usuario\r\n\t\t};\t\r\n\t\r\n\t//Carrego llistat geometries\r\n\tgetGeometriesColleccioByBusinessId(data).then(function(results){\r\n\t\tif(results.status == 'OK'){\r\n\t\t\t\r\n\t\t\tvar clusterLayer = L.markerClusterGroup({\r\n\t\t\t\tsingleMarkerMode : true\r\n\t\t\t});\t\t\t\t\r\n\t\t\t\r\n\t\t\tvar arrP=[];\r\n\t\t\t$.each(results.geometries.geometria.features, function(i, feature) {\r\n\t\t\t\tif (feature.geometry.type==\"MultiPoint\"){\r\n\t\t\t\t\t$.each(feature.geometry.coordinates, function(j, coord) {\t\r\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(coord[1],coord[0]), {\r\n\t\t\t\t\t\t\t//title : layer._leaflet_id\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\r\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\t\t\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tvar marker = L.marker(new L.LatLng(feature.geometry.coordinates[1],feature.geometry.coordinates[0]), {\r\n\t\t\t\t\t\t//title : layer._leaflet_id\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\r\n\t\t\t\t\tclusterLayer.addLayer(marker);\t\t\t\t\r\n\t\t\t\t}\t\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tclusterLayer.options.businessId = layer.businessId;\r\n\t\t\tclusterLayer.options.nom =layer.nom;\r\n\t\t\tclusterLayer.options.zIndex = parseInt(zIndex);\r\n\t\t\tclusterLayer.options.tipus = t_visualitzacio;\r\n\t\t\tclusterLayer.options.tipusRang = tem_cluster;\r\n\t\t\t\r\n\t\t\tif (capesActiva!=undefined && capesActiva.indexOf(\"false\")==-1){\r\n\t\t\t\tmap.addLayer(clusterLayer);\r\n\t\t\t}\t\t\r\n\t\t\telse if (capesActiva==undefined) map.addLayer(clusterLayer);\r\n\t\t\t\r\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\r\n\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\r\n//\t\t\tcontrolCapes._lastZIndex++;\r\n\t\t\tactivaPanelCapes(true);\t\r\n\t\t\t\r\n\t\t\tif(dfd){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tdfd.resolve();\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\t\t\t\t\t\r\n\t\t}\r\n\t},function(results){\r\n\t\t//TODO error\r\n\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\r\n\t});\t\r\n}\r\n","var context,\r\n    newCanvas,\r\n    objLLegenda = null,\r\n    ldpercent_img = 0,\r\n    matriuCapesLL = {\r\n        layers: [],\r\n        n_layers: [],\r\n        id_layers: [],\r\n        t_layers: [],\r\n        c_layers: []\r\n    };\r\n\r\nfunction comportamentCaptura(inicial, titol, text_progress) {\r\n    if (inicial == 0) {\r\n        ldpercent_img = 0;\r\n        jQuery('.bt_desc_img').hide();\r\n        jQuery('#bt_desc_ll').hide();\r\n        jQuery('#div_captura').hide();\r\n        //jQuery('#img_canvas').attr('src', '/llibreries/img/loading.gif');\r\n        jQuery('#progress_bar_carrega_img').show();\r\n        jQuery('#dialog_captura').modal('show');\r\n\r\n        jQuery('#dialog_captura_title').text(window.lang.translate(titol));\r\n        \r\n        jQuery('#div_msg_export').html(window.lang.translate(text_progress));\r\n        \r\n        \r\n        //jQuery('#dialog_captura_text').html(window.lang.translate(text_progress));\r\n\r\n        uploadprogress_img();\r\n    } else if (inicial == 1) {\r\n        jQuery('#progress_bar_carrega_img').hide();\r\n        jQuery('.bt_desc_img').show();\r\n        //jQuery('#div_captura').show();\r\n    } else if (inicial == 3) {\r\n        jQuery('#progress_bar_carrega_img').hide();\r\n        //jQuery('#bt_desc_img').show();\r\n        //jQuery('#div_captura').show();\r\n    } else if (inicial == 2) {\r\n        jQuery('#progress_bar_carrega_img').hide();\r\n        jQuery('#dialog_captura').modal('hide');\r\n    }\r\n}\r\n\r\nfunction uploadprogress_img() {\r\n    ldpercent_img += 10;\r\n    if (ldpercent_img > 100) {\r\n        ldpercent_img = 100;\r\n    }\r\n    jQuery('#prg_bar_img').css('width', ldpercent_img + \"%\");\r\n    if (ldpercent_img < 100) {\r\n        setTimeout(\"uploadprogress_img()\", 1500);\r\n    }\r\n}\r\n\r\n\r\nfunction errorCaptura() {\r\n    comportamentCaptura(2);\r\n    alert(window.lang.translate(\"Error: No es pot generar el document\"));\r\n}\r\n\r\nfunction capturaPantalla(tipus) {\r\n\t\r\n\t\r\n\t\r\n    if (estatMapa3D) {\r\n        disparaEventMapa = false;\r\n        mapaEstatNOPublicacio = false;\r\n    }\r\n    if (tipus == CAPTURA_MAPA) {\r\n        comportamentCaptura(0, 'Capturar la vista del mapa', 'Es genera una impressió de pantalla del que mostra el mapa en el moment de clicar el botó.');\r\n        ActDesPrintMode(true);\r\n        setTimeout(function() {\r\n            generaCaptura(CAPTURA_MAPA, null, null, 2);\r\n\r\n            //generaCaptura(CAPTURA_MAPA_GEOTIFF, null, null, 2);\r\n\r\n        }, 500);\r\n\r\n\r\n    } else if (tipus == CAPTURA_MAPA_GEOPACKAGE) {\r\n    \t\r\n\t\tif(checkDataVectorlayers()){\r\n\t\t\t\t\tcomportamentCaptura(0, 'Descarrega les capes vectorials en format GeoPackage', 'Es genera un arxiu GeoPackage (base de dades) que conté només les capes vectorials del mapa i els seus atributs.');\r\n\t\t\t\t\t//ActDesPrintMode(true);\r\n\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tgeneraCaptura(CAPTURA_MAPA_GEOPACKAGE, null, null, 2);\r\n\r\n\r\n\t\t\t\t\t}, 500);\r\n\t\t}\r\n    } else if (tipus == CAPTURA_MAPA_GEOTIFF) {\r\n        comportamentCaptura(0, 'Descarrega el mapa en format GeoTIFF', 'Es genera un arxiu TIF que conté coordenades -longitud i latitud -. Llegible per aplicacions de tractament d’imatge o SIG.');\r\n        ActDesPrintMode(true);\r\n        \r\n        \r\n       \r\n        \r\n        setTimeout(function() {\r\n            generaCaptura(CAPTURA_MAPA_GEOTIFF, null, null, 2);\r\n        }, 500);\r\n\r\n    } else if (tipus == CAPTURA_INFORME) {\r\n        comportamentCaptura(0, 'Imprimir la vista del mapa', 'Es genera una vista prèvia que permet imprimir el que es visualitza a pantalla dins un full A4.');\r\n        ActDesPrintMode(true);\r\n        setTimeout(function() {\r\n            generaCaptura(CAPTURA_INFORME, null, null, 2);\r\n        }, 500);\r\n    } else if (tipus == CAPTURA_GALERIA) {\r\n        ActDesPrintMode(true);\r\n        setTimeout(function() {\r\n            generaCaptura(CAPTURA_GALERIA, null, null, 2);\r\n        }, 500);\r\n    } else if (tipus == CAPTURA_GEOPDF) {\r\n        comportamentCaptura(0, 'Descarrega mapa en format GeoPDF', 'Es genera un arxiu PDF que conté capes i coordenades - longitud i latitud -.Llegible per aplicacions com Adobe Acrobat, Adobe Reader i altres.');\r\n        ActDesPrintMode(true);\r\n        setTimeout(function() {\r\n            generaCaptura(CAPTURA_GEOPDF, null, null, 2);\r\n        }, 500);\r\n    }\r\n}\r\n\r\nfunction pucPassar(item) {\r\n    var passo = false;\r\n\r\n\r\n\r\n    if (document.getElementById('input-' + item.layer.options.businessId) != null) {\r\n        if (document.getElementById('input-' + item.layer.options.businessId).checked) {\r\n            if (item.layer._map != null && item.layer.options.tipus != t_wms &&\r\n                item.layer.options.tipus != t_wms &&\r\n                item.layer.options.tipus != t_heatmap &&\r\n                item.layer.options.tipus != t_cluster &&\r\n                item.layer.options.tipus != t_size) {\r\n                passo = true;\r\n                try {\r\n                    item.layer.toGeoJSONcustom();\r\n                    passo = true;\r\n                } catch (err) {\r\n                    passo = false;\r\n                    return passo;\r\n                }\r\n\r\n\r\n                //options.geometrytype\r\n\r\n            }\r\n        } else {\r\n            passo = false;\r\n        }\r\n    }\r\n    return passo;\r\n}\r\n\r\nfunction ompleCapesMatriu(item) {\r\n    var mainColor = \"#FF0000\";\r\n    if (pucPassar(item)) {\r\n        var L_JSON = item.layer.toGeoJSONcustom();\r\n        jQuery.each(L_JSON.features, function(i, feature) {\r\n            var tipus = feature.geometry.type;\r\n            if (tipus.indexOf(\"Point\") != -1) {\r\n                if (!feature.styles.icon) {\r\n                    feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:6px);BRUSH(fc:\" + feature.styles.fillColor + \")\";\r\n                    mainColor = feature.styles.fillColor;\r\n                } else {\r\n                    var icona;\r\n                    if (feature.styles.icon.options.markerColor) {\r\n                        icona = \"/opt/geocat/maps/galeria/\" + feature.styles.icon.options.markerColor;\r\n                        mainColor = icona;\r\n                    } else {\r\n                        var ff = feature.styles.icon.options.iconUrl\r\n                        icona = \"/opt/geocat/maps/galeria/\" + ff.substring(ff.lastIndexOf(\"/\") + 1, ff.lastIndexOf(\".\"));\r\n                        mainColor = icona;\r\n                    }\r\n                    feature.properties.OGR = \"SYMBOL(c:#ff0000,id:\" + icona + \".png)\";\r\n                }\r\n            } else if (tipus.indexOf(\"Line\") != -1) { //Polyline\r\n                feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:\" + (parseInt(feature.styles.weight) + 3) + \"px)\";\r\n                mainColor = feature.styles.color;\r\n            } else if (tipus.indexOf(\"Polygon\") != -1) {\r\n                mainColor = feature.styles.fillColor;\r\n                if (!mainColor || mainColor.indexOf(\"rgba\") != -1) {\r\n                    mainColor = feature.styles.color + \"90 \";\r\n                }\r\n                feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:\" + (parseInt(feature.styles.weight) + 3) + \"px);BRUSH(fc:\" + mainColor + \")\";\r\n            } else {\r\n                feature.properties.OGR = \"PEN(c:#0000ff,w:5px);BRUSH(fc:#0000ff90)\";\r\n            }\r\n        });\r\n        try {\r\n            matriuCapesLL.layers.push(JSON.stringify(L_JSON));\r\n        } catch (Err) {\r\n            var cache = [];\r\n            matriuCapesLL.layers.push(JSON.stringify(L_JSON, function(key, value) {\r\n                if (typeof value === 'object' && value !== null) {\r\n                    if (cache.indexOf(value) !== -1) {\r\n                        // Circular reference found, discard key\r\n                        return;\r\n                    }\r\n                    // Store value in our collection\r\n                    cache.push(value);\r\n                }\r\n                return value;\r\n            }));\r\n            cache = null;\r\n        }\r\n        matriuCapesLL.n_layers.push(item.name);\r\n        matriuCapesLL.id_layers.push(item.layer.options.businessId);\r\n        var geoM = item.layer.options.geometryType ? item.layer.options.geometryType : t_marker;\r\n        matriuCapesLL.t_layers.push(geoM);\r\n        matriuCapesLL.c_layers.push(mainColor);\r\n    }\r\n}\r\n\r\nfunction getCapesVectorActives() {\r\n    matriuCapesLL.layers = [];\r\n    matriuCapesLL.n_layers = [];\r\n    matriuCapesLL.id_layers = [];\r\n    matriuCapesLL.t_layers = [];\r\n    matriuCapesLL.c_layers = [];\r\n\r\n    jQuery.each(controlCapes._layers, function(i, item) {\r\n        ompleCapesMatriu(item);\r\n        jQuery.each(item._layers, function(j, item2) {\r\n            ompleCapesMatriu(item2);\r\n        });\r\n    });\r\n    return matriuCapesLL;\r\n}\r\n\r\n\r\nfunction calculaWF() {\r\n    var d = map.getSize();\r\n    w = d.x;\r\n    h = d.y;\r\n    var topMap = jQuery('#map').position().top;\r\n    var puntIn = map.getBounds().getNorthWest();\r\n    var NW = L.CRS.EPSG3857.project(puntIn);\r\n    var SE = L.CRS.EPSG3857.project(map.getBounds().getSouthEast());\r\n    var ff_Pixels = new L.Point(0, 0);\r\n    var ff_MM = map.layerPointToLatLng(ff_Pixels);\r\n    var ff_3557 = L.CRS.EPSG3857.project(ff_MM);\r\n    var pNW_Pixels = new L.Point(0, -topMap);\r\n    var pNW = map.layerPointToLatLng(pNW_Pixels);\r\n    var FACT = parseFloat(ff_MM.lat) - parseFloat(pNW.lat);\r\n    var pNW_3557 = L.CRS.EPSG3857.project(pNW);\r\n    var FACT = parseFloat(ff_3557.y) - parseFloat(pNW_3557.y);\r\n    var _FACT = parseFloat(ff_MM.lat) - parseFloat(pNW.lat);\r\n    var pNE_Pixels = new L.Point(w, h - topMap);\r\n    var pNE = map.layerPointToLatLng(pNE_Pixels);\r\n    var pNE_3557 = L.CRS.EPSG3857.project(pNE);\r\n    var mapW = (pNE_3557.x - pNW_3557.x) / w;\r\n    var mapH = (pNW_3557.y - pNE_3557.y) / h;\r\n    var nouY = parseFloat(parseFloat(NW.y) - (parseFloat(FACT)));\r\n    var _nouY = parseFloat(parseFloat(puntIn.lat) - (parseFloat(_FACT)));\r\n    var _nouYMIN = parseFloat(parseFloat(puntIn.lat) + (parseFloat(_FACT)));\r\n    var mapW4326 = (pNE.lng - pNW.lng) / w;\r\n    var mapH4326 = (pNW.lat - pNE.lat) / h;\r\n    var WF = {};\r\n    WF.imgW = w;\r\n    WF.imgH = h;\r\n    WF.resW4326 = mapW4326;\r\n    WF.resH4326 = mapH4326;\r\n    WF.resW = mapW;\r\n    WF.resH = mapH;\r\n\r\n    /*\r\n    mapW4326=(mapW4326 - 0.000040);\r\n    mapH4326=(mapH4326 - 0.000040);\r\n    */\r\n    //WF.x=NW.x;\r\n\r\n    WF.x1 = SE.x;\r\n    WF.y1 = nouY\r\n    WF.x = NW.x;\r\n    WF.y = SE.y;\r\n\r\n    WF.x4326 = map.getBounds().getNorthWest().lng;\r\n    WF.y14326 = _nouY;\r\n    WF.x14326 = map.getBounds().getSouthEast().lng;\r\n    WF.y4326 = map.getBounds().getSouthEast().lat;\r\n\r\n    return WF;\r\n}\r\n\r\nfunction tornaLLoc(tr) {\r\n    jQuery(\".leaflet-map-pane\").css({\r\n        left: 0,\r\n        top: 0,\r\n        \"transform\": tr\r\n    });\r\n}\r\n\r\n\r\nfunction tornaLLocGeoPDF(tr) {\r\n    if (L.Browser.webkit) {\r\n        jQuery(\".leaflet-map-pane\").css({\r\n            \"transform\": tr\r\n        });\r\n    }\r\n}\r\n\r\nfunction hackCaptura() {\r\n    if (jQuery(\".leaflet-map-pane\").css(\"transform\")) {\r\n        var transform = jQuery(\".leaflet-map-pane\").css(\"transform\")\r\n        var comp = transform.split(\",\") //split up the transform matrix\r\n        var mapleft = parseFloat(comp[4]) //get left value\r\n        var maptop = parseFloat(comp[5]) //get top value\r\n        $(\".leaflet-map-pane\").css({ //get the map container. not sure if stable\r\n            \"transform\": \"none\",\r\n            \"left\": mapleft,\r\n            \"top\": maptop,\r\n        });\r\n    }\r\n    return transform;\r\n}\r\n\r\nfunction hackGeoPDF() {\r\n    if (L.Browser.webkit) {\r\n        if (jQuery(\".leaflet-map-pane\").css(\"transform\")) {\r\n            var transform = jQuery(\".leaflet-map-pane\").css(\"transform\");\r\n            var comp = transform.split(\",\") //split up the transform matrix\r\n            var mapleft = parseFloat(comp[4]) //get left value\r\n            var maptop = parseFloat(comp[5]) //get top value\r\n            $(\".leaflet-map-pane\").css({ //get the map container. not sure if stable\r\n                \"transform\": \"translate3d(0px,0px,0px)\",\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\nfunction generaCaptura(_tipusCaptura, w, h, factor) {\r\n\r\n   \r\n    map.setView([map.getCenter().lat, map.getCenter().lng], map.getZoom());\r\n    if ((!w) || (w == null)) {\r\n        var d = map.getSize();\r\n        w = d.x;\r\n        h = d.y;\r\n    }\r\n    var transform = \"\";\r\n\r\n\r\n    jQuery('#map .leaflet-marker-pane').find('div').has('.marker-cluster').attr('data-html2canvas-ignore', 'true');\r\n    jQuery('#map .leaflet-overlay-pane').find('canvas').not('.leaflet-heatmap-layer').removeAttr('data-html2canvas-ignore');\r\n    jQuery(\".leaflet-sidebar\").attr(\"data-html2canvas-ignore\", \"true\");\r\n    jQuery(\".leaflet-top.leaflet-left\").attr(\"data-html2canvas-ignore\", \"true\");\r\n    jQuery(\".leaflet-top.leaflet-right\").attr(\"data-html2canvas-ignore\", \"true\");\r\n    jQuery(\".leaflet-bottom.leaflet-left\").attr(\"data-html2canvas-ignore\", \"true\");\r\n    jQuery(\".leaflet-bottom.leaflet-right div\").attr(\"data-html2canvas-ignore\", \"true\");\r\n\r\n    if (jQuery('#dv_bt_legend').hasClass('greenfort')) {\r\n        jQuery(\"#mapLegend\").removeAttr(\"data-html2canvas-ignore\");\r\n        jQuery(\"#mapLegend div\").removeAttr(\"data-html2canvas-ignore\");\r\n    }\r\n\r\n\r\n    var divActiuCanvas = '.leaflet-map-pane';\r\n    var colorMapBackGround = jQuery('#map').css('background-color');\r\n\r\n    if (estatMapa3D) {\r\n        divActiuCanvas = '.cesium-widget';\r\n        disparaEventMapa = false;\r\n        mapaEstatNOPublicacio = false;\r\n    }\r\n    if (_tipusCaptura == CAPTURA_MAPA) {\r\n        transform = hackCaptura();\r\n        var snd = new Audio(\"/llibreries/sons/camera.wav\"); // buffers\r\n        snd.play();\r\n        html2canvas(jQuery(divActiuCanvas), {\r\n            onrendered: function(canvas) {\r\n                ActDesPrintMode(false);\r\n\r\n\r\n                var imgData = canvas.toDataURL('image/png', 0.92);\r\n                imgData = JSON.stringify(imgData.replace(\r\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n                uploadImageBase64(imgData).then(\r\n                    function(results) {\r\n                        if (results.status == \"OK\") {\r\n                            var urlIMG = paramUrl.urlgetMapImage +\r\n                                \"&request=getCaptura&uuid=\" +\r\n                                results.UUID;\r\n                            capturaLlegenda(true);\r\n                            comportamentCaptura(1);\r\n                            var $desc_img = jQuery('#dialog_captura').find('.desc_img');\r\n\r\n                            $desc_img.prop('href', urlIMG);\r\n\r\n                            $desc_img.prop('download', 'mapa_captura.png');\r\n                            //$desc_img.html(\"Desar mapa\" +\" <i class='fa fa-picture-o'></i>\");\r\n                            //jQuery('#dialog_captura').find('.bt_desc_img').show();\r\n                            tornaLLoc(transform);\r\n                            if (estatMapa3D) {\r\n                                mapaEstatNOPublicacio = true;\r\n                            }\r\n                        } else {\r\n                            errorCaptura();\r\n                        }\r\n                        imgData = \"\";\r\n                    });\r\n            },\r\n            useCORS: true,\r\n            allowTaint: false,\r\n            proxy: paramUrl.urlgetImageProxy,\r\n            background: colorMapBackGround,\r\n            width: w,\r\n            height: h,\r\n            logging: false\r\n        });\r\n\r\n\r\n    } else if (_tipusCaptura == CAPTURA_MAPA_GEOTIFF) {\r\n        transform = hackCaptura();\r\n        var data = calculaWF();\r\n        html2canvas(jQuery(divActiuCanvas), {\r\n            onrendered: function(canvas) {\r\n                ActDesPrintMode(false);\r\n\r\n\r\n                var imgData = canvas.toDataURL('image/png', 0.92);\r\n                imgData = JSON.stringify(imgData.replace(\r\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n                uploadImageBase64(imgData).then(\r\n                    function(results) {\r\n                        if (results.status == \"OK\") {\r\n                            var urlIMG = paramUrl.urlgetMapImage +\r\n                                \"&request=getCapturaGeoTiff&uuid=\" +\r\n                                results.UUID +\r\n                                \"&resW=\" + data.resW +\r\n                                \"&resH=\" + data.resH +\r\n                                \"&x=\" + data.x +\r\n                                \"&y=\" + data.y +\r\n                                \"&x1=\" + data.x1 +\r\n                                \"&y1=\" + data.y1 +\r\n                                \"&resW4326=\" + data.resW4326 +\r\n                                \"&resH4326=\" + data.resH4326 +\r\n                                \"&x4326=\" + data.x4326 +\r\n                                \"&y4326=\" + data.y4326 +\r\n                                \"&x14326=\" + data.x14326 +\r\n                                \"&y14326=\" + data.y14326 +\r\n                                \"&entitatUid=\" + mapConfig.entitatUid + \"&businessId=\" + mapConfig.businessId;\r\n                            capturaLlegenda(true);\r\n                            comportamentCaptura(1);\r\n                            var $desc_img = jQuery('#dialog_captura').find('.desc_img');\r\n\r\n                            $desc_img.prop('href', urlIMG);\r\n\r\n                            $desc_img.prop('download', 'mapa_geo.tiff');\r\n\r\n                            tornaLLoc(transform);\r\n                            if (estatMapa3D) {\r\n                                mapaEstatNOPublicacio = true;\r\n                            }\r\n                        } else {\r\n                            errorCaptura();\r\n                        }\r\n                        imgData = \"\";\r\n                    });\r\n            },\r\n            useCORS: true,\r\n            allowTaint: false,\r\n            proxy: paramUrl.urlgetImageProxy,\r\n            background: colorMapBackGround,\r\n            width: w,\r\n            height: h,\r\n            logging: false\r\n        });\r\n\r\n\r\n\r\n    } else if (_tipusCaptura == CAPTURA_GALERIA) {\r\n        transform = hackCaptura();\r\n        html2canvas(jQuery(divActiuCanvas), {\r\n            onrendered: function(canvas) {\r\n                ActDesPrintMode(false);\r\n                var imgCaptura = canvas.toDataURL('image/jpeg', 0.50);\r\n                imgCaptura = JSON.stringify(imgCaptura.replace(\r\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n                tornaLLoc(transform);\r\n                try {\r\n                    map.spin(false);\r\n                } catch (Err) {}\r\n                uploadImageBase64(imgCaptura).then(\r\n                    function(results) {\r\n                        if (results.status == \"OK\") {\r\n                            var urlIMG = paramUrl.urlgetMapImage +\r\n                                \"&request=getGaleria&update=true&businessid=\" +\r\n                                mapConfig.businessId + \"&uuid=\" + results.UUID;\r\n                            var img = document.createElement('img');\r\n                            img.src = urlIMG;\r\n                            tornaLLoc(transform);\r\n                        } else {\r\n                            //alert(\"Error\");\r\n                        }\r\n                        imgCaptura = \"\";\r\n                    });\r\n            },\r\n            useCORS: true,\r\n            allowTaint: false,\r\n            proxy: paramUrl.urlgetImageProxy,\r\n            background: colorMapBackGround,\r\n            width: parseInt(w),\r\n            height: parseInt(h),\r\n            logging: false\r\n        });\r\n    } else if (_tipusCaptura == CAPTURA_INFORME) {\r\n        transform = hackCaptura();\r\n        html2canvas(jQuery(divActiuCanvas), {\r\n            onrendered: function(canvas) {\r\n                ActDesPrintMode(false);\r\n                var imgData = canvas.toDataURL('image/jpeg', 0.72);\r\n                imgData = JSON.stringify(imgData.replace(\r\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n                uploadImageBase64(imgData).then(\r\n                    function(results) {\r\n                        if (results.status == \"OK\") {\r\n                            var urlIMG = paramUrl.urlgetMapImage +\r\n                                \"&request=getCaptura&uuid=\" +\r\n                                results.UUID;\r\n                            jQuery('#img_canvas').attr('src', urlIMG);\r\n                            capturaLlegenda(false);\r\n                            comportamentCaptura(2);\r\n                            tornaLLoc(transform);\r\n                            window.open(\"/geocatweb/print.html\", \"Imprimir\",\r\n                                \"resizable=yes,status=yes,toolbar=yes,menubar=yes,location=no,scrollbars=yes\")\r\n                            if (estatMapa3D) {\r\n                                mapaEstatNOPublicacio = true;\r\n                            }\r\n                        } else {\r\n                            errorCaptura();\r\n                        }\r\n                        imgData = \"\";\r\n                    });\r\n            },\r\n            useCORS: true,\r\n            allowTaint: false,\r\n            proxy: paramUrl.urlgetImageProxy,\r\n            background: colorMapBackGround,\r\n            width: parseInt(w / 1.2),\r\n            height: parseInt(h / 1.2),\r\n            logging: false\r\n        });\r\n    } else if (_tipusCaptura == CAPTURA_GEOPDF) {\r\n        jQuery('#map .leaflet-overlay-pane').find('canvas').not('.leaflet-heatmap-layer').attr('data-html2canvas-ignore', 'true');\r\n\r\n        //hack Marker com imatge\r\n        jQuery('#map .leaflet-marker-pane').attr('data-html2canvas-ignore', 'true');\r\n\r\n\r\n        //In some browsers the initial transform is not set correctly\r\n        //we move the map a pixel so it resets itself\r\n\r\n\r\n\r\n        map.addOneTimeEventListener('moveend', captureGEOPDF);\r\n        //map.addOneTimeEventListener('moveend', captureGEOPackage);\r\n\r\n        map.panBy([0, 1], {\r\n            animate: false,\r\n            noMoveStart: true,\r\n            duration: 0\r\n        });\r\n    } else if (_tipusCaptura == CAPTURA_MAPA_GEOPACKAGE) {\r\n\r\n\r\n        captureGEOPackage();\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction checkDataVectorlayers(){\r\n\t\r\n\tvar data=getCapesVectorActives();\r\n\r\n\tif( data.layers.length ==0){\r\n\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Aquest mapa no té capes vector. No es pot generar un vector GeoPackage\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\treturn false;\r\n\t}else{\r\n\t\t\treturn true;\t\r\n\t}\t\r\n\t\r\n}\t\r\n\r\n\r\nfunction captureGEOPackage(event) {\r\n    var data = getCapesVectorActives();\r\n\r\n\tif(matriuCapesLL.layers.length >=1){\r\n\t\r\n    data.request = \"createGeoPackage\";\r\n    data.entitatUid = mapConfig.entitatUid;\r\n    data.businessId = mapConfig.businessId;\r\n    data.nomAplicacio = mapConfig.nomAplicacio;\r\n\r\n    createGeoPdfMap(data).then(\r\n        function(geopackageresult) {\r\n            if (geopackageresult.status == \"OK\") {\r\n                var urlIMG = paramUrl.urlgetMapImage +\r\n                    \"&request=getGeoPackage&uuid=\" +\r\n                    geopackageresult.UUID;\r\n                var $desc_img = jQuery('#dialog_captura').find('.desc_img');\r\n                $desc_img.prop('href', urlIMG);\r\n                $desc_img.prop('download', 'mapa_geoPackage.gpkg');\r\n                //jQuery('#desc_img').html(window.lang.translate(\"Desar mapa\") +\" <i class='fa fa-file-pdf-o'></i>\");\r\n                comportamentCaptura(3);\r\n                $('#dialog_captura').find('.bt_desc_img').show();\r\n\r\n\r\n            } else {\r\n\r\n                errorCaptura();\r\n            }\r\n        });\r\n\r\n\t}else{\r\n\t\t\r\n\r\n\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Aquest mapa no té capes vector. No es pot genera GeoPackage\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\r\n\t}\t\r\n\r\n\r\n\r\n\r\n\r\n}\r\n\r\n\r\nfunction captureGEOPDF(event) {\r\n    transform = hackCaptura();\r\n    var WF = calculaWF();\r\n    var data = getCapesVectorActives();\r\n    capturaLlegenda(false);\r\n    var colorMapBackGround = jQuery('#map').css('background-color');\r\n    html2canvas(jQuery('#map .leaflet-map-pane'), {\r\n        onrendered: function(canvas) {\r\n            ActDesPrintMode(false);\r\n            var imgData = canvas.toDataURL('image/png', 0.95);\r\n            imgData = JSON.stringify(imgData.replace(\r\n                /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n            uploadImageBase64(imgData).then(\r\n                function(results) {\r\n                    if (results.status == \"OK\") {\r\n                        data.imgW = WF.imgW;\r\n                        data.imgH = WF.imgH;\r\n                        data.resW = WF.resW;\r\n                        data.resH = WF.resH;\r\n                        data.resW = WF.resW;\r\n                        data.resH = WF.resH;\r\n                        data.resW4326 = WF.resW4326;\r\n                        data.resH4326 = WF.resH4326;\r\n                        data.x = WF.x;\r\n                        data.y = WF.y;\r\n                        data.x1 = WF.x1;\r\n                        data.y1 = WF.y1;\r\n                        data.x4326 = WF.x4326;\r\n                        data.y4326 = WF.y4326;\r\n                        data.x14326 = WF.x14326;\r\n                        data.y14326 = WF.y14326;\r\n                        data.request = \"createGeoPDF\";\r\n                        data.uuid = results.UUID;\r\n                        data.entitatUid = mapConfig.entitatUid;\r\n                        data.businessId = mapConfig.businessId;\r\n                        data.nomAplicacio = mapConfig.nomAplicacio;\r\n                        data.llegenda = objLLegenda;\r\n                        createGeoPdfMap(data).then(\r\n                            function(geopdfresults) {\r\n                                if (geopdfresults.status == \"OK\") {\r\n                                    var urlIMG = paramUrl.urlgetMapImage +\r\n                                        \"&request=getGeoPDF&uuid=\" +\r\n                                        results.UUID;\r\n                                    var $desc_img = jQuery('#dialog_captura').find('.desc_img');\r\n                                    $desc_img.prop('href', urlIMG);\r\n                                    $desc_img.prop('download', 'mapa_geoPDF.pdf');\r\n                                    //jQuery('#desc_img').html(window.lang.translate(\"Desar mapa\") +\" <i class='fa fa-file-pdf-o'></i>\");\r\n                                    $('#dialog_captura').find('.bt_desc_img').show();\r\n                                    comportamentCaptura(3);\r\n                                    if (!L.Browser.webkit) {\r\n                                        tornaLLoc(transform);\r\n                                    }\r\n                                } else {\r\n                                    comportamentCaptura(2);\r\n                                    errorCaptura();\r\n                                }\r\n                            });\r\n                    } else {\r\n                        alert(\"Error\");\r\n                    }\r\n                    imgData = \"\";\r\n                });\r\n        },\r\n        useCORS: true,\r\n        allowTaint: false,\r\n        proxy: paramUrl.urlgetImageProxy,\r\n        background: colorMapBackGround,\r\n        width: w,\r\n        height: h,\r\n        logging: false\r\n    });\r\n}\r\n\r\nfunction capturaLlegenda(ensenyaBoto) {\r\n    objLLegenda = null;\r\n    if (jQuery('#dv_bt_legend').hasClass('greenfort')) {\r\n        var w = jQuery('#mapLegend').width();\r\n        var h = jQuery('#mapLegend').height();\r\n        html2canvas(jQuery('#mapLegend'), {\r\n            onrendered: function(canvas) {\r\n                var imgCapturaLL = canvas.toDataURL('image/jpeg', 0.75);\r\n                imgCapturaLL = JSON.stringify(imgCapturaLL.replace(\r\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\r\n                uploadImageBase64(imgCapturaLL).then(\r\n                    function(results) {\r\n                        if (results.status == \"OK\") {\r\n                            objLLegenda = results.UUID;\r\n                            var urlIMG = paramUrl.urlgetMapImage +\r\n                                \"&request=getCaptura&uuid=\" +\r\n                                results.UUID;\r\n                            if (ensenyaBoto) {\r\n                                jQuery('#desc_ll').attr('href', urlIMG);\r\n                                jQuery('#desc_ll').attr('download', 'llegenda_captura.jpeg');\r\n                                jQuery('#desc_ll').html(window.lang.translate(\"Desar llegenda\") + \" <i class='fa fa-bars'></i>\");\r\n                                jQuery('#bt_desc_ll').show();\r\n                            } else {\r\n                                jQuery('#ll_canvas').attr('src', urlIMG);\r\n                                jQuery('#bt_desc_ll').hide();\r\n                            }\r\n                        } else {\r\n                            objLLegenda = null;\r\n                        }\r\n                    }\r\n                );\r\n            },\r\n            useCORS: true,\r\n            allowTaint: false,\r\n            proxy: paramUrl.urlgetImageProxy,\r\n            background: undefined,\r\n            logging: false\r\n        });\r\n    }\r\n}\r\n\r\nfunction imatgeCarregada() {\r\n    ActDesPrintMode(false);\r\n}\r\n\r\nfunction ActDesPrintMode(printMode) {\r\n    try {\r\n        if (map.options.typeMap == FONS_TOPOMAP) {\r\n            map.topoMap(printMode);\r\n        } else if (map.options.typeMap == FONS_ORTOMAP) {\r\n            map.ortoMap(printMode);\r\n        } else if (map.options.typeMap == FONS_HIBRIDMAP) {\r\n            map.hibridMap(printMode);\r\n        } else if (map.options.typeMap == FONS_TOPOGISMAP) {\r\n            map.topoGrisMap(printMode);\r\n        }\r\n        return true;\r\n    } catch (err) {\r\n        return true;\r\n    }\r\n}\r\n\r\nfunction calculaDistanciaMetres(PuntIn, PuntFi) {\r\n    var lat1 = PuntIn.lat;\r\n    var lon1 = PuntIn.lng;\r\n    var lat2 = PuntFi.lat;\r\n    var lon2 = PuntFi.lng;\r\n\r\n    var R = 6371; // Radius of the earth in km\r\n    var dLat = deg2rad(lat2 - lat1); // deg2rad below\r\n    var dLon = deg2rad(lon2 - lon1);\r\n    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) *\r\n        Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\r\n    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n    var d = R * c; // Distance in km\r\n    return d;\r\n}\r\n\r\nfunction deg2rad(deg) {\r\n    return deg * (Math.PI / 180)\r\n}\r\n\r\nfunction rag2deg(deg) {\r\n    return deg * (180 / Math.PI)\r\n}\r\n",";(function(global, $){\r\n\t\r\n\tvar Semaforic = function(isEditing){\r\n\t\treturn new Semaforic._init(isEditing);\r\n\t}\r\n\t\r\n\tSemaforic.prototype = {\r\n\t\t_createPaletteSelector: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar html = \r\n\t\t\t'\t<div id=\"interactivePalette\">' +\r\n\t\t\t'\t\t<div id=\"paletteBackground\"></div>' +\r\n\t\t\t'\t\t<div id=\"innerPalette\">' +\r\n\t\t\t'\t\t\t<div lang=\"ca\" class=\"paletteTitle\">Temàtic per escala de color</div>' + \r\n\t\t\t'\t\t\t<div lang=\"ca\" style=\"font-size: 12px;\">Tria la paleta de colors</div>' +\r\n\t\t\t'\t\t\t<div>' +\r\n\t\t\t'\t\t\t\t<div class=\"paletteLabels\">' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors menors</div>' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors iguals</div>' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors majors</div>' +\r\n\t\t\t'\t\t\t\t</div>' +\r\n\t\t\t'\t\t\t\t<div class=\"palettes\" style=\"display: inline-block;\">';\r\n\t\t\t\r\n\t\t\tvar palettes = $(\"#paletes_colors > .ramp\");\r\n\t\t\tpalettes.splice(0, 0, \"carto\");\r\n\t\t\tif(1 == palettes.length)\r\n\t\t\t\tpalettes = [\"carto\", \"BuGn\", \"BuPu\", \"GnBu\", \"OrRd\", \"PuBu\", \"PuBuGn\", \"PuRd\", \"RdPu\", \"YlGn\", \"YlGnBu\", \"YlOrBr\", \"YlOrRd\", \r\n\t\t\t\t\t\"BrBG\", \"PRGn\", \"PuOr\", \"RdGy\", \"RdYlBu\", \"RdYlGn\", \"Spectral\", \"Paired\", \"Set3\", \"Set1\", \"Dark2\"];\r\n\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\tvar palName;\r\n\t\t\t\tif($(palette).hasClass(\"ramp\"))\r\n\t\t\t\t\tpalName = $(palette).attr(\"class\").replace(\"ramp \", \"\");\r\n\t\t\t\telse\r\n\t\t\t\t\tpalName = palette;\r\n\t\t\t\tvar scale = self._createScaleAux(palName, 3, false);\r\n\t\t\t\thtml += '\t\t\t\t\t<div class=\"ramp border ' + palName + '\">' +\r\n\t\t\t\t'\t\t\t\t\t<svg height=\"60\" width=\"15\">' + \r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"0\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[0]).hex() + '\"/>' + \r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"20\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[1]).hex() + '\"/>' +\r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"40\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[2]).hex() + '\"/>' +\r\n\t\t\t\t'\t\t\t\t\t</svg>' +\r\n\t\t\t\t'\t\t\t\t</div>';\r\n\t\t\t});\r\n\r\n\t\t\thtml += '\t\t\t\t</div>' + \r\n\t\t\t'\t\t\t\t<div class=\"paletteButtons\">'+\r\n\t\t\t'\t\t\t\t\t<div style=\"display: inline-block; float:left;\">'+\r\n\t\t\t'\t\t\t\t\t\t<input id=\"cbSoftColors\" type=\"checkbox\"><span style=\"padding-left: 10px;\" lang=\"ca\">' + window.lang.translate('Colors suaus') + '</span>' +\r\n\t\t\t'\t\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t\t<div class=\"innerPaletteButtons\">'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-invert-palette\"><span lang=\"ca\">Inverteix paleta</span><span id=\"invert-palette-arrow\" class=\"glyphicon glyphicon-arrow-down\" style=\"padding-left: 5px;\"></span></button>'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" lang=\"ca\">Cancel·lar</button>'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Acceptar</button>'+\r\n\t\t\t'\t\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t</div>' +\r\n\t\t\t'\t\t</div>' + \r\n\t\t\t'\t</div>' +\r\n\t\t\t'\t<div id=\"dismissPaletteDialog\" class=\"modal fade\">' + \r\n\t\t\t'\t\t<div class=\"modal-dialog\">'+\r\n\t\t\t'\t\t\t<div class=\"modal-content panel-primary\">'+\r\n\t\t\t'\t\t\t\t<div id=\"id_sw\" class=\"modal-body\">'+\r\n\t\t\t'\t\t\t\t\t<h4><span lang=\"ca\">Vols sortir sense guardar aquesta escala de color?</span></h4>' +\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t\t\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Cancel·lar</button>'+\r\n\t\t\t'\t\t\t        <button type=\"button\" class=\"btn btn-danger\" data-dismiss=\"modal\" lang=\"ca\">Esborrar</button>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t</div>'+\r\n\t\t\t'\t\t</div>'+\r\n\t\t\t'\t</div>';\r\n\t\t\t$(\"#mapa_modals\").append(html);\r\n\r\n\t\t\t$('#cbSoftColors').iCheck({\r\n\t\t\t\tcheckboxClass: 'icheckbox_flat-blue',\r\n\t\t\t\tradioClass: 'iradio_flat-blue'\r\n\t\t\t});\r\n\r\n\t\t\tself._isPaletteDialogCreated = true;\r\n\r\n\t\t},\r\n\r\n\t\t_bindPaletteButtons: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar aux = $(\"#interactivePalette .ramp\");\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(evt){\r\n\t\t\t\tvar _this = $(this);\r\n\t\t\t\t$(\"#interactivePalette .ramp.active\").removeClass(\"active\");\r\n\t\t\t\tvar brewerClass = _this.attr('class').replace(\"ramp border \",\"\").replace(\" active\", \"\");\r\n\t\t\t\tself._palette = brewerClass;\r\n\t\t\t\t_this.addClass(\"active\");\r\n\r\n\t\t\t\t//If we are editing, update the values of the category popup\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif(\"carto\" == brewerClass)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tbrewerClass = [\"#1a9850\",\"#ffffbf\",\"#d73027\"];\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"paleta\", brewerClass);\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#interactivePalette .btn-invert-palette\");\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(evt){\r\n\t\t\t\tself._isPaletteReversed = !self._isPaletteReversed;\r\n\r\n\t\t\t\tif(self._isPaletteReversed)\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\t$(\"#invert-palette-arrow\").removeClass(\"glyphicon-arrow-down\").addClass(\"glyphicon-arrow-up\");\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$(\"#invert-palette-arrow\").removeClass(\"glyphicon-arrow-up\").addClass(\"glyphicon-arrow-down\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"reverse\",self._isPaletteReversed);\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar palettes = $(\"#interactivePalette .ramp\");\r\n\t\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\t\tvar svg = $(palette).children();\r\n\t\t\t\t\tvar rects = $(svg).children();\r\n\t\t\t\t\tvar startColor = $(rects[0]).attr(\"fill\");\r\n\t\t\t\t\tvar endColor = $(rects[2]).attr(\"fill\");\r\n\t\t\t\t\t$(rects[0]).attr(\"fill\", endColor);\r\n\t\t\t\t\t$(rects[2]).attr(\"fill\", startColor);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $('#interactivePalette .btn-success');\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(e){\r\n\r\n\t\t\t\t$.publish('analyticsEvent',{event:['mapa', 'bt_semaforic']});\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t$('#interactivePalette').hide();\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$('#info_uploadFile').show();\r\n\t\t\t\t\tbusy=true;\r\n\t\t\t\t\t$(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t$(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tvar key = $(\"#dialog_tematic_rangs #dataField\").val();\r\n\t\t\t\t\tvar rangs = $(\"#dialog_tematic_rangs\").data(\"rangs\");\r\n\t\t\t\t\tvar value = rangs[1].min;\r\n\t\t\t\t\tvar data = {nom: key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + value + \")\", \r\n\t\t\t\t\t\ttrafficLightKey: key, trafficLightValue: value, trafficLightLowerColor: self._previsualizationLayer.estil[0].color,\r\n\t\t\t\t\t\ttrafficLightEqualColor: self._previsualizationLayer.estil[1].color, trafficLightHigherColor: self._previsualizationLayer.estil[2].color};\r\n\t\t\t\t\tcreateTematicLayerCategories(e, {}, data, $.Deferred()).then(function(layerId) {\r\n\t\t\t\t\t\t//Update the map legend\r\n\t\t\t\t\t\tvar arrRangsEstilsLegend = sortObject(controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend);\r\n\t\t\t\t\t\tarrRangsEstilsLegend.sort(sortByValueMax);\r\n\t\t\t\t\t\t//Change the businessId from the styles and ranges to sort them correctly\r\n\t\t\t\t\t\t//(When geocat.mapa.legend.js addLayerToLegend is called, the ranges are sorted by its businessId so they are not guaranteed to \r\n\t\t\t\t\t\t//mantain the lower-equal-bigger legend)\r\n\t\t\t\t\t\tvar estils = controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.estil;\r\n\t\t\t\t\t\tvar nousEstils = [];\r\n\t\t\t\t\t\tfor(var i=0; i<estils.length; ++i)\r\n\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\tif(arrRangsEstilsLegend[0].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Lower style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[0] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[0].businessId = 0;\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(arrRangsEstilsLegend[1].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Equal style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[1] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[1].businessId = 1;\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(arrRangsEstilsLegend[2].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Bigger style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[2] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[2].businessId = 2;\r\n\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.estil = nousEstils;\r\n\t\t\t\t\t\tcontrolCapes._visLayers[controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.businessId].estil = nousEstils;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[0].value = key + window.lang.translate(\" menor de \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[0].key = 0;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[1].value = key + window.lang.translate(\" igual a \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[1].key = 1;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[2].value = key + window.lang.translate(\" major de \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[2].key = 2;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend = [];\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[0].key] = arrRangsEstilsLegend[0].value;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[1].key] = arrRangsEstilsLegend[1].value;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[2].key] = arrRangsEstilsLegend[2].value;\r\n\t\t\t\t\t\t//Remove the previsualization layer from the layer control\r\n\t\t\t\t\t\tmap.removeLayer(self._capaVisualitzacio);\r\n\t\t\t\t\t\tcontrolCapes.removeLayer(controlCapes._layers[self._previsualizationLayer.parentid]._layers[self._capaVisualitzacio._leaflet_id]);\r\n\t\t\t\t\t\tself._previsualizationLayer = null;\r\n\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $('#interactivePalette .btn-default');\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(e){\r\n\t\t\t\t//Activate the parent layer\r\n\t\t\t\t$( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).click();\r\n\t\t\t\tself._closePalette();\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#paletteBackground\");\r\n\t\t\taux.off(\"click\");\r\n\t\t\taux.on(\"click\", function(e) {\r\n\t\t\t\t$(\"#dismissPaletteDialog\").modal(\"show\");\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#dismissPaletteDialog .btn-danger\");\r\n\t\t\taux.off(\"click\");\r\n\t\t\taux.on(\"click\", function(e) {\r\n\t\t\t\tself._closePalette();\r\n\t\t\t});\r\n\r\n\t\t\t$(\"#cbSoftColors\").on(\"ifToggled\", function(e) {\r\n\t\t\t\tself._softColorsCheckboxChanged();\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar palettes = $(\"#interactivePalette .ramp\");\r\n\t\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\t\tvar svg = $(palette).children();\r\n\t\t\t\t\tvar rects = $(svg).children();\r\n\t\t\t\t\tvar paletteName = $(palette).attr(\"class\").replace(\"ramp border \", \"\").replace(\" active\", \"\");\r\n\t\t\t\t\tvar scale = self._createScaleAux(paletteName, 3, self._isPaletteReversed);\r\n\t\t\t\t\t$(rects[0]).attr(\"fill\", scale(self._paletteColorSteps[0]).hex());\r\n\t\t\t\t\t$(rects[1]).attr(\"fill\", scale(self._paletteColorSteps[1]).hex());\r\n\t\t\t\t\t$(rects[2]).attr(\"fill\", scale(self._paletteColorSteps[2]).hex());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t},\r\n\r\n\t\t_softColorsCheckboxChanged: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tself._useSoftColors = !self._useSoftColors;\r\n\r\n\t\t\tif(self._useSoftColors)\r\n\t\t\t\tself._paletteColorSteps = [0.75, 1.5, 2.25];\r\n\t\t\telse\r\n\t\t\t\tself._paletteColorSteps = [0, 1.5, 3];\r\n\r\n\t\t},\r\n\r\n\t\t_closePalette: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\t$('#interactivePalette').hide();\r\n\t\t\tmap.removeLayer(self._capaVisualitzacio);\r\n\t\t\tcontrolCapes.removeLayer(controlCapes._layers[self._previsualizationLayer.parentid]._layers[self._capaVisualitzacio._leaflet_id]);\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\t\t\tself._previsualizationLayer = null;\r\n\r\n\t\t},\r\n\r\n\t\t_showPaletteSelector: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tif(!self._isPaletteDialogCreated)\r\n\t\t\t\tself._createPaletteSelector();\r\n\r\n\t\t\tself._bindPaletteButtons();\r\n\t\t\t$(\"#interactivePalette\").show();\r\n\r\n\t\t},\r\n\r\n\t\t_createTrafficLightStyle: function(color, bId, features)\r\n\t\t{\r\n\r\n\t\t\treturn {\r\n\t\t\t\tbusinessId : bId,\r\n\t\t\t\tborderColor: \"#ffffff\",\r\n\t\t\t\tborderWidth: 1,\r\n\t\t\t\tcolor: color,\r\n\t\t\t\topacity: 75,\r\n\t\t\t\tlabel: false,\r\n\t\t\t\tlabelHaloWidth: 0,\r\n\t\t\t\tlabelSize: 0,\r\n\t\t\t\tlineWidth: 0,\r\n\t\t\t\tradius: 0,\r\n\t\t\t\tsimbolSize: 6,\r\n\t\t\t\tgeometria: {\r\n\t\t\t\t\tfeatures: features\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t},\r\n\r\n\t\t_randomStringAux: function(length, chars)\r\n\t\t{\r\n\r\n\t\t\tvar result = '';\r\n\t\t\tfor (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];\r\n\t\t\treturn result;\r\n\r\n\t\t},\r\n\r\n\t\t_randomString: function(length)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treturn self._randomStringAux(length, '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');\r\n\r\n\t\t},\r\n\r\n\t\t_createTempTrafficLightLayer: function(key, value, baseLayer, layerOptions)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar newLayer = {};\r\n\t\t\tvar id = randomString(32);\r\n\t\t\tvar newOptions = {businessId: id,\r\n\t\t\t\tcapesActiva: \"true\",\r\n\t\t\t\tcapesCalenta: null,\r\n\t\t\t\tcapesGroup: \"\",\r\n\t\t\t\tcapesOrdre: \"sublayer\",\r\n\t\t\t\tcapesVisibilitat: null,\r\n\t\t\t\tentitatUid: null, //<----\r\n\t\t\t\tepsg: {},\r\n\t\t\t\tid: null, //<----\r\n\t\t\t\timgFormat: \"\",\r\n\t\t\t\tinfFormat: \"\",\r\n\t\t\t\tlayers: null,\r\n\t\t\t\tlegend: \"\",\r\n\t\t\t\topacity: 1,\r\n\t\t\t\toptions: JSON.stringify({\r\n\t\t\t\t\ttem: \"clasicTematic\",\r\n\t\t\t\t\tid: null,  //<----\r\n\t\t\t\t\tbusinessId: id,\r\n\t\t\t\t\tnom: key + \" \" + window.lang.translate(\"Escala de color\"),\r\n\t\t\t\t\torigen: baseLayer.businessId,\r\n\t\t\t\t\tgeometryType: baseLayer.geometryType,\r\n\t\t\t\t\ttipus: \"clasicTematic\",\r\n\t\t\t\t\toptions: {\r\n\t\t\t\t\t\tsource: baseLayer.source,\r\n\t\t\t\t\t\tpropName: baseLayer.propName.join(),\r\n\t\t\t\t\t},\r\n\t\t\t\t\tgeometriesColleccio: {\r\n\t\t\t\t\t\tid: baseLayer.id,\r\n\t\t\t\t\t\tbusinessId: baseLayer.businessId,\r\n\t\t\t\t\t\tnom: baseLayer.nom, \r\n\t\t\t\t\t\toptions: baseLayer.propName.join(),\r\n\t\t\t\t\t\tgeometryType: baseLayer.geometryType\r\n\t\t\t\t\t},\r\n\t\t\t\t\tentitat: null,  //<----\r\n\t\t\t\t\tgroup: {\r\n\t\t\t\t\t\tname: baseLayer.group.name, \r\n\t\t\t\t\t\tgroupName: baseLayer.group.groupName,\r\n\t\t\t\t\t\tid: baseLayer.group.id,\r\n\t\t\t\t\t\tz_order: baseLayer.group.z_order,\r\n\t\t\t\t\t\texpanded: baseLayer.group.expanded\r\n\t\t\t\t\t},\r\n\t\t\t\t\ttrafficLightKey : key,\r\n\t\t\t\t\ttrafficLightValue: value,\r\n\t\t\t\t\tpropName: baseLayer.propName.join()\r\n\t\t\t\t}),\r\n\t\t\t\tquery:null,\r\n\t\t\t\tserverName: key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + value + \")\",\r\n\t\t\t\tserverType: baseLayer.tipus,\r\n\t\t\t\ttiles:\"\",\r\n\t\t\t\ttitles:null,\r\n\t\t\t\ttransparency:\"\",\r\n\t\t\t\turl:\"\",\r\n\t\t\t\tversion:\"\",\r\n\t\t\t\tvisibilitat:\"O\"\r\n\t\t\t};\r\n\r\n\t\t\tnewLayer.options = newOptions.options;\r\n\t\t\tnewLayer.businessId = null; //<----\r\n\t\t\tnewLayer.geometriesBusinessId = baseLayer.businessId;\r\n\t\t\tnewLayer.geometryType = baseLayer.geometryType;\r\n\t\t\tnewLayer.id = null; //<----\r\n\t\t\tnewLayer.nom = newOptions.options.serverName;\r\n\t\t\tnewLayer.tipus = \"clasicTematic\";\r\n\t\t\tnewLayer.uid = null;//<----\r\n\r\n\t\t\t//Set the parentid property. If the baseLayer doesn't have it, look for it on \r\n\t\t\t//the layer control\r\n\t\t\tif(baseLayer.hasOwnProperty(\"leafletid\"))\r\n\t\t\t\tnewLayer.parentid = baseLayer.leafletid;\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\tvar keys = Object.keys(controlCapes._layers);\r\n\t\t\t\tvar trobat = false;\r\n\t\t\t\tvar key;\r\n\t\t\t\tfor(var i=0; i<keys.length && !trobat; ++i)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tkey = keys[i];\r\n\t\t\t\t\ttrobat = (controlCapes._layers[keys[i]].layer.options.businessId == baseLayer.businessId);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewLayer.parentid = key;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$.extend(layerOptions, newOptions);\r\n\r\n\t\t\treturn newLayer;\r\n\r\n\t\t},\r\n\r\n\t\t_setupTematicLayerDialog: function(layer, key, pivot, min, highestLowerValue, lowestHigherValue, max)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tif(self._isEditing)\r\n\t\t\t{\r\n\r\n\t\t\t\t//Set the category popup values to use its own click and do the\r\n\t\t\t\t//same process done on a 3 interval category\r\n\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"capamare\", {\r\n\t\t\t\t\tbusinessid: layer.options.businessId,\r\n\t\t\t\t\tfrom: layer.options.from,\r\n\t\t\t\t\tgeometrytype: layer.options.geometryType,\r\n\t\t\t\t\tleafletid: layer.options.leafletid,\r\n\t\t\t\t\tpropname: layer.options.propName.join(),\r\n\t\t\t\t\ttipus: layer.options.tipus\r\n\t\t\t\t});\r\n\r\n\t\t\t\tvar src;\r\n\t\t\t\tif (layer.options.geometryType == t_marker)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-punt-template\").html();\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse if (layer.options.geometryType == t_polyline)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-polyline-template\").html();\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\telse if (layer.options.geometryType == t_polygon)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-polygon-template\").html();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar template = Handlebars.compile(src);\r\n\t\t\t\t$(\"#rd_tipus_semaforic\").prop(\"checked\", true);\r\n\t\t\t\t$(\"#list_tematic_values\").html(template({values: [{index:0, v: {min: min, max: highestLowerValue}}, {index:1, v: {min: pivot, max: pivot}}, {index:2, v:{min: lowestHigherValue, max: max}}]}));\r\n\r\n\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"rangs\", [{min: min, max: highestLowerValue}, {min: pivot, max: pivot}, {min: lowestHigherValue, max: max}]);\r\n\t\t\t\tshowTematicRangs(layer.options.geometryType);\r\n\t\t\t\t$(\"#dataField\").html(\"<option value=\\\"\" + key + \"\\\">\" + key + \"</option>\");\r\n\t\t\t\t$(\"#dataField\").val(key);\r\n\t\t\t\t$(\"#cmb_num_rangs\").val(3);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tself._showPaletteSelector();\r\n\r\n\t\t},\r\n\r\n\t\t_createScaleAux: function(paleta, rang, reversed)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar auxPaleta = paleta;\r\n\t\t\tif(\"carto\" == auxPaleta)\r\n\t\t\t{\r\n\r\n\t\t\t\tauxPaleta = self._cartoPaletteColors;\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn createScale(auxPaleta, rang, reversed);\r\n\r\n\t\t},\r\n\r\n\t\tsortGeometry: function(inStyles, key, pivot)\r\n\t\t{\r\n\r\n\t\t\tvar styles = inStyles;\r\n\t\t\tvar equalGeom = [];\r\n\t\t\tvar lowerGeom = []; \r\n\t\t\tvar higherGeom = [];\r\n\t\t\tvar highestLowerValue = Number.MIN_SAFE_INTEGER;\r\n\t\t\tvar lowestHigherValue = Number.MAX_SAFE_INTEGER;\r\n\t\t\tvar min = Number.MAX_SAFE_INTEGER;\r\n\t\t\tvar max = Number.MIN_SAFE_INTEGER;\r\n\r\n\t\t\t$.each(inStyles, function(i, estil) {\r\n\t\t\t\t$.each(estil.geometria.features, function(j, feature) {\r\n\r\n\t\t\t\t\tvar aux = feature;\r\n\t\t\t\t\tvar val = parseFloat(aux.properties[key]);\r\n\t\t\t\t\tmin = (min > val ? val : min);\r\n\t\t\t\t\tmax = (max < val ? val : max);\r\n\t\t\t\t\tif(val == pivot)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Equal color\r\n\t\t\t\t\t\tequalGeom.push(feature);\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(val < pivot)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Less than color\r\n\t\t\t\t\t\tlowerGeom.push(feature);\r\n\t\t\t\t\t\tif(val >= highestLowerValue)\r\n\t\t\t\t\t\t\thighestLowerValue = val;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse \r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Greater than color\r\n\t\t\t\t\t\thigherGeom.push(feature);\r\n\t\t\t\t\t\tif(val < lowestHigherValue)\r\n\t\t\t\t\t\t\tlowestHigherValue = val;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\treturn {\r\n\t\t\t\tlowerGeom: lowerGeom,\r\n\t\t\t\tequalGeom: equalGeom,\r\n\t\t\t\thigherGeom: higherGeom,\r\n\t\t\t\thighestLowerValue: highestLowerValue,\r\n\t\t\t\tlowestHigherValue: lowestHigherValue,\r\n\t\t\t\tmin: min, \r\n\t\t\t\tmax: max\r\n\t\t\t};\r\n\r\n\t\t},\r\n\r\n\t\t_renderFakeLayer: function(defer)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treadVisualitzacio($.Deferred(), self._previsualizationLayer, self._previsualizationLayerOptions).then(function(data) {\r\n\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\tif ($( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).attr(\"checked\")!=undefined) $( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).click();\r\n\t\t\t\tself._capaVisualitzacio = data;\r\n\t\t\t\tdefer.resolve(data._leaflet_id);\r\n\t\t\t\t$(\"#interactivePalette .ramp.carto\").click();\r\n\t\t\t});\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\r\n\t\t},\r\n\r\n\t\t_renderLayer: function(defer)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treloadVisualitzacioLayer(self._capaVisualitzacio, self._previsualizationLayer, self._previsualizationLayerOptions, map);\r\n\t\t\tdefer.resolve(self._capaVisualitzacio._leaflet_id);\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\r\n\t\t},\r\n\r\n\t\trender: function(defer, key, pivot, inLayer)\r\n\t\t{\t\t\t\r\n\r\n\t\t\tvar self = this;\r\n\t\t\t//Create each style and sort the geometry on each bucket\r\n\t\t\tvar rangColors = self._createScaleAux(self._palette, 3, self._isPaletteReversed);\r\n\t\t\tvar estilActual = [\r\n\t\t\t\trangColors(self._paletteColorSteps[0]).hex(), \r\n\t\t\t\trangColors(self._paletteColorSteps[1]).hex(), \r\n\t\t\t\trangColors(self._paletteColorSteps[2]).hex()\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\tvar layerOptions = {};\r\n\t\t\tvar layer = (null != self._previsualizationLayer ? self._previsualizationLayer : inLayer);\r\n\r\n\t\t\tvar sorted = self.sortGeometry(inLayer.options.estil, key, pivot);\r\n\t\t\tvar lowerStyle = self._createTrafficLightStyle(estilActual[0], 0, sorted.lowerGeom);\r\n\t\t\tvar equalStyle = self._createTrafficLightStyle(estilActual[1], 1, sorted.equalGeom);\r\n\t\t\tvar higherStyle = self._createTrafficLightStyle(estilActual[2], 2, sorted.higherGeom);\r\n\r\n\t\t\tif(null == self._previsualizationLayer)\r\n\t\t\t{\r\n\r\n\t\t\t\tself._setupTematicLayerDialog(layer, key, pivot, sorted.min, sorted.highestLowerValue, sorted.lowestHigherValue, sorted.max);\r\n\t\t\t\tlayer = self._createTempTrafficLightLayer(key, pivot, layer.options, layerOptions);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tlayer.estil = [lowerStyle, equalStyle, higherStyle];\r\n\t\t\t\r\n\t\t\t//Draw the layer\r\n\t\t\tif(null == self._previsualizationLayerOptions)\r\n\t\t\t{\r\n\r\n\t\t\t\tself._previsualizationLayerOptions = layerOptions;\r\n\t\t\t\tself._previsualizationLayer = layer;\r\n\t\t\t\tself._renderFakeLayer(defer);\t\t\t\t\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t//Update mapConfig legend if exists\r\n\t\t\t\tvar lowerThanLabel = key + window.lang.translate(\" menor de \") + pivot;\r\n\t\t\t\tvar equalToLabel = key + window.lang.translate(\" igual a \") + pivot;\r\n\t\t\t\tvar higherThanLabel = key + window.lang.translate(\" major de \") + pivot;\r\n\t\t\t\tif(self._capaVisualitzacio.hasOwnProperty(\"layer\"))\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\tself._updateMapLegend(layer, lowerThanLabel, equalToLabel, higherThanLabel);\r\n\t\t\t\t\tself._updateStyleRangeLegend(layer, lowerThanLabel, equalToLabel, higherThanLabel, \r\n\t\t\t\t\t\tlowerStyle, equalStyle, higherStyle, pivot);\r\n\r\n\t\t\t\t}\r\n\t\t\t\tself._renderLayer(defer);\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn defer.promise();\r\n\r\n\t\t},\r\n\r\n\t\t_updateStyleRangeLegend: function(layer, lowerThanLabel, equalToLabel, higherThanLabel, lowerStyle, equalStyle, higherStyle, pivot)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar aux = JSON.parse(layer.options);\r\n\t\t\taux.rangsEstilsLegend = {};\r\n\t\t\taux.rangsEstilsLegend[layer.estil[0].businessId] = lowerThanLabel;\r\n\t\t\taux.rangsEstilsLegend[layer.estil[1].businessId] = equalToLabel;\r\n\t\t\taux.rangsEstilsLegend[layer.estil[2].businessId] = higherThanLabel;\r\n\t\t\tlayer.options = JSON.stringify(aux);\r\n\t\t\tself._capaVisualitzacio.layer.options.rangsEstilsLegend = aux.rangsEstilsLegend;\r\n\t\t\tself._capaVisualitzacio.layer.options.estil = [lowerStyle, equalStyle, higherStyle];\r\n\r\n\t\t\t//Update the layer properties so they are saved when publishing\r\n\t\t\tself._capaVisualitzacio.layer.options.trafficLightValue = pivot;\r\n\t\t\tvar newName = self._getNewLayerName(self._capaVisualitzacio.name, pivot)\r\n\t\t\tself._capaVisualitzacio.layer.options.nom = newName;\r\n\t\t\tself._capaVisualitzacio.name = newName;\r\n\t\t\tvar aux = JSON.parse(self._previsualizationLayer.options);\r\n\t\t\taux.trafficLightValue = pivot;\r\n\t\t\tself._previsualizationLayer.options = JSON.stringify(aux);\r\n\r\n\t\t},\r\n\r\n\t\t_updateMapLegend: function(layer, lowerThanLabel, equalToLabel, higherThanLabel)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar _mapConfig = (\"undefined\" == typeof visor) ? mapConfig : visor._mapConfig;\r\n\t\t\tif(undefined != _mapConfig.legend && \"\" != _mapConfig.legend)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar auxLegend = JSON.parse(_mapConfig.legend);\r\n\t\t\t\tif(null != auxLegend)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tvar layerLegend;\r\n\t\t\t\t\tlayerLegend = auxLegend[self._capaVisualitzacio.layer.options.businessId];\r\n\r\n\t\t\t\t\tif(null != layerLegend)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Check which bucket is by its color (should we be using the style businessId?)\r\n\t\t\t\t\t\tvar lowerThanColor = hexToRgb(layer.estil[0].color);\r\n\t\t\t\t\t\tvar lowerThanFill = \"fill:rgb(\" + lowerThanColor.r +\", \" + lowerThanColor.g+ \", \"+lowerThanColor.b+\");\"\r\n\t\t\t\t\t\tvar equalToColor = hexToRgb(layer.estil[1].color);\r\n\t\t\t\t\t\tvar equalToFill = \"fill:rgb(\" + equalToColor.r +\", \" + equalToColor.g+ \", \"+equalToColor.b+\");\"\r\n\t\t\t\t\t\tvar higherThanColor = hexToRgb(layer.estil[2].color);\r\n\t\t\t\t\t\tvar higherThanFill = \"fill:rgb(\" + higherThanColor.r +\", \" + higherThanColor.g+ \", \"+higherThanColor.b+\");\"\r\n\t\t\t\t\t\tfor(var i=0; i<layerLegend.length; ++i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(-1 != layerLegend[i].symbol.indexOf(lowerThanFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = lowerThanLabel;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(-1 != layerLegend[i].symbol.indexOf(equalToFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = equalToLabel;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(-1 != layerLegend[i].symbol.indexOf(higherThanFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = higherThanLabel;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif(\"undefined\" == typeof visor)\r\n\t\t\t\t\t\t\tmapConfig = JSON.stringify(auxLegend);\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tvisor._mapConfig.legend = JSON.stringify(auxLegend);\r\n\t\t\t\t\t\tmapLegend = auxLegend;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t},\r\n\r\n\t\t_getNewLayerName: function(oldName, pivot)\r\n\t\t{\r\n\r\n\t\t\t//If the name contains the \"Reference value\" string, update it with the new value\r\n\t\t\tvar newName = oldName;\r\n\t\t\tvar refString = window.lang.translate(\"(Valor de ref: \");\r\n\t\t\tvar indexValor = oldName.indexOf(refString);\r\n\t\t\tif(-1 !== indexValor)\r\n\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\tnewName = oldName.substring(0, indexValor+refString.length) + pivot + \")\";\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn newName;\r\n\r\n\t\t},\r\n\r\n\t\t_updateFakeLayer: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar scale = self._createScaleAux(self._palette, 3, self._isPaletteReversed);\r\n\t\t\tself._previsualizationLayer.estil[0].color = scale(self._paletteColorSteps[0]).hex();\r\n\t\t\tself._previsualizationLayer.estil[1].color = scale(self._paletteColorSteps[1]).hex();\r\n\t\t\tself._previsualizationLayer.estil[2].color = scale(self._paletteColorSteps[2]).hex();\r\n\r\n\t\t\t//Removes the additional data from the map.\r\n\t\t\treloadVisualitzacioLayer(self._capaVisualitzacio, self._previsualizationLayer, self._previsualizationLayerOptions, map);\r\n\r\n\t\t},\r\n\r\n\t\tsetVisualization: function(vis)\r\n\t\t{\r\n\r\n\t\t\tthis._capaVisualitzacio = vis;\r\n\r\n\t\t},\r\n\r\n\t\tsetLayer: function(layer)\r\n\t\t{\r\n\r\n\t\t\tthis._previsualizationLayer = layer;\r\n\r\n\t\t},\r\n\r\n\t\tsetLayerOptions: function(options)\r\n\t\t{\r\n\r\n\t\t\tthis._previsualizationLayerOptions = options;\r\n\r\n\t\t},\r\n\r\n\t\tsetPalette: function(palette, isReversed)\r\n\t\t{\r\n\r\n\t\t\tthis._palette = palette;\r\n\t\t\tthis._isPaletteReversed = isReversed;\r\n\r\n\t\t},\r\n\r\n\t};\r\n\t\r\n\tSemaforic._init = function(isEditing){\r\n\r\n\t\tvar self = this;\r\n\r\n\t\tself._isEditing = (\"undefined\" !== typeof isEditing && isEditing)\r\n\t\tself._previsualizationLayer = null;\r\n\t\tself._previsualizationLayerOptions = null;\r\n\t\tself._isInitialized = true;\r\n\t\tself._capaVisualitzacio = null;\r\n\r\n\t\tself._isPaletteDialogCreated = ( 0 != $(\"#interactivePalette\").length);\r\n\t\tif(self._isPaletteDialogCreated && self._isEditing)\r\n\t\t{\r\n\r\n\t\t\t//Get the parameters from the palette dialog\r\n\t\t\tself._isPaletteReversed = $(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\t\t\tself._palette = $(\"#dialog_tematic_rangs\").data(\"paleta\");\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tself._isPaletteReversed = false;\r\n\t\t\tself._palette = \"carto\";\r\n\r\n\t\t}\r\n\r\n\t\t$(\"#cbSoftColors\").iCheck('uncheck');\r\n\t\tself._useSoftColors = false;\r\n\t\tself._paletteColorSteps = [0, 1.5, 3];\r\n\t\tself._cartoPaletteColors = [\"#00a84b\", \"#e2e174\", \"#cc0001\"];\r\n\r\n\t\treturn this;\r\n\t}\r\n\t\r\n\tSemaforic._init.prototype = Semaforic.prototype;\r\n\tSemaforic.sortGeometry = Semaforic.prototype.sortGeometry;\r\n\tSemaforic.getUpdatedLayerName = Semaforic.prototype._getNewLayerName;\r\n\tglobal.Semaforic = Semaforic;\r\n\t\r\n}(window, jQuery));","/**\r\n * Gestio del temàtic de tipus Basic \r\n */\r\n\r\nfunction createTematicLayerBasic(tematic, styles){\r\n\tvar defer = $.Deferred();\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'basic', 1]});\r\n\t\r\n\t\r\n\tvar rangs = getRangsFromStyles(tematic, styles);\r\n\tvar capaMare = controlCapes._layers[tematic.leafletid].layer;\r\n\t\r\n\r\n\t\r\n\tif(capaMare.options.tipus == t_dades_obertes){\r\n\t\tvar data1 = {\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t}\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tloadDadesObertesLayer(data.results);\r\n\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error creant el temàtic bàsic\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error creant el temàtic bàsic\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\tvar options = {\r\n\t\t\t\t\t\tdataset: capaMare.options.dataset,\r\n\t\t\t\t\t\ttem: tem_simple,\r\n\t\t\t\t\t\tstyle: rangs[0],\r\n\t\t\t\t\t\torigen: capaMare.options.businessId\r\n\t\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\t\tserverType: capaMare.options.tipus,\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t        activas: true,\r\n\t\t\t\t        visibilitats: true,\r\n\t\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\r\n\t\t\t\t        epsg: '4326',\r\n\t\t\t\t        imgFormat: 'image/png',\r\n\t\t\t\t        infFormat: 'text/html',\r\n\t\t\t\t        tiles: true,\t            \r\n\t\t\t\t        transparency: true,\r\n\t\t\t\t        opacity: 1,\r\n\t\t\t\t        visibilitat: 'O',\r\n\t\t\t\t\t\toptions: JSON.stringify(options),\r\n\t\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\t\ttipusTematic:\"t_dades_obertes\",\r\n\t\t\t\t\t\turlTematic:paramUrl.createServidorInMap\r\n\t\t\t\t\t};\r\n\t\t\t\r\n\t\t\t\tcallActions(data);\r\n\t\t\t\t//createServidorInMap(data);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\r\n\t\t\t/*.then(function(results){\r\n\t\t\t\tbusy=false;\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\tif (results.status=\"OK\") {\r\n\t\t\t\t\tloadDadesObertesLayer(results.results);\r\n\t\t\t\t}\t\t\r\n\t\t\t\r\n\t\t\t});*/\r\n\t\t });\r\n\t\t\r\n\t}else if(capaMare.options.tipus == t_url_file){\r\n\t\tvar data1 = {\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t}\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =1000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tloadURLfileLayer(data.results).then(function(results){\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\tvar estil_do = capaMare.options.estil_do;\r\n\t\t\t\t\r\n\t\t\t\tif(capaMare.options.geometryType.indexOf(\"line\")!=-1){\r\n\t\t\t\t\trangs[0].weight = rangs[0].lineWidth;\r\n\t\t\t\t\t\r\n\t\t\t\t}else if(capaMare.options.geometryType.indexOf(\"polygon\")!=-1){\r\n\t\t\t\t\t\r\n\t\t\t\t\t var polygonStyle = rangs[0];//getPolygonRangFromStyle(canvas_pol);\r\n\t\t\t\t\t rangs[0].weight = polygonStyle.borderWidth;//lineWidth;\r\n\t\t\t\t\t rangs[0].fillColor = polygonStyle.color;\r\n\t\t\t\t\t rangs[0].color = polygonStyle.borderColor;\r\n\t\t\t\t\t rangs[0].fillOpacity = polygonStyle.opacity/100; \r\n\t\t\t\t\t rangs[0].opacity = 1;\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar markerStyle2 = rangs[0];\r\n\t\t\t\t\trangs[0].fillColor = markerStyle2.color;\r\n\t\t\t\t\trangs[0].color = markerStyle2.borderColor;\r\n\t\t\t\t\trangs[0].fillOpacity = 1;\r\n\t\t\t\t\trangs[0].opacity = 1;\r\n\t\t\t\t\trangs[0].radius = markerStyle2.simbolSize;\r\n\t\t\t\t\trangs[0].weight = markerStyle2.borderWidth;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tvar options = {\r\n\t\t\t\t\turl: capaMare.options.url,\r\n\t\t\t\t\ttem: tem_simple,\r\n\t\t\t\t\tstyle: rangs[0],\r\n\t\t\t\t\torigen: capaMare.options.businessId,\r\n\t\t\t\t\ttipus : t_url_file,\r\n\t\t\t//\t\tbusinessId : '-1',\r\n\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\r\n\t\t\t\t\testil_do: rangs[0],\r\n\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\r\n\t\t\t\t\tgeometryType: capaMare.options.geometryType,\r\n\t\t\t\t\tcolX: capaMare.options.colX,\r\n\t\t\t\t\tcolY: capaMare.options.colY,\r\n\t\t\t\t\tdinamic: capaMare.options.dinamic\r\n\t\t\t\t};\r\n\t\t\t\r\n\t\t\t//\tconsole.debug(options);\r\n\t\t\t\t\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\tserverType: capaMare.options.tipus,\r\n\t\t\t\t\tcalentas: false,\r\n\t\t\t        activas: true,\r\n\t\t\t        visibilitats: true,\r\n\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\r\n\t\t\t        epsg: capaMare.options.epsgIN,\r\n\t\t\t//        imgFormat: 'image/png',\r\n\t\t\t//        infFormat: 'text/html',\r\n\t\t\t//        tiles: true,\t            \r\n\t\t\t        transparency: true,\r\n\t\t\t        opacity: 1,\r\n\t\t\t        visibilitat: 'O',\r\n\t\t\t        url: capaMare.options.url,\r\n\t\t\t\t\toptions: JSON.stringify(options),\r\n\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\ttipusTematic:\"t_url_file\",\r\n\t\t\t\t\turlTematic:paramUrl.createServidorInMap\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tcallActions(data);\r\n\t\t\t\t/*createServidorInMap(data);.then(function(results){\r\n\t\t\t\t\tbusy=false;\r\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\tif (results.status=\"OK\") {\r\n\t\t\t\t\t\tloadURLfileLayer(results.results).then(function(results){\t\t\t\t\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});*/\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\t\r\n\r\n\t\t\t\r\n\t\t });\r\n\t\t\r\n\t\t\r\n\t}else if(capaMare.options.tipus == t_json){\r\n\r\n\t\tvar data1 = {\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t}\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tloadCapaFromJSON(data.results).then(function(results){\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\tvar capaMareOptions = capaMare.options.options;\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\tserverType: t_json,\r\n\t\t\t\t\tcalentas: false,\r\n\t\t\t        activas: true,\r\n\t\t\t        visibilitats: true,\r\n\t\t\t        order: capesOrdre_sublayer,\r\n\t\t\t        epsg: '4326',\r\n\t\t\t        imgFormat: 'image/png',\r\n\t\t\t        infFormat: 'text/html',\r\n\t\t\t        tiles: true,\t            \r\n\t\t\t        transparency: true,\r\n\t\t\t        opacity: 1,\r\n\t\t\t        visibilitat: 'O',\r\n\t\t\t        url: capaMare.options.url,//Provar jQuery(\"#txt_URLJSON\")\r\n\t\t\t        calentas: false,\r\n\t\t\t        activas: true,\r\n\t\t\t        visibilitats: true,\r\n\t\t\t        options: '{\"origen\":\"'+capaMare.options.businessId+'\",\"tem\":\"'+tem_simple+'\",\"x\":\"'+capaMareOptions.x+'\", \"y\":\"'+capaMareOptions.y+'\",\"titol\":\"'+capaMareOptions.titol+'\",\"descripcio\":\"'+capaMareOptions.descripcio+'\", \"imatge\":\"'+capaMareOptions.imatge+'\",\"vincle\":\"'+capaMareOptions.vincle+'\",\"estil_do\":{\"radius\":\"'+styles.options.radius+'\",\"fillColor\":\"'+styles.options.fillColor+'\",\"color\":\"'+styles.options.color+'\",\"weight\":\"'+styles.options.weight+'\",\"opacity\":\"'+styles.options.opacity+'\",\"fillOpacity\":\"'+styles.options.fillOpacity+'\",\"isCanvas\":\"'+styles.options.isCanvas+'\"}}',\r\n\t\t\t        tmpFilePath: tmpFile,\r\n\t\t\t\t\ttipusTematic:\"t_json\",\r\n\t\t\t\t\turlTematic:paramUrl.createServidorInMap\r\n\t\t\t\t};\t\t\r\n\t\t\t\t\r\n\t\t\t\tcallActions(data);\r\n\t\t\t\t/*createServidorInMap(data);.then(function(results){\r\n\t\t\t\t\tbusy=false;\r\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\tif (results.status=\"OK\") {\r\n\t\t\t\t\t\tloadCapaFromJSON(results.results).then(function(results){\t\t\t\t\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});*/\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t });\r\n\t\t\r\n\t}else if (tematic.tipus == t_tematic){\r\n\t\tvar data1 = {\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t}\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tloadTematicLayer(data.results);\r\n\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\t rangs = JSON.stringify({rangs:rangs});\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tbusinessId: tematic.businessid,\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t        mapBusinessId: url('?businessid'),\t           \r\n\t\t\t\t        nom: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t        activas: true,\r\n\t\t\t\t        visibilitats: true,    \r\n\t\t\t\t        order: capesOrdre_sublayer,\r\n\t\t\t\t\t\ttipusRang: tematic.from,\r\n\t\t\t\t\t\trangs: rangs,\r\n\t\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\t\ttipusTematic:\"t_tematic\",\r\n\t\t\t\t\t\turlTematic:paramUrl.duplicateTematicLayer\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tcallActions(data);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tduplicateTematicLayer(data);/*.then(function(results){\r\n\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\tloadTematicLayer(results.results);\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});*/\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t });\r\n\t//NOU MODEL\t\r\n\t}else if (tematic.tipus == t_visualitzacio){\r\n\t\tvar data1 = {\r\n\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t}\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\t\t\t\t\r\n\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\r\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\tbusy=false;\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\t\tbusinessId: tematic.businessid,//businessId id de la visualización de origen\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t        mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t        nom: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),//nom nombre de la nueva visualizacion\r\n\t\t\t\t        activas: true,\r\n\t\t\t\t        order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\t\ttem: tematic.from,//tem_simple\r\n\t\t\t\t        estils: JSON.stringify(rangs[0]),\r\n\t\t\t\t        tmpFilePath: tmpFile,\r\n\t\t\t\t\t\ttipusTematic:\"t_visualitzacio\",\r\n\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioSimple  \r\n\t\t\t\t        \r\n\t\t\t\t\t};\t\r\n\t\t\t\t\t\r\n\t\t\t\tcallActions(data);\r\n\t\t\t\t\t/*createVisualitzacioSimple(data);/*.then(function(results){\r\n\t\t\t\t\t\tbusy=false;\t\t\t\t\t\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\t\t\tvar defer = $.Deferred();\t\t\t\t\r\n\t\t\t\t\t\t\treadVisualitzacio(defer, results.visualitzacio, results.layer).then(function(results){\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\t\t\r\n\t\t\t\t\t });\t*/\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\trangs = JSON.stringify({rangs:rangs});\r\n\t\r\n\t\t\r\n\t\t\r\n\t});\r\n\t\r\n}\r\n\treturn defer.promise();\t\r\n}","/**\r\n * Gestio del temàtic de tipus Categories \r\n */\r\n\r\nfunction showModalTematicCategories(data){\r\n\t//console.debug(\"showModalTematicCategories\");\r\n\tjQuery('.modal').modal('hide');\r\n\tjQuery('#dialog_tematic_rangs').modal('show');\r\n\t\r\n\t//se ponen los off para evitar el doble evento\r\n\t//TODO hay que revisar como evitar el doble evento.\r\n\tjQuery('#dialog_tematic_rangs .btn-success').off('click');\r\n\tjQuery('#dialog_tematic_rangs .btn-success').on('click',function(e){\r\n\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\tjQuery('#info_uploadFile').show();\r\n\t\tbusy=true;\r\n\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\r\n\t\t);\t\r\n\t\tcreateTematicLayerCategories(e);\r\n\t});\t\r\n\t\r\n\tjQuery('#palet_warning').hide();\r\n\t\r\n\tjQuery(\".ramp\").off('click');\r\n\tjQuery(\".ramp\").on('click',function(evt){\r\n\t\tvar _this = jQuery(this);\r\n\t\tvar brewerClass = _this.attr('class').replace(\"ramp \",\"\");\r\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"paleta\", brewerClass);\r\n\t\tif (jQuery('#list_tematic_values').html() !== \"\"){\r\n\t\t\tupdatePaletaRangs();\r\n\t\t}\r\n\t});\r\n\t\r\n\tjQuery(\"#dialog_tematic_rangs\").data(\"capamare\", data);\r\n\t\r\n\tjQuery('#tipus_agrupacio_grp').hide();\r\n\tjQuery('#num_rangs_grp').hide();\r\n\tjQuery('#list_tematic_values').html(\"\");\r\n\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\r\n\tjQuery('.btn-reverse-palete').off('click');\r\n\tjQuery('.btn-reverse-palete').on('click',function(evt){\r\n\t\tvar glyp = jQuery('.btn-reverse-palete.glyphicon');\r\n\t\tvar reverse = false;\r\n\t\tif(glyp.hasClass('glyphicon-arrow-down')){\r\n\t\t\treverse = true;\r\n\t\t\tglyp.removeClass('glyphicon-arrow-down').addClass('glyphicon-arrow-up');\r\n\t\t}else{\r\n\t\t\treverse = false;\r\n\t\t\tglyp.removeClass('glyphicon-arrow-up').addClass('glyphicon-arrow-down');\r\n\t\t}\r\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"reverse\",reverse);\r\n\t\t//console.debug(jQuery(\"#dialog_tematic_rangs\").data(\"reverse\"));\r\n\t\tif (jQuery('#list_tematic_values').html() !== \"\"){\r\n\t\t\tupdatePaletaRangs();\r\n\t\t}\r\n\t});\r\n\t\r\n\tvar dataTem={\r\n\t\tbusinessId: data.businessid,\r\n\t\tuid: Cookies.get('uid')\r\n\t};\r\n\t\r\n\tif(data.tipus == t_url_file){\r\n\t\tvar urlFileLayer = controlCapes._layers[data.leafletid].layer;\r\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\", urlFileLayer.options);\r\n\t\tvar fields = {};\r\n\t\t//fields[window.lang.translate('Escull el camp')] = '---';\r\n\t\t//Recollim propName de les geometries de la capa\r\n\t\tvar dataNames = urlFileLayer.options.propName.split(',');\r\n\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\tfields[value] = value;\r\n\t\t});\r\n\t\t//creamos el select con los campos\r\n\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\r\n\t\tvar template1 = Handlebars.compile(source1);\r\n\t\tvar html1 = template1({fields:fields});\r\n\t\tjQuery('#dataField').html(html1);\r\n\t\t\r\n\t\tjQuery('#dataField').off('change');\r\n\t\tjQuery('#dataField').on('change',function(e){\r\n\t\t\tvar this_ = jQuery(this);\r\n\t\t\tif (this_.val() == \"---\"){\r\n\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\r\n\t\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t}else{\t\t\t\t\r\n\t\t\t\treadDataUrlFileLayer(urlFileLayer, this_.val()).then(function(results){\r\n\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\r\n\t\t\t\t\tgetTipusValuesVisualitzacio(results,data.geometrytype);\r\n\t\t\t\t});\t\t\t\r\n\t\t\t}\r\n\t\t});\t\t\t\r\n\t\t\r\n\t}else{\r\n\t\tvar dataNames = [];\r\n\t\tvar fields = {};\r\n\t\t//fields[window.lang.translate('Escull el camp')] = '---';\r\n\t\tdataNames = data.propname.split(',');\r\n\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\tif (value!='') \tfields[value] = value;\r\n\t\t});\r\n\t\tif(data.propname=='null' || data.propname==''){\r\n\t\t\tfields['nom']='nom';\r\n\t\t\tfields['text']='text';\r\n\t\t}\r\n\t\t\r\n\t\t//creamos el select con los campos\r\n\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\r\n\t\tvar template1 = Handlebars.compile(source1);\r\n\t\t\r\n\t\t\r\n\t\tvar html1 = template1({fields:fields});\r\n\t\tjQuery('#dataField').html(html1);\r\n\t\t\r\n\t\tjQuery('#dataField').off('change');\r\n\t\tjQuery('#dataField').on('change',function(e){\r\n\t\t\tvar this_ = jQuery(this);\r\n\t\t\tif (this_.val() == \"---\"){\r\n\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\r\n\t\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t}else{\r\n\t\t\t\tvar dataVis={\r\n\t\t\t\t\t\tbusinessId1: data.businessid,\r\n\t\t\t\t\t\tkey: this_.val(),\r\n\t\t\t\t\t\tuid: Cookies.get('uid')\r\n\t\t\t\t};\r\n\t\t\t\tgetValuesFromKeysProperty(dataVis).then(function(results){\r\n\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\r\n\t\t\t\t\tgetTipusValuesVisualitzacio(results);\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\t\r\n\t\t\r\n\t\t//Si es una visualitzacio\r\n\t\t/*getVisualitzacioByBusinessId(dataTem).then(function(results){\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\tvar visualitzacio = results.results;\r\n\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\", visualitzacio);\r\n\t\t\t\tvar fields = {};\r\n\t\t\t\tfields[window.lang.translate('Escull el camp')] = '---';\r\n\t\t\t\tvar dataNames = [];\r\n\t\t\t\tif (visualitzacio.options){\r\n\t\t\t\t\t//var options = JSON.parse(visualitzacio.options);\r\n\t\t\t\t\tvar options;\r\n\t\t\t\t\tif(typeof (visualitzacio.options)==\"string\"){\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\toptions = JSON.parse(visualitzacio.options);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcatch (err) {\r\n\t\t\t\t\t\t\toptions = visualitzacio.options;\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\toptions = visualitzacio.options;\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(options.propName){\r\n\t\t\t\t\t\tdataNames = options.propName.split(',');\r\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\t\t\t\t\tfields[value] = value;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tif (results.geometries && results.geometries.options){\r\n\t\t\t\t\t\t\tdataNames = results.geometries.options.split(',');\r\n\t\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\t\t\t\t\t\tfields[value] = value;\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tif (results.geometries && results.geometries.options){\r\n\t\t\t\t\t\tdataNames = results.geometries.options.split(',');\r\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\r\n\t\t\t\t\t\t\tfields[value] = value;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t//creamos el select con los campos\r\n\t\t\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\r\n\t\t\t\tvar template1 = Handlebars.compile(source1);\r\n\t\t\t\tvar html1 = template1({fields:fields});\r\n\t\t\t\tjQuery('#dataField').html(html1);\r\n\t\t\t\t\r\n\t\t\t\tjQuery('#dataField').off('change');\r\n\t\t\t\tjQuery('#dataField').on('change',function(e){\r\n\t\t\t\t\tvar this_ = jQuery(this);\r\n\t\t\t\t\tif (this_.val() == \"---\"){\r\n\t\t\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\r\n\t\t\t\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\treadDataVisualitzacio(visualitzacio, this_.val()).then(function(results){\r\n\t\t\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\r\n\t\t\t\t\t\t\tgetTipusValuesVisualitzacio(results);\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\t\t\t\r\n\t\t\t}else{\r\n\t\t\t\t//TODO error\r\n\t\t\t\tconsole.debug(\"getVisualitzacioByBusinessId ERROR\");\t\t\t\t\r\n\t\t\t}\r\n\t\t},function(results){\r\n\t\t\t//TODO error\r\n\t\t\tconsole.debug(\"getVisualitzacioByBusinessId ERROR\");\r\n\t\t});\t*/\r\n\t}\r\n\t\t\t\t\r\n}\r\n\r\nfunction getTipusValuesVisualitzacio(results,geomType){\r\n\t//console.debug(\"getTipusValuesVisualitzacio\");\r\n\tvar resultats;\r\n\tif (results.valors!=undefined) resultats=results.valors;\r\n\telse resultats=results;\r\n\t\r\n\tvar geometryType;\r\n\tif (results.geomType!=undefined) geometryType=results.geomType;\r\n\telse geometryType=geomType;\r\n\r\n\t\r\n\tif (resultats.length === 0){\r\n\t\tvar warninMSG=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest camp no te valors')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\r\n\t\tjQuery('#list_tematic_values').html(warninMSG);\r\n\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t}else{\r\n\t\tvar nodata = [];\r\n\t\tvar esText = false;\r\n\t\tvar arr = jQuery.grep(resultats, function( n, i ) {\r\n\t\t\tvar isText = false;\r\n\t\t\tif (!jQuery.isNumeric(n)){\r\n\t\t\t\tif (n == \"Sense valor\" || n == \"Sin valor\" || n == \"Empty value\" || n == NODATA_VALUE){\r\n\t\t\t\t\tnodata.push(n);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tisText = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn isText;\r\n\t\t});\r\n\t\tif (nodata.length !== 0){\r\n\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"nodata\",true);\r\n\t\t}\r\n\t\tif (arr.length === 0){ //rangos o semafòric\r\n\t\t\tjQuery('#tipus_agrupacio_grp').show();\r\n\t\t\tjQuery('#num_rangs_grp').show();\r\n\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\r\n\t\t\tjQuery( \"input:radio[name=rd_tipus_agrupacio]\").on('change',function(e){\r\n\t\t\t\tvar this_ = jQuery(this);\r\n\t\t\t\tif (this_.val() == \"U\"){\r\n\t\t\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\t\t\tshowVisualitzacioDataUnic(resultats,geometryType).then(function(results1){\r\n\t\t\t\t\t\tloadTematicValueTemplate(results1,'unic');\r\n\t\t\t\t\t});\r\n\t\t\t\t}else if(this_.val() == \"S\") {\r\n\t\t\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\t\t\tcreateSemaforicValues(geometryType);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t\t\tjQuery('#num_rangs_grp').show();\r\n\t\t\t\t\tjQuery('#cmb_num_rangs').val(\"---\");\r\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tjQuery('#cmb_num_rangs').on('change',function(e){\r\n\t\t\t\tvar this_ = jQuery(this);\r\n\t\t\t\tif (this_.val() == \"---\"){\r\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\r\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tcreateRangsValues(this_.val(),geometryType);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tjQuery('#rd_tipus_rang').click().change();\t\t\r\n\t\t}else{ //unicos\r\n\t\t\tjQuery('#tipus_agrupacio_grp').hide();\r\n\t\t\tjQuery('#num_rangs_grp').hide();\r\n\t\t\tshowVisualitzacioDataUnic(resultats,geometryType).then(function(results1){\r\n\t\t\t\tloadTematicValueTemplate(results1,'unic');\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction showVisualitzacioDataUnic(values,geomType){\r\n\tvar defer = jQuery.Deferred();\r\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\r\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\r\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\tjQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\",\"unic\");\r\n\t//Ordenar valores\r\n\tvalues.sort(sortByValueMax);\r\n\t//console.debug(paleta);\r\n\tpaleta = paleta ? paleta : 'Paired';\r\n\t//console.debug(values.length);\r\n\tvar scale = createScale(paleta, values.length, reverse);\t\r\n\tvar ftype = transformTipusGeometry(geomType);\t\r\n\tvar valuesStyle = jQuery.map( values, function( a, i) {\r\n\t\t//console.debug(createIntervalStyle(i,ftype,scale));\r\n\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale), index: i};\r\n\t});\r\n\tdefer.resolve(valuesStyle);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction createIntervalStyle(index, geometryType, paleta, nodata){\r\n\t//console.debug(\"createIntervalStyle\");\r\n\tvar defStyle;\r\n\tvar ftype = transformTipusGeometry(geometryType);\r\n\t\t\r\n\tif (ftype == t_marker){\r\n\t\tdefStyle = jQuery.extend({}, default_circulo_style);\r\n\t\tdefStyle.fillColor = paleta(index).hex();\r\n\t\tif(nodata){\r\n\t\t\tdefStyle.fillColor = NODATA_COLOR;\r\n\t\t}\r\n\t\tdefStyle.isCanvas = true;\t\t\r\n\t}else if (ftype == t_polyline){\r\n\t\tdefStyle = jQuery.extend({}, default_line_style);\r\n\t\tdefStyle.color = paleta(index).hex();\r\n\t\tif(nodata){\r\n\t\t\tdefStyle.color = NODATA_COLOR;\r\n\t\t}\r\n\t}else if (ftype == t_polygon){\r\n\t\tdefStyle = jQuery.extend({}, default_area_style);\r\n\t\tdefStyle.color = paleta(index).hex();\r\n\t\tif(nodata){\r\n\t\t\tdefStyle.color = NODATA_COLOR;\r\n\t\t}\r\n\t}\r\n\tdefStyle.geometryType = ftype;\r\n\treturn defStyle;\r\n}\r\n\r\nfunction showTematicRangs(geomType){\r\n\t//TODO cambiar nombre a la funcion\r\n\t//console.debug(\"showTematicRangs\");\r\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"rangs\");\r\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\r\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\r\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\tjQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\",\"rangs\");\r\n\tpaleta = paleta ? paleta : 'Paired';\r\n\tvar scale = createScale(paleta, values.length, reverse);\r\n\t\t\t\r\n\tvar defer = jQuery.Deferred();\r\n\tvar valuesStyle = [];\r\n\tvar ftype = transformTipusGeometry(geomType);\r\n\tvaluesStyle = jQuery.map( values, function( a, i ) {\r\n\t\tif (a.nodata){\r\n\t\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale,true), index: i};\r\n\t\t}else{\r\n\t\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale,false), index: i};\r\n\t\t}\r\n\t});\r\n\tdefer.resolve(valuesStyle);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction div2RangStyle(tematic, tdElem){\r\n\t//console.debug(\"div2RangStyle\");\r\n\tvar rangStyle;\r\n\t\r\n\tvar ftype = transformTipusGeometry(tematic.geometrytype);\r\n\tvar divElement;\t\r\n\tif (ftype == t_marker){\r\n\t\tdivElement = tdElem.find('div');\r\n\t\trangStyle = {\r\n\t\t\tborderColor :  \"#ffffff\",\r\n\t\t\tborderWidth :  2,\r\n\t\t\tsimbolSize: parseInt(parseInt(divElement.css('height'))/2.4),\r\n\t\t\tcolor: jQuery.Color(divElement.css('background-color')).toHexString(),\r\n\t\t\topacity: 90\r\n\t\t};\r\n\t}else if (ftype == t_polyline){\r\n\t\tdivElement = tdElem.find('canvas')[0].getContext(\"2d\");\r\n\t\trangStyle = {\r\n\t\t\tlineWidth :  divElement.lineWidth,\r\n\t\t\tcolor: divElement.strokeStyle,\r\n\t\t};\r\n\t}else if (ftype == t_polygon){\r\n\t\tdivElement = tdElem.find('canvas')[0].getContext(\"2d\");\r\n\t\trangStyle = {\r\n\t\t\tborderColor :  divElement.strokeStyle,\r\n\t\t\tborderWidth :  divElement.lineWidth,\r\n\t\t\tcolor: jQuery.Color(divElement.fillStyle).toHexString(),\r\n\t\t\topacity: Math.round(jQuery.Color(divElement.fillStyle).alpha()*100)\t\t\r\n\t\t};\r\n\t}\r\n\treturn rangStyle;\r\n}\r\n\r\nfunction createTematicLayerCategories(event, extraOptions, extraData, deferred){\r\n//\tconsole.debug(\"createTematicLayerCategories\"); //al guardar\r\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'categories', 1]});\r\n\tconsole.info(\"ok\");\r\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\r\n\tvar tipusRang = $(\"input:radio[name=rd_tipus_agrupacio]:checked\").val();\r\n//\tvar visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\r\n//\tconsole.debug(visualitzacio);\r\n\tvar tematicFrom = jQuery(\"#dialog_tematic_rangs\").data(\"capamare\");\r\n\tvar capaMare = controlCapes._layers[tematicFrom.leafletid].layer;\r\n\tvar rangsTr = jQuery('#list_tematic_values tbody tr');\r\n\r\n\tvar rangs = [];\r\n\tvar layerName = capaMare.options.nom+\" \"+window.lang.translate(\"Categories\");\r\n\t\r\n\tif(\"S\" != tipusRang)\r\n\t{\r\n\r\n\t\tjQuery.each(rangsTr, function( index, value ) {\r\n\t\t\tvar _this = jQuery(value);\r\n\t\t\tvar tdRang, tdMin, tdMax;\r\n\t\t\tvar tdVal;\r\n\t\t\tvar rang = {};\r\n\t\t\tvar rangEstil;\r\n\t\t\tif (_this.children().length == 2){\r\n\t\t\t\ttdRang = _this.find('td:eq(0)');\r\n\t\t\t\t//console.debug(tdRang);\r\n\t\t\t\ttdVal = _this.find('td:eq(1)');\r\n\t\t\t\t//console.debug(tdVal);\r\n\t\t\t\trangEstil = div2RangStyle(tematicFrom, tdVal);\r\n\t\t\t\trang.estil = rangEstil;\r\n\t\t\t\trang.valueMax = tdRang.text();\r\n\t\t\t\trang.valueMin = tdRang.text();\r\n\t\t\t\trangs.push(rang);\r\n\t\t\t}else{\r\n\t\t\t\ttdMin = _this.find('td:eq(0)');\r\n\t\t\t\ttdMax = _this.find('td:eq(1)');\r\n\t\t\t\ttdVal = _this.find('td:eq(2)');\r\n\t\t\t\t//console.debug(tdMin);\r\n\t\t\t\t//console.debug(tdMax);\r\n\t\t\t\t//console.debug(tdVal);\r\n\t\t\t\trangEstil = div2RangStyle(tematicFrom, tdVal);\r\n\t\t\t\trang.estil = rangEstil; \r\n\t\t\t\trang.valueMin = tdMin.find('input').val();\r\n\t\t\t\trang.valueMax = tdMax.find('input').val();\r\n\t\t\t\trangs.push(rang);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tvar auxRangs = $(\"#dialog_tematic_rangs\").data(\"rangs\");\r\n\t\t$.each(auxRangs, function(index, value)\r\n\t\t{\r\n\r\n\t\t\tvar rang = {};\r\n\t\t\trang.estil = div2RangStyle(tematicFrom, $(rangsTr[index]).find(\"td:last\"));\r\n\t\t\trang.valueMin = value.min;\r\n\t\t\trang.valueMax = value.max;\r\n\t\t\trangs.push(rang);\r\n\r\n\t\t});\r\n\r\n\t\tvar key = $(\"#dataField\").val();\r\n\t\tlayerName = key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + auxRangs[1].min + \")\";\r\n\t\textraData = {trafficLightKey: key, trafficLightValue: auxRangs[1].min, trafficLightLowerColor: rangs[0].estil.color, \r\n\t\t\ttrafficLightEqualColor: rangs[1].estil.color, trafficLightHigherColor: rangs[2].estil.color};\r\n\r\n\t}\r\n\t//console.debug(rangs);\r\n\tvar estils = {\r\n\t\testils: rangs,\r\n\t\tdataField: jQuery('#dataField').val().toLowerCase(),\r\n\t\tlabelField: jQuery('#dataField').val().toLowerCase()\r\n\t};\r\n\tvar data1 = {};\r\n\tif(capaMare.tipus == t_url_file || tematicFrom.tipus==t_url_file){\r\n\t\tdata1 = {\r\n\t\t\tuid: Cookies.get('uid'),\r\n\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t};\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tloadURLfileLayer(data.results).then(function(results){\r\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t\t//L'afegim a les dades guardades\r\n\t\t\t\t\t\t\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers = {};\r\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._options = {};\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers[data.layer.businessId] = data.visualitzacio;\r\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._options[data.layer.businessId] = data.layer;\r\n\t\t\t\t\t\t\t\t\t\tif(undefined !== deferred)\r\n\t\t\t\t\t\t\t\t\t\t\tdeferred.resolve(results._leaflet_id);\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\tbusy=false;\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\t\t\t\t\r\n\t\t\t\tvar options = {\r\n\t\t\t\t\t\turl: capaMare.options.url,\r\n\t\t\t\t\t\ttem: tem_clasic,\r\n\t\t\t\t\t\tstyle: estils,\r\n\t\t\t\t\t\torigen: capaMare.options.businessId,\r\n\t\t\t\t\t\ttipus : t_url_file,\r\n\t\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\r\n\t\t\t\t\t\ttipusAcc: capaMare.options.tipusAcc,\r\n\t\t\t\t\t\ttipusCodi: capaMare.options.tipusCodi,\r\n\t\t\t\t\t\ttipusFont: capaMare.options.tipusFont,\r\n\t\t\t\t\t\tnomCampCodi: capaMare.options.nomCampCodi,\r\n\t\t\t\t\t\testil_do: estils,\r\n\t\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\r\n\t\t\t\t\t\tgeometryType: capaMare.options.geometryType,\r\n\t\t\t\t\t\tcolX: capaMare.options.colX,\r\n\t\t\t\t\t\tcolY: capaMare.options.colY,\r\n\t\t\t\t\t\tdinamic: capaMare.options.dinamic\t\t\t\t\t\t\r\n\t\t\t\t\t};\r\n\t\t\t\t\t$.extend(options, extraOptions);\r\n\t\t\t\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\r\n\t\t\t\t\t\tserverName: layerName,\r\n\t\t\t\t\t\tserverType: capaMare.options.tipus,\r\n\t\t\t\t\t\tcalentas: false,\r\n\t\t\t\t        activas: true,\r\n\t\t\t\t        visibilitats: true,\r\n\t\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\r\n\t\t\t\t        epsg: capaMare.options.epsgIN,\r\n\t\t\t\t        transparency: true,\r\n\t\t\t\t        opacity: 1,\r\n\t\t\t\t        visibilitat: 'O',\r\n\t\t\t\t        url: capaMare.options.url,\r\n\t\t\t\t\t\toptions: JSON.stringify(options),\r\n\t\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\t\ttipusTematic:\"t_url_file\",\r\n\t\t\t\t\t\turlTematic:paramUrl.createServidorInMap,\r\n\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\r\n\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\r\n\t\t\t\t\t};\r\n\t\t\t\t\t$.extend(data, extraData);\r\n\t\t\t\t\tcallActions(data);\r\n\t\t\t\t\t/*createServidorInMap(data);/*.then(function(results){\r\n\t\t\t\t\t\tbusy=false;\t\t\t\t\t\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\tloadURLfileLayer(results.results).then(function(results){\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});*/\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\t\t\t\r\n\t\t });\r\n\t}else{\r\n\t\tdata1 = {\r\n\t\t\tuid: Cookies.get('uid'),\r\n\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t};\r\n\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\tvar tmpFile=\"\";\r\n\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t//Fem polling\r\n\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t//console.debug(data);\r\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\")!=-1 || data.status.indexOf(\"PAS 3\")!=-1) && busy){\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\r\n\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\r\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t\t//L'afegim a les dades guardades\r\n\t\t\t\t\t\t\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers = {};\r\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._options = {};\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers[data.layer.businessId] = data.visualitzacio;\r\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._options[data.layer.businessId] = data.layer;\r\n\t\t\t\t\t\t\t\t\t\tif(undefined !== deferred)\r\n\t\t\t\t\t\t\t\t\t\t\tdeferred.resolve(results._leaflet_id);\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\t\tbusinessId: tematicFrom.businessid,//businessId id de la visualización de origen\r\n\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t        mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t        nom: layerName,\r\n\t\t\t\t        activas: true,\r\n\t\t\t\t        order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t        dataField: jQuery('#dataField').val(),//¿?¿?¿?¿?\r\n\t\t\t\t\t\ttem: tem_clasic,//visualitzacio.from,//tem_simple\r\n\t\t\t\t\t\testils: JSON.stringify(estils),\r\n\t\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\t\ttipusTematic:\"t_visualitzacio_categories\",\r\n\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioTematica,\r\n\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\r\n\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\r\n\t\t\t\t\t};\r\n\t\t\t\t\t$.extend(data, extraData);\r\n\t\t\t\t\tcallActions(data);\r\n\t\t\t\t//\tcreateVisualitzacioTematica(data);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t}\r\n\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t/*createVisualitzacioTematica(data);/*.then(function(results){\r\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\tbusy=false;\r\n\t\t\t\tif(results.status == 'OK'){\r\n\t\t\t\t\tvar defer = $.Deferred();\r\n\t\t\t\t\treadVisualitzacio(defer, results.visualitzacio, results.layer).then(function(results){\r\n\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t});\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t});\t\t*/\r\n\t\t});\t\t\t\t\r\n\t}\r\n\t\r\n\tevent.preventDefault();\r\n\tevent.stopImmediatePropagation();\r\n\r\n\tif(\"undefined\" !== typeof deferred)\r\n\t\treturn deferred.promise();\r\n\t\r\n}\r\n\r\nfunction updatePaletaRangs(softColors){\r\n\t\r\n\tvar softColorsUsed = (undefined !== softColors && softColors);\r\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\r\n\tvar tematicFrom = jQuery(\"#dialog_tematic_rangs\").data(\"capamare\");\r\n\t\r\n\t//console.debug( jQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\"));\r\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\");\r\n\t//values = values;\r\n\tvar rangs = jQuery(\"#dialog_tematic_rangs\").data(\"rangs\");\r\n\t\r\n\tvar tipusrang = jQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\");\r\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\t\r\n\r\n\t\r\n\tvar val_leng = 0;\r\n\tif (tipusrang == 'rangs'){\r\n\t\tval_leng = rangs.length;\r\n\t}else{\r\n\t\tval_leng = values.length;\r\n\t}\r\n\r\n\t//If soft colors are used instead of getting the [0, val_leng] and the rest evenly distributed\r\n\t//we use the half values of each interval\r\n\t//Example: 3 colors from [0, 3]\r\n\t//Non soft colors gets the colors on the [0, 1.5, 3] points\r\n\t//Soft colors gets the colors on the [0.75, 1.5, 2.25] points\r\n\t\r\n\tvar ftype = transformTipusGeometry(tematicFrom.geometrytype);\r\n\tpaleta = paleta ? paleta : 'Paired';\r\n\r\n\tvar scale = createScale(paleta, val_leng, reverse);\r\n\t\r\n\tif (ftype == t_marker){\r\n\t\tvar elems = $(\"#list_tematic_values tbody td div\");\r\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\r\n\t\tvar factor = val_leng/length;\r\n\t\tvar start = (softColors ? factor : 0);\r\n\t\telems.each(function(i, elm){\r\n\t\t\tvar color = scale(start + i*factor).hex();\r\n\t\t\tjQuery(elm).css('background-color', color);\r\n\t\t});\r\n\t}else if (ftype == t_polyline){\r\n\t\tvar elems = $(\"#list_tematic_values canvas\");\r\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\r\n\t\tvar factor = val_leng/length;\r\n\t\tvar start = (softColors ? factor : 0);\r\n\t\telems.each(function(i, elm){\r\n\t\t\tvar color = scale(start + i*factor).hex();\r\n\t\t\taddGeometryInitLRang(elm, {style:{color: color}});\r\n\t\t});\r\n\t}else if (ftype == t_polygon){\r\n\t\tvar elems = $(\"#list_tematic_values canvas\");\r\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\r\n\t\tvar factor = val_leng/length;\r\n\t\tvar start = (softColors ? factor : 0);\r\n\t\telems.each(function(i, elm){\r\n\t\t\tvar color = scale(start + i*factor).hex();\r\n\t\t\taddGeometryInitPRang(elm, {style:{color: color}});\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction createSemaforicValues(geomType)\r\n{\r\n\r\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values\");\r\n\tif (values.valors!=undefined) values = values.valors;\r\n\tvar nodata = jQuery(\"#dialog_tematic_rangs\").data(\"nodata\");\r\n\tvalues = jQuery.grep(values, function( n, i ) {\r\n\t\treturn (n != NODATA_VALUE && jQuery.isNumeric(parseFloat(n)));\r\n\t});\r\n\tvalues.sort(function(a,b){return a-b;});\r\n\tvar min = parseFloat(values[0]);\r\n\tvar max = parseFloat(values[values.length-1]);\r\n\tvar half = (max + min)/2;\r\n\r\n\t//Creem un vector amb els següents rangs:\r\n\t// [valor mínim, valor anterior al valor mig)\r\n\t// [valor anterior al valor mig, valor següent al valor mig)\r\n\t// [valor següent al valor mig, valor màxim]\r\n\tvar newRangs = [{min: min, max: max}];\r\n\tvar i = 0;\r\n\twhile (values[i] <= half)\r\n\t\ti++;\r\n\t\r\n\tnewRangs[0].max = parseFloat(values[i-1]);\r\n\tnewRangs.push({min: parseFloat(values[i-1]), max: parseFloat(values[i])});\r\n\tnewRangs.push({min: parseFloat(values[i]), max: max});\r\n\r\n\tif (nodata){\r\n\t\tnewRangs.push({min: NODATA_VALUE, max: NODATA_VALUE, nodata:true});\r\n\t}\r\n\t\r\n\tjQuery(\"#dialog_tematic_rangs\").data(\"rangs\", newRangs);\r\n\tshowTematicRangs(geomType).then(function(results){\r\n\t\tloadTematicValueTemplate(results,'semaforic');\r\n\t\tupdatePaletaRangs();\r\n\t});\r\n\r\n}\r\n\r\nfunction createRangsValues(rangs,geomType){\r\n\t//console.debug(\"createRangsValues\");\r\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values\");\r\n\tif (values.valors!=undefined) values = values.valors;\r\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\r\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\r\n\tvar nodata = jQuery(\"#dialog_tematic_rangs\").data(\"nodata\");\r\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\tvalues = jQuery.grep(values, function( n, i ) {\r\n\t\treturn (n != NODATA_VALUE && jQuery.isNumeric(parseFloat(n)));\r\n\t});\r\n\tvalues.sort(function(a,b){return a-b;});\r\n\tvar min = parseFloat(values[0]);\r\n\tvar max = parseFloat(values[values.length-1]);\r\n\tvar deltaR = (max - min)/rangs;\r\n\tdeltaR = parseFloat(deltaR.toFixed(2));\r\n\tvar newRangs = [];\r\n\tvar i = 0;\r\n\twhile (min < max && i < rangs){\r\n\t\tif (i == (rangs-1)){\r\n\t\t\tnewRangs.push({min: min, max: max});\r\n\t\t}else{\r\n\t\t\tvar tmpmax = parseFloat((min+deltaR).toFixed(2));\r\n\t\t\tnewRangs.push({min: min, max: tmpmax});\r\n\t\t\tmin = tmpmax;\r\n\t\t}\r\n\t\ti++;\r\n\t}\r\n\tif (nodata){\r\n\t\tnewRangs.push({min: NODATA_VALUE, max: NODATA_VALUE, nodata:true});\r\n\t}\r\n\t\r\n\tjQuery(\"#dialog_tematic_rangs\").data(\"rangs\", newRangs);\r\n\tshowTematicRangs(geomType).then(function(results){\r\n\t\tloadTematicValueTemplate(results,'rangs');\r\n\t});\r\n}\r\n\r\nfunction loadTematicValueTemplate(results, rtype){\r\n\r\n\tvar source1;\r\n\tvar geometryType = results[0].style.geometryType;\r\n\tif (!geometryType){\r\n\t\tgeometryType = results[0].style.tipus;\r\n\t}\r\n\tvar ftype = transformTipusGeometry(geometryType);\r\n\tif (ftype == t_marker){\r\n\t\tif (rtype == 'rangs'){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-punt-template\").html();\r\n\t\t}else if(rtype == \"unic\"){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-punt-template\").html();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-punt-template\").html();\r\n\t\t}\r\n\t\t\r\n\t}else if (ftype == t_polyline){\r\n\t\tif (rtype == 'rangs'){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-polyline-template\").html();\r\n\t\t}else if(rtype == \"unic\"){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-polyline-template\").html();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-polyline-template\").html();\r\n\t\t}\r\n\t\t\r\n\t}else if (ftype == t_polygon){\r\n\t\tif (rtype == 'rangs'){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-polygon-template\").html();\r\n\t\t}else if(rtype == \"unic\"){\r\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-polygon-template\").html();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-polyline-template\").html();\r\n\t\t}\r\n\t}\r\n\t\r\n\tvar resultsNoRepetits=[];\r\n\tif (rtype=='unic'){\t\r\n\t\tvar data = {};\t\t\r\n\t\tjQuery.grep(results,  function( n, i ) {\r\n\t\t\t\tvar value = n.v;\r\n\t\t\t\tif(isBlank(value)) value = \"nodata\";\r\n\t\t\t\tif(!data[value]){\r\n\t\t\t\t\tdata[value] = value;\r\n\t\t\t\t\tresultsNoRepetits.push(n);\r\n\t\t\t\t}\r\n\t\t});\r\n\t\t//match ints and floats/decimals\r\n\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\t\tvar resultsFloat = [];\r\n\t\tvar i=0;\r\n\t\tvar j=0;\r\n\t\tjQuery.grep(resultsNoRepetits, function( n, i ) {\r\n\t\t\t//console.debug(n.v);\r\n\t\t\t//console.debug(floatRegex.test(n.v));\t\t\t\r\n\t\t\tif (floatRegex.test(n.v)) {\r\n\t\t\t\t//console.debug(n.v);\r\n\t\t\t\tresultsFloat[j]=n;\r\n\t\t\t\tj++;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t});\r\n\t\tvar template1 = Handlebars.compile(source1);\r\n\t\tvar html1 = \"\";\r\n\t\tif (resultsFloat.length>0 && resultsNoRepetits.length == resultsFloat.length) {\r\n\t\t\t//resultsFloat.sort(function(a,b){return a.v-b.v;});\r\n\t\t\tresultsFloat.sort(sortByValueMax);\r\n\t\t\thtml1 = template1({values:resultsFloat});\r\n\t\t}\r\n\t\telse {\r\n\t\t\tresultsNoRepetits.sort(sortByValueMax);\r\n\t\t\thtml1 = template1({values:resultsNoRepetits});\r\n\t\t}\r\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\",resultsNoRepetits);\r\n\t}\r\n\telse {\r\n\t\t\r\n\t\t//match ints and floats/decimals\r\n\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\t\tvar resultsFloat = [];\r\n\t\tvar i=0;\r\n\t\tjQuery.grep(results, function( n, i ) {\r\n\t\t\tif (floatRegex.test(n.v)) {\r\n\t\t\t\tresultsFloat[i]=n;\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\tvar template1 = Handlebars.compile(source1);\r\n\t\tvar html1 = \"\";\r\n\t\tif (resultsFloat.length>0) {\r\n\t\t\tresultsFloat.sort(function(a,b){return a.v-b.v;});\r\n\t\t\thtml1 = template1({values:resultsFloat});\r\n\t\t}\r\n\t\telse if(\"semaforic\" == rtype)\r\n\t\t{\r\n\r\n\t\t\thtml1 = template1({value:results[1].v.min});\r\n\r\n\t\t}\r\n\t\telse {\r\n\t\t\tresults.sort();\r\n\t\t\thtml1 = template1({values:results});\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\tjQuery('#list_tematic_values').html(html1);\r\n\tjQuery('#dialog_tematic_rangs .btn-success').show();\r\n\tif (ftype == t_marker){\r\n\t\tjQuery('#list_tematic_values div.awesome-marker-web').on('click',function(e){\r\n\t\t\tvar _this = this;\r\n\t\t\tvar _$this = $(this);\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t\r\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\r\n\t\t\t\t_$this.css('background-color',e.color);\r\n\t\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t}else if (ftype == t_polyline){\r\n\t\tjQuery('#list_tematic_values canvas').each(function(i, val){\r\n\t\t\taddGeometryInitLRang(val, results[i]);\r\n\t\t});\r\n\t\t\r\n\t\tjQuery('#list_tematic_values canvas').on('click',function(e){\r\n\t\t\tvar _this = this;\r\n\t\t\tvar _$this = $(this);\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t\r\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\r\n\t\t\t\tvar canvas = _this;\r\n\t\t\t\tvar style = {style:{}};\r\n\t\t\t\tstyle.style.color = e.color;\r\n\t\t\t\taddGeometryInitLRang(canvas, style);\r\n\t\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t});\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t}else if (ftype == t_polygon){\r\n\t\t\r\n\t\tjQuery('#list_tematic_values canvas').each(function(i, val){\r\n\t\t\taddGeometryInitPRang(val, results[i]);\r\n\t\t});\r\n\t\t\r\n\t\tjQuery('#list_tematic_values canvas').on('click',function(e){\r\n\t\t\tvar _this = this;\r\n\t\t\tvar _$this = $(this);\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t\r\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\r\n\t\t\t\r\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\r\n\t\t\t\tvar canvas = _this;\r\n\t\t\t\tvar style = {style:{}};\r\n\t\t\t\tstyle.style.color = e.color;\r\n\t\t\t\taddGeometryInitPRang(canvas, style);\r\n\t\t\t\t$(\"#temp_color_pallete\").remove();\r\n\t\t\t});\r\n\t\t\t\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction addGeometryInitLRang(canvas, style){\r\n\tvar\tcv_ctx_l=canvas.getContext(\"2d\");\r\n\tvar scale = 0.7;\r\n\t\r\n\tcv_ctx_l.clearRect(0, 0, canvas.width, canvas.height);\r\n\t\t\r\n\tcv_ctx_l.shadowColor = '#999';\r\n\tcv_ctx_l.shadowBlur = 4;\r\n\tcv_ctx_l.shadowOffsetX = 2;\r\n\tcv_ctx_l.shadowOffsetY = 2;\r\n\t\r\n\tcv_ctx_l.moveTo(0.7*scale,39.42*scale);\r\n\tcv_ctx_l.lineTo(2.05*scale,34.43*scale);\r\n\tcv_ctx_l.lineTo(3.62*scale,31.00*scale);\r\n\tcv_ctx_l.lineTo(5.95*scale,27.72*scale);\r\n\tcv_ctx_l.lineTo(8.17*scale,25.61*scale);\r\n\tcv_ctx_l.lineTo(10.72*scale,23.84*scale);\r\n\tcv_ctx_l.lineTo(13.059*scale,22.73*scale);\r\n\tcv_ctx_l.lineTo(15.32*scale,22.28*scale);\r\n\tcv_ctx_l.lineTo(17.76*scale,22.08*scale);\r\n\tcv_ctx_l.lineTo(20.30*scale,21.47*scale);\r\n\tcv_ctx_l.lineTo(23.28*scale,20.51*scale);\r\n\tcv_ctx_l.lineTo(25.88*scale,18.90*scale);\r\n\tcv_ctx_l.lineTo(28.265*scale,16.83*scale);\r\n\tcv_ctx_l.lineTo(29.9*scale,14.71*scale);\r\n\tcv_ctx_l.lineTo(31.89*scale,12.195*scale);\r\n\tcv_ctx_l.lineTo(33.62*scale,9.42*scale);\r\n\tcv_ctx_l.lineTo(34.81*scale,6.64*scale);\r\n\tcv_ctx_l.lineTo(35.46*scale,3.92*scale);\r\n\tcv_ctx_l.lineTo(35.52*scale,0.54*scale);\r\n\tcv_ctx_l.strokeStyle=style.style.color;\r\n\tcv_ctx_l.lineWidth=3;\r\n\tcv_ctx_l.stroke(); \t\r\n}\r\n\r\nfunction addGeometryInitPRang(canvas, style){\r\n\tvar\tcv_ctx_p=canvas.getContext(\"2d\");\r\n\tvar scale = 0.7;\r\n\t\r\n\tcv_ctx_p.clearRect(0, 0, canvas.width, canvas.height);\r\n\t\t\r\n\tcv_ctx_p.shadowColor = '#999';\r\n\tcv_ctx_p.shadowBlur = 4;\r\n\tcv_ctx_p.shadowOffsetX = 2;\r\n\tcv_ctx_p.shadowOffsetY = 2;\r\n\t\r\n\tcv_ctx_p.moveTo(5.13*scale,15.82*scale);\r\n\tcv_ctx_p.lineTo(25.49*scale,5.13*scale);\r\n\tcv_ctx_p.lineTo(37.08*scale,13.16*scale);\r\n\tcv_ctx_p.lineTo(20.66*scale,38.01*scale);\r\n\tcv_ctx_p.lineTo(2.06*scale,33.67*scale);\r\n\tcv_ctx_p.closePath();\r\n\tcv_ctx_p.strokeStyle=\"#ffffff\"; //hex\r\n\tcv_ctx_p.fillStyle=jQuery.Color(style.style.color).alpha(0.75).toRgbaString(); //rgba\r\n\tcv_ctx_p.lineWidth=1;\r\n\tcv_ctx_p.fill();\r\n\tcv_ctx_p.stroke();\r\n}\r\n\r\nfunction readDataUrlFileLayer(urlFileLayer, key){\r\n\t\r\n\tvar defer = jQuery.Deferred();\r\n\tvar data = {};\r\n\tvar dataValues = [];\t\r\n\t\r\n\tjQuery.each( urlFileLayer._layers, function(i,feature) {\r\n\t\t//var value = feature.properties[key.toLowerCase()];\r\n\t\tvar value = feature.feature.properties[key];\r\n\t\tif(!data[value]){\r\n\t\t\tdata[value] = value;\r\n\t\t\tdataValues.push(value);\r\n\t\t}\r\n\t});\r\n\t\r\n\tdefer.resolve(dataValues);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction readDataVisualitzacio(visualitzacio, key){\r\n\t//console.debug(\"readDataVisualitzacio\");\r\n\tvar defer = jQuery.Deferred();\r\n\tvar data = {};\r\n\tvar dataValues = [];\r\n\tjQuery.each(visualitzacio.estil, function(index, item){\r\n\t\tjQuery.each( item.geometria.features, function(i,feature) {\r\n\t\t\t//var value = feature.properties[key.toLowerCase()];\r\n\t\t\tvar value = feature.properties[key];\r\n\t\t\t//Si es blanc assignem categoria \"Sense valor\" com una més\r\n\t\t\t//if(isBlank(value)) value = window.lang.translate(\"Sense valor\");\r\n\t\t\tif(isBlank(value)) value = \"nodata\";\r\n\t\t\tif(!data[value]){\r\n\t\t\t\tdata[value] = value;\r\n\t\t\t\tdataValues.push(value);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\tdefer.resolve(dataValues);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction createScale(paleta, length, reverse){\r\n\tvar scale = ColorScales.createScale(paleta, length, reverse);\r\n\treturn scale;\r\n}\r\n\r\n\r\n\r\nfunction createTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare){\r\n\tvar paleta,reverse,dataField,labelField,tipusClasicTematic;\r\n\tif (sublayer.layer.options.paleta!=undefined) paleta = sublayer.layer.options.paleta;\r\n\tif (sublayer.layer.options.reverse!=undefined) reverse = sublayer.layer.options.reverse;\r\n\tif (sublayer.layer.options.dataField!=undefined) dataField = sublayer.layer.options.dataField;\r\n\tif (sublayer.layer.options.labelField!=undefined) labelField = sublayer.layer.options.labelField;\r\n\tif (sublayer.layer.options.tipusClasicTematic!=undefined) tipusClasicTematic = sublayer.layer.options.tipusClasicTematic;\r\n\t\r\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\r\n//\tvar visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\r\n\tvar capaMare = controlCapes._layers[layerMare.layer._leaflet_id].layer;\r\n//\tconsole.debug(paleta);\r\n\tpaleta = paleta ? paleta : 'Paired';\r\n\tvar sToCount = $(\"#count-\"+businessIdCapaMare).html();\r\n\tsToCount = sToCount.replace(\"(\", \" \");\r\n\tsToCount = sToCount.replace(\")\", \" \");\t\r\n\tvar toCount = parseInt(sToCount.trim());\r\n\tvar scale = createScale(paleta, toCount, reverse);\t\r\n\tvar ftype = transformTipusGeometry(layerMare.layer.options.geometryType);\t\r\n\tvar dataVis={\r\n\t\t\tbusinessId1: businessIdCapaMare,\r\n\t\t\tkey: dataField,\r\n\t\t\tuid: Cookies.get('uid')\r\n\t};\r\n\tvar rangsEstils=[];\r\n\tgetValuesFromKeysProperty(dataVis).then(function(results){\r\n\t\tvar valors = results.valors;\r\n\t\tvar resultatsFinals=[];\r\n\t\t\t\t\t\t\r\n\t\tif (tipusClasicTematic==undefined || tipusClasicTematic==\"unic\"){\r\n\t\t\tvar resultsNoRepetits=[];\r\n\t\t\tvar data = {};\t\t\r\n\t\t\tjQuery.grep(valors,  function( n, i ) {\r\n\t\t\t\t\t\tvar value = n;\r\n\t\t\t\t\t\tif(isBlank(value)) value = \"nodata\";\r\n\t\t\t\t\t\t\tif(!data[value]){\r\n\t\t\t\t\t\t\t\tdata[value] = value;\r\n\t\t\t\t\t\t\t\tresultsNoRepetits.push(n);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t//match ints and floats/decimals\r\n\t\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\t\t\tvar resultsFloat = [];\r\n\t\t\tvar i=0;\r\n\t\t\tjQuery.grep(resultsNoRepetits, function( n, i ) {\r\n\t\t\t\tif (floatRegex.test(n.v)) {\r\n\t\t\t\t\tresultsFloat[i]=n;\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t});\r\n\t\t\tif (resultsFloat.length>0) resultatsFinals=resultsFloat;\r\n\t\t\telse resultatsFinals=resultsNoRepetits;\r\n\t\t}\r\n\t\telse {\r\n\t\t\t//match ints and floats/decimals\r\n\t\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\r\n\t\t\tvar resultsFloat = [];\r\n\t\t\tvar i=0;\r\n\t\t\tjQuery.grep(valors, function( n, i ) {\r\n\t\t\t\tif (floatRegex.test(n.v)) {\r\n\t\t\t\t\tresultsFloat[i]=n;\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t});\r\n\t\t\tif (resultsFloat.length>0) resultatsFinals=resultsFloat;\r\n\t\t\telse resultatsFinals=valors;\r\n\t\t}\r\n\t\tvar valuesStyle = jQuery.map( resultatsFinals, function( a, i) {\r\n\t\t\trangsEstils[i]={v: a, style: createIntervalStyle(i,ftype,scale)};\t\t\t\t\t\t\t\r\n\t\t});\r\n\t\tloadRangValues(rangsEstils,tipusClasicTematic,layerMare.layer.options.geometryType,sublayer.layer.options.estilsRangs,sublayer.layer.options.estil).then(function(rangs){\r\n\t\t\tvar data1 = {\r\n\t\t\t\t\tuid: Cookies.get('uid'),\r\n\t\t\t\t\tbusinessId1: capaMare.options.businessId\r\n\t\t\t\t};\r\n\t\t\t\tcrearFitxerPolling(data1).then(function(results) {\r\n\t\t\t\t\tvar tmpFile=\"\";\r\n\t\t\t\t\tif (results.status==\"OK\"){\r\n\t\t\t\t\t\ttmpFile = results.tmpFilePath;\r\n\t\t\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\r\n\t\t\t\t\t\tvar pollTime =3000;\r\n\t\t\t\t\t\t//Fem polling\r\n\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tpollBuffer = function(){\r\n\t\t\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\r\n\t\t\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\t\t\ttype: 'get',\r\n\t\t\t\t\t\t\t\t\tsuccess: function(data){\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\r\n\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\r\n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\")!=-1 || data.status.indexOf(\"PAS 3\")!=-1) && busy){\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\r\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\r\n\t\t\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\r\n\t\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+businessIdCapaMare).attr(\"checked\")!=undefined) $( \"#input-\"+businessIdCapaMare).click();\r\n\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(data);\r\n\t\t\t\t\t\t\t\t\t\t\tbusy = false;\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse if (!busy){\r\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\r\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tpollInterval = setInterval(function(){\r\n\t\t\t\t\t\t\t\tpollBuffer();\r\n\t\t\t\t\t\t\t},pollTime);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t})();\r\n\t\t\t\t\t\t\tvar estils = {\r\n\t\t\t\t\t\t\t\testils: rangs,\r\n\t\t\t\t\t\t\t\tdataField: dataField,\r\n\t\t\t\t\t\t\t\tlabelField: dataField\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tvar options = {\r\n\t\t\t\t\t\t\t\turl: capaMare.options.url,\r\n\t\t\t\t\t\t\t\ttem: tem_clasic,\r\n\t\t\t\t\t\t\t\tstyle: estils,\r\n\t\t\t\t\t\t\t\torigen: capaMare.options.businessId,\r\n\t\t\t\t\t\t\t\ttipus : t_url_file,\r\n\t\t\t\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\r\n\t\t\t\t\t\t\t\testil_do: estils,\r\n\t\t\t\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\r\n\t\t\t\t\t\t\t\tgeometryType: capaMare.options.geometryType,\r\n\t\t\t\t\t\t\t\tcolX: capaMare.options.colX,\r\n\t\t\t\t\t\t\t\tcolY: capaMare.options.colY,\r\n\t\t\t\t\t\t\t\tdinamic: capaMare.options.dinamic\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\t\tbusinessId: businessIdCapaMare,//businessId id de la visualización de origen\r\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\r\n\t\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \r\n\t\t\t\t\t\t\t\tnom:  sublayer.layer.options.nom,\r\n\t\t\t\t\t\t\t\tactivas: true,\r\n\t\t\t\t\t\t\t\torder: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\r\n\t\t\t\t\t\t\t\tdataField: jQuery('#dataField').val(),//¿?¿?¿?¿?\r\n\t\t\t\t\t\t\t\ttem: tem_clasic,//visualitzacio.from,//tem_simple\r\n\t\t\t\t\t\t\t\testils: JSON.stringify(estils),\r\n\t\t\t\t\t\t\t\ttipusTematic:\"t_visualitzacio_categories\",\r\n\t\t\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioTematica,\r\n\t\t\t\t\t\t\t\ttmpFilePath: tmpFile,\r\n\t\t\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\r\n\t\t\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t//console.debug(\"callActions\");\r\n\t\t\t\t\t\t\tcallActions(data);\r\n\t\t\t\t\t\t\t/*createVisualitzacioTematica(data).then(function(results){\r\n\t\t\t\t\t\t\t\t\tvar defer = jQuery.Deferred();\r\n\t\t\t\t\t\t\t\t\treadVisualitzacio (defer,results.visualitzacio,results.layer).then(function(results2){\r\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\r\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t});*/\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\r\n\t\t\t\t\t\tbusy=false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t});\t\r\n\t\t\t\t\r\n\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t});\r\n}\r\n\r\nfunction loadRangValues(rangsEstils,tipusClasicTematic,geometrytype,estilsRangs,estilLayer){\r\n\tvar defer = jQuery.Deferred();\r\n\tvar rangs=[];\r\n\tvar rangsGuardats=[];\r\n\tif (tipusClasicTematic==\"rangs\"){\r\n\t\tjQuery.each(estilsRangs, function( index, value ) {\r\n\t\t\tvar values =[];\r\n\t\t\tvalues=index.split(\" - \");\r\n        \tvar indexEstil = 0;\r\n        \twhile(indexEstil<estilLayer.length && value!=estilLayer[indexEstil].businessId){\r\n        \t\t\tindexEstil++;\r\n\t\t\t}\r\n\t\t\tvar estil = estilLayer[indexEstil];\t\t\t\r\n\t\t\tvar tdRang, tdMin, tdMax;\r\n\t\t\tvar tdVal;\r\n\t\t\tvar rang = {};\r\n\t\t\trang.estil = transformStyle(estil,geometrytype);\r\n\t\t\trang.valueMax = values[1];\r\n\t\t\trang.valueMin = values[0];\r\n\t\t\trangs.push(rang);\r\n\t\t});\r\n\t}\r\n\tif (tipusClasicTematic==undefined || tipusClasicTematic==\"unic\"){\r\n\t\tjQuery.each(rangsEstils, function( index, value ) {\r\n\t\t\tvar tdRang, tdMin, tdMax;\r\n\t\t\tvar tdVal;\r\n\t\t\tvar rang = {};\r\n\t\t\trang.estil = transformStyle(value.style,geometrytype);\r\n\t\t\trang.valueMax = value.v;\r\n\t\t\trang.valueMin = value.v;\r\n\t\t\trangs.push(rang);\r\n\t\t\t\r\n\t\t});\t\r\n\t}\r\n\tconsole.debug(rangs);\r\n\tdefer.resolve(rangs);\r\n\treturn defer.promise();\r\n}\r\n\r\nfunction transformStyle(style,geometrytype){\r\n\tvar rangStyle;\r\n\tvar ftype = transformTipusGeometry(geometrytype);\r\n\tif (ftype == t_marker){\r\n\t\t//divElement = tdElem.find('div');\r\n\t\tvar color;\r\n\t\tif (style.fillColor!=undefined) color=style.fillColor;\r\n\t\telse if (style.color!=undefined) color=style.color;\r\n\t\trangStyle = {\r\n\t\t\tborderColor :  \"#ffffff\",\r\n\t\t\tborderWidth :  2,\r\n\t\t\tsimbolSize: style.simbolSize,\r\n\t\t\tcolor: color,\r\n\t\t\topacity: 90\r\n\t\t};\r\n\t}else if (ftype == t_polyline){\r\n\t\t//divElement = tdElem.find('canvas')[0].getContext(\"2d\");\r\n\t\tvar lineWidth;\r\n\t\tif (style.dashArray!=undefined) lineWidth=style.dashArray;\r\n\t\telse if (style.lineWidth) lineWidth=style.lineWidth;\r\n\t\trangStyle = {\r\n\t\t\tlineWidth :  style.dashArray,\r\n\t\t\tcolor: style.color,\r\n\t\t};\r\n\t}else if (ftype == t_polygon){\r\n\t\t\r\n\t\t//divElement = tdElem.find('canvas')[0].getContext(\"2d\");\r\n\t\trangStyle = {\r\n\t\t\tborderColor : '#FFFFFF',\r\n\t\t\tborderWidth :  '1',\r\n\t\t\tcolor: style.color,\r\n\t\t\tfillColor: style.color,\r\n\t\t\tfillOpacity: style.opacity,\r\n\t\t\topacity: '75'\t\t//75!\r\n\t\t};\r\n\t\t//console.debug(rangStyle);\r\n\t}\r\n\treturn rangStyle;\r\n}\r\n\t\r\n\r\n\r\n","//var per controlar si hi ha hagut edicio dels elements de la capa, i si cal fer refresh\r\nvar editat = false;\r\nvar geomBusinessId = '-1';\r\nvar geomRowIndex = 0;\r\nvar numRows = 0;\r\n\r\n\r\nfunction addFuncioEditDataTable(){\r\n\t\r\n\taddHtmlModalDataTable();\r\n\taddHtmlModalDeleteDataTableRow();\r\n\t\r\n\t$('#dialog_delete_row .btn-danger').on('click', function(event){\r\n\t\tvar button = $(event.relatedTarget); // Button that triggered the modal\r\n\t\tvar recipient = button.data('whatever');\r\n\t\t\r\n    \tvar geometryid = $('#dialog_delete_row .btn-danger').data(\"geometryid\");\r\n    \tvar geometriesBusinessId = $('#dialog_delete_row .btn-danger').data(\"geometriesBusinessId\");\r\n    \tvar businessId = $('#dialog_delete_row .btn-danger').data(\"businessId\");\t\t\r\n\t\t\r\n    \tremoveGeometryDB(geometryid,businessId,geometriesBusinessId);\r\n\t});\r\n\t\r\n\t$('#modal_data_table').on('hidden.bs.modal', function (e) {\r\n\t\t\r\n//\t\tconsole.debug(controlCapes);\r\n\t\t\r\n\t\t//si hem editat dades recarreguem la capa per visualitzar els canvis\r\n\t\tif(editat){\r\n//\t\t\tconsole.debug(\"Tanquem modal data table\");\r\n\t\t\t  \r\n\t    \t//Actualitzem visualitzacions de la capa on estava la geometria modificada\r\n\t\t\tvar capaEdicio = $('#modal_data_table').data(\"capaEdicio\");//controlCapes._layers[capaEdicioLeafletId];\r\n//\t\t\tconsole.debug(\"capaEdicio:\");\r\n//\t\t\tconsole.debug(capaEdicio);\r\n\t\t\tvar layerServidor = $('#modal_data_table').data(\"layerServidor\");\r\n\t\t\t\r\n\t\t\tlayerServidor.capesOrdre = capaEdicio.layer.options.zIndex.toString();\r\n\t\t\t\r\n//\t\t\tconsole.debug(\"layerServidor:\");\r\n//\t\t\tconsole.debug(layerServidor);\t\r\n\t\t\t\r\n\t\t\t//Eliminem la capa de controlCapes i mapa\r\n\t\t\tmap.closePopup();\r\n\t\t\tmap.removeLayer(capaEdicio.layer);\r\n\t\t\tcontrolCapes.removeLayer(capaEdicio);\t\t\t\r\n\t\t\t\r\n\t\t\t//Recarrego la capa origen\r\n\t\t\tloadVisualitzacioLayer(layerServidor).then(function(results){\r\n\t\t\t\t//recarrego les sublayers si les te\r\n\t\t\t\tjQuery.each(capaEdicio._layers, function(i, sublayer){\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(jQuery.type(capaEdicio.layer.options)== \"string\"){\r\n\t\t\t\t\t\tcapaEdicio.layer.options = $.parseJSON(capaEdicio.layer.options);\r\n\t\t\t\t\t}\t            \t  \r\n\t\t\t\t\t//Sublayer visualitzacio, carrego la capa\r\n\t\t\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\r\n\t\t\t\t  \t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\r\n\t\t\t\t  \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\r\n\t\t\t\t  \t\t  sublayer.layer.capesActiva = \"true\";\r\n\t\t\t\t  \t\t  sublayer.layer.options.origen = capaEdicio.layer.options.businessId;//layer.properties.capaBusinessId;//BusinessIdCapaorigen\r\n\t\t\t\t  \t\t  //tipusRang\r\n\t\t\t\t  \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\r\n\t\t\t\t  \t\t  sublayer.layer.options = JSON.stringify(sublayer.layer.options);\r\n\t\t\t\t  \t\t  \r\n\t\t\t\t  \t\t  //eliminem sublayer del mapa, i recarreguem\r\n\t\t\t\t  \t\t  map.closePopup();\r\n\t\t\t\t  \t\t  map.removeLayer(sublayer.layer);\r\n\t\t\t\t  \t\t  \r\n\t\t\t\t  \t\t  loadVisualitzacioLayer(sublayer.layer);\r\n\t\t\t  \t  \t}\r\n\t\t\t\t});\t\r\n\t\t\t});\t\t\r\n\t\t}\r\n\t\teditat = false;\r\n\t\tgeomBusinessId = '-1';\r\n\t\tgeomRowIndex = 0;\r\n\t\tnumRows = 0;\r\n\t\t$('#modal_data_table').off('post-body.bs.table');\r\n\t\t$('#modal_data_table_body #layer-data-table').bootstrapTable('destroy');\r\n\t});\t\r\n\t\r\n}\r\n\r\nfunction fillModalDataTable(obj, geomBid){\r\n\t\r\n\tvar columNames = [];\r\n\tvar geometriesBusinessId = \"\";\r\n\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html')!=-1);\r\n\t\r\n\tif(isValidValue(geomBid)){\r\n\t\tgeomBusinessId = geomBid;\r\n\t\t\r\n\t\t$('#modal_data_table').on('post-body.bs.table\t', function(event, name, row, \toldValue, param) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t\t\r\n//\t\t\tvar scroll = ($('div.fixed-table-body #layer-data-table tbody')[0].scrollHeight * (geomRowIndex+1)) / numRows;\r\n//\t\t\tconsole.debug(\"scroll:\");\r\n//\t\t\tconsole.debug(scroll);\r\n\t\t\t\r\n\t\t\t var parentDiv =  $('div.fixed-table-body');\r\n\t\t\t var innerListItem = $('div.fixed-table-body #layer-data-table tbody tr.success');\r\n\t\t\t if(!editat) parentDiv.scrollTo(innerListItem);\r\n\t\t\t \r\n\t\t});\r\n\t}\r\n\t\r\n\t$('#modal_data_table').data(\"capaEdicio\", obj);\r\n\t\r\n\t//obj.layer.serverName\t\r\n\t//$('#modal_data_table_title').html(obj.name.toUpperCase());\r\n\t$('#modal_data_table_title').text(obj.name.toUpperCase());\t\r\n\t\r\n\tvar options = obj.layer.options;\r\n\tif (obj.layer.options!=undefined && obj.layer.options.estil!=undefined){\r\n\t\t//Primer trobem column names\r\n\t\tjQuery.each(obj.layer.options.estil, function(indexEstil, estil){\r\n\t\t\t\r\n\t\t\tjQuery.each(estil.geometria.features, function(indexFeature, feature){\r\n\t\t\t\t//console.debug(feature);\r\n\t\t\t\t//Geometry Id\r\n\t\t\t\tvar objGeomId = {\r\n\t\t\t\t\t\tfield: 'geometryid',\r\n\t\t\t\t\t\ttitle: 'ID',\r\n\t\t\t\t\t\tvisible: false\r\n\t\t\t\t}\r\n\t\t\t\tcolumNames.push(objGeomId);\t\r\n\t\r\n\t\t\t\t//Geometry Bid \r\n\t\t\t\tvar objGeomBid = {\r\n\t\t\t\t\t\tfield: 'geometrybid',\r\n\t\t\t\t\t\ttitle: 'BID',\r\n\t\t\t\t\t\tvisible: false\r\n\t\t\t\t}\r\n\t\t\t\tcolumNames.push(objGeomBid);\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//geometryBBOX\r\n\t\t\t\tvar objGeomBBOX = {\r\n\t\t\t\t\t\tfield: 'geometryBBOX',\r\n\t\t\t\t\t\ttitle: 'BBOX',\r\n\t\t\t\t\t\tvisible: false \r\n\t\t\t\t}\r\n\t\t\t\tcolumNames.push(objGeomBBOX);\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//console.debug(options);\r\n\t\t\t\tif(modeMapa){\r\n\t\t\t\t\tvar isADrawMarker=false;\r\n\t\t\t\t\t//properties headers\r\n\t\t\t\t\t//console.debug(feature);\r\n\t\t\t\t\tvar propName;\r\n\t\t\t\t\tif(typeof (options.propName)==\"string\"){\t\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tpropName = JSON.parse(options.propName);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcatch (err) {\r\n\t\t\t\t\t\t\tpropName = options.propName;\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\t\t\t\r\n\t\t\t\t\t\tpropName = options.propName;\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (propName!=undefined && propName.toString().indexOf(\"nom,text\")==-1) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tfor(var x in propName){\t\r\n\t\t\t\t\t\t\tif (propName[x].toLowerCase()!=\"geomorigen\") {\r\n\t\t\t\t\t\t\t\t//console.debug(propName[x]);\r\n\t\t\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\t\ttitle: propName[x].toUpperCase(),\r\n\t\t\t\t\t\t\t\t\tfield: propName[x].toLowerCase(),\r\n\t\t\t\t\t\t\t\t\tsortable: true,\r\n\t\t\t\t\t\t\t\t\teditable: {\r\n\t\t\t\t\t\t\t\t\t\temptytext : '-'\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (options.propName[x]=='text' || options.propName[x]=='TEXT') isADrawMarker=true;\r\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\r\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfor(var x in feature.properties){\r\n\t\t\t\t\t\t\tif (x.toLowerCase()!=\"geomorigen\"){\r\n\t\t\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\t\ttitle: x.toUpperCase(),\r\n\t\t\t\t\t\t\t\t\tfield: x.toLowerCase(),\r\n\t\t\t\t\t\t\t\t\tsortable: true,\r\n\t\t\t\t\t\t\t\t\teditable: {\r\n\t\t\t\t\t\t\t\t\t\temptytext : '-'\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (x=='text' || x=='TEXT') isADrawMarker=true;\r\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\r\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (isADrawMarker && feature.geometry.type==\"Point\"){ //Nomes pintem longitud/latitud quan és un punt\r\n\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\r\n\t\t\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\r\n\t\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t obj = {\r\n\t\t\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\r\n\t\t\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\r\n\t\t\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t columNames.push(obj);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Actions\r\n\t\t\t\t\tvar objActions = {\r\n\t\t\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\r\n\t\t\t\t\t\t\tfield: 'Accions',\r\n\t\t\t\t\t\t\tformatter: 'actionFormatter',\r\n\t\t\t\t\t\t\tevents: 'actionEvents'\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tcolumNames.push(objActions);\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\t//Taula no editable pel visor\r\n\t\t\t\t\t//properties headers\r\n\t\t\t\t\tvar isADrawMarker=false;\r\n\t\t\t\t\tif (options.propName!=undefined && options.propName.toString().indexOf(\"nom,text\")==-1) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tfor(var x in options.propName){\r\n\t\t\t\t\t\t\t\tif (options.propName[x].toLowerCase()!=\"geomorigen\") {\r\n\t\t\t\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\t\t\ttitle: options.propName[x].toUpperCase(),\r\n\t\t\t\t\t\t\t\t\t\tfield: options.propName[x].toLowerCase(),\r\n\t\t\t\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif (options.propName[x]=='text' || options.propName[x]=='TEXT') isADrawMarker=true;\r\n\t\t\t\t\t\t\t\t\telse isADrawMarker=false;\r\n\t\t\t\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfor(var x in feature.properties){\r\n\t\t\t\t\t\t\tif (x.toLowerCase()!=\"geomorigen\"){\r\n\t\t\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\t\ttitle: x.toUpperCase(),\r\n\t\t\t\t\t\t\t\t\tfield: x.toLowerCase(),\r\n\t\t\t\t\t\t\t\t\tsortable: true\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (x=='text' || x=='TEXT') isADrawMarker=true;\r\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\r\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tif (isADrawMarker){\r\n\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\r\n\t\t\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\r\n\t\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcolumNames.push(obj);\r\n\t\t\t\t\t\t obj = {\r\n\t\t\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\r\n\t\t\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\r\n\t\t\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t columNames.push(obj);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Actions\r\n\t\t\t\t\tvar objActions = {\r\n\t\t\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\r\n\t\t\t\t\t\t\tfield: 'Accions',\r\n\t\t\t\t\t\t\tformatter: 'actionFormatterVisor',\r\n\t\t\t\t\t\t\tevents: 'actionEvents'\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tcolumNames.push(objActions);\r\n\t\t\t\t}\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//return false;\r\n\t\t});\t\r\n\t}\r\n\telse {//Primer cop que dibuixem una geometria\r\n\t\t//Geometry Id\r\n\t\tvar objGeomId = {\r\n\t\t\t\tfield: 'geometryid',\r\n\t\t\t\ttitle: 'ID',\r\n\t\t\t\tvisible: false\r\n\t\t}\r\n\t\tcolumNames.push(objGeomId);\t\r\n\r\n\t\t//Geometry Bid \r\n\t\tvar objGeomBid = {\r\n\t\t\t\tfield: 'geometrybid',\r\n\t\t\t\ttitle: 'BID',\r\n\t\t\t\tvisible: false\r\n\t\t}\r\n\t\tcolumNames.push(objGeomBid);\t\t\t\r\n\t\t\r\n\t\t//geometryBBOX\r\n\t\tvar objGeomBBOX = {\r\n\t\t\t\tfield: 'geometryBBOX',\r\n\t\t\t\ttitle: 'BBOX',\r\n\t\t\t\tvisible: false \r\n\t\t}\r\n\t\tcolumNames.push(objGeomBBOX);\t\t\r\n\t\t//console.debug(options);\r\n\t\tif(modeMapa){\r\n\t\t\tvar isADrawMarker=true;\r\n\t\t\t//properties headers\r\n\t\t\t//console.debug(feature);\r\n\t\t\r\n\t\t\tvar obj2 = {\r\n\t\t\t\t\ttitle: \"nom\".toUpperCase(),\r\n\t\t\t\t\tfield: \"nom\".toLowerCase(),\r\n\t\t\t\t\tsortable: true,\r\n\t\t\t\t\teditable: {\r\n\t\t\t\t\t\temptytext : '-'\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\tcolumNames.push(obj2);\r\n\t\t\tobj2 = {\r\n\t\t\t\t\ttitle: \"text\".toUpperCase(),\r\n\t\t\t\t\tfield: \"text\".toLowerCase(),\r\n\t\t\t\t\tsortable: true,\r\n\t\t\t\t\teditable: {\r\n\t\t\t\t\t\temptytext : '-'\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\tcolumNames.push(obj2);\r\n\t\t\t\r\n\t\t\tif (isADrawMarker && options.geometryType==\"marker\"){ //Nomes pintem longitud/latitud quan és un punt\r\n\t\t\t\tvar obj2 = {\r\n\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\r\n\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\r\n\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t}\r\n\t\t\t\tcolumNames.push(obj2);\r\n\t\t\t\t obj2 = {\r\n\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\r\n\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\r\n\t\t\t\t\t\t\tsortable: true\r\n\t\t\t\t\t\t}\r\n\t\t\t\t columNames.push(obj2);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//Actions\r\n\t\t\tvar objActions = {\r\n\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\r\n\t\t\t\t\tfield: 'Accions',\r\n\t\t\t\t\tformatter: 'actionFormatter',\r\n\t\t\t\t\tevents: 'actionEvents'\r\n\t\t\t}\t\r\n\t\t\tcolumNames.push(objActions);\r\n\t\t\t\r\n\t\t}\r\n\t\t\r\n\t}\r\n\t\r\n\twindow.actionEvents = {\r\n\t\t    'click .remove': function (e, value, row, index) {\r\n\t\t    \t//Afegim parametres al button del dialog, per despres poder fer crida al remove\r\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"geometryid\", row.geometryid);\r\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"geometriesBusinessId\", geometriesBusinessId);\r\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"businessId\", obj.layer.options.businessId);\r\n\t\t    \t\r\n\t\t    \t$('#dialog_delete_row').modal('show');\r\n\t\t    },\r\n\t        'click .zoomTo': function (e, value, row, index) {\r\n\t        \t$('#modal_data_table').modal('hide');\r\n\t        \tvar coords = row.geometryBBOX.split(\"#\"); \r\n\t\t\t\tvar bbox = L.latLngBounds(L.latLng(coords[1], coords[0]), L.latLng(coords[3], coords[2]));\r\n\t\t\t\tmap.fitBounds(bbox);\r\n\t        }\r\n\t\t};\t\r\n\r\n\t//Portem properties del servidor\r\n\tvar data ={\r\n\t\t\tbusinessId: obj.layer.options.businessId,\r\n\t\t\tuid:Cookies.get('uid')\r\n\t\t};\r\n\t\r\n\t\r\n\tgetGeometriesPropertiesLayer(data).then(function(results){\r\n\t\t\t\r\n\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\r\n\t\t\t\tgeometriesBusinessId = results.geometriesBusinessId;\r\n\t\t\t\t$('#modal_data_table').data(\"layerServidor\", results.layer);\r\n\t\t\t\tvar resultats = results.results;\r\n\t\t\t\tvar coords = resultats.split(\"#\");  \r\n\t\t\t\tvar lon = parseFloat(coords[2]);\r\n\t\t\t\tvar lat = parseFloat(coords[1]);\r\n\t\t\t\t//resultats = resultats.replace(\"}]\",\",\\\"longitud\\\":\\\"\"+lon.toFixed(5)+\"\\\",\\\"latitud\\\":\\\"\"+lat.toFixed(5)+\"\\\"}]\");\r\n\t\t\t\tvar resultats2 = $.parseJSON(resultats);\r\n\t\t\t\tvar resultatsMod = [];\r\n\t\t\t\tvar resultI=0;\r\n\t\t\t\tvar haveGeomOrigen=false;\r\n\t\t\t\tjQuery.each(resultats2, function(i, result){\r\n\t\t\t\t\tvar coords = result.geometryBBOX.split(\"#\");  \r\n\t\t\t\t\tvar lon = parseFloat(coords[2]);\r\n\t\t\t\t\tvar lat = parseFloat(coords[1]);\r\n\t\t\t\t\tif (result.longitud==undefined)  result.longitud=lon.toFixed(5);\r\n\t\t\t\t\tif (result.latitud==undefined)  result.latitud=lat.toFixed(5);\t\t\t\t\t\r\n\t\t\t\t\t$.each( result, function( key, value ) {\r\n\t\t\t\t\t\tif (key.toLowerCase()!=\"geomorigen\"){\r\n\t\t\t\t\t\t\tvar valorStr=value.toString();\r\n\t\t\t\t\t\t\tif (valorStr.indexOf(\"src\")>-1){\r\n\t\t\t\t\t\t\t\tvalue=valorStr.replaceAll('\"',\"'\");//Issue #560\r\n\t\t\t\t\t\t\t\t//console.debug(value);\r\n\t\t\t\t\t\t\t\tresult[key]=value;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse result[key]=value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tresult[key] = null;\r\n\t\t\t\t\t\t\tdelete result[key];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tresultatsMod[resultI]=result;\r\n\t\t\t\t\t\r\n\t\t\t\t\tresultI++;\r\n\t\t\t\t\t//console.debug(result);\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t\tvar showRefresh=false;\r\n\t\t\t\tif (mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC) showRefresh=true;\r\n\t\t\t\t$('#modal_data_table_body #layer-data-table').bootstrapTable({\r\n\t\t\t\t\tsearch: true,\r\n\t\t\t\t\tstriped: true,\r\n\t\t\t\t\theight: '600',\r\n\t\t\t\t\tidField: 'geometryid',\r\n//\t\t\t\t\tclickToSelect: true,\r\n//\t\t\t\t\tcheckboxHeader: true,\r\n//\t\t\t\t\tshowColumns: true,\r\n//\t\t\t\t\t showHeader: true,\r\n\t\t\t\t\trowStyle: 'rowStyle',\r\n\t\t\t\t    columns: columNames,\r\n\t\t\t\t    showExport: true,\t\t\t\r\n\t\t\t\t    showRefresh: showRefresh,\r\n\t\t\t\t    exportTypes: ['json', 'csv', 'txt', 'excel'],\r\n\t\t\t\t    ignoreColumn: [columNames.length-4],\r\n\t\t\t\t    data: resultatsMod,\r\n\t\t\t\t    icons: {\r\n\t\t\t\t       refresh: 'glyphicon-refresh'\r\n\t\t\t\t    }\r\n\t\t\t\t});\t\r\n\t\t\t\t\r\n\r\n\t\t\t\t$('#modal_data_table').on('editable-save.bs.table', function(event, name, row, \toldValue, param) {\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tevent.stopImmediatePropagation();\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(isValidValue(name)){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar dataUpdate ={\r\n\t\t\t\t\t\t\t\tuid:Cookies.get('uid'),\r\n\t\t\t\t\t\t\t\tgeometryid: row[\"geometryid\"],\r\n\t\t\t\t\t\t\t\tkey:  name,\r\n\t\t\t\t\t\t\t\tnewValue: row[name]\r\n\t\t\t\t\t\t\t};\r\n//\t\t\t\t\t\tconsole.debug(dataUpdate);\r\n\t\t\t\t\t\tupdateGeometriaProperties(dataUpdate).then(function(results){\r\n\t\t\t\t\t\t\tif (results.status == \"OK\"){\r\n//\t\t\t\t\t\t\t\tconsole.debug(results);\r\n\t\t\t\t\t\t\t\teditat = true;\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tconsole.debug('error updateGeometriaProperties');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\t\tconsole.debug('error updateGeometriaProperties');\r\n\t\t\t\t\t\t});\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t});\t\r\n\t\t\t\t\r\n\t\t\t\t$('[name=\"refresh\"]').on('click',function(){\r\n\t\t\t\t\tvar capaEdicio = $('#modal_data_table').data(\"capaEdicio\");\r\n\t\t\t\t\t$('#modal_data_table').modal('hide');\r\n\t\t\t\t\tcarregarModalFitxer(true,obj.layer.options.businessId,obj.name,this.dataset.servertype,capaEdicio);\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Tornem a carregar les dades de la visualització\r\n\t\t\t\t\t/*updateGeometries(data).then(function(results){\r\n\t\t\t\t\t\tif (results.status == \"OK\"){\r\n\t\t\t\t\t\t\teditat = true;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.debug('error updateGeometries');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},function(results){\r\n\t\t\t\t\t\t\tconsole.debug('error updateGeometries');\r\n\t\t\t\t\t\t});\t\t\t\t\t\t\t\r\n\t\t\t\t\t}*/\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t}else{\r\n\t\t\t\tconsole.debug('error getGeometriesPropertiesLayer');\r\n\t\t\t}\r\n\t\t},function(results){\r\n\t\t\tconsole.debug('error getGeometriesPropertiesLayer');\r\n\t\t});\r\n\t\r\n}\r\n\r\nfunction rowStyle(row, index) {\r\n\t\r\n\tnumRows = numRows + 1;\r\n\tif (row.geometrybid == geomBusinessId) {\r\n//    \tconsole.debug(\"rowStyle:\");\r\n   \r\n//    \tconsole.debug(index);\r\n    \tgeomRowIndex = index;\r\n        return {\r\n            classes: 'success'//classes[index / 2]\r\n        };\r\n    }\r\n    return {};\r\n\t\r\n//    var classes = ['active', 'success', 'info', 'warning', 'danger'];\r\n//    \r\n//    if (index % 2 === 0 && index / 2 < classes.length) {\r\n//    \tconsole.debug(\"rowStyle:\");\r\n//    \tconsole.debug(row);\r\n//        return {\r\n//            classes: classes[index / 2]\r\n//        };\r\n//    }\r\n//    return {};\r\n}\r\n\r\nfunction actionFormatter(value, row, index) {\r\n    return [\r\n        '<a class=\"zoomTo\" href=\"javascript:void(0)\" title=\"ZoomTo\">',\r\n        '<i class=\"glyphicon glyphicon-zoom-in data-table-icon-zoom\"></i>',            \r\n        '<a class=\"remove ml10\" href=\"javascript:void(0)\" title=\"Remove\">',\r\n        '<i class=\"glyphicon glyphicon-trash data-table-icon-remove\"></i>',\r\n        '</a>'\r\n    ].join('');\r\n}\r\n\r\nfunction actionFormatterVisor(value, row, index) {\r\n    return [\r\n        '<a class=\"zoomTo\" href=\"javascript:void(0)\" title=\"ZoomTo\">',\r\n        '<i class=\"glyphicon glyphicon-zoom-in data-table-icon-zoom\"></i>',            \r\n        '</a>'\r\n    ].join('');\r\n}\r\n\r\nfunction removeGeometryDB(geometryid, businessId, geometriesBusinessId){\r\n\t\r\n\tvar data ={\r\n\t\t\tbusinessId: businessId,\r\n\t\t\tuid:Cookies.get('uid'),\r\n\t\t\tgeometryid: geometryid,\r\n\t\t\tgeometriesBusinessId: geometriesBusinessId\r\n\t\t};\r\n\t\r\n\tremoveGeometriaFromProperties(data).then(function(results){\r\n\t\t\r\n\t\tif(results.status == \"OK\"){\r\n\t\t\teditat = true;\r\n\t\t    $('#modal_data_table_body #layer-data-table').bootstrapTable('remove', {\r\n\t            field: 'geometryid',\r\n\t            values: [geometryid]\r\n\t        }); \r\n\t\t}else{\r\n\t\t\tconsole.debug(\"ERROR removeGeometriaFromProperties\");\r\n\t\t}\r\n\t\t\r\n\t},function(results){\r\n\t\tconsole.debug(\"ERROR removeGeometriaFromProperties\");\r\n\t});\r\n\t\r\n}\r\n\r\nfunction addHtmlModalDataTable(){\r\n\t\r\n\tjQuery('#mapa_modals').append(\r\n\t'<!-- Modal Data Table -->'+\r\n\t'\t\t<div id=\"modal_data_table\" class=\"modal fade\">'+\r\n\t'\t\t<div class=\"modal-dialog modal-lg\">'+\r\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\r\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\r\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>'+\r\n\t'\t\t\t\t\t<h4 lang=\"ca\" id=\"modal_data_table_title\"  class=\"modal-title\"></h4>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div id=\"modal_data_table_body\" class=\"modal-body\">'+\r\n//\t'\t\t\t\t\t<div id=\"div-table\">'+\r\n//\t'\t\t\t\t\t\t<div class=\"cell-left\">'+\r\n\t'\t\t\t\t\t\t\t<div id=\"layer-data-table\"></div>'+\r\n//\t'\t\t\t\t\t\t</div>'+\r\n//\t'\t\t\t\t\t\t<div class=\"cell-right\"></div>'+\r\n//\t'\t\t\t\t\t\t<div class=\"clearfix\"></div>'+\r\n//\t'\t\t\t\t\t</div>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t<!-- /.modal-content -->'+\r\n\t'\t\t</div>'+\r\n\t'\t\t<!-- /.modal-dialog -->'+\r\n\t'\t</div>'+\r\n\t'<!-- fi Data Table -->'\t\t\r\n\t);\r\n}\r\n\r\nfunction addHtmlModalDeleteDataTableRow(){\r\n\t\r\n\tjQuery('#mapa_modals').append(\r\n\t'<!-- Modal delete data table row -->'+\r\n\t'\t\t<div id=\"dialog_delete_row\" class=\"modal fade\">'+\r\n\t'\t\t<div class=\"modal-dialog\">'+\r\n\t'\t\t\t<div class=\"modal-content\">'+\r\n\t'\t\t\t\t<div class=\"modal-body\">'+\r\n\t'\t\t\t\t\t<h4><span lang=\"ca\">Vols esborrar la fila?</span></h4>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn btn-default\"'+\r\n\t'\t\t\t\t\t\tdata-dismiss=\"modal\">Cancel·lar</button>'+\r\n\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn btn-danger\"'+\r\n\t'\t\t\t\t\t\tdata-dismiss=\"modal\">Esborrar</button>'+\r\n\t'\t\t\t\t</div>'+\r\n\t'\t\t\t</div>'+\r\n\t'\t\t\t<!-- /.modal-content -->'+\r\n\t'\t\t</div>'+\r\n\t'\t\t<!-- /.modal-dialog -->'+\r\n\t'\t</div>'+\r\n\t'\t<!-- /.modal -->'+\r\n\t'\t<!-- Fi Modal delete -->\t'\t\t\r\n\t);\r\n}\r\n\r\n","/**\n * InstamapsLayers \n * \n * require todos los archivos con los diferentes tipos de capas\n * require geocat.mapa.wms\n * require geocat.mapa.json\n * require geocat.mapa.tematic\n * require geocat.mapa.url-file\n * require geocat.mapa.geojsonvt\n * require geocat.mapa.dades-obertes\n * require geocat.mapa.xarxes-socials\n * require geocat.mapa.heat\n * require geocat.mapa.cluster\n * require geocat.mapa.visualitzacioWMS\n */\n;(function(global, $){\n\tvar InstamapsLayers = function(options){\n\t\treturn new InstamapsLayers.init(options);\n\t};\n\t\n\tInstamapsLayers.prototype = {\n\t\tloadLayer: function(value){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\tdefer = $.Deferred();\n\n\t\t\tif (value.epsg == \"4326\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG4326;\n\t\t\t}else if (value.epsg == \"25831\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG25831;\n\t\t\t}else if (value.epsg == \"23031\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG23031;\n\t\t\t}else{\n\t\t\t\tvalue.epsg = _map.options.crs;\n\t\t\t}\n\n\t\t\t//Si la capa es de tipus wms\n\t\t\tif(value.serverType == t_wms){\n\t\t\t\tloadWmsLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_json){\n\t\t\t\tloadCapaFromJSON(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus url file\n\t\t\t}else if(value.serverType == t_url_file){\n\t\t\t\tloadURLfileLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t},function(result){\n\t\t\t\t\tdefer.reject(result);\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_geojsonvt){\n\t\t\t\t//console.debug(loadGeojsonvtLayer);\n\t\t\t\tloadGeojsonvtLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_dades_obertes){\n\t\t\t\tloadDadesObertesLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t},function(result){\n\t\t\t\t\tdefer.reject(result);\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus xarxes socials\n\t\t\t}else if(value.serverType == t_xarxes_socials){\n\t\t\t\tvar options = $.parseJSON( value.options );\n\t\t\t\tif(options.xarxa_social == 'twitter') loadTwitterLayer(value, options.hashtag);\n\t\t\t\telse if(options.xarxa_social == 'panoramio') loadPanoramioLayer(value);\n\t\t\t\telse if(options.xarxa_social == 'wikipedia') loadWikipediaLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}else if(value.serverType == t_tematic){\n\t\t\t\tloadTematicLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t});\n\t\t\t}else if(value.serverType == t_visualitzacio){\n\t\t\t\tif (self.edit) {\n\t\t\t\t\tloadVisualitzacioLayer(value).then(function(){\n\t\t\t\t\t\tdefer.resolve();\n\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tloadCacheVisualitzacioLayer(value).then(function(){\n\t\t\t\t\t\tdefer.resolve();\n\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t//Si la capa es de tipus vis_wms\n\t\t\t}else if(value.serverType == t_vis_wms || value.serverType == t_vis_wms_noedit){\n\t\t\t\tloadVisualitzacioWmsLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}\n\t\t\telse if(value.serverType == tem_heatmap_wms || value.serverType == tem_cluster_wms){\n\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}else{\n\t\t\t\tconsole.error(\"Tipus capa no soportat\");\n\t\t\t\tdefer.reject({msg:\"Tipus capa no soportat\"});\n\t\t\t}\n\n\t\t\treturn defer.promise();\n\t\t}, \n\t\t\n\t\t_loadAllLayers: function(_mapConfig, _controlCapes){\n\t\t\tvar self = this,\n\t\t\tdfd = $.Deferred();\n\t\t\tself.waitDeferred = dfd;\n\t\t\t\n\t\t\tself._loadOrigenWMS(_mapConfig, _controlCapes).then(function(results){\n\t\t\t\tvar num_origen = 0;\n\t\t\t\tself.numLayers = results.origen.length + results.sublayers.length;\n\t\t\t\tif(self.numLayers === 0){\n\t\t\t\t\tself._waitLoadAll(0);\n\t\t\t\t}\n\n\t\t\t\tif (!self.edit)\n\t\t\t\t{\n\t\t\t\t\n\t\t\t\t\tself.map.oms = new OverlappingMarkerSpiderfier(self.map, {keepSpiderfied : false});\n\t\t\t\t\tvar popup = new L.Popup();\n\t\t\t\t\tself.map.oms.addListener('click', function(marker) {\n\n\t\t\t\t\t\tif(marker.getPopup)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tpopup.setContent(marker.getPopup().getContent());\n\t\t\t\t\t\t\tpopup.setLatLng(marker.getLatLng());\n\t\t\t\t\t\t\tself.map.openPopup(popup);\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\t$.each(results.origen, function(index, value){\n\n\t\t\t\t\tself.loadLayer(value).then(function(){\n\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\tif (num_origen == results.origen.length){\n\t\t\t\t\t\t\t$.each(results.sublayers, function(index, value){\n\t\t\t\t\t\t\t\tself.loadLayer(value).then(function(){\n\t\t\t\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\t\t\t},function(){\n\t\t\t\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t},function(){\n\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn dfd.promise();\n\t\t},\n\t\t\t\t\n\t\t_waitLoadAll: function(numLayers){\n\t\t\tvar self = this;\n\t\t\tif(self.numLayers === numLayers){\n\t\t\t\tself.waitDeferred.resolve();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_loadOrigenWMS: function(_mapConfig, _controlCapes){\n\t\t\tvar dfd = $.Deferred(),\n\t\t\tlayer_map = {origen:[],sublayers:[]};\n\t\t\t\n\t\t\t$.each(_mapConfig.servidorsWMS, function(index, value){\n\t\t\t\t//TODO parsear las options y el group y dejarlo en json.\n\t\t\t\t//TODO quitar el parse de cada tipo de capa.\n\t\t\t\tif(value.options && value.capesGroup){\n\t\t\t\t\tvar options;\n\t\t\t\t\tif(typeof (value.options)==\"string\"){\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\toptions = JSON.parse(value.options);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\toptions = value.options;\n\t\t\t\t\t\t}\n\t\t\t\t\t}else{\n\t\t\t\t\t\toptions = value.options;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar group = JSON.parse(value.capesGroup);\n\t\t\t\t\toptions.group = group;\n\t\t\t\t\tvalue.options = JSON.stringify(options);\n\t\t\t\t}\n\t\t\t\tif(value.capesOrdre == capesOrdre_sublayer){\n\t\t\t\t\tlayer_map.sublayers.push(value);\n\t\t\t\t\tlsublayers.push(value); //variable global se tendría que quitar\n\t\t\t\t}else{\n\t\t\t\t\tlayer_map.origen.push(value);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(layer_map.origen, function(index, value){\n\t\t\t\tvar jsonOptions;\n\t\t\t\tif(typeof (value.options)==\"string\"){\n\t\t\t\t\ttry {\n\t\t\t\t\t\tjsonOptions = JSON.parse(value.options);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\tjsonOptions = value.options;\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tjsonOptions = value.options;\n\t\t\t\t}\n\n\t\t\t\tif(jsonOptions && jsonOptions.group){\n\t\t\t\t\tif(_controlCapes){\n\t\t\t\t\t\t_controlCapes._addGroupFromObject(jsonOptions.group);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tdfd.resolve(layer_map);\n\t\t\treturn dfd.promise();\n\t\t},\n\n\t};\n\t\n\tInstamapsLayers.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, options);\n\t};\n\t\n\tInstamapsLayers.init.prototype = InstamapsLayers.prototype;\n\t\n\tglobal.InstamapsLayers = InstamapsLayers;\n\t\n}(window, jQuery));","/**\n * \n */\n;(function(global, $){\n\tvar InstamapsWms = function(options){\n\t\treturn new InstamapsWms.init(options);\n\t};\n\t\n\tvar _options = {\n\t\tproxyUrl: \"http://www.instamaps.cat/share/jsp/ows2json.jsp?\"\t\n\t};\n\t\n\tInstamapsWms.prototype = {\n\t\tinitUi: function(){\n\t\t\tvar self = this;\n\t\t\tself._div = self.container;\n\t\t\tself._botons = self.botons;\n\t\t\tif (self.loadTemplateParam==undefined) self.loadTemplate();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tloadTemplate: function(){\n\t\t\tvar self = this;\n\t\t\t$.get(\"templates/wmsTemplate.html\",function(data){\n\t\t\t\tself._div.html(data);\n\t\t\t\tself._uiloaded = true;\n\t\t\t\t$(\".layers-wms\").hide();\n\t\t\t\t\n\t\t\t\t$(\".url-wms\").focus(function() {\n\t\t\t\t\tself.clear();\n\t\t\t\t\t//jQuery('#txt_URLWMS').val('');\n\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t$(\".btn-conn-wms\").on('click', function(e) {\n\t\t\t\t\t\n\t\t\t\t\tvar input = $(e.target).closest('.txt_ext').find('.url-wms');\t\t\t\t\t\n\t\t\t\t    var url = $.trim(input.val());\n\t\t\t\t\t\n\t\t\t\t\tif (url === \"\") {\n\t\t\t\t\t\talert(window.lang.translate(\"Has d'introduïr una URL del servidor\"));\n\t\t\t\t\t} else if (!isValidURL(url)) {\n\t\t\t\t\t\talert(window.lang.translate(\"La URL introduïda no sembla correcte\"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tself.getCapabilities({url:url});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\t\n\t\t\t});\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tclear: function(){\n\t\t\tvar self = this;\n\t\t\t$('.layers-wms').html('');\n\t\t\t$(\".layers-wms\").hide();\n\t\t\tself._botons.empty();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tshow: function(){\n\t\t\tvar self = this;\n\t\t\t$(\".layers-wms\").show();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tgetLayers: function(options){\n\t\t\tvar self = this;\n\t\t\t$(\".url-wms\").val(options.url);\n\t\t\tself.url = options.url;\n\t\t\tself.name = options.name;\t\t\t\n\t\t\toptions.capa ? self.capa=options.capa : self.capa=null;\t\t\t\n\t\t\tself.getCapabilities();\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tgetWMSLayers: function(data){\n\t\t\tvar self = this;\n\t\t\treturn jQuery.ajax({\n\t\t\t\turl: self.proxyUrl,\n\t\t\t\tdata: data,\n\t\t\t\tasync: true,\n\t\t\t\tmethod: 'post',\n\t\t\t\tdataType: 'jsonp',\n\t\t\t\ttimeout: 12000 //timeout WMS\n\t\t\t}).promise();\n\t\t},\n\t\t\n\t\tgetCapabilities: function(options){\n\t\t\tvar self = this,\n\t\t\t\tActiuWMS = {};\n\t\t\t\n\t\t\tself = $.extend(self, options);\n\t\t\tvar data = {url: self.url, capa:self.capa};\n\t\t\t\n\t\t\tself.getWMSLayers(data).then(function(results) {\n\t\t\t\tvar bbox, servidor, WMS_BBOX,\n\t\t\t\tsouce_capabilities_template = $(\"#capabilities-template\").html(),\n\t\t\t\tcapabilities_template = Handlebars.compile(souce_capabilities_template);\n\t\t\t\t\n\t\t\t\tHandlebars.registerPartial( \"list-template\", $( \"#list-template\" ).html() );\n\t\t\t\tHandlebars.registerHelper('layer', function(context, options) {\n\t\t\t\t  var ret = \"\";\n\t\t\t\t  if (!Handlebars.Utils.isArray(context)){\n\t\t\t\t\t  context = [context];\n\t\t\t\t  }\n\t\t\t\t  for(var i=0, j=context.length; i<j; i++) {\n\t\t\t\t\t  if (!Handlebars.Utils.isArray(context[i])){\n\t\t\t\t\t\t  ret = ret + options.fn(context[i]);\n\t\t\t\t\t  }else{\n\t\t\t\t\t\t  for(var k=0, l=context.length; k<l; k++) {\n\t\t\t\t\t\t\t  ret = ret + options.fn(context[i][k]);\n\t\t\t\t\t\t  }\n\t\t\t\t\t  }\n\t\t\t\t  }\n\t\t\t\t  return ret;\n\t\t\t\t});\n\t\t\t\tHandlebars.registerHelper(\"debug\", function(optionalValue) {\n\t\t\t\t  console.log(\"Current Context\");\n\t\t\t\t  console.log(\"====================\");\n\t\t\t\t  console.log(this);\n\t\t\t\t \n\t\t\t\t  if (optionalValue) {\n\t\t\t\t    console.log(\"Value\");\n\t\t\t\t    console.log(\"====================\");\n\t\t\t\t    console.log(optionalValue);\n\t\t\t\t  }\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tself.clear().show();\n\n\t\t\t\tif (servidor == null) {\n\t\t\t\t\tservidor = results.Service.Title;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\ttry{\n\t\t\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\n\t\t\t\t\t\tbbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\n\t\t\t\t\t\tbbox = results.Capability.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else{\n\t\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t\t}\t\n\t\t\t\t} catch (err) {\n\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\ttry {\n\t\t\t\t\tvar matriuEPSG = results.Capability.Layer.CRS,\n\t\t\t\t\tepsg = [],\n\t\t\t\t\thtml = \"\";\n\t\t\t\t\t\n\t\t\t\t\tif($.isArray(results.Capability.Layer)){\n\t\t\t\t\t\thtml = capabilities_template({Layer: results.Capability.Layer});\n\t\t\t\t\t}else{\n\t\t\t\t\t\thtml = capabilities_template({Layer: [results.Capability.Layer]});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tActiuWMS.servidor = self.name || servidor || results.Capability.Layer.Title;\n\t\t\t\t\tActiuWMS.url = self.url;\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer.SRS;\n\t\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].CRS;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].SRS;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($.isArray(matriuEPSG)){\n\t\t\t\t\t\t$.each(matriuEPSG, function(index, value) {\n\t\t\t\t\t\t\tepsg.push(value);\n\t\t\t\t\t\t});\n\t\t\t\t\t}else{\n\t\t\t\t\t\tepsg.push(matriuEPSG);\n\t\t\t\t\t}\n\t\t\t\n\t\t\t\t\tif ($.inArray('EPSG:3857', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t\t\t} else if ($.inArray('EPSG:900913', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t\t\t} else if ($.inArray('EPSG:4326', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t\t\t} else if ($.inArray('CRS:84', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t\t\t} else if ($.inArray('EPSG:4258', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\talert(window.lang.translate(\"No s'ha pogut visualitzar aquest servei: Instamaps només carrega serveis WMS globals en EPSG:3857 i EPSG:4326\"));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tself.ActiuWMS = ActiuWMS;\n\t\t\t\t\t\n\t\t\t\t\t$('.layers-wms').empty().append(html);\n\t\t\t\t\tself.addTreeEvents();\n\t\t\t\t\tself._botons.empty();\n\t\t\t\t\tself._botons.html(\n\t\t\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" class=\"btn btn-success btn-add-wms\" >' +\n\t\t\t\t\t\twindow.lang.translate(\"Afegir capes\") + '</button></div>');\n\t\t\t\t\t\n\t\t\t\t\t//if(self.capa){\n\t\t\t\t\tif(self.hasOwnProperty('capa')){\n\t\t\t\t\t\tvar ls;\n\t\t\t\t\t\tvar hits=0;\n\t\t\t\t\t\t//para las capas con nombres de números y que solo son dos capas\n\t\t\t\t\t\t//en el excel puede variar el formato y poner 5.5 en lugar de 5.1\n\t\t\t\t\t\tif(self.capa == null){\n\t\t\t\t\t\t\tself.capa=\"null\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tself.capa = self.capa.replace(/(\\d)\\.(\\d)/,\"$1,$2\");\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(self.capa.indexOf(\",\")!=-1){\t\t\t\t\t\t\t\t//hi ha més una capa\n\t\t\t\t\t\t\tls=self.capa.split(\",\");\n\t\t\t\t\t\t\tfor(i=0; i < ls.length;i++){\n\t\t\t\t\t\t\t\thits=hits + self._ckechLayerWMS(ls[i]);\n\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tls=self.capa;\n\t\t\t\t\t\t\thits=hits + self._ckechLayerWMS(ls);\n\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(hits > 0){\n\t\t\t\t\t\t\tself.addExternalWMS(false);\t\t\t\t\t\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tjQuery(\"#div_controlWMS_OFICIALS\").show();\n\t\t\t\t\t\t\tjQuery(\"#div_emptyWMS_OFICIALS\").show();\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\tjQuery(\"#div_controlWMS_OFICIALS\").show();\n\t\t\t\t\t\tjQuery(\"#div_emptyWMS_OFICIALS\").show();\n\t\t\t\t\t}\n\t\t\t\t\t//ckbox_layer\t\t\t\t\t\n\t\t\t\t\t$(\".btn-add-wms\").on('click', function(e) {\n\t\t\t\t\t    self.addExternalWMS(false);\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.debug(err);\n\t\t\t\t\t$('.layers-wms').html('<hr lang=\"ca\">'+window.lang.translate(\"Error en interpretar capabilities\")+': ' + err + '</hr>');\n\t\t\t\t}\n\t\t\t},function(data,status,error){\n\t\t\t\tstatus.indexOf('parser')!=-1?alert(window.lang.translate(\"Error en interpretar capabilities\")):alert(window.lang.translate(\"Error: No s'ha pogut executar l'operació\"));\n\t\t\t\t\n\t\t\t\t});\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_ckechLayerWMS: function(layerName){\n\t\t\tvar self = this;\n\t\t\tvar hit=0;\n\t\t\tjQuery(\".ckbox_layer\").each(function() {\t\t\n\t\t\t\tif(this.value==layerName){\t\t\t\t\n\t\t\t\tjQuery(this).prop('checked',true);\n\t\t\t\thit=hit +1;\t\t\t\t\n\t\t\t\t}\t\t\t\t\n\t\t\t});\t\t\t\n\t\t\treturn hit;\t\t\t\n\t\t},\t\n\t\t\n\t\t_getChekedLayers:function(){\n\t\t\tvar ch=0;\n\t\t\t$(\".ckbox_layer\").each(function() {\n\t\t\t\tif(jQuery(this).prop('checked')){\n\t\t\t\t\tch=ch + 1;\n\t\t\t\t}\n\t\t\t\treturn ch;\t\t\t\t\t\n\t\t\t});\t\n\t\t},\t\n\t\t\n\t\taddExternalWMS: function(){\n\t\t\tvar self = this,\n\t\t\t_dateFormat = false;\n\t\t\t\t\t\t\n\t\t\tvar cc = $('.layers-wms input:checked').map(function(){\n\t\t\t\tvar name = this.value.replace(/:/g,\"\\\\\\:\");\n\t\t\t\ttry{\n\t\t\t\t\tif($('#geoservicetime_'+name).length > 0){\n\t\t\t\t\t\t_dateFormat = true;\n\t\t\t\t\t}\n\t\t\t\t}catch(e){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\treturn this.value;\n\t\t\t});\n\t\t\t\n\t\t\tcc = jQuery.makeArray(cc);\n\t\t\tcc = cc.join(',');\n\t\t\t\t\t\t\n\t\t\tvar _nomCapesWMS=[];\n\t\t\tvar cc1 = $('.layers-wms input:checked').map(function(){\t\t\t\n\t\t\t\treturn this.id;\n\t\t\t});\n\t\t\t\n\t\t\tcc1 = jQuery.makeArray(cc1);\t\n\t\t\t\n\t\t\t//TODO esto lo debemos activar para la pestaña de WMS y no para las de \n\t\t\t//dades oficials\n\t\t\tif(cc1.length==1){\n\t\t\t\t//self.ActiuWMS.servidor=cc1.join(\" \");\n\t\t\t}\n\t\t\t\n\t\t\tself.ActiuWMS.wmstime = _dateFormat;\n\t\t\t\n\t\t\tif(cc.length === 0){\n\t\t\t\talert(window.lang.translate(\"Has de seleccionar almenys una capa\"));\n\t\t\t}else{\n\t\t\t\tself.ActiuWMS.layers = cc;\n\t\t\t\tif(self.callback){\n\t\t\t\t\tself.callback(self.ActiuWMS);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\taddTreeEvents: function(){\n\t\t\tvar self = this;\n\t\t\t\n\t\t\t$('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');\n\t\t    $('.tree li.parent_li > span').on('click', function (e) {\n\t\t        var children = $(this).parent('li.parent_li').find(' > ul > li');\n\t\t        if (children.is(\":visible\")) {\n\t\t            children.hide('fast');\n\t\t            $(this).attr('title', 'Expand this branch').find(' > i').addClass('glyphicon-folder-close').removeClass('glyphicon-folder-open');\n\t\t        } else {\n\t\t            children.show('fast');\n\t\t            $(this).attr('title', 'Collapse this branch').find(' > i').addClass('glyphicon-folder-open').removeClass('glyphicon-folder-close');\n\t\t        }\n\t\t        e.stopPropagation();\n\t\t    });\n\t\t    \n\t\t    $('.tree li > span.leaf').on('click', function (e) {\n\t\t    \t$(this).children('.ckbox_layer').click();\n\t\t    });\n\t\t    \n\t\t    $('.ckbox_layer').on('click', function (e) {\n\t\t    \te.stopPropagation();\n\t\t    });\n\t\t    \n\t\t    $('.btn-all').on('click',function(){\n\t\t    \t$(this).parent('li.parent_li').find('input:checkbox').prop('checked', true);\n\t\t\t});\n\t\t\t\n\t\t\t$('.btn-none').on('click',function(){\n\t\t\t\t$(this).parent('li.parent_li').find('input:checkbox').prop('checked', false);\n\t\t\t});\n\n\t\t\t$('.btn-invert').on('click',function(){\n\t\t\t\tvar ul = $(this).parent(\"li.parent_li\").find(\".sublayers_list\");\n\t\t\t\tul.children().each(function(i,li){ul.prepend(li)});\n\t\t\t});\n\t\t\t\n\t\t\treturn self;\n\t\t}\n\t\t\n\t};\n\t\n\tInstamapsWms.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, _options, options);\n\t\tself.initUi();\n\t};\n\t\n\tInstamapsWms.init.prototype = InstamapsWms.prototype;\n\t\n\tglobal.InstamapsWms = InstamapsWms;\n\t\n}(window, jQuery));\n","/**\r\n * TODO Cambiar a la carpeta de leaflet\r\n */\r\nL.IM_ControlFons = L.Control.extend({\r\n\toptions: {\r\n\t\tcollapsed: true,\r\n        position: 'bottomleft',\r\n        title: 'Escollir el mapa de fons',\r\n        langTitle: 'Escollir el mapa de fons',\r\n        tooltip: 'right'\r\n    },\r\n    \r\n    onAdd: function (map) {\r\n    \tthis._initLayout();\r\n    \t\r\n    \tthis._div = this._container;\r\n    \t\r\n    \treturn this._container;\r\n    },\r\n    \r\n    _initLayout: function(){\r\n    \tvar self = this,\r\n\t\toptions = self.options,\r\n\t\tclassName = 'control-btn-fons',\r\n\t    container = this._container = L.DomUtil.create('div', className);\r\n    \t\r\n    \t// makes this work on IE touch devices by stopping it from firing a mouseout event when the touch is released\r\n\t\tcontainer.setAttribute('aria-haspopup', true);\r\n\t\t\r\n\t\tcontainer.title = options.title;\r\n\t\tcontainer.dataset.toggle = 'tooltip';\r\n\t\tcontainer.dataset.placement = options.tooltip;\r\n\t\tcontainer.dataset.langTitle = options.langTitle;\r\n\r\n        var ua = window.navigator.userAgent;\r\n        var msie = ua.indexOf(\"MSIE \");\r\n        var version = 11;\r\n        if (msie > 0) version = parseInt(ua.substring(msie + 5, ua.indexOf(\".\", msie)));\r\n\t\t\r\n        if (!L.Browser.touch) {\r\n\t\t\tL.DomEvent\r\n\t\t\t\t.disableClickPropagation(container)\r\n\t\t\t\t.disableScrollPropagation(container);\r\n\t\t} else {\r\n\t\t\tL.DomEvent.on(container, 'click', L.DomEvent.stopPropagation);\r\n\t\t}\r\n    \t\r\n\t\r\n\t\tif (this.options.collapsed){\r\n\t\t\t//#499: Amb IE10 no es carreguen els visors\r\n\t\t\tif (msie==0){\r\n\t\t\t\tif (!L.Browser.android) {\r\n\t\t\t\t\t\tL.DomEvent.on(container, {\r\n\t\t\t\t\t\t\tmouseenter: this._expand,\r\n\t\t\t\t\t\t\tmouseleave: this._collapse\r\n\t\t\t\t\t\t}, this);\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n    \t\t\r\n    \t\t\r\n    \t\tL.DomEvent.on(container, 'click', this._expand, this);\r\n    \t\t\r\n    \t\tthis._map.on('click', this._collapse, this);\r\n    \t}else{\r\n    \t\tthis._expand();\r\n    \t}\r\n    \t    \t\r\n    \tvar btllista = L.DomUtil.create('div','leaflet-bar btn btn-default btn-sm');\r\n    \t\r\n    \tif (this._map.getActiveMap() == \"ortoMap\"){\r\n    \t\tL.DomUtil.addClass(btllista, 'bt_topo');\r\n    \t}else{\r\n    \t\tL.DomUtil.addClass(btllista, 'bt_orto');\r\n    \t}\r\n    \t\r\n\t\tcontainer.appendChild(btllista);\r\n\t\tthis._btllista = btllista;\r\n\t\tbtllista.innerHTML = '<small id=\"sm_tipus\" lang=\"ca\">Fons</small>';\r\n\t\t\t\t\r\n\t\tvar llistaFons = L.DomUtil.create('div','leaflet-bar btn btn-default llista-fons');\r\n\t\t\r\n\t\tthis._addLayers(llistaFons);\r\n\t\r\n\t\tcontainer.appendChild(llistaFons);\r\n\t\t\t\t\t\t\r\n\t\treturn container;\r\n    },\r\n    \r\n    hideBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).hide();\r\n\t},\r\n\t\r\n\tshowBtn: function(){\r\n\t\tvar self = this;\r\n\t\t$(self._div).show();\r\n\t},\r\n    \r\n    _update: function(){\r\n    \t\r\n    },\r\n    \r\n    _expand: function(){\r\n    \tL.DomUtil.addClass(this._container, 'control-btn-fons-expanded');\t\r\n    },\r\n    \r\n    _collapse: function(){\r\n    \tL.DomUtil.removeClass(this._container, 'control-btn-fons-expanded');\r\n    },\r\n    \r\n    _addLayers: function(container){\r\n\t\t\r\n\r\n\t\t\r\n    \t this._addItem(container,{id:'topoMap',className:'div_fons_1',title:'Topogràfic'});\r\n    \t this._addItem(container,{id:'topoMapGeo',className:'div_fons_12',title:'Simple'});\r\n    \t this._addItem(container,{id:'hibridMap',className:'div_fons_13',title:'Mapa híbrid'});\r\n    \t this._addItem(container,{id:'ortoMap',className:'div_fons_3',title:'Imatge'});    \t\r\n    \t this._addItem(container,{id:'terrainMap',className:'div_fons_4',title:'Terreny'});\r\n    \t this._addItem(container,{id:'alcadaMap',className:'div_fons_15',title:'Model d\\'elevacions'});\r\n    \t this._addItem(container,{id:'historicOrtoMap',className:'div_fons_11',title:'Ortofoto històrica Catalunya 1956-57'});\r\n    \t this._addItem(container,{id:'historicOrtoMap46',className:'div_fons_14',title:'Ortofoto històrica Catalunya 1946'});\r\n    \t this._addItem(container,{id:'historicMap',className:'div_fons_10',title:'Mapa històric Catalunya 1936'});     \t\r\n    \t this._addItem(container,{id:'topoGrisMap',className:'div_fons_2',title:'Topogràfic gris'});\r\n    \t this._addItem(container,{id:'nit',className:'div_fons_6',title:'Nit'});\r\n    \t this._addItem(container,{id:'sepia',className:'div_fons_7',title:'Sèpia'});\r\n    \t this._addItem(container,{id:'zombie',className:'div_fons_8',title:'Coure'});\r\n    \t this._addItem(container,{id:'orquidea',className:'div_fons_9',title:'BluePrint'});\r\n    \t this._addItem(container,{id:'naturalMap',className:'div_fons_16',title:'Natural'});\r\n    \t this._addItem(container,{id:'divadminMap',className:'div_fons_17',title:'Divisions administratives'});\t\t \r\n\t\t this._addItem(container,{id:'hibridTerrainMap',className:'div_fons_18',title:'Terreny híbrid'});\t\t\r\n\t\t this._addItem(container,{id:'colorBlankMapwhite',className:'div_fons_blank',title:'Fons neutre blanc'});\r\n\t\t this._addItem(container,{id:'colorBlankMaplightgray',className:'div_fons_gris',title:'Fons neutre gris'} );\r\n\t\t this._addItem(container,{id:'colorBlankMapgray',className:'div_fons_gris_fort',title:'Fons neutre gris fort'});\r\n\t\t \r\n\t\t \r\n    },\r\n    \r\n    _addItem: function(container, properties){\r\n\t\t\r\n\t\r\n    \tvar item = document.createElement('div');\r\n    \titem.id = properties.id;\r\n    \titem.className = properties.className;\r\n    \titem.setAttribute(\"data-toggle\",\"tooltip\");\r\n    \titem.setAttribute(\"data-lang-title\",properties.title);\r\n    \titem.title = properties.title;\r\n    \t\r\n    \tL.DomEvent.on(item, 'click', L.DomEvent.stopPropagation);\r\n    \tL.DomEvent.on(item, 'click', this._onItemClick, this);\r\n    \tcontainer.appendChild(item);\r\n    \t$(item).tooltip({placement : 'bottom',container : 'body'});\r\n    },\r\n    \r\n    _onItemClick: function(evt){\r\n    \tvar that = this;\r\n    \tvar _this = evt.target;\r\n    \tvar fons = $(_this).attr('id');\r\n\t\t\r\n\t\t\r\n\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#fons', fons, 1]});\r\n\t\tif (fons == 'topoMap'){\r\n\t\t\tthis._map.topoMap();\r\n\t\t}else if (fons == 'topoMapGeo') {\r\n\t\t\tthis._map.topoMapGeo();\r\n\t\t}else if (fons == 'ortoMap') {\r\n\t\t\tthis._map.ortoMap();\r\n\t\t}else if (fons == 'terrainMap') {\r\n\t\t\tthis._map.terrainMap();\r\n\t\t}else if (fons == 'topoGrisMap') {\r\n\t\t\tthis._map.topoGrisMap();\r\n\t\t}else if (fons == 'historicOrtoMap') {\r\n\t\t\tthis._map.historicOrtoMap();\r\n\t\t}else if (fons == 'historicMap') {\r\n\t\t\tthis._map.historicMap();\r\n\t\t}else if (fons == 'hibridMap'){\r\n\t\t\tthis._map.hibridMap();\r\n\t\t}else if (fons == 'historicOrtoMap46'){\r\n\t\t\tthis._map.historicOrtoMap46();\r\n\t\t}else if (fons == 'alcadaMap'){\r\n\t\t\tthis._map.alcadaMap();\r\n\t\t\t\r\n\t\t}else if (fons == 'naturalMap') {\r\n\t\t\tthis._map.naturalMap();\r\n\t\t\t\r\n\t\t}else if (fons == 'divadminMap') {\r\n\t\t\tthis._map.divadminMap();\r\n\t\t\r\n\r\n\t\t}else if (fons == 'hibridTerrainMap') {\r\n\t\t\tthis._map.hibridTerrainMap();\t\r\n\t\t\t\r\n\t\t}else if (fons.indexOf('colorBlankMap')!=-1) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\tthis._map.colorBlankMap(fons);\r\n\t\t\t\r\n\t\t}else{\r\n\t\t\tthis._map.colorMap(fons);\t\t\t\r\n\t\t}\r\n\t\tif (fons == 'ortoMap'){\r\n\t\t\tL.DomUtil.removeClass(this._btllista, 'bt_orto');\r\n\t\t\tL.DomUtil.addClass(this._btllista, 'bt_topo');\r\n\t\t}else{\r\n\t\t\tL.DomUtil.removeClass(this._btllista, 'bt_topo');\r\n\t\t\tL.DomUtil.addClass(this._btllista, 'bt_orto');\r\n\t\t}\r\n\t\tthis._collapse();\r\n    }\r\n});\r\n\r\nL.IM_controlFons = function (options) {\r\n    return new L.IM_ControlFons(options);\r\n};\r\n\r\n/*\r\n//Control mapa orto/topo\r\n\tvar ctr_llistaCapes = L.control({\r\n        position : 'bottomright'\r\n\t});\r\n\tctr_llistaCapes.onAdd = function (map) {\r\n\r\n\t\t\r\n\t};\r\n\tctr_llistaCapes.addTo(map);\r\n\t\r\n\tjQuery('.div_barrabotons').on('click', function () {\r\n\t\tif (jQuery('div', this).hasClass('bt_orto')) {\r\n\t        map.ortoMap();\r\n\t        canvasTiles.bringToFront();\r\n\t        jQuery('#sm_tipus').text('Mapa');\r\n\t        jQuery('div', this).addClass('bt_topo');\r\n\t        jQuery('div', this).removeClass('bt_orto');\r\n\t\t}else{\r\n\t        map.topoMapGeo();\r\n\t        canvasTiles.bringToFront();\r\n\t        jQuery('#sm_tipus').text('Ortofoto');\r\n\t        jQuery('div', this).addClass('bt_orto');\r\n\t        jQuery('div', this).removeClass('bt_topo');\r\n\t\t}\r\n\t});\r\n\t\r\n*/\t","/*\r\nVariables GLOBALS del 3D\r\n */\r\nvar viewer;\r\nvar mapaVista3D = null;\r\nvar capesActives3D;\r\nvar modul3D = true;\r\nvar terreny;\r\nvar _imageryLayers;\r\nvar scene;\r\nvar camera;\r\nvar ellipsoid;\r\nvar handler = null;\r\nvar baseLayer3D = [];\r\nvar overLayers3D = [];\r\nvar matriu3 = [];\r\nvar factorTerreny = 14;\r\nvar browserWebGL;\r\nvar disparaEventMapa = true;\r\nvar mapaEstatNOPublicacio = true;\r\nvar initAmbVistaControlada = false;\r\nvar testModel3D=false;\r\nvar msgHTML = \"\";\r\nvar modeDebug3D=true;\r\nvar _urlTerrenys = 'http://tilemaps.icgc.cat/terrenys/demextes';\r\nvar urlApp=document.location.href;\r\n\r\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)||(urlApp.indexOf('172.70.1.11')!=-1)){\r\n\t _urlTerrenys = 'http://imtilemapsdev.icgc.local/terrenys/dem2out';\r\n\t//_urlTerrenys = 'http://tilemaps.icgc.cat/terrenys/demextes';\r\n}\r\nvar _urlModels3D='http://tilemaps.icgc.cat/terrenys/model3D/test/Prova1_cesium.json';\r\nvar appl='mapa';\r\nvar factorNavegador=1000;\r\n\r\nfunction addModul3D(config) {\r\n\tvar _mapConfig = config;\r\n\tvar socChrome=isChrome();\r\n\r\n\tif(socChrome){factorNavegador=600;}\r\n\t\r\n\tif(!getModeMapa()){appl='visor';}\r\n\t\r\n\tbrowserWebGL = detectoCapacitatsWebGL();\r\n\r\n\tif (browserWebGL) {\r\n\t\tloadCesiumCssJs();\r\n\t\t$(\"body\").append('<div id=\"map3D\"></div>');\r\n\t\t$(\"body\").append('<div id=\"popup3D\"></div>');\r\n\t\t$.publish('analyticsEvent',{event:[ appl, 'siWebGL3D', 'label 3D', 1]});\r\n\t}\r\n\r\n\tjQuery('.bt_3D_2D').on('click', function (event) {\r\n\t\taturaClick(event);\r\n\t\t$.publish('analyticsEvent',{event:[ appl, tipus_user + '3D', 'label 3D', 1]});\r\n\t\t$('.tooltip').hide();\r\n\t\tactivaVista3d_2d(this);\r\n\t});\r\n\r\n\tjQuery(document).on('click', \"#tanca3D\", function (e) {\r\n\t\tjQuery(\"#popup3D\").hide();\r\n\r\n\t});\r\n\r\n\tjQuery(document).on('click', \"#chk_ad_3d\", function (e) {\r\n\t\tCookies.set('msg3D', true, {\r\n\t\t\texpires: 365\r\n\t\t});\r\n\t});\r\n\t\r\n\tif (url('?3D') == 'true') {\r\n\t\tvar fT = parseInt(_mapConfig.servidorsWMS.length * 1000 / 2);\r\n\t\tsetTimeout(function(){\r\n\t\t\tinitMapa3DfromMapConfig(_mapConfig);\r\n\t\t}, fT);\r\n\t} else if (_mapConfig.options && _mapConfig.options.mapa3D) {\r\n\t\tvar fT = parseInt(_mapConfig.servidorsWMS.length * 1000 / 2);\r\n\t\tsetTimeout(function(){\r\n\t\t\tinitMapa3DfromMapConfig(_mapConfig);\r\n\t\t}, fT);\r\n\t}\r\n\t\r\n\tif (url('?testModel3D') == 'true') {\t\r\n\t\ttestModel3D=true;\r\n\t\t_urlTerrenys='//assets.agi.com/stk-terrain/world';\r\n\t}\t\r\n}\r\n\r\nfunction loadCesiumCssJs(){\r\n    $(\"head\").append('<link id=\"cesium_css\" href=\"/llibreries/cesium/Cesium.css\" type=\"text/css\" rel=\"stylesheet\" />');\r\n    $(\"body\").append('<script src=\"/llibreries/cesium/Cesium.js\"  type=\"text/javascript\"></script>');\r\n    $(\"body\").append('<script src=\"/llibreries/cesium/Cesium.PinBuilder_IM.js\"  type=\"text/javascript\"></script>');\r\n    $(\"body\").append('<script src=\"/llibreries/cesium/cesium-navigation.js\"  type=\"text/javascript\"></script>');\r\n}\r\n\r\nfunction activaVista3d_2d(_this){\r\n\t// mirar si el navegador suporta 3d\r\n\tbrowserWebGL ? canviaVista_3D_2D(_this) : mostraMsgNo3D();\r\n}\r\n\r\nfunction gestionFonsMapa3D() {\r\n\tif (estatMapa3D && mapaEstatNOPublicacio) {\r\n\t\tmapaVista3D.addBaseLayersCesium();\r\n\t}\r\n}\r\n\r\nfunction canviaVista_3D_2D(boto, event) {\r\n\t(jQuery(boto).text() == '3D') ? init3D(boto) : init2D(boto);\r\n}\r\n\r\nfunction initMapa3DfromMapConfig(config) {\r\n\tif (browserWebGL) {\r\n\t\tinitAmbVistaControlada = true;\r\n\t\tjQuery('.bt_3D_2D').text('2D');\r\n\t\tinicialitzaMapa3D('_fromConfig', config);\r\n\t}\r\n}\r\n\r\nfunction inicialitzaMapa3D(origen, config) {\r\n\tif (browserWebGL) {\r\n\t\tif (mapaVista3D == null) {\r\n\t\t\tmapaVista3D = new IM_aplicacio({\r\n\t\t\t\t'mapId' : 'map',\r\n\t\t\t\t'mapId3D' : 'map3D', \r\n\t\t\t\tmapConfig: config\r\n\t\t\t});\r\n\t\t}\r\n\t\tmapaVista3D.canviaVisor3D(map, controlCapes, origen);\r\n\t\tActDesOpcionsVista3D(true);\r\n\t\tif (getModeMapa()) {\r\n\t\t\tif (drgFromMapa) {\r\n\t\t\t\tdrgFromMapa.destroy();\r\n\t\t\t\tdrgFromMapa = null;\r\n\t\t\t\tcreaAreesDragDropFiles();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction init3D(boto) {\r\n\tmap.spin(true);\r\n\tif (browserWebGL) {\r\n\t\tinitAmbVistaControlada = false;\r\n\t\tif (!Cookies.get('msg3D')) {\r\n\t\t\tjQuery(\"#dialgo_ad_3D\").modal('show');\r\n\t\t}\r\n\t\tjQuery(boto).text('2D');\r\n\t\tinicialitzaMapa3D('_fromBoto');\r\n\t} else {}\r\n}\r\n\r\nfunction init2D(boto) {\r\n\tjQuery(boto).text('3D');\r\n\tmapaVista3D.retornaPosicio2D().then(function (bbox) {\r\n\t\tmap.fitBounds([[bbox.lat0, bbox.lng0], [bbox.lat1, bbox.lng1]]);\r\n\t\tmap.spin(true);\r\n\t\t$(\"#map3D\").fadeOut(\"slow\", function () {\r\n\t\t\tjQuery('.leaflet-map-pane').show();\r\n\t\t\tjQuery(\"#map3D\").hide();\r\n\t\t\tjQuery(\"#popup3D\").hide();\r\n\t\t\tjQuery(\"#map3D\").html('');\r\n\t\t\tjQuery(\"#not_3d\").remove();\r\n\t\t\tjQuery(\"#not_3d_mini\").remove();\r\n\t\t\tmap.spin(false);\r\n\t\t});\r\n\r\n\t\testatMapa3D = false;\r\n\t\tmapaVista3D = null;\r\n\r\n\t\tif (getModeMapa()) {\r\n\t\t\tdrgFromMapa.destroy();\r\n\t\t\tdrgFromMapa = null;\r\n\t\t\tcreaAreesDragDropFiles();\r\n\t\t}\r\n\r\n\t\tActDesOpcionsVista3D(false);\r\n\r\n\t\tjQuery('label span').each(function (index) {\r\n\t\t\tjQuery(this).css('text-decoration', 'none');\r\n\t\t});\r\n\r\n\t\tsetTimeout(function () {\r\n\t\t\thandler = null;\r\n\t\t\tviewer = null\r\n\t\t}, 2000);\r\n\r\n\t});\r\n\r\n\tmap.spin(false);\r\n}\r\n\r\nfunction ActDesOpcionsVista3D(activa3D) {\r\n\tvar crtl = ['.leaflet-control-scale',\r\n\t\t'.leaflet-control-minimap-toggle-display',\r\n\t\t'.leaflet-control-zoom',\r\n\t\t'.bt_geopdf',\r\n\t\t'.leaflet-control-draw-measure',\r\n\t\t'#dv_bt_Routing'\r\n\t];\r\n\r\n\tif (activa3D) {\r\n\t\tjQuery('#funcio_draw').prepend('<div id=\"not_3d\">' +\r\n\t\t\twindow.lang.translate('Operacions no disponibles en modus 3D') +\r\n\t\t\t'</div>');\r\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'hidden');\r\n\t\t$.each(crtl, function (index, value) {\r\n\t\t\tjQuery(value).hide();\r\n\t\t});\r\n\t} else {\r\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'visible');\r\n\t\t$.each(crtl, function (index, value) {\r\n\t\t\tjQuery(value).show();\r\n\t\t});\r\n\t\tviewer.navigation = undefined;\r\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'visible');\r\n\t}\r\n}\r\n\r\nvar IM_aplicacio = function (options) {\r\n\tthis.options = options;\r\n\tthis.cesium = undefined;\r\n\tthis.leaflet = undefined;\r\n\tthis.mapId = this.options.mapId;\r\n\tthis.mapId3D = this.options.mapId3D;\r\n\tthis.container = document.getElementById(this.mapId);\r\n\tthis.matriuCapes = {};\r\n\tthis.matriuCapes.base = [];\r\n\tthis.matriuCapes.overlays = [];\r\n\tthis.mapConfig = this.options.mapConfig;\r\n\tthis.setVisor = function (isLeaflet) {\r\n\t\tthis.leaflet = isLeaflet;\r\n\t};\r\n\tthis.canviaVisor2D = function () {\r\n\t\testatMapa3D = false;\r\n\t};\r\n\tthis.canviaVisor3D = function (map, controlCapes, origen) {\r\n\t\toverLayers3D = [];\r\n\t\tthis.bounds = map.getBounds();\r\n\t\tthis.center = map.getCenter();\r\n\t\tterreny = new Cesium.CesiumTerrainProvider({\r\n\t\t\turl : _urlTerrenys,\r\n\t\t\tcredit : 'icgc'\r\n\r\n\t\t});\r\n\t\tthis.gestionaTerrainProvaider(this.bounds.getCenter().lat, this.bounds.getCenter().lng, 'icgc').then(function (terrain) {\r\n\t\t\tif (terrain != null) {\r\n\t\t\t\tterreny = terrain;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tviewer = new Cesium.Viewer(this.mapId3D, {\r\n\t\t\timageryProvider : false,\r\n\t\t\ttimeline : false,\r\n\t\t\tnavigationHelpButton : false,\r\n\t\t\tscene3DOnly : true,\r\n\t\t\tfullscreenButton : false,\r\n\t\t\tbaseLayerPicker : false,\r\n\t\t\thomeButton : false,\r\n\t\t\tinfoBox : false,\r\n\t\t\tsceneModePicker : false,\r\n\t\t\tanimation : false,\r\n\t\t\tgeocoder : false,\r\n\t\t\tcontextOptions : {\r\n\t\t\t\twebgl : {\r\n\t\t\t\t\tpreserveDrawingBuffer : true\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tshowRenderLoopErrors : false,\r\n\t\t\tuseDefaultRenderLoop : true,\r\n\t\t\tsceneMode : Cesium.SceneMode.SCENE3D,\r\n\t\t\tterrainProvider : terreny\r\n\t\t});\r\n\r\n\t\tnavigationInitialization(this.mapId3D, viewer);\r\n\t\tscene = viewer.scene;\r\n\t\tscene.globe.depthTestAgainstTerrain = true;\r\n\t\tcamera = viewer.scene.camera;\r\n\t\tellipsoid = scene.globe.ellipsoid;\r\n\t\tviewer.scene.globe.enableLighting = true;\r\n\t\tviewer.scene.fog.enabled = true;\r\n\t\tviewer.scene.fog.density = 0.0002;\r\n\t\tviewer.scene.fog.screenSpaceErrorFactor = 2;\r\n\t\tcapesActives3D = viewer.scene.imageryLayers;\r\n\t\t_imageryLayers = viewer.imageryLayers;\r\n\t\t\r\n\t\tviewer.scene.globe.baseColor =Cesium.Color.fromCssColorString(jQuery('#map').css('background-color'));\r\n\t\t\r\n\t\tjQuery(\"#bt_pinch3D\").show();\r\n\t\tmap.spin(true);\r\n\t\tvar zz = parseInt(map.getZoom());\r\n\t\tif (zz < 15) {\r\n\t\t\t//disparaEventMapa=false;\r\n\t\t\t//map.setZoom(parseInt(zz) + 1)\r\n\t\t}\r\n\t\tthis.bounds = map.getBounds();\r\n\t\tthis.mapZoom = map.getZoom();\r\n\r\n\t\t$(\".leaflet-map-pane\").fadeOut(\"slow\", function () {\r\n\t\t\tjQuery('#map3D').show();\r\n\t\t\tdocument.getElementById('map3D').style.display = 'block';\r\n\t\t\tjQuery(\".leaflet-map-pane\").hide();\r\n\t\t\tmap.spin(false);\r\n\t\t});\r\n\r\n\t\testatMapa3D = true;\r\n\t\r\n\t\tthis.calculaPosicioInici(this.bounds, this.mapZoom).then(function (rectangle) {\r\n\t\t\tif (initAmbVistaControlada && this.mapConfig.options) {\r\n\t\t\t\tif (this.mapConfig.options && this.mapConfig.options.camera3D) {\r\n\t\t\t\t\tvar cameraPos = this.mapConfig.options.camera3D;\r\n\t\t\t\t\tif (cameraPos.indexOf('NaN') == -1) {\r\n\t\t\t\t\t\tmapaVista3D.setPosicioCamera3D(cameraPos);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tviewer.camera.setView({\r\n\t\t\t\t\t\t\tdestination : rectangle.rectangle\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tviewer.camera.setView({\r\n\t\t\t\t\t\tdestination : rectangle.rectangle\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (origen == '_fromBoto') {\r\n\t\t\t\t\tvar _altu = parseFloat(rectangle.altMetres) + parseFloat(rectangle.newAlt[0].height);\r\n\t\t\t\t\tif (terreny.credit.text = 'icgc' && !testModel3D) {\r\n\t\t\t\t\t\tviewer.camera.flyTo({\r\n\t\t\t\t\t\t\tdestination : rectangle.rectangle,\r\n\t\t\t\t\t\t\tduration : 0,\r\n\t\t\t\t\t\t\tcomplete : function () {\r\n\t\t\t\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t\t\t\tviewer.camera.flyTo({\r\n\t\t\t\t\t\t\t\t\t\tdestination : Cesium.Cartesian3.fromDegrees(rectangle.centerLng, rectangle.newLat, (parseFloat(rectangle.altMetres) + parseFloat(rectangle.newAlt[0].height * 1.5))),\r\n\t\t\t\t\t\t\t\t\t\torientation : {\r\n\t\t\t\t\t\t\t\t\t\t\theading : Cesium.Math.toRadians(0.0),\r\n\t\t\t\t\t\t\t\t\t\t\tpitch : Cesium.Math.toRadians(rectangle._picth), //tilt\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\teasingFunction : Cesium.EasingFunction.LINEAR_NONE\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}, 2000);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tviewer.camera.setView({\r\n\t\t\t\t\t\t\tdestination : rectangle.rectangle\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tviewer.camera.setView({\r\n\t\t\t\t\t\tdestination : rectangle.rectangle\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.addBaseLayersCesium();\r\n\t\tvar that=this;\r\n\t\tsetTimeout(function(){\t\t\t\r\n\t\t\tthat.miraCapesiExternes();\r\n\t\t},factorNavegador*3);\r\n\r\n\t\t//Afegin Events Cesium hanlers\r\n\t\tif (handler == null) {\r\n\t\t\thandler = new Cesium.ScreenSpaceEventHandler(scene.canvas);\r\n\t\t\tvar thet = this;\r\n\t\t\thandler.setInputAction(function (movement) {\r\n\t\t\t\tif (estatMapa3D) {\r\n\t\t\t\t\tvar pickedObjects = scene.drillPick(movement.position);\r\n\t\t\t\t\tmsgHTML = \"\";\r\n\t\t\t\t\tjQuery(\"#popup3D\").hide();\r\n\t\t\t\t\tvar pickRay = viewer.camera.getPickRay(movement.position);\r\n\t\t\t\t\tvar featuresPromise = viewer.imageryLayers.pickImageryLayerFeatures(pickRay, viewer.scene);\r\n\t\t\t\t\tif (!Cesium.defined(featuresPromise)) {}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tCesium.when(featuresPromise, function (features) {\r\n\t\t\t\t\t\t\tif (features.length > 0) {\r\n\t\t\t\t\t\t\t\tif (features[0].data.properties) {\r\n\t\t\t\t\t\t\t\t\tthet.generaPopup(features[0].data, \"vector\");\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthet.generaPopup(features[0], \"raster\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (Cesium.defined(pickedObjects)) {\r\n\t\t\t\t\t\tif (pickedObjects.length > 0) {\r\n\t\t\t\t\t\t\tthet.generaPopup(pickedObjects[0].id, \"vector\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}, Cesium.ScreenSpaceEventType.LEFT_CLICK);\r\n\t\t\t\r\n\t\t\thandler.setInputAction(function (movement) {\r\n\t\t\t\tif (estatMapa3D) {\r\n\t\t\t\t\tthet.miraPosicioXYZ(movement);\r\n\t\t\t\t}\r\n\t\t\t}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\r\n\t\t}\r\n\t\tthis.activaEventLeaflet();\r\n\t};\r\n\r\n\tthis.miraCapesiExternes = function () {\r\n\t\tthis.addOverlaysLayersCesium(controlCapes);\r\n\t};\r\n\r\n\tthis.activaEventLeaflet = function () {\r\n\t\tvar thet = this;\r\n\t\tmap.on('viewreset', function (e) {\r\n\t\t\tif (estatMapa3D && disparaEventMapa) {\r\n\t\t\t\tthet._goToBounds(map.getBounds(), map.getZoom());\t\t\t\t\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tthis.miraPosicioXYZ = function (movement) {\r\n\t\tmatriu3 = [];\r\n\t\ttry {\r\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\tvar cartesian = viewer.camera.pickEllipsoid(movement.endPosition, ellipsoid);\r\n\t\t\tif (cartesian) {\r\n\t\t\t\tvar cartographic = ellipsoid.cartesianToCartographic(cartesian);\r\n\t\t\t\tvar lon = Cesium.Math.toDegrees(cartographic.longitude);\r\n\t\t\t\tvar lat = Cesium.Math.toDegrees(cartographic.latitude);\r\n\t\t\t\tvar lonC = Cesium.Math.toRadians(lon);\r\n\t\t\t\tvar latC = Cesium.Math.toRadians(lat);\r\n\t\t\t\tif (!isNaN(lonC)) {\r\n\t\t\t\t\tvar text = '<div>WGS84 ' + lon.toFixed(5) + ' ' + lat.toFixed(5) + '</div>';\r\n\t\t\t\t\tjQuery('.leaflet-control-mouseposition').html(text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (Err) {\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'error3D', Err, 'miraPosicioXYZ', 1]});\r\n\t\t}\r\n\t};\r\n\r\n\tthis._goToBounds = function (bounds, mapZoom) {\r\n\t\tvar rectangle = Cesium.Rectangle.fromDegrees((bounds.getWest()),\r\n\t\t\t((bounds.getSouth())), \r\n\t\t\t(bounds.getEast()),\r\n\t\t\t((bounds.getNorth())));\r\n\t\tviewer.camera.setView({\r\n\t\t\tdestination : rectangle\r\n\t\t});\r\n\t};\r\n\r\n\tthis._goTo = function (lat, lng) {\r\n\t\tviewer.camera.setView({\r\n\t\t\tdestination : Cesium.Cartesian3.fromDegrees(lng, lat, viewer.camera.positionCartographic.height),\r\n\t\t\torientation : {\r\n\t\t\t\theading : viewer.camera.heading,\r\n\t\t\t\tpitch : viewer.camera.pitch,\r\n\t\t\t\troll : viewer.camera.roll\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tthis.canviaOpacity = function (businessId, opacity) {\r\n\t\tjQuery.each(capesActives3D._layers, function (index, layer) {\r\n\t\t\tif (layer.id == businessId) {\r\n\t\t\t\tlayer.alpha = opacity;\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tthis.actualitzaVistaOverlays = function (obj, accio, visible) {\r\n\t\tif (mapaEstatNOPublicacio) {\r\n\t\t\tif (accio == \"add\") {\r\n\t\t\t\tif (jQuery.inArray(obj.businessId, overLayers3D) == -1) {\r\n\t\t\t\t\tthis.matriuCapes.overlays = [];\r\n\t\t\t\t\tthis.addOverlaysLayersCesium();\r\n\t\t\t\t}\r\n\t\t\t} else if ((accio == \"display\") || (accio == \"remove\")) {\r\n\t\t\t\tvar trobatCapa = false;\r\n\t\t\t\tjQuery.each(capesActives3D._layers, function (index, layer) {\r\n\t\t\t\t\tif (layer && layer.id == obj.businessId) {\r\n\t\t\t\t\t\ttrobatCapa = true;\r\n\t\t\t\t\t\tif (accio == \"display\") {\r\n\t\t\t\t\t\t\tlayer.show = visible\r\n\t\t\t\t\t\t} else if (accio == \"remove\") {\r\n\t\t\t\t\t\t\tcapesActives3D.remove(layer, true)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tvar n = 0;\r\n\t\t\t\tfor (var f = 0; f < viewer.entities.values.length; f++) {\r\n\t\t\t\t\tvar feature = viewer.entities.values[f];\r\n\t\t\t\t\tif (feature && feature.properties) {\r\n\t\t\t\t\t\tif (feature.properties.dataSource == obj.businessId) {\r\n\t\t\t\t\t\t\ttrobatCapa = true;\r\n\t\t\t\t\t\t\tif (accio == \"display\") {\r\n\t\t\t\t\t\t\t\tfeature.show = visible;\r\n\t\t\t\t\t\t\t} else if (accio == \"remove\") {\r\n\t\t\t\t\t\t\t\tfeature.show = false;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!trobatCapa) {\r\n\t\t\t\t\tmap.spin(true);\r\n\t\t\t\t\tif (jQuery.inArray(obj.businessId, overLayers3D) == -1) {\r\n\t\t\t\t\t\tthis.matriuCapes.overlays = [];\r\n\t\t\t\t\t\tthis.addOverlaysLayersCesium();\r\n\t\t\t\t\t\tmap.spin(false);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tjQuery.each(viewer.entities.values, function (index, feature) {\r\n\t\t\t\t\tif (feature.properties.dataSource == obj.businessId) {\r\n\t\t\t\t\t\tfeature.show = visible;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis.generaPopup = function (player, origen) {\r\n\t\tif (origen == \"vector\" && player.properties) {\r\n\t\t\tvar out = [];\r\n\t\t\tif (player.properties.nom && !isBusinessId(player.properties.nom)) {\r\n\t\t\t\tmsgHTML += '<h4>' + player.properties.nom + '</h4>';\r\n\t\t\t} else if (player.properties.name && !isBusinessId(player.properties.name)) {\r\n\t\t\t\tmsgHTML += '<h4>' + player.properties.name + '</h4>';\r\n\t\t\t} else if (player.properties.Name && !isBusinessId(player.properties.Name)) {\r\n\t\t\t\tmsgHTML += '<h4>' + player.properties.Name + '</h4>';\r\n\t\t\t}\r\n\t\t\tif (player.properties.description) {\r\n\t\t\t\tif (!$.isNumeric(player.properties.description) && !validateWkt(player.properties.description))\r\n\t\t\t\t\tmsgHTML += '<div>' + parseUrlTextPopUp(player.properties.description) + '</div>';\r\n\t\t\t\telse\r\n\t\t\t\t\tmsgHTML += '<div>' + player.properties.description + '</div>';\r\n\t\t\t}\r\n\t\t\tmsgHTML += '<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\r\n\t\t\tvar pp = player.properties;\r\n\t\t\t$.each(pp, function (key, value) {\r\n\t\t\t\tif (key != \"styles\" && key != \"dataSource\" && key != \"OGR\" && key != \"OGR_STYLE\") {\r\n\t\t\t\t\tif (isValidValue(value)) {\r\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50') {\r\n\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_row\">';\r\n\t\t\t\t\t\t\tvar txt = value;\r\n\t\t\t\t\t\t\tif (!$.isNumeric(txt) && key != \"styles\" && !validateWkt(txt)) {\r\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\r\n\t\t\t\t\t\t\t\tif (txt.indexOf(\"iframe\") == -1 && txt.indexOf(\"img\") == -1) {\r\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_key\">' + key + '</div>';\r\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_value\">' + txt + '</div>';\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_img_iframe\">' + txt + '</div>';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_key\">' + key + '</div>';\r\n\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_value\">' + txt + '</div>';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tmsgHTML += '</div>';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmsgHTML += '</div></div>';\r\n\t\t} else {\r\n\t\t\tmsgHTML += player.data;\r\n\t\t}\r\n\t\tvar html2 = '<div class=\"leaflet-popup leaflet-container leaflet-zoom-animated\" style=\"opacity:1\"><a id=\"tanca3D\" class=\"leaflet-popup-close-button\" href=\"#close\">Ã—</a>' +\r\n\t\t\t'<div class=\"leaflet-popup-content-wrapper\">' +\r\n\t\t\t'<div class=\"leaflet-popup-content\" style=\"width: 301px;\">' +\r\n\t\t\tmsgHTML +\r\n\t\t\t'</div></div></div>';\r\n\t\tjQuery(\"#popup3D\").show();\r\n\t\tjQuery(\"#popup3D\").html(html2);\r\n\t};\r\n\t\r\n\tthis.addBaseLayersCesium = function () {\r\n\t\tif (mapaEstatNOPublicacio) {\r\n\t\t\tjQuery.each(baseLayer3D, function (index, layer) {\r\n\t\t\t\t_imageryLayers.remove(layer, true); //capesActives3D\r\n\t\t\t});\r\n\t\t\tbaseLayer3D = [];\r\n\t\t\tthis.matriuCapes.base = map.getLGActiveMap().getLayers();\r\n\t\t\tthis.matriuCapes.base.reverse();\r\n\t\t\tfor (var i = 0; i < this.matriuCapes.base.length; i++) {\r\n\t\t\t\tvar url = this.matriuCapes.base[i]._url;\r\n\t\t\t\tif (url.indexOf('osm.org') != -1 || url.indexOf('openstreetmap.org') != -1) {\r\n\t\t\t\t\tif (!this._miraCentreDins(this.center.lat, this.center.lng)) {\r\n\t\t\t\t\t\tthis.matriuCapes.base[i].options.tms ? url = url.replace('{y}', '{reverseY}') : url;\r\n\t\t\t\t\t\tvar BB_layer = _imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({\r\n\t\t\t\t\t\t\turl : url,\r\n\t\t\t\t\t\t\tmaximumLevel : 18,\r\n\t\t\t\t\t\t\tminimumLevel : 3\r\n\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t_imageryLayers.lowerToBottom(BB_layer);\r\n\t\t\t\t\t\tbaseLayer3D.push(BB_layer);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.matriuCapes.base[i].options.tms ? url = url.replace('{y}', '{reverseY}') : url;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tvar _mxlevel=18;\t\t\t\t\t\r\n\t\t\t\t\tif(url.indexOf('bases_noutm')!=-1){\r\n\t\t\t\t\t\t_mxlevel=19;\t\t\t\t\t\t\t\r\n\t\t\t\t\t}else if(url.indexOf('relleu')!=-1){\r\n\t\t\t\t\t\t_mxlevel=17;\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar BB_layer = _imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({\r\n\t\t\t\t\t\turl : url,\r\n\t\t\t\t\t\tmaximumLevel : _mxlevel,\r\n\t\t\t\t\t\tminimumLevel : 3\r\n\t\t\t\t\t}));\r\n\t\t\t\t\t_imageryLayers.lowerToBottom(BB_layer);\r\n\t\t\t\t\tbaseLayer3D.push(BB_layer);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(testModel3D){\r\n\t\t\t\tvar tileset=viewer.scene.primitives.add( new Cesium.Cesium3DTileset({\r\n\t\t\t\t\turl: _urlModels3D,\r\n\t\t\t\t\tmaximumScreenSpaceError: 2,\r\n\t\t\t\t\tmaximumNumberOfLoadedTiles: 1000\r\n\t\t\t\t}));\t \r\n\t\t\t}\t\r\n\t\t}\r\n\t};\r\n\r\n\tthis.addOverlaysLayersCesium = function () {\r\n\t\tvar that = this;\r\n\t\tvar numCapes = 1;\r\n\t\tvar numCapesActives = 0;\r\n\t\ttry {\r\n\t\t\tnumCapes = controlCapes.getCountLayers();\r\n\t\t\tjQuery.each(controlCapes._layers, function (i, item) {\r\n\t\t\t\tif (item.layer._map != null) {\r\n\t\t\t\t\tnumCapesActives = numCapesActives + 1;\r\n\t\t\t\t}\r\n\t\t\t\tjQuery.each(item._layers, function (j, item2) {\r\n\t\t\t\t\tif (item2.layer._map != null) {\r\n\t\t\t\t\t\tnumCapesActives = numCapesActives + 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\tnumCapes = numCapesActives;\r\n\t\t} catch (Err) {\r\n\t\t\tnumCapes = 1;\r\n\t\t}\r\n\t\tjQuery.each(controlCapes._layers, function (i, item) {\r\n\t\t\tthat._utilValidoClassificoTipusCapa(item, numCapes);\r\n\t\t\tjQuery.each(item._layers, function (j, item2) {\r\n\t\t\t\tthat._utilValidoClassificoTipusCapa(item2, numCapes);\r\n\t\t\t});\r\n\t\t});\r\n\t\tthis.addOverlaysVectorsCesium();\r\n\t\tthis.addOverlaysRastersCesium();\r\n\t};\r\n\r\n\tthis._utilValidoClassificoTipusCapa = function (item, numCapes) {\r\n\t\tif (item.layer._map != null) {\r\n\t\t\tif (item.layer.options.tipusRang != tem_heatmap && item.layer.options.tipusRang != tem_cluster && item.layer.options.wmstime != true) {\r\n\t\t\t\tif (jQuery.inArray(item.layer.options.businessId, overLayers3D) == -1) {\r\n\t\t\t\t\tthis.matriuCapes.overlays.push(this._utilDeterminaTipusItem(item, true, numCapes));\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tjQuery('label span#' + item.layer._leaflet_id).css('text-decoration', 'line-through');\r\n\t\t\t\tjQuery('.leaflet-bar-timecontrol').hide();\r\n\t\t\t}\r\n\t\t} else { //NO ACTIVES\r\n\t\t\tif (item.layer.options.tipusRang != tem_heatmap && item.layer.options.tipusRang != tem_cluster && item.layer.options.wmstime != true) {\r\n\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\tjQuery('label span#' + item.layer._leaflet_id).css('text-decoration', 'line-through');\r\n\t\t\t\tjQuery('.leaflet-bar-timecontrol').hide();\r\n\t\t\t}\r\n\t\t} //FI ELSE NO actives\r\n\t};\r\n\r\n\tthis.addOverlaysRastersCesium = function () {\r\n\t\tmatriuCapesLL.layers = [];\r\n\t\tmatriuCapesLL.n_layers = [];\r\n\t\tmatriuCapesLL.id_layers = [];\r\n\t\tmatriuCapesLL.t_layers = [];\r\n\t\tmatriuCapesLL.c_layers = [];\r\n\t\tmatriuCapesLL.v_layers = [];\r\n\t\tvar _hihaVecras = false;\r\n\t\tfor (var i = 0; i < this.matriuCapes.overlays.length; i++) {\r\n\t\t\tif (jQuery.inArray(this.matriuCapes.overlays[i].businessId, overLayers3D) == -1) {\r\n\t\t\t\tif (this.matriuCapes.overlays[i].tipus == \"raster\") {\r\n\t\t\t\t\tvar raster = this.matriuCapes.overlays[i].item;\r\n\t\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\r\n\t\t\t\t\tif (raster.layer.options.tipus.indexOf(\"wms\") != -1) {\r\n\t\t\t\t\t\tvar _url = raster.layer._url;\r\n\t\t\t\t\t\tif (_url) {\r\n\t\t\t\t\t\t\tif (_url.indexOf('?') == -1) {\r\n\t\t\t\t\t\t\t\t_url = _url + '?';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar opacity = 0.9;\r\n\t\t\t\t\t\tif (raster.layer.options.opacity) {\r\n\t\t\t\t\t\t\topacity = raster.layer.options.opacity;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (urlApp.indexOf('172.70.1.11') != -1) {\r\n\t\t\t\t\t\t\t_url = _url.replace('betaserver.icgc.cat', '172.70.1.31');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar provider = new Cesium.WebMapServiceImageryProvider({\r\n\t\t\t\t\t\t\turl : _url,\r\n\t\t\t\t\t\t\tlayers : raster.layer.wmsParams.layers,\r\n\t\t\t\t\t\t\tenablePickFeatures : true,\r\n\t\t\t\t\t\t\tgetFeatureInfoAsXml : false,\r\n\t\t\t\t\t\t\tgetFeatureInfoAsGeoJson : false,\r\n\t\t\t\t\t\t\tgetFeatureInfoParameters : {\r\n\t\t\t\t\t\t\t\tinfo_format : 'text/plain'\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tparameters : {\r\n\t\t\t\t\t\t\t\ttransparent : 'true',\r\n\t\t\t\t\t\t\t\tformat : 'image/png',\r\n\t\t\t\t\t\t\t\tstyles : ''\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tmaximumLevel : 18,\r\n\t\t\t\t\t\t\tminimumLevel : 5,\r\n\t\t\t\t\t\t\tproxy : {\r\n\t\t\t\t\t\t\t\tgetURL : function (url) {\r\n\t\t\t\t\t\t\t\t\treturn paramUrl.proxy_betterWMS + '?url=' + encodeURIComponent(url);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tprovider.alpha = opacity;\r\n\t\t\t\t\t\tsetTimeout(this.delayAddImageProvider(provider, visible, raster.layer.options.businessId), 1000);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this.matriuCapes.overlays[i].tipus == \"vecras\") {\r\n\t\t\t\t\t_hihaVecras = true;\r\n\t\t\t\t\tvar vecras = this.matriuCapes.overlays[i].item;\r\n\t\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tompleCapesMatriu(vecras, true);\r\n\t\t\t\t\t\tmatriuCapesLL.v_layers.push(visible);\r\n\t\t\t\t\t} catch (Err) {}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} //fi for\r\n\t\tif (_hihaVecras) {\r\n\t\t\tthis.generaWMSfromCapesVector();\r\n\t\t}\r\n\t};\r\n\r\n\tthis.generaWMSfromCapesVector = function () {\r\n\t\tvar data = matriuCapesLL;\r\n\t\tvar that = this;\r\n\t\tdata.request = \"createWMSfromMap\";\r\n\t\tdata.businessId = that.mapConfig.businessId;\r\n\t\tdata.nomAplicacio = that.mapConfig.nomAplicacio;\r\n\t\tdata.modeMapa = getModeMapa();\r\n\t\tgetModeMapa() ? data.entitatUid = _UsrID : data.entitatUid = that.mapConfig.servidorsWMS[0].entitatUid;\r\n\t\tif (that.mapConfig.entitatUid && that.mapConfig.entitatUid.indexOf(\"random_\") != -1) {\r\n\t\t\tdata.entitatUid = \"randomuser\"\r\n\t\t}\r\n\t\tif (data.c_layers.length > 0) {\r\n\t\t\tmap.spin(true);\r\n\t\t\tfor (var z = 0; z < data.c_layers.length; z++) {\r\n\t\t\t\tvar _newData = {};\r\n\t\t\t\t_newData.request = data.request;\r\n\t\t\t\t_newData.businessId = data.id_layers[z];\r\n\t\t\t\t_newData.nomAplicacio = data.nomAplicacio;\r\n\t\t\t\t_newData.modeMapa = data.modeMapa;\r\n\t\t\t\t_newData.entitatUid = data.entitatUid;\r\n\t\t\t\t_newData.layers = [data.layers[z]];\r\n\t\t\t\t_newData.n_layers = [data.n_layers[z]];\r\n\t\t\t\t_newData.id_layers = [data.id_layers[z]];\r\n\t\t\t\t_newData.t_layers = [data.t_layers[z]];\r\n\t\t\t\t_newData.c_layers = [data.c_layers[z]];\r\n\t\t\t\t_newData.v_layers = [data.v_layers[z]];\r\n\t\t\t\tcreateMapToWMS(_newData).then(\r\n\t\t\t\t\tfunction (results) {\r\n\t\t\t\t\tif (results.status == \"OK\") {\r\n\t\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t\tvar url = results.url;\r\n\t\t\t\t\t\t\tif (url.indexOf('?') == -1) {\r\n\t\t\t\t\t\t\t\turl = url + '?';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthat.addVectortoWMSToMatriuCapes(_newData.id_layers[0], _newData.n_layers[0], url, _newData.v_layers[0]);\r\n\t\t\t\t\t\t}, factorNavegador);\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} //fi for\r\n\t\t} //fi bucle\r\n\t};\r\n\r\n\tthis.addVectortoWMSToMatriuCapes = function (layers, titles, url, visible) {\r\n\t\tvar that = this;\r\n\t\tvar _bbox = 'bbox={westProjected}%2C{southProjected}%2C{eastProjected}%2C{northProjected}&';\r\n\t\tvar srs = \"EPSG:3857\";\r\n\t\tprovider = new Cesium.UrlTemplateImageryProvider({\r\n\t\t\tenablePickFeatures : true,\r\n\t\t\tgetFeatureInfoAsXml : false,\r\n\t\t\tgetFeatureInfoAsGeoJson : true,\r\n\t\t\tgetFeatureInfoParameters : {\r\n\t\t\t\tinfo_format : 'geojson'\r\n\t\t\t},\r\n\t\t\turl : url + '&tiled=true&' +\r\n\t\t\t'transparent=true&format=image%2Fpng&exceptions=application/vnd.ogc.se_blank&' +\r\n\t\t\t'styles=&service=WMS&version=1.1.1&request=GetMap&' +\r\n\t\t\t'layers=Capa_' + layers + '&srs=' + encodeURI(srs) + '&' +\r\n\t\t\t_bbox +\r\n\t\t\t'width=256&height=256&',\r\n\t\t\tmaximumLevel : 19,\r\n\t\t\tminimumLevel : 3\r\n\t\t});\r\n\t\tsetTimeout(that.delayAddImageProvider(provider, visible, layers), 100);\r\n\t};\r\n\r\n\tthis.delayAddImageProvider = function (provider, visible, id) {\r\n\t\tvar _tmpLayer = capesActives3D.addImageryProvider(provider);\r\n\t\t_tmpLayer.id = id;\r\n\t\t_tmpLayer.show = false;\r\n\t\tsetTimeout(function () {\r\n\t\t\t_tmpLayer.show = visible;\r\n\t\t\tmap.spin(false);\r\n\t\t}, factorNavegador *2);\r\n\t\toverLayers3D.push(_tmpLayer);\r\n\t};\r\n\t\r\n\tthis.addOverlaysVectorsCesium = function () {\r\n\t\tvar that = this;\r\n\t\tfor (var i = 0; i < this.matriuCapes.overlays.length; i++) {\r\n\t\t\tif (this.matriuCapes.overlays[i].tipus == \"vector\") {\r\n\t\t\t\tvar vector = this.matriuCapes.overlays[i].item;\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\t\t\t\t\t\t\t\r\n\t\t\t\tvar gj = vector.layer.toGeoJSONStyles2ToProperties();\r\n\t\t\t\tvar msg = this.matriuCapes.overlays[i].msg;\r\n\t\t\t\tvar bb = vector.layer.options.businessId;\r\n\t\t\t\tif (jQuery.inArray(bb, overLayers3D) == -1) {\r\n\t\t\t\t\toverLayers3D.push(bb);\r\n\t\t\t\t\tvar promise = Cesium.GeoJsonDataSource.load(gj);\r\n\t\t\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\t\t\tpromise.then(function (dataSource) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tdataSource.id = bb;\r\n\t\t\t\t\t\tvar dataL = dataSource;\r\n\t\t\t\t\t\tvar XYZ_Edificis = [];\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\tthat.calculaMatriuAlcades(dataL, XYZ_Edificis, 3, visible, msg);\r\n\t\t\t\t\t\t},factorNavegador);\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}).otherwise(function (error) {\r\n\t\t\t\t\t\tconsole.warn(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis._utilDeterminaTipusItem = function (item, visibilitat, numCapes) {\r\n\t\tvar tmp_feature = {\r\n\t\t\t\"item\" : item,\r\n\t\t\t\"show\" : visibilitat,\r\n\t\t\t\"businessId\" : item.layer.options.businessId,\r\n\t\t\t\"msg\" : 'vector'\r\n\t\t};\r\n\t\tvar factor = 1;\r\n\t\tvar mapZoom = this.mapZoom;\r\n\t\tif (numCapes <= 15) {\r\n\t\t\tfactor = 3\r\n\t\t}\r\n\t\tif (numCapes >= 15) {\r\n\t\t\tfactor = 1\r\n\t\t}\r\n\t\tvar _factorNumVectorsPol = 450 * factor;\r\n\t\tvar _factorNumVectorsLin = 300 * factor;\r\n\t\tvar _factorNumVectorsPunt = 500 * factor;\r\n\t\tif (numCapes >= 25) {\r\n\t\t\t_factorNumVectorsPol = 10;\r\n\t\t\t_factorNumVectorsLin = 20;\r\n\t\t\t_factorNumVectorsPunt = 30;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tvar ff = item.layer.toGeoJSON();\t\t\t\t\t\r\n\t\t\tvar numFeatures = ff.features.length;\r\n\t\t\tif (item.layer.options.geometryType) {\r\n\t\t\t\tif (item.layer.options.geometryType.indexOf('polygon') != -1) {\r\n\t\t\t\t\t_escriuDebug(item.layer.options,\"instamaps.mapa3D-1.0.0\",1288);\r\n\t\t\t\t\tif (item.layer.options.source && item.layer.options.source.indexOf('json')!=-1) {\r\n\t\t\t\t\t\tnumFeatures <= _factorNumVectorsPol ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t\t\tif (tmp_feature.tipus == 'vector') {\r\n\t\t\t\t\t\t\tfor (var j = 0; j < numFeatures; j++) {\r\n\t\t\t\t\t\t\t\tvar vertex = ff.features[j].geometry.coordinates[0].length;\r\n\t\t\t\t\t\t\t\t_escriuDebug(vertex,\"instamaps.mapa3D-1.0.0\",1303);\r\n\t\t\t\t\t\t\t\tif (vertex > 46000) {\r\n\t\t\t\t\t\t\t\t\ttmp_feature.msg = 'none';\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (mapZoom <= 10 && numFeatures < 3500) {\r\n\t\t\t\t\t\t\ttmp_feature.msg = 'none';\r\n\t\t\t\t\t\t\ttmp_feature.tipus = 'vector'\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (item.layer.options.source && item.layer.options.source.indexOf('xls') != -1) {\r\n\t\t\t\t\t\tnumFeatures <= 1000 ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t\t\ttmp_feature.msg = 'none';\r\n\t\t\t\t\t} else if (item.layer.options.source && item.layer.options.source.indexOf('csv') != -1) {\r\n\t\t\t\t\t\tnumFeatures <= 1000 ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t\t\ttmp_feature.msg = 'none';\r\n\t\t\t\t\t} else if (!item.layer.options.source) {\r\n\t\t\t\t\t\tnumFeatures <= _factorNumVectorsPol ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttmp_feature.tipus = 'vecras';\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (item.layer.options.geometryType.indexOf('polyline') != -1) {\r\n\t\t\t\t\tnumFeatures <= (_factorNumVectorsLin) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t} else { //son punts\r\n\t\t\t\t\tnumFeatures <= (_factorNumVectorsPunt) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t\t}\r\n\t\t\t} else if (item.layer.options.tipusRang) {\r\n\t\t\t\ttmp_feature.tipus = 'vecras';\r\n\t\t\t} else {\r\n\t\t\t\tnumFeatures <= (_factorNumVectorsPunt) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\r\n\t\t\t}\r\n\t\t\tff = \"\";\r\n\t\t\t_escriuDebug(tmp_feature,\"instamaps.mapa3D-1.0.0\",1367);\r\n\t\t\treturn tmp_feature;\r\n\t\t} catch (err) {\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'error3D', err, '_utilDeterminaTipusItem', 1]});\r\n\t\t\tif (item.layer.options.tipusRang) {\r\n\t\t\t\ttmp_feature.tipus = 'vecras';\r\n\t\t\t} else {\r\n\t\t\t\ttmp_feature.tipus = 'raster';\r\n\t\t\t}\r\n\t\t\t_escriuDebug(tmp_feature,\"instamaps.mapa3D-1.0.0\",1382);\r\n\t\t\treturn tmp_feature;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.calculaMatriuAlcades = function (dataSource, matriu, hFactor, visible, msg) {\r\n\t\t_escriuDebug(\"calculaMatriuAlcades\",\"instamaps.mapa3D-1.0.0\",1367);\r\n\t\tvar collection = dataSource.entities;\r\n\t\tvar entities = collection.values;\r\n\t\tvar length = entities.length;\r\n\t\tvar that = this;\r\n\t\tif (msg == 'vector') {\r\n\t\t\tfor (var i = 0; i < length; ++i) {\r\n\t\t\t\tvar entity = entities[i];\r\n\t\t\t\tentity.ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\t\tif (entity.billboard) {\r\n\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.position._value);\r\n\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\r\n\t\t\t\t} else if (entity.polyline) {\r\n\t\t\t\t\tfor (var j = 0; j < entity.polyline.positions._value.length; ++j) {\r\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polyline.positions._value[j]);\r\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (entity.polygon) {\r\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\r\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polygon._hierarchy._value.positions[j]);\r\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} //fi bicle FOR\r\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, factorTerreny, matriu);\r\n\t\t\tCesium.when(promise, function (updatedPositions) {\r\n\t\t\t\t_escriuDebug(length,\"instamaps.mapa3D-1.0.0\",1452);\r\n\t\t\t\tif(length >50){\r\n\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\r\n\t\t\t\t\t},factorNavegador);\r\n\t\t\t\t}else{\t\t\t\t\r\n\t\t\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\r\n\t\t\t\t}\t\r\n\t\t\t});\r\n\t\t\tmap.spin(true);\r\n\t\t} else {\r\n\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\r\n\t\t}\r\n\t};\r\n\r\n\tthis.calculaMatriuAlcadesClaimTerrain = function (dataSource, matriu, hFactor, visible, msg) {\r\n\t\tvar collection = dataSource.entities;\r\n\t\tvar entities = collection.values;\r\n\t\tvar length = entities.length;\r\n\t\tvar that = this;\r\n\t\tif (msg == 'vector' && !entities[0].polyline) {\r\n\t\t\tconsole.info(\"No hauria entrar\");\r\n\t\t\tfor (var i = 0; i < length; ++i) {\r\n\t\t\t\tvar entity = entities[i];\r\n\t\t\t\tentity.ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\t\tif (entity.billboard) {\r\n\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.position._value)\r\n\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\r\n\t\t\t\t} \r\n\t\t\t\telse if (entity.polygon) {\r\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\r\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polygon._hierarchy._value.positions[j]);\r\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} //fi bicle FOR\r\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, factorTerreny, matriu);\r\n\t\t\tCesium.when(promise, function (updatedPositions) {\r\n\t\t\t\tif(length >50){\r\n\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\r\n\t\t\t\t\t},factorNavegador);\r\n\t\t\t\t}else{\t\t\t\t\r\n\t\t\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\t\r\n\t\t\t\t}\t\r\n\t\t\t});\r\n\t\t\tmap.spin(true);\r\n\t\t} else {\r\n\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\t\r\n\t\t}\r\n\t};\r\n\t\r\n\tthis.addEntitiesVisorCesiumClamTerrain = function (dataSource, matriu, hfactor, visible, msg) {\r\n\t\tvar entities = dataSource.entities.values;\r\n\t\tvar z = 0;\r\n\t\tfor (var i = 0; i < entities.length; i++) {\r\n\t\t\tvar entity = entities[i];\r\n\t\t\tentity.show = true;\r\n\t\t\tentity.properties.dataSource = dataSource.id;\r\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\tif (entity.polyline) {\r\n\t\t\t\tvar colorLin=entity.properties.styles.color;\r\n\t\t\t\tvar wLin=entity.properties.styles.weight;\r\n\t\t\t\tif(!colorLin){colorLin=\"#FFCC00\";}\r\n\t\t\t\tif(!wLin){wLin=2;}\r\n\t\t\t\tvar _newEntity = {\r\n\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\tpolyline : {\r\n\t\t\t\t\t\tpositions : entity.polyline.positions._value,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\twidth :(parseInt(wLin)*4),\r\n\t\t\t\t\t\tmaterial : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin)),\r\n\t\t\t\t\t\tcolor : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin)),\r\n\t\t\t\t\t\theightReference :Cesium.HeightReference.CLAMP_TO_GROUND\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(_newEntity);\r\n\t\t\t} else if (entity.billboard) {\r\n\t\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\r\n\t\t\t\tif (entity.properties.styles.icon) {\r\n\t\t\t\t\tvar _alt = parseInt(matriu[i].height + 100)\r\n\t\t\t\t\tvar redEllipse = viewer.entities.add({\r\n\t\t\t\t\t\tposition : ellipsoid.cartographicToCartesian(matriu[i]),\r\n\t\t\t\t\t\theight : matriu[i].height,\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tellipse : {\r\n\t\t\t\t\t\t\tsemiMinorAxis : 0.75,\r\n\t\t\t\t\t\t\tsemiMajorAxis : 0.75,\r\n\t\t\t\t\t\t\tperPositionHeight : false,\r\n\t\t\t\t\t\t\theight : matriu[i].height,\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.WHITE,\r\n\t\t\t\t\t\t\textrudedHeight : parseInt(_alt)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmatriu[i].height = _alt;\r\n\t\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\r\n\t\t\t\t\tvar pinBuilder = new PinBuilder_IM();\r\n\t\t\t\t\tentity.billboard.color = Cesium.Color.WHITE;\r\n\t\t\t\t\tif (entity.properties.styles.icon.options.markerColor) {\r\n\t\t\t\t\t\tvar colorPUNT = entity.properties.styles.icon.options.markerColor; //\r\n\t\t\t\t\t\tif (colorPUNT.indexOf('punt_r') == -1) {\r\n\t\t\t\t\t\t\tentity.billboard.image = pinBuilder.fromColor(\r\n\t\t\t\t\t\t\t\tCesium.Color[colorPUNT.toUpperCase()], 48);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tentity.billboard = \"\";\r\n\t\t\t\t\t\t\tentity.point = {\r\n\t\t\t\t\t\t\t\tshow : visible, // default\r\n\t\t\t\t\t\t\t\tcolor : Cesium.Color\r\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.fillColor), // default:\r\n\t\t\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.icon.options.radius) * 1.5), // default:\r\n\t\t\t\t\t\t\t\toutlineColor : Cesium.Color\r\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.color), // default:\r\n\t\t\t\t\t\t\t\toutlineWidth : 2\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (entity.properties.styles.icon.options.iconUrl) {\r\n\t\t\t\t\t\tvar url = entity.properties.styles.icon.options.iconUrl;\r\n\t\t\t\t\t\tentity.billboard.image = url;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (!entity.properties.styles.icon) {\r\n\t\t\t\t\tvar _color=\"#FFCC00\";\r\n\t\t\t\t\tentity.properties.styles.color?_color=entity.properties.styles.color:_color=_color;\r\n\t\t\t\t\tentity.billboard = \"\";\r\n\t\t\t\t\tentity.point = {\r\n\t\t\t\t\t\tshow : visible, // default\r\n\t\t\t\t\t\tcolor : Cesium.Color\r\n\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.fillColor), // default:\r\n\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.radius) * 1.5), // default:\r\n\t\t\t\t\t\toutlineColor : Cesium.Color\r\n\t\t\t\t\t\t.fromCssColorString(_color), // default:\r\n\t\t\t\t\t\toutlineWidth : 2\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_escriuDebug(\"No hauria entrar aqui\",\"instamaps.mapa3D-1.0.0\",1713);\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(entity); //add billboard\r\n\t\t\t} else if (entity.polygon) {\r\n\t\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\t\tentity.polygon.perPositionHeight = new Cesium.ConstantProperty(false);\r\n\t\t\t\tvar borderColor = entity.properties.styles.borderColor ? entity.properties.styles.borderColor : \"\";\r\n\t\t\t\tvar fillOpacity = entity.properties.styles.fillOpacity ? entity.properties.styles.fillOpacity : false;\r\n\t\t\t\tvar fillColor = entity.properties.styles.fillColor ? entity.properties.styles.fillColor : \"\";\r\n\t\t\t\tvar outlineWidth = entity.properties.styles.weight;\r\n\t\t\t\tif (fillColor == \"\") {\r\n\t\t\t\t\tfillColor = entity.properties.styles.color\r\n\t\t\t\t};\r\n\t\t\t\tif (borderColor == \"\" || borderColor == \"#FFC400\") {\r\n\t\t\t\t\tborderColor = entity.properties.styles.color\r\n\t\t\t\t};\r\n\t\t\t\tif (!fillOpacity) {\r\n\t\t\t\t\tfillOpacity = 0.5;\r\n\t\t\t\t};\r\n\t\t\t\tvar alcada = 0;\r\n\t\t\t\tvar _tenimAlcada = false;\r\n\t\t\t\tif (entity.properties.elevation) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.elevation);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.ELEVATION) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.ELEVATION);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.height) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.height);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.HEIGHT) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.HEIGHT);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.altura) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.altura);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.ALTURA) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.ALTURA);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.z) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.z);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.Z) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.Z);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.volum) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.volum);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.VOLUM) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.VOLUM);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_tenimAlcada = false;\r\n\t\t\t\t}\r\n\t\t\t\tvar entityMatriu = [];\r\n\t\t\t\tvar _matriuAlcada = [];\r\n\t\t\t\tvar _extrudeAlcada;\r\n\t\t\t\tif (msg == 'vector') {\r\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\r\n\t\t\t\t\t\tz = z + 1;\r\n\t\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\r\n\t\t\t\t\t\tif (_tenimAlcada) {\r\n\t\t\t\t\t\t\t_matriuAlcada.push(matriu[z - 1].height);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar cartesianPositions = entity.polygon._hierarchy._value;\r\n\t\t\t\t}\r\n\t\t\t\tvar _newEntity;\r\n\t\t\t\tif (_tenimAlcada) {\r\n\t\t\t\t\tvar terra = 0;\r\n\t\t\t\t\tif (msg == 'vector') {\r\n\t\t\t\t\t\tterra = (Math.max.apply(Math, _matriuAlcada));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t_extrudeAlcada = terra + parseInt(alcada);\r\n\t\t\t\t\t_newEntity = {\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\tpolygon : {\r\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\r\n\t\t\t\t\t\t\toutline : true,\r\n\t\t\t\t\t\t\textrudedHeight : _extrudeAlcada,\r\n\t\t\t\t\t\t\tfill : true,\r\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\r\n\t\t\t\t\t\t\t// outlineWidth : 3.0,\r\n\t\t\t\t\t\t\tperPositionHeight : true\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_newEntity = {\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\tpolygon : {\r\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\r\n\t\t\t\t\t\t\toutline : true,\r\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\r\n\t\t\t\t\t\t\theightReference :Cesium.HeightReference.CLAMP_TO_GROUND\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(_newEntity);\r\n\t\t\t}\r\n\t\t} // final for afegim el DataSource\r\n\t\tdataSource = \"\";\r\n\t\tmap.spin(false);\r\n\t\tmatriu = [];\r\n\t};\r\n\t\r\n\tthis.addEntitiesVisorCesium = function (dataSource, matriu, hfactor, visible, msg) {\r\n\t\t_escriuDebug(\"addEntitiesVisorCesium\",\"instamaps.mapa3D-1.0.0\",1891);\r\n\t\tvar entities = dataSource.entities.values;\r\n\t\tvar z = 0;\r\n\t\tfor (var i = 0; i < entities.length; i++) {\r\n\t\t\tvar entity = entities[i];\r\n\t\t\tentity.show = true;\r\n\t\t\tentity.properties.dataSource = dataSource.id;\r\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\r\n\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\tif (entity.polyline) {\t\t\t\t\t\r\n\t\t\t\tvar entityMatriu = [];\r\n\t\t\t\tfor (var j = 0; j < entity.polyline.positions._value.length; ++j) {\r\n\t\t\t\t\tz = z + 1;\r\n\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\r\n\t\t\t\t}\r\n\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\r\n\t\t\t\tvar colorLin=entity.properties.styles.color;\r\n\t\t\t\tvar wLin=entity.properties.styles.weight;\r\n\t\t\t\tif(!colorLin){colorLin=\"#FFCC00\";}\r\n\t\t\t\tif(!wLin){wLin=2;}\t\t\t\r\n\t\t\t\tvar _newEntity = {\r\n\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\tpolyline : {\r\n\t\t\t\t\t\tpositions : cartesianPositions,\r\n\t\t\t\t\t\toutline : true,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\twidth :wLin,\r\n\t\t\t\t\t\tmaterial : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin))\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(_newEntity);\r\n\t\t\t} else if (entity.billboard) {\r\n\t\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\r\n\t\t\t\tif (entity.properties.styles.icon) {\r\n\t\t\t\t\tvar _alt = parseInt(matriu[i].height + 100)\r\n\t\t\t\t\tvar redEllipse = viewer.entities.add({\r\n\t\t\t\t\t\tposition : ellipsoid.cartographicToCartesian(matriu[i]),\r\n\t\t\t\t\t\theight : matriu[i].height,\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tellipse : {\r\n\t\t\t\t\t\t\tsemiMinorAxis : 0.75,\r\n\t\t\t\t\t\t\tsemiMajorAxis : 0.75,\r\n\t\t\t\t\t\t\tperPositionHeight : false,\r\n\t\t\t\t\t\t\theight : matriu[i].height,\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.WHITE,\r\n\t\t\t\t\t\t\textrudedHeight : parseInt(_alt)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmatriu[i].height = _alt;\r\n\t\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\r\n\t\t\t\t\tvar pinBuilder = new PinBuilder_IM();\r\n\t\t\t\t\tentity.billboard.color = Cesium.Color.WHITE;\r\n\t\t\t\t\tentity.billboard.heightReference=Cesium.HeightReference.NONE ;\r\n\t\t\t\t\tif (entity.properties.styles.icon.options.markerColor) {\r\n\t\t\t\t\t\tvar colorPUNT = entity.properties.styles.icon.options.markerColor; //\r\n\t\t\t\t\t\tif (colorPUNT.indexOf('punt_r') == -1) {\r\n\t\t\t\t\t\t\tentity.billboard.image = pinBuilder.fromColor(Cesium.Color[colorPUNT.toUpperCase()], 48);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tentity.billboard = \"\";\r\n\t\t\t\t\t\t\tentity.point = {\r\n\t\t\t\t\t\t\t\tshow : visible, // default\r\n\t\t\t\t\t\t\t\tcolor : Cesium.Color\r\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.fillColor), // default:\r\n\t\t\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.icon.options.radius) * 1.5), // default:\r\n\t\t\t\t\t\t\t\toutlineColor : Cesium.Color\r\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.color), // default:\r\n\t\t\t\t\t\t\t\toutlineWidth : 2\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (entity.properties.styles.icon.options.iconUrl) {\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar url = entity.properties.styles.icon.options.iconUrl;\r\n\t\t\t\t\t\tentity.billboard.image = url;\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (!entity.properties.styles.icon) {\r\n\t\t\t\t\tvar _color=\"#FFCC00\";\r\n\t\t\t\t\tentity.properties.styles.color?_color=entity.properties.styles.color:_color=_color;\r\n\t\t\t\t\tentity.billboard = \"\";\r\n\t\t\t\t\tentity.point = {\r\n\t\t\t\t\t\tshow : visible, // default\r\n\t\t\t\t\t\tcolor : Cesium.Color\r\n\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.fillColor), // default:\r\n\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.radius) * 1.5), // default:\r\n\t\t\t\t\t\toutlineColor : Cesium.Color\r\n\t\t\t\t\t\t.fromCssColorString(_color), // default:\r\n\t\t\t\t\t\toutlineWidth : 2\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_escriuDebug(\"No hauria entrar aqui\",\"instamaps.mapa3D-1.0.0\",2023);\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(entity); //add billboard\r\n\t\t\t} else if (entity.polygon) {\r\n\t\t\t\tentity.ellipsoid = ellipsoid;\r\n\t\t\t\tentity.polygon.perPositionHeight = new Cesium.ConstantProperty(false);\r\n\t\t\t\tvar borderColor = entity.properties.styles.borderColor ? entity.properties.styles.borderColor : \"\";\r\n\t\t\t\tvar fillOpacity = entity.properties.styles.fillOpacity ? entity.properties.styles.fillOpacity : false;\r\n\t\t\t\tvar fillColor = entity.properties.styles.fillColor ? entity.properties.styles.fillColor : \"\";\r\n\t\t\t\tvar outlineWidth = entity.properties.styles.weight;\r\n\t\t\t\tif (fillColor == \"\") {\r\n\t\t\t\t\tfillColor = entity.properties.styles.color\r\n\t\t\t\t};\r\n\t\t\t\tif (borderColor == \"\" || borderColor == \"#FFC400\") {\r\n\t\t\t\t\tborderColor = entity.properties.styles.color\r\n\t\t\t\t};\r\n\t\t\t\tif (!fillOpacity) {\r\n\t\t\t\t\tfillOpacity = 0.5;\r\n\t\t\t\t};\r\n\t\t\t\tvar alcada = 0;\r\n\t\t\t\tvar _tenimAlcada = false;\r\n\t\t\t\t_escriuDebug(entity.properties,\"instamaps.mapa3D-1.0.0\",2053);\r\n\t\t\t\tif (entity.properties.elevation) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.elevation);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.ELEVATION) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.ELEVATION);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.height) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.height);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.HEIGHT) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.HEIGHT);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.altura) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.altura);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.ALTURA) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.ALTURA);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.z) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.z);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.Z) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.Z);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.volum) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.volum);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.VOLUM) {\r\n\t\t\t\t\talcada = parseInt(entity.properties.VOLUM);\r\n\t\t\t\t\t_tenimAlcada = true;\r\n\t\t\t\t} else if (entity.properties.text) {\r\n\t\t\t\t\tif(entity.properties.text.indexOf('volum#')!=-1){\r\n\t\t\t\t\t\taltT=entity.properties.text.replace('volum#','');\r\n\t\t\t\t\t\talcada = parseInt(altT);\t\r\n\t\t\t\t\t\t_tenimAlcada = true;\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t_tenimAlcada = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_tenimAlcada = false;\r\n\t\t\t\t}\r\n\t\t\t\tvar entityMatriu = [];\r\n\t\t\t\tvar _matriuAlcada = [];\r\n\t\t\t\tvar _extrudeAlcada;\r\n\t\t\t\tif (msg == 'vector') {\r\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\r\n\t\t\t\t\t\tz = z + 1;\r\n\t\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\r\n\t\t\t\t\t\tif (_tenimAlcada) {\r\n\t\t\t\t\t\t\t_matriuAlcada.push(matriu[z - 1].height);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar cartesianPositions = entity.polygon._hierarchy._value;\r\n\t\t\t\t}\r\n\t\t\t\tvar _newEntity;\r\n\t\t\t\tif (_tenimAlcada) {\r\n\t\t\t\t\tvar terra = 0;\r\n\t\t\t\t\tif (msg == 'vector') {\r\n\t\t\t\t\t\tterra = (Math.max.apply(Math, _matriuAlcada));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t_extrudeAlcada = terra + parseInt(alcada);\r\n\t\t\t\t\t_newEntity = {\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\tpolygon : {\r\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\r\n\t\t\t\t\t\t\toutline : true,\r\n\t\t\t\t\t\t\textrudedHeight : _extrudeAlcada,\r\n\t\t\t\t\t\t\tfill : true,\r\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\r\n\t\t\t\t\t\t\tperPositionHeight : true\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t} else {\r\n\t\t\t\t\t_newEntity = {\r\n\t\t\t\t\t\tproperties : entity.properties,\r\n\t\t\t\t\t\tshow : visible,\r\n\t\t\t\t\t\tpolygon : {\r\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\r\n\t\t\t\t\t\t\toutline : true,\r\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\r\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\r\n\t\t\t\t\t\t\theightReference : Cesium.HeightReference.CLAMP_TO_GROUND\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t\tviewer.entities.add(_newEntity);\r\n\t\t\t}\r\n\t\t} // final for afegim el DataSource\r\n\t\tdataSource = \"\";\r\n\t\tmap.spin(false);\r\n\t\tmatriu = [];\r\n\t};\r\n\r\n\tthis.getPosicioCamera3D = function () {\r\n\t\tvar dfd = $.Deferred();\r\n\t\ttry {\r\n\t\t\tvar cameraPos = viewer.camera._position.x + ',' + viewer.camera._position.y + ',' + viewer.camera._position.z + ','\r\n\t\t\t\t+viewer.camera._directionWC.x + ',' + viewer.camera._directionWC.y + ',' + viewer.camera._directionWC.z + ','\r\n\t\t\t\t+viewer.camera._up.x + ',' + viewer.camera._up.y + ',' + viewer.camera._up.z;\r\n\r\n\t\t\tdfd.resolve(cameraPos);\r\n\t\t} catch (Err) {\r\n\t\t\tdfd.reject(Err);\r\n\t\t}\r\n\t\treturn dfd.promise();\r\n\t};\r\n\r\n\tthis.setPosicioCamera3D = function (cameraPos) {\r\n\t\tvar v = cameraPos.split(\",\");\r\n\t\t//_postion\r\n\t\teye = new Cesium.Cartesian3(parseFloat(v[0]), parseFloat(v[1]), parseFloat(v[2]));\r\n\t\ttarget = Cesium.Cartesian3.add(eye, new Cesium.Cartesian3(parseFloat(v[3]), parseFloat(v[4]), parseFloat(v[5])),\r\n\t\t\tnew Cesium.Cartesian3());\r\n\t\tup = new Cesium.Cartesian3(parseFloat(v[6]), parseFloat(v[7]), parseFloat(v[8]));\r\n\t\tviewer.camera.flyTo({\r\n\t\t\tdestination : new Cesium.Cartesian3(parseFloat(v[0]), parseFloat(v[1]), parseFloat(v[2])),\r\n\t\t\torientation : {\r\n\t\t\t\tdirection : new Cesium.Cartesian3(parseFloat(v[3]), parseFloat(v[4]), parseFloat(v[5])),\r\n\t\t\t\tup : new Cesium.Cartesian3(parseFloat(v[6]), parseFloat(v[7]), parseFloat(v[8]))\r\n\t\t\t},\r\n\t\t\tduration : 0\r\n\t\t});\r\n\t};\r\n\r\n\tthis.gestionaTerrainProvaider = function (lat, lng, credit) {\r\n\t\tvar dfd = $.Deferred();\r\n\t\ttry {\r\n\t\t\tif (this._miraCentreDins(lat, lng) && credit != 'icgc') {\r\n\t\t\t\tfactorTerreny = 14\r\n\t\t\t\t\tterreny = new Cesium.CesiumTerrainProvider({\r\n\t\t\t\t\t\turl : _urlTerrenys,\r\n\t\t\t\t\t\tcredit : 'icgc'\r\n\t\t\t\t\t});\r\n\t\t\t\tdfd.resolve(terreny);\r\n\t\t\t} else if (!this._miraCentreDins(lat, lng) && credit != 'cesium') {\r\n\t\t\t\tfactorTerreny = 11;\r\n\t\t\t\tterreny = new Cesium.CesiumTerrainProvider({\r\n\t\t\t\t\turl : 'http://assets.agi.com/stk-terrain/world',\r\n\t\t\t\t\tcredit : 'cesium'\r\n\t\t\t\t});\r\n\t\t\t\tdfd.resolve(terreny);\r\n\t\t\t} else {\r\n\t\t\t\tdfd.resolve(null);\r\n\t\t\t}\r\n\t\t} catch (Err) {\r\n\t\t\tdfd.reject(Err);\r\n\t\t}\r\n\t\treturn dfd.promise();\r\n\t};\r\n\r\n\tthis._ActivaDesactivaCapa = function (bi, visible) {\r\n\t\tfor (var i = 0; i < viewer.dataSources.length; i++) {\r\n\t\t\tviewer.dataSources[i].show = false;\r\n\t\t}\r\n\t};\r\n\r\n\tthis._miraPosicioCamera = function () {\r\n\t\tvar pos = viewer.camera.positionCartographic;\r\n\t\tvar obj = new Object;\r\n\t\tobj.x = parseFloat(pos.longitude * (180.0 / Math.PI));\r\n\t\tobj.y = parseFloat(pos.latitude * (180.0 / Math.PI));\r\n\t\tobj.z = pos.height;\r\n\t\treturn obj;\r\n\t};\r\n\r\n\tthis.calculaPosicioInici = function (bounds, mapZoom) {\r\n\t\tvar dfd = $.Deferred();\r\n\t\ttry {\r\n\t\t\tvar ns = parseFloat(bounds.getNorth() - bounds.getSouth());\r\n\t\t\tvar we = parseFloat(bounds.getEast() - bounds.getWest());\r\n\t\t\tvar ew = parseFloat(bounds.getWest() - bounds.getEast());\r\n\t\t\tvar centerLng = parseFloat(bounds.getEast()) + parseFloat(ew / 2);\r\n\t\t\tvar centerLat = parseFloat(bounds.getNorth()) - parseFloat(ns / 2);\r\n\t\t\tvar inNS = parseFloat(ns / 2);\r\n\t\t\tvar inWE = parseFloat(we / 2);\r\n\t\t\tvar southLat = bounds.getSouth();\r\n\t\t\tvar factor = 1;\r\n\t\t\tvar rectangle2 = Cesium.Rectangle.fromDegrees((bounds.getWest() + inWE),\r\n\t\t\t\t((bounds.getSouth()) - ns), \r\n\t\t\t\t(bounds.getEast() - inWE),\r\n\t\t\t\t((bounds.getNorth()) - ns));\r\n\t\t\tvar matriuAlt = [56623104, 28311552, 14155776, 7077888, 3538944, 1769472, 884736, 442368, 221184, 110592, 55296, 27648, 13824, 6912, 3456, 1728, 864, 432, 216, 108, 54, 27, 13, 5];\r\n\t\t\tvar matriuGrauSud = [16, 16, 16, 13, 10, 7, 4, 2, 1, 0.8, 0.7, 0.2, 0.1, 0.055, 0.03, 0.015, 0.0095, 0.005, 0.002, 0.0015, 0.0005, 0.00035, 0.0002];\r\n\t\t\tvar matriuPitch = [-73, -73, -73, -71, -69, -67, -65, -63, -61, -59, -57, -55, -53, -51, -49, -47, -45, -43, -41, -39, -37, -35, -33];\r\n\t\t\tvar altMetres = matriuAlt[mapZoom];\r\n\t\t\tvar grausSud = matriuGrauSud[mapZoom];\r\n\t\t\tvar _picth = matriuPitch[mapZoom];\r\n\t\t\tvar distMetres = altMetres * Math.sin(37.5);\r\n\t\t\tvar factorLat = Cesium.Math.toDegrees(Math.tan(distMetres / 6370000));\r\n\t\t\tvar newLat = parseFloat(centerLat) - parseFloat(grausSud);\r\n\t\t\tvar positions = [\r\n\t\t\t\tCesium.Cartographic.fromDegrees(centerLng, newLat)\r\n\t\t\t];\r\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, 15, positions);\r\n\t\t\tCesium.when(promise, function (updatedPositions) {\r\n\r\n\t\t\t});\r\n\t\t\tvar rectangle3 = Cesium.Rectangle.fromDegrees(\r\n\t\t\t\t(bounds.getWest()),\r\n\t\t\t\t((bounds.getSouth()) - parseFloat(ns / 2)),\r\n\t\t\t\t(bounds.getEast()),\r\n\t\t\t\t((bounds.getNorth()) - parseFloat(ns / 2)));\r\n\r\n\t\t\tvar rectangle4 = Cesium.Rectangle.fromDegrees(\r\n\t\t\t\t(bounds.getWest()),\r\n\t\t\t\t((bounds.getSouth()) + parseFloat(factorLat)),\r\n\t\t\t\t(bounds.getEast()),\r\n\t\t\t\t((bounds.getNorth()) + parseFloat(factorLat)));\r\n\r\n\t\t\tvar rectangle = Cesium.Rectangle.fromDegrees(\r\n\t\t\t\t(bounds.getWest()),\r\n\t\t\t\t((bounds.getSouth())), \r\n\t\t\t\t(bounds.getEast()),\r\n\t\t\t\t((bounds.getNorth())));\r\n\r\n\t\t\tvar posicioMapa3D = {\r\n\t\t\t\t'rectangle' : rectangle,\r\n\t\t\t\t'rectangle2' : rectangle2,\r\n\t\t\t\t'rectangle3' : rectangle3,\r\n\t\t\t\t'rectangle4' : rectangle4,\r\n\t\t\t\t'centerLng' : centerLng,\r\n\t\t\t\t'centerLat' : centerLat,\r\n\t\t\t\t'altMetres' : altMetres,\r\n\t\t\t\t'newAlt' : positions,\r\n\t\t\t\t'grausSud' : grausSud,\r\n\t\t\t\t'_picth' : _picth,\r\n\t\t\t\t'newLat' : newLat,\r\n\t\t\t\t'southLat' : southLat,\r\n\t\t\t\t'x0' : bounds.getWest(),\r\n\t\t\t\t'y0' : bounds.getSouth(),\r\n\t\t\t\t'x1' : bounds.getEast(),\r\n\t\t\t\t'y1' : bounds.getNorth()\r\n\t\t\t};\r\n\t\t\tdfd.resolve(posicioMapa3D);\r\n\t\t} catch (Err) {\r\n\t\t\tdfd.reject(Err);\r\n\t\t}\r\n\t\treturn dfd.promise();\r\n\t};\r\n\r\n\tthis.retornaPosicio2D = function () {\r\n\t\tvar dfd = $.Deferred();\r\n\t\ttry {\r\n\t\t\tvar windowPosition = new Cesium.Cartesian2(viewer.container.clientWidth / 2, viewer.container.clientHeight / 2);\r\n\t\t\tvar pickPosition = viewer.camera.pickEllipsoid(windowPosition);\r\n\t\t\tvar pickPositionCartographic = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPosition);\r\n\t\t\tvar posUL = new Cesium.Cartesian2(0, 0);\r\n\t\t\tvar posLR = new Cesium.Cartesian2(viewer.container.clientWidth, viewer.container.clientHeight);\r\n\t\t\tvar pickPositionUL = viewer.camera.pickEllipsoid(posUL);\r\n\t\t\tvar pickPositionCartographicUL = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPositionUL);\r\n\t\t\tvar pickPositionLR = viewer.camera.pickEllipsoid(posLR);\r\n\t\t\tvar pickPositionCartographicLR = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPositionLR);\r\n\t\t\tvar bbox = {};\r\n\t\t\tbbox.lng0 = Cesium.Math.toDegrees(pickPositionCartographicUL.longitude);\r\n\t\t\tbbox.lat0 = Cesium.Math.toDegrees(pickPositionCartographicUL.latitude);\r\n\t\t\tbbox.lng1 = Cesium.Math.toDegrees(pickPositionCartographicLR.longitude);\r\n\t\t\tbbox.lat1 = Cesium.Math.toDegrees(pickPositionCartographicLR.latitude);\r\n\t\t\tvar zoomLevel;\r\n\t\t\tvar latDiff = parseFloat(bbox.lat1) - parseFloat(bbox.lat0);\r\n\t\t\tvar lngDiff = parseFloat(bbox.lng1) - parseFloat(bbox.lng1);\r\n\t\t\tvar centerLat = parseFloat(bbox.lat0) + (parseFloat(latDiff / 2));\r\n\t\t\tvar centerLng = parseFloat(bbox.lng0) + (parseFloat(lngDiff / 2));\r\n\t\t\tvar maxDiff = (lngDiff > latDiff) ? lngDiff : latDiff;\r\n\t\t\tif (maxDiff < 256 / Math.pow(2, 20)) {\r\n\t\t\t\tzoomLevel = 21;\r\n\t\t\t} else {\r\n\t\t\t\tzoomLevel = parseInt((-1 * ((Math.log(maxDiff) / Math.log(2)) - (Math.log(360) / Math.log(2)))));\r\n\t\t\t\tif (zoomLevel > 18) {\r\n\t\t\t\t\tzoomLevel = zoomLevel - 2;\r\n\t\t\t\t}\r\n\t\t\t\tif (zoomLevel < 1) {\r\n\t\t\t\t\tzoomLevel = 1;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbbox.centerLat = centerLat;\r\n\t\t\tbbox.centerLng = centerLng;\r\n\t\t\tbbox.zoomLevel = zoomLevel;\r\n\t\t\tdfd.resolve(bbox);\r\n\t\t} catch (Err) {\r\n\t\t\tvar bbox = {};\r\n\t\t\tbbox.lng0 = map.getBounds().getWest();\r\n\t\t\tbbox.lat0 = map.getBounds().getSouth();\r\n\t\t\tbbox.lng1 = map.getBounds().getEast();\r\n\t\t\tbbox.lat1 = map.getBounds().getNorth();\r\n\t\t\tdfd.resolve(bbox);\r\n\t\t}\r\n\t\treturn dfd.promise();\r\n\t};\r\n\r\n\tthis._miraCentreDins = function (y, x) {\r\n\t\tvar x0 = 0.1087; // 0.7525\r\n\t\tvar y0 = 40.4763; // 40.5263\r\n\t\tvar x1 = 3.33669; // 3.3563\r\n\t\tvar y1 = 42.8855; // 42.3748\r\n\t\tif (x >= x0 && x <= x1 && y >= y0 && y <= y1) {\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t};\r\n} // fi objecte\r\n\r\n\r\nfunction mostraMsgNo3D() {\r\n\tjQuery(\"#dialgo_no_webgl\").modal('show');\r\n\t$.publish('analyticsEvent',{event:[ appl, 'noWebGL3D', 'label 3D', 1]});\r\n}\r\n\r\nfunction detectoCapacitatsWebGL() {\r\n\tvar soc3D = true;\r\n\tif (!Modernizr.webgl) {\r\n\t\tsoc3D = false;\r\n\t} else if (!window.WebGLRenderingContext) {\r\n\t\tsoc3D = false;\r\n\t} else {\r\n\t\tvar canvas = document.createElement('canvas');\r\n\t\tvar webglOptions = {\r\n\t\t\talpha : false,\r\n\t\t\tstencil : false,\r\n\t\t\tfailIfMajorPerformanceCaveat : true\r\n\t\t};\r\n\t\tvar gl = canvas.getContext(\"webgl\", webglOptions) || canvas.getContext(\"experimental-webgl\", webglOptions);\r\n\t\tif (!gl) {\r\n\t\t\tsoc3D = false;\r\n\t\t}\r\n\t}\r\n\treturn soc3D;\r\n}\r\n\r\nfunction addHtmlModalNoWebGL() {\r\n\tjQuery('#mapa_modals').append(\r\n\t\t'\t<!-- Modal Old Browser -->' +\r\n\t\t'\t\t<div id=\"dialgo_no_webgl\" class=\"modal\">' +\r\n\t\t'\t\t<div class=\"modal-dialog\">' +\r\n\t\t'\t\t\t<div class=\"modal-content\">' +\r\n\t\t'\t\t\t\t<div class=\"modal-header\">' +\r\n\t\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"' +\r\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>' +\r\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Ups! Ho sentim, no es pot inicialitzar el mapa en 3D.</h4>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t<div class=\"modal-body\">' +\r\n\t\t'\t\t\t\t\t<div lang=\"ca\">Aquest prototip utilitza Cesium JS, una llibreria per a la creació de mapes en 3D - basada amb WebGL - que per funcionar correctament necessita que tingueu la darrera versió del navegador web i que la tarja gràfica del vostre ordinador tingui carregats els drivers més actuals</div>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t<div class=\"modal-footer\">' +\r\n\t\t'\t\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Continuar</button>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t</div>' +\r\n\t\t'\t\t\t<!-- /.modal-content -->' +\r\n\t\t'\t\t</div>' +\r\n\t\t'\t\t<!-- /.modal-dialog -->' +\r\n\t\t'\t</div>' +\r\n\t\t'\t<!-- fi Modal Old Browser -->');\r\n\r\n\tjQuery('#mapa_modals').append(\r\n\t\t'\t<!-- Modal Old Browser -->' +\r\n\t\t'\t\t<div id=\"dialgo_ad_3D\" class=\"modal\">' +\r\n\t\t'\t\t<div class=\"modal-dialog\">' +\r\n\t\t'\t\t\t<div class=\"modal-content\">' +\r\n\t\t'\t\t\t\t<div class=\"modal-header\">' +\r\n\t\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"' +\r\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>' +\r\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\"><span lang=\"ca\">La modalitat 3D està en fase beta.</span> <span style=\"color:#ffa500\" class=\"fa fa-warning sign\"></span> </h4>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t<div class=\"modal-body\">' +\r\n\t\t'\t\t\t\t\t<div class=\"alert-warning\"  style=\"padding:5px\"  lang=\"ca\">' +\r\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">En el mode 3D podeu seguir utilitzant la majoria de les funcionalitat d\\'Instamaps. Amb tot, notareu que algunes es troben de moment deshabilitades.</div><br>' +\r\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">La tecnologia WebGL que s\\'utilitza per la renderització 3D consumeix recursos del vostre maquinari i navegador. En funció del vostre equip obtindreu una millor rendiment. Comproveu que el vostre navegador està actualitzat.</div><br>' +\r\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">Us recomanem que per al treball en 3 dimensions utilitzeu preferiblement <b>Chrome</b>, ja que demostra un més alt rendiment.</div>' +\r\n\t\t'                </div><hr>' +\r\n\t\t'\t\t\t\t\t<div>' +\r\n\t\t'\t\t\t\t\t\t<div style=\"float:left;padding-left: 14px;\"  lang=\"ca\"><img width=\"70\" src=\"/geocatweb/img/nav3d.png\"></div>' +\r\n\t\t'\t\t\t\t\t\t<div style=\" width: 80%;float:right;padding:5px\" class=\"alert-info\">' +\r\n\t\t'\t\t\t\t\t\t<div lang=\"ca\"><span>1-</span><span lang=\"ca\">Arrossegueu per rotar i girar la vista. Consells: També podeu orbitar lliurement prement la tecla CTRL i arrossegant el mapa .Fent doble click podreu inicialitzar la vista</span></div><br>' +\r\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\"><span>2-</span><span lang=\"ca\">Feu clic i arrossegueu per rotar la càmera</span></div>' +\r\n\t\t'\t\t\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t\t<div class=\"modal-footer\">' +\r\n\t\t'\t\t\t\t\t<span style=\"float:left\"><input id=\"chk_ad_3d\" type=\"checkbox\"><span lang=\"ca\">No mostrar més aquest missatge</span></span>  <button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-info\" data-dismiss=\"modal\">Continuar</button>' +\r\n\t\t'\t\t\t\t</div>' +\r\n\t\t'\t\t\t</div>' +\r\n\t\t'\t\t\t<!-- /.modal-content -->' +\r\n\t\t'\t\t</div>' +\r\n\t\t'\t\t<!-- /.modal-dialog -->' +\r\n\t\t'\t</div>' +\r\n\t\t'\t<!-- fi Modal Old Browser -->');\r\n}\r\n\r\naddHtmlModalNoWebGL();\r\n","/**\r\n * require geocat.ajax-1.0.0\r\n * require geocat.web-1.0.0\r\n * require geocat.mapa.edit-data-table\r\n * require url.min\r\n * require leaflet\r\n * require L.IM_Map\r\n * require L.IM_controlFons\r\n * require jQuery.cookie\r\n * require geocat.utils\r\n * require geocat.constants\r\n * require instamaps.visor.geolocal\r\n */\r\n\r\n;(function(global, $){\r\n\r\n\tvar Visor = function(options){\r\n\t\treturn new Visor.init(options);\r\n\t}\r\n\r\n\tvar map_ = new L.IM_Map('map', {\r\n\t  \tzoomAnimation: false,\r\n        typeMap : \"topoMapGeo\",\r\n        minZoom: 2,\r\n        maxZoom : 19,\r\n        zoomControl: true,\r\n        timeDimension: true,\r\n\t    timeDimensionControl: true,\r\n\t    timeDimensionControlOptions:{\r\n\t    \tspeedSlider:false\r\n\t    },\r\n\t    spinerDiv: 'div_loading'\r\n\t}).setView([ 41.431, 1.8580 ], 8);\r\n\r\n\tvar visorOptions = {\r\n\t\taddDefaultZoomControl: true,\r\n\t\tcontrols: {},\r\n\t\tmap: map_\r\n\t};\r\n\r\n\tvar changeInitVisor = function(){\r\n\t\t$('.container').css('width','95%');\r\n\t};\r\n\r\n\tVisor.prototype = {\r\n\t\taddLogoInstamap: function(){\r\n\t\t\tvar self = this;\r\n\t\t\t$.get(\"templates/logoInstamaps.html\",function(data){\r\n\t\t\t\tself.controls.controlLogos.addLogoHtml(data);\r\n\t\t\t});\r\n\r\n\t\t\treturn self;\r\n   \t\t},\r\n\r\n   \t\tremoveLogoInstamap: function(){\r\n\t\t\tvar self = this;\r\n\t\t\tself.controls.controlLogos.removeLogo({\r\n\t\t\t\tclassName: 'logo_instamaps'\r\n\t\t\t});\r\n\r\n\t\t\treturn self;\r\n   \t\t},\r\n\r\n   \t\tresizeMap: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tmap = self.map,\r\n\t\t\toptionsBtn = {},\r\n\t\t\tfactorH = 0,\r\n\t\t\tfactorW = 0,\r\n\t\t\t_window = $( window ),\r\n\t\t\twidthW = _window.width(),\r\n\t\t\theightW = _window.height(),\r\n\t\t\t_mapDiv = $('#map'),\r\n\t\t\tcl = jQuery('.bt_llista span').attr('class');\r\n\t\t\tif(self.embed){//Pel cas visor, embeded\r\n\t\t\t\tfactorH = 0;\r\n\t\t\t}else{\r\n\t\t\t\tfactorH = $('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\r\n\t\t\t}\r\n\t\t\t_mapDiv.css('top', factorH + 'px');\r\n\t\t\t_mapDiv.height(heightW - factorH);\r\n\t\t\t_mapDiv.width(widthW - factorW);\r\n\r\n\t\t\tif(widthW<500 || heightW<=350){\r\n\t\t\t\toptionsBtn = {\r\n\t\t\t\t\topenInstamaps: true,\r\n\t\t\t\t\thome: false,\r\n\t\t\t\t\trouting: false,\r\n\t\t\t\t\tsearch: false,\r\n\t\t\t\t\tlocation: false,\r\n\t\t\t\t\tshare: false,\r\n\t\t\t\t\tlike: false,\r\n\t\t\t\t\tsnapshot: false,\r\n\t\t\t\t\tc3d: false,\r\n\t\t\t\t\tmousePosition: false,\r\n\t\t\t\t\tscale: false,\r\n\t\t\t\t\tfons: false,\r\n\t\t\t\t\tlegend: false,\r\n\t\t\t\t\tlayers: false,\r\n\t\t\t\t\tminimap: false,\r\n\t\t\t\t\twidgets: false\r\n\t\t\t\t};\r\n\t\t\t}else{\r\n\t\t\t\toptionsBtn = {\r\n\t\t\t\t\topenInstamaps: false,\r\n\t\t\t\t\thome: true,\r\n\t\t\t\t\trouting: true,\r\n\t\t\t\t\tsearch: true,\r\n\t\t\t\t\tlocation: true,\r\n\t\t\t\t\tshare: true,\r\n\t\t\t\t\tlike: true,\r\n\t\t\t\t\tsnapshot: true,\r\n\t\t\t\t\tc3d: true,\r\n\t\t\t\t\tmousePosition: true,\r\n\t\t\t\t\tscale: true,\r\n\t\t\t\t\tfons: true,\r\n\t\t\t\t\tlegend: true,\r\n\t\t\t\t\tlayers: true,\r\n\t\t\t\t\tminimap: true,\r\n\t\t\t\t\twidgets: true\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\tself._redrawButtons(optionsBtn);\r\n\t\t\tmap.invalidateSize();\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_redrawButtons: function(options){\r\n\t\t\tvar self = this;\r\n\t\t\tif(options.home && self.controls.homeControl){\r\n\t\t\t\tself.controls.homeControl.showBtn();\r\n\t\t\t}else if(self.controls.homeControl){\r\n\t\t\t\tself.controls.homeControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.openInstamaps && self.controls.openInstamapsControl){\r\n\t\t\t\tself.controls.openInstamapsControl.showBtn();\r\n\t\t\t}else if(self.controls.openInstamapsControl){\r\n\t\t\t\tself.controls.openInstamapsControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.routing && self.controls.routingControl){\r\n\t\t\t\tself.controls.routingControl.showBtn();\r\n\t\t\t}else if(self.controls.routingControl){\r\n\t\t\t\tself.controls.routingControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.location && self.controls.locationControl){\r\n\t\t\t\tself.controls.locationControl.showBtn();\r\n\t\t\t}else if(self.controls.locationControl){\r\n\t\t\t\tself.controls.locationControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.share && self.controls.shareControl){\r\n\t\t\t\tself.controls.shareControl.showBtn();\r\n\t\t\t}else if(self.controls.shareControl){\r\n\t\t\t\tself.controls.shareControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.like && self.controls.likeControl){\r\n\t\t\t\tself.controls.likeControl.showBtn();\r\n\t\t\t}else if(self.controls.likeControl){\r\n\t\t\t\tself.controls.likeControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.search && self.controls.searchControl){\r\n\t\t\t\tself.controls.searchControl.showBtn();\r\n\t\t\t}else if(self.controls.searchControl){\r\n\t\t\t\tself.controls.searchControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.snapshot && self.controls.snapshotControl){\r\n\t\t\t\tself.controls.snapshotControl.showBtn();\r\n\t\t\t}else if(self.controls.snapshotControl){\r\n\t\t\t\tself.controls.snapshotControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.c3d && self.controls.control3d){\r\n\t\t\t\tself.controls.control3d.showBtn();\r\n\t\t\t}else if(self.controls.control3d){\r\n\t\t\t\tself.controls.control3d.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.mousePosition && self.controls.mousePositionControl){\r\n\t\t\t\tself.controls.mousePositionControl.showBtn();\r\n\t\t\t}else if(self.controls.mousePositionControl){\r\n\t\t\t\tself.controls.mousePositionControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.scale && self.controls.scaleControl){\r\n\t\t\t\tself.controls.scaleControl.showBtn();\r\n\t\t\t}else if(self.controls.scaleControl){\r\n\t\t\t\tself.controls.scaleControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.fons && self.controls.fonsControl){\r\n\t\t\t\tself.controls.fonsControl.showBtn();\r\n\t\t\t}else if(self.controls.fonsControl){\r\n\t\t\t\tself.controls.fonsControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.legend && self.controls.llegendaControl){\r\n\t\t\t\tself.controls.llegendaControl.showBtn();\r\n\t\t\t}else if(self.controls.llegendaControl){\r\n\t\t\t\tself.controls.llegendaControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.layers && self.controls.layersControl){\r\n\t\t\t\tself.controls.layersControl.showBtn();\r\n\t\t\t}else if(self.controls.layersControl){\r\n\t\t\t\tself.controls.layersControl.hideBtn();\r\n\t\t\t}\r\n\r\n\t\t\tif(options.minimap && self.controls.minimapControl){\r\n\t\t\t\tself.controls.minimapControl.showBtn();\r\n\t\t\t}else if(self.controls.minimapControl){\r\n\t\t\t\tself.controls.minimapControl.hideBtn();\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\thideControl: function(control){\r\n\t\t\tvar self = this;\r\n\t\t\tif(self.controls[control]){\r\n\t\t\t\tself.controls[control].hideBtn();\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tshowControl: function(control){\r\n\t\t\tvar self = this;\r\n\t\t\tif(self.controls[control]){\r\n\t\t\t\tself.controls[control].showBtn();\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tremoveCapes: function(){\r\n\t\t\tvar self = this;\r\n\t\t\t$('.bt_llista').hide();\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tdrawEmbed: function(){\r\n\t\t\tvar self = this;\r\n\t\t\t$('#navbar-visor').hide();\r\n\t\t\t$('#searchBar').css('top', '0');\r\n\r\n\t\t\t//Per defecte embed té el control de zoom, el botó d'obrir finestra Instamaps i el control de capes.\r\n\t\t\tself.addDefaultZoomControl = 1;\r\n\t\t\tself.openinstamaps = 1;\r\n\t\t\tself.layerscontrol = 1;\r\n\t\t\tself.ltoolbar=1;\r\n\t\t\tself.rtoolbar=1;\r\n\r\n\t\t\tif (!self.mouseposition) self.mouseposition = 0;\r\n\t\t\tif (!self.scalecontrol) self.scalecontrol = 0;\r\n\t\t\tif (!self.minimapcontrol) self.minimapcontrol = 0;\r\n\t\t\tif (!self.fonscontrol) self.fonscontrol = 0;\r\n\r\n\t\t\tif (!self.homecontrol) self.homecontrol = 0;\r\n\t\t\tif (!self.locationcontrol) self.locationcontrol = 0;\r\n\t\t\tif (!self.sharecontrol) self.sharecontrol = 0;\r\n\t\t\tif (!self.searchcontrol) self.searchcontrol = 0;\r\n\t\t\tif (!self.routingcontrol) self.routingcontrol = 0;\r\n\t\t\tif (!self.likecontrol) self.likecontrol = 0;\r\n\r\n\t\t\tif (!self.control3d) self.control3d = 0;\r\n\r\n\t\t\tif (!self.snapshotcontrol) self.snapshotcontrol = 0;\r\n\r\n\t\t\tif (!self.printcontrol) self.printcontrol = 0;\r\n\t\t\tif (!self.geopdfcontrol) self.geopdfcontrol = 0;\r\n\r\n\t\t\tif (!self.llegenda) self.llegenda = 0;\r\n\t\t\tif (!self.colorscalecontrol) self.colorscalecontrol = 0;\r\n\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'embed']});\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddMousePositionControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_position,\r\n\t\t\t_map = self.map;\r\n\t\t\tctr_position = L.control.coordinates({\r\n\t  \t\t\tposition : 'bottomright',\r\n\t  \t\t\t'emptystring':' ',\r\n\t  \t\t\t'numDigits': 2,\r\n\t  \t\t\t'numDigits2': 6,\r\n\t  \t\t\t'prefix': 'ETRS89 UTM 31N',\r\n\t  \t\t\t'prefix2': 'WGS84',\r\n\t  \t\t\t'separator': ' ',\r\n\t  \t\t\t'showETRS89':true\r\n\t  \t\t}).addTo(_map);\r\n\r\n\t\t\tself.controls.mousePositionControl = ctr_position;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddScaleControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_scale,\r\n\t\t\t_map = self.map;\r\n\t\t\tctr_scale = L.control.escala({\r\n\t\t\t\tposition : 'bottomright',\r\n\t\t\t\t'metric':true,\r\n\t\t\t\t'imperial':false\r\n\t\t\t}).addTo(_map);\r\n\r\n\t\t\tself.controls.scaleControl = ctr_scale;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddMinimapControl: function(options){\r\n\t\t\tvar self = this,\r\n\t\t\t_minTopo,\r\n\t\t\tctr_minimap,\r\n\t\t\t_map = self.map,\r\n\t\t\t_options = {\r\n\t\t\t\ttoggleDisplay: true,\r\n\t\t\t\tautoToggleDisplay: false,\r\n\t\t\t\tminimized: true,\r\n\t\t\t\tmapOptions: {trackResize: false}\r\n\t\t\t};\r\n\r\n\t\t\t_options = $.extend(_options, options);\r\n\r\n\t\t\t_minTopo = new L.TileLayer(URL_MQ, {\r\n\t\t\t\tminZoom: 0,\r\n\t\t\t\tmaxZoom: 19,\r\n\t\t\t\tsubdomains:subDomains});\r\n\r\n\t\t\tctr_minimap = L.control.minimapa(_minTopo, _options).addTo(_map)._minimize();\r\n\r\n\t\t\tself.controls.minimapControl = ctr_minimap;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddFonsControl: function(){\r\n\r\n\t\t\tvar self = this,\r\n\t\t\tctr_fons,\r\n\t\t\t_map = self.map;\r\n\t\t\tctr_fons = new L.IM_controlFons({\r\n\t\t\t\ttitle: window.lang.translate('Escollir el mapa de fons'),\r\n\t\t\t}).addTo(_map);\r\n\r\n\t\t\tself.controls.fonsControl = ctr_fons;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddLayersControl: function(button){\r\n\t\t\tvar self = this,\r\n\t\t\tbtn_ctr_layers,\r\n\t\t\t_mapConfig = self._mapConfig,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tbutton = (button !== undefined) ? button : true;\r\n\r\n\t\t\tbtn_ctr_layers = L.control.layersBtn({\r\n\t\t\t\tmapConfig: _mapConfig,\r\n\t\t\t\ttitle: window.lang.translate('Llista de capes'),\r\n\t\t\t\tbutton: button\r\n\t\t\t});\r\n\t\t\tbtn_ctr_layers.addTo(_map);\r\n\r\n\t\t\tself.controls.layersControl = btn_ctr_layers;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddOpenInstamapsControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_linkViewMap,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_linkViewMap = L.control.openInstamaps({\r\n\t\t\t\tbusinessid: self.businessid,\r\n\t\t\t\turlwms: self.urlwms,\r\n\t\t\t\tlayername: self.layername,\r\n\t\t\t\ttitle: window.lang.translate('Veure a InstaMaps'),\r\n\t\t\t\tfn: function(event) {\r\n\t\t\t\t\t$.publish('analyticsEvent',{event:['visor', 'button#veureInstamaps', 'label embed', 1]});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tctr_linkViewMap.addTo(_map);\r\n\r\n\t\t\tself.controls.openInstamapsControl = ctr_linkViewMap;\r\n\t\t},\r\n\r\n\t\taddHomeControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_vistaInicial,\r\n\t\t\t_mapConfig = self.mapConfig,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_vistaInicial = L.control.home({\r\n\t\t\t\tmapConfig: _mapConfig,\r\n\t\t\t\ttitle: window.lang.translate('Vista inicial')\r\n\t\t\t});\r\n\t\t\tctr_vistaInicial.addTo(_map);\r\n\r\n\t\t\tself.controls.homeControl = ctr_vistaInicial;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddLikeControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_like,\r\n\t\t\t_mapConfig = self.mapConfig,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_like = L.control.like({\r\n\t\t\t\tmapConfig: _mapConfig,\r\n\t\t\t\ttitle: window.lang.translate(\"M'agrada\")\r\n\t\t\t});\r\n\t\t\tctr_like.addTo(_map);\r\n\r\n\t\t\tself.controls.likeControl = ctr_like;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddShareControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_shareBT,\r\n\t\t\tv_url = window.location.href,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tif(v_url.indexOf('localhost')!=-1){\r\n\t\t\t\tv_url = v_url.replace('localhost',DOMINI);\r\n\t\t\t}\r\n\t\t\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\r\n\r\n\t\t\tshortUrl(v_url).then(function(results){\r\n\t\t\t\t$('#socialShare_visor').share({\r\n\t\t\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\r\n\t\t\t\t\t//orientation: 'vertical',\r\n\t\t\t\t\t//affix: 'left center',\r\n\t\t\t\t\ttheme: 'square',\r\n\t\t\t\t\turlToShare: results.id\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\t$('.share-square a').attr('target','_blank');\r\n\r\n\t\t\tctr_shareBT = L.control.share({\r\n\t\t\t\ttitle: window.lang.translate('Compartir')\r\n\t\t\t});\r\n\t\t\tctr_shareBT.addTo(_map);\r\n\r\n\t\t\tself.controls.shareControl = ctr_shareBT;\r\n\r\n\t\t},\r\n\r\n\t\taddRoutingControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_routingBT,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_routingBT = L.control.routingControl({\r\n\t\t\t\ttitle: window.lang.translate('Routing'),\r\n\t\t\t\tlang: web_determinaIdioma()\r\n\t\t\t});\r\n\r\n\t\t\tctr_routingBT.addTo(_map);\r\n\r\n\t\t\tself.controls.routingControl = ctr_routingBT;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddLocationControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_gps,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\t//TODO agregar las opciones por defecto al control\r\n\t\t\tctr_gps = L.control.locationControl({\r\n\t\t\t\tautoCenter: true,\t\t//move map when gps location change\r\n\t\t\t\tstyle: {\r\n\t\t\t\t\tradius: 6,\t\t//marker circle style\r\n\t\t\t\t\tweight:3,\r\n\t\t\t\t\tcolor: '#e03',\r\n\t\t\t\t\tfill: true,\r\n\t\t\t\t\tfillColor: '#e03',\r\n\t\t\t\t\topacity: 1,\r\n\t\t\t\t\tfillOpacity: 0.5},\r\n\t\t\t\ttitle: window.lang.translate('Centrar mapa a la seva ubicació'),\r\n\t\t\t\ttextErr: window.lang.translate('Error del GPS'),\t//error message on alert notification\r\n\t\t\t\tcallErr: null\t\t//function that run on gps error activating\r\n\t\t\t});\r\n\r\n\t\t\t_map.addControl(ctr_gps);\r\n\r\n\t\t\tself.controls.locationControl = ctr_gps;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddSearchControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_findBT,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_findBT = L.control.searchControl({\r\n\t\t\t\ttitle: window.lang.translate('Cercar'),\r\n\t\t\t\tsearchUrl: paramUrl.searchAction+\"searchInput={s}\",\r\n\t\t\t\tinputplaceholderText: window.lang.translate('Cercar llocs al món o coordenades  ...')\r\n\t\t\t});\r\n\t\t\t_map.addControl(ctr_findBT);\r\n\t\t\t//TODO generar el control del search\r\n\t\t\t//addControlCercaEdit();\r\n\r\n\t\t\tself.controls.searchControl = ctr_findBT;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddSnapshotControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_snapshot,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_snapshot = L.control.mapExport({\r\n\t\t\t\ttitle: window.lang.translate('Capturar la vista del mapa')\r\n\t\t\t});\r\n\t\t\tctr_snapshot.addTo(_map);\r\n\r\n\t\t\tself.controls.snapshotControl = ctr_snapshot;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\r\n\t\t/*\r\n\t\taddSnapshotControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_snapshot,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_snapshot = L.control.snapshot({\r\n\t\t\t\ttitle: window.lang.translate('Capturar la vista del mapa')\r\n\t\t\t});\r\n\t\t\tctr_snapshot.addTo(_map);\r\n\r\n\t\t\tself.controls.snapshotControl = ctr_snapshot;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddPrintControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_printmap,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_printmap = L.control.printmap({\r\n\t\t\t\ttitle: window.lang.translate('Imprimir la vista del mapa')\r\n\t\t\t});\r\n\t\t\tctr_printmap.addTo(_map);\r\n\r\n\t\t\tself.controls.printControl = ctr_printmap;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddGeopdfControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_geopdf,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_geopdf = L.control.geopdf({\r\n\t\t\t\ttitle: window.lang.translate('Descarrega mapa en format GeoPDF')\r\n\t\t\t});\r\n\t\t\tctr_geopdf.addTo(_map);\r\n\r\n\t\t\tself.controls.geopdfControl = ctr_geopdf;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t*/\r\n\r\n\t\taddAppModul:function(modul){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_arbres,\r\n\t\t\t_map = self.map;\r\n\t\t\tif(modul=='arbres'){\r\n\t\t\t\t$.getScript( \"/moduls/\" + modul + \"/js/modul_\"+modul+\"_1.0.0.js\", function( data, textStatus, jqxhr ) {\r\n\t\t\t\t\tif (jqxhr.status==200){\r\n\t\t\t\t\tctr_arbres=L.control.addmodulArbres(new L.geoJson()).addTo(_map);\r\n\t\t\t\t\tself.controls.arbresControl = ctr_arbres;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\r\n\r\n\t\t},\r\n\r\n\t\taddLlegenda: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_legend,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_legend = L.control.legend({\r\n\t\t\t\ttitle: window.lang.translate('Llegenda'),\r\n\t\t\t\ttipusllegenda: self.tipusllegenda,  //\"dinamica\"\r\n\t\t\t\tllegendaOpt: self.llegendaOpt,\r\n\t\t\t\torigenllegenda:'visor'\r\n\t\t\t});\r\n\r\n\t\t\tctr_legend.addTo(_map);\r\n\r\n\t\t\tself.controls.llegendaControl = ctr_legend;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddControl3d: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_3d,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_3d = L.control.control3d({\r\n\t\t\t\ttitle: window.lang.translate('Canviar vista')\r\n\t\t\t});\r\n\t\t\tctr_3d.addTo(_map);\r\n\r\n\t\t\tself.controls.control3d = ctr_3d;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\taddControlLogos: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_logos,\r\n\t\t\t_map = self.map;\r\n\r\n\t\t\tctr_logos = L.control.logos();\r\n\t\t\tctr_logos.addTo(_map);\r\n\r\n\t\t\tself.controls.controlLogos = ctr_logos;\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tdrawMap: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map;\r\n\t\t\tmap = self.map;\r\n\r\n\t\t\tself._listenEvents();\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tdrawControls: function(){\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tself.addControlLogos();\r\n\r\n\t\t\tif((self.mouseposition && self.mouseposition==\"1\") || self.mouseposition===null){\r\n\t\t\t\tself.addMousePositionControl();\r\n\t\t\t}\r\n\t\t\tif((self.scalecontrol && self.scalecontrol==\"1\") || self.scalecontrol===null){\r\n\t\t\t\tself.addScaleControl();\r\n\t\t\t}\r\n\t\t\tif((self.minimapcontrol && self.minimapcontrol==\"1\") || self.minimapcontrol===null){\r\n\t\t\t\tself.addMinimapControl();\r\n\t\t\t}\r\n\r\n\t\t\tif((self.fonscontrol && self.fonscontrol==\"1\") || self.fonscontrol===null) {\r\n\t\t\t\tself.addFonsControl();\r\n\t\t\t}\r\n\r\n\t\t\tif((self.ltoolbar && self.ltoolbar==\"1\") || (self.ltoolbar===null)){\r\n\t\t\t\tif(self.embed){\r\n\t\t\t\t\tif((self.openinstamaps && self.openinstamaps==\"1\") || (self.openinstamaps===null)){\r\n\t\t\t\t\t\tself.addOpenInstamapsControl();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif((self.homecontrol && self.homecontrol==\"1\") || self.homecontrol===null){\r\n\t\t\t\t\tself.addHomeControl();\r\n\t\t\t\t}\r\n\t\t\t\tif((self.locationcontrol && self.locationcontrol==\"1\") || self.locationcontrol===null){\r\n\t\t\t\t\tself.addLocationControl();\r\n\t\t\t\t}\r\n\t\t\t\tif((self.searchcontrol && self.searchcontrol==\"1\") || self.searchcontrol===null){\r\n\t\t\t\t\tself.addSearchControl();\r\n\t\t\t\t}\r\n\t\t\t\tif((self.routingcontrol && self.routingcontrol==\"1\") || self.routingcontrol===null){\r\n\t\t\t\t\tself.addRoutingControl();\r\n\t\t\t\t}\r\n\t\t\t\tif((self.sharecontrol && self.sharecontrol==\"1\") || self.sharecontrol===null){\r\n\t\t\t\t\tself.addShareControl();\r\n\t\t\t\t}\r\n\t\t\t\tif((self.likecontrol && self.likecontrol==\"1\") || self.likecontrol===null){\r\n\t\t\t\t\tself.addLikeControl();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif((self.rtoolbar && self.rtoolbar==\"1\") || (self.rtoolbar===null)){\r\n\t\t\t\tif((self.layerscontrol && self.layerscontrol==\"1\") || (self.layerscontrol===null)){\r\n\t\t\t\t\tself.addLayersControl();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tself.addLayersControl(false);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif((self.control3d && self.control3d==\"1\") || self.control3d===null) {\r\n\t\t\t\t\tself.addControl3d();\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t\tif((self.snapshotcontrol && self.snapshotcontrol==\"1\") || self.snapshotcontrol===null){\r\n\r\n\r\n\t\t\t\t\tself.addSnapshotControl();\r\n\t\t\t\t}else if((self.printcontrol && self.printcontrol==\"1\") || self.printcontrol===null){\r\n\r\n\r\n\t\t\t\t//\tself.addSnapshotControl();\r\n\t\t\t\t}\r\n\t\t\t\telse if ((self.geopdfcontrol && self.geopdfcontrol==\"1\") || self.geopdfcontrol===null){\r\n\r\n\r\n\t\t\t\t//\tself.addSnapshotControl();\r\n\t\t\t\t}\r\n\r\n\r\n\r\n\t\t\t}else{\r\n\t\t\t\tself.addLayersControl(false);\r\n\t\t\t}\r\n\t\t\tif((self.llegenda && self.llegenda==\"1\") || self.llegenda===null){\r\n\t\t\t\tvar hasLayers = false;\r\n\t\t\t\tif(self._mapConfig.hasOwnProperty(\"legend\"))\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tvar leg = JSON.parse(self._mapConfig.legend);\r\n\t\t\t\t\tvar keys = Object.keys(leg);\r\n\t\t\t\t\tfor(var i=0; i<keys.length; ++i) {\r\n\t\t\t\t\t\tfor  (var j=0;j<leg[keys[i]].length;j++){\r\n\t\t\t\t\t\t\tif (hasLayers || leg[keys[i]][j].chck) {\r\n\t\t\t\t\t\t\t\thasLayers=hasLayers || leg[keys[i]][j].chck;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (!self.nollegenda && hasLayers) {\r\n\t\t\t\t\t\tself.addLlegenda();\r\n\t\t\t\t\t\tif (self.llegendaOpt==false){\r\n\t\t\t\t\t\t\tself.controls.llegendaControl.button.show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(self.appmodul){\r\n\t\t\t\tself.addAppModul(self.appmodul);\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tloadErrorPage: function(){\r\n\t\t\t//TODO redirect a la pagina de error 404\r\n\t\t\t//console.debug(\"error\");\r\n\t\t\twindow.location.href = paramUrl.galeriaPage;\r\n\t\t},\r\n\r\n\t\tloadLoginPage: function(){\r\n\t\t\twindow.location.href = paramUrl.loginPage;\r\n\t\t},\r\n\r\n\t\t//hace el redirect para que el invitado al colaborativo pueda ver que puede editar el mapa\r\n\t\tloadMapaColaboratiuPage: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_businessid = self.businessid;\r\n\t\t\twindow.location = paramUrl.mapaPage+\"?businessid=\"+_businessid+\"&mapacolaboratiu=si\";\r\n\t\t},\r\n\r\n\t\t_loadPasswordModal: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_businessid = self.businessid;\r\n\r\n\t\t\t$('#dialog_password').modal('show');\r\n\r\n\t\t\t$('#dialog_password .btn-primary').on('click',function(){\r\n\t\t\t\tvar clau = $.trim($('#inputPassword').val());\r\n\t\t\t\tif(clau == \"\"){\r\n\t\t\t\t\t$('#password_msg').removeClass('hide');\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$('#password_msg').addClass('hide');\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\tclauVisor: clau,\r\n\t\t\t\t\t\tbusinessId: _businessid\r\n\t\t\t\t\t};\r\n\t\t\t\t\tloadPrivateMapByBusinessId(data).then(function(results){\r\n\t\t\t\t\t\tif(results.status == \"ERROR\"){\r\n\t\t\t\t\t\t\t$('#password_msg').removeClass('hide');\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tself._beforeLoadConfig(results);\r\n\t\t\t\t\t\t\t$('#password_msg').addClass('hide');\r\n\t\t\t\t\t\t\t$('#dialog_password').modal('hide');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_colaboratiuToLogin: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_uid = self.uid;\r\n\t\t\t_businessid=self.businessid;\r\n\t\t\tCookies.remove('uid');\r\n\t\t\tCookies.set('collaboratebid', _businessid);\r\n\t\t\tCookies.set('collaborateuid', _uid);\r\n\t\t\tself.loadLoginPage();\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_beforeLoadConfig: function(results){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_uid = self.uid,\r\n\t\t\t_businessid = self.businessid,\r\n\t\t\t_mapacolaboratiu = self.mapacolaboratiu;\r\n\r\n\t\t\tif ( _mapacolaboratiu  &&  _mapacolaboratiu==\"alta\" && !Cookies.get('uid')) {\r\n\t\t\t\tself._colaboratiuToLogin();\r\n\t\t\t}\r\n\t\t\telse if (_mapacolaboratiu &&  _mapacolaboratiu==\"alta\" && _uid!=Cookies.get('uid')) {\r\n\t\t\t\tself._colaboratiuToLogin();\r\n\t\t\t}\r\n\t\t\telse if (url('?mapacolaboratiu') &&  url('?mapacolaboratiu')==\"alta\" && _uid==Cookies.get('uid')) {\r\n\t\t\t\tself.loadMapaColaboratiuPage();\r\n\t\t\t}\r\n\t\t\tvar _mapConfig;\r\n\t\t\tif (undefined != results.results) _mapConfig= $.parseJSON(results.results);\r\n\t\t\telse _mapConfig=results;\r\n\t\t\tif(_mapConfig.options){\r\n\t\t\t\t_mapConfig.options = $.parseJSON(_mapConfig.options);\r\n\t\t\t\tif(_mapConfig.options.llegenda === false){\r\n\t\t\t\t\tself.nollegenda = \"1\"; //ocultar la llegenda\r\n\t\t\t\t\tself.llegenda = 0;\r\n\t\t\t\t}\r\n\t\t\t\tself.tipusllegenda=_mapConfig.options.tipusllegenda;\r\n\t\t\t\tself.llegendaOpt=_mapConfig.options.llegendaOpt;\r\n\t\t\t}\r\n\t\t\tself._mapConfig = _mapConfig;\r\n\r\n\t\t\tself._configControls();\r\n\r\n\t\t\t_map.fire('loadconfig', _mapConfig);\r\n\t\t\t$.publish('loadConfig', _mapConfig);\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_configControls: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tmapConfigOptions = self._mapConfig.options;\r\n\r\n\t\t\tif(mapConfigOptions.params){\r\n\t\t\t\tvar params = mapConfigOptions.params;\r\n\t\t\t\tif(self.embed && (!$.isEmptyObject(params.iframe))){\r\n\t\t\t\t\tvar piframe = params.iframe;\r\n\t\t\t\t\t$.each(piframe, function(key, value){\r\n\t\t\t\t\t\tif(self[key] == 0 || self[key] == 1){\r\n\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tself[key] = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}else if(!$.isEmptyObject(params.visor)){\r\n\t\t\t\t\tvar pvisor = params.visor;\r\n\t\t\t\t\t$.each(pvisor, function(key, value){\r\n\t\t\t\t\t\tif(self[key] == 0 || self[key] == 1){\r\n\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tself[key] = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tfireLoadConfig: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_mapConfig = self._mapConfig;\r\n\r\n\t\t\t_map.fire('visorconfig', _mapConfig);\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\t_loadCacheMap: function(_businessid,_uid,_mapacolaboratiu){\r\n\t\t\tvar self=this;\r\n\t\t\tif (_uid==null){\r\n\t\t\t\tif (undefined != url('?id')){ \r\n\t\t\t\t\t_uid=url('?id');\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\t_uid = url(-3);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//console.debug(HOST_APP+'capesuser/'+_uid+'/'+_businessid+'.json');\r\n\t\t\t$.get(HOST_APP+'capesuser/'+_uid+'/'+_businessid+'.json', function(results) { \r\n\t\t\t\tif(results){\t\r\n\t\t\t\t\tif (results.clau){\r\n\t\t\t\t\t\t//ocultar las pelotas\r\n\t\t\t\t\t\tself._hideLoading();\r\n\t\t\t\t\t\t//mostar modal con contraseña\r\n\t\t\t\t\t\tself._loadPasswordModal();\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse self._beforeLoadConfig(results);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tvar data = {\r\n\t\t\t\t\t\t\tbusinessId: _businessid,\r\n\t\t\t\t\t\t\tid: _uid,\r\n\t\t\t\t\t\t\tmapacolaboratiu: _mapacolaboratiu,\r\n\t\t\t\t\t\t\tuid: _uid\t\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\tgetCacheMapByBusinessId(data).then(function(results){\r\n\t\t\t\t\t\tif (results.status == \"ERROR\"){\r\n\t\t\t\t\t\t\tself.loadErrorPage();\r\n\t\t\t\t\t\t}else if (results.status == \"PRIVAT\"){\r\n\t\t\t\t\t\t\t//ocultar las pelotas\r\n\t\t\t\t\t\t\tself._hideLoading();\r\n\t\t\t\t\t\t\t//mostar modal con contraseña\r\n\t\t\t\t\t\t\tself._loadPasswordModal();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\r\n\t\t\t\t\t\t\tself._beforeLoadConfig(results);\r\n\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}).fail(function() {\r\n\t\t\t\tvar data = {\r\n\t\t\t\t\t\tbusinessId: _businessid,\r\n\t\t\t\t\t\tid: _uid,\r\n\t\t\t\t\t\tmapacolaboratiu: _mapacolaboratiu,\r\n\t\t\t\t\t\tuid: _uid\t\r\n\t\t\t\t\t};\r\n\t\t\t\tgetCacheMapByBusinessId(data).then(function(results){\r\n\t\t\t\t\tif (results.status == \"ERROR\"){\r\n\t\t\t\t\t\tself.loadErrorPage();\r\n\t\t\t\t\t}else if (results.status == \"PRIVAT\"){\r\n\t\t\t\t\t\t//ocultar las pelotas\r\n\t\t\t\t\t\tself._hideLoading();\r\n\t\t\t\t\t\t//mostar modal con contraseña\r\n\t\t\t\t\t\tself._loadPasswordModal();\r\n\t\t\t\t\t}else{\r\n\t\t\r\n\t\t\t\t\t\tself._beforeLoadConfig(results);\r\n\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\tloadMapConfig: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_uid = self.uid,\r\n\t\t\t_businessid = self.businessid,\r\n\t\t\t_mapacolaboratiu = self.mapacolaboratiu;\r\n\t\t\t\t\t\t\r\n\t\t\tself._loadCacheMap(_businessid,_uid,_mapacolaboratiu);\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\r\n\t\tloadURLConfig: function() {\r\n\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tself.mouseposition = self.mouseposition || false;\r\n\t\t\tself.scalecontrol = self.scalecontrol || false;\r\n\t\t\tself.minimapcontrol = self.minimapcontrol || false;\r\n\t\t\tself.fonscontrol = self.fonscontrol || false;\r\n\t\t\tself.homecontrol = self.homecontrol || false;\r\n\t\t\tself.locationcontrol = self.locationcontrol || false;\r\n\t\t\tself.searchcontrol = self.searchcontrol || false;\r\n\t\t\tself.routingcontrol = self.routingcontrol || false;\r\n\t\t\tself.sharecontrol = self.sharecontrol || false;\r\n\t\t\tself.likecontrol = self.likecontrol || false;\r\n\t\t\tself.layerscontrol = self.layerscontrol || false;\r\n\t\t\tself.control3d = self.control3d || false;\r\n\r\n\t\t\tself.snapshotcontrol = self.snapshotcontrol || false;\r\n\r\n\t\t\tself.printcontrol = self.printcontrol || false;\r\n\t\t\tself.geopdfcontrol = self.geopdfcontrol || false;\r\n\r\n\t\t\tself.rtoolbar = self.rtoolbar || false;\r\n\t\t\tself.llegenda = self.llegenda || false;\r\n\t\t\tself.appmodul = self.appmodul || false;\r\n\t\t\tself.zoomcontrol = self.zoomcontrol || false;\r\n\t\t\tself.fons = self.fons || \"hibridMap\";\r\n\r\n\t\t\tvar hash = location.hash;\r\n\t\t\thashControl = new L.Hash(self.map);\r\n\t\t\tvar parsed = hashControl.parseHash(hash);\r\n\t\t\tself._mapConfig = {\r\n\t\t\t\ttipusAplicacioId : TIPUS_APLIACIO_INSTAMAPS,\r\n\t\t\t\tnomAplicacio : (self.appname ? self.appname : \"\"),\r\n\t\t\t\tentitatUid : \"@\",\r\n\t\t\t\tnomEntitat : \"\",\r\n\t\t\t\tservidorsWMS : [],\r\n\t\t\t\toptions : {\r\n\t\t\t\t\tcenter : (parsed ? parsed.center.lat + \",\" + parsed.center.lng : \"41.431,1.8580\"),\r\n\t\t\t\t\tzoom : (parsed ? parsed.zoom : 8),\r\n\t\t\t\t\tdescription : \"\",\r\n\t\t\t\t\tfons : self.fons\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tif(!self.zoomcontrol){\r\n\t\t\t\tself.map.removeControl(self.map.zoomControl);\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tloadApp: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_mapConfig = self._mapConfig;\r\n\r\n\t\t\tself._loadPublicMap(_mapConfig);\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_mapNameShortener: function(inName) {\r\n\t\t\tname = \"<div id='mapNameContainer'><span title=\\\"\" + inName + \"\\\">\" + inName + \"</span></div>\";\r\n\t\t\treturn name;\r\n\t\t},\r\n\r\n\t\t_loadPublicMap: function(_mapConfig){\r\n\t\t\tvar self = this,\r\n\t\t\t\tnomUser = _mapConfig.entitatUid.split(\"@\"),\r\n\t\t\t\tnomEntitat = _mapConfig.nomEntitat,\r\n\t\t\t\tinfoHtml = '';\r\n\r\n\t\t\tvar nomAp = _mapConfig.nomAplicacio;\r\n\t\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) {\r\n\t\t\t\t$('meta[property=\"og:title\"]').attr('content', \"Mapa \"+nomAp.replaceAll(\"'\",\"\\'\"));\r\n\t\t\t}\r\n\t\t\tif ($(location).attr('href').indexOf('/visor_onsoc.html') != -1) {\r\n\t\t\t\tdocument.title=url('?title');\r\n\t\t\t}\r\n\t\t\tCookies.set('perfil', 'instamaps');\r\n\t\t\tcheckUserLogin();\r\n\r\n\t\t\tinfoHtml += '<p>'+nomUser[0]+'</p>';\r\n\r\n\t\t\tif (_mapConfig.options){\r\n\t\t\t\tvar desc=_mapConfig.options.description;\r\n\r\n\t\t\t\tdesc==\"\"?desc=_mapConfig.nomAplicacio:desc=desc;\r\n\r\n\t\t\t\tif (desc!=undefined)  desc = desc.replaceAll(\"'\",\"\\'\");\r\n\t\t\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) {\r\n\t\t\t\t\t$('meta[name=\"description\"]').attr('content', desc+' - Fet amb InstaMaps.cat');\r\n\t\t\t\t\t$('meta[property=\"og:description\"]').attr('content', desc+' - Fet amb InstaMaps.cat');\r\n\r\n\t\t\t\t\tvar urlThumbnail = GEOCAT02 + paramUrl.urlgetMapImage+ \"&request=getGaleria&update=false&businessid=\" + url('?businessid');\r\n\t\t\t\t\t$('meta[property=\"og:image\"]').attr('content', urlThumbnail);\r\n\t\t\t\t\tvar urlMap = HOST_APP+paramUrl.visorPage+\"?businessid=\"+_mapConfig.businessId;\r\n\t\t\t\t\tvar nomApp=_mapConfig.nomAplicacio;\r\n\t\t\t\t\tif (undefined!=nomApp){\r\n\t\t\t\t\t\tvar nomIndexacio=nomApp;\r\n\t\t\t        \t(nomIndexacio.length > 100)?nomIndexacio=nomIndexacio.substring(0,100):nomIndexacio;\r\n\t\t\t        \tnomIndexacio= encodeURI(nomIndexacio);\r\n\t\t\t\t\t\turlMap += \"&title=\"+nomIndexacio;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar generatedScript=\"<script type=\\\"application/ld+json\\\">\"+\r\n\t\t\t\t\tgenerarScriptMarkupGoogle(urlMap,nomAp,urlThumbnail,_mapConfig.entitatUid,_mapConfig.dataPublicacio,desc)+\r\n\t\t\t\t\t\"</script>\";\r\n\t\t\t\t\t$('head').append(generatedScript);\r\n\t\t\t\t}\r\n\t\t\t\tif (_mapConfig.options.description!=undefined) infoHtml += '<p>'+_mapConfig.options.description+'</p>';\r\n\t\t\t\tif (_mapConfig.options.tags!=undefined) infoHtml += '<p>'+_mapConfig.options.tags+'</p>';\r\n\r\n\t\t\t\t$('.escut').hide();\r\n\t\t\t}\r\n\t\t\t$(\"#mapTitle\").html(self._mapNameShortener(_mapConfig.nomAplicacio) + '<span id=\"infoMap\" lang=\"ca\" class=\"glyphicon glyphicon-info-sign pop\" data-toggle=\"popover\" title=\"Informació\" data-lang-title=\"Informació\" ></span>');\r\n\r\n\t\t\t$('#infoMap').popover({\r\n\t\t\t\tplacement : 'bottom',\r\n\t\t\t\thtml: true,\r\n\t\t\t\tcontent: infoHtml\r\n\t\t\t});\r\n\r\n\t\t\t$('#infoMap').on('show.bs.popover', function () {\r\n\t\t\t\t$(this).attr('data-original-title', window.lang.translate($(this).data('lang-title')));\r\n\t\t\t});\r\n\r\n\t\t\t//TODO quitar la global ya que se usa en el control de capas.\r\n\t\t\tdownloadableData = (_mapConfig.options && _mapConfig.options.downloadable?\r\n\t\t\t\t\t_mapConfig.options.downloadable:[]);\r\n\r\n\t\t\t_mapConfig.newMap = false;\r\n\t\t\t$('#nomAplicacio').html(_mapConfig.nomAplicacio);\r\n\r\n\t\t\tself._loadMapConfig(_mapConfig).then(function(){\r\n\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\t_loadMapConfig: function(_mapConfig){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_layers = self.instamapsLayers,\r\n\t\t\tdfd = $.Deferred();\r\n\r\n\t\t\tif (!$.isEmptyObject( _mapConfig )){\r\n\r\n\t\t\t\t$('#businessId').val(_mapConfig.businessId);\r\n\t\t\t\t//TODO ver los errores de leaflet al cambiar el mapa de fondo\r\n\t\t\t\t//cambiar el mapa de fondo a orto y gris\r\n\t\t\t\tif (_mapConfig.options != null){\r\n\t\t\t\t\tif(_mapConfig.options.hasOwnProperty(\"fons\"))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar fons = _mapConfig.options.fons;\r\n\t\t\t\t\t\tif (fons == 'topoMap'){\r\n\t\t\t\t\t\t\t_map.topoMap();\r\n\t\t\t\t\t\t}else if (fons == 'topoMapGeo') {\r\n\t\t\t\t\t\t\t_map.topoMapGeo();\r\n\t\t\t\t\t\t}else if (fons == 'ortoMap') {\r\n\t\t\t\t\t\t\t_map.ortoMap();\r\n\t\t\t\t\t\t}else if (fons == 'terrainMap') {\r\n\t\t\t\t\t\t\t_map.terrainMap();\r\n\t\t\t\t\t\t}else if (fons == 'topoGrisMap') {\r\n\t\t\t\t\t\t\t_map.topoGrisMap();\r\n\t\t\t\t\t\t}else if (fons == 'historicOrtoMap') {\r\n\t\t\t\t\t\t\t_map.historicOrtoMap();\r\n\t\t\t\t\t\t}else if (fons == 'historicMap') {\r\n\t\t\t\t\t\t\t_map.historicMap();\r\n\t\t\t\t\t\t}else if (fons == 'hibridMap'){\r\n\t\t\t\t\t\t\t_map.hibridMap();\r\n\t\t\t\t\t\t}else if (fons == 'historicOrtoMap46'){\r\n\t\t\t\t\t\t\t_map.historicOrtoMap46();\r\n\t\t\t\t\t\t}else if (fons == 'alcadaMap'){\r\n\t\t\t\t\t\t\t_map.alcadaMap();\r\n\t\t\t\t\t\t}else if (fons == 'colorMap') {\r\n\t\t\t\t\t\t\t_map.colorMap(_mapConfig.options.fonsColor);\r\n\t\t\t\t\t\t}else if (fons == 'naturalMap') {\r\n\t\t\t\t\t\t\t_map.naturalMap();\r\n\t\t\t\t\t\t}else if (fons == 'divadminMap') {\r\n\t\t\t\t\t\t\t_map.divadminMap();\r\n\t\t\t\t\t\t}else if (fons == 'hibridTerrainMap') {\r\n\t\t\t\t\t\t\t_map.hibridTerrainMap();\r\n\t\t\t\t\t\t}else if (fons.indexOf('colorBlankMap')!=-1) {\r\n\t\t\t\t\t\t\t_map.colorBlankMap(fons);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t_map.setActiveMap(_mapConfig.options.fons);\r\n\t\t\t\t\t\t_map.setMapColor(_mapConfig.options.fonsColor);\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//carga las capas en el mapa\r\n\t\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\r\n\t\t\t\t_UsrID = _mapConfig.entitatUid;\r\n\t\t\t\t_layers._loadAllLayers(_mapConfig, controlCapes).then(function(){\r\n\t\t\t\t\tself._updateLayerControl();\r\n\t\t\t\t});\r\n\r\n\t\t\t\tself._hideLoading();\r\n\t\t\t}\r\n\t\t\tdfd.resolve();\r\n\t\t\treturn dfd.promise();\r\n\t\t},\r\n\r\n\t\t_addDownloadLayer: function(){\r\n\t\t\tvar self = this;\r\n\t\t\taddFuncioDownloadLayer('visor');\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_addDataTable: function(){\r\n\t\t\tvar self = this;\r\n\t\t\taddFuncioEditDataTable();\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_drawVisor: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tmap = self.map,\r\n\t\t\t_mapConfig = self._mapConfig;\r\n\r\n\t\t\tif(self.embed){\r\n\t\t\t\tself.drawEmbed();\r\n\t\t\t}\r\n\r\n\t\t\tif(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_INSTAMAPS){\r\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\r\n\r\n\t\t\t\tif(self.embed){\r\n\t\t\t\t\tself.addLogoInstamap();\r\n\t\t\t\t}\r\n\t\t\t\t$(\".leaflet-control-draw-measure\").hide();\t//Eliminem el control de mesura si no és geolocal/AOC\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'visor_instamaps', _mapConfig.entitatUid, 1]});\r\n\t\t\t}else if(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_GEOLOCAL){\r\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()\r\n\t\t\t\t._drawVisorGeolocal()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\r\n\t\t\t\taddDrawTooltips();\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','visor_entitat', _mapConfig.nomEntitat, 1]});\r\n\r\n\t\t\t}else if(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC){\r\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()\r\n\t\t\t\t._drawVisorGeolocal()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\r\n\t\t\t\taddDrawTooltips();\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','visor_entitat', _mapConfig.nomEntitat, 1]});\r\n\r\n\t\t\t}else{\r\n\r\n\t\t\talert(\"No hi ha tipus definit\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_drawVisorGeolocal: function(){\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tvar visorGeolocal = VisorGeolocal({visor:self}).draw();\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_drawVisorSimple: function(){\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tvar visorSimple = VisorSimple({visor:self}).draw();\r\n\r\n\t\t\t$.publish('trackPageview', null);\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_initCenter: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t_map = self.map,\r\n\t\t\t_mapConfig = self._mapConfig;\r\n\r\n\t\t\tvar ineFound = false;\r\n\t\t\tif(self.INE10)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar municipis = ListViewMunicipis.municipis;\r\n\t\t\t\tfor(var i=0; i<municipis.length && !ineFound; ++i)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tineFound = (municipis[i].municipiCodi == self.INE10);\r\n\t\t\t\t\tif(ineFound)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tvar data = municipis[i];\r\n\t\t\t\t\t\tvar bbox = data.bbox.split(\",\");\r\n\t\t\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]),\r\n\t\t\t\t\t\tnorthEast = L.latLng(bbox[3], bbox[2]),\r\n\t\t\t\t\t\tbounds = L.latLngBounds(southWest, northEast);\r\n\t\t\t\t\t\t_map.fitBounds(bounds)\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif(!ineFound)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar hash = location.hash;\r\n\t\t\t\thashControl = new L.Hash(_map);\r\n\t\t\t\tvar parsed = hashControl.parseHash(hash);\r\n\r\n\t\t\t\tif(\"\" == hash && _mapConfig.options){\r\n\t\t\t\t\tif (_mapConfig.options.center){\r\n\t\t\t\t\t\tvar opcenter = _mapConfig.options.center.split(\",\");\r\n\t\t\t\t\t\t_map.setView(L.latLng(opcenter[0], opcenter[1]), _mapConfig.options.zoom);\r\n\t\t\t\t\t}else if (_mapConfig.options.bbox){\r\n\t\t\t\t\t\tvar bbox = _mapConfig.options.bbox.split(\",\");\r\n\t\t\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]);\r\n\t\t\t\t\t    var northEast = L.latLng(bbox[3], bbox[2]);\r\n\t\t\t\t\t    var bounds = L.latLngBounds(southWest, northEast);\r\n\r\n\t\t\t\t\t    _map.fitBounds( bounds );\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if (parsed){\r\n\r\n\t\t\t\t\thashControl.update();\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\tdraw: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t   \t_map = self.map;\r\n\r\n\t\t\tchangeInitVisor();\r\n\r\n\t\t\t$(window).resize(_.debounce(function(){\r\n\t\t\t\tself.resizeMap();\r\n\t\t\t},150));\r\n\r\n\t\t\tif(self.businessid){\r\n\t\t\t\tself.loadMapConfig();\r\n\t\t\t\t_map.on('loadconfig', self._drawVisor, self);\r\n\t\t\t}else{\r\n\t\t\t\tif(self.urlwms){ //cloudifier\r\n\t\t\t\t\tif(self.embed){\r\n\t\t\t\t\t\tself.drawEmbed();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tself.drawMap().resizeMap().drawControls()._drawVisorSimple()._hideLoading();\r\n\t\t\t\t}\r\n\t\t\t\telse if(self.text) {\t//map defined by url params\r\n\t\t\t\t\tself.loadURLConfig()._initCenter()._drawVisor()._addURLMarker();\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tself.loadErrorPage();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!self.embed){\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'no embed']});\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_addURLMarker: function() {\r\n\t\t\tvar self = this;\r\n\t\t\tvar opcenter = self._mapConfig.options.center.split(\",\");\r\n\t\t\tvar defaultPunt = L.AwesomeMarkers.icon(default_onsoc_style);\r\n\t\t\tvar marker = L.marker(new L.LatLng(opcenter[0], opcenter[1]), {icon: defaultPunt,\r\n\t\t\t\t\t tipus: t_marker}).addTo(self.map);\r\n\r\n\t\t\tif(self.text)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar html = '';\r\n\t\t\t\tvar hasValidLink = ((null != self.link) && (\"\" != self.link.trim()) && isValidURL(self.link));\r\n\r\n\t\t\t\tif(hasValidLink)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tvar hasProtocol = (-1 != self.link.indexOf(\"://\"));\r\n\t\t\t\t\tif(!hasProtocol)\r\n\t\t\t\t\t\thtml += \"<a href=\\\"http://\" + self.link + \"\\\" target=\\\"_blank\\\">\";\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\thtml += \"<a href=\\\"\" + self.link + \"\\\" target=\\\"_blank\\\">\";\r\n\r\n\t\t\t\t\thtml += self.text;\r\n\t\t\t\t\thtml += \"</a>\";\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\thtml += parseUrlTextPopUp(self.text, \"\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tmarker.bindPopup(html);\r\n\t\t\t\tmarker.openPopup();\r\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','parametres']});\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$(\"#infoMap\").hide();\r\n\r\n\t\t},\r\n\r\n\t\t_addTooltips: function(){\r\n\t\t\tvar self = this;\r\n\t\t\t$('[data-toggle=\"tooltip\"]').tooltip({container: 'body'});\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_updateLang: function(e, data){\r\n\t\t\tvar self = this;\r\n\t\t\t//TODO esto deberia ir en cada control que es responsable de toda su funcionalidad\r\n\t\t\tjQuery('body').on('show.bs.tooltip','[data-toggle=\"tooltip\"]',function(){\r\n\t\t\t\tjQuery(this).attr('data-original-title', window.lang.translate(jQuery(this).data('lang-title')));\r\n\t\t\t});\r\n\t\t\t//Add tooltip caixa cerca\r\n\t\t\tjQuery(\".leaflet-control-search .search-button, .glyphicon-search\").attr('title',window.lang.translate('Cercar llocs o coordenades ...'));\r\n\t\t\tjQuery(\".leaflet-control-search .search-input\").attr('placeholder',window.lang.translate('Cercar llocs o coordenades ...'));\r\n\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_updateLayerControl: function(e, data){\r\n\t\t\tvar self = this;\r\n\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\r\n\t\t\tif(controlCapes){\r\n\t\t\t\tcontrolCapes.forceUpdate();\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\r\n\t\t_showRoutingEvent: function(){\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#routing', 'label routing', 1]});\r\n\t\t},\r\n\r\n\t\t_mapsnapshotEvent: function(){\r\n\t\t\t//$.publish('analyticsEvent',{event:['visor', 'button#exportmapa', 'label exportmap', 1]});\t\t\r\n\t\t},\r\n\r\n\r\n\t\t/*\r\n\t\t_mapprintEvent: function(){\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', this.tipusUser+'print', 'label print', 1]});\r\n\t\t},\r\n\r\n\t\t_mapgeopdfEvent: function(){\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', this.tipusUser+'geopdf', 'label geopdf', 1]});\r\n\t\t},\r\n\t\t*/\r\n\t\t_map3dmodeEvent: function(){\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#3D', 'label 3D', 1]});\r\n\t\t},\r\n\r\n\t\t_hideLoading: function(){\r\n\t\t\t$('#div_loading').hide();\r\n\t\t\treturn this;\r\n\t\t},\r\n\r\n\t\t_listenEvents: function(){\r\n\t\t\tvar self = this,\r\n\t\t\t\t_map = self.map;\r\n\t\t\tif(_map){\r\n\t\t\t\t_map.on('showRouting', self._showRoutingEvent, self);\r\n\t\t\t\t_map.on('mapsnapshot', self._mapsnapshotEvent, self);\r\n\t\t\t\t_map.on('mapprint', self._mapprintEvent, self);\r\n\t\t\t\t_map.on('mapgeopdf', self._mapgeopdfEvent, self);\r\n\t\t\t\t_map.on('map3dmode', self._map3dmodeEvent, self);\r\n\t\t\t\t_map.on('zoomend',self._gestionaEtiquetes, self);\r\n\t\t\t}\r\n\t\t\t$.subscribe('change-lang',self._updateLang);\r\n\t\t},\r\n\t\t_gestionaEtiquetes: function(){\r\n\t\t\tvar self=this;\r\n\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\r\n\t\t\tjQuery.each(controlCapes._layers, function(i, obj){\r\n\t\t\t\t if (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\r\n\t\t\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\r\n\t\t\t\t\t \t\tvar zoomInicial = \"2\";\r\n\t\t\t\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\r\n\t\t\t\t\t \t\tvar zoomFinal = \"19\";\r\n\t\t\t\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\r\n\r\n\t\t\t\t\t \t\tif ( map.getZoom()>=zoomInicial &&  map.getZoom() <= zoomFinal) {//mostrem labels\r\n\t\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\r\n\t\t\t\t\t\t\t\t\tif (lay.label!=undefined) {\r\n\t\t\t\t\t\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(1);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tif(lay._showLabel){\r\n\t\t\t\t\t                        lay._showLabel({latlng: lay.label._latlng});\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t \t\t }\r\n\t\t\t\t\t \t\t else {//amaguem labels\r\n\t\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\r\n\t\t\t\t\t\t\t\t\tif(lay.label){\r\n\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(0);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t }\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t};\r\n\r\n\tVisor.init = function(options){\r\n\t\tvar self = this;\r\n\t\tself = $.extend(self, visorOptions, options);\r\n\t\tself.instamapsLayers = InstamapsLayers(visorOptions);\r\n\t}\r\n\r\n\tVisor.init.prototype = Visor.prototype;\r\n\r\n\tglobal.Visor = Visor;\r\n\r\n}(window, jQuery));\r\n","/**\r\n * require geocat.web-1.0.0\r\n * require url https://github.com/websanova/js-url\r\n * require geocat.google-analytics.js\r\n * requier geocat.utils\r\n */\r\nvar visorOptions = {\r\n\tuid: url('?uid') || null,\r\n\turlwms: url('?urlwms') || null,\r\n\tlayername: url('?layername') || null,\r\n\ttype: url('?type') || null,\r\n\turl: url('?url') || null,\r\n\tq: url('?q') || null,\r\n\tbusinessid: url('?businessid') || null,\r\n\tmapacolaboratiu: url('?mapacolaboratiu') || null,\r\n\tembed: url('?embed') || null,\r\n\tllegenda: url('?llegenda') || null,\r\n\tmouseposition: url('?mouseposition') || null,\r\n\tlayerscontrol: url('?layerscontrol') || null,\r\n\tprintcontrol: url('?printcontrol') || null,\r\n\tminimapcontrol: url('?minimapcontrol') || null,\r\n\tsnapshotcontrol: url('?snapshotcontrol') || null,\r\n\tgeopdfcontrol: url('?geopdfcontrol') || null,\r\n\twidgetscontrol: url('?widgetscontrol') || null,\r\n\tfonscontrol: url('?fonscontrol') || null,\r\n\tsharecontrol: url('?sharecontrol') || null,\r\n\tlikecontrol: url('?likecontrol') || null,\r\n\tsearchcontrol: url('?searchcontrol') || null,\r\n\troutingcontrol: url('?routingcontrol') || null,\r\n\topeninstamaps: url('?openinstamaps') || null,\r\n\tscalecontrol: url('?scalecontrol') || null,\r\n\tcontrol3d: url('?control3d') || null,\r\n\tview3d: url('?3d') || null,\r\n\thomecontrol: url('?homecontrol') || null,\r\n\tlocationcontrol: url('?locationcontrol') || null,\r\n\tzoomcontrol: url('?zoomcontrol') || null,\r\n\tstaticmap: url('?staticmap') || null,\r\n\tnavbar: url('?navbar') || null,\r\n\trtoolbar: url('?rtoolbar') || null,\r\n\tltoolbar: url('?ltoolbar') || null,\r\n\tappmodul: url('?appmodul') || null,\r\n\tlat : url(\"?lat\") || null,\r\n\tlon : url(\"?lon\") || null,\r\n\tzoom : url(\"?zoom\") || null,\r\n\ttext: url(\"?text\") || null,\r\n\tlink: url(\"?link\") || null,\r\n\tappname: url(\"?appname\") || null,\r\n\tfons: url(\"?fons\") || null,\r\n\tINE10: url(\"?INE10\") || null, \r\n\trandom: url(\"?random\") || null\r\n};\r\n\r\nvar visor; \r\n\r\njQuery(document).ready(function() {\r\n\t//TODO ver si esto es mejor ponerlo cuando ya esté cargado todo el visor para cojer bien el titulo, etc.\r\n\t//$.publish('trackPageview', null);\r\n\t\r\n\tvar tipus_user = defineTipusUser();  //geocat.web-1.0.0\r\n\t\r\n\tvisorOptions.tipusUser = tipus_user;\r\n\t\r\n\tif (visorOptions.businessid==null){\r\n\t\tvar busid = url(-2);\r\n\t\tvisorOptions.businessid=busid;\r\n\t}\r\n\tvisor = Visor(visorOptions).draw();\r\n\t\r\n}); // Final document ready\r\n\r\n","/**\r\n * require: jquery\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar SelectMunicipis = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \treturn this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tvar that = this;\r\n        \t$.get(\"/geocatweb/dades/municipis4326.json\",function(data){\r\n        \t\tthat.municipis = data;\r\n        \t});\r\n        },\r\n \r\n        createSelect: function(){\r\n        \tvar that = this;\r\n        \tvar selMuni = $('<select/>')\r\n        \t.addClass('selectMunicipis')\r\n        \t.prop('title', \"Escull un municipi\")\r\n        \t.on('change',function(){\r\n        \t\t$.publish('changeSelectMunicipis',$(this).find(\":selected\").data('item'));\r\n        \t});\r\n        \t$.each(that.municipis, function() {\r\n        \t\tvar item = this;\r\n        \t\tvar option = $('<option/>')\r\n        \t\t.prop('value',item.municipiCodi)\r\n        \t\t.data('item', item)\r\n        \t\t.html(item.municipi);\r\n        \t\tselMuni.append(option);\r\n        \t});\r\n        \treturn selMuni;\r\n        },\r\n        \r\n        getViewMunicipis: function(bbox){\r\n        \t\r\n        },\r\n                      \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \t\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return SelectMunicipis.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.SelectMunicipis = SelectMunicipis.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, leafletjs\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar ListViewMunicipis = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.filtered = [];\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \treturn this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tvar that = this;\r\n        \t$.get(\"/geocatweb/dades/municipis4326.json\",function(data){\r\n        \t\tthat.municipis = data;\r\n        \t});\r\n        },\r\n \r\n        createList: function(container){\r\n        \tvar that = this;\r\n        \tthat.container = container;\r\n        \t$('<div/>').prop('lang','ca').addClass('listlabel').html('Municipis en vista').appendTo(container);\r\n        \tthat.label = that.container.find('.listlabel');\r\n        \tvar listMuni = $('<ul/>')\r\n        \t.addClass('listMunicipis')\r\n        \t.on('click','li',function(){\r\n        \t\t$.publish('changeSelectMunicipis',$(this).data('item'));\r\n        \t});\r\n        \tlistMuni.appendTo(container);\r\n        \tthat.listMuni = listMuni;\r\n        \tthat.drawList();\r\n        },\r\n        \r\n        drawList: function(){\r\n        \tvar that = this;\r\n        \tif(that.label){\r\n        \t\tthat.label.show();\r\n        \t}\r\n        \tif(that.listMuni){\r\n        \t\t$.each(that.filtered, function() {\r\n            \t\tvar item = this;\r\n            \t\tvar option = $('<li/>')\r\n            \t\t.data('item', item)\r\n            \t\t.html(item.municipi);\r\n            \t\tthat.listMuni.append(option);\r\n            \t});\r\n        \t}\r\n        },\r\n        \r\n        cleanList: function(){\r\n        \tvar that = this;\r\n        \tif(that.label){\r\n        \t\tthat.label.hide();\r\n        \t}\r\n        \tif(that.listMuni){\r\n        \t\tthat.listMuni.empty();\r\n        \t}\r\n        \tthat.filtered = [];\r\n        },\r\n                \r\n        getViewMunicipis: function(bbox){\r\n        \tvar that = this;\r\n        \tvar arrayLength = that.municipis.length;\r\n        \tvar municipi, mbbox;\r\n        \tthat.cleanList();\r\n        \tfor(var i = 0; i < arrayLength; i++){\r\n        \t\tmunicipi = that.municipis[i];\r\n        \t\tmbbox = municipi.bbox.split(\",\");\r\n        \t\tmbbox = L.latLngBounds([[parseFloat(mbbox[1]),parseFloat(mbbox[0])],[parseFloat(mbbox[3]),parseFloat(mbbox[2])]]);\r\n        \t\tif(bbox.intersects(mbbox)){\r\n        \t\t\tthat.filtered.push(municipi);\r\n        \t\t}\r\n        \t}\r\n        \tthat.drawList();\r\n        },\r\n                      \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('mapMoveend',function(e, data){\r\n        \t\tvar map = data;\r\n        \t\tif (map.getZoom() >= 13){\r\n        \t\t\tthat.getViewMunicipis(map.getBounds());\r\n        \t\t}else{\r\n        \t\t\tthat.cleanList();\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return ListViewMunicipis.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.ListViewMunicipis = ListViewMunicipis.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetMeteo = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.url = \"http://www.aemet.es/ca/eltiempo/prediccion/municipios/mostrarwidget/widget_prov_id_municipi?w=g3p11111110ohmffffffw350z252x333333t999999r1s1n1\";\r\n        \tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tvar that = this;\r\n        \tthat.container = $(that.containerId);\r\n        \t$.get(\"/geocatweb/dades/municipisAemet.json\",function(data){\r\n        \t\tthat.municipis = data;\r\n        \t});\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n        \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-meteo')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Meteo']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \tthis.iframe = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        getMunicipi: function(codigo){\r\n        \tvar that = this;\r\n        \tvar codiMeteo;\r\n        \tif (codigo != null){\r\n        \t\tif (codigo.length > 5){\r\n        \t\t\tcodigo = codigo.substring(0,5);\r\n        \t\t}\r\n        \t\tvar arrayLength = that.municipis.length;\r\n        \t\tfor (var i = 0; i < arrayLength; i++) {\r\n        \t\t\tif (that.municipis[i].indexOf(codigo) != -1){\r\n        \t\t\t\tcodiMeteo = that.municipis[i];\r\n        \t\t\t\tbreak;\r\n        \t\t\t}\r\n        \t\t}\r\n        \t}\r\n        \treturn codiMeteo;\r\n        },\r\n        \r\n        draw: function(data){\r\n        \tvar that = this;\r\n        \tif(that.active   && data.tipusMunicipi){\r\n        \t\tvar codi = that.getMunicipi(data.municipiCodi);\r\n        \t\tif (codi){\r\n            \t\tvar url = that.url.replace(\"widget_prov_id_municipi\", codi);\r\n            \t\tif (that.iframe){\r\n            \t\t\t$(that.containerId).find('iframe').prop('src',url);\r\n                \t}else{\r\n                \t\t$('<iframe/>').prop('src',url)\r\n                \t\t.attr('seamless','seamless').attr('scrolling','no')\r\n                \t\t.appendTo($(that.containerId));\r\n                \t\tthat.iframe = true;\r\n                \t}\r\n            \t}else{\r\n            \t\t$(that.containerId).empty();\r\n            \t}\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetMeteo.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetMeteo = WidgetMeteo.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetIdescat = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.url = \"http://api.idescat.cat/emex.ifr?bc=333333&lc=0000cc&c=000000&t=0&e=f&enc=utf-8&tc=ffffff&id=widget_id_municipi&i=f261,f321,f187,f188,f184,f91,f242,f122,f133,f134,f141,f144,f215,f219,f19&lang=cat\";\r\n\t\t\tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tthis.container = $(this.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n                \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-idescat')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Idescat']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \tthis.iframe = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        draw: function(data){\r\n        \tvar that = this;\r\n        \tif(that.active   && data.tipusMunicipi){\r\n        \t\tvar codi = data.municipiCodi;\r\n        \t\tif (codi){\r\n            \t\tvar url = that.url.replace(\"widget_id_municipi\", codi);\r\n            \t\tif (that.iframe){\r\n            \t\t\t$(that.containerId).find('iframe').prop('src',url);\r\n                \t}else{\r\n                \t\t$('<iframe/>').prop('src',url)\r\n                \t\t.attr('seamless','seamless').attr('scrolling','no')\r\n                \t\t.appendTo($(that.containerId));\r\n                \t\tthat.iframe = true;\r\n                \t}\r\n            \t}else{\r\n            \t\t$(that.containerId).empty();\r\n            \t}\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetIdescat.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetIdescat = WidgetIdescat.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetCartoteca = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.url = \"http://cartotecadigital.icc.cat/cdm/search/searchterm/widget_id_llistamunis/mode/all/conn/and/cosuppress/\";\r\n        \tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tthis.container = $(this.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n                \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-cartoteca')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Cartoteca']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        draw: function(data){\r\n        \tvar that = this;\r\n        \tif(that.active){\r\n        \t\t$(that.containerId).empty();\r\n        \t\tvar llistamunis = encodeURIComponent(data.municipi);\r\n        \t\tvar url = that.url.replace(\"widget_id_llistamunis\", llistamunis);\r\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \r\n    \t\t\tthis.windowObjectReference.focus();\r\n    \t\t\t\r\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\r\n    \t\t\t$('<div></div>').addClass('list').append(\r\n\t    \t\t\t$('<a></a>', {\r\n\t\t\t\t\t\t'href' : url,\r\n\t\t\t\t\t\t'target' : '_blank'\r\n\t\t\t\t\t}).html(data.municipi + \" a la cartoteca digital\")).append(\r\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\r\n            \t\t\t\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetCartoteca.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetCartoteca = WidgetCartoteca.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetRPUC = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.url = \"http://ptop.gencat.cat/rpucportal/AppJava/cercaExpedient.do?reqCode=cerca&municipiSel=widget_id_municipi\";;\r\n        \tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tthis.container = $(this.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n                \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-rpuc')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Rpuc']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        draw: function(data){\t\r\n\t\t\r\n\t\r\n        \tvar that = this;\r\n        \tif(that.active  && data.tipusMunicipi){\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\t\r\n        \t\t$(that.containerId).empty();\r\n        \t\tvar codi = data.municipiCodi.substring(0,5);\r\n        \t\tvar url = that.url.replace(\"widget_id_municipi\", codi);\r\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \r\n    \t\t\tthis.windowObjectReference.focus();\r\n    \t\t\t\r\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\r\n    \t\t\t$('<div></div>').addClass('list').append(\r\n\t    \t\t\t$('<a></a>', {\r\n\t\t\t\t\t\t'href' : url,\r\n\t\t\t\t\t\t'target' : '_blank'\r\n\t\t\t\t\t}).html(data.municipi + \" al registre de planejament urbanístic de Catalunya\")).append(\r\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetRPUC.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetRPUC = WidgetRPUC.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetCadastre = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.rutaUrbanaCadastre = \"http://www.catastro.minhap.es/INSPIRE/CadastralParcels/_provincia_/_codi_-_nom_/A.ES.SDGC.CP.U._codi_.zip\";\r\n\t\t\tthis.rutaRuralCadastre = \"http://www.catastro.minhap.es/INSPIRE/CadastralParcels/_provincia_/_codi_-_nom_/A.ES.SDGC.CP.R._codi_.zip\";\r\n\t\t\tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.m_SGDC = \"Els arxius es descarregaran en el format GML 3.2. Si tens problemes per visualitzar-los consulta la <a href='http://www.geoportal.cat/geoportal/cat/documentacio/manuals/index.jsp' target='_blank' class='alert-link'>Guia IDEC de visualització GML</a> <br><br><i>Font dades:<a href='http://www.catastro.minhap.es/INSPIRE/CadastralParcels/ES.SDGC.CP.Atom.xml' target='_blank' class='alert-link'>Servei INSPIRE-ATOM SDGC</a></i>\";\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tvar that = this;\r\n        \tthat.container = $(that.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n        \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-cadastre')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Cadastre']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        draw: function(data){\r\n        \tvar that = this;\r\n        \tif(that.active   && data.tipusMunicipi){\r\n        \t\t$(that.containerId).empty();\r\n        \t\tvar codi = data.codiCadastre;\r\n        \t\tvar urlUrbana = that.rutaUrbanaCadastre.replace('_nom_',data.municipiCadastre);\r\n        \t\turlUrbana = urlUrbana.replace('_provincia_',data.provinciaCodi);\r\n        \t\turlUrbana = urlUrbana.replace(/_codi_/g,data.codiCadastre);\r\n        \t\t\r\n        \t\tvar urlRural = that.rutaRuralCadastre.replace('_nom_',data.municipiCadastre);\r\n        \t\turlRural = urlRural.replace('_provincia_',data.provinciaCodi);\r\n        \t\turlRural = urlRural.replace(/_codi_/g,data.codiCadastre);\r\n        \t\t\r\n        \t\tif (codi){\r\n        \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\r\n        \t\t\t$('<div></div>').addClass('list').append(\r\n        \t\t\t$('<a></a>', {\r\n    \t\t\t\t\t'href' : urlUrbana,\r\n    \t\t\t\t\t'class' : 'zip',\r\n    \t\t\t\t\t'target' : '_blank'\r\n    \t\t\t\t}).html(data.municipiCadastre + \" urbana.zip\")).append(\r\n    \t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-compressed'})).appendTo($(that.containerId));\r\n        \t\t\t\r\n        \t\t\t$('<div></div>').addClass('list').append($('<a></a>', {\r\n    \t\t\t\t\t'href' : urlRural,\r\n    \t\t\t\t\t'class' : 'zip',\r\n    \t\t\t\t\t'target' : '_blank'\r\n    \t\t\t\t}).html(data.municipiCadastre + \" rústega.zip\")).append(\r\n        \t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-compressed'})).appendTo($(that.containerId));\r\n        \t\t\t\r\n        \t\t\t$('<p></p>').appendTo($(that.containerId));\r\n        \t\t\t$('<div></div>').addClass('alert alert-info').html(that.m_SGDC).appendTo($(that.containerId));\r\n        \t\t}else{\r\n            \t\t$(that.containerId).empty();\r\n            \t}\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetCadastre.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetCadastre = WidgetCadastre.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetInfoparcela = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\tthis.url = \"http://www.geolocal.cat/geoLocal/infoParcela/?bbox=widget_bbox_municipi&title=widget_nom_municipi\";;\r\n\t\t\tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \tthis.bindEvents();\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tthis.container = $(this.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n                \r\n        drawButton: function(container){\r\n        \tvar that = this;\r\n        \t$('<div/>').addClass('widget-button').addClass('widget-infoparcela')\r\n        \t.on('click',function(){\r\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_InfoParcela']});\r\n        \t})\r\n        \t.appendTo(container);\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        \r\n        draw: function(data){\t\r\n        \tvar that = this;\r\n        \t\r\n        \tif(that.active && data.tipusMunicipi){\r\n        \t\t$(that.containerId).empty();\r\n        \t\t//var codi = data.municipiCodi.substring(0,5);\r\n        \t\tvar url = that.url.replace(\"widget_nom_municipi\", data.municipi);\r\n        \t\turl = url.replace(\"widget_bbox_municipi\", data.bbox);\r\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \r\n    \t\t\tthis.windowObjectReference.focus();\r\n    \t\t\t\r\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\r\n    \t\t\t$('<div></div>').addClass('list').append(\r\n\t    \t\t\t$('<a></a>', {\r\n\t\t\t\t\t\t'href' : url,\r\n\t\t\t\t\t\t'target' : '_blank'\r\n\t\t\t\t\t}).html(data.municipi + \" a InfoParcel·la\")).append(\r\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\r\n        \t}\r\n        },\r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n        \t\tif(data){\r\n        \t\t\tthat.draw(data);\r\n        \t\t}\r\n        \t});\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetInfoparcela.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetInfoparcela = WidgetInfoparcela.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * require: jquery, bootstrap\r\n */\r\n(function ( $, window, document, undefined ) {\r\n\t\"use strict\";\r\n\tvar WidgetMascara = {\r\n\t\t\t\t\t\r\n\t\tinit: function() {\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tthis.url = \"/geotimeservices/aoc?\";\r\n\t\t\tthis.layerFiltreCom='filtre_comarca';\r\n\t\t\tthis.layerFiltreMuni='filtre_municipi'\r\n\t\t\tthis.layerWMS=null;\r\n\t\t\tthis.itemActive=null;\r\n\t\t\tthis.containerId = '.drawWidgets';\r\n\t\t\tthis.cache();\r\n        \tthis.subscriptions();\r\n        \t//this.bindEvents();\t\t\t\r\n        \tthis.uiLoaded = false;                    \t\r\n            return this;\r\n        },\r\n        \r\n        cache: function(){\r\n        \tthis.container = $(this.containerId);\r\n        },\r\n        \r\n        getWidget: function(){\r\n        \treturn this;\r\n        },\r\n                \r\n        drawButton: function(container){\r\n\t\t\t\r\n\t\t\tvar selMask = $('<input/>')\r\n        \t.addClass('chk_mascara')\r\n        \t.prop('type', \"checkbox\")\r\n\t\t\t\r\n\t\t\t.prop('id', \"id_chk_mascara\")\r\n        \t.on('click',function(){\r\n        \t\t$.publish('changeMask',$(this).prop('checked'));\r\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Mascara']});\r\n        \t});\r\n\t\t\t\r\n\t\t\tvar selMaskdiv = $('<div/>').addClass('checkbox');\r\n\t\t\tselMask.appendTo(selMaskdiv);\r\n\t\t\t\r\n\t\t\tvar selLabelMask=$('<label />')\r\n\t\t\t.prop('for', \"id_chk_mascara\")\r\n\t\t\t.text( \"Aplicar màscara\");\r\n\t\t\tselLabelMask.appendTo(selMaskdiv);\r\n\t\t\tcontainer.append( selMaskdiv);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tthis.bindEvents();\t\r\n\t\t\t\r\n        },\r\n        \r\n        activate: function(){\r\n        \tthis.active = true;\r\n        },\r\n        \r\n        deactivate: function(){\r\n        \tthis.active = false;\r\n        \t$(this.containerId).empty();\r\n        },\r\n        getActiveItem:function(){\r\n\t\t\r\n\t\t\treturn this.itemActive;\r\n\t\t\r\n\t\t},\t\r\n\t\t\r\n\t\tsetActiveItem:function(data){\r\n\t\t\t this.itemActive=data;\r\n\t\t\t\r\n\t\t},\t\r\n\t\tdraw:function(data,input){\r\n\t\t\t\r\n\t\t\tvar that = this;\r\n\t\t\t\t\r\n\t\t\tif(this.layerWMS !=null && map.hasLayer(this.layerWMS)){map.removeLayer(this.layerWMS);}\t\r\n\t\t\t\r\n\t\t\tif(input){\r\n\r\n\t\t\tvar layerFiltre=that.layerFiltreMuni;\r\n\r\n\t\t\t\tthis.itemActive.tipusMunicipi?layerFiltre=that.layerFiltreMuni:layerFiltre=that.layerFiltreCom;\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.layerWMS= L.tileLayer.betterWms(that.url, {\r\n\t\t\t\t\tlayers : layerFiltre,\r\n\t\t\t\t\t//crs : '3857',\r\n\t\t\t\t\t\r\n\t\t\t\t\ttransparent : true,\r\n\t\t\t\t\tCODIENS : this.itemActive.municipiMunicat,\r\n\t\t\t\t\texceptions:'application/vnd.ogc.se_blank',\r\n\t\t\t\t\t//exceptions:checkExceptionsType(wms.url),\r\n\t\t\t\t\tformat : 'image/png',\r\n\t\t\t\t\twmstime:false,\r\n\t\t\t\t\ttileSize:512\r\n\t\t\t\t}).addTo(map).bringToFront();\r\n\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\r\n\t\t},\r\n\t\t\r\n        \r\n                \r\n        /**********Events**************/\r\n        bindEvents: function(){\r\n\t\t\tvar _that =this;\r\n\t\t\tmap.on('layeradd',function(e){\r\n\t\t\t\t\r\n\t\t\t\tif(_that.layerWMS !=null && map.hasLayer(_that.layerWMS)){_that.layerWMS.bringToFront()}\t\r\n\t\t\t\t\r\n\t\t\t});\t\r\n\t\t\t\r\n\t\t\t\r\n        },\r\n        \r\n        subscriptions: function() {\r\n        \tvar _that = this;\r\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\r\n\t\t\t\t\r\n\t\t\t\t_that.setActiveItem(data);\r\n\t\t\t\t\r\n        \t\tif(data && $('#id_chk_mascara').prop('checked')){\r\n     \r\n\t\t\t\t_that.draw(data, true);\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n        \t\t}\r\n        \t});\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t$.subscribe('changeMask',function(e, input){\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\tvar data=_that.getActiveItem();\r\n\t\t\t\t\t\t\t\t\r\n        \t\tif(input && data ){\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t_that.draw(data, true);\t\r\n\r\n        \t\t}else{\r\n\t\t\t\t\r\n\t\t\t\t_that.draw(null, false);\t\r\n\t\t\t\t\r\n\t\t\t\t}\t\r\n        \t});\r\n\t\t\t\r\n\t\t\t\r\n        }\r\n\t}\r\n\t\r\n\t//Registre module if AMD is present:\r\n   \tif(typeof define === \"function\" && define.amd){\r\n   \t\tdefine([], function(){return WidgetMascara.init();} );\r\n   \t}\r\n   \t\r\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\r\n   \twindow.WidgetMascara = WidgetMascara.init();\r\n\t\r\n})( jQuery, window, document );","/**\r\n * \r\n * require: WidgetsGeolocal, \r\n */\r\n;(function(global, $){\r\n\r\n\tvar VisorGeolocal = function(options){\r\n\t\treturn new VisorGeolocal.init(options);\r\n\t};\r\n\t\r\n\tvar visorOptions = {\r\n\t\tcontrols: {},\r\n\t};\r\n\t\r\n\tVisorGeolocal.prototype = {\r\n\t\t\t\r\n\t\taddWidgetsControl: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tctr_widgets,\r\n\t\t\tvisor = self.visor,\r\n\t\t\t_map = visor.map;\r\n\t\t\t\r\n\t\t\tctr_widgets = L.control.widgets({\r\n\t\t\t\ttitle: window.lang.translate('Ginys')\r\n\t\t\t});\r\n\t\t\tctr_widgets.addTo(_map);\r\n\t\t\t\r\n\t\t\tself.controls.widgetsControl = ctr_widgets;\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tresizeMap: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tvisor = self.visor,\r\n\t\t\tmap = visor.visor,\r\n\t\t\toptionsBtn = {},\r\n\t\t\tfactorH = 0,\r\n\t\t\tfactorW = 0,\r\n\t\t\t_window = $( window ),\r\n\t\t\twidthW = _window.width(),\r\n\t\t\theightW = _window.height(),\r\n\t\t\t_mapDiv = $('#map'),\r\n\t\t\tcl = jQuery('.bt_llista span').attr('class');\r\n\t\t\tif(self.embed){//Pel cas visor, embeded\r\n\t\t\t\tfactorH = 0;\r\n\t\t\t}else{\r\n\t\t\t\tfactorH = $('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\r\n\t\t\t}\r\n\t\t\t_mapDiv.css('top', factorH + 'px');\r\n\t\t\t_mapDiv.height(heightW - factorH);\r\n\t\t\t_mapDiv.width(widthW - factorW);\r\n\t\t\t\r\n\t\t\tif(widthW<500 || heightW<=350){\r\n\t\t\t\toptionsBtn = {\r\n\t\t\t\t\twidgets: false\r\n\t\t\t\t};\r\n\t\t\t}else{\r\n\t\t\t\toptionsBtn = {\r\n\t\t\t\t\twidgets: true\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\tself._redrawButtons(optionsBtn);\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\t_redrawButtons: function(options){\r\n\t\t\tvar self = this;\r\n\t\t\t\r\n\t\t\tif(options.widgets && self.controls.widgetsControl){\r\n\t\t\t\tself.controls.widgetsControl.showBtn();\r\n\t\t\t}else if(self.controls.widgetsControl){\r\n\t\t\t\tself.controls.widgetsControl.hideBtn();\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_loadPublicMap: function(_mapConfig){\r\n\t\t\tvar self = this,\r\n\t\t\tvisor = self.visor,\r\n\t\t\tmap = visor.map,\r\n\t\t\tnomUser = _mapConfig.entitatUid.split(\"@\"),\r\n\t\t\tnomEntitat = _mapConfig.nomEntitat,\r\n\t\t\tinfoHtml = '';\r\n\t\t\t\r\n\t\t\t//TODO  ver si podemos usar un objeto usuario para almacenar este tipo de cosas.\r\n\t\t\t//cambiamos la cookie del perfil\r\n\t\t\tCookies.set('perfil', 'geolocal');\r\n\t\t\tcheckUserLogin();\r\n\t\t\t\r\n\t\t\t//cambiamos la cuenta de google\r\n\t\t\t//_gaq.push(['_setAccount', 'UA-46332195-6']);\r\n\t\t\tga('create', 'UA-46332195-6', 'auto');\r\n\t\t\t//cambiamos el info\r\n\t\t\tinfoHtml += '<div style=\"color:#ffffff\">';\r\n\t\t\tif (nomEntitat!=undefined) infoHtml +='<p>'+nomEntitat+'</p>';\r\n\t\t\tinfoHtml += '</div>';\r\n\t\t\t\r\n\t\t\t//destruir el creado en el visor\r\n\t\t\t$('#infoMap').popover('destroy');\r\n\t\t\t$('#infoMap').popover({\r\n\t\t\t\tplacement : 'bottom',\r\n\t\t\t\thtml: true,\r\n\t\t\t\tcontent: infoHtml\r\n\t\t\t});\r\n\t\t\t$('#infoMap').on('show.bs.popover', function () {\r\n\t\t\t\t$(this).attr('data-original-title', window.lang.translate($(this).data('lang-title')));\t\t\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t$('.brand-txt').hide();//#496: Traiem \"Instamaps\" dels visors de Geolocal\r\n\t\t\t$('.img-circle2-icon').hide();\r\n\r\n\t\t\tif (_mapConfig.options.barColor){\r\n\t\t\t\t$('#navbar-visor').css('background-color', _mapConfig.options.barColor);\r\n\t\t\t}\r\n\r\n\t\t\tif (_mapConfig.options.textColor){\r\n\t\t\t\t$('#navbar-visor').css('color', _mapConfig.options.textColor).css('border-color', '#ffffff');\r\n\t\t\t\t$('.navbar-brand').css('color', _mapConfig.options.textColor);\r\n\t\t\t\t$('#mapTitle').css('color', _mapConfig.options.textColor);\r\n\t\t\t\t$('#mapTitle h3').css('color', '#ffffff');\r\n\t\t\t\t$('.navbar-inverse .navbar-nav > li > a').css('color', _mapConfig.options.textColor);\r\n\t\t\t\t$('#menu_user > a > span').removeClass('green').css('color', _mapConfig.options.textColor);\r\n\t\t\t\t$('.navbar-form').css('border-color', 'transparent');\r\n\t\t\t\t$('.bt-sessio').css('border-color', '#ffffff');\r\n\t\t\t}\r\n\r\n\t\t\tif (_mapConfig.options.fontType){\r\n\t\t\t\t$('#navbar-visor').css('font-family', _mapConfig.options.fontType);\r\n\t\t\t}\r\n\r\n\t\t\t$('.escut').show();\r\n\t\t\tif (_mapConfig.logo){\r\n\t\t\t\t$('.escut img').prop('src', '/logos/'+_mapConfig.logo);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tdrawEmbed: function(){\r\n\t\t\tvar self = this;\r\n\t\t\t\r\n\t\t\tself.widgetscontrol = true;\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tdraw: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tvisor = self.visor,\r\n\t\t\tmap = visor.map,\r\n\t\t\t_mapConfig = visor._mapConfig;\r\n\t\t\t\r\n\t\t\t$(window).resize(_.debounce(function(){\r\n\t\t\t\tself.resizeMap();\r\n\t\t\t},150));\r\n\t\t\t\r\n\t\t\tself._listenEvents();\r\n\t\t\t\r\n\t\t\tif(visor.embed){\r\n\t\t\t\tself.drawEmbed();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(!visor.rtoolbar){\r\n\t\t\t\tif(!self.widgetscontrol){\r\n\t\t\t\t\tself.addWidgetsControl();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tself._addLogosGeolocal();\r\n\t\t\t\r\n\t\t\tself._loadPublicMap(_mapConfig);\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\t_addLogosGeolocal: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tvisor = self.visor,\r\n\t\t\tmap = visor.map;\r\n\t\t\t\r\n\t\t\tvisor.addLogoInstamap();\r\n\t   \t\t\r\n\t   \t\t$.get(\"templates/logosGeolocal.html\",function(data){\r\n\t   \t\t\tvisor.controls.controlLogos.addLogoHtml(data);\r\n\t\t\t});\r\n\t\t\t\r\n\t   \t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\t_showwigetsEvent: function(){\r\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'widgets']});\r\n\t\t},\r\n\t\t\r\n\t\t_listenEvents: function(){\r\n\t\t\tvar self = this,\r\n\t\t\tvisor = self.visor,\r\n\t\t\t_map = visor.map;\r\n\t\t\tif(_map){\r\n\t\t\t\t_map.on('showwigets', self._showwigetsEvent, self);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t};\r\n\t\r\n\tVisorGeolocal.init = function(options){\r\n\t\tvar self = this;\r\n\t\tself = $.extend(self, visorOptions, options);\r\n\t};\r\n\t\r\n\tVisorGeolocal.init.prototype = VisorGeolocal.prototype;\r\n\t\r\n\tglobal.VisorGeolocal = VisorGeolocal;\r\n\t\r\n}(window, jQuery));","/**\n * Crear el visor simple para el cloudifier\n */\n;(function(global, $){\n\t\n\tvar VisorSimple = function(options){\n\t\treturn new VisorSimple.init(options);\n\t};\n\t\n\tvar visorOptions = {\n\t\tcontrols: {},\n\t};\n\t\n\tVisorSimple.prototype = {\n\t\t\n\t\tdrawEmbed: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor;\n\t\t\t\n\t\t\tvisor.hideControl('layersControl');\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tsetMapWMSBoundingBox: function(url){\n\t\t\tvar instamapsWms = InstamapsWms({\n\t\t\t\tloadTemplateParam :false});\n\t\t\tvar dataWMS = {url: url};\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\t\t\t//Fem Layer.Layer perq des de el cloudifier sempre tindrem nomes una capa\n\t\t\t\tvar bbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\tmap.fitBounds([\n\t\t\t       [bbox[\"@miny\"], bbox[\"@minx\"]],\n\t\t\t       [bbox[\"@maxy\"], bbox[\"@maxx\"]]\n\t\t\t\t]);\n\t\t\t},function(){\n\t\t\t\tconsole.error(\"Error getCapabilities\");\n\t\t\t});\n\t\t},\n\t\t\n\t\tloadWmsVisorSimple: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tlayername = visor.layername,\n\t\t\tmap = visor.map,\n\t\t\turl = visor.urlwms;\n\t\t\t\n\t\t\tlayer = {\n\t\t\t\t\"url\": url,\n\t\t\t\t\"servername\": layername,\n\t\t\t\t\"layers\": layername,\n\t\t\t    \"imgFormat\": \"image/png\",\n\t\t\t    \"transparency\": \"true\",\n\t\t\t    \"version\": \"1.1.1\",\n\t\t\t    \"opacity\": 1,\n\t\t\t    \"epsg\": undefined,\n\t\t\t\t\"serverName\": layername,\n\t\t\t\t\"serverType\": t_wms,\n\t\t\t\t\"capesActiva\": \"true\",\n\t\t\t\t\"capesCalenta\" : \"false\",\n\t\t\t\t\"capesOrdre\":  \"1\",\n\t\t\t\t\"capesVisibilitat\":  \"true\",\n\t\t\t\t\"visibilitat\": \"O\",\n\t\t\t    \"businessId\": \"-1\"\n\t\t\t};\n\t\t\tif(visor.random){\n\t\t\t\tlayer.random = visor.random;\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\tloadWmsLayer(layer, map);\n\t\t\tself.setMapWMSBoundingBox(layer.url);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tloadVisorSimple: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tlayername = visor.layername,\n\t\t\ttitle = \"Mapa  \"+ layername +\" cloudifier\",\n\t\t\t_map = visor.map;\n\t\t\t\n\t\t\t$('meta[poperty=\"og:title\"]').attr('content', title);\n\t\t\t$('#nomAplicacio').html(title);\n\t\t\tdocument.title = title;\n\t\t\t$(\"#mapTitle\").html(title);\n\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tdraw: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor;\n\t\t\t\n\t\t\tif(visor.embed){\n\t\t\t\tself.drawEmbed();\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\tself.loadVisorSimple();\n\t\t\tself.loadWmsVisorSimple();\n\t\t\t\n\t\t\treturn self;\n\t\t}\n\t};\n\t\n\tVisorSimple.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, visorOptions, options);\n\t};\n\t\n\tVisorSimple.init.prototype = VisorSimple.prototype;\n\t\n\tglobal.VisorSimple = VisorSimple;\n\t\n}(window, jQuery));","/**\r\n * \r\n */\r\n;(function(global, $){\r\n\t\r\n\tvar Instamaps = function(options){\r\n\t\treturn new Instamaps.init(options);\r\n\t}\r\n\t\r\n\tvar perfils = [\"instamaps\",\"geolocal\"];\r\n\t\r\n\tvar footers = {\r\n\t\tinstamaps: \"InstaMaps Beta\",\r\n\t\tgeolocal: \"InstaMaps.Geolocal\"\r\n\t};\r\n\t\r\n\tvar galeriaLink = {\r\n\t\tinstamaps: \"/geocatweb/galeria.html\",\r\n\t\tgeolocal: \"/geocatweb/galeria_geolocal.html\"\r\n\t};\r\n\t\r\n\tvar sessionLink = {\r\n\t\tinstamaps: \"/geocatweb/sessio.html\",\r\n\t\tgeolocal: \"/geocatweb/sessio_geolocal.html\"\t\r\n\t};\r\n\t\r\n\tvar brand = {\r\n\t\tinstamaps: \"InstaMaps\",\r\n\t\tgeolocal: \"InstaMaps.GeoLocal\"\r\n\t};\r\n\t\r\n\tvar brandLink = {\r\n\t\tinstamaps: \"/index.html\",\r\n\t\tgeolocal: \"/geolocal.html\"\r\n\t};\r\n\t\r\n\tvar contactEmail = {\r\n\t\tinstamaps: \"instamapes@icgc.cat\",\r\n\t\tgeolocal: \"geolocal@icgc.cat\"\t\r\n\t};\r\n\t\r\n\tvar instamapsOptions = {\r\n\t\tperfil: perfils[0]\t\r\n\t};\r\n\t\r\n\tInstamaps.prototype = {\r\n\t\t\r\n\t\tsetPerfil: function(perfil){\r\n\t\t\tvar self = this;\r\n\t\t\tif(perfils.indexOf(perfil) === -1){\r\n\t\t\t\tthrow \"Perfil no soportado\";\r\n\t\t\t}else{\r\n\t\t\t\tself.options.perfil = perfil;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn self;\r\n\t\t}, \r\n\t\t\r\n\t\tchangeSession: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = sessionLink[self.perfil];\r\n\t\t\t$(selector).attr(\"href\",msg);\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tchangeBrand: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = brand[self.perfil];\r\n\t\t\t$(selector).html(msg);\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tchangeBrandLink: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = brandLink[self.perfil];\r\n\t\t\t$(selector).attr(\"href\",msg);\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tchangeGaleria: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = galeriaLink[self.perfil];\r\n\t\t\tif (self.perfil=='geolocal'){\r\n\t\t\t\tvar msg = \"http://www.instamaps.cat/\"+paramUrl.galeriaPage.substring(1,paramUrl.galeriaPage.length)+\"?user=\"+self.uid;\r\n\t\t\t\t$(selector).attr(\"href\",msg);\t\t\t\t\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t$(selector).attr(\"href\",msg);\r\n\t\t\t}\r\n\t\t\treturn self;\r\n\t\t},\r\n\t\t\r\n\t\tchangeFooter: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = footers[self.perfil];\r\n\t\t\t$(selector).html(msg);\r\n\t\t\treturn self;\r\n\t\t}, \r\n\t\t\r\n\t\tchangeContact: function(selector){\r\n\t\t\tvar self = this;\r\n\t\t\tif(!$){\r\n\t\t\t\tthrow \"jQuery not loaded\";\r\n\t\t\t}\r\n\t\t\tif(!selector){\r\n\t\t\t\tthrow \"Missing jQuery selector\";\r\n\t\t\t}\r\n\t\t\tvar msg = contactEmail[self.perfil];\r\n\t\t\t$(selector).attr(\"href\",\"mailto:\"+msg);\r\n\t\t\treturn self;\r\n\t\t}\r\n\t\r\n\t};\r\n\t\r\n\tInstamaps.init = function(options){\r\n\t\tvar self = this;\r\n\t\t$.extend(self, instamapsOptions, options);\r\n\t\tswitch(self.tipusEntitat){\r\n\t\t\tcase 1:\r\n\t\t\t\tself.perfil = \"instamaps\";\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2: \r\n\t\t\t\tself.perfil = \"geolocal\";\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tself.perfil = \"instamaps\";\r\n\t\t}\r\n\t}\r\n\t\r\n\tInstamaps.init.prototype = Instamaps.prototype;\r\n\t\r\n\tglobal.Instamaps = Instamaps; \r\n\t\r\n}(window, jQuery));"]}