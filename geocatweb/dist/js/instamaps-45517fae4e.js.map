{"version":3,"sources":["L.IM_ControlLayerManager.js","L.IM_Search.js","L.IM_Map-2.0.0.js","L.IM_ColorLayer.js","L.IM_Coordinates.js","L.IM_OpenInstamapsControl.js","L.IM_HomeControl.js","L.IM_ShareControl.js","L.IM_RoutingControl.js","L.IM_SearchControl.js","L.IM_SnapshotControl.js","L.IM_LikeControl.js","L.IM_PrintControl.js","L.IM_GeoPdfControl.js","L.IM_3DControl.js","L.IM_LegendBtnControl.js","L.IM_LegendControl.js","L.IM_LayersBtnControl.js","L.IM_LocationControl.js","L.IM_ControlScale.js","L.IM_MinimapControl.js","L.IM_LogosControl.js","L.IM_WidgetsControl.js","L.IM_MapExportControl.js","L.IM_Spin.js","L.Wikipedia.js","L.Twitter.js","L.IM_Label.js","geocat.config-1.0.0.js","geocat.constants.js","geocat.ajax-1.0.0.js","geocat.utils.js","geocat.web-1.0.0.js","geocat.compartir.js","instamaps.google-analytics.js","geocat.panel-capes.js","geocat.mapa.draw.js","geocat.mapa.wms.js","geocat.mapa.tematics.js","geocat.mapa.url-file.js","geocat.mapa.visualitzacioWMS.js","geocat.mapa.xarxes-socials.js","geocat.mapa.dades-obertes.js","geocat.mapa.json.js","geocat.mapa.heat.js","geocat.mapa.cluster.js","geocat.mapa.canvas.js","geocat.mapa.semaforic.js","geocat.mapa.basic.js","geocat.mapa.categories.js","geocat.mapa.edit-data-table.js","instamaps.layers-1.0.0.js","instamaps.wms-1.0.0.js","geocat.visor.fons.js","instamaps.mapa.3D-1.0.0.js","instamaps.visor.visor-2.0.0.js","instamaps.visor.app-1.0.0.js","instamaps.geolocal.selectMunicipis.js","instamaps.geolocal.listViewMunicipis.js","instamaps.geolocal.widgets.meteo.js","instamaps.geolocal.widgets.idescat.js","instamaps.geolocal.widgets.cartoteca.js","instamaps.geolocal.widgets.rpuc.js","instamaps.geolocal.widgets.cadastre.js","instamaps.geolocal.widgets.infoparcela.js","instamaps.geolocal.widgets.mascara.js","instamaps.visor.geolocal.js","instamaps.visor.simple.js","instamaps.app-1.0.0.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpyDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9hCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACp4CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7ZA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjiDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7qBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3sFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9bA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACh3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1pBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACl9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1OA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/XA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnqDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvgDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"instamaps-45517fae4e.js","sourcesContent":["L.Control.OrderLayers = L.Control.Layers.extend({\n\toptions : {\n\t\tcollapsed : true,\n\t\tposition : 'topright',\n\t\ttitle : 'Title',\n\t\tautoZIndex : true,\n\t\tautoUpdate: true\n\t},\n\n\tinitialize : function(baseLayers, groupedOverlays, options) {\n\t\tvar i, j;\n\t\t\n\t\tL.Util.setOptions(this, options);\n\t\t\n\t\tthis._layers = {};\n\t\tthis._lastZIndex = 0;\n\t\tthis._handlingClick = false;\n\t\tthis._groupList = [];\n\t\tthis._domGroups = [];\n\t\tthis._socInstamapsVell=\"_socVisorVellInstamaps_\";\n\t\tthis._mapConfig = options.mapConfig;\n\t\t\n\t\tfor (i in baseLayers) {\n\t\t\tfor ( var j in baseLayers[i].layers) {\n\t\t\t\tthis._addLayer(baseLayers[i].layers[j], j,\n\t\t\t\t\tbaseLayers[i], false);\n\t\t\t}\n\t\t}\n\n\t\tfor (i in groupedOverlays) {\n\t\t\tfor ( var j in groupedOverlays[i].layers) {\n\t\t\t\tthis._addLayer(groupedOverlays[i].layers[j], j, true,\n\t\t\t\t\tnull, groupedOverlays[i]);\n\t\t\t}\n\t\t}\n\t},\n\n\tonAdd : function(map) {\n\t\tthis._initLayout();\n\t\tthis._update();\n\t\tmap.on('layeradd', this._onLayerChange, this).on('layerremove', this._onLayerChange, this);\n\t\treturn this._container;\n\t},\n\n\tonRemove : function(map) {\n\t\tmap.off('layeradd', this._onLayerChange).off('layerremove', this._onLayerChange);\n\t},\n\n\taddBaseLayer : function(layer, name, group) {\n\t\tthis._addLayer(layer, name, group, false);\n\t\tthis._update();\n\t\treturn this;\n\t},\n\n\taddOverlay : function(layer, name, overlay, groupLeafletId) {\n\t\tthis._addLayer(layer, name, overlay, groupLeafletId);\n\t\tthis._update();\n\t\treturn this;\n\t},\n\t\n\tremoveLayer : function(obj) {\n\t\tvar id = L.stamp(obj.layer);\n\t\tif (!obj.sublayer) {\n\t\t\tdelete this._layers[id];\n\t\t} else {\n\t\t\tdelete this._layers[obj.layerIdParent]._layers[id];\n\t\t}\n\n\t\tvar _thereIs = false;\n\t\tfor (layer in this._layers) {\n\t\t\tif (this._layers[layer].layer.options.tipus && this._layers[layer].layer.options.tipus.indexOf(t_wms) != -1) {\n\t\t\t\tif (this._layers[layer].layer.options.wmstime == true) {\n\t\t\t\t\t_thereIs = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tshowTimeControl(_thereIs);\n\n\t\tthis._update();\n\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,\"remove\",true);}\n\t\treturn this;\n\t},\n\n\tgetCountLayers:function(){\n\t\tvar i=0;\n\t\tfor (layer in this._layers) {\n\t\t\ti=i+1;\n\t\t\tfor (sublayer in this._layers[layer]._layers) {\n\t\t\t\ti=i+1;\n\t\t\t}\n\t\t}\n\t\treturn i;\n\t},\n\t\n\tgetLayersFromGroupId : function(groupId, groupName) {\n\t\tvar resp_Layer = [];\n\t\tfor (layer in this._layers) {\n\t\t\tif (this._layers[layer].layer.options.group.groupName == groupName\n\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\n\t\t\t\tresp_Layer.push(this._layers[layer]);\n\t\t\t}\n\t\t}\n\t\treturn resp_Layer;\n\t},\n\n\tupdateTreeGroupLayers : function(groupId, groupName, businessId, z_order, expanded) {\n\t\tvar dfd = $.Deferred();\n\t\ttry{\n\t\t\tthis._groupList[groupId].groupName = groupName;\n\t\t\tthis._groupList[groupId].name = groupName;\n\t\t\tthis._groupList[groupId].id = groupId;\n\t\t\tthis._groupList[groupId].expanded = expanded;\n\t\n\t\t\tfor (layer in this._layers) {\n\t\t\t\tif (this._layers[layer].layer.options.group\n\t\t\t\t\t&& this._layers[layer].layer.options.businessId == businessId) {\n\t\t\t\t\tthis._layers[layer].layer.options.group.name = groupName;\n\t\t\t\t\tthis._layers[layer].layer.options.group.groupName = groupName;\n\t\t\t\t\tthis._layers[layer].layer.options.group.id = groupId;\n\t\t\t\t\tthis._layers[layer].layer.options.group.z_order = z_order;\n\t\t\t\t\tthis._layers[layer].layer.options.group.expanded = expanded;\n\t\t\t\t\tthis._layers[layer].layer.options.zIndex = z_order;\n\t\t\t\t\tthis._layers[layer].layer.setZIndex(parseInt(z_order)+1);\n\t\t\t\t\tmap.eachLayer(function(layer) {\n\t\t\t\t\t\tif (layer.options\n\t\t\t\t\t\t\t&& layer.options.businessId == businessId) {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tlayer.bringToFront();\n\t\t\t\t\t\t\t} catch (Err) {\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tdfd.resolve(this._layers[layer].layer);\n\t\t\t\t}\n\t\t\t}\n\t\t}catch(Err){\n\t\t\tdfd.reject(Err);\n\t\t\tconsole.debug(Err);\n\t\t}\n\t\treturn dfd.promise();\n\t},\n\n\tupdateGroupName : function(oldName, newName, groupId) {\n\t\tvar resp_Layer = [];\n\t\tfor (group in this._groupList) {\n\t\t\tif (this._groupList[group].groupName == oldName\n\t\t\t\t&& this._groupList[group].id == groupId) {\n\t\t\t\tthis._groupList[group].groupName = newName;\n\t\t\t\tthis._groupList[group].name = newName;\n\n\t\t\t\tfor (layer in this._layers) {\n\t\t\t\t\tif (this._layers[layer].layer.options.group\n\t\t\t\t\t\t&& this._layers[layer].layer.options.group.name == oldName\n\t\t\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\n\t\t\t\t\t\tthis._layers[layer].layer.options.group.name = newName;\n\t\t\t\t\t\tthis._layers[layer].layer.options.group.groupName = newName;\n\t\t\t\t\t\tresp_Layer.push(this._layers[layer].layer);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis._update();\n\t\treturn resp_Layer;\n\t},\n\n\tremoveGroup : function(groupName, groupId) {\n\t\tif (groupName) {\n\t\t\tfor (group in this._groupList) {\n\t\t\t\tif (this._groupList[group].groupName == groupName\n\t\t\t\t\t\t&& this._groupList[group].id == groupId) {\n\t\t\t\t\tfor (layer in this._layers) {\n\t\t\t\t\t\tif (this._layers[layer].layer.options.group\n\t\t\t\t\t\t\t&& this._layers[layer].layer.options.group.groupName == groupName\n\t\t\t\t\t\t\t&& this._layers[layer].layer.options.group.id == groupId) {\n\t\t\t\t\t\t\tdelete this._layers[layer];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tdelete this._groupList[group];\n\t\t\t\t\tthis._update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t_initLayout : function() {\n\t\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html') != -1);\n\t\tvar className = 'leaflet-control-layers', \n\t\tcontainer = this._container = L.DomUtil.create('div', className);\n\n\t\t// Makes this work on IE10 Touch devices by stopping it from\n\t\t// firing a mouseout event when the touch is released\n\t\tcontainer.setAttribute('aria-haspopup', true);\n\n\t\tif (!L.Browser.touch) {\n\t\t\tL.DomEvent.disableClickPropagation(container);\n\t\t\tL.DomEvent.on(container, 'wheel', L.DomEvent.stopPropagation);\n\t\t} else {\n\t\t\tL.DomEvent.on(container, 'click', L.DomEvent.stopPropagation);\n\t\t}\n\t\tvar section = document.createElement('section');\n\t\tsection.className = 'ac-container ' + className + '-list';\n\t\t\n\t\tvar spiner = this._spiner = L.DomUtil.create('div', className + '-spiner');\n\t\t\n\t\tspiner.innerHTML = \"<i class='fa fa-refresh fa-spin fa-fw margin-bottom'></i>\"+\n\t\t\"<span lang='ca'>Carregant, esperi si us plau...</span>\";\n\t\t\n\t\tsection.appendChild(spiner);\n\t\t\n\t\tvar form = this._form = L.DomUtil.create('div', className + '-list');\n\n\t\tif (this.options.title) {\n\t\t\tvar title = L.DomUtil.create('h3', className + '-title editable');\n\t\t\ttitle.innerHTML = this.options.title;\n\t\t\ttitle.id = 'nomAplicacio';\n\t\t\tform.appendChild(title);\n\t\t}\n\n\t\tsection.appendChild(form);\n\n\t\tif (this.options.collapsed) {\n\t\t\tif (!L.Browser.android) {\n\t\t\t\tL.DomEvent.on(container, 'mouseover', this._expand,\n\t\t\t\t\tthis).on(container, 'mouseout', this._collapse,\n\t\t\t\t\tthis);\n\t\t\t}\n\t\t\tvar link = this._layersLink = L.DomUtil.create('a',\n\t\t\t\tclassName + '-toggle', container);\n\t\t\tlink.href = '#';\n\t\t\tlink.title = 'Layers';\n\n\t\t\tif (L.Browser.touch) {\n\t\t\t\tL.DomEvent.on(link, 'click', L.DomEvent.stop).on(link,\n\t\t\t\t\t'click', this._expand, this);\n\t\t\t} else {\n\t\t\t\tL.DomEvent.on(link, 'focus', this._expand, this);\n\t\t\t}\n\n\t\t\tthis._map.on('click', this._collapse, this);\n\t\t\t// TODO keyboard accessibility\n\n\t\t} else {\n\t\t\tthis._expand();\n\t\t}\n\n\t\tvar strLayersList = 'layers-list';\n\t\tthis._baseLayersList = L.DomUtil.create('div', className + '-base', form);\n\n\t\tthis._overlaysList = L.DomUtil.create('ol', className + '-overlays', form);\n\n\t\tif (getModeMapa()) {\n\t\t\tthis._addButton = L.DomUtil.create('div', 'addVerd', form);\n\t\t\tL.DomEvent.on(this._addButton, 'click',\n\t\t\t\tthis._addGroupFromScratch, this);\n\n\t\t\t$(this._addButton).tooltip({\n\t\t\t\tplacement : 'left',\n\t\t\t\tcontainer : 'body',\n\t\t\t\ttitle : window.lang.translate(\"Nou grup\")\n\t\t\t});\n\t\t}\n\n\t\tcontainer.appendChild(section);\n\n\t\t// process options of ac-container css class - to\n\t\t// options.container_width and options.container_maxHeight\n\t\tfor (var c = 0; c < (containers = container\n\t\t  .getElementsByClassName('ac-container')).length; c++) {\n\t\t\tif (this.options.container_width) {\n\t\t\t\tcontainers[c].style.width = this.options.container_width;\n\t\t\t}\n\n\t\t\t// set the max-height of control to y value of map object\n\t\t\tthis._default_maxHeight = this.options.container_maxHeight ? this.options.container_maxHeight\n\t\t\t\t: (this._map._size.y - 70);\n\t\t}\n\t\twindow.onresize = this._on_resize_window.bind(this);\n\t},\n\n\t_on_resize_window : function() {\n\n\t},\n\n\t// remove the px from a css value and convert to a int\n\t_removePxToInt : function(value) {\n\t\tif (typeof (value) == \"number\") {\n\t\t\treturn value;\n\t\t} else {\n\t\t\treturn parseInt(value.replace(\"px\", \"\"));\n\t\t}\n\t},\n\n\t_socVisorInstamaps:function(){\n\t\tvar self = this;\n\t\tvar hoSoc=false;\n\t\tif (self._mapConfig===undefined) self._mapConfig=mapConfig;\n\t\tif(self._mapConfig.tipusAplicacioId==1 && !getModeMapa()){\n\t\t\thoSoc=true;\n\t\t}\n\t\treturn hoSoc;\n\t},\n\t\n\t_createGroupFromScratch : function(position) {\n\t\tvar pos = this._groupList.length;\n\t\tvar posTXT;\n\t\tvar genericName=window.lang.translate('Capes');\n\t\tvar genericPos=\"\";\n\n\t\tpos==0?genericPos=\"\":genericPos=pos;\n\n\t\tthis._socVisorInstamaps()?genericName=this._socInstamapsVell:genericName=genericName;\n\n\t\tif (position == 1 && pos > 0) { // estic afegint una\n\t\t\t// capa però ja existeix\n\t\t\t// un grup\n\t\t\treturn this.getActiveGroup();\n\t\t} else {\n\t\t\tvar group = {\n\t\t\t\t\"groupName\" : genericName+\" \"+ genericPos,\n\t\t\t\t\"name\" : genericName+\" \"+ genericPos,\n\t\t\t\t\"id\" : pos,\n\t\t\t\t\"expanded\" : true\n\t\t\t};\n\t\t\tthis._groupList.push(group);\n\t\t\treturn group;\n\t\t}\n\t},\n\n\tgetActiveGroup : function() {\n\t\tvar groupLast = this._groupList[this._groupList.length - 1];\n\t\tvar notExpanded = false;\n\t\tif (groupLast.expanded==true || groupLast.expanded==\"true\") {\n\t\t\treturn groupLast;\n\t\t} else {\n\t\t\tfor (j=0; j < this._groupList.length;j++ ){\n\t\t\t\tvar _gr=this._groupList[j];\n\t\t\t\tif (_gr.expanded==true || _gr.expanded==\"true\") {\n\t\t\t\t\tnotExpanded = true;\n\t\t\t\t\treturn _gr;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!notExpanded) {\n\t\t\treturn groupLast;\n\t\t}\n\t},\n\n\tgetGroupWhereIBelong : function() {\n\t\tvar pos = this._groupList.length;\n\t\tif (pos > 0) { // estic afegint una capa però ja existeix un\n\t\t\t// grup\n\t\t\treturn this._groupList[this._groupList.length - 1];\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t},\n\n\t_addGroupFromScratch : function() {\n\t\tvar container = this._overlaysList;\n\t\tvar obj = {};\n\t\tvar group = this._createGroupFromScratch(0);\n\n\t\tobj.group = group;\n\t\tthis._addGroup(container, obj, null);\n\t\tif (getModeMapa()) {\n\t\t\tupdateEditableElements();\n\t\t\trefreshSortablesElements();\n\t\t}\n\t},\n\n\t_addGroupFromObject : function(group) {\n\t\tif (group) {\n\t\t\tvar container = this._overlaysList;\n\t\t\tvar obj = {};\n\t\t\tobj.group = group;\n\t\t\tvar trobat = false;\n\t\t\tfor (g in this._groupList) {\n\t\t\t\tif (this._groupList[g].id == group.id) {\n\t\t\t\t\ttrobat = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!trobat) {\n\t\t\t\tthis._groupList.push(obj.group);\n\t\t\t}\n\t\t\tthis._addGroup(container, obj, null);\n\t\t}\n\t},\n\n\t_addGroup : function(container, _obj, _menu_item_checkbox) {\n\t\tvar _id;\n\t\tvar obj;\n\t\tif (_obj.group) {\n\t\t\t_id = _obj.group.id;\n\t\t\tobj = _obj;\n\t\t} else if (_obj.layer) {\n\t\t\tobj = _obj.layer.options;\n\t\t\ttry{\n\t\t\t_id = _obj.layer.options.group.id;\n\t\t\t}catch(Err){\n\n\t\t\t_id= this._domGroups.length -1;\n\t\t\t}\n\t\t} else {\n\t\t\t_id = null;\n\t\t}\n\t\tif (_id >= 0) {\n\t\t\tvar groupContainer = this._domGroups[_id];\n\t\t\tif (!groupContainer) {\n\t\t\t\tgroupContainer = document.createElement('div');\n\t\t\t\tgroupContainer.id = 'leaflet-control-accordion-layers-'+ _id;\n\t\t\t\tgroupContainer.className = 'leaflet-control-accordion-layers';\n\t\t\t\t// verify if group is expanded\n\t\t\t\tvar s_expanded = obj.group.expanded ? ' checked = \"true\" ': '';\n\t\t\t\t// verify if type is exclusive\n\t\t\t\tvar s_type_exclusive = this.options.exclusive ? ' type=\"radio\" '\n\t\t\t\t\t: ' type=\"checkbox\" ';\n\t\t\t\tinputElement = '<input id=\"ac' + _id\n\t\t\t\t\t+ '\" name=\"accordion-' + _id\n\t\t\t\t\t+ '\" class=\"menu expanded_input\" ' + s_expanded\n\t\t\t\t\t+ s_type_exclusive + '/>';\n\t\t\t\tinputLabel = document.createElement('label');\n\t\t\t\tvar _for = document.createAttribute('for');\n\t\t\t\t_for.value = \"ac\" + _id;\n\t\t\t\tinputLabel.setAttributeNode(_for);\n\n\t\t\t\tvar spanGroup = document.createElement('span');\n\t\t\t\tspanGroup.innerHTML = obj.group.name;\n\t\t\t\tvar classExpanded = 'glyphicon glyphicon-triangle-bottom label_gl';\n\t\t\t\tif (!obj.group.expanded) {\n\t\t\t\t\tclassExpanded = 'glyphicon glyphicon-triangle-right label_gl';\n\t\t\t\t}\n\t\t\t\tinputLabel.id = 'lbl_ac_' + _id;\n\n\t\t\t\tif(obj.group.name.indexOf(this._socInstamapsVell)==-1){\n\t\t\t\t\tinputLabel.className = 'label_ac';\n\t\t\t\t}else{\n\t\t\t\t\tinputLabel.className = 'label_ac_novisible';\n\t\t\t\t}\n\n\t\t\t\tvar _i = document.createElement('i');\n\t\t\t\t_i.id = '_i_' + _id;\n\t\t\t\t_i.className = classExpanded\n\t\t\t\tinputLabel.appendChild(_i);\n\t\t\t\t\tL.DomEvent.on(inputLabel, 'click', this._onExpandGroup,this);\n\t\t\t\tspanGroup.className = 'span_ac editable';\n\t\t\t\tspanGroup.id = 'ac' + _id;\n\t\t\t\tspanGroup.groupId = _id;\n\t\t\t\tspanGroup.groupName = obj.group.name;\n\t\t\t\tinputLabel.appendChild(spanGroup);\n\n\t\t\t\tif (getModeMapa()) {\n\t\t\t\t\tvar col = L.DomUtil.create('span', \n\t\t\t\t\t\t'tema_verd glyphicon glyphicon-remove group-conf');\n\t\t\t\t\tcol.id = 'mv-' + _id;\n\t\t\t\t\tcol.groupId = _id;\n\t\t\t\t\tcol.groupName = obj.group.name;\n\t\t\t\t\tL.DomEvent.on(col, 'click', this._onRemoveGroup,this);\n\t\t\t\t\tinputLabel.appendChild(col);\n\n\t\t\t\t\t$(col).tooltip({\n\t\t\t\t\t\tplacement : 'left',\n\t\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\t\ttitle : window.lang.translate(\"Esborrar grup\")\n\t\t\t\t\t});\n\n\t\t\t\t\tvar col = L.DomUtil.create('span',\n\t\t\t\t\t\t'tema_verd_move glyphicon glyphicon-move group-conf');\n\t\t\t\t\tcol.id = 'rv-' + _id;\n\t\t\t\t\tcol.groupName = obj.group.name;\n\t\t\t\t\tcol.groupId = _id;\n\t\t\t\t\tinputLabel.appendChild(col);\n\t\t\t\t\t$(col).tooltip({\n\t\t\t\t\t\tplacement : 'left',\n\t\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\t\ttitle : window.lang.translate(\"Moure grup\")\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tarticle = document.createElement('ol');\n\t\t\t\tarticle.className = 'ac-large';\n\t\t\t\tif (_menu_item_checkbox) {\n\t\t\t\t\tarticle.appendChild(_menu_item_checkbox);\n\t\t\t\t}\n\n\t\t\t\t// process options of ac-large css class - to\n\t\t\t\t// options.group_maxHeight property\n\t\t\t\tif (this.options.group_maxHeight) {\n\t\t\t\t\tarticle.style.maxHeight = this.options.group_maxHeight;\n\t\t\t\t}\n\n\t\t\t\tgroupContainer.innerHTML = inputElement;\n\t\t\t\tgroupContainer.appendChild(inputLabel);\n\t\t\t\tgroupContainer.appendChild(article);\n\n\t\t\t\tvar supraLI = document.createElement('li');\n\t\t\t\tsupraLI.appendChild(groupContainer);\n\n\t\t\t\tcontainer.appendChild(supraLI);\n\n\t\t\t\tthis._domGroups[_id] = groupContainer;\n\t\t\t} else {\n\t\t\t\tif (_menu_item_checkbox) {\n\t\t\t\t\tgroupContainer.lastElementChild.appendChild(_menu_item_checkbox);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t_addLayer : function(layer, name, overlay, groupLeafletId) {\n\t\tvar id = L.Util.stamp(layer);\n\t\tif (groupLeafletId) {\n\t\t\tthis._layers[groupLeafletId]._layers[id] = {\n\t\t\t\tlayer : layer,\n\t\t\t\tname : name,\n\t\t\t\toverlay : overlay,\n\t\t\t\tsublayer : true,\n\t\t\t\tlayerIdParent : groupLeafletId\n\t\t\t};\n\t\t} else {\n\t\t\tthis._layers[id] = {\n\t\t\t\tlayer : layer,\n\t\t\t\tname : name,\n\t\t\t\toverlay : overlay,\n\t\t\t\tsublayer : false,\n\t\t\t\t_layers : {}\n\t\t\t};\n\t\t}\n\t\tvar group = layer.options.group;\n\t\tvar _heCreat = false;\n\t\tvar _heCreatFromScratch=false;\n\t\tif (!group) {\n\t\t\tgroup = this._createGroupFromScratch(1);\n\t\t\t_heCreat = true;\n\t\t\t_heCreatFromScratch=true;\n\t\t}\n\t\tvar groupId;\n\t\tif (group) {\n\t\t\t//var groupId = this._groupList.indexOf(group);\n\t\t\tif (undefined !=group.id) {\n\t\t\t\tgroupId = group.id;\n\t\t\t\tvar trobat = false;\n\t\t\t\tfor (g in this._groupList) {\n\t\t\t\t\tif (this._groupList[g].id == group.id) {\n\t\t\t\t\t\ttrobat = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!trobat) {\n\t\t\t\t\tthis._groupList.push(group);\n\t\t\t\t}\n\n\t\t\t}\n\t\t\t// if not find the group search for the name\n\t\t\t/*if (groupId === -1) {\n\t\t\t\tfor (g in this._groupList) {\n\t\t\t\t\tif (this._groupList[g].groupName == group.groupName) {\n\t\t\t\t\t\tgroupId = g;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}*/\n\n\t\t\tif (groupId === -1) {\n\t\t\t\tgroupId = this._groupList.push(group) - 1;\n\t\t\t}\n\n\t\t\t\n\t\t\tif (this._layers[id]) {\n\t\t\t\tthis._layers[id].layer.options.group = {\n\t\t\t\t\tname : group.groupName,\n\t\t\t\t\tgroupName : group.groupName,\n\t\t\t\t\tid : groupId,\n\t\t\t\t\tz_order : this._layers[id].layer.options.zIndex,\n\t\t\t\t\texpanded : group.expanded\n\t\t\t\t};\n\n\t\t\t\tif (_heCreat) {\n\t\t\t\t\tif (getModeMapa()) {\n\t\t\t\t\t\tif(_heCreatFromScratch){\n\t\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\t\t\tbusinessId : this._layers[id].layer.options.businessId, // url('?businessid')\n\t\t\t\t\t\t\t\tuid : Cookies.get('uid'),\n\t\t\t\t\t\t\t\toptions : JSON.stringify(this._layers[id].layer.options.group)\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t// Ara desactivat\n\t\t\t\t\t\t\tupdateGroupsLayerGroup(data, null);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (this.options.autoZIndex && layer.setZIndex) {\n\t\t\tthis._lastZIndex++;\n\t\t\tlayer.setZIndex(this._lastZIndex);\n\t\t}\n\t},\n\n\t_update : function(makeUpdate) {\n\t\tvar self = this;\n\t\tvar redraw = makeUpdate || self.options.autoUpdate;\n\t\tif(redraw){\n\t\t\tif (!self._container) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tself._domGroupsTMP = self._groupList;\n\t\t\tself._groupList = [];\n\t\t\tself._baseLayersList.innerHTML = '';\n\t\t\tself._overlaysList.innerHTML = '';\n\t\t\tself._domGroups.length = 0;\n\n\t\t\tself._domGroupsTMP = sortByKey(self._domGroupsTMP, \"id\");\n\t\t\tself._groupList = sortByKey(self._groupList, \"id\");\t\t\t\n\t\t\t\n\t\t\tself._domGroupsTMP.forEach(function(item, index, array) {\n\t\t\t\tself._addGroupFromObject(item);\n\t\t\t});\n\n\t\t\tvar baseLayersPresent = false, overlaysPresent = false, i, obj;\n\t\t\tvar layerArray=[];\n\t\t\tfor (i in self._layers) {\n\t\t\t\tlayerArray.push(self._layers[i]);\n\t\t\t}\n\t\t\tlayerArray = sortByKeyPath(layerArray, \"zIndex\");\n\t\t\t\n\t\t\tfor (i in layerArray) {\n\t\t\t\tobj = layerArray[i];\n\t\t\t\tself._addItem(obj);\n\t\t\t\toverlaysPresent = overlaysPresent || obj.overlay;\n\t\t\t\tbaseLayersPresent = baseLayersPresent || !obj.overlay;\n\t\t\t}\n\t\t\t\n\t\t\tself._hideSpiner();\n\t\t\t\n\t\t\tmap.fire('onRedrawLegend', self._mapConfig);\n\t\t\t$.publish('onRedrawLegend', self._mapConfig);\n\t\t}\n\t},\n\t\n\tforceUpdate: function(autoUpdate){\n\t\tif(autoUpdate){\n\t\t\tthis.options.autoUpdate = true;\n\t\t}\n\t\tthis._update(true);\n\t},\n\n\t_diferences : function(a1, a2) {\n\t\tvar a = [], diff = [];\n\t\tfor (var i = 0; i < a1.length; i++)\n\t\t\ta[a1[i]] = true;\n\t\tfor (var i = 0; i < a2.length; i++)\n\t\t\tif (a[a2[i]])\n\t\t\t\tdelete a[a2[i]];\n\t\t\telse\n\t\t\t\ta[a2[i]] = true;\n\t\tfor ( var k in a)\n\t\t\tdiff.push(parseInt(k));\n\t\treturn diff;\n\t},\n\n\t_onLayerChange : function(e) {\n\t\tvar obj = this._layers[L.Util.stamp(e.layer)];\n\t\tif (!obj) {\n\t\t\treturn;\n\t\t}\n\t\tif (!this._handlingClick) {\n\t\t\tthis._update();\n\t\t}\n\t\t//parece que esta parte de código no se usa.\n\t\tvar type = obj.overlay ? (e.type === 'layeradd' ? 'overlayadd'\n\t\t\t: 'overlayremove')\n\t\t\t: (e.type === 'layeradd' ? 'baselayerchange' : null);\n\t\tif (type) {\n\t\t\tthis._map.fire(type, obj);\t\t\t\t\t\n\t\t}\n\t},\n\n\t_createRadioElement : function(name, checked) {\n\t\tvar radioHtml = '<input type=\"radio\" class=\"leaflet-control-layers-selector\" name=\"'\n\t\t\t+ name + '\"';\n\t\tif (checked) {\n\t\t\tradioHtml += ' checked=\"checked\"';\n\t\t}\n\t\tradioHtml += '/>';\n\t\tvar radioFragment = document.createElement('div');\n\t\tradioFragment.innerHTML = radioHtml;\n\t\treturn radioFragment.firstChild;\n\t},\n\n\t_addItem : function(obj) {\n\t\tvar _menu_item_checkbox = document.createElement('li'), \n\t\tinput, checked = this._map.hasLayer(obj.layer), \n\t\tcontainer;\t\n\t\t\n\t\tvar _leaflet_input = document.createElement('div');\n\t\tif (obj.overlay) {\n\t\t\t_menu_item_checkbox.className = \"leaflet-row\";\n\t\t\t_menu_item_checkbox.id = 'LI-'+ obj.layer.options.businessId;\n\n\t\t\tinput = document.createElement('input');\n\t\t\tinput.id = 'input-' + obj.layer.options.businessId;\n\t\t\tinput.type = 'checkbox';\n\t\t\tinput.className = 'checkbox_styled hide leaflet-control-layers-selector';\n\t\t\t\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\n\t\t\t\tif (obj.layer.options.wmstime == true) {\n\t\t\t\t\tinput.className = 'checkbox_time hide leaflet-control-layers-selector';\n\t\t\t\t}\n\t\t\t}\n\t\t\tinput.defaultChecked = checked;\n\t\t} else {\n\t\t\tinput = this._createRadioElement('leaflet-base-layers', checked);\n\t\t}\n\n\t\t_leaflet_input.className = \"leaflet-input\";\n\t\tinput.layerId = L.Util.stamp(obj.layer);\n\t\tL.DomEvent.on(input, 'click', this._onInputClick, this);\n\t\tvar label_for = document.createElement('label');\n\t\tvar _for = document.createAttribute('for');\n\t\t_for.value = 'input-' + obj.layer.options.businessId;\n\t\tlabel_for.setAttributeNode(_for);\n\t\t_leaflet_input.appendChild(input);\n\t\t_leaflet_input.appendChild(label_for);\n\n\t\tvar _leaflet_name = document.createElement('div');\n\t\t_leaflet_name.className = 'leaflet-name';\n\t\tvar _label_buit = document.createElement('label');\n\t\tvar nomCapa = document.createElement('span');\n\n\t\t\n\t\tvar layerName=obj.name;\t\t\t\n    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\n \n\t\tnomCapa.innerHTML = ' ' + layerName;\n\t\t//nomCapa.innerHTML = ' ' + obj.name;\n\t\tnomCapa.className = 'editable';\n\t\tnomCapa.id = input.layerId;\n\n\t\tif(obj.layer.error){\n\t\t\t_label_buit.className = 'error';\n\t\t}\n\t\t\n\t\t_label_buit.appendChild(nomCapa);\n\n\t\tif (obj.layer.options.tipus == t_visualitzacio\n\t\t\t\t|| obj.layer.options.tipus == t_tematic\n\t\t\t\t|| obj.layer.options.tipus == t_dades_obertes\n\t\t\t\t|| obj.layer.options.tipus == t_json\n\t\t\t\t|| obj.layer.options.tipus == t_url_file) {\n\t\t\tvar count = document.createElement('span');\n\t\t\tcount.className = 'layer-count';\n\t\t\tcount.id = 'count-' + obj.layer.options.businessId;\n\t\t\tcount.innerHTML = ' (' + obj.layer.getLayers().length + ')';\n\t\t\t_label_buit.appendChild(count);\n\t\t}\n\n\t\t_leaflet_name.appendChild(_label_buit);\n\t\t_menu_item_checkbox.appendChild(_leaflet_input);\n\t\t_menu_item_checkbox.appendChild(_leaflet_name);\n\n\t\tvar container;\n\t\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html') != -1);\n\n\t\tvar col;\n\n\t\tif (obj.overlay) {\n\t\t\t// Icona conf Sempre\n\t\t\tcol = L.DomUtil.create('div', 'leaflet-conf glyphicon glyphicon-cog opcio-conf');\n\t\t\tL.DomEvent.on(col, 'click', this._showOptions, this);\n\t\t\tcol.layerId = input.layerId;\n\t\t\t_menu_item_checkbox.appendChild(col);\n\n\t\t\t// Icona remove només Edicio\n\t\t\tif (getModeMapa()) {\n\t\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-remove glyphicon glyphicon-remove subopcio-conf');\n\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\tL.DomEvent.on(col, 'click', this._onRemoveClick, this);\n\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t\t\t}\n\t\t\t// Icona Taula de Dades Sempre\n\t\t\tif ((obj.layer.options.source || obj.layer.options.geometryType==\"marker\" ||  obj.layer.options.geometryType==\"polyline\" \n\t\t\t\t||  obj.layer.options.geometryType==\"polygon\") && !obj.layer.options.dinamic ) {\n\t\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t\t'data-table-'+ obj.layer.options.businessId+ ' leaflet-data-table glyphicon glyphicon-list-alt');\n\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\tL.DomEvent.on(col, 'click', this._onOpenDataTable, this);\n\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t\t\t}\n\t\t\t// Icona Descàrrega sempre\n\t\t\t//Issue #467: S'ha de respectar el que es selecciona al publicar sobre si una capa és descarregable o no.\n\t\t\tif (getModeMapa()) {\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) == -1\n\t\t\t\t\t&& obj.layer.options.tipus.indexOf(t_geojsonvt) == -1) {\n\t\t\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-download glyphicon glyphicon-save subopcio-conf');\n\t\t\t\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\t\t\t\tL.DomEvent.on(col, 'click', this._onDownloadClick, this);\n\t\t\t\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) == -1\n\t\t\t\t\t&& obj.layer.options.tipus.indexOf(t_geojsonvt) == -1) {\n\t\t\t\t\tif(downloadableData[obj.layer.options.businessId]){\n\t    \t\t\t\tif(downloadableData[obj.layer.options.businessId][0].chck) {\n\t\t\t\t\t\t\tcol = L.DomUtil\n\t\t\t\t\t\t\t\t\t.create(\n\t\t\t\t\t\t\t\t\t\t\t'div',\n\t\t\t\t\t\t\t\t\t\t\t'conf-'\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ obj.layer.options.businessId\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ ' leaflet-download glyphicon glyphicon-save subopcio-conf');\n\t\t\t\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\t\t\t\tL.DomEvent\n\t\t\t\t\t\t\t\t\t.on(col, 'click', this._onDownloadClick, this);\n\t\t\t\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t    \t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}\n\t\t\t// Icona Transparència\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\n\t\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-trans glyphicon glyphicon-adjust subopcio-conf');\n\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\tL.DomEvent.on(col, 'click', this._onTransparenciaClick,this);\n\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t\t\t\t$(col).tooltip({\n\t\t\t\t\tplacement : 'bottom',\n\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\ttitle : window.lang.translate(\"Transparència\")\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Icona Moure només Edicio\n\t\t\tif (getModeMapa()) {\n\t\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-move glyphicon glyphicon-move subopcio-conf');\n\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\t_menu_item_checkbox.appendChild(col);\n\t\t\t\t$(col).tooltip({\n\t\t\t\t\tplacement : 'bottom',\n\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\ttitle : window.lang.translate(\"Moure\")\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tcol = L.DomUtil.create('div',\n\t\t\t\t'conf-'+ obj.layer.options.businessId+ ' leaflet-zoom glyphicon glyphicon-search subopcio-conf');\n\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\tL.DomEvent.on(col, 'click', this._onZoomClick,this);\n\t\t\t\t_menu_item_checkbox.appendChild(col);\n\n\t\t\t\t$(col).tooltip({\n\t\t\t\t\tplacement : 'bottom',\n\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\ttitle : window.lang.translate(\"Zoom a la capa\")\n\t\t\t\t});\n\t\t\t\n\t\t\tif (getModeMapa()) {\n\t\t\t\tif ((obj.layer.options.tipus == t_visualitzacio\n\t\t\t\t\t\t|| obj.layer.options.tipus == t_url_file\n\t\t\t\t\t\t|| obj.layer.options.tipus == t_json) && !obj.layer.options.dinamic) {\n\t\t\t\t\tcol = L.DomUtil\n\t\t\t\t\t\t\t.create(\n\t\t\t\t\t\t\t\t\t'div',\n\t\t\t\t\t\t\t\t\t'conf-'\n\t\t\t\t\t\t\t\t\t\t\t+ obj.layer.options.businessId\n\t\t\t\t\t\t\t\t\t\t\t+ ' leaflet-zoom glyphicon glyphicon-font subopcio-conf');\n\t\t\t\t\tcol.layerId = input.layerId;\n\t\t\t\t\t// L.DomEvent.on(col, 'click', this._onDownClick, this);\n\t\t\t\t\tL.DomEvent.on(col, 'click', this._onEtiquetaClick,\n\t\t\t\t\t\t\tthis);\n\t\t\t\t\t_menu_item_checkbox.appendChild(col);\n\n\t\t\t\t\t$(col).tooltip({\n\t\t\t\t\t\tplacement : 'bottom',\n\t\t\t\t\t\tcontainer : 'body',\n\t\t\t\t\t\ttitle : window.lang.translate(\"Etiquetes de la capa\")\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tcontainer = this._overlaysList;\n\t\t} else {\n\t\t\tcontainer = this._baseLayersList;\n\t\t}\n\n\t\tvar sublayers = obj._layers;\n\t\tfor (j in sublayers) {\n\t\t\tvar row_sublayer = this._createSubItem(sublayers[j], input.layerId, modeMapa);\n\t\t\t_menu_item_checkbox.appendChild(row_sublayer);\n\t\t}\n\n\t\tthis._addGroup(container, obj, _menu_item_checkbox);\n\n\t\t// Afegim tooltips\n\t\t$(\".data-table-\" + obj.layer.options.businessId\n\t\t\t+ \".leaflet-data-table\").tooltip({\n\t\t\tplacement : 'bottom',\n\t\t\tcontainer : 'body',\n\t\t\ttitle : window.lang.translate(\"dades\")\n\t\t});\n\n\t\t$(\".opcio-conf\").tooltip({\n\t\t\tplacement : 'bottom',\n\t\t\tcontainer : 'body',\n\t\t\ttitle : window.lang.translate(\"opcions\")\n\t\t});\n\n\t\tif (getModeMapa()){\n\t\t\ttry{\n\t\t\t\tupdateEditableElements();\n\t\t\t\trefreshSortablesElements();\n\t\t\t\tmap.fireEvent('addItemFinish');\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,\"add\",true);}\t\n\t\t\t\t\n\t\t\t\t//generallegendaMapaEdicio();\n\t\t\t\t\n\t\t\t}catch(Err){\n\t\t\t\tupdateEditableElements();\n\t\t\t}\n\t\t}\n\t\treturn _menu_item_checkbox;\n\t},\n\t\n\t_createSubItem : function(sublayer, layerIdParent, modeMapa) {\n\t\tvar row_sublayer = L.DomUtil.create('div',\n\t\t\t\t'leaflet-row leaflet-subrow');\n\n\t\tvar label_sublayer, \n\t\t\tinput_sublayer, checked = this._map.hasLayer(sublayer.layer);\n\n\t\tif(sublayer.layer.error){\n\t\t\tlabel_sublayer = L.DomUtil.create('label', 'error');\n\t\t}else{\n\t\t\tlabel_sublayer = L.DomUtil.create('label', '');\n\t\t}\n\t\tlabel_sublayer.id =  'lblsub-'+ sublayer.layer.options.businessId;\t\t\n\t\t\t\t\n\t\tinput_sublayer = L.DomUtil.create('input');\n\t\tinput_sublayer.id = 'input-'\n\t\t\t\t+ sublayer.layer.options.businessId;\n\t\tinput_sublayer.type = 'checkbox';\n\t\tinput_sublayer.className = 'checkbox_eye hide leaflet-control-layers-selector';\n\t\tinput_sublayer.defaultChecked = checked;\n\n\t\tinput_sublayer.layerId = L.stamp(sublayer.layer);\n\t\tinput_sublayer.layerIdParent = layerIdParent; // input.layerId;\n\n\t\tL.DomEvent.on(input_sublayer, 'click', this._onInputClick, this);\n\n\t\tvar name_sublayer = document.createElement('span');\n\t\tname_sublayer.className = 'editable';\n\t\tname_sublayer.idParent = layerIdParent;\n\t\tname_sublayer.id = L.stamp(sublayer.layer);\n\t\tvar layerName=sublayer.name;\t\t\t\n    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\t\n \n\t\tname_sublayer.innerHTML = ' ' + layerName;\n\n\t\tvar col_sublayer = L.DomUtil.create('div', 'leaflet-input');\n\t\tvar label_for = document.createElement('label');\n\t\tvar _for = document.createAttribute('for');\n\t\t_for.value = 'input-' + sublayer.layer.options.businessId;\n\t\tlabel_for.setAttributeNode(_for);\n\t\tcol_sublayer.appendChild(input_sublayer);\n\t\tcol_sublayer.appendChild(label_for);\n\n\t\trow_sublayer.appendChild(col_sublayer);\n\t\tcol_sublayer = L.DomUtil.create('div', 'leaflet-name');\n\t\tcol_sublayer.appendChild(label_sublayer);\n\t\trow_sublayer.appendChild(col_sublayer);\n\t\tlabel_sublayer.appendChild(name_sublayer);\n\n\t\tif (modeMapa) {\n\t\t\tcol_sublayer = L.DomUtil.create('span','leaflet-remove glyphicon glyphicon-remove opcio-conf');\n\t\t\tL.DomEvent.on(col_sublayer, 'click', this._onRemoveClick, this);\n\t\t\tcol_sublayer.layerId = input_sublayer.layerId;\n\t\t\tcol_sublayer.layerIdParent = layerIdParent;\n\t\t\trow_sublayer.appendChild(col_sublayer);\n\t\t\t\t\n\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(sublayer.layer.options,\"add\",true);}\t\n\t\t}\n\t\treturn row_sublayer;\n\t},\n\n\tgetCountActiveLayers:function(){\n\t\tvar i, input, obj, \n\t\tinputs = this._form.getElementsByTagName('input'), \n\t\tinputsLen = inputs.length;\n\t\tvar j=0;\n\t\tfor (i = 0; i < inputsLen; i++) {\n\t\t\tinput = inputs[i];\n\t\t\tif (!input.layerId) {\n\t\t\t\tcontinue;\n\t\t\t} else{\n\t\t\t\t\n\t\t\t\tif (input.checked){\n\t\t\t\t\tj=j+1;\n\t\t\t\t\tobj=input.id.replace(\"input-\", \"\");\n\t\t\t\t}\t\n\t\t\t\t\t\n\t\t\t}\n\t\t\n\t\t}\n\t\treturn {total:j, lastActive:obj};\n\t},\t\n\t\n\t_onInputClick : function(event) {\n\t\tvar i, input, obj, \n\t\tinputs = this._form.getElementsByTagName('input'), \n\t\tinputsLen = inputs.length;\n\n\t\tthis._handlingClick = true;\n\t\tvar checkHeat = false;\n\t\tvar id, parentId;\n\n\t\tvar currentbid = arguments[0].currentTarget.id.replace(\"input-\", \"\");\n\t\t\n\t\t// tractament en cas heatmap\n\t\tif (arguments[0].currentTarget.layerIdParent) {\n\t\t\tid = arguments[0].currentTarget.layerId;\n\t\t\tparentId = arguments[0].currentTarget.layerIdParent;\n\t\t\tcheckHeat = isHeat(controlCapes._layers[parentId]._layers[id])\n\t\t\t\t\t&& arguments[0].currentTarget.value == \"on\";\n\t\t}\n\n\t\tvar _timeLayers = [];\n\t\tvar isLegendLoad=false;\n\t\t\n\t\tfor (i = 0; i < inputsLen; i++) {\n\t\t\tinput = inputs[i];\n\t\t\tif (!input.layerId) {\n\t\t\t\tcontinue;\n\t\t\t} else if (!input.layerIdParent) {\n\t\t\t\tobj = this._layers[input.layerId];\n\t\t\t} else {\n\t\t\t\tobj = this._layers[input.layerIdParent]._layers[input.layerId];\n\t\t\t}\n\n\t\t\t// Si la capa clickada es  heatmap i s'ha d'activar, i la que\n\t\t\t// estem tractant tb, no s'ha de mostrar\n\t\t\tif (isHeat(obj) && checkHeat && obj.layer._leaflet_id != id) {\n\t\t\t\tinput.checked = false;\n\t\t\t}\n\t\t\t// valida tipus CapaTime\n\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_wms) != -1) {\n\t\t\t\tif (obj.layer.options.wmstime == true) {\n\t\t\t\t\t_timeLayers.push(input);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(currentbid === obj.layer.options.businessId){\n\t\t\t\t\n\t\t\t\t\t//$.publish('activaLegendTab',{id: currentbid, activo: input.checked});\n\t\t\t\t\tthis._map.fire('activaLegendTab',{id: currentbid, activo: input.checked});\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t// Afegir\n\t\t\tvar canSpiderify = (obj.layer.options.tipusRang == tem_clasic || \n\t\t\t\tobj.layer.options.tipusRang == tem_simple || \n\t\t\t\tobj.layer.options.tipusRang == tem_origen);\n\t\t\tif (input.checked && !this._map.hasLayer(obj.layer)) {\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tthis._map.addLayer(obj.layer);\n\n\t\t\t\tif(this._map.hasOwnProperty(\"oms\") && obj.layer._layers ){\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\t//Add the markers to Spiderify\n\t\t\t\t\tvar keys = Object.keys(obj.layer._layers);\n\t\t\t\t\tvar num = this._map.oms.markers.length;\n\t\t\t\t\tfor(var j=0; j<keys.length; ++j)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tvar aux = obj.layer._layers[keys[j]];\n\t\t\t\t\t\tif(canSpiderify)\n\t\t\t\t\t\t\tthis._map.oms.addMarker(aux);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif(num != this._map.oms.markers.length)\n\t\t\t\t\t\tthis._map.oms.unspiderfy();\n\n\t\t\t\t}\n\n\t\t\t\t//Mostrem els labels\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\n\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\n\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\t\n\t\t\t\t\t\tvar zoomInicial = \"2\";\n\t\t\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\n\t\t\t\t \t\tvar zoomFinal = \"19\";\n\t\t\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\n\t\t\t\t \t\t\n\t\t\t\t \t\tif ( map.getZoom()>=zoomInicial &&  map.getZoom() <= zoomFinal) {//mostrem labels\n\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\n\t\t\t\t\t\t\t\tif (lay.label!=undefined) {\n\t\t\t\t\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(1);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif(lay._showLabel){\n\t\t\t\t                        lay._showLabel({latlng: lay.label._latlng});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t \t\t }\n\t\t\t\t \t\t else {//amaguem labels\n\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\n\t\t\t\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\t\t\t\tlay.label.setOpacity(0);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t }\t\t\t\t\t\t\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_vis_wms) != -1) {\n\t\t\t\t\tvar optionsUtfGrid = {\n\t\t\t\t\t\tlayers : obj.layer.options.businessId,\n\t\t\t\t\t\tcrs : L.CRS.EPSG4326,\n\t\t\t\t\t\tsrs : \"EPSG:4326\",\n\t\t\t\t\t\ttransparent : true,\n\t\t\t\t\t\tformat : 'utfgrid',\n\t\t\t\t\t\tnom : obj.layer.options.nom + \" utfgrid\",\n\t\t\t\t\t\ttipus : obj.layer.options.tipus,\n\t\t\t\t\t\tbusinessId : obj.layer.options.businessId\n\t\t\t\t\t};\n\t\t\t\t\tvar utfGrid = createUtfGridLayer(obj.layer._url, optionsUtfGrid);\n\t\t\t\t\tthis._map.addLayer(utfGrid);\n\t\t\t\t\tobj.layer.options.utfGridLeafletId = utfGrid._leaflet_id;\n\t\t\t\t}\n\t\t\t\t// Si hem activat capa de tipus tematic categories,\n\t\t\t\t// mostrem la seva llegenda\n\t\t\t\tif (currentbid == obj.layer.options.businessId\n\t\t\t\t\t\t&& obj.layer.options.tipusRang\n\t\t\t\t\t\t&& (obj.layer.options.tipusRang == tem_clasic || obj.layer.options.tipusRang == tem_size)) {\n\t\t\t\t\t//thisLoadMapLegendEdicio(obj.layer);\n\t\t\t\t\tisLegendLoad=true;\n\t\t\t\t}\n\t\t\t\telse if (obj.layer.options.tipus==\"wms\"){//per WMS tb s'ha d'omplir\n\t\t\t\t\t//thisLoadMapLegendEdicio(obj.layer);\n\t\t\t\t\tisLegendLoad=true;\n\t\t\t\t}\t\t\t\t\t\n\t\t\t\telse if (!isLegendLoad){\n\t\t\t\t\t//thisEmptyMapLegendEdicio(obj.layer,true);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif (obj.layer.options.dinamic && (obj.layer.options.tem == tem_clasic || obj.layer.options.tem == tem_size)) {\n\t\t\t\t\t//thisLoadMapLegendEdicioDinamic(obj.layer);\n\t\t\t\t\tisLegendLoad=true;\n\t\t\t\t}\n\t\t\t\telse if(!isLegendLoad){\n\n\t\t\t\t//thisEmptyMapLegendEdicio(obj.layer,true);\n\t\t\t\t}\n\t\t\t\t//mirem vista 3D\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,'display',true);}\n\t\t\t\n\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\t} else if (!input.checked && this._map.hasLayer(obj.layer)) {\n\t\t\t\t//Amaguem els labels\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\n\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\n\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\n\t\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\t\tlay.label.setOpacity(0);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t\t// Si es vis_wms, hem d'eliminar tb la capa utfgrid\n\t\t\t\tif (obj.layer.options.tipus && obj.layer.options.tipus.indexOf(t_vis_wms) != -1) {\n\t\t\t\t\tvar utfGridLayer = this._map._layers[obj.layer.options.utfGridLeafletId];\n\t\t\t\t\tthis._map.removeLayer(utfGridLayer);\n\t\t\t\t}\n\n\t\t\t\tthis._map.removeLayer(obj.layer);\n\n\t\t\t\tif(this._map.hasOwnProperty(\"oms\") && obj.layer._layers ){\n\t\t\t\t\n\t\t\t\t\t//Remove the markers from Spiderify\n\t\t\t\t\tvar keys = Object.keys(obj.layer._layers);\n\t\t\t\t\tvar num = this._map.oms.markers.length;\n\t\t\t\t\tfor(var j=0; j<keys.length; ++j)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tvar aux = obj.layer._layers[keys[j]];\n\t\t\t\t\t\tif(canSpiderify)\n\t\t\t\t\t\t\tthis._map.oms.removeMarker(aux);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif(num != this._map.oms.markers.length)\n\t\t\t\t\t\tthis._map.oms.unspiderfy();\n\n\t\t\t\t}\n\n\t\t\t\t// Si hem desactivat capa de tipus tematic categories,\n\t\t\t\t// mostrem la seva llegenda\n\t\t\t\tif (currentbid == obj.layer.options.businessId\n\t\t\t\t\t\t&& obj.layer.options.tipusRang\n\t\t\t\t\t\t&& (obj.layer.options.tipusRang == tem_clasic|| obj.layer.options.tipusRang == tem_size)) {\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (currentbid == obj.layer.options.businessId && obj.layer.options.dinamic && \n\t\t\t\t\t\t(obj.layer.options.tem == tem_clasic || obj.layer.options.tem == tem_size)) {\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\n\t\t\t\t}\n\t\t\t\tif (obj.layer.options.tipus==\"wms\"){\n\t\t\t\t\tthisEmptyMapLegendEdicio(obj.layer);\n\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\tif(estatMapa3D){mapaVista3D.actualitzaVistaOverlays(obj.layer.options,'display',false);}\n\t\t\t}\n\t\t}\n\t\tthis._validateWmsTime(_timeLayers);\n\t\tthis._handlingClick = false;\n\t\tthis._refocusOnMap();\n\t},\n\n\t_validateWmsTime : function(_timeLayers) {\n\t\tvar _thereIs = false;\n\t\tfor (j = 0; j < _timeLayers.length; j++) {\n\t\t\tif (_timeLayers[j].checked) {\n\t\t\t\t_thereIs = true;\n\t\t\t}\n\t\t}\n\t\tshowTimeControl(_thereIs);\n\t},\n\n\t_onUpClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar inputs = this._form.getElementsByTagName('input');\n\t\tvar obj = this._layers[layerId];\n\n\t\tif (!obj.overlay) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar replaceLayer = null;\n\t\tfor (var i = 0; i < inputs.length; i++) {\n\t\t\tif (!inputs[i].layerIdParent) {\n\t\t\t\tvar auxLayer = this._layers[inputs[i].layerId];\n\t\t\t\tif (auxLayer.overlay\n\t\t\t\t\t\t&& ((obj.layer.options.zIndex - 1) === auxLayer.layer.options.zIndex)) {\n\t\t\t\t\treplaceLayer = auxLayer;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar newZIndex = obj.layer.options.zIndex - 1;\n\t\tif (replaceLayer) {\n\n\t\t\tif (typeof url('?businessid') == \"string\") {\n\t\t\t\tvar data = {\n\t\t\t\t\tuid : Cookies.get('uid'),\n\t\t\t\t\tbusinessId : url('?businessid'),\n\t\t\t\t\tservidorWMSbusinessId : obj.layer.options.businessId\n\t\t\t\t\t\t\t+ ','\n\t\t\t\t\t\t\t+ replaceLayer.layer.options.businessId,\n\t\t\t\t\torder : newZIndex + ',' + (newZIndex + 1)\n\t\t\t\t};\n\n\t\t\t\tupdateServersOrderToMap(data).then(function(results) {\n\t\t\t\t\tif (results.status != 'OK')\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\n\t\t\t\t\t// no es faci tampoc a client, i es\n\t\t\t\t\t// mostri un error\n\t\t\t\t}, function(results) {\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\n\t\t\t\t\t// faci tampoc a client, i es mostri un\n\t\t\t\t\t// error\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tobj.layer.options.zIndex = newZIndex;\n\t\t\treplaceLayer.layer.options.zIndex = newZIndex + 1;\n\n\t\t\tthis._map.fire('changeorder', obj, this);\n\t\t}\n\t},\n\n\t_onDownClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar inputs = this._form.getElementsByTagName('input');\n\t\tvar obj = this._layers[layerId];\n\n\t\tif (!obj.overlay) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar replaceLayer = null;\n\t\tfor (var i = 0; i < inputs.length; i++) {\n\t\t\tif (!inputs[i].layerIdParent) {\n\t\t\t\tvar auxLayer = this._layers[inputs[i].layerId];\n\t\t\t\tif (auxLayer.overlay\n\t\t\t\t\t\t&& ((obj.layer.options.zIndex + 1) === auxLayer.layer.options.zIndex)) {\n\t\t\t\t\treplaceLayer = auxLayer;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar newZIndex = obj.layer.options.zIndex + 1;\n\t\tif (replaceLayer) {\n\t\t\tif (typeof url('?businessid') == \"string\") {\n\t\t\t\tvar data = {\n\t\t\t\t\tuid : Cookies.get('uid'),\n\t\t\t\t\tbusinessId : url('?businessid'),\n\t\t\t\t\tservidorWMSbusinessId : obj.layer.options.businessId\n\t\t\t\t\t\t\t+ ','\n\t\t\t\t\t\t\t+ replaceLayer.layer.options.businessId,\n\t\t\t\t\torder : newZIndex + ',' + (newZIndex - 1)\n\t\t\t\t};\n\n\t\t\t\tupdateServersOrderToMap(data).then(function(results) {\n\t\t\t\t\tif (results.status != 'OK')\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\n\t\t\t\t\t// no es faci tampoc a client, i es\n\t\t\t\t\t// mostri un error\n\t\t\t\t}, function(results) {\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\n\t\t\t\t\t// faci tampoc a client, i es mostri un\n\t\t\t\t\t// error\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tobj.layer.options.zIndex = newZIndex;\n\t\t\treplaceLayer.layer.options.zIndex = newZIndex - 1;\n\n\t\t\tthis._map.fire('changeorder', obj, this);\n\t\t}\n\t},\n\n\t_onExpandGroup : function(e) {\n\t\tvar cl=e.explicitOriginalTarget;\n\t\tif(!cl){\n\t\t\tcl=e.srcElement;\n\t\t}\n\t\tvar cls=jQuery(cl).attr('class');\n\t\tif(getModeMapa()){\n\t\t\tif(cls && cls.indexOf('label')!=-1){\n\t\t\t\tvar _id = e.currentTarget.id;\n\t\t\t\t_id = _id.replace('lbl_ac_', '_i_');\n\t\t\t\tif ($('#' + _id).hasClass('glyphicon-triangle-bottom')) {\n\t\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-bottom');\n\t\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-right');\n\n\t\t\t\t} else if ($('#' + _id).hasClass('glyphicon-triangle-right')) {\n\t\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-right');\n\t\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-bottom');\n\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\tvar _id = e.currentTarget.id;\n\t\t\t_id = _id.replace('lbl_ac_', '_i_');\n\t\t\tif ($('#' + _id).hasClass('glyphicon-triangle-bottom')) {\n\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-bottom');\n\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-right');\n\t\n\t\t\t} else if ($('#' + _id).hasClass('glyphicon-triangle-right')) {\n\t\t\t\t$('#' + _id).removeClass('glyphicon-triangle-right');\n\t\t\t\t$('#' + _id).addClass('glyphicon-triangle-bottom');\n\t\n\t\t\t}\n\t\t}\n\t\tif (getModeMapa()) {\n\t\t\treOrderGroupsAndLayers(false);\n\t\t}\n\t},\n\n\t_onRemoveGroup : function(e) {\n\t\t$('.tooltip').hide();\n\t\te.stopImmediatePropagation();\n\n\t\t$('#dialog_delete_group').modal('show');\n\t\t$('#dialog_delete_group #nom_group_delete').text(e.currentTarget.groupName);\n\t\t$('#dialog_delete_group .btn-danger').data(\"group\",e.currentTarget);\n\t},\n\n\t_onRemoveClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\n\t\tvar lbusinessId = [];\n\t\tif (!layerIdParent) {\n\t\t\tvar obj = this._layers[layerId];\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t\tfor (i in obj._layers) {\n\t\t\t\tlbusinessId.push(obj._layers[i].layer.options.businessId);\n\t\t\t}\n\t\t} else {\n\t\t\tvar objParent = this._layers[layerIdParent];\n\t\t\tvar obj = objParent._layers[layerId];\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t}\n\n\t\tif (!obj.overlay) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof url('?businessid') == \"string\") {\n\t\t\tvar data = {\n\t\t\t\tbusinessId : url('?businessid'),\n\t\t\t\tuid : Cookies.get('uid'),\n\t\t\t\tservidorWMSbusinessId : lbusinessId.toString()\n\t\t\t};\n\t\t\t$('#dialog_delete_capa').modal('show');\n\t\t\t$('#dialog_delete_capa #nom_capa_delete').text(obj.layer.options.nom);\n\t\t\t$('#dialog_delete_capa .btn-danger').data(\"data\", data);\n\t\t\t$('#dialog_delete_capa .btn-danger').data(\"obj\", obj);\n\t\t}\n\t},\n\n\t_onDeleteClick : function(obj) {\n\t\tvar node = obj.target.parentElement.childNodes[0];\n\t\tn_obj = this._layers[node.layerId];\n\n\t\t// verify if obj is a basemap and checked to not remove\n\t\tif (!n_obj.overlay && node.checked) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this._map.hasLayer(n_obj.layer)) {\n\t\t\tthis._map.removeLayer(n_obj.layer);\n\t\t}\n\t\tthis.removeLayer(n_obj.layer);\n\t\tobj.target.parentNode.remove();\n\n\t\treturn false;\n\t},\n\t\n\t_onEditNameClick : function(e) {\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar obj = this._layers[layerId];\n\t\tif (!obj.overlay) {\n\t\t\treturn;\n\t\t}\n\t},\n\t\n\t_onOpenDataTable : function(e) {\n\t\t$('.tooltip').hide();\n\n\t\t$('#modal_data_table').modal('show');\n\t\tconsole.debug($('#modal_data_table'));\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar obj = this._layers[layerId];\n\t\tdownload_layer = obj;\n\t\tfillModalDataTable(obj);\n\t},\n\n\t_onTransparenciaClick : function(e) {\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar obj = this._layers[layerId];\n\t\tvar op = obj.layer.options.opacity;\n\n\t\top ? op = obj.layer.options.opacity\n\t\t\t\t: op = obj.layer.options.fillOpacity;\n\n\t\tif (!op) {\n\t\t\top = 1;\n\t\t\tobj.layer.options.fillOpacity = 1;\n\t\t} else {\n\t\t\tif (op == 0) {\n\t\t\t\top = 1\n\t\t\t} else {\n\t\t\t\top = (parseFloat(op) - 0.25)\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tobj.layer.setOpacity(op);\n\t\t\tif(estatMapa3D){mapaVista3D.canviaOpacity(obj.layer.options.businessId,op);}\n\t\t} catch (err) {\n\t\t\tobj.layer.options.fillOpacity = op;\n\t\t\tobj.layer.options.opacity = op;\n\t\t}\n\n\t\tif (getModeMapa()) {\n\t\t\tvar data = {\n\t\t\t\tbusinessId : obj.layer.options.businessId, // url('?businessid')\n\t\t\t\tuid : Cookies.get('uid'),\n\t\t\t\topacity : op\n\t\t\t};\n\t\t\tupdateServidorWMSOpacity(data).then(function(results) {\n\t\t\t\tif (results.status === 'OK') {\n\t\t\t\t\t// console.debug(results);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\t_onDownloadClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar obj = this._layers[layerId];\n\t\tdownload_layer = obj;\n\n\t\tif (obj.layer.options.tipusRang\n\t\t\t\t&& (obj.layer.options.tipusRang == tem_cluster || obj.layer.options.tipusRang == tem_heatmap)) {\n\t\t\t$('#modal-body-download-not-available').show();\n\t\t\t$('#modal-body-download-error').hide();\n\t\t\t$('#modal-body-download').hide();\n\t\t\t$('#modal_download_layer .modal-footer').show();\n\t\t\t$('#bt_download_tancar').show();\n\t\t\t$('#bt_download_accept').hide();\n\t\t\t$('#modal_download_layer').modal('show');\n\t\t} else {\n\t\t\t$('#modal-body-download-not-available').hide();\n\t\t\t$('#modal-body-download-error').hide();\n\t\t\t$('#modal-body-download').show();\n\t\t\t$('#modal_download_layer .modal-footer').show();\n\t\t\t$('#bt_download_tancar').hide();\n\t\t\t$('#bt_download_accept').show();\n\t\t\t$('#modal_download_layer').modal('show');\n\t\t}\n\t},\n\t\n\t_onZoomClick: function(e){\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar obj = this._layers[layerId];\n\t\tif (obj.layer._wmsVersion==undefined){\n\t\t\tvar bounds = obj.layer.getBounds();\n\t\t\t!estatMapa3D?map.fitBounds(bounds):mapaVista3D._goToBounds(bounds);\n\t\t}\n\t\telse{\n\t\t\tvar instamapsWms = InstamapsWms({\n\t\t\t\tloadTemplateParam :false});\n\t\t\tvar dataWMS = {url: obj.layer._url};\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\t\t\ttry{\n\t\t\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\n\t\t\t\t\t\tvar bbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar bbox = results.Capability.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else{\n\t\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t\t}\t\n\t\t\t\t} catch (err) {\n\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t}\n\t\t\t\tif (WMS_BBOX !=null) map.fitBounds(WMS_BBOX);\n\t\t\t});\n\t\t}\n\t},\n\t\n\t_hideSpiner: function(){\n\t\t$(this._spiner).hide();\n\t},\n\t\n\t_showSpiner: function(){\n\t\t$(this._spiner).show();\n\t},\n\t\n\t_onEtiquetaClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\n\t\tvar lbusinessId = [];\n\t\tif (!layerIdParent) {\n\t\t\tvar obj = this._layers[layerId];\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t\tfor (i in obj._layers) {\n\t\t\t\tlbusinessId\n\t\t\t\t\t\t.push(obj._layers[i].layer.options.businessId);\n\t\t\t}\n\t\t} else {\n\t\t\tvar objParent = this._layers[layerIdParent];\n\t\t\tvar obj = objParent._layers[layerId];\n\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t}\n\n\t\tif (!obj.overlay) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof url('?businessid') == \"string\") {\n\t\t\tvar data = obj.layer.options;\n\t\t\tif (data!=undefined){\n\t\t\t\tvar dataNames = [];\n\t\t\t\tvar fields = {};\n\t\t\t\tfields[window.lang.translate('Escull el camp')] = '---';\n\t\t\t\t\t\t\t\t\n\t\t\t\tif (data.propName!=undefined && data.propName!='null' && data.propName!='') {\n\t\t\t\t\tvar propName = data.propName;\n\t\t\t\t\tif(typeof (propName)==\"string\"){\t\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tdataNames = JSON.parse(propName);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\tdataNames = propName;\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}else{\t\t\t\n\t\t\t\t\t\tdataNames = propName;\t\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t\tif (typeof (dataNames)==\"string\"){\n\t\t\t\t\t\t var dataNamesSplit=dataNames.split(\",\");\n\t\t\t\t\t\t jQuery.each(dataNamesSplit, function( index, value ) {\n\t\t\t\t\t\t\t\tif (value!='') \tfields[value] = value;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\t\t\t\t\tif (value!='') \tfields[value] = value;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tfields['nom']='nom';\n\t\t\t\t\tfields['text']='text';\n\t\t\t\t}\n\t\t\t\t//creamos el select con los campos\n\t\t\t\tvar source1 = jQuery(\"#etiquetes-layers-fields\").html();\n\t\t\t\tvar template1 = Handlebars.compile(source1);\n\t\t\t\tvar html1 = template1({fields:fields});\n\t\t\t\tjQuery('#dataFieldEtiqueta').html(html1);\n\t\t\t\t$('#dialog_etiquetes_capa').modal('show');\n\t\t\t\t//console.debug(obj.layer.options);\n\t\t\t\t$('#dialog_etiquetes_capa #nom_capa_etiqueta').text(obj.layer.options.nom);\n\t\t\t\t//console.debug(obj.layer);\n\t\t\t\t$('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(obj.layer.options.businessId);\n\t\t\t\t$('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val(obj.layer._leaflet_id);\n\t\t\t\t$('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val(layerId);\n\t\t\t\t//Si tenim al camp options informació de les etiquetes ho marquem en el formulari\n\t\t\t\tif (obj.layer.options.campEtiqueta!=undefined)\t$('#dataFieldEtiqueta option[value='+obj.layer.options.campEtiqueta+']').attr('selected','selected');\n\t\t\t\telse $('#dataFieldEtiqueta option[value=---]').attr('selected','selected');\n\t\t\t\tif (obj.layer.options.fontFamily!=undefined)\t$('#font-family option[value='+obj.layer.options.fontFamily+']').attr('selected','selected');\n\t\t\t\telse $('#font-family option[value='+obj.layer.options.fontFamily+']').attr('selected','selected');\n\t\t\t\tif (obj.layer.options.fontSize!=undefined)\t$('#font-size option[value='+obj.layer.options.fontSize+']').attr('selected','selected');\n\t\t\t\telse $('#font-size option[value=Arial]').attr('selected','selected');\n\t\t\t\tif (obj.layer.options.fontStyle!=undefined)\t$('#font-style option[value='+obj.layer.options.fontStyle+']').attr('selected','selected');\n\t\t\t\telse $('#font-style option[value=10px]').attr('selected','selected');\n\t\t\t\tif (obj.layer.options.fontColor!=undefined)\t$('#dv_color_etiqueta').css('background-color',obj.layer.options.fontColor);\n\t\t\t\telse \t$('#dv_color_etiqueta').css('background-color','#000000');\n\t\t\t\tif (obj.layer.options.caixaColor!=undefined)\t$('#dv_color_caixa_etiqueta').css('background-color',obj.layer.options.caixaColor);\n\t\t\t\telse \t$('#dv_color_caixa_etiqueta').css('background-color','#000000');\n\t\t\t\tif (obj.layer.options.opcionsVisEtiqueta!=undefined) $('input:radio[name=etiqueta][value='+obj.layer.options.opcionsVisEtiqueta+']').attr('checked', true);\n\t\t\t\telse $('input:radio[name=etiqueta][value=etiquetageom]').attr('checked', true);\n\t\t\t\tvar zoomInicial = \"2\";\n\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\n\t\t \t\tvar zoomFinal = \"19\";\n\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\n\t\t \t\t//Omplim els camps amb el que hi ha guardat a la BBDD\n\t\t \t\t var tooltip = function(sliderObj, ui){\n\t\t \t\t\t \t\n\t\t                val1            = '<div id=\"slider_tooltip\" style=\"font-size:10px;\">'+ zoomInicial +'</div>';\n\t\t                val2            = '<div id=\"slider_tooltip\" style=\"font-size:10px;\">'+ zoomFinal +'</div>';\n\t\t                if (ui.values[0]==zoomInicial)  sliderObj.children('.ui-slider-handle').first().html(val1);\n\t\t                else  sliderObj.children('.ui-slider-handle').first().html('');\n\t\t                if (ui.values[1]==zoomFinal)   sliderObj.children('.ui-slider-handle').last().html(val2);\n\t\t                else  sliderObj.children('.ui-slider-handle').last().html('');\n\t\t            };\n\t\t\t\t$( \"#slider\" ).slider({\n\t\t\t\t\trange:true,\n\t\t\t        min: 2,\n\t\t\t        max: 19,\t\t\t \n\t\t\t        values: [parseInt(zoomInicial),parseInt(zoomFinal)],\n\t\t\t        change:function(event,ui){\n\t\t            \t//tooltip($(this),ui);  \n\t\t            },\n\t\t\t        start: function( event, ui ) {\n\t\t\t        \t$('#slider .ui-slider-handle').first().tooltip('destroy');\t\t\t        \n\t\t\t        \t$('#slider .ui-slider-handle').last().tooltip('destroy');\n\t\t\t        \t\n\t\t\t        },\n\t\t\t        stop: function( event, ui ) {\n\t\t\t        \t$('#slider .ui-slider-handle').first().html('');\n\t\t\t        \t$('#slider .ui-slider-handle').last().html('');\t\n\t\t\t            //alert(  ui.values[ 0 ] + \" - \" + ui.values[ 1 ] );\n\t\t\t             $('#slider .ui-slider-handle').first().tooltip({title: ui.values[0], trigger: 'manual', placement: 'bottom'}).tooltip(\"show\");\n\t\t\t            $('#slider .ui-slider-handle').last().tooltip({title: ui.values[1], trigger: 'manual', placement: 'bottom'}).tooltip(\"show\");\n\t\t\t         }    \n\t\t\t       }\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t$('#dialog_etiquetes_capa .btn-success').on('click', function (e) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\tif (jQuery('#dataFieldEtiqueta').val()!=undefined && jQuery('#dataFieldEtiqueta').val()==\"---\"){\n\t\t\t\t\t\talert(\"Cal escollir un camp per etiquetar\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar capaLeafletId = $('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val();\n\t\t\t\t\t\tvar capaLeafletIdControl = $('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val();\n\t\t\t\t\t\tvar color = rgb2hex($('#dv_color_etiqueta').css('background-color'));\n\t\t\t\t\t\tvar caixaColor  = rgb2hex($('#dv_color_caixa_etiqueta').css('background-color'));\n\t\t\t\t\t\tvar sliderVals =$(\"#slider\").slider(\"values\");\n\t\t\t\t\t\tvar options = {\n\t\t\t\t\t\t\t\tcampEtiqueta:jQuery('#dataFieldEtiqueta').val(),\n\t\t\t\t\t\t\t\tfontFamily:jQuery('#font-family').val(),\n\t\t\t\t\t\t\t\tfontSize:jQuery('#font-size').val(),\n\t\t\t\t\t\t\t\tfontStyle:jQuery('#font-style').val(),\n\t\t\t\t\t\t\t\tfontColor:color,\n\t\t\t\t\t\t\t\topcionsVis:$(\"input[name=etiqueta]:checked\").val(),\n\t\t\t\t\t\t\t\tcaixaColor: caixaColor,\n\t\t\t\t\t\t\t\tcontorn:$(\"input[name=contorn]:checked\").val(),\n\t\t\t\t\t\t\t\tcaixa:$(\"input[name=caixeti]:checked\").val(),\n\t\t\t\t\t\t\t\tzoomInicial:sliderVals[0],\n\t\t\t\t\t\t\t\tzoomFinal:sliderVals[1]\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar layerMap=map._layers[capaLeafletId];\n\t\t\t\t\t\tvar optionsMap;\n\t\t\t\t\t\tif (layerMap==undefined) {\n\t\t\t\t\t\t\tlayerMap = controlCapes._layers[capaLeafletId];\n\t\t\t\t\t\t\toptionsMap=layerMap.layer.options;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse optionsMap=layerMap.options;\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar data={\n\t\t\t\t\t\t\t\tbusinessId: $('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(),\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\t\t\toptions:  JSON.stringify(options),\n\t\t\t\t\t\t\t\tnom:optionsMap.nom,\n\t\t\t\t\t\t\t\ttipus:optionsMap.tipusRang,\n\t\t\t\t\t\t\t\tgeometryType:optionsMap.geometryType\n\t\t\t\t\t\t};\n\t\t\t\t\t\tupdateVisualitzacioLayer(data).then(function(results){\n\t\t\t\t\t\t\t$('#dialog_etiquetes_capa').modal('hide');\n\t\t\t\t\t\t\treloadVisualitzacioLayer(layerMap, results.visualitzacio, results.layer, map).then(function(results) {\n\t\t\t\t\t\t\t\t//refresh zoom etiquetes\n\t\t\t\t\t\t\t\trefrescarZoomEtiquetes(results);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t},\n\t\n\t_onRefreshClick : function(e) {\n\t\t$('.tooltip').hide();\n\t\tconsole.debug(e.currentTarget);\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar layerIdParent = e.currentTarget.layerIdParent;\n\t\tconsole.debug(this._layers);\n\t\tvar obj = this._layers[layerIdParent]._layers[layerId];\n\t\t//Refrescar els temàtics: eliminem sublayer del mapa, i recarreguem\n\t\tmap.removeLayer(obj.layer);\n\t\tloadVisualitzacioLayer(obj.layer);\n\t},\n\n\t_showOptions : function(e) {\n\t\tvar layerId = e.currentTarget.layerId;\n\t\tvar inputs = this._form.getElementsByTagName('input');\n\t\tvar obj = this._layers[layerId];\n\t\tshowConfOptions(obj.layer.options.businessId);\n\t},\n\n\t_expand : function() {\n\t\tL.DomUtil.addClass(this._container,\n\t\t\t\t'leaflet-control-layers-expanded');\n\t},\n\n\t_collapse : function() {\n\t\tthis._container.className = this._container.className.replace(\n\t\t\t\t' leaflet-control-layers-expanded', '');\n\t}\n});\n\t\t\t\t\t\t\nL.control.orderlayers = function(baseLayers, overlays, options) {\n\treturn new L.Control.OrderLayers(baseLayers, overlays, options);\n};\n\nfunction isHeat(obj) {\n\treturn (obj.layer.options.tipusRang && obj.layer.options.tipusRang\n\t\t\t.indexOf('heatmap') != -1);\n}\n\nfunction showConfOptions(businessId) {\n\tjQuery(\".conf-\" + businessId + \"\").toggle(\"fast\");\n\taddTooltipsConfOptions(businessId);\n}\n\nfunction updateCheckStyle() {\n\t$('.leaflet-input input').iCheck({\n\t\tcheckboxClass : 'icheckbox_flat-blue',\n\t\tradioClass : 'iradio_flat-blue'\n\t});\n}\n\nfunction thisFillModalDataTable(obj) {\n\tfillModalDataTable(obj);\n}\n\nfunction thisLoadMapLegendEdicio(obj) {\n\tif (getModeMapa()){\n\t\tloadMapLegendEdicio(obj);\n\t}\n}\n\nfunction thisLoadMapLegendEdicioDinamic(obj) {\n\tif (getModeMapa()){\n\t\tloadMapLegendEdicioDinamics(obj);\n\t}\n}\n\nfunction thisEmptyMapLegendEdicio(obj,isOrigen) {\n\tif (getModeMapa()){\n\t\temptyMapLegendEdicio(obj,isOrigen);\n\t}\n}\n","/*\nBased on git@github.com:stefanocudini/leaflet-search.git \n\n*/\n\n\n(function() {\n\nL.Control.Search = L.Control.extend({\n\tincludes: L.Mixin.Events,\n\n\toptions: {\n\t\turl: '',\t\t\t\t\t//url for search by ajax request, ex: \"search.php?q={s}\"\n\t\tjsonpParam: null,\t\t\t//jsonp param name for search by jsonp service, ex: \"callback\"\n\t\tlayer: null,\t\t\t\t//layer where search markers(is a L.LayerGroup)\t\t\n\t\tcallData: null,\t\t\t\t//function that fill _recordsCache, passed searching text by first param and callback in second\n\t\t//TODO important! implements uniq option 'sourceData' that recognizes source type: url,array,callback or layer\t\t\n\t\t//TODO implement can do research on multiple sources\n\t\tpropertyName: 'title',\t\t//property in marker.options(or feature.properties for vector layer) trough filter elements in layer\n\t\tpropertyLoc: 'loc',\t\t\t//field name for remapping location, using array: ['latname','lonname'] for select double fields(ex. ['lat','lon'] )\n\t\t//TODO implement sub property filter for propertyName,propertyLoc like this:  \"prop.subprop.title\"\n\t\tcallTip: null,\t\t\t\t//function that return row tip html node(or html string), receive text tooltip in first param\n\t\tfilterJSON: null,\t\t\t//callback for filtering data to _recordsCache\n\t\tminLength: 1,\t\t\t\t//minimal text length for autocomplete\n\t\tinitial: true,\t\t\t\t//search elements only by initial text\n\t\tautoType: true,\t\t\t//complete input with first suggested result and select this filled-in text.\n\t\tdelayType: 400,\t\t\t\t//delay while typing for show tooltip\n\t\ttooltipLimit: -1,\t\t\t//limit max results to show in tooltip. -1 for no limit.\n\t\ttipAutoSubmit: true,  \t\t//auto map panTo when click on tooltip\n\t\tautoResize: true,\t\t\t//autoresize on input change\n\t\tautoCollapse: true,\t\t//collapse search control after submit(on button or on tips if enabled tipAutoSubmit)\n\t\t//TODO add option for persist markerLoc after collapse!\n\t\tautoCollapseTime: 1200,\t\t//delay for autoclosing alert and collapse after blur\n\t\tanimateLocation: true,\t\t//animate a circle over location found\n\t\tcircleLocation: true,\t\t//draw a circle in location found\n\t\tmarkerLocation: false,\t\t//draw a marker in location found\n\t\tzoom: null,\t\t\t\t\t//zoom after pan to location found, default: map.getZoom()\n\t\tidInputText : null,\n\t\ttext: 'Cercar...',\t\t\t//placeholder value\t\n\t\ttextCancel: 'Cancel',\t\t//title in cancel button\n\t\ttextErr: 'No trobat',\n\t\ttextEdit:'Edit',//error message\n\t\ttextLoad:'',\n\t\tscope:'visor',\n\t\tposition: 'topcenter'\n\t\t//TODO add option collapsed, like control.layers\n\t},\n//FIXME option condition problem {autoCollapse: true, markerLocation: true} not show location\n//FIXME option condition problem {autoCollapse: false }\n\n\tinitialize: function(options) {\n\t\tL.Util.setOptions(this, options || {});\n\t\tthis._inputMinSize = this.options.text ? this.options.text.length : 10;\n\t\tthis._layer = this.options.layer || new L.LayerGroup();\n\t\tthis._filterJSON = this.options.filterJSON || this._defaultFilterJSON;\n\t\tthis._autoTypeTmp = this.options.autoType;\t//useful for disable autoType temporarily in delete/backspace keydown\n\t\tthis._countertips = 0;\t\t//number of tips items\n\t\tthis._recordsCache = {};\t//key,value table! that store locations! format: key,latlng\n\t},\n\n\tonAdd: function (map) {\n\t\t\n\t\t var $controlContainer = map._controlContainer,\n         nodes = $controlContainer.childNodes,\n         topCenter = false;\n\n\t     for (var i = 0, len = nodes.length; i < len; i++) {\n\t         var klass = nodes[i].className;\n\t         if (/leaflet-top/.test(klass) && /leaflet-center/.test(klass)) {\n\t             topCenter = true;\n\t             break;\n\t         }\n\t     }\n\n\t     if (!topCenter) {\n\t         var tc = document.createElement('div');\n\t         tc.className += 'leaflet-top leaflet-center';\n\t         \n\t         if(this.options.idInputText==null){\n\t        \t $controlContainer.appendChild(tc); \n\t         }else{\n\t        \t jQuery(this.options.idInputText).append(tc);\n\t         }\n\t         map._controlCorners.topcenter = tc;\n\t     }\n\t\t\n\t\tthis._map = map;\n\t\tthis._container = L.DomUtil.create('div', 'leaflet-control-search');\n\t\t\n\t\tthis._cancel = this._createCancel(this.options.textCancel, 'search-cancel');\n//\t\tthis._button = this._createButton(this.options.text, 'search-button glyphicon glyphicon-search grisfort');\n\t\tthis._input = this._createInput(this.options.text, 'search-input');\n\t\tthis._icon= this._createIcon('fa fa-search iconSearch');\n\t\tthis._tooltip = this._createTooltip('search-tooltip');\n\t\tthis._alert = this._createAlert('search-alert');\n\t\tthis._edit = this._createEdit(this.options.textEdit,'search-edit');\n\t\tthis._loadv = this._createLoad(this.options.textLoad,'search-load');\n\t\t\n\t\t\n\t\tif(this.options.circleLocation || this.options.markerLocation) {\n\t\t\t//this._markerLoc = new SearchMarker([0,0], {marker: this.options.markerLocation});//see below\n\t\t\t//Mira si és icona\n\t\t\tvar defaultPunt= L.AwesomeMarkers.icon(default_marker_style);\n//\t\t\tconsole.debug(defaultPunt);\n\t\t\tif(!defaultPunt.options.isCanvas){\n\t\t\t\tthis._markerLoc=L.marker([0,0],\n\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t tipus: t_marker});\n\t\t\t}else{\n\t\t\t\t//Si és cercle sense glifon\n\t\t\t\tthis._markerLoc= L.circleMarker([0,0],\n\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \n\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\n\t\t\t\t\t\t  color :  defaultPunt.options.color,\n\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\n\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\n\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\n\t\t\t\t\t\t  tipus: t_marker}\n\t\t\t\t\t\t\n\t\t\t\t);\n\t\t\t}\n\t    }\n\t\t\n\t\t//this.setLayer( this._layer );\n\t\t\n\t\tmap.on({'resize':this._handleAutoresize()}, this);\n\t\t \n\t\treturn this._container;\n\t},\n\n\tonRemove: function(map) {\n\t\tthis._recordsCache = {};\n\t\t// map.off({\n\t\t// \t\t'layeradd': this._onLayerAddRemove,\n\t\t// \t\t'layerremove': this._onLayerAddRemove\n\t\t// \t}, this);\n\t},\n\n\t// _onLayerAddRemove: function(e) {\n\t// \t//console.info('_onLayerAddRemove');\n\t// \t//without this, run setLayer also for each Markers!! to optimize!\n\t// \tif(e.layer instanceof L.LayerGroup)\n\t// \t\tif( L.stamp(e.layer) != L.stamp(this._layer) )\n\t// \t\t\tthis.setLayer(e.layer);\n\t// },\n\t\n\tsetLayer: function(layer) {\t//set search layer at runtime\n\t\t//this.options.layer = layer; //setting this, run only this._recordsFromLayer()\n\t\tthis._layer = layer;\n\t\tthis._layer.addTo(this._map);\n\t\tif(this._markerLoc)\n\t\t\tthis._layer.addLayer(this._markerLoc);\n\t\treturn this;\n\t},\n\t\n\tshowAlert: function(text) {\n\t\ttext = text || this.options.textErr;\n\t\tthis._alert.style.display = 'block';\n\t\tthis._alert.innerHTML = text;\n\t\tclearTimeout(this.timerAlert);\n\t\tvar that = this;\t\t\n\t\tthis.timerAlert = setTimeout(function() {\n\t\t\tthat.hideAlert();\n\t\t},this.options.autoCollapseTime);\n\t\t$.publish('analyticsEvent',{event:[this.options.scope,'input#cercaTopoFAIL',this._input.value, 8]});\n\t\treturn this;\n\t},\n\t\n\t\n\tshowLoad: function(text) {\n\t\ttext = text || this.options.textLoad;\n\t\tthis._loadv.style.display = 'block';\n\t\tthis._loadv.innerHTML = text;\n\t\tclearTimeout(this.timerAlert);\n\t\tvar that = this;\t\t\n\t\tthis.timerAlert = setTimeout(function() {\n\t\t\tthat.hideAlert();\n\t\t},this.options.autoCollapseTime);\n\t\treturn this;\n\t},\n\t\n\thideLoad: function() {\n\t\tthis._loadv.style.display = 'none';\n\t\treturn this;\n\t},\n\t\n\t\n\tshowEdit: function(text) {\n\t\ttext = text || this.options.textEdit;\n\t\t\n\t\tthis._edit.style.display = 'block';\n\t\tthis._edit.innerHTML = text;\n\t\t//clearTimeout(this.timerAlert);\n\t\tvar that = this;\t\t\n\t\t\n\t\treturn this;\n\t},\n\t\n\thideAlert: function() {\n\t\tthis._alert.style.display = 'none';\n\t\treturn this;\n\t},\n\t\t\n\thideEdit: function() {\n\t\tthis._edit.style.display = 'none';\n\t\treturn this;\n\t},\n\t\n\tcancel: function() {\n\t\tthis._input.value = '';\n\t\t//this._handleKeypress({keyCode:46});//simulate backspace keypress\n\t\t//this._input.focus();\n\t\tthis._cancel.style.display = 'none';\n\t\treturn this;\n\t},\n\t\n\texpand: function() {\t\t\n\t\tthis._input.style.display = 'block';\n\t\tL.DomUtil.addClass(this._container, 'search-exp');\t\n\t\tthis._input.focus();\n\t\tthis._map.on('dragstart', this.collapse, this);\n\t\treturn this;\t\n\t},\n\n\tcollapse: function() {\n\t\tthis._hideTooltip();\n\t\tthis.cancel();\n\t\tthis._alert.style.display = 'none';\n\t\tthis._input.style.display = 'block';\n\t\tthis._input.blur();\n\t\tthis._cancel.style.display = 'none';\n\t\tL.DomUtil.removeClass(this._container, 'search-exp');\t\t\n\t\t//this._markerLoc.hide();//maybe unuseful\n\t\tthis._map.off('dragstart', this.collapse, this);\n\t\tthis.fire('search_collapsed');\n\t\treturn this;\n\t},\n\t\n\tcollapseDelayed: function() {\t//collapse after delay, used on_input blur\n\t\tif (!this.options.autoCollapse) return this;\n\t\tvar that = this;\n\t\tclearTimeout(this.timerCollapse);\n\t\tthis.timerCollapse = setTimeout(function() {\n\t\t\tthat.collapse();\n\t\t}, this.options.autoCollapseTime);\n\t\treturn this;\t\t\n\t},\n\n\tcollapseDelayedStop: function() {\n\t\tclearTimeout(this.timerCollapse);\n\t\treturn this;\t\t\n\t},\n\n////start DOM creations\n\t_createAlert: function(className) {\n\t\tvar alert = L.DomUtil.create('div', className, this._container);\n\t\talert.style.display = 'none';\n\n\t\tL.DomEvent\n\t\t\t.on(alert, 'click', L.DomEvent.stop, this)\n\t\t\t.on(alert, 'click', this.hideAlert, this);\n\n\t\treturn alert;\n\t},\n\t\n\t_createEdit: function(text,className) {\n\t\tvar edit = L.DomUtil.create('div', className, this._container);\n\t\tedit.style.display = 'none';\n\t\tedit.innerHTML = text;\n\t\t//L.DomEvent.on(edit, 'click', L.DomEvent.stop, this);\n\t\t\t//.on(edit, 'click', this.hideEdit, this);\n\n\t\treturn edit;\n\t},\n\t\n\t_createLoad: function(text,className) {\n\t\tvar loadv = L.DomUtil.create('div', className, this._container);\n\t\tloadv.style.display = 'none';\n\t\tloadv.innerHTML = text;\n\t\t//L.DomEvent.on(load, 'click', L.DomEvent.stop, this);\n\t\t\t//.on(edit, 'click', this.hideEdit, this);\n\n\t\treturn loadv;\n\t},\n\n\t_createInput: function (text, className) {\n\t\tvar input = L.DomUtil.create('input', className, this._container);\n\t\tinput.type = 'text';\n\t\tinput.size = this._inputMinSize;\n\t\tinput.value = '';\n\t\tinput.autocomplete = 'off';\n\t\tinput.placeholder = text;\n\t\tinput.style.display = 'block';\n\t\tinput.lang = 'ca';\n\t\tinput.id = 'search-input';\n\t\t\n\t\t\n\t\tL.DomEvent\n\t\t\t.disableClickPropagation(input)\n\t\t\t.on(input, 'keyup', this._handleKeypress, this)\n\t\t\t.on(input, 'keydown', this._handleAutoresize, this)\n\t\t\t.on(input, 'blur', this.collapseDelayed, this)\n\t\t\t.on(input, 'focus', this.collapseDelayedStop, this);\n\t\t\n\t\treturn input;\n\t},\n\n\t_createCancel: function (title, className) {\n\t\tvar cancel = L.DomUtil.create('a', className, this._container);\n\t\tcancel.href = '#';\n\t\tcancel.title = title;\n\t\tcancel.style.display = 'none';\n\t\tcancel.innerHTML = \"<span>&otimes;</span>\";//imageless(see css)\n\n\t\tL.DomEvent\n\t\t\t.on(cancel, 'click', L.DomEvent.stop, this)\n\t\t\t.on(cancel, 'click', this.cancel, this);\n\n\t\treturn cancel;\n\t},\n\t\n\t_createButton: function (title, className) {\n\t\tvar button = L.DomUtil.create('a', className, this._container);\n\t\tbutton.href = '#';\n\t\tbutton.title = title;\n\n\t\tL.DomEvent\n\t\t\t.on(button, 'click', L.DomEvent.stop, this)\n\t\t\t.on(button, 'click', this._handleSubmit, this)\t\t\t\n\t\t\t.on(button, 'focus', this.collapseDelayedStop, this)\n\t\t\t.on(button, 'blur', this.collapseDelayed, this);\n\n\t\treturn button;\n\t},\n\n\t_createTooltip: function(className) {\n\t\tvar tool = L.DomUtil.create('div', className, this._container);\n\t\ttool.style.display = 'none';\n\n\t\tvar that = this;\n\t\tL.DomEvent\n\t\t\t.disableClickPropagation(tool)\n\t\t\t.on(tool, 'blur', this.collapseDelayed, this)\n\t\t\t.on(tool, 'mousewheel', function(e) {\n\t\t\t\tthat.collapseDelayedStop();\n\t\t\t\tL.DomEvent.stopPropagation(e);//disable zoom map\n\t\t\t}, this)\n\t\t\t.on(tool, 'mouseover', function(e) {\n\t\t\t\tthat.collapseDelayedStop();\n\t\t\t}, this);\n\t\treturn tool;\n\t},\n\n\t_createTip: function(text, val) {//val is object in recordCache, usually is Latlng\n\t\tvar tip;\n\t\t\n\t\tif(this.options.callTip)\n\t\t{\n\t\t\ttip = this.options.callTip(text,val); //custom tip node or html string\n\t\t\tif(typeof tip === 'string')\n\t\t\t{\n\t\t\t\tvar tmpNode = L.DomUtil.create('div');\n\t\t\t\ttmpNode.innerHTML = tip;\n\t\t\t\ttip = tmpNode.firstChild;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttip = L.DomUtil.create('a', '');\n\t\t\ttip.href = '#';\n\t\t\ttip.innerHTML = text;\n\t\t}\n\t\t\n\t\tL.DomUtil.addClass(tip, 'search-tip');\n\t\ttip._text = text; //value replaced in this._input and used by _autoType\n\n\t\tL.DomEvent\n\t\t\t.disableClickPropagation(tip)\t\t\n\t\t\t.on(tip, 'click', L.DomEvent.stop, this)\n\t\t\t.on(tip, 'click', function(e) {\n\t\t\t\tthis._input.value = text;\n\t\t\t\tthis._handleAutoresize();\n\t\t\t\tthis._input.focus();\n\t\t\t\tthis._hideTooltip();\t\n\t\t\t\tif(this.options.tipAutoSubmit)//go to location at once\n\t\t\t\t\tthis._handleSubmit();\n\t\t\t}, this);\n\n\t\treturn tip;\n\t},\n\n\t_createIcon: function ( className) {\n\t\tvar icon = L.DomUtil.create('i', className, this._container);\n\t\ticon.id = 'searchIcon';\n\t\t\n\t\tL.DomEvent\n\t\t.disableClickPropagation(icon)\n\t\t.on(icon, 'click', this._makeSearch,this);\n\t\treturn icon;\n\t},\n//////end DOM creations\n\n\t_filterRecords: function(text) {\t//Filter this._recordsCache case insensitive and much more..\n\t\n\t\tvar regFilter = new RegExp(\"^[.]$|[\\[\\]|()*]\",'g'),\t//remove . * | ( ) ] [\n\t\t\tI, regSearch,\n\t\t\tfrecords = {};\n\n\t\ttext = text.replace(regFilter,'');\t  //sanitize text\n\t\tI = this.options.initial ? '^' : '';  //search only initial text\n\t\t//TODO add option for case sesitive search, also showLocation\n\t\tregSearch = new RegExp(I + text,'i');\n\n\t\t//TODO use .filter or .map\n\t\tfor(var key in this._recordsCache)\n\t\t\tif( regSearch.test(key) )\n\t\t\t\tfrecords[key]= this._recordsCache[key];\n\t\t\n\t\treturn frecords;\n\t},\n\n\tshowTooltip: function() {\n\t\t\n\t\tvar filteredRecords, newTip;\n\n\t\tthis._countertips = 0;\n\t\t\n\t//FIXME problem with jsonp/ajax when remote filter has different behavior of this._filterRecords\n\t\tif(this.options.layer)\n\t\t\tfilteredRecords = this._filterRecords( this._input.value );\n\t\telse\n\t\t\tfilteredRecords = this._recordsCache;\n\t\t\t\n\t\tthis._tooltip.innerHTML = '';\n\t\tthis._tooltip.currentSelection = -1;  //inizialized for _handleArrowSelect()\n\n\t\tfor(var key in filteredRecords)//fill tooltip\n\t\t{\n\t\t\tif(++this._countertips == this.options.tooltipLimit) break;\n\n\t\t\tnewTip = this._createTip(key, filteredRecords[key] );\n\n\t\t\tthis._tooltip.appendChild(newTip);\n\t\t}\n\t\t\n\t\tif(this._countertips > 0)\n\t\t{\n\t\t\tthis._tooltip.style.display = 'block';\n\t\t\tif(this._autoTypeTmp)\n\t\t\t\tthis._autoType();\n\t\t\tthis._autoTypeTmp = this.options.autoType;//reset default value\n\t\t}\n\t\telse\n\t\t\tthis._hideTooltip();\n\n\t\tthis._tooltip.scrollTop = 0;\n\t\treturn this._countertips;\n\t},\n\n\t_hideTooltip: function() {\n\t\tthis._tooltip.style.display = 'none';\n\t\tthis._tooltip.innerHTML = '';\n\t\treturn 0;\n\t},\n\n\t_defaultFilterJSON: function(json) {\t//default callback for filter data\t\n\t\t\n\t\tvar jsonret = {},\n\t\t\tpropName = this.options.propertyName;\n\t\t\tpropLoc = this.options.propertyLoc;\n\n\t\tif( L.Util.isArray(propLoc) )\n\t\t\tfor(var i in json)\n\t\t\t\tjsonret[ json[i][propName] ]= L.latLng( json[i][ propLoc[0] ], json[i][ propLoc[1] ] );\n\t\telse\n\t\t\tfor(var n in json)\n\t\t\t\tjsonret[ json[n][propName] ]= L.latLng( json[n][ propLoc ] );\n\t\t//TODO verify json[n].hasOwnProperty(propName)\n\t\t//throw new Error(\"propertyName '\"+propName+\"' not found in JSON data\");\n\t\treturn jsonret;\n\t},\n\n\t_recordsFromJsonp: function(text, callAfter) {  //extract searched records from remote jsonp service\n\t\t//TODO remove script node after call run\n\t\tvar that = this;\n\t\tL.Control.Search.callJsonp = function(data) {\t//jsonp callback\n\t\t\t\n\t\t\t\n\t\t\tvar fdata = that._filterJSON(data);//_filterJSON defined in inizialize...\n\t\t\t\n\t\t\tcallAfter(fdata);\n\t\t}\n\t\tif (this.options.url.indexOf(\"geocodificador\")>-1) {\n\t\t\t\n\t\t\ttext=escape(text);\n\t\t\t\n\t\t}\n\t\t\t\t\n\t\tvar script = L.DomUtil.create('script','search-jsonp', document.getElementsByTagName('body')[0] ),\t\n\t\t\turl = L.Util.template(this.options.url+'&'+this.options.jsonpParam+'=L.Control.Search.callJsonp', {s: text}); //parsing url\n\t\t\t//rnd = '&_='+Math.floor(Math.random()*10000);\n\t\t\t//TODO add rnd param or randomize callback name! in recordsFromJsonp\n\t\tscript.type = 'text/javascript';\n\t\tscript.src = url;\n\t\treturn this;\n\t\t//may be return {abort: function() { script.parentNode.removeChild(script); } };\n\t},\n\n\t_recordsFromAjax: function(text, callAfter) {\t//Ajax request\n\t\tif (window.XMLHttpRequest === undefined) {\n\t\t\twindow.XMLHttpRequest = function() {\n\t\t\t\ttry { return new ActiveXObject(\"Microsoft.XMLHTTP.6.0\"); }\n\t\t\t\tcatch  (e1) {\n\t\t\t\t\ttry { return new ActiveXObject(\"Microsoft.XMLHTTP.3.0\"); }\n\t\t\t\t\tcatch (e2) { throw new Error(\"XMLHttpRequest is not supported\"); }\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\tvar request = new XMLHttpRequest(),\n\t\t\turl = L.Util.template(this.options.url, {s: text}), //parsing url\n\t\t\t//rnd = '&_='+Math.floor(Math.random()*10000);\n\t\t\t//TODO add rnd param or randomize callback name! in recordsFromAjax\t\t\t\n\t\t\tresponse = {};\n\t\t\n\t\trequest.open(\"GET\", url);\n\t\tvar that = this;\n\t\trequest.onreadystatechange = function() {\n\t\t    if(request.readyState === 4 && request.status === 200) {\n\t\t    \tresponse = JSON.parse(request.responseText);\n\t\t    \tvar fdata = that._filterJSON(response);//_filterJSON defined in inizialize...\n\t\t        callAfter(fdata);\n\t\t    }\n\t\t};\n\t\trequest.send();\n\t\treturn this;   \n\t},\t\n\n\t_recordsFromLayer: function() {\t//return table: key,value from layer\n\t\tvar retRecords = {},\n\t\t\tpropName = this.options.propertyName,\n\t\t\tloc;\n\t\t\n\t\tthis._layer.eachLayer(function(layer) {\n\n\t\t\tif(layer instanceof SearchMarker) return;\n\n\t\t\tif(layer instanceof L.Marker)\n\t\t\t{\n\t\t\t\tif(layer.options.hasOwnProperty(propName))\n\t\t\t\t{\n\t\t\t\t\tloc = layer.getLatLng();\n\t\t\t\t\tloc.layer = layer;\n\t\t\t\t\tretRecords[ layer.options[propName] ] = loc;\t\t\t\n\t\t\t\t\t\n\t\t\t\t}else if(layer.feature.properties.hasOwnProperty(propName)){\n\n\t\t\t\t\tloc = layer.getLatLng();\n\t\t\t\t\tloc.layer = layer;\n\t\t\t\t\tretRecords[ layer.feature.properties[propName] ] = loc;\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.log(\"propertyName '\"+propName+\"' not found in marker\", layer);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if(layer.hasOwnProperty('feature'))//GeoJSON layer\n\t\t\t{\n\t\t\t\tif(layer.feature.properties.hasOwnProperty(propName))\n\t\t\t\t{\n\t\t\t\t\tloc = layer.getBounds().getCenter();\n\t\t\t\t\tloc.layer = layer;\t\t\t\n\t\t\t\t\tretRecords[ layer.feature.properties[propName] ] = loc;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\tconsole.log(\"propertyName '\"+propName+\"' not found in feature\", layer);\t\t\t\n\t\t\t}\n\t\t\t\n\t\t},this);\n\t\t\n\t\treturn retRecords;\n\t},\n\n\t_autoType: function() {\n\t\t\n\t\t//TODO implements autype without selection(useful for mobile device)\n\t\t\n\t\tvar start = this._input.value.length,\n\t\t\tfirstRecord = this._tooltip.firstChild._text,\n\t\t\tend = firstRecord.length;\n\n\t\tif (firstRecord.indexOf(this._input.value) === 0) { // If prefix match\n\t\t\tthis._input.value = firstRecord;\n\t\t\tthis._handleAutoresize();\n\n\t\t\tif (this._input.createTextRange) {\n\t\t\t\tvar selRange = this._input.createTextRange();\n\t\t\t\tselRange.collapse(true);\n\t\t\t\tselRange.moveStart('character', start);\n\t\t\t\tselRange.moveEnd('character', end);\n\t\t\t\tselRange.select();\n\t\t\t}\n\t\t\telse if(this._input.setSelectionRange) {\n\t\t\t\tthis._input.setSelectionRange(start, end);\n\t\t\t}\n\t\t\telse if(this._input.selectionStart) {\n\t\t\t\tthis._input.selectionStart = start;\n\t\t\t\tthis._input.selectionEnd = end;\n\t\t\t}\n\t\t}\n\t},\n\n\t_hideAutoType: function() {\t// deselect text:\n\n\t\tvar sel;\n\t\tif ((sel = this._input.selection) && sel.empty) {\n\t\t\tsel.empty();\n\t\t}\n\t\telse if (this._input.createTextRange) {\n\t\t\tsel = this._input.createTextRange();\n\t\t\tsel.collapse(true);\n\t\t\tvar end = this._input.value.length;\n\t\t\tsel.moveStart('character', end);\n\t\t\tsel.moveEnd('character', end);\n\t\t\tsel.select();\n\t\t}\n\t\telse {\n\t\t\tif (this._input.getSelection) {\n\t\t\t\tthis._input.getSelection().removeAllRanges();\n\t\t\t}\n\t\t\tthis._input.selectionStart = this._input.selectionEnd;\n\t\t}\n\t},\n\t\n\t_handleKeypress: function (e) {\t//run _input keyup event\n\t\tswitch(e.keyCode)\n\t\t{\n\t\t\tcase 27: //Esc\n\t\t\t\tthis.collapse();\n\t\t\tbreak;\n\t\t\tcase 13: //Enter\n\t\t\t\tthis._makeSearch(this);\t\t\t\t\n\t\t\tbreak;\n\t\t\tcase 38://Up\n\t\t\t\tthis._handleArrowSelect(-1);\n\t\t\tbreak;\n\t\t\tcase 40://Down\n\t\t\t\tthis._handleArrowSelect(1);\n\t\t\tbreak;\n\t\t\tcase 37://Left\n\t\t\tcase 39://Right\n\t\t\tcase 16://Shift\n\t\t\tcase 17://Ctrl\n\t\t\t//case 32://Space\n\t\t\tbreak;\n\t\t\tcase 8://backspace\n\t\t\tcase 46://delete\n\t\t\t\tthis._autoTypeTmp = false;//disable temporarily autoType\n\t\t\tbreak;\n\t\t\tdefault://All keys\n\n\t\t}\n\t},\n\t\n\t_makeSearch: function(){\n\t\tif(this._input.value.length)\n\t\t\tthis._cancel.style.display = 'block';\n\t\telse\n\t\t\tthis._cancel.style.display = 'none';\n\n\t\tif(this._input.value.length >= this.options.minLength)\n\t\t{\n\t\t\tvar that = this;\n\t\t\tclearTimeout(this.timerKeypress);\t//cancel last search request while type in\t\t\t\t\n\t\t\t//this.timerKeypress = setTimeout(function() {\t//delay before request, for limit jsonp/ajax request\n\n\t\t\t\tthat._fillRecordsCache();\n\t\t\t\n\t\t\t//}, this.options.delayType);\n\t\t}\n\t\telse\n\t\t\tthis._hideTooltip();\n\t},\n\t\n\t_fillRecordsCache: function() {\n\t\t//that.hideAlert();\n//TODO important optimization!!! always append data in this._recordsCache\n//  now _recordsCache content is emptied and replaced with new data founded\n//  always appending data on _recordsCache give the possibility of caching ajax, jsonp and layersearch!\n//\n//TODO here insert function that search inputText FIRST in _recordsCache keys and if not find results.. \n//  run one of callbacks search(callData,jsonpUrl or options.layer) and run this.showTooltip\n//\n//TODO change structure of _recordsCache\n//\tlike this: _recordsCache = {\"text-key1\": {loc:[lat,lng], ..other attributes.. }, {\"text-key2\": {loc:[lat,lng]}...}, ...}\n//\tin this mode every record can have a free structure of attributes, only 'loc' is required\n\t\tvar inputText = this._input.value,\n\t\t\tthat;\n\t\t\n\t\tL.DomUtil.addClass(this._container, 'search-load');\n\n\t\tif(this.options.callData)\t//CUSTOM SEARCH CALLBACK(USUALLY FOR AJAX SEARCHING)\n\t\t{\n\t\t\tthat = this;\n\t\t\tthis.options.callData(inputText, function(jsonraw) {\n\n\t\t\t\tthat._recordsCache = that._filterJSON(jsonraw);\n\n\t\t\t\tthat.showTooltip();\n\n\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\n\t\t\t});\n\t\t}\n\t\telse if(this.options.url)\t//JSONP/AJAX REQUEST\n\t\t{\tif(this.options.jsonpParam)\n\t\t\t{\n\t\t\t\tthat = this;\n\t\t\t\t\n\t\t\t\tthis._recordsFromJsonp(inputText, function(data) {// is async request then it need callback\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tthat._recordsCache = data;\n\t\t\t\t\tthat.showTooltip();\n\t\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthat = this;\n\t\t\t\tthis._recordsFromAjax(inputText, function(data) {// is async request then it need callback\n\t\t\t\t\tthat._recordsCache = data;\n\t\t\t\t\tthat.showTooltip();\n\t\t\t\t\tL.DomUtil.removeClass(that._container, 'search-load');\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\telse if(this.options.layer)\t//SEARCH ELEMENTS IN PRELOADED LAYER\n\t\t{\n\t\t\tthis._recordsCache = this._recordsFromLayer();\t//fill table key,value from markers into layer\t\t\t\t\n\t\t\tthis.showTooltip();\n\t\t\tL.DomUtil.removeClass(this._container, 'search-load');\n\t\t}\n\t},\n\t\n\t_handleAutoresize: function() {\t//autoresize this._input\n\t    //TODO refact _handleAutoresize now is not accurate\n\t    if (this._input.style.maxWidth != this._map._container.offsetWidth) //If maxWidth isn't the same as when first set, reset to current Map width\n\t        this._input.style.maxWidth = L.DomUtil.getStyle(this._map._container, 'width');\n\n\t\tif(this.options.autoResize && (this._container.offsetWidth + 45 < this._map._container.offsetWidth))\n\t\t\tthis._input.size = this._input.value.length<this._inputMinSize ? this._inputMinSize : this._input.value.length;\n\t},\n\n\t_handleArrowSelect: function(velocity) {\n\t\n\t\tvar searchTips = this._tooltip.hasChildNodes() ? this._tooltip.childNodes : [];\n\t\t\t\n\t\tfor (i=0; i<searchTips.length; i++)\n\t\t\tL.DomUtil.removeClass(searchTips[i], 'search-tip-select');\n\t\t\n\t\tif ((velocity == 1 ) && (this._tooltip.currentSelection >= (searchTips.length - 1))) {// If at end of list.\n\t\t\tL.DomUtil.addClass(searchTips[this._tooltip.currentSelection], 'search-tip-select');\n\t\t}\n\t\telse if ((velocity == -1 ) && (this._tooltip.currentSelection <= 0)) { // Going back up to the search box.\n\t\t\tthis._tooltip.currentSelection = -1;\n\t\t}\n\t\telse if (this._tooltip.style.display != 'none') { // regular up/down\n\t\t\tthis._tooltip.currentSelection += velocity;\n\t\t\t\n\t\t\tL.DomUtil.addClass(searchTips[this._tooltip.currentSelection], 'search-tip-select');\n\t\t\t\n\t\t\tthis._input.value = searchTips[this._tooltip.currentSelection]._text;\n\n\t\t\t// scroll:\n\t\t\tvar tipOffsetTop = searchTips[this._tooltip.currentSelection].offsetTop;\n\t\t\t\n\t\t\tif (tipOffsetTop + searchTips[this._tooltip.currentSelection].clientHeight >= this._tooltip.scrollTop + this._tooltip.clientHeight) {\n\t\t\t\tthis._tooltip.scrollTop = tipOffsetTop - this._tooltip.clientHeight + searchTips[this._tooltip.currentSelection].clientHeight;\n\t\t\t}\n\t\t\telse if (tipOffsetTop <= this._tooltip.scrollTop) {\n\t\t\t\tthis._tooltip.scrollTop = tipOffsetTop;\n\t\t\t}\n\t\t}\n\t},\n\n\t_handleSubmit: function() {\t//button and tooltip click and enter submit\n\n\t\tthis._hideAutoType();\n\t\t\n\t\tthis.hideAlert();\n\t\tthis._hideTooltip();\n\n\t\tif(this._input.style.display == 'none')\t//on first click show _input only\n\t\t\tthis.expand();\n\t\telse\n\t\t{\n\t\t\tif(this._input.value === '')\t//hide _input only\n\t\t\t\tthis.collapse();\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar loc = this._getLocation(this._input.value);\n\t\t\t\t$.publish('analyticsEvent',{event:[this.options.scope,'input#cercaTopoOK',this._input.value, 8]});\n\t\t\t\t\n\t\t\t\t\tthis.showLocation(loc, this._input.value,this._input.value);\n\t\t\t\t\tthis.fire('search_locationfound', {\n\t\t\t\t\t\t\tlatlng: loc,\n\t\t\t\t\t\t\ttext: this._input.value,\n\t\t\t\t\t\t\tlayer: loc.layer ? loc.layer : null\n\t\t\t\t\t\t});\n\t\t\t\t//}\n\t\t\t\t//this.collapse();\n\t\t\t\t//FIXME if collapse in _handleSubmit hide _markerLoc!\n\t\t\t}\n\t\t}\n\t},\n\n\t_getLocation: function(key) {\t//extract latlng from _recordsCache\n\n\t\tif( this._recordsCache.hasOwnProperty(key) )\n\t\t\treturn this._recordsCache[key];//then after use .loc attribute\n\t\telse\n\t\t\treturn false;\n\t},\n\n\tshowLocation: function(latlng, title,nom) {\t//set location on map from _recordsCache\n\t\tif(this.options.zoom)\n\t\t\tthis._map.setView(latlng, this.options.zoom);\n\t\telse\n\t\t\tthis._map.panTo(latlng);\n\t\n\t\tvar v_url = window.location.href;\n\t\tvar defaultPunt= L.AwesomeMarkers.icon(default_marker_style);\t\n\t\tif(this._markerLoc)\n\t\t{\n\t\t\t\n\t\t\t\n\t\t\tif(v_url.indexOf('visor')==-1){\n\t\t\t\t\n\t\t\t\tvar marker;\n\t\t\t\t//this._markerLoc.setLatLng(latlng);  //show circle/marker in location found\n\t\t\t\tif(defaultPunt.options.markerColor!=\"punt_r\"){\t\t\t\t\t\n\t\t\t\t\tmarker=L.marker([0,0],\n\t\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t tipus: t_marker});\n\t\t\t\t}else{\n\t\t\t\t\t//Si és cercle sense glifon\n\t\t\t\t\tmarker= L.circleMarker([0,0],\n\t\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \n\t\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\n\t\t\t\t\t\t\t  color :  defaultPunt.options.color,\n\t\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\n\t\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\n\t\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\n\t\t\t\t\t\t\t  tipus: t_marker}\t\t\t\t\t\t\t\n\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\tmarker.setLatLng(latlng);\n\t\t\t\tmarker.addTo(map);\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nom,\n\t\t\t\t\tzIndex :  -1,\n\t//\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_marker\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t\tmarker.properties={\n\t\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\n\t\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\n\t\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\n\t\t\t\t\t\t'tipusFeature':t_marker};\t\n\t\t\t\t\n\t\t\t\tmarker.properties.data={\n\t\t\t\t\t\t'nom':nom,\n\t\t\t\t\t\t'text':title,\n\t\t\t\t};\n\t\t\t\tcapaUsrActiva.addLayer(marker);\n\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t\telse {\n\t\t\t\t\t\t\t\n\t\t\t\t\n\t\t\t\tvar marker=null;\n\t\t\t\tif(!defaultPunt.options.isCanvas){\n\t\t\t\t\tmarker=L.marker([0,0],\n\t\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t tipus: t_marker});\n\t\t\t\t}else{\n\t\t\t\t\t//Si és cercle sense glifon\n\t\t\t\t\tmarker= L.circleMarker([0,0],\n\t\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \n\t\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\n\t\t\t\t\t\t\t  color :  defaultPunt.options.color,\n\t\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\n\t\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\n\t\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\n\t\t\t\t\t\t\t  tipus: t_marker}\t\t\t\t\t\t\t\n\t\t\t\t\t);\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tmarker.setLatLng(latlng); \n\t\t\t\t\n\t\t\t\t//console.debug(\"createPopupWindowData\");\n\t\t\t\tvar html='';\n\t\t\t\t\n\t\t\t\thtml+='<h4>'+nom+'</h4>';\t\t\t\t\n\t\t\t\thtml+='<div>'+title+'</div>';\n\t\t\t\t\n\t\t\t\tmarker.bindPopup(html,{'offset':[0,-25]});\n\t\t\t\t\n\t\t\t\tthis._layer.addLayer(marker);\n\t\t\t\tmap.addLayer(this._layer);\n\t\t\t\t//map.addLayer(this._layer);\n\t\t\t}\n\t\t\t\n\t\t}\n\t\tclearTimeout(this.timerKeypress);\n\t\t\n\t\t//FIXME autoCollapse option hide this._markerLoc before that visualized!!\n\t\tif(this.options.autoCollapse)\n\t\t\tthis.collapse();\n\t\treturn this;\n\t}\n});\n\n/*\nvar SearchMarker = L.Marker.extend({\n\n\tincludes: L.Mixin.Events,\n\t\n\toptions: {\n\t\tradius: 10,\n\t\tweight: 3,\n\t\tcolor: '#e03',\n\t\tstroke: true,\n\t\tfill: false,\n\t\ttitle: '',\n\t\t//TODO add custom icon!\t\n\t\tmarker: false\t//show icon optional, show only circleLoc\n\t},\n\t\n\tinitialize: function (latlng, options) {\n\t\tL.setOptions(this, options);\n\t\tL.Marker.prototype.initialize.call(this, latlng, options);\n\t\tthis._circleLoc = new L.CircleMarker(latlng, this.options);\n\t\t//TODO add inner circle\n\t},\n\n\tonAdd: function (map) {\n\t\tL.Marker.prototype.onAdd.call(this, map);\n\t\tmap.addLayer(this._circleLoc);\n\t\tthis.hide();\n\t},\n\n\tonRemove: function (map) {\n\t\tL.Marker.prototype.onRemove.call(this, map);\n\t\tmap.removeLayer(this._circleLoc);\n\t},\t\n\t\n\tsetLatLng: function (latlng) {\n\t\tL.Marker.prototype.setLatLng.call(this, latlng);\n\t\tthis._circleLoc.setLatLng(latlng);\n\t\treturn this;\n\t},\n\t\n\tsetTitle: function(title) {\n\t\ttitle = title || '';\n\t\tthis.options.title = title;\n\t\tif(this._icon)\n\t\t\tthis._icon.title = title;\n\t\treturn this;\n\t},\n\n\tshow: function() {\n\t\tif(this.options.marker)\n\t\t{\n\t\t\tif(this._icon)\n\t\t\t\tthis._icon.style.display = 'block';\n\t\t\tif(this._shadow)\n\t\t\t\tthis._shadow.style.display = 'block';\n\t\t\t//this._bringToFront();\n\t\t}\n\t\tif(this._circleLoc)\n\t\t{\n\t\t\tthis._circleLoc.setStyle({fill: this.options.fill, stroke: this.options.stroke});\n\t\t\t//this._circleLoc.bringToFront();\n\t\t}\n\t\treturn this;\n\t},\n\n\thide: function() {\n\t\tif(this._icon)\n\t\t\tthis._icon.style.display = 'none';\n\t\tif(this._shadow)\n\t\t\tthis._shadow.style.display = 'none';\n\t\tif(this._circleLoc)\t\t\t\n\t\t\tthis._circleLoc.setStyle({fill: false, stroke: false});\n\t\treturn this;\n\t},\n\n\tanimate: function() {\n\t//TODO refact animate() more smooth! like this: http://goo.gl/DDlRs\n\t\tvar circle = this._circleLoc,\n\t\t\ttInt = 200,\t//time interval\n\t\t\tss = 10,\t//frames\n\t\t\tmr = parseInt(circle._radius/ss),\n\t\t\toldrad = this.options.radius,\n\t\t\tnewrad = circle._radius * 2.5,\n\t\t\tacc = 0;\n\n\t\tcircle._timerAnimLoc = setInterval(function() {\n\t\t\tacc += 0.5;\n\t\t\tmr += acc;\t//adding acceleration\n\t\t\tnewrad -= mr;\n\t\t\t\n\t\t\tcircle.setRadius(newrad);\n\n\t\t\tif(newrad<oldrad)\n\t\t\t{\n\t\t\t\tclearInterval(circle._timerAnimLoc);\n\t\t\t\tcircle.setRadius(oldrad);//reset radius\n\t\t\t\t//if(typeof afterAnimCall == 'function')\n\t\t\t\t\t//afterAnimCall();\n\t\t\t\t\t//TODO use create event 'animateEnd' in SearchMarker \n\t\t\t}\n\t\t}, tInt);\n\t\t\n\t\treturn this;\n\t }\n});*/\n\nL.Map.addInitHook(function () {\n    if (this.options.searchControl) {\n        this.searchControl = L.control.search(this.options.searchControl);\n        this.addControl(this.searchControl);\n    }\n});\n\nL.control.search = function (options) {\n    return new L.Control.Search(options);\n};\n\n}).call(this);\n\n","var catContorn= [new L.LatLng( 41.07088, 1.94891 ), new L.LatLng( 41.07066, 1.94848 ), new L.LatLng( 41.07029, 1.94621 ), new L.LatLng( 41.06905, 1.94367 ), new L.LatLng( 41.06713, 1.93675 ), new L.LatLng( 41.05791, 1.87074 ), new L.LatLng( 41.05638, 1.86145 ), new L.LatLng( 41.05579, 1.85968 ), new L.LatLng( 41.05556, 1.85833 ), new L.LatLng( 41.05496, 1.85716 ), new L.LatLng( 41.05338, 1.84738 ), new L.LatLng( 41.04211, 1.82503 ), new L.LatLng( 41.03047, 1.75295 ), new L.LatLng( 41.03017, 1.75238 ), new L.LatLng( 41.02522, 1.72904 ), new L.LatLng( 41.02165, 1.71546 ), new L.LatLng( 41.02054, 1.71000 ), new L.LatLng( 41.01991, 1.70398 ), new L.LatLng( 41.01716, 1.69107 ), new L.LatLng( 41.01614, 1.68140 ), new L.LatLng( 41.01540, 1.66879 ), new L.LatLng( 41.00953, 1.64076 ), new L.LatLng( 41.00927, 1.63811 ), new L.LatLng( 41.00774, 1.61073 ), new L.LatLng( 41.00850, 1.60525 ), new L.LatLng( 41.00479, 1.59129 ), new L.LatLng( 41.00432, 1.58899 ), new L.LatLng( 41.00139, 1.56170 ), new L.LatLng( 41.00127, 1.56126 ), new L.LatLng( 40.99840, 1.55401 ), new L.LatLng( 40.99766, 1.55231 ), new L.LatLng( 40.99613, 1.54940 ), new L.LatLng( 40.99011, 1.54026 ), new L.LatLng( 40.98790, 1.53625 ), new L.LatLng( 40.98159, 1.52171 ), new L.LatLng( 40.96908, 1.49789 ), new L.LatLng( 40.95415, 1.40729 ), new L.LatLng( 40.95429, 1.40623 ), new L.LatLng( 40.95333, 1.40037 ), new L.LatLng( 40.95358, 1.39427 ), new L.LatLng( 40.95240, 1.38521 ), new L.LatLng( 40.95153, 1.37995 ), new L.LatLng( 40.93441, 1.34544 ), new L.LatLng( 40.93174, 1.34319 ), new L.LatLng( 40.89157, 1.26717 ), new L.LatLng( 40.88362, 1.21949 ), new L.LatLng( 40.88046, 1.20519 ), new L.LatLng( 40.87964, 1.19827 ), new L.LatLng( 40.87936, 1.19403 ), new L.LatLng( 40.87647, 1.17674 ), new L.LatLng( 40.88188, 1.11723 ), new L.LatLng( 40.86572, 1.10366 ), new L.LatLng( 40.86152, 1.09612 ), new L.LatLng( 40.84059, 1.06246 ), new L.LatLng( 40.81600, 1.08618 ), new L.LatLng( 40.80741, 1.09173 ), new L.LatLng( 40.80384, 1.09288 ), new L.LatLng( 40.80047, 1.09598 ), new L.LatLng( 40.75908, 1.11247 ), new L.LatLng( 40.75148, 1.11422 ), new L.LatLng( 40.72426, 1.11772 ), new L.LatLng( 40.66538, 1.10647 ), new L.LatLng( 40.64644, 1.09849 ), new L.LatLng( 40.64205, 1.09506 ), new L.LatLng( 40.63611, 1.09369 ), new L.LatLng( 40.59434, 1.06348 ), new L.LatLng( 40.58387, 1.05334 ), new L.LatLng( 40.56637, 1.03402 ), new L.LatLng( 40.55067, 1.01163 ), new L.LatLng( 40.53803, 0.99111 ), new L.LatLng( 40.52596, 0.96516 ), new L.LatLng( 40.51864, 0.95244 ), new L.LatLng( 40.50554, 0.91975 ), new L.LatLng( 40.49942, 0.91443 ), new L.LatLng( 40.49605, 0.51561 ), new L.LatLng( 40.50384, 0.47462 ), new L.LatLng( 40.52674, 0.41491 ), new L.LatLng( 40.54219, 0.40244 ), new L.LatLng( 40.56436, 0.39892 ), new L.LatLng( 40.57879, 0.37796 ), new L.LatLng( 40.58118, 0.33371 ), new L.LatLng( 40.59385, 0.33076 ), new L.LatLng( 40.59590, 0.31505 ), new L.LatLng( 40.60164, 0.30290 ), new L.LatLng( 40.59405, 0.29124 ), new L.LatLng( 40.60640, 0.26035 ), new L.LatLng( 40.62209, 0.24270 ), new L.LatLng( 40.63681, 0.23201 ), new L.LatLng( 40.64621, 0.23026 ), new L.LatLng( 40.67282, 0.23709 ), new L.LatLng( 40.68064, 0.21382 ), new L.LatLng( 40.69748, 0.20113 ), new L.LatLng( 40.70252, 0.16895 ), new L.LatLng( 40.71180, 0.14707 ), new L.LatLng( 40.71979, 0.13857 ), new L.LatLng( 40.74909, 0.12487 ), new L.LatLng( 40.76740, 0.13317 ), new L.LatLng( 40.77494, 0.14585 ), new L.LatLng( 40.78385, 0.18409 ), new L.LatLng( 40.79314, 0.20019 ), new L.LatLng( 40.80563, 0.20865 ), new L.LatLng( 40.82283, 0.23139 ), new L.LatLng( 40.84643, 0.21806 ), new L.LatLng( 40.86268, 0.21600 ), new L.LatLng( 40.87335, 0.20621 ), new L.LatLng( 40.87854, 0.20181 ), new L.LatLng( 40.86693, 0.17371 ), new L.LatLng( 40.86768, 0.15376 ), new L.LatLng( 40.87628, 0.13789 ), new L.LatLng( 40.89037, 0.12675 ), new L.LatLng( 40.93069, 0.12701 ), new L.LatLng( 40.93586, 0.14132 ), new L.LatLng( 40.93462, 0.22399 ), new L.LatLng( 40.96669, 0.24835 ), new L.LatLng( 41.00875, 0.22405 ), new L.LatLng( 41.02249, 0.19535 ), new L.LatLng( 41.03394, 0.18475 ), new L.LatLng( 41.06212, 0.18202 ), new L.LatLng( 41.07289, 0.16923 ), new L.LatLng( 41.08339, 0.16509 ), new L.LatLng( 41.13481, 0.16710 ), new L.LatLng( 41.15500, 0.18661 ), new L.LatLng( 41.16105, 0.19742 ), new L.LatLng( 41.16311, 0.22196 ), new L.LatLng( 41.17445, 0.23796 ), new L.LatLng( 41.17683, 0.26081 ), new L.LatLng( 41.18126, 0.26958 ), new L.LatLng( 41.22862, 0.28506 ), new L.LatLng( 41.23914, 0.29212 ), new L.LatLng( 41.24944, 0.30833 ), new L.LatLng( 41.25760, 0.34015 ), new L.LatLng( 41.27565, 0.34467 ), new L.LatLng( 41.29262, 0.33239 ), new L.LatLng( 41.30309, 0.32927 ), new L.LatLng( 41.31729, 0.31527 ), new L.LatLng( 41.37445, 0.29692 ), new L.LatLng( 41.38371, 0.28770 ), new L.LatLng( 41.39397, 0.28454 ), new L.LatLng( 41.41183, 0.29192 ), new L.LatLng( 41.42874, 0.31040 ), new L.LatLng( 41.43934, 0.30858 ), new L.LatLng( 41.44989, 0.31216 ), new L.LatLng( 41.47845, 0.30308 ), new L.LatLng( 41.48896, 0.30343 ), new L.LatLng( 41.50086, 0.31042 ), new L.LatLng( 41.50979, 0.32438 ), new L.LatLng( 41.51419, 0.34728 ), new L.LatLng( 41.51271, 0.37362 ), new L.LatLng( 41.52597, 0.38375 ), new L.LatLng( 41.53111, 0.41768 ), new L.LatLng( 41.53786, 0.42032 ), new L.LatLng( 41.54628, 0.41848 ), new L.LatLng( 41.55040, 0.41113 ), new L.LatLng( 41.54994, 0.40109 ), new L.LatLng( 41.56688, 0.39509 ), new L.LatLng( 41.57427, 0.33683 ), new L.LatLng( 41.57986, 0.32493 ), new L.LatLng( 41.58843, 0.31678 ), new L.LatLng( 41.62090, 0.31046 ), new L.LatLng( 41.63113, 0.31251 ), new L.LatLng( 41.65111, 0.29444 ), new L.LatLng( 41.66940, 0.28989 ), new L.LatLng( 41.69024, 0.29387 ), new L.LatLng( 41.71067, 0.31125 ), new L.LatLng( 41.71054, 0.28554 ), new L.LatLng( 41.72891, 0.28472 ), new L.LatLng( 41.73349, 0.29896 ), new L.LatLng( 41.73285, 0.32387 ), new L.LatLng( 41.72738, 0.33322 ), new L.LatLng( 41.73694, 0.33663 ), new L.LatLng( 41.77656, 0.37329 ), new L.LatLng( 41.78293, 0.38660 ), new L.LatLng( 41.79109, 0.43810 ), new L.LatLng( 41.81989, 0.45765 ), new L.LatLng( 41.84449, 0.49398 ), new L.LatLng( 41.84957, 0.51674 ), new L.LatLng( 41.86123, 0.52064 ), new L.LatLng( 41.87098, 0.56885 ), new L.LatLng( 41.89931, 0.59511 ), new L.LatLng( 41.91544, 0.59548 ), new L.LatLng( 41.92084, 0.57851 ), new L.LatLng( 41.92307, 0.53454 ), new L.LatLng( 41.93185, 0.52630 ), new L.LatLng( 41.94391, 0.52686 ), new L.LatLng( 41.96049, 0.53666 ), new L.LatLng( 41.98417, 0.55990 ), new L.LatLng( 41.99400, 0.58192 ), new L.LatLng( 42.00941, 0.59480 ), new L.LatLng( 42.01837, 0.61688 ), new L.LatLng( 42.03007, 0.61628 ), new L.LatLng( 42.04842, 0.62272 ), new L.LatLng( 42.06060, 0.63378 ), new L.LatLng( 42.10284, 0.65188 ), new L.LatLng( 42.11482, 0.66318 ), new L.LatLng( 42.13940, 0.65938 ), new L.LatLng( 42.18102, 0.66337 ), new L.LatLng( 42.21911, 0.67801 ), new L.LatLng( 42.23517, 0.68061 ), new L.LatLng( 42.26368, 0.70083 ), new L.LatLng( 42.28983, 0.70381 ), new L.LatLng( 42.31359, 0.71338 ), new L.LatLng( 42.33039, 0.70630 ), new L.LatLng( 42.34224, 0.70647 ), new L.LatLng( 42.35548, 0.69007 ), new L.LatLng( 42.37054, 0.68697 ), new L.LatLng( 42.36935, 0.58727 ), new L.LatLng( 42.36066, 0.55420 ), new L.LatLng( 42.36924, 0.48478 ), new L.LatLng( 42.42879, 0.48808 ), new L.LatLng( 42.45198, 0.52073 ), new L.LatLng( 42.45867, 0.65592 ), new L.LatLng( 42.47682, 0.65662 ), new L.LatLng( 42.49173, 0.65520 ), new L.LatLng( 42.50566, 0.66459 ), new L.LatLng( 42.51975, 0.68541 ), new L.LatLng( 42.53645, 0.68815 ), new L.LatLng( 42.55578, 0.70254 ), new L.LatLng( 42.56377, 0.71435 ), new L.LatLng( 42.58657, 0.72388 ), new L.LatLng( 42.60167, 0.68326 ), new L.LatLng( 42.60908, 0.67230 ), new L.LatLng( 42.61987, 0.66401 ), new L.LatLng( 42.61760, 0.59368 ), new L.LatLng( 42.62180, 0.58646 ), new L.LatLng( 42.64319, 0.58506 ), new L.LatLng( 42.65763, 0.58830 ), new L.LatLng( 42.66089, 0.61333 ), new L.LatLng( 42.66075, 0.64249 ), new L.LatLng( 42.67625, 0.62776 ), new L.LatLng( 42.69016, 0.62346 ), new L.LatLng( 42.70055, 0.62585 ), new L.LatLng( 42.71190, 0.63770 ), new L.LatLng( 42.72096, 0.63661 ), new L.LatLng( 42.72687, 0.63339 ), new L.LatLng( 42.73575, 0.61189 ), new L.LatLng( 42.75328, 0.60200 ), new L.LatLng( 42.76367, 0.60439 ), new L.LatLng( 42.77301, 0.61227 ), new L.LatLng( 42.78267, 0.60936 ), new L.LatLng( 42.79306, 0.61175 ), new L.LatLng( 42.81130, 0.62806 ), new L.LatLng( 42.83789, 0.62241 ), new L.LatLng( 42.85370, 0.62909 ), new L.LatLng( 42.87402, 0.65098 ), new L.LatLng( 42.88012, 0.66267 ), new L.LatLng( 42.88246, 0.68464 ), new L.LatLng( 42.88885, 0.70785 ), new L.LatLng( 42.88603, 0.73190 ), new L.LatLng( 42.86489, 0.78227 ), new L.LatLng( 42.86706, 0.80978 ), new L.LatLng( 42.86346, 0.82600 ), new L.LatLng( 42.85611, 0.84146 ), new L.LatLng( 42.85135, 0.87194 ), new L.LatLng( 42.82354, 0.92631 ), new L.LatLng( 42.83100, 0.94767 ), new L.LatLng( 42.83247, 0.96166 ), new L.LatLng( 42.82784, 0.98160 ), new L.LatLng( 42.81703, 0.99833 ), new L.LatLng( 42.81757, 1.01035 ), new L.LatLng( 42.81030, 1.05644 ), new L.LatLng( 42.81542, 1.07678 ), new L.LatLng( 42.81359, 1.09254 ), new L.LatLng( 42.77932, 1.14903 ), new L.LatLng( 42.76121, 1.16591 ), new L.LatLng( 42.74590, 1.16879 ), new L.LatLng( 42.74125, 1.17361 ), new L.LatLng( 42.75430, 1.22646 ), new L.LatLng( 42.75320, 1.24123 ), new L.LatLng( 42.74518, 1.26557 ), new L.LatLng( 42.74586, 1.30283 ), new L.LatLng( 42.75024, 1.31610 ), new L.LatLng( 42.75117, 1.33716 ), new L.LatLng( 42.74512, 1.37040 ), new L.LatLng( 42.73924, 1.38315 ), new L.LatLng( 42.73059, 1.39131 ), new L.LatLng( 42.71780, 1.39486 ), new L.LatLng( 42.70787, 1.41311 ), new L.LatLng( 42.69654, 1.42299 ), new L.LatLng( 42.70299, 1.48050 ), new L.LatLng( 42.69861, 1.52276 ), new L.LatLng( 42.69900, 1.55742 ), new L.LatLng( 42.69577, 1.56697 ), new L.LatLng( 42.67829, 1.56699 ), new L.LatLng( 42.67587, 1.47123 ), new L.LatLng( 42.66270, 1.47063 ), new L.LatLng( 42.66013, 1.44930 ), new L.LatLng( 42.64028, 1.45352 ), new L.LatLng( 42.60832, 1.47904 ), new L.LatLng( 42.58542, 1.47428 ), new L.LatLng( 42.57006, 1.48036 ), new L.LatLng( 42.55757, 1.47789 ), new L.LatLng( 42.51370, 1.50397 ), new L.LatLng( 42.50250, 1.50264 ), new L.LatLng( 42.49359, 1.49659 ), new L.LatLng( 42.48053, 1.47661 ), new L.LatLng( 42.46117, 1.48398 ), new L.LatLng( 42.45867, 1.52059 ), new L.LatLng( 42.46796, 1.52463 ), new L.LatLng( 42.47854, 1.53618 ), new L.LatLng( 42.48124, 1.56348 ), new L.LatLng( 42.48634, 1.56995 ), new L.LatLng( 42.48083, 1.57416 ), new L.LatLng( 42.47981, 1.58406 ), new L.LatLng( 42.48182, 1.62970 ), new L.LatLng( 42.48907, 1.63280 ), new L.LatLng( 42.49918, 1.64986 ), new L.LatLng( 42.50093, 1.65870 ), new L.LatLng( 42.51496, 1.65740 ), new L.LatLng( 42.52250, 1.64167 ), new L.LatLng( 42.53054, 1.65732 ), new L.LatLng( 42.53081, 1.68070 ), new L.LatLng( 42.52262, 1.69775 ), new L.LatLng( 42.52749, 1.70981 ), new L.LatLng( 42.52965, 1.72722 ), new L.LatLng( 42.52789, 1.73885 ), new L.LatLng( 42.52127, 1.75192 ), new L.LatLng( 42.51291, 1.78418 ), new L.LatLng( 42.51707, 1.80639 ), new L.LatLng( 42.51088, 1.83754 ), new L.LatLng( 42.50361, 1.85641 ), new L.LatLng( 42.49134, 1.87401 ), new L.LatLng( 42.48338, 1.89869 ), new L.LatLng( 42.47583, 1.91121 ), new L.LatLng( 42.47954, 1.92570 ), new L.LatLng( 42.49384, 1.93299 ), new L.LatLng( 42.51272, 1.95286 ), new L.LatLng( 42.51816, 1.96315 ), new L.LatLng( 42.52090, 1.98903 ), new L.LatLng( 42.51669, 2.00823 ), new L.LatLng( 42.49052, 2.03759 ), new L.LatLng( 42.48699, 2.05246 ), new L.LatLng( 42.47121, 2.05982 ), new L.LatLng( 42.46611, 2.04484 ), new L.LatLng( 42.44685, 2.04971 ), new L.LatLng( 42.42988, 2.03842 ), new L.LatLng( 42.42351, 2.02505 ), new L.LatLng( 42.41997, 1.99421 ), new L.LatLng( 42.39893, 1.99768 ), new L.LatLng( 42.40635, 2.00360 ), new L.LatLng( 42.40898, 2.01123 ), new L.LatLng( 42.40337, 2.08053 ), new L.LatLng( 42.43217, 2.10357 ), new L.LatLng( 42.44865, 2.14305 ), new L.LatLng( 42.45148, 2.16868 ), new L.LatLng( 42.44542, 2.19491 ), new L.LatLng( 42.45314, 2.22342 ), new L.LatLng( 42.46357, 2.24134 ), new L.LatLng( 42.46584, 2.25716 ), new L.LatLng( 42.45463, 2.29521 ), new L.LatLng( 42.45603, 2.30948 ), new L.LatLng( 42.45376, 2.32546 ), new L.LatLng( 42.44374, 2.34567 ), new L.LatLng( 42.43806, 2.36767 ), new L.LatLng( 42.44010, 2.38897 ), new L.LatLng( 42.43819, 2.38994 ), new L.LatLng( 42.44616, 2.40222 ), new L.LatLng( 42.43756, 2.41382 ), new L.LatLng( 42.43974, 2.44057 ), new L.LatLng( 42.43635, 2.45653 ), new L.LatLng( 42.43034, 2.45964 ), new L.LatLng( 42.41286, 2.45766 ), new L.LatLng( 42.40472, 2.46607 ), new L.LatLng( 42.39336, 2.47088 ), new L.LatLng( 42.37954, 2.49202 ), new L.LatLng( 42.37017, 2.50069 ), new L.LatLng( 42.36580, 2.52122 ), new L.LatLng( 42.37825, 2.53773 ), new L.LatLng( 42.38488, 2.56695 ), new L.LatLng( 42.38329, 2.59452 ), new L.LatLng( 42.37495, 2.61825 ), new L.LatLng( 42.38650, 2.61512 ), new L.LatLng( 42.39832, 2.61853 ), new L.LatLng( 42.42131, 2.64526 ), new L.LatLng( 42.43640, 2.63571 ), new L.LatLng( 42.45003, 2.63569 ), new L.LatLng( 42.45111, 2.64871 ), new L.LatLng( 42.44558, 2.66714 ), new L.LatLng( 42.44540, 2.68171 ), new L.LatLng( 42.44578, 2.69700 ), new L.LatLng( 42.45023, 2.69734 ), new L.LatLng( 42.45164, 2.70447 ), new L.LatLng( 42.44805, 2.71025 ), new L.LatLng( 42.45262, 2.75639 ), new L.LatLng( 42.44775, 2.77648 ), new L.LatLng( 42.46454, 2.80081 ), new L.LatLng( 42.47833, 2.81359 ), new L.LatLng( 42.48421, 2.82541 ), new L.LatLng( 42.48597, 2.84289 ), new L.LatLng( 42.49250, 2.85583 ), new L.LatLng( 42.49467, 2.87023 ), new L.LatLng( 42.48787, 2.90052 ), new L.LatLng( 42.50627, 2.93086 ), new L.LatLng( 42.50899, 2.94456 ), new L.LatLng( 42.50711, 2.96091 ), new L.LatLng( 42.49983, 2.97434 ), new L.LatLng( 42.50215, 2.98996 ), new L.LatLng( 42.49890, 3.01500 ), new L.LatLng( 42.50190, 3.03199 ), new L.LatLng( 42.49906, 3.05361 ), new L.LatLng( 42.48951, 3.07003 ), new L.LatLng( 42.46693, 3.08312 ), new L.LatLng( 42.45993, 3.09467 ), new L.LatLng( 42.46535, 3.12097 ), new L.LatLng( 42.46289, 3.29906 ), new L.LatLng( 42.43429, 3.36389 ), new L.LatLng( 42.39945, 3.40221 ), new L.LatLng( 42.35343, 3.43178 ), new L.LatLng( 41.89415, 3.43270 ), new L.LatLng( 41.87526, 3.43273 ), new L.LatLng( 41.83873, 3.42726 ), new L.LatLng( 41.81802, 3.42107 ), new L.LatLng( 41.81669, 3.42082 ), new L.LatLng( 41.81665, 3.42081 ), new L.LatLng( 41.81351, 3.41935 ), new L.LatLng( 41.81154, 3.41894 ), new L.LatLng( 41.81149, 3.41892 ), new L.LatLng( 41.80253, 3.41457 ), new L.LatLng( 41.80199, 3.41444 ), new L.LatLng( 41.80194, 3.41442 ), new L.LatLng( 41.80159, 3.41411 ), new L.LatLng( 41.79632, 3.41156 ), new L.LatLng( 41.79429, 3.41100 ), new L.LatLng( 41.78530, 3.40486 ), new L.LatLng( 41.78169, 3.40260 ), new L.LatLng( 41.78164, 3.40257 ), new L.LatLng( 41.78093, 3.40187 ), new L.LatLng( 41.77013, 3.39450 ), new L.LatLng( 41.77009, 3.39446 ), new L.LatLng( 41.75453, 3.37803 ), new L.LatLng( 41.74983, 3.37424 ), new L.LatLng( 41.74978, 3.37419 ), new L.LatLng( 41.74267, 3.36552 ), new L.LatLng( 41.73598, 3.35846 ), new L.LatLng( 41.73423, 3.35494 ), new L.LatLng( 41.72154, 3.33555 ), new L.LatLng( 41.72151, 3.33550 ), new L.LatLng( 41.71071, 3.31047 ), new L.LatLng( 41.70206, 3.29422 ), new L.LatLng( 41.70203, 3.29414 ), new L.LatLng( 41.70102, 3.28827 ), new L.LatLng( 41.70054, 3.28733 ), new L.LatLng( 41.70052, 3.28726 ), new L.LatLng( 41.70046, 3.28694 ), new L.LatLng( 41.69715, 3.28027 ), new L.LatLng( 41.69549, 3.27140 ), new L.LatLng( 41.69530, 3.27101 ), new L.LatLng( 41.69529, 3.27095 ), new L.LatLng( 41.69514, 3.26983 ), new L.LatLng( 41.69204, 3.25784 ), new L.LatLng( 41.69024, 3.25648 ), new L.LatLng( 41.68929, 3.25554 ), new L.LatLng( 41.67334, 3.24261 ), new L.LatLng( 41.67323, 3.24248 ), new L.LatLng( 41.66116, 3.22771 ), new L.LatLng( 41.66009, 3.22555 ), new L.LatLng( 41.65732, 3.22060 ), new L.LatLng( 41.65629, 3.21968 ), new L.LatLng( 41.65584, 3.21877 ), new L.LatLng( 41.65392, 3.21705 ), new L.LatLng( 41.63677, 3.18904 ), new L.LatLng( 41.63606, 3.18801 ), new L.LatLng( 41.63447, 3.18546 ), new L.LatLng( 41.63416, 3.18479 ), new L.LatLng( 41.63154, 3.18050 ), new L.LatLng( 41.63151, 3.18045 ), new L.LatLng( 41.63147, 3.18035 ), new L.LatLng( 41.63141, 3.18026 ), new L.LatLng( 41.63138, 3.18018 ), new L.LatLng( 41.62625, 3.16731 ), new L.LatLng( 41.62480, 3.16412 ), new L.LatLng( 41.61812, 3.15267 ), new L.LatLng( 41.61806, 3.15254 ), new L.LatLng( 41.61073, 3.13306 ), new L.LatLng( 41.60801, 3.12706 ), new L.LatLng( 41.60541, 3.12474 ), new L.LatLng( 41.60311, 3.12014 ), new L.LatLng( 41.59989, 3.11726 ), new L.LatLng( 41.59898, 3.11545 ), new L.LatLng( 41.59431, 3.11128 ), new L.LatLng( 41.59335, 3.10971 ), new L.LatLng( 41.59260, 3.10860 ), new L.LatLng( 41.58967, 3.10598 ), new L.LatLng( 41.58623, 3.09910 ), new L.LatLng( 41.58110, 3.09147 ), new L.LatLng( 41.58106, 3.09140 ), new L.LatLng( 41.57840, 3.08540 ), new L.LatLng( 41.57193, 3.07487 ), new L.LatLng( 41.57190, 3.07481 ), new L.LatLng( 41.56438, 3.05605 ), new L.LatLng( 41.56360, 3.05465 ), new L.LatLng( 41.56359, 3.05462 ), new L.LatLng( 41.56263, 3.05311 ), new L.LatLng( 41.56260, 3.05306 ), new L.LatLng( 41.55981, 3.04635 ), new L.LatLng( 41.55066, 3.02812 ), new L.LatLng( 41.55007, 3.02453 ), new L.LatLng( 41.54811, 3.02091 ), new L.LatLng( 41.54810, 3.02086 ), new L.LatLng( 41.54752, 3.01759 ), new L.LatLng( 41.54746, 3.01747 ), new L.LatLng( 41.54729, 3.01633 ), new L.LatLng( 41.54267, 3.00524 ), new L.LatLng( 41.54253, 3.00433 ), new L.LatLng( 41.53698, 2.98190 ), new L.LatLng( 41.53640, 2.98034 ), new L.LatLng( 41.53610, 2.97835 ), new L.LatLng( 41.53591, 2.97757 ), new L.LatLng( 41.53509, 2.97454 ), new L.LatLng( 41.53451, 2.97333 ), new L.LatLng( 41.53449, 2.97328 ), new L.LatLng( 41.53422, 2.97126 ), new L.LatLng( 41.53290, 2.96634 ), new L.LatLng( 41.53287, 2.96623 ), new L.LatLng( 41.53266, 2.96436 ), new L.LatLng( 41.53122, 2.95904 ), new L.LatLng( 41.53119, 2.95894 ), new L.LatLng( 41.53078, 2.95532 ), new L.LatLng( 41.52788, 2.95279 ), new L.LatLng( 41.52374, 2.94746 ), new L.LatLng( 41.52292, 2.94586 ), new L.LatLng( 41.52167, 2.94475 ), new L.LatLng( 41.48255, 2.86706 ), new L.LatLng( 41.47716, 2.83959 ), new L.LatLng( 41.47556, 2.83523 ), new L.LatLng( 41.46486, 2.81246 ), new L.LatLng( 41.46471, 2.81151 ), new L.LatLng( 41.46432, 2.81073 ), new L.LatLng( 41.44002, 2.73160 ), new L.LatLng( 41.43966, 2.72916 ), new L.LatLng( 41.43925, 2.72726 ), new L.LatLng( 41.43595, 2.71920 ), new L.LatLng( 41.43518, 2.71417 ), new L.LatLng( 41.42533, 2.68612 ), new L.LatLng( 41.42051, 2.67377 ), new L.LatLng( 41.41075, 2.65454 ), new L.LatLng( 41.40862, 2.64533 ), new L.LatLng( 41.40473, 2.63050 ), new L.LatLng( 41.39620, 2.60917 ), new L.LatLng( 41.39188, 2.60068 ), new L.LatLng( 41.39147, 2.59795 ), new L.LatLng( 41.39140, 2.59780 ), new L.LatLng( 41.39113, 2.59604 ), new L.LatLng( 41.37554, 2.56528 ), new L.LatLng( 41.37539, 2.56502 ), new L.LatLng( 41.35440, 2.52958 ), new L.LatLng( 41.34020, 2.49829 ), new L.LatLng( 41.33548, 2.48597 ), new L.LatLng( 41.32463, 2.46471 ), new L.LatLng( 41.32164, 2.45326 ), new L.LatLng( 41.31940, 2.44527 ), new L.LatLng( 41.31806, 2.43978 ), new L.LatLng( 41.31800, 2.43930 ), new L.LatLng( 41.31685, 2.43486 ), new L.LatLng( 41.31567, 2.42914 ), new L.LatLng( 41.31549, 2.42743 ), new L.LatLng( 41.30591, 2.42018 ), new L.LatLng( 41.29560, 2.40976 ), new L.LatLng( 41.28848, 2.40157 ), new L.LatLng( 41.26931, 2.39438 ), new L.LatLng( 41.21058, 2.34321 ), new L.LatLng( 41.20502, 2.33237 ), new L.LatLng( 41.17843, 2.30530 ), new L.LatLng( 41.17501, 2.29863 ), new L.LatLng( 41.17080, 2.29472 ), new L.LatLng( 41.15886, 2.27715 ), new L.LatLng( 41.13858, 2.23501 ), new L.LatLng( 41.12893, 2.21681 ), new L.LatLng( 41.11451, 2.17514 ), new L.LatLng( 41.11398, 2.17202 ), new L.LatLng( 41.11252, 2.16919 ), new L.LatLng( 41.10426, 2.13750 ), new L.LatLng( 41.09444, 2.08910 ), new L.LatLng( 41.09226, 2.06812 ), new L.LatLng( 41.08936, 2.05358 ), new L.LatLng( 41.08682, 2.02335 ), new L.LatLng( 41.08577, 2.00088 ), new L.LatLng( 41.08572, 2.00058 ), new L.LatLng( 41.08568, 1.99687 ), new L.LatLng( 41.08484, 1.99525 ), new L.LatLng( 41.08430, 1.99183 ), new L.LatLng( 41.07956, 1.97402 ), new L.LatLng( 41.07282, 1.96104 ), new L.LatLng( 41.07088, 1.94891 ) ];\nvar catContorn5k= [ new L.LatLng( 42.09360, 3.20674 ), new L.LatLng( 42.07406, 3.22457 ), new L.LatLng( 42.06212, 3.22768 ), new L.LatLng( 42.05299, 3.23920 ), new L.LatLng( 42.04368, 3.24213 ), new L.LatLng( 42.03702, 3.23826 ), new L.LatLng( 42.03400, 3.22791 ), new L.LatLng( 42.04381, 3.21041 ), new L.LatLng( 42.00509, 3.21105 ), new L.LatLng( 41.98528, 3.22157 ), new L.LatLng( 41.97466, 3.24404 ), new L.LatLng( 41.95904, 3.24792 ), new L.LatLng( 41.94878, 3.24574 ), new L.LatLng( 41.93804, 3.23337 ), new L.LatLng( 41.91704, 3.23194 ), new L.LatLng( 41.91195, 3.22500 ), new L.LatLng( 41.88994, 3.21519 ), new L.LatLng( 41.87850, 3.19473 ), new L.LatLng( 41.87313, 3.19270 ), new L.LatLng( 41.86400, 3.20086 ), new L.LatLng( 41.85738, 3.19728 ), new L.LatLng( 41.85246, 3.15852 ), new L.LatLng( 41.84512, 3.15457 ), new L.LatLng( 41.83506, 3.13636 ), new L.LatLng( 41.83717, 3.10777 ), new L.LatLng( 41.82731, 3.10263 ), new L.LatLng( 41.81549, 3.08290 ), new L.LatLng( 41.79902, 3.07889 ), new L.LatLng( 41.78238, 3.06646 ), new L.LatLng( 41.76437, 3.03590 ), new L.LatLng( 41.76549, 3.01705 ), new L.LatLng( 41.75865, 3.00855 ), new L.LatLng( 41.75465, 2.99316 ), new L.LatLng( 41.74692, 2.98019 ), new L.LatLng( 41.72648, 2.96344 ), new L.LatLng( 41.70876, 2.94079 ), new L.LatLng( 41.69446, 2.89291 ), new L.LatLng( 41.69204, 2.85659 ), new L.LatLng( 41.68288, 2.82980 ), new L.LatLng( 41.66874, 2.81319 ), new L.LatLng( 41.66427, 2.79914 ), new L.LatLng( 41.64957, 2.79125 ), new L.LatLng( 41.64053, 2.77943 ), new L.LatLng( 41.63599, 2.75154 ), new L.LatLng( 41.62279, 2.72472 ), new L.LatLng( 41.59318, 2.62619 ), new L.LatLng( 41.57705, 2.58029 ), new L.LatLng( 41.56857, 2.56649 ), new L.LatLng( 41.56839, 2.55195 ), new L.LatLng( 41.54966, 2.51253 ), new L.LatLng( 41.53787, 2.47135 ), new L.LatLng( 41.52166, 2.45413 ), new L.LatLng( 41.51957, 2.44176 ), new L.LatLng( 41.48230, 2.37632 ), new L.LatLng( 41.47529, 2.33876 ), new L.LatLng( 41.46707, 2.31798 ), new L.LatLng( 41.46742, 2.30801 ), new L.LatLng( 41.45380, 2.27564 ), new L.LatLng( 41.44020, 2.25986 ), new L.LatLng( 41.40951, 2.23938 ), new L.LatLng( 41.37454, 2.20377 ), new L.LatLng( 41.34954, 2.18780 ), new L.LatLng( 41.33056, 2.18145 ), new L.LatLng( 41.32883, 2.16783 ), new L.LatLng( 41.29836, 2.14355 ), new L.LatLng( 41.28452, 2.12243 ), new L.LatLng( 41.26996, 2.08039 ), new L.LatLng( 41.25971, 2.03029 ), new L.LatLng( 41.25523, 1.94026 ), new L.LatLng( 41.25005, 1.92881 ), new L.LatLng( 41.24897, 1.91359 ), new L.LatLng( 41.24215, 1.90608 ), new L.LatLng( 41.23763, 1.87985 ), new L.LatLng( 41.23010, 1.87180 ), new L.LatLng( 41.22720, 1.85466 ), new L.LatLng( 41.22877, 1.83673 ), new L.LatLng( 41.22488, 1.82537 ), new L.LatLng( 41.22723, 1.81703 ), new L.LatLng( 41.21729, 1.79443 ), new L.LatLng( 41.21061, 1.75072 ), new L.LatLng( 41.19929, 1.73551 ), new L.LatLng( 41.20297, 1.71736 ), new L.LatLng( 41.20066, 1.70051 ), new L.LatLng( 41.19071, 1.67876 ), new L.LatLng( 41.18663, 1.65963 ), new L.LatLng( 41.18308, 1.61919 ), new L.LatLng( 41.17892, 1.60849 ), new L.LatLng( 41.18126, 1.59887 ), new L.LatLng( 41.17558, 1.54459 ), new L.LatLng( 41.16945, 1.52967 ), new L.LatLng( 41.17079, 1.52006 ), new L.LatLng( 41.15893, 1.47166 ), new L.LatLng( 41.14837, 1.44502 ), new L.LatLng( 41.13653, 1.41792 ), new L.LatLng( 41.12599, 1.40770 ), new L.LatLng( 41.12649, 1.38149 ), new L.LatLng( 41.11759, 1.34533 ), new L.LatLng( 41.12097, 1.33530 ), new L.LatLng( 41.12060, 1.30241 ), new L.LatLng( 41.10678, 1.27633 ), new L.LatLng( 41.10531, 1.26505 ), new L.LatLng( 41.09462, 1.25268 ), new L.LatLng( 41.09416, 1.24509 ), new L.LatLng( 41.07722, 1.22682 ), new L.LatLng( 41.07897, 1.21380 ), new L.LatLng( 41.08969, 1.21067 ), new L.LatLng( 41.07330, 1.19429 ), new L.LatLng( 41.06042, 1.19179 ), new L.LatLng( 41.04829, 1.17656 ), new L.LatLng( 41.04923, 1.15747 ), new L.LatLng( 41.05824, 1.14995 ), new L.LatLng( 41.06717, 1.12583 ), new L.LatLng( 41.05443, 1.08500 ), new L.LatLng( 41.05775, 1.07301 ), new L.LatLng( 41.05275, 1.06176 ), new L.LatLng( 41.05558, 1.05297 ), new L.LatLng( 41.03674, 1.00961 ), new L.LatLng( 41.03299, 0.99080 ), new L.LatLng( 41.00546, 0.95438 ), new L.LatLng( 40.98394, 0.94058 ), new L.LatLng( 40.97947, 0.92133 ), new L.LatLng( 40.94762, 0.88502 ), new L.LatLng( 40.94231, 0.87293 ), new L.LatLng( 40.92181, 0.86045 ), new L.LatLng( 40.91493, 0.84897 ), new L.LatLng( 40.86211, 0.80175 ), new L.LatLng( 40.85191, 0.77852 ), new L.LatLng( 40.84217, 0.77239 ), new L.LatLng( 40.83494, 0.75609 ), new L.LatLng( 40.81905, 0.75103 ), new L.LatLng( 40.80086, 0.71480 ), new L.LatLng( 40.79470, 0.71897 ), new L.LatLng( 40.80193, 0.73174 ), new L.LatLng( 40.80432, 0.74769 ), new L.LatLng( 40.80060, 0.77713 ), new L.LatLng( 40.74344, 0.83708 ), new L.LatLng( 40.74472, 0.87796 ), new L.LatLng( 40.73140, 0.89009 ), new L.LatLng( 40.72037, 0.89288 ), new L.LatLng( 40.69796, 0.88417 ), new L.LatLng( 40.68451, 0.87157 ), new L.LatLng( 40.67009, 0.84798 ), new L.LatLng( 40.63604, 0.76675 ), new L.LatLng( 40.57591, 0.71162 ), new L.LatLng( 40.55356, 0.67506 ), new L.LatLng( 40.54601, 0.64224 ), new L.LatLng( 40.54682, 0.61277 ), new L.LatLng( 40.56480, 0.58808 ), new L.LatLng( 40.58296, 0.58407 ), new L.LatLng( 40.58796, 0.59029 ), new L.LatLng( 40.58789, 0.60619 ), new L.LatLng( 40.59387, 0.60945 ), new L.LatLng( 40.59668, 0.61770 ), new L.LatLng( 40.59272, 0.63194 ), new L.LatLng( 40.59578, 0.64803 ), new L.LatLng( 40.60237, 0.65949 ), new L.LatLng( 40.60395, 0.67325 ), new L.LatLng( 40.59972, 0.69247 ), new L.LatLng( 40.60196, 0.70517 ), new L.LatLng( 40.63160, 0.72935 ), new L.LatLng( 40.62923, 0.69592 ), new L.LatLng( 40.61578, 0.64520 ), new L.LatLng( 40.61543, 0.62068 ), new L.LatLng( 40.60261, 0.61044 ), new L.LatLng( 40.60436, 0.59722 ), new L.LatLng( 40.57779, 0.56736 ), new L.LatLng( 40.56700, 0.56602 ), new L.LatLng( 40.56204, 0.54885 ), new L.LatLng( 40.55050, 0.54629 ), new L.LatLng( 40.54087, 0.53437 ), new L.LatLng( 40.52150, 0.52691 ), new L.LatLng( 40.51649, 0.52071 ), new L.LatLng( 40.52273, 0.48359 ), new L.LatLng( 40.53509, 0.44508 ), new L.LatLng( 40.54771, 0.42645 ), new L.LatLng( 40.56735, 0.42286 ), new L.LatLng( 40.57378, 0.42605 ), new L.LatLng( 40.59025, 0.39791 ), new L.LatLng( 40.59602, 0.39436 ), new L.LatLng( 40.59960, 0.38545 ), new L.LatLng( 40.60211, 0.33399 ), new L.LatLng( 40.60729, 0.31242 ), new L.LatLng( 40.62536, 0.27177 ), new L.LatLng( 40.64685, 0.25460 ), new L.LatLng( 40.66597, 0.25892 ), new L.LatLng( 40.68580, 0.27749 ), new L.LatLng( 40.69647, 0.26360 ), new L.LatLng( 40.69824, 0.25717 ), new L.LatLng( 40.69339, 0.23800 ), new L.LatLng( 40.69981, 0.22696 ), new L.LatLng( 40.72225, 0.21555 ), new L.LatLng( 40.71756, 0.19412 ), new L.LatLng( 40.73084, 0.16039 ), new L.LatLng( 40.74863, 0.14967 ), new L.LatLng( 40.75850, 0.15182 ), new L.LatLng( 40.76587, 0.18769 ), new L.LatLng( 40.77782, 0.20780 ), new L.LatLng( 40.77762, 0.22043 ), new L.LatLng( 40.79465, 0.22644 ), new L.LatLng( 40.80930, 0.25089 ), new L.LatLng( 40.82391, 0.26299 ), new L.LatLng( 40.83664, 0.25003 ), new L.LatLng( 40.85386, 0.24123 ), new L.LatLng( 40.87265, 0.24283 ), new L.LatLng( 40.87741, 0.23327 ), new L.LatLng( 40.88602, 0.22801 ), new L.LatLng( 40.90075, 0.23891 ), new L.LatLng( 40.91432, 0.23825 ), new L.LatLng( 40.92652, 0.24509 ), new L.LatLng( 40.93621, 0.25315 ), new L.LatLng( 40.93919, 0.26218 ), new L.LatLng( 40.95001, 0.26160 ), new L.LatLng( 40.96403, 0.27387 ), new L.LatLng( 40.98391, 0.27103 ), new L.LatLng( 40.99616, 0.25870 ), new L.LatLng( 41.00419, 0.25869 ), new L.LatLng( 41.01132, 0.24942 ), new L.LatLng( 41.02412, 0.25113 ), new L.LatLng( 41.02762, 0.24570 ), new L.LatLng( 41.02832, 0.22896 ), new L.LatLng( 41.04306, 0.20727 ), new L.LatLng( 41.05683, 0.21183 ), new L.LatLng( 41.07310, 0.20756 ), new L.LatLng( 41.08022, 0.19360 ), new L.LatLng( 41.08650, 0.18985 ), new L.LatLng( 41.10406, 0.18966 ), new L.LatLng( 41.11656, 0.19680 ), new L.LatLng( 41.12189, 0.19121 ), new L.LatLng( 41.13162, 0.19093 ), new L.LatLng( 41.14761, 0.21101 ), new L.LatLng( 41.14118, 0.24018 ), new L.LatLng( 41.15796, 0.24558 ), new L.LatLng( 41.15990, 0.26798 ), new L.LatLng( 41.17058, 0.28992 ), new L.LatLng( 41.23151, 0.31367 ), new L.LatLng( 41.24125, 0.33887 ), new L.LatLng( 41.23865, 0.35419 ), new L.LatLng( 41.24967, 0.36288 ), new L.LatLng( 41.27971, 0.37290 ), new L.LatLng( 41.30183, 0.35477 ), new L.LatLng( 41.31432, 0.35811 ), new L.LatLng( 41.32077, 0.34368 ), new L.LatLng( 41.33083, 0.33738 ), new L.LatLng( 41.34902, 0.35145 ), new L.LatLng( 41.35323, 0.36191 ), new L.LatLng( 41.36703, 0.35112 ), new L.LatLng( 41.39002, 0.31296 ), new L.LatLng( 41.39630, 0.30920 ), new L.LatLng( 41.42945, 0.33790 ), new L.LatLng( 41.43840, 0.33400 ), new L.LatLng( 41.45151, 0.34232 ), new L.LatLng( 41.46568, 0.33091 ), new L.LatLng( 41.48611, 0.32846 ), new L.LatLng( 41.49707, 0.34590 ), new L.LatLng( 41.49590, 0.37623 ), new L.LatLng( 41.49919, 0.39010 ), new L.LatLng( 41.54705, 0.43326 ), new L.LatLng( 41.56682, 0.41882 ), new L.LatLng( 41.59177, 0.42358 ), new L.LatLng( 41.58538, 0.40377 ), new L.LatLng( 41.59218, 0.34641 ), new L.LatLng( 41.59690, 0.33972 ), new L.LatLng( 41.62374, 0.33542 ), new L.LatLng( 41.63240, 0.34090 ), new L.LatLng( 41.65498, 0.32553 ), new L.LatLng( 41.66067, 0.31645 ), new L.LatLng( 41.67944, 0.31559 ), new L.LatLng( 41.70398, 0.33391 ), new L.LatLng( 41.72001, 0.35788 ), new L.LatLng( 41.73246, 0.36146 ), new L.LatLng( 41.74759, 0.37759 ), new L.LatLng( 41.75028, 0.38709 ), new L.LatLng( 41.76561, 0.39112 ), new L.LatLng( 41.77589, 0.44835 ), new L.LatLng( 41.77496, 0.45981 ), new L.LatLng( 41.79347, 0.46392 ), new L.LatLng( 41.80913, 0.47511 ), new L.LatLng( 41.81574, 0.49087 ), new L.LatLng( 41.83228, 0.51136 ), new L.LatLng( 41.83195, 0.53838 ), new L.LatLng( 41.86176, 0.54823 ), new L.LatLng( 41.86345, 0.56953 ), new L.LatLng( 41.87089, 0.57264 ), new L.LatLng( 41.87770, 0.59028 ), new L.LatLng( 41.88625, 0.58181 ), new L.LatLng( 41.90954, 0.58869 ), new L.LatLng( 41.92042, 0.58447 ), new L.LatLng( 41.92799, 0.55558 ), new L.LatLng( 41.94363, 0.55082 ), new L.LatLng( 41.97454, 0.57930 ), new L.LatLng( 41.97832, 0.59981 ), new L.LatLng( 41.99906, 0.61494 ), new L.LatLng( 42.00912, 0.64862 ), new L.LatLng( 42.02807, 0.64092 ), new L.LatLng( 42.04524, 0.64646 ), new L.LatLng( 42.05141, 0.65848 ), new L.LatLng( 42.06482, 0.65929 ), new L.LatLng( 42.08284, 0.67097 ), new L.LatLng( 42.09325, 0.67249 ), new L.LatLng( 42.11030, 0.68865 ), new L.LatLng( 42.15365, 0.68450 ), new L.LatLng( 42.16443, 0.69343 ), new L.LatLng( 42.17365, 0.68633 ), new L.LatLng( 42.19438, 0.69189 ), new L.LatLng( 42.20123, 0.69793 ), new L.LatLng( 42.22927, 0.70416 ), new L.LatLng( 42.25639, 0.72409 ), new L.LatLng( 42.28722, 0.72750 ), new L.LatLng( 42.30599, 0.73449 ), new L.LatLng( 42.31924, 0.74570 ), new L.LatLng( 42.32453, 0.73379 ), new L.LatLng( 42.33830, 0.72936 ), new L.LatLng( 42.35095, 0.74119 ), new L.LatLng( 42.36536, 0.71273 ), new L.LatLng( 42.37427, 0.71396 ), new L.LatLng( 42.38690, 0.73249 ), new L.LatLng( 42.39479, 0.72867 ), new L.LatLng( 42.40343, 0.71644 ), new L.LatLng( 42.41032, 0.71619 ), new L.LatLng( 42.41632, 0.72205 ), new L.LatLng( 42.43398, 0.70071 ), new L.LatLng( 42.46187, 0.69702 ), new L.LatLng( 42.47138, 0.68732 ), new L.LatLng( 42.48860, 0.67998 ), new L.LatLng( 42.50582, 0.69660 ), new L.LatLng( 42.50238, 0.71477 ), new L.LatLng( 42.50596, 0.71943 ), new L.LatLng( 42.51105, 0.71024 ), new L.LatLng( 42.52982, 0.71070 ), new L.LatLng( 42.54188, 0.71838 ), new L.LatLng( 42.54916, 0.73057 ), new L.LatLng( 42.57411, 0.74708 ), new L.LatLng( 42.60503, 0.75359 ), new L.LatLng( 42.60572, 0.73483 ), new L.LatLng( 42.61438, 0.70478 ), new L.LatLng( 42.62724, 0.68836 ), new L.LatLng( 42.64253, 0.68969 ), new L.LatLng( 42.65396, 0.68455 ), new L.LatLng( 42.66639, 0.66836 ), new L.LatLng( 42.68984, 0.64898 ), new L.LatLng( 42.69894, 0.65224 ), new L.LatLng( 42.70229, 0.66330 ), new L.LatLng( 42.71025, 0.66770 ), new L.LatLng( 42.72051, 0.66184 ), new L.LatLng( 42.72574, 0.66389 ), new L.LatLng( 42.74445, 0.65191 ), new L.LatLng( 42.74842, 0.63486 ), new L.LatLng( 42.75620, 0.62816 ), new L.LatLng( 42.77426, 0.64391 ), new L.LatLng( 42.78136, 0.63545 ), new L.LatLng( 42.78825, 0.63519 ), new L.LatLng( 42.80861, 0.65697 ), new L.LatLng( 42.81591, 0.65377 ), new L.LatLng( 42.82284, 0.65688 ), new L.LatLng( 42.82890, 0.65083 ), new L.LatLng( 42.84243, 0.64864 ), new L.LatLng( 42.85515, 0.66691 ), new L.LatLng( 42.86526, 0.67388 ), new L.LatLng( 42.86601, 0.69007 ), new L.LatLng( 42.87231, 0.70992 ), new L.LatLng( 42.86414, 0.74128 ), new L.LatLng( 42.85761, 0.74795 ), new L.LatLng( 42.84704, 0.78101 ), new L.LatLng( 42.85103, 0.80590 ), new L.LatLng( 42.83948, 0.83725 ), new L.LatLng( 42.83716, 0.86111 ), new L.LatLng( 42.80194, 0.92806 ), new L.LatLng( 42.81142, 0.94220 ), new L.LatLng( 42.81679, 0.96063 ), new L.LatLng( 42.81201, 0.97540 ), new L.LatLng( 42.79781, 0.99120 ), new L.LatLng( 42.80166, 1.00662 ), new L.LatLng( 42.79347, 1.05611 ), new L.LatLng( 42.79865, 1.08417 ), new L.LatLng( 42.78666, 1.09708 ), new L.LatLng( 42.77995, 1.11813 ), new L.LatLng( 42.76219, 1.13971 ), new L.LatLng( 42.75233, 1.14598 ), new L.LatLng( 42.74611, 1.14340 ), new L.LatLng( 42.73456, 1.14769 ), new L.LatLng( 42.72052, 1.16989 ), new L.LatLng( 42.73859, 1.22983 ), new L.LatLng( 42.73293, 1.25254 ), new L.LatLng( 42.72692, 1.26114 ), new L.LatLng( 42.72879, 1.30980 ), new L.LatLng( 42.73550, 1.33292 ), new L.LatLng( 42.72970, 1.34728 ), new L.LatLng( 42.72783, 1.36703 ), new L.LatLng( 42.71689, 1.37084 ), new L.LatLng( 42.70851, 1.36548 ), new L.LatLng( 42.70549, 1.38234 ), new L.LatLng( 42.69288, 1.40095 ), new L.LatLng( 42.67869, 1.40169 ), new L.LatLng( 42.66081, 1.42595 ), new L.LatLng( 42.63176, 1.43302 ), new L.LatLng( 42.62623, 1.44041 ), new L.LatLng( 42.61430, 1.44428 ), new L.LatLng( 42.60745, 1.45520 ), new L.LatLng( 42.59272, 1.45266 ), new L.LatLng( 42.58413, 1.44224 ), new L.LatLng( 42.57741, 1.45539 ), new L.LatLng( 42.56624, 1.45674 ), new L.LatLng( 42.55413, 1.43783 ), new L.LatLng( 42.54819, 1.46053 ), new L.LatLng( 42.51208, 1.48135 ), new L.LatLng( 42.50489, 1.47679 ), new L.LatLng( 42.48800, 1.44533 ), new L.LatLng( 42.48126, 1.45345 ), new L.LatLng( 42.47020, 1.45403 ), new L.LatLng( 42.46559, 1.45962 ), new L.LatLng( 42.44657, 1.45959 ), new L.LatLng( 42.43988, 1.51665 ), new L.LatLng( 42.44465, 1.54190 ), new L.LatLng( 42.45946, 1.54589 ), new L.LatLng( 42.46872, 1.55684 ), new L.LatLng( 42.46709, 1.57680 ), new L.LatLng( 42.47907, 1.60018 ), new L.LatLng( 42.47540, 1.61000 ), new L.LatLng( 42.47882, 1.64986 ), new L.LatLng( 42.49768, 1.65189 ), new L.LatLng( 42.51323, 1.66193 ), new L.LatLng( 42.51597, 1.67048 ), new L.LatLng( 42.51343, 1.67914 ), new L.LatLng( 42.50585, 1.68553 ), new L.LatLng( 42.50291, 1.70332 ), new L.LatLng( 42.51167, 1.71499 ), new L.LatLng( 42.51398, 1.72658 ), new L.LatLng( 42.51143, 1.73524 ), new L.LatLng( 42.50488, 1.73976 ), new L.LatLng( 42.50542, 1.75283 ), new L.LatLng( 42.49902, 1.76789 ), new L.LatLng( 42.49654, 1.79053 ), new L.LatLng( 42.50095, 1.80481 ), new L.LatLng( 42.49581, 1.81845 ), new L.LatLng( 42.49598, 1.82962 ), new L.LatLng( 42.48456, 1.85384 ), new L.LatLng( 42.47589, 1.85901 ), new L.LatLng( 42.46924, 1.88794 ), new L.LatLng( 42.46086, 1.89534 ), new L.LatLng( 42.45817, 1.91577 ), new L.LatLng( 42.46525, 1.93232 ), new L.LatLng( 42.46278, 1.94569 ), new L.LatLng( 42.48389, 1.95276 ), new L.LatLng( 42.49376, 1.96625 ), new L.LatLng( 42.50307, 1.97144 ), new L.LatLng( 42.50567, 1.98214 ), new L.LatLng( 42.50201, 1.99857 ), new L.LatLng( 42.49064, 2.01067 ), new L.LatLng( 42.48375, 2.01078 ), new L.LatLng( 42.47486, 2.00085 ), new L.LatLng( 42.46311, 2.02098 ), new L.LatLng( 42.45073, 2.02651 ), new L.LatLng( 42.44260, 2.01853 ), new L.LatLng( 42.44002, 2.00404 ), new L.LatLng( 42.44019, 1.98120 ), new L.LatLng( 42.44764, 1.95567 ), new L.LatLng( 42.43742, 1.95518 ), new L.LatLng( 42.42972, 1.97061 ), new L.LatLng( 42.41422, 1.96924 ), new L.LatLng( 42.38627, 1.97804 ), new L.LatLng( 42.37102, 1.99616 ), new L.LatLng( 42.36366, 2.01379 ), new L.LatLng( 42.36875, 2.03201 ), new L.LatLng( 42.36936, 2.05742 ), new L.LatLng( 42.37596, 2.06896 ), new L.LatLng( 42.37638, 2.07792 ), new L.LatLng( 42.38194, 2.08151 ), new L.LatLng( 42.39026, 2.10358 ), new L.LatLng( 42.39988, 2.10477 ), new L.LatLng( 42.42195, 2.12300 ), new L.LatLng( 42.43391, 2.15369 ), new L.LatLng( 42.43536, 2.16846 ), new L.LatLng( 42.42889, 2.18536 ), new L.LatLng( 42.42817, 2.20233 ), new L.LatLng( 42.43609, 2.22114 ), new L.LatLng( 42.43840, 2.23852 ), new L.LatLng( 42.44966, 2.25765 ), new L.LatLng( 42.43506, 2.29629 ), new L.LatLng( 42.43912, 2.30292 ), new L.LatLng( 42.43862, 2.31834 ), new L.LatLng( 42.42714, 2.33283 ), new L.LatLng( 42.42508, 2.35353 ), new L.LatLng( 42.41553, 2.35878 ), new L.LatLng( 42.41292, 2.36692 ), new L.LatLng( 42.41057, 2.39162 ), new L.LatLng( 42.40271, 2.41456 ), new L.LatLng( 42.40366, 2.43776 ), new L.LatLng( 42.39525, 2.44707 ), new L.LatLng( 42.38267, 2.44720 ), new L.LatLng( 42.37730, 2.46474 ), new L.LatLng( 42.35186, 2.48815 ), new L.LatLng( 42.35339, 2.50555 ), new L.LatLng( 42.34402, 2.53286 ), new L.LatLng( 42.34937, 2.54189 ), new L.LatLng( 42.36235, 2.54643 ), new L.LatLng( 42.36904, 2.57198 ), new L.LatLng( 42.36693, 2.59359 ), new L.LatLng( 42.35742, 2.61493 ), new L.LatLng( 42.35168, 2.66448 ), new L.LatLng( 42.36411, 2.65121 ), new L.LatLng( 42.37318, 2.65136 ), new L.LatLng( 42.38840, 2.64054 ), new L.LatLng( 42.39878, 2.65000 ), new L.LatLng( 42.39820, 2.66172 ), new L.LatLng( 42.40698, 2.66119 ), new L.LatLng( 42.41405, 2.66915 ), new L.LatLng( 42.41712, 2.68755 ), new L.LatLng( 42.43101, 2.71296 ), new L.LatLng( 42.43536, 2.73356 ), new L.LatLng( 42.43572, 2.76224 ), new L.LatLng( 42.42422, 2.77339 ), new L.LatLng( 42.42885, 2.79070 ), new L.LatLng( 42.44099, 2.79675 ), new L.LatLng( 42.45031, 2.81304 ), new L.LatLng( 42.45065, 2.82135 ), new L.LatLng( 42.45948, 2.82458 ), new L.LatLng( 42.46940, 2.83590 ), new L.LatLng( 42.46750, 2.85274 ), new L.LatLng( 42.47847, 2.87140 ), new L.LatLng( 42.46749, 2.91425 ), new L.LatLng( 42.48108, 2.92319 ), new L.LatLng( 42.49229, 2.94343 ), new L.LatLng( 42.49229, 2.95274 ), new L.LatLng( 42.47813, 2.97384 ), new L.LatLng( 42.48530, 2.99001 ), new L.LatLng( 42.47993, 3.01370 ), new L.LatLng( 42.48558, 3.03232 ), new L.LatLng( 42.48424, 3.04542 ), new L.LatLng( 42.45667, 3.06536 ), new L.LatLng( 42.43623, 3.09143 ), new L.LatLng( 42.44486, 3.10477 ), new L.LatLng( 42.44881, 3.12074 ), new L.LatLng( 42.44471, 3.14632 ), new L.LatLng( 42.44552, 3.18039 ), new L.LatLng( 42.43680, 3.18860 ), new L.LatLng( 42.41476, 3.18332 ), new L.LatLng( 42.40863, 3.17736 ), new L.LatLng( 42.39073, 3.18107 ), new L.LatLng( 42.38223, 3.17498 ), new L.LatLng( 42.36530, 3.18167 ), new L.LatLng( 42.35725, 3.20011 ), new L.LatLng( 42.36240, 3.23048 ), new L.LatLng( 42.36052, 3.24053 ), new L.LatLng( 42.35717, 3.24796 ), new L.LatLng( 42.34815, 3.25260 ), new L.LatLng( 42.35058, 3.27351 ), new L.LatLng( 42.33019, 3.33835 ), new L.LatLng( 42.32232, 3.34579 ), new L.LatLng( 42.31401, 3.34092 ), new L.LatLng( 42.30439, 3.31390 ), new L.LatLng( 42.29693, 3.32216 ), new L.LatLng( 42.28874, 3.32226 ), new L.LatLng( 42.27394, 3.30024 ), new L.LatLng( 42.25216, 3.29385 ), new L.LatLng( 42.24560, 3.27963 ), new L.LatLng( 42.23110, 3.27085 ), new L.LatLng( 42.23061, 3.25809 ), new L.LatLng( 42.23767, 3.24049 ), new L.LatLng( 42.22709, 3.22677 ), new L.LatLng( 42.22585, 3.21460 ), new L.LatLng( 42.24077, 3.17513 ), new L.LatLng( 42.25582, 3.16364 ), new L.LatLng( 42.24691, 3.14951 ), new L.LatLng( 42.22740, 3.13309 ), new L.LatLng( 42.20274, 3.12392 ), new L.LatLng( 42.14981, 3.12989 ), new L.LatLng( 42.13915, 3.13706 ), new L.LatLng( 42.13189, 3.14843 ), new L.LatLng( 42.11976, 3.18648 ), new L.LatLng( 42.09360, 3.20674 ) ];\nvar CatPol= [ [ 0.83496, 42.75105 ], [ 0.78552, 41.90228 ], [ 0.32959, 40.75974 ], [0.47790,40.56389 ], [0.70861,40.48455 ], [0.95581,40.66397 ], [1.08215,40.95501 ], [2.12036,41.19105 ], [3.05419,41.60722 ], [3.38928,41.78360 ], [3.33435,42.13896 ], [3.43322,42.26104 ], [3.32336,42.42751 ], [1.88415,42.35448 ], [ 0.83496, 42.75105 ]  ] ;\nvar CatBounds = L.latLngBounds(L.latLng(40.47, 0.1087), L.latLng(42.8855, 3.33669));\n\n//var CatBounds = L.latLngBounds(L.latLng(40.47, 0.77), L.latLng(42.45, 3.33669));\n\nvar MQ_ATTR='Font:<a  href=\"https://www.openstreetmap.org/\" target=\"_blank\">OpenStreetMap </a>';\nvar ESRI_ATTR='Tiles © Esri  Sources: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping,Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';\nvar ESRI_ATTR_TERRAIN=\"Tiles © Esri Sources: Esri, USGS, NOAA\";\nvar ICGC='Font:<a  href=\"http://www.icc.cat\" target=\"_blank\">Institut Cartogràfic i Geològic de Catalunya</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>';\nvar ICGC_MON='Font:Mapa del Món (<a  href=\"http://www.icc.cat\" target=\"_blank\">ICGC</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>)';\nvar ICGC_HISTO='Font:Mapa de Catalunya 1936 (<a  href=\"http://www.icc.cat\" target=\"_blank\">ICGC</a> - <a  href=\"http://www.icc.cat/cat/Home-ICC/Transparencia/Reutilitzacio-de-la-informacio/Condicions-d-us-de-la-geoinformacio-ICGC\" target=\"_blank\">CC-BY</a>)';\nvar ICGC_HISTOOrto='Font:Vol americà 1956-57 Ministerio de Defensa';\nvar ICGC_HISTOOrto46='Font:Vol Americà A 1946-47 Ministerio de Defensa';\nvar _topoLayers=null,TOPO_ICC_L0_6,TOPO_MQ_L7_19,TOPO_ICC_L7_10,TOPO_ICC_L11_12,TOPO_ICC_L12_19;\nvar _topoLayersGeo=null,TOPO_GEO_MQ_L15_18,TOPO_GEO_MON_L0_14,TOPO_GEO_ICC_L8_12,TOPO_GEO_OMBRA_L8_12,TOPO_GEO_ICC_L8_17,TOPO_GEO_ICC_L8_17_TOPONIMS;\nvar _ortoLayers=null,ORTO_ESRI_L0_19,ORTO_ICC_L0_11,ORTO_ICC_L12_19,ORTO_ICC_L9_12;\n\n\nvar _ortoAurgmentada=null,ORTO_ESRI_L0_19,ORTO_AUGMENTADA_L4_17,ORTO_ICC_L18_20;\nvar _hibridLayers=null,HIBRID_MQ_L0_18,HIBRID_ICGC_L0_18,HIBRID_ICGC_L13_18;\nvar _histoMap=null;\nvar _histoOrtoMap=null;\nvar _histoOrtoMap46=null;\nvar _alcadesMap=null;\nvar _naturalMap=null;\nvar _divadminMap=null;\nvar _colorBlankMap=null;\nvar _hibridTerrainMap=null;\n\n\nvar ESRI_RELLEU_L0_13;\nvar ICC_RELLEU_L0_14;\nvar MQ_TOPO_GRIS_L15_19,ICC_TOPO_GRIS_L7_10,ICC_TOPO_GRIS_L11_19,ICC_MON_L0,MQ_TOPO_GRIS_L0_14;\nvar COLOR_TOPO_ICC_L0_6,COLOR_TOPO_MQ_L7_19,COLOR_TOPO_ICC_L11_19;\nvar HISTO_ICC_L0_14;\nvar HISTOOrto_ICC_L0_14;\nvar HISTOOrto46_ICC_L0_14;\nvar ALCADAMAPA_ICGC_L0_17;\nvar DIVADMIN_L0_14;\nvar DIVADMIN_L14_18;\nvar DIVADMIN_L14_18_TOPO;\n\nvar ORTO_HIBRID_8_18_VECTOR;\nvar ORTO_HIBRID_L8_17_TOPONIMS;\nvar TERRAIN_HIBRID_8_18_VECTOR;\nvar _terrainLayers=null;\nvar _topoColorLayers=null;\nvar _grisLayers=null;\nvar _ombraLayer=null;\n//var subDomains=['otile1','otile2','otile3','otile4'];0\nvar subDomains=['a','b','c'];\nvar subDomainsA=['a','b','c'];\n//var urlServerTiles=\"http://www.{s}.instamaps.cat\"\n//var urlServerTilesW=\"http://www.instamaps.cat\"\t\n\nvar urlServerTiles=\"http://{s}.tilemaps.icgc.cat\";\t\nvar urlServerTilesW=\"http://{s}.tilemaps.icgc.cat\";\n\n\nvar urlApp=document.location.href;\n\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)||(urlApp.indexOf('172.70.1.11')!=-1)){\n\t\n\t//urlServerTiles=\"http://imtilemapsdev.icgc.local\";\n\turlServerTilesW=\"http://imtilemapsdev.icgc.local\";\t\n\turlServerTiles=\"http://{s}.tilemaps.icgc.cat\";\n\t//urlServerTilesW=\"http://{s}.tilemaps.icgc.cat\";\n\t\n\n\t\n}\n\n\nvar FONS_TOPOMAP='topoMap';\nvar FONS_TOPOMAP_GEO='topoMapGeo';\nvar FONS_ORTOMAP='ortoMap';\nvar FONS_ORTOAUGMENTADA='ortoAugmentada';\nvar FONS_HIBRIDMAP='hibridMap';\nvar FONS_TERRAINMAP='terrainMap';\nvar FONS_TOPOGISMAP='topoGrisMap';\nvar FONS_COLORMAP='colorMap';\nvar FONS_HISTORICMAP='historicMap';\nvar FONS_HISTORICORTOMAP='historicOrtoMap';\nvar FONS_HISTORICORTOMAP46='historicOrtoMap46';\nvar FONS_ALCADAMAP='alcadaMap';\nvar FONS_NATURAL='naturalMap';\nvar FONS_DIVADMIN='divadminMap';\nvar FONS_COLORBLANK='colorBlankMap';\nvar FONS_HIBRIDTERRAIN='hibridTerrainMap';\n\nvar URL_MQ='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';\n\nvar mapaUrl = {\t\n\ttopoMapMON:urlServerTiles+'/mapfactory/wmts/mon_cat/MON3857/{z}/{x}/{y}.png',\n\ttopoMapOSM:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n\ttopoMapICGC:'http://mapcache.{s}.icc.cat/map/bases_noutm/wmts/topo/GRID3857/{z}/{x}/{y}.jpeg',\t\n\ttopoMapSuauOSM:urlServerTiles+'/mapfactory/wmts/osm_suau/CAT3857_15/{z}/{x}/{y}.png',\n\ttopoMapSuauICGC:urlServerTiles+'/mapfactory/wmts/topo_suau/CAT3857/{z}/{x}/{y}.png',\t\n\tortoEsri:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n\tortoInstamaps:urlServerTiles+'/mapfactory/wmts/orto_8_12/CAT3857/{z}/{x}/{y}.png',\n\tortoAugmentada:urlServerTilesW+'/mapfactory/wmts/orto_augmentada/CAT3857/{z}/{x}/{y}.jpeg',\n\tortoICGC:\"http://mapcache.{s}.icc.cat/map/bases_noutm/wmts/orto/GRID3857/{z}/{x}/{y}.jpeg\",\n\thibridInstamaps:urlServerTiles+'/mapfactory/wmts/hibrida/CAT3857/{z}/{x}/{y}.png',\t\n\tterrainEsri:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',\n\tterrainInstamaps:urlServerTiles+'/mapfactory/wmts/relleu/CAT3857/{z}/{x}/{y}.png',\t\n\tombraInstamaps:urlServerTiles+'/mapfactory/wmts/h_ombra/CAT3857/{z}/{x}/{y}.png',\t\n\torto46ICGC:urlServerTiles+'/mapfactory/wmts/orto46/CAT3857/{z}/{x}/{y}.png',\t\n\torto55ICGC:urlServerTiles+'/mapfactory/wmts/orto55/CAT3857/{z}/{x}/{y}.png',\n\ttopo36ICGC:urlServerTiles+'/mapfactory/wmts/cat1936/CAT3857/{z}/{x}/{y}.png',\t\n\ttopoGrisOSM:urlServerTiles+'/mapfactory/wmts/gris_osm_suau/CAT3857_15/{z}/{x}/{y}.png',\n\ttopoGrisICGC:urlServerTiles+'/mapfactory/wmts/gris_topo_suau/CAT3857/{z}/{x}/{y}.png',\t\n\ttopoNaturalOSM:'http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png',\n\ttopoNaturalSuau:urlServerTiles+'/mapfactory/wmts/natural_suau/CAT3857/{z}/{x}/{y}.png',\n\ttoponimsNaturalSuau:urlServerTiles+'/mapfactory/wmts/toponimia/CAT3857/{z}/{x}/{y}.png',\t\n    topoLimitsSuau:urlServerTiles+'/mapfactory/wmts/limits/CAT3857/{z}/{x}/{y}.png',\n\tfonsBlank:'',\n\thibridTotal:urlServerTiles+'/mapfactory/wmts/hibrida_total/CAT3857/{z}/{x}/{y}.png',\n\ttopoSuauColor:{\n\t\tzombie:{suau:urlServerTiles+'/mapfactory/wmts/coure_topo_suau/CAT3857/{z}/{x}/{y}.png',\n\t\t\t\tosm:urlServerTiles+'/mapfactory/wmts/coure_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\n\t\tnit:{suau:urlServerTiles+'/mapfactory/wmts/nit_topo_suau/CAT3857/{z}/{x}/{y}.png',\n\t\t\t osm:urlServerTilesW+'/mapfactory/wmts/nit_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\n\t\torquidea:{suau:urlServerTiles+'/mapfactory/wmts/blueprint_topo_suau/CAT3857/{z}/{x}/{y}.png',\n\t\t\t\t  osm:urlServerTiles+'/mapfactory/wmts/blueprint_osm_suau/CAT3857_15/{z}/{x}/{y}.png'},\n\t\tsepia:{suau:urlServerTiles+'/mapfactory/wmts/sepia_topo_suau/CAT3857/{z}/{x}/{y}.png',\n\t\t\t   osm:urlServerTilesW+'/mapfactory/wmts/sepia_osm_suau/CAT3857_15/{z}/{x}/{y}.png'}\n\t}\t\t\t\n}\t\n\n\nL.IM_Map = L.Map.extend({\n\n\toptions: {\n\t\ttypeMap:FONS_TOPOMAP,\n\t\tmapColor: '',\n\t\tmeasureControl:true\n\t},\n\n\tinitialize: function(id,options) {\n\t\tL.Map.prototype.initialize.call(this,id,options);\n\t\tL.Util.setOptions(this, options);\n\n\t\tthis.activeMap=this.options.typeMap;\n\n\t\tif(this.options.typeMap==FONS_TOPOMAP){this.topoMap();\n\t\t}else if(this.options.typeMap==FONS_ORTOMAP){this.ortoMap();\t\t\n\t\t}else if(this.options.typeMap==FONS_ORTOAUGMENTADA){this.ortoAugmentada();\n\t\t}else if(this.options.typeMap==FONS_HIBRIDMAP){this.hibridMap();\n\t\t}else if(this.options.typeMap==FONS_TOPOMAP_GEO){this.topoMapGeo();\n\t\t}else if(this.options.typeMap==FONS_TERRAINMAP){this.terrainMap();\n\t\t}else if(this.options.typeMap==FONS_TOPOGISMAP){this.topoGrisMap();\n\t\t}else if(this.options.typeMap==FONS_COLORMAP){this.colorMap();\n\t\t}else if(this.options.typeMap==FONS_HISTORICMAP){this.historicMap();\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP){this.historicOrtoMap();\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP46){this.historicOrtoMap46();\n\t\t}else if(this.options.typeMap==FONS_ALCADAMAP){this.alcadaMap();\n\t\t}else if(this.options.typeMap==FONS_NATURAL){this.naturalMap();\n\t\t}else if(this.options.typeMap==FONS_DIVADMIN){this.divadminMap();\n\t\t}else if(this.options.typeMap==FONS_COLORBLANK){this.colorBlankMap();\n\t\t}else if(this.options.typeMap==FONS_HIBRIDTERRAIN){this.hibridTerrainMap();\n\t\t}else{\n\t\tthis.activeMap=FONS_TOPOMAP;this.topoMap();\n\t\t}\n\t\t\n\n\t\tthis.on('moveend', function(){\n\t\t\tthis.gestionaFons(false);\n\t\t});\n\t\t\n\t\tthis.on('layeradd', function(){\n\t\t\tthis.gestionaFons(true);\n\t\t});\n\t\t\n\t\n\t\t\n\t},\n\t//Funcio nova 3D\n\tgetLGActiveMap:function(){\n\n\t\tif(this.options.typeMap==FONS_TOPOMAP){return _topoLayers;\n\t\t}else if(this.options.typeMap==FONS_ORTOMAP){return _ortoLayers;\n\t\t\n\t\t}else if(this.options.typeMap==FONS_ORTOAUGMENTADA){return _ortoAurgmentada;\n\t\t}else if(this.options.typeMap==FONS_HIBRIDMAP){return _hibridLayers;\n\t\t}else if(this.options.typeMap==FONS_TOPOMAP_GEO){return _topoLayersGeo;\n\t\t}else if(this.options.typeMap==FONS_TERRAINMAP){return _terrainLayers;\n\t\t}else if(this.options.typeMap==FONS_TOPOGISMAP){return _grisLayers;\n\t\t}else if(this.options.typeMap==FONS_COLORMAP){return _topoColorLayers;\n\t\t}else if(this.options.typeMap==FONS_HISTORICMAP){return _histoMap;\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP){return _histoOrtoMap;\n\t\t}else if(this.options.typeMap==FONS_HISTORICORTOMAP46){return _histoOrtoMap46;\n\t\t}else if(this.options.typeMap==FONS_ALCADAMAP){return _alcadesMap;\n\t\t}else if(this.options.typeMap==FONS_NATURAL){return _naturalMap;\n\t\t}else if(this.options.typeMap==FONS_DIVADMIN){return _divadminMap;\n\t\t}else if(this.options.typeMap==FONS_COLORBLANK){return _colorBlankMap;\n\t\t}else if(this.options.typeMap==FONS_HIBRIDTERRAIN){return _hibridTerrainMap;\n\t\t}else{\n\t\treturn _topoLayers;\n\t\t}\n\n\t},\n\tgetActiveMap:function(){\n\t\treturn this.options.typeMap;\n\t},\n\n\tgetCurrentZoomLevel:function(){\n\t\t\n\t\tif(estatMapa3D){\n\n\t\t\treturn \"\";\n\t\t}else{\n\t\t\t\n\t\t\treturn \" ZL:\"+this.getZoom();\n\t\t\n\t\t}\t\t\n\t\t\n\t\t\n\t\t\n\t},\t\n\tsetActiveMap:function(typeMap){\n\t\tthis.options.typeMap = typeMap;\n\n\t\t//Activa mapa vista 3D\n\t\tif(estatMapa3D){\n\n\t\t\tmapaVista3D.addBaseLayersCesium();\n\t\t}\n\t},\n\n\tgetMapColor:function(){\n\n\t\treturn this.options.mapColor;\n\t},\n\n\tsetMapColor:function(mapColor){\n\t\tthis.options.mapColor = mapColor;\n\n\t},\n\tmiraCentreDins:function(x,y){\n\t\tvar x0=0.1087; //0.7525\n\t\tvar y0=40.4763; // 40.5263\n\t\tvar x1=3.33669; // 3.3563\n\t\tvar y1=42.8855;  // 42.3748\n\t\tif(x>=x0&&x<=x1&&y>=y0&&y<=y1){return true;}else{return false;}\n\t},\n\n\tdinsCatalunya:function(MapBounds){\n\n\n\t\tvar x = MapBounds.getWest(), y =MapBounds.getNorth();\n\n\t    var inside = false;\n\t    for (var i = 0, j = CatPol.length - 1; i < CatPol.length; j = i++) {\n\t        var xi = CatPol[i][0], yi = CatPol[i][1];\n\t        var xj = CatPol[j][0], yj = CatPol[j][1];\n\n\t        var intersect = ((yi > y) != (yj > y))\n\t            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\n\t        if (intersect) inside = !inside;\n\t    }\n\n\t    return inside;\n\n\n\t},\n\n\n\tmiraBBContains:function(MapBounds){\n\n\n\t\tvar cas=0;\n\t\tvar vC=CatBounds.intersects(MapBounds);// True es veu Cat\n\t\tvar nC=CatBounds.contains(MapBounds);//True nomes Cat\n\t\t   if(!vC){\n\t\t\tcas=0; //Estic fora de Cat\n\t\t   }else if(vC && !nC){ //veig Cat i altres\n\t\t\t//cas=1;\n\n\t\t\t   this.dinsCatalunya(MapBounds)?cas=2:cas=1\n\n\t\t   }else if (vC && nC){ //Nomes veig cat\n\n\n\t\t\tthis.dinsCatalunya(MapBounds)?cas=2:cas=1;\n\n\t\t   }\n\n\n\t\treturn cas;\n\t},\n\tmirarActivarHill:function(hoMiro,zoom,sC){\n\n\n\t},\n\tsetHillActiu:function(grup,actiu){\n\t\t\n\n\t},\n\tsetTransActiveMap:function(trans,hillActiu){\n\n\t\n\n\t},\n\tgestionaFons:function(layerAdd){\n\t\tvar sC=this.miraBBContains(this.getBounds());\n\t\tvar f=this.getActiveMap();\n\t\tvar zT=14;\n\n\t\tif(f==FONS_TOPOMAP){ //_topoLayers=null,TOPO_ICC_L0_6,TOPO_MQ_L7_19,TOPO_ICC_L7_10,TOPO_ICC_L11_19;\n\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\n\n\n\t\t\tif((sC==0)){\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(1);\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=19;\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=zT;\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=zT;\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=zT;\n\t\t\t\tif(this.getZoom() > 6){\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\t//TOPO_ICC_L0_6\n\t\t\t\t\t_topoLayers.removeLayer(TOPO_ICC_L0_6);\n\t\t\t\t}else{\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\n\t\t\t\t\t_topoLayers.addLayer(TOPO_ICC_L0_6);\n\t\t\t\t}\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\t\t\t}else if(sC==1){\n\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(1);\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=19;\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=12;\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=10;\n\t\t\t\tif(this.getZoom() > 6){\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \" - \"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\t_topoLayers.removeLayer(TOPO_ICC_L0_6);\n\t\t\t\t}else{\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\n\t\t\t\t\t_topoLayers.addLayer(TOPO_ICC_L0_6);\n\t\t\t\t}\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\t\t\t}else if(sC==2){\n\t\t\t\tTOPO_MQ_L7_19.setOpacity(0);\n\t\t\t\tTOPO_MQ_L7_19.options.maxZoom=zT;\n\t\t\t\tTOPO_ICC_L11_12.options.maxZoom=12;\n\t\t\t\tTOPO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\tTOPO_ICC_L7_10.options.maxZoom=10;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\tjQuery('#map').css('backgroundColor','#E0EAF3');\n\t\t\t\t\n\t\t\t}\n\n\t\t//var _topoLayersGeo=null,TOPO_GEO_MQ_L15_18,TOPO_GEO_ICC_L8_12,TOPO_GEO_ICC_L8_17;\n\t\t}else if(f==FONS_TOPOMAP_GEO){\n\t\t\t\t\t\n\t\t\t\tif(sC==0){\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(1);\n\t\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=18;\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\n\t\t\t\t}else if(sC==1){\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(0.7);\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=18;\n\t\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\n\t\t\t\t}else if(sC==2){\n\t\t\t\t\tTOPO_GEO_MQ_L15_18.options.maxZoom=14;\n\t\t\t\t\t//TOPO_GEO_MQ_L15_18.setOpacity(0);\n\t\t\t\t\t//TOPO_GEO_MON_L0_14.setOpacity(0);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\n\t\t\t\t}\n\n\n\t\t}else if(f==FONS_NATURAL){\n\n\n\n\t\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)|| (sC==1)){\n\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(1);\n\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(1);\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+\" - \"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\t\t\t}else if(sC==2){\n\t\t\t\tTOPO_GEO_MQ_L15_18.setOpacity(0);\n\t\t\t\tTOPO_GEO_MON_L0_14.setOpacity(0);\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\tjQuery('#map').css('backgroundColor','#CBDCDC');\n\t\t\t}\n\n\n\n\t\t}else if(f==FONS_ORTOMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)){ //Fora Cat\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=19;\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=zT;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=zT;\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(1);\n\t\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\t\t\t\t}else if(sC==1){ //Cat i altres\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=17;\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=12;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0.8);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\n\t\t\t\t}else if(sC==2){ //Nomes cat\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0);\n\t\t\t\t\tORTO_ICC_L0_11.options.maxZoom=12;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\n\t\t\t\t}\n\n\t\t\t\n\t\t}else if(f==FONS_HIBRIDMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)){ //Fora Cat\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=19;\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=zT;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=zT;\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(1);\n\t\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#DDDDDD');\n\t\t\t\t}else if(sC==1){ //Cat i altres\n\t\t\t\t\tORTO_ESRI_L0_19.options.maxZoom=17;\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=17;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0.8);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\n\t\t\t\t}else if(sC==2){ //Nomes cat\n\t\t\t\t\tORTO_ESRI_L0_19.setOpacity(0);\n\t\t\t\t\tORTO_AUGMENTADA_L4_17.options.maxZoom=17;\n\t\t\t\t\tORTO_ICC_L12_19.options.maxZoom=20;\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#1B2C4A');\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\n\t\t\tif((parseInt(this.getZoom()) >= 7) &&(parseInt(this.getZoom()) <= 11)) {\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.4);\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(0.8);\n\t\t\t\t\n\t\t\t}else if ((parseInt(this.getZoom()) >= 12) &&(parseInt(this.getZoom()) <= 13)) {\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.5);\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(0.8);\n\t\t\t\t\n\t\t\t}else{\n\t\t\t\t\n\t\t\t\tORTO_HIBRID_8_18_VECTOR.setOpacity(0.8);\n\t\t\t\tORTO_HIBRID_L8_17_TOPONIMS.setOpacity(1);\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t/*\t\n\n\t\t}else if(f==FONS_HIBRIDMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)){ //Fora Cat\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=18;\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=zT;\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=zT;\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(1);\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t}else if(sC==1){ //Cat i altres\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=18;\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=18;\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=18;\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(0.8);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#192A46');\n\t\t\t\t}else if(sC==2){ //Nomes cat\n\t\t\t\t\tHIBRID_MQ_L0_18.options.maxZoom=zT;\n\t\t\t\t\tHIBRID_ICGC_L0_18.options.maxZoom=18;\n\t\t\t\t\t//HIBRID_ICGC_L13_18.options.maxZoom=18;\n\t\t\t\t\tHIBRID_MQ_L0_18.setOpacity(0);\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t\t\tjQuery('#map').css('backgroundColor','#192A46');\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t*/\n\t\t}else if(f==FONS_TERRAINMAP){\n\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\n\t\t\tif((this.getZoom() > 17)&& (layerAdd)){\n\t\t\t\tthis.setZoom(17);\n\t\t\t}\n\n\t\t\tif((sC==0)){ //Fora Cat\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=zT;\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(1);\n\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==1){ //Cat i altres\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(0.8);\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==2){ //Nomes cat\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t}\n\t\t\n\t\t}else if(f.indexOf('colorBlankMap')!=-1){\n\t\t\n\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\n\t\t\n\t\t}else if(f==FONS_HIBRIDTERRAIN){\n\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\n\t\t\tif((this.getZoom() > 17)&& (layerAdd)){\n\t\t\t\tthis.setZoom(17);\n\t\t\t}\n\n\t\t\tif((sC==0)){ //Fora Cat\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=zT;\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(1);\n\t\t\t\tthis.attributionControl.setPrefix(ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==1){ //Cat i altres\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\n\t\t\t\tESRI_RELLEU_L0_13.setOpacity(0.8);\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+ESRI_ATTR_TERRAIN +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==2){ //Nomes cat\n\t\t\t\tESRI_RELLEU_L0_13.options.maxZoom=9;\n\t\t\t\tICC_RELLEU_L0_14.options.maxZoom=17;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t}\t\n\t\t\t\n\t\t}else if(f==FONS_TOPOGISMAP){\n\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\n\n\t\t\tif((sC==0)){\n\t\t\t\tMQ_TOPO_GRIS_L15_19.setOpacity(1);\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=18;\n\t\t\t\tMQ_TOPO_GRIS_L0_14.options.maxZoom=14;\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=zT;\n\t\t\t\t//ICC_TOPO_GRIS_L7_10.options.maxZoom=zT;\n\t\t\t\tif(this.getZoom() <= 6){\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}else if(sC==1){\n\t\t\t\tMQ_TOPO_GRIS_L15_19.setOpacity(1);\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=18;\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=18;\n\t\t\t//\tICC_TOPO_GRIS_L7_10.options.maxZoom=10;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==2){\n\t\t\t\tMQ_TOPO_GRIS_L15_19.options.maxZoom=zT;\n\t\t\t\tMQ_TOPO_GRIS_L0_14.options.maxZoom=zT;\n\t\t\t\tICC_TOPO_GRIS_L11_19.options.maxZoom=18;\n\t\t\t\t//ICC_TOPO_GRIS_L7_10.options.maxZoom=10;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t}\n\t\t}else if(f==FONS_COLORMAP){\n\t\t\t//this.mirarActivarHill(true,this.getZoom(),sC);\n\t\t\tif((sC==0)){\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.setOpacity(1);\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=18;\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=zT;\n\n\t\t\t\tif(this.getZoom() <= 6){\n\t\t\t\t\tthis.attributionControl.setPrefix(MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t\t}else{\n\t\t\t\t\tthis.attributionControl.setPrefix(ICGC_MON +this.getCurrentZoomLevel());\n\t\t\t\t}\n\t\t\t}else if(sC==1){\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.setOpacity(1);\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=18;\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=18;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\n\t\t\t}else if(sC==2){\n\t\t\t\tCOLOR_TOPO_MQ_L7_19.options.maxZoom=zT;\n\t\t\t\tCOLOR_TOPO_ICC_L11_19.options.maxZoom=18;\n\t\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t\t}\n\n\t\t}else if(f==FONS_HISTORICMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif(this.getZoom() > 14){\n\t\t\t\tmap.setZoom(14);\n\t\t\t}\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTO +this.getCurrentZoomLevel());\n\t\t\tif((sC==0)){\n\t\t\t\tthis.fitBounds(CatBounds);\n\t\t\t}\n\n\n\t\t}else if(f==FONS_DIVADMIN){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif(this.getZoom() > 18){\n\t\t\t\tmap.setZoom(18);\n\t\t\t}\n\t\t\tthis.attributionControl.setPrefix(ICGC+ \",\"+MQ_ATTR +this.getCurrentZoomLevel());\n\n\n\t\t}else if(f==FONS_HISTORICORTOMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTOOrto +this.getCurrentZoomLevel());\n\t\t\tif((sC==0)){\n\t\t\t\tthis.fitBounds(CatBounds);\n\t\t\t}\n\t\t}else if(f==FONS_HISTORICORTOMAP46){\n\t\t\t////this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)){\n\t\t\t\tthis.fitBounds(CatBounds);\n\n\t\t\t}\n\t\t\tthis.attributionControl.setPrefix(ICGC_HISTOOrto46 +this.getCurrentZoomLevel());\n\n\t\t}else if(f==FONS_ALCADAMAP){\n\t\t\t//this.mirarActivarHill(false,this.getZoom(),sC);\n\t\t\tif((sC==0)){\n\t\t\t\tthis.fitBounds(CatBounds);\n\n\t\t\t}\n\t\t\tthis.attributionControl.setPrefix(ICGC +this.getCurrentZoomLevel());\n\t\t}else{\n\n\t\t}\n\t},\n\n\ttopoMap: function (print){\n\t\tthis.deletePreviousMap();\n\t\tthis.options.typeMap=FONS_TOPOMAP;\n\t\tthis.ajustaZoom(20);\n\n\t\tthis.setMapColor(null);\n\t\t_topoLayers=L.layerGroup();\n\t\tTOPO_ICC_L0_6=  new L.TileLayer(mapaUrl.topoMapMON, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 6,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: false,\n\t\t\tsubdomains:subDomainsA,\n\t\t\tworldCopyJump: false,\n\t\t}).addTo(_topoLayers);\n\t\tTOPO_MQ_L7_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\n\t\t\tminZoom: 7,\n\t\t\tmaxZoom:19,\n\t\t\tsubdomains:subDomains}\n\t\t).addTo(_topoLayers);\n\t\tif(print){\n\t\t\tTOPO_ICC_L7_10 = new L.TileLayer(mapaUrl.topoMapICGC,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 7,\n\t\t\t\tmaxZoom: 10,\n\t\t\t\tboundary: catContorn,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tsubdomains:subDomainsA,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_topoLayers);\n\n\t\t\tTOPO_ICC_L11_12 = new L.TileLayer(mapaUrl.topoMapICGC,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 11,\n\t\t\t\tmaxZoom: 12,\n\t\t\t\tboundary: catContorn,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tsubdomains:subDomainsA,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_topoLayers);\n\n\t\t}else{ //no es true\n\n\t\t\tTOPO_ICC_L7_10 = new L.TileLayer.boundaryCanvas(mapaUrl.topoMapICGC,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 7,\n\t\t\t\tmaxZoom: 10,\n\t\t\t\tboundary: catContorn,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tsubdomains:subDomainsA,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_topoLayers);\n\n\n\t\t\tTOPO_ICC_L11_12 = new L.TileLayer.boundaryCanvas(mapaUrl.topoMapICGC,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 11,\n\n\t\t\t\tmaxZoom: 12,\n\t\t\t\tboundary: catContorn,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tsubdomains:subDomainsA,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_topoLayers);\n\n\t\t}\n\n\t\tTOPO_ICC_L12_19 = new L.TileLayer(mapaUrl.topoMapICGC,{\n\t\t\ttms:false,\n\t\t\tminZoom: 13,\n\t\t\tmaxZoom: 20,\n\t\t\tcontinuousWorld: true,\n\t\t\tsubdomains:subDomainsA,\n\t\t\tworldCopyJump: false\n\t\t}).addTo(_topoLayers);\n\t\tthis.addLayer(_topoLayers,true);\n\t\tthis.setActiveMap(FONS_TOPOMAP);\n\t},\n\n\n\n\ttopoMapGeo: function (){\n\t\tthis.deletePreviousMap();\n\t\tthis.options.typeMap=FONS_TOPOMAP_GEO;\n\t\tthis.ajustaZoom(18);\n\n\t\tthis.setMapColor(null);\n\t\t_topoLayersGeo=L.layerGroup();\n\n\n\t\tTOPO_GEO_MON_L0_14=  new L.TileLayer(mapaUrl.topoMapSuauOSM, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 14,\n\t\t\tsubdomains:subDomainsA,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: false,\n\t\t\tworldCopyJump: false,\n\t\t}).addTo(_topoLayersGeo);\n\n\n\t\tTOPO_GEO_MQ_L15_18 = new L.TileLayer(mapaUrl.topoMapOSM,{\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom:18,\n\n\t\t\tsubdomains:subDomains}\n\t\t).addTo(_topoLayersGeo);\n\n\n\n\n\t\tTOPO_GEO_ICC_L8_17 = new L.TileLayer(mapaUrl.topoMapSuauICGC,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom: 18\n\n\t\t}).addTo(_topoLayersGeo);\n\t\tthis.addLayer(_topoLayersGeo,true);\n\t\tthis.setActiveMap(FONS_TOPOMAP_GEO);\n\t},\n\n\n\tajustaZoom:function (maxZoom){\n\tthis.options.maxZoom=maxZoom;\n\tthis.getZoom() > maxZoom ?  this.setZoom(maxZoom) : null;\n\n\t},\n\n\tortoMap: function (print){\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(20);\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_ORTOMAP;\n\t\t_ortoLayers=L.layerGroup();\n\n\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\n\t\t   minZoom: 0,\n\t\t   maxZoom:19}\n\t\t).addTo(_ortoLayers);\n\n\n\n\t\tORTO_ICC_L0_11 = new L.TileLayer(mapaUrl.ortoInstamaps,{  \t    \n\t\t\ttms:false,\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 12,\t                                                        \n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false\n\t\t}).addTo(_ortoLayers);\n\t\t\n\n\n\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\n\t\t\ttms:false,\n\t\t\tminZoom: 13,\n\t\t\tmaxZoom: 20,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false\n\t\t}).addTo(_ortoLayers);\n\n\t\tthis.addLayer(_ortoLayers,true);\n\t\tthis.setActiveMap(FONS_ORTOMAP);\n\t},\n\n\t\tortoAugmentada:function(print){\n\t\t\t\n\t\t\tthis.deletePreviousMap();\n\t\t\tthis.ajustaZoom(20);\n\t\t\tthis.setMapColor(null);\n\t\t\tthis.options.typeMap=FONS_ORTOAUGMENTADA;\n\t\t\t_ortoAurgmentada=L.layerGroup();\n\n\t\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\n\t\t\t   minZoom: 0,\n\t\t\t   maxZoom:19}\n\t\t\t).addTo(_ortoAurgmentada);\n\n\t\t\t\n\t\t\t\n\t\t\tif(print){\n\t\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer(mapaUrl.ortoAugmentada,{  \t    \n\t\t\t\t\ttms:false,\n\t\t\t\t\tminZoom: 4,\n\t\t\t\t\tmaxZoom: 17,\t\t\t\n\t\t\t\t\tcontinuousWorld: true,\n\t\t\t\t\tworldCopyJump: false\n\t\t\t\t}).addTo(_ortoAurgmentada);\n\n\t\t\t}else{ //no es true\n\n\n\t\t\t\t\n\t\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer.boundaryCanvas(mapaUrl.ortoAugmentada,{  \t    \n\t\t\t\t\ttms:false,\n\t\t\t\t\tminZoom: 4,\n\t\t\t\t\tmaxZoom: 17,\n\t\t\t\t\tboundary: catContorn5k,\n\t\t\t\t\tcontinuousWorld: true,\n\t\t\t\t\tworldCopyJump: false\n\t\t\t\t}).addTo(_ortoAurgmentada);\n\t\t\t\t\n\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\n\t\t\t\n\t\t\t\n\t\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 18,\n\t\t\t\tmaxZoom: 20,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_ortoAurgmentada);\n\n\t\t\tthis.addLayer(_ortoAurgmentada,true);\n\t\t\tthis.setActiveMap(FONS_ORTOAUGMENTADA);\n\t\t\t\n\t\t\t\n\t\t},\n\t\n\n\tnaturalMap: function (){\n\t\tthis.deletePreviousMap();\n\t\tthis.options.typeMap=FONS_NATURAL;\n\t\tthis.ajustaZoom(18);\n\n\t\tthis.setMapColor(null);\n\t\t_naturalMap=L.layerGroup();\n\n\t\tTOPO_GEO_MON_L0_14=  new L.TileLayer(mapaUrl.topoMapSuauOSM, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 14,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: false,\n\t\t\tworldCopyJump: false,\n\t\t}).addTo(_naturalMap);\n\n\n\t\tTOPO_GEO_MQ_L15_18 = new L.TileLayer(mapaUrl.topoNaturalOSM,{\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom:18,\n\n\t\t\tsubdomains:subDomainsA}\n\t\t).addTo(_naturalMap);\n\n\t\tTOPO_GEO_ICC_L8_17 = new L.TileLayer(mapaUrl.topoNaturalSuau,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tsubdomains:subDomainsA,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 18\n\n\t\t}).addTo(_naturalMap);\n\n\n\t\tTOPO_GEO_ICC_L8_17_TOPONIMS = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 18\n\n\t\t}).addTo(_naturalMap);\n\n\n\n\n\n\n\t\tthis.addLayer(_naturalMap,true);\n\t\t\tthis.setActiveMap(FONS_NATURAL);\n\t},\n\n\n\tajustaZoom:function (maxZoom){\n\tthis.options.maxZoom=maxZoom;\n\tthis.getZoom() > maxZoom ?  this.setZoom(maxZoom) : null;\n\n\t},\n\n/*\n\n\thibridMap: function (print){\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(18);\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_HIBRIDMAP;\n\t\t_hibridLayers=L.layerGroup();\n\n\t\tHIBRID_MQ_L0_18 = new L.TileLayer(mapaUrl.ortoEsri,{\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom:18,\n\t\t\tsubdomains:subDomains\n\t\t}).addTo(_hibridLayers);\n\n\n\n\t\t\tHIBRID_ICGC_L0_18 = new L.TileLayer(mapaUrl.hibridInstamaps,{\n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 0,\n\t\t\t\tmaxZoom: 18,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_hibridLayers);\n\n\t\tthis.addLayer(_hibridLayers,true);\n\tthis.setActiveMap(FONS_HIBRIDMAP);\n\t},\n\n*/\n\t\n\thibridMap:function(print){\n\t\t\n\t\t\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(19);\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_HIBRIDMAP;\n\t\t_hibridLayers=L.layerGroup();\n\n\n\t\tORTO_ESRI_L0_19 = new L.TileLayer(mapaUrl.ortoEsri,{\n\t\t   minZoom: 0,\n\t\t   maxZoom:19}\n\t\t).addTo(_hibridLayers);\n\n\t\t\n\t\tif(print){\n\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer(mapaUrl.ortoAugmentada,{  \t    \n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 16,\t\t\t\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_hibridLayers);\n\n\t\t}else{ //no es true\n\n\n\t\t\t\n\t\t\tORTO_AUGMENTADA_L4_17 = new L.TileLayer.boundaryCanvas(mapaUrl.ortoAugmentada,{  \t    \n\t\t\t\ttms:false,\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 16,\n\t\t\t\tboundary: catContorn5k,\n\t\t\t\tcontinuousWorld: true,\n\t\t\t\tworldCopyJump: false\n\t\t\t}).addTo(_hibridLayers);\n\t\t\t\n\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tORTO_ICC_L12_19 = new L.TileLayer(mapaUrl.ortoICGC,{\n\t\t\ttms:false,\n\t\t\tminZoom: 17,\n\t\t\tmaxZoom: 20,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false\n\t\t}).addTo(_hibridLayers);\n\t\t\n\t\t\n\t\t\n\t\tORTO_HIBRID_8_18_VECTOR = new L.TileLayer(mapaUrl.hibridTotal,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tsubdomains:subDomainsA,\n\t\t\topacity:0.5,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 17\n\t\t}).addTo(_hibridLayers);\n\t\t\n\t\t\n\t\t\n\n\t\tORTO_HIBRID_L8_17_TOPONIMS = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tminZoom: 8,\n\t\t\topacity:0.8,\n\t\t\tmaxZoom: 18\n\n\t\t}).addTo(_hibridLayers);\n\n\t\t\n\n\t\tthis.addLayer(_hibridLayers,true);\n\t\tthis.setActiveMap(FONS_HIBRIDMAP);\n\t\t\n\t\t\n\t},\n\t\n\thibridTerrainMap: function (){\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(17);\n\n\t\tthis.setMapColor(null);\n\t\t_hibridTerrainMap=L.layerGroup();\n\n\t\tESRI_RELLEU_L0_13 =new L.TileLayer(mapaUrl.terrainEsri,{\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom:9}\n\t\t).addTo(_hibridTerrainMap);\n\n\t\tICC_RELLEU_L0_14= new L.TileLayer(mapaUrl.terrainInstamaps, {\n\t\t   minZoom: 0,\n\t\t   maxZoom: 17,\n\t\t   tms:false,\n\t\t   continuousWorld: true,\n\t\t   worldCopyJump: false,\n\t\t}).addTo(_hibridTerrainMap);\n\n\t\t\n\t\t\n\t\tTERRAIN_HIBRID_8_18_VECTOR = new L.TileLayer(mapaUrl.hibridTotal,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tsubdomains:subDomainsA,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 17\n\n\t\t}).addTo(_hibridTerrainMap);\n\t\t\n\t\t\t\n\t\t\n\t\t/*\n\t\tTERRAIN_HIBRID_8_18_TOPO1 = new L.TileLayer(mapaUrl.topoNaturalSuau,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tsubdomains:subDomainsA,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 17\n\n\t\t}).addTo(_hibridTerrainMap);\n*/\n\n\t\tTERRAIN_HIBRID_8_18_TOPO2 = new L.TileLayer(mapaUrl.toponimsNaturalSuau,{\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tminZoom: 8,\n\t\t\tmaxZoom: 17\n\n\t\t}).addTo(_hibridTerrainMap);\n\t\t\n\t\t\n\t\tthis.addLayer(_hibridTerrainMap,true);\n\t\t\tthis.setActiveMap(FONS_HIBRIDTERRAIN);\n\t},\n\t\n\t\n\n\tterrainMap: function (){\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(17);\n\n\t\tthis.setMapColor(null);\n\t\t_terrainLayers=L.layerGroup();\n\n\t\tESRI_RELLEU_L0_13 =new L.TileLayer(mapaUrl.terrainEsri,{\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom:9}\n\t\t).addTo(_terrainLayers);\n\n\t\tICC_RELLEU_L0_14= new L.TileLayer(mapaUrl.terrainInstamaps, {\n\t\t   minZoom: 0,\n\t\t   maxZoom: 17,\n\t\t   tms:false,\n\t\t   continuousWorld: true,\n\t\t   worldCopyJump: false,\n\t\t}).addTo(_terrainLayers);\n\n\t\tthis.addLayer(_terrainLayers,true);\n\t\t\tthis.setActiveMap(FONS_TERRAINMAP);\n\t},\n\n\ttopoGrisMap: function (print){\n\t\tthis.deletePreviousMap();\n\t\tthis.ajustaZoom(18);\n\n\t\tthis.setMapColor(null);\n\t\t_grisLayers=L.layerGroup();\n\t\n\n\t\tMQ_TOPO_GRIS_L0_14 =new L.TileLayer(mapaUrl.topoGrisOSM,{\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom:14,\n\t\t\tcolor:'gris',\n\t\t\tsubdomains:subDomains\n\t\t}).addTo(_grisLayers);\n\n\t\tMQ_TOPO_GRIS_L15_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom:18,\n\t\t\tcolor:'gris',\n\t\t\tsubdomains:subDomains\n\t\t}).addTo(_grisLayers);\n\t\t\n\t\tICC_TOPO_GRIS_L11_19 = new L.TileLayer(mapaUrl.topoGrisICGC,{\n\t\t\ttms:false,\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom: 18,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false\n\t\t}).addTo(_grisLayers);\n\n\t\t//_grisLayers.addTo(this);\n\n\t\tthis.addLayer(_grisLayers,true);\n\t\t\tthis.setActiveMap(FONS_TOPOGISMAP);\n\t},\n\n\tcolorMap: function (color){\n\t\t//this.options.maxZoom=19;\n\t\tthis.ajustaZoom(18);\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(color);\n\t\t_topoColorLayers=L.layerGroup();\n\n\t\t\n\t\tCOLOR_TOPO_ICC_L0_6= new L.TileLayer(mapaUrl.topoSuauColor[color].osm, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 14,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tcolor:color\n\t\t}).addTo(_topoColorLayers);\n\n\t\tCOLOR_TOPO_MQ_L7_19 =new L.TileLayer(mapaUrl.topoMapOSM,{\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom:18,\n\t\t\tcolor:color,\n\t\t\tsubdomains:subDomains\n\t\t}).addTo(_topoColorLayers);\n\n\t\tCOLOR_TOPO_ICC_L11_19= new L.TileLayer(mapaUrl.topoSuauColor[color].suau, {\n\t\t\tminZoom: 15,\n\t\t\tmaxZoom: 18,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t\tcolor:color\n\t\t}).addTo(_topoColorLayers);\n\n\t\tthis.addLayer(_topoColorLayers,true);\n\t\t\tthis.setActiveMap(FONS_COLORMAP);\n\t},\n\n\thistoricMap:function(){\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_HISTORICMAP;\n\t\tthis.ajustaZoom(14);\n\t\t_histoMap=L.layerGroup();\n\n\t\tHISTO_ICC_L0_14= new L.TileLayer(mapaUrl.topo36ICGC, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 14,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false,\n\t\t}).addTo(_histoMap);\n\n\t\tthis.addLayer(_histoMap,true);\n\tthis.setActiveMap(FONS_HISTORICMAP);\n\t},\n\n\tcolorBlankMap:function(color){\n\t\t\n\t\tthis.deletePreviousMap();\n\t\tFONS_COLORBLANK=color;\n\t\tcolor=color.replace('colorBlankMap','');\n\t\tthis.setMapColor(null);\n\t\t\n\t\tthis.options.typeMap=FONS_COLORBLANK;\n\t\t//this.ajustaZoom(14);\n\t\t_colorBlankMap=L.layerGroup();\n\n\t\t new L.TileLayer(mapaUrl.fonsBlank, {\n\t\t\tminZoom: 2,\n\t\t\tmaxZoom: 19,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false,\n\t\t}).addTo(_colorBlankMap);\n\n\t\tthis.addLayer(_colorBlankMap,true);\n\tthis.setActiveMap(FONS_COLORBLANK);\n\tjQuery('#map').css('backgroundColor',color);\t\n\t\t\n\t\t\n\t},\n\t\n\tdivadminMap:function(){\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_DIVADMIN;\n\t\tthis.ajustaZoom(18);\n\t\t_divadminMap=L.layerGroup();\n\n\n\t\tDIVADMIN_L0_14= new L.TileLayer(mapaUrl.topoLimitsSuau, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 13,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false,\n\t\t}).addTo(_divadminMap);\n\n\n\n\n\n\t\tDIVADMIN_L14_18= new L.TileLayer(mapaUrl.topoGrisICGC, {\n\t\t\tminZoom: 14,\n\t\t\tmaxZoom: 18,\n\t\t\ttms:false,\n\t\t\tcolor:'gris',\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t}).addTo(_divadminMap);\n\n\n\t\tDIVADMIN_L14_18_TOPO= new L.TileLayer(mapaUrl.toponimsNaturalSuau, {\n\t\t\tminZoom: 14,\n\t\t\tmaxZoom: 18,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump: false,\n\t\t}).addTo(_divadminMap);\n\n\n\t\tthis.addLayer(_divadminMap,true);\nthis.setActiveMap(FONS_DIVADMIN);\n\t},\n\n\thistoricOrtoMap:function(){\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_HISTORICORTOMAP;\n\n\t\tthis.ajustaZoom(17);\n\t\t_histoOrtoMap=L.layerGroup();\n\n\t\tHISTOOrto_ICC_L0_14= new L.TileLayer(mapaUrl.orto55ICGC, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 17,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false\n\n\t\t}).addTo(_histoOrtoMap);\n\t\t/*\n\t\tHISTOOrto_ICC_L0_14= new L.tileLayer.wms(mapaUrl.orto55ICGC, {\n\t\t\tlayers: 'ovab5m',\n\t\t\tformat: 'image/png',\n\t\t\ttransparent: true,\n\t\t\texceptions:'application/vnd.ogc.se_xml'\n\t\t}).addTo(_histoOrtoMap);\n\t\t*/\n\t\tthis.addLayer(_histoOrtoMap,true);\n\tthis.setActiveMap(FONS_HISTORICORTOMAP);\n\t},\n\n\thistoricOrtoMap46:function(){\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_HISTORICORTOMAP46;\n\n\t\tthis.ajustaZoom(17);\n\n\t\t_histoOrtoMap46=L.layerGroup();\n\n\t\tHISTOOrto46_ICC_L0_14= new L.TileLayer(mapaUrl.orto46ICGC, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 17,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false\n\t\t\t//attribution:'Font:Ministerio de Defensa'\n\t\t}).addTo(_histoOrtoMap46);\n\n\n\n\t\tthis.addLayer(_histoOrtoMap46,true);\n\tthis.setActiveMap(FONS_HISTORICORTOMAP46);\n\t},\n\n\talcadaMap:function(){\n\t\tthis.deletePreviousMap();\n\n\t\tthis.setMapColor(null);\n\t\tthis.options.typeMap=FONS_ALCADAMAP;\n\n\t\tthis.ajustaZoom(16);\n\t\t_alcadesMap=L.layerGroup();\n\n\t\tALCADAMAPA_ICGC_L0_17= new L.TileLayer(mapaUrl.ombraInstamaps, {\n\t\t\tminZoom: 0,\n\t\t\tmaxZoom: 16,\n\t\t\ttms:false,\n\t\t\tcontinuousWorld: true,\n\t\t\tworldCopyJump:false\n\t\t\t//attribution:'Font:Ministerio de Defensa'\n\t\t}).addTo(_alcadesMap);\n\n\n\n\t\tthis.addLayer(_alcadesMap,true);\n\tthis.setActiveMap(FONS_ALCADAMAP);\n\t},\n\n\n\n\trmCapa: function (grup,layer){\n\n\t\tif(grup.hasLayer(layer)){grup.removeLayer(layer);return}\n\n\t},\n\n\taddCapa: function (grup,layer){\n\n\t\tif(!grup.hasLayer(layer)){grup.addLayer(layer,true);return}\n\n\t},\n\n\tdeletePreviousMap: function () {\n\n\t\tif(this.hasLayer(_topoLayers)){this.removeLayer(_topoLayers);return}\n\t\telse if(this.hasLayer(_topoLayersGeo)){this.removeLayer(_topoLayersGeo);return}\n\t\telse if(this.hasLayer(_ortoLayers)){this.removeLayer(_ortoLayers);return}\n\t\telse if(this.hasLayer(_hibridLayers)){this.removeLayer(_hibridLayers);return}\n\t\telse if(this.hasLayer(_terrainLayers)){this.removeLayer(_terrainLayers);return}\n\t\telse if(this.hasLayer(_topoColorLayers)){this.removeLayer(_topoColorLayers);return}\n\t\telse if(this.hasLayer(_grisLayers)){this.removeLayer(_grisLayers);return}\n\t\telse if(this.hasLayer(_histoMap)){this.removeLayer(_histoMap);return}\n\t\telse if(this.hasLayer(_histoOrtoMap)){this.removeLayer(_histoOrtoMap);return}\n\t\telse if(this.hasLayer(_histoOrtoMap46)){this.removeLayer(_histoOrtoMap46);return}\n\t\telse if(this.hasLayer( _naturalMap)){this.removeLayer( _naturalMap);return}\n\t\telse if(this.hasLayer(_divadminMap)){this.removeLayer(_divadminMap);return}\n\t\telse if(this.hasLayer(_alcadesMap)){this.removeLayer(_alcadesMap);return}\n\t\telse if(this.hasLayer(_colorBlankMap)){this.removeLayer(_colorBlankMap);return}\n\t\telse if(this.hasLayer(_hibridTerrainMap)){this.removeLayer(_hibridTerrainMap);return}\n\t\t\n\t}\n\t//fi default metode\n});\n","/*\n * L.IM_ColorLayer is a regular tilelayer with grayscale makeover.\n */\n\nL.IM_ColorLayer = L.TileLayer.extend({\n\toptions: {\n\t\tenableCanvas: true,\n\t\tcolor:'gris'\n\t},\n\n\tinitialize: function (url, options) {\n\t\tvar canvasEl = document.createElement('canvas');\n\t\tif( !(canvasEl.getContext && canvasEl.getContext('2d')) ) {\n\t\t\toptions.enableCanvas = false;\n\t\t}\n\n\t\tL.TileLayer.prototype.initialize.call(this, url, options);\n\t},\n\n\t_loadTile: function (tile, tilePoint) {\n\t\ttile.setAttribute('crossorigin', 'anonymous');\n\t\tL.TileLayer.prototype._loadTile.call(this, tile, tilePoint);\n\t},\n\n\t_tileOnLoad: function () {\n\t\tif (this._layer.options.enableCanvas && !this.canvasContext) {\n\t\t\tvar canvas = document.createElement(\"canvas\");\n\t\t\tcanvas.width = canvas.height = this._layer.options.tileSize;\n\t\t\tthis.canvasContext = canvas.getContext(\"2d\");\n\t\t}\n\t\tvar ctx = this.canvasContext;\n\n\t\tif (ctx) {\n\t\t\tthis.onload  = null; // to prevent an infinite loop\n\t\t\tctx.drawImage(this, 0, 0);\n\t\t\tvar imgd = ctx.getImageData(0, 0, this._layer.options.tileSize, this._layer.options.tileSize);\n\t\t\tvar d = imgd.data;\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris'){\n\t\t\t\t\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t\t  d[i] = d[i + 1] = d[i + 2] = (r+g+b)/3;\n\t\t\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='grisClar'){\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\tvar brightness = 0.44 * d[i] + 0.5 * d[i + 1] + 0.16 * d[i + 2];\n\t\t\t          // r\n\t\t\t          d[i] = brightness;\n\t\t\t          // green\n\t\t\t          d[i + 1] = brightness;\n\t\t\t          // blue\n\t\t\t          d[i + 2] = brightness;\n\t\t\t        }\n\t\t}\n\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='sepia'){\n\t\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t  d[i]     = (r * 0.393)+(g * 0.769)+(b * 0.189); // red\n\t\t\t\t\t  d[i + 1] = (r * 0.349)+(g * 0.686)+(b * 0.168); // green\n\t\t\t\t\t  d[i + 2] = (r * 0.272)+(g * 0.534)+(b * 0.131); // blue\n\t\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='orquidea'){\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t        r = d[i];\n\t\t\t        g = d[i + 1];\n\t\t\t        b = d[i + 2];\n\n\t\t\t        d[i] = (r * 0.393 + g * 0.769 + b * 0.189 ) / 1.351;\n\t\t\t        d[i + 1] = (r * 0.349 + g * 0.686 + b * 0.168 ) / 1.203;\n\t\t\t        d[i + 2] = (r * 0.272 + g * 0.534 + b * 0.131 ) / 2.140;\n\t\t\t      }\n\t\t\t\t*/\n\t\t\t\t\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t\t        avg = 0.25  * d[i] + 0.59 * d[i + 1] + 0.11 * d[i + 2];\n\t\t\t\t        d[i] = avg + 250;\n\t\t\t\t        d[i + 1] = avg + 20;\n\t\t\t\t        d[i + 2] = avg + 200;\n\t\t\t\t      }\n\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\t\n\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t\t  var r = d[i];\n\t\t\t\t\t  var g = d[i + 1];\n\t\t\t\t\t  var b = d[i + 2];\n\t\t\t\t\t  \n\t\t\t\t\t  d[i]     = (r * 0.95)+(g * 2.169)+(b * 2.989); // red\n\t\t\t\t\t  d[i + 1] = (r * 0.26)+(g * 0.5)+(b * 0.168); // green\n\t\t\t\t\t  d[i + 2] = (r * 0.96)+(g * 2.734)+(b * 2); // blue\n\t\t\t\t\t  \n\t\t\t\t\t  \n\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\t*/\n\t\t\t\n}\n\t\t\t\n\t\t\t\t\t\t\n\t\t\tif(this._layer.options.color=='zombie'){\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tfor (var i = 0; i < d.length; i += 4) {\n\t\t\t        avg = 0.2  * d[i] + 0.49 * d[i + 1] + 0.21 * d[i + 2];\n\t\t\t        d[i] = avg + 255;\n\t\t\t        d[i + 1] = avg + 1;\n\t\t\t        d[i + 2] = avg + 20;\n\t\t\t      }\n\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  d[i] = (r+g+b)/2.5;      \t\t\t\t  \n\t\t\t\t  d[i + 1] = d[i + 2] = 50; // zero out green and blue channel\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t*/\n\t\t\t\t\n\t\t\t}\n\t\t\tif(this._layer.options.color=='nit'){\n\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t // red\n\t\t\t\td[i] = 255 - d[i];\n          // green\n\t\t\t\td[i + 1] = 255 - d[i + 1];\n          // blue\n\t\t\t\td[i + 2] = 255 - d[i + 2];\n\t\t\t}\n\t\t\t}\n\t\t\tif(this._layer.options.color=='brillant'){\n\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t  var brightness = 0.54 * d[i] + 0.7 * d[i + 1] + 0.16 * d[i + 2];\n          // red\n\t\t\t\td[i] = brightness;\n          // green\n\t\t\t\td[i + 1] = d[i + 1];\n          // blue\n\t\t\t\td[i + 2] =d[i + 2];\n\t\t\t}\n\t\t\t}\n\t\t\tif(this._layer.options.color=='negre_blau'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=0 && r <=100) && (g >=0 && g <=100) && (b >=0 && b <=100)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 0\n\t\t\t\t  d[i + 1] = 0;\n\t\t\t\t  d[i + 2] = 255;\n\t\t\t\t  \n\t\t\t\t  }else{\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t\t // d[i] = r;    // apply average to red channel\n\t\t\t\t  //d[i + 1] = g;\n\t\t\t\t  //d[i + 2] = b;\n\n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  // zero out green and blue channel\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris_verd'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=120 && r <=190) && (g >=120 && g <=190) && (b >=120 && b <=190)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 9\n\t\t\t\t  d[i + 1] = 190;\n\t\t\t\t  d[i + 2] = 0;\n\t\t\t\t  \n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\tif(this._layer.options.color=='gris_vermell_tot'){\n\t\t\t\n\t\t\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t\t\t  var r = d[i];\n\t\t\t\t \n\t\t\t\t  var g = d[i + 1];\n\t\t\t\t  var b = d[i + 2];\n\t\t\t\t  \n\t\t\t\t  if((r>=120 && r <=190) && (g >=120 && g <=190) && (b >=120 && b <=190)){ //NEGRE\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t   d[i] = 255\n\t\t\t\t  d[i + 1] = 204;\n\t\t\t\t  d[i + 2] = 0;\n\t\t\t\t  \n\t\t\t\t  }else{\n\t\t\t\t    d[i] = 230\n\t\t\t\t  d[i + 1] = 230;\n\t\t\t\t  d[i + 2] = 230;\n\t\t\t\t  }\n\t\t\t\t  \n\t\t\t\t  \n\t\t\t}\n\t\t\t}\n\t\t\t//rgb(220, 185, 185)\n\t\t\t//rgb(255, 197, 0)\n\t\t\tif(this._layer.options.color=='mb'){\n\t\t\t\t\n\t\t\t\t for (var i = 0; i < d.length; i += 4) {\n\t\t  var r = d[i];\t\t \n\t\t  var g = d[i + 1];\n\t\t  var b = d[i + 2];\n\t\t  \n\t\t // rgb(244, 245, 228)\n\t\t // rgb(245, 246, 227)\n\t\t  \n\t\t  if((r>=243 && r <=246) && (g >=243 && g <=247) && (b >=226 && b <=229)){\n\t\t\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t\t\t // console.info(r);\n\t\t\t\t  d[i] = 245;\n\t\t\t\t  d[i + 1] = 175;\n\t\t\t\t  d[i + 2] = 5;\n\t\t\t\t  d[i + 3] = 0;\n\t\t\t\t  }\n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  \n\t\t  if((r>=250 && r <=255) && (g >=250 && g <=255) && (b >=250 && b <=255)){\n\t\t// if((r>=0 && r <=220) && (g >=160 && g <=240) && (b >=200 && b <=255)){ //NEGRE\n\t\t // console.info(r);\n\t\t\t  //rgb(204, 231, 252)\n\t\t  d[i] = 204;\n\t\t  d[i + 1] = 231;\n\t\t  d[i + 2] = 252;\n\t\t  d[i + 3] = 0;\n\t\t  }\n\t\t  \n\t\t \n\t\t  \n\t\t  \n\t}\n\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t/*Gris\n\t\t\t if(imageData.data[i]==oldRed &&\n         imageData.data[i+1]==oldGreen &&\n         imageData.data[i+2]==oldBlue\n      ){\n          // change to your new rgb\n          imageData.data[i]=newRed;\n          imageData.data[i+1]=newGreen;\n          imageData.data[i+2]=newBlue;\n      }\n\t\t\t \n\t\t\t\n\t\t\t*/\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t/*\n\t\t\tfor (var i = 0, n = pix.length; i < n; i += 4) {\n\t\t\t\tpix[i] = pix[i + 1] = pix[i + 2] = (3 * pix[i] + 4 * pix[i + 1] + pix[i + 2]) / 8;\n\t\t\t}\n\t\t\t*/\n\t\t\tctx.putImageData(imgd, 0, 0);\n\t\t\tthis.removeAttribute(\"crossorigin\");\n\t\t\tthis.src = ctx.canvas.toDataURL();\n\t\t}\n\n\t\tL.TileLayer.prototype._tileOnLoad.call(this);\n\t}\n});\n\n/*\nL.IM_ColorLayer = function (url, options) {\n\treturn new L.IM_ColorLayer(url, options);\n};\n*/\n","/*\nExemple \nL.control.coordinates({\n\t\t\tposition : 'bottomright', \n\t\t\t'emptystring':' ',\n\t\t\t'numDigits': 2,\n\t\t\t'prefix': 'ETRS89 UTM 31N',\n\t\t\t'separator': ' '\n\t\t}).addTo(map);\n*/\n\nL.Control.Coordinates = L.Control.extend({\n  options: {\n    position: 'bottomleft',\n    separator: ' : ',\n    emptyString: '',\n    lngFirst: true, //modifiquem el paràmetre per mostrar les coordenades igual que el Vissir (issue #554)\n    numDigits: 2,\n    numDigits2: 6,\n\tcrs:new L.Proj.CRS('EPSG:25831',  '+proj=utm +zone=31 +ellps=GRS80 +datum=WGS84 +units=m +no_defs'),\n    lngFormatter: undefined,\n    latFormatter: undefined,\n    prefix: \"\",\n    prefix2: \"\",\n    showETRS89: true\n  },\n\n  onAdd: function (map) {\n\tvar self = this,\n\tcontainer = L.DomUtil.create('div', 'leaflet-control-mouseposition');\n\t\n\tcontainer.innerHTML=self.options.emptyString;\n\t\n\tself._container = container;\n\tself._div = self._container;\n\t\n\tmap.on('mousemove', self._onMouseMove, self);\n\t   \n\tL.DomEvent.disableClickPropagation(self._container);\n   \n    return self._container;\n  },\n\n  hideBtn: function(){\n\tvar self = this;\n\t$(self._div).hide();\n  },\n\n  showBtn: function(){\n\tvar self = this;\n\t$(self._div).show();\n  },\n  \n  onRemove: function (map) {\n    map.off('mousemove', this._onMouseMove);\n  },\n\n  _onMouseMove: function (e) {\n\tvar map = this._map;  \n\t\n\tvar sC=map.miraBBContains(map.getBounds());\n  \n    \n\tvar _CRS=this.options.crs.project( {lat:e.latlng.lat,lng:e.latlng.lng});\n  \n    //var lng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits);\n    //var lat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits);\n    \n\tvar lng = this.options.lngFormatter ? this.options.lngFormatter(_CRS.x) : L.Util.formatNum(_CRS.x, this.options.numDigits);\n    var lat =this.options.latFormatter ? this.options.latFormatter(_CRS.y) : L.Util.formatNum(_CRS.y, this.options.numDigits);\n\t\n\tvar value = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;\n\t\n\tlng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits2);\n\tlat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits2);\n\t\n\tvar value2 = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;\n\t\n    var prefixAndValue = this.options.prefix + ' ' + value;\n    var prefixAndValue2 = this.options.prefix2 + ' ' +value2;\n    if((sC===0)){\n    \tthis._container.innerHTML = prefixAndValue2;\n    }\n    else if((sC==1 || sC==2)){  \n\t    if (this.options.showETRS89) this._container.innerHTML = prefixAndValue + '<br/>'+ prefixAndValue2;\n\t    else this._container.innerHTML = prefixAndValue2;\n    }\n  }\n\n});\n\nL.Map.mergeOptions({\n    positionControl: false\n});\n\nL.Map.addInitHook(function () {\n    if (this.options.positionControl) {\n        this.positionControl = new L.Control.Coordinates();\n        this.addControl(this.positionControl);\n    }\n});\n\nL.control.coordinates = function (options) {\n    return new L.Control.Coordinates(options);\n};\n","/**\n * L.Control.OpenInstamaps permite abrir un visor embed en un iframe en un visor de Instamaps en una nueva ventana.\n */\n\nL.Control.OpenInstamaps = L.Control.extend({\n\toptions: {\n\t\tposition: 'topleft',\n\t\turl: 'http://instamaps.cat/geocatweb/visor.html?',\n\t\tid: 'div-linkViewMap',\n\t\tclassName: 'control-linkViewMap',\n\t\ttitle: 'Veure a InstaMaps',\n\t\tlangTitle: 'Veure a InstaMaps',\n\t\thtml: '&nbsp;<span class=\"glyphicon glyphicon-fullscreen grisfort bt-expand\"></span>',\n\t\ttooltip: 'right'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\t\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tif (options.businessid){\n\t\t\toptions.url += '&businessid='+options.businessid;\n\t\t}\n\t\tif(options.urlwms){\n\t\t\toptions.url += '&urlwms='+options.urlwms+'&layername='+options.layername;\n\t\t}\n\t\t\n\t\tself._button = self._createButton(options.html, options.title, '', options.url, container, options.fn);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\t_createButton: function (html, title, className, url, container, fn) {\n\t\tvar link = L.DomUtil.create('a', className, container),\n\t\t\tstop = L.DomEvent.stopPropagation;\n\t\tlink.innerHTML = html;\n\t\tlink.setAttribute(\"target\", \"_blank\");\n\t\tlink.href = url;\n\t\tlink.title = title;\n\n\t\tL.DomEvent\n\t\t\t.on(link, 'click', stop)\n\t\t\t.on(link, 'mousedown', stop)\n\t\t\t.on(link, 'dblclick', stop)\n\t\t\t.on(link, 'click', fn, this);\n\t\t\n\t\treturn link;\n\t}\n});\n\nL.control.openInstamaps = function(options){\n\treturn new L.Control.OpenInstamaps(options);\n};","/**\n * L.Control.Home control que permite volver a la vista inicial del mapa\n */\nL.Control.Home = L.Control.extend({\n\toptions: {\n\t\tposition: 'topleft',\n\t\tid: 'dv_bt_vistaInicial',\n\t\tclassName: 'leaflet-bar  btn btn-default btn-sm',\n\t\ttitle: 'Vista inicial',\n\t\tlangTitle: 'Vista inicial',\n\t\thtml: '<span id=\"span_bt_vistaInicial\" class=\"fa fa-home grisfort\"></span>',\n\t\ttooltip: 'right'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\t\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._goHome, self);\n\t\treturn container;\n\t},\n\t\n\tonRemove: function (map) {\n\t\tmap.off('loadconfig', this._updateMapConfig, this);\n\t\tmap.off('visorconfig', this._updateMapConfig, this);\n\t},\n\t\n\t_goHome: function(e){\n\t\tvar _mapConfig = this.options.mapConfig,\n\t\t\t_map = this._map;\n\t\t\n\t\t\n\t\tif(_mapConfig){\n\t\t\tif (_mapConfig.options.bbox){\n\t\t\t\tvar bbox = _mapConfig.options.bbox.split(\",\");\n\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]);\n\t\t\t    var northEast = L.latLng(bbox[3], bbox[2]);\n\t\t\t    var bounds = L.latLngBounds(southWest, northEast);\n\t\t\t    _map.fitBounds( bounds );\n\t\t\t}\n\t\t\telse if (_mapConfig.options.center){\n\t\t\t\tvar opcenter = _mapConfig.options.center.split(\",\");\n\t\t\t\t_map.setView(L.latLng(opcenter[0], opcenter[1]), _mapConfig.options.zoom);\n\t\t\t}\n\t\t}\n\t\t\n\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#home','label home']});\n\t\t\n\t\t\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\t_updateMapConfig: function(config){\n\t\tthis.options.mapConfig = config;\n\t}\n});\n\nL.control.home = function(options){\n\treturn new L.Control.Home(options);\n};","/**\n *\n */\nL.Control.Share = L.Control.extend({\n\toptions: {\n\t\tposition: 'topleft',\n\t\tid: 'dv_bt_Share',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\n\t\ttitle: 'Compartir',\n\t\tlangTitle: 'Compartir',\n\t\thtml: '<span id=\"span_bt_Share\" class=\"fa fa-share-alt\"></span>',\n\t\ttooltip: 'right'\n\t},\n\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\toptions = self.options,\n\t\tstop = L.DomEvent.stopPropagation,\n\t\tcontainer = L.DomUtil.create('div', options.className);\n\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\n\t\tself._div = container;\n\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\n\t\t\t.on(container, 'click', self._toggle, self);\n\n\t\treturn container;\n\t},\n\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\n\thide: function() {\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\n\t\t$('#socialShare_visor').hide();\n\t},\n\n\tshow: function(e){\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\n\t\tvar offset = $(this._div).offset();\n\t\t$('#socialShare_visor').css('top', (offset.top - 15) +'px');\n\t\t$('#socialShare_visor').css('left', (offset.left + 35) +'px');\n\t\t$('#socialShare_visor').show();\n\t\t$.publish('analyticsEvent',{event:['visor','button#share','label share', 9]});\n\n\t\t$('#socialShare_visor .pop-social').on('click', function(event){\n\t\t\t$.publish('analyticsEvent',{event:['visor', 'compartir-publicar', $(this).attr('data-type'), 1]});\n\t\t});\n\n\n\n\t},\n\n\t_toggle: function(e){\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\n\t\tthis[collapsed ? 'show' : 'hide']();\n\t},\n\n});\n\nL.control.share = function(options){\n\treturn new L.Control.Share(options);\n};\n","/**\n * L.Control.RoutingControl control de routing basado en el leaflet-routing-machine\n */\n\nL.Control.RoutingControl = L.Control.extend({\n\tincludes: L.Mixin.Events,\n\t\n\toptions: {\n\t\tposition: 'topleft',\n\t\tlang: 'ca',\n\t\tid: 'dv_bt_Routing',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\n\t\ttitle: 'Routing',\n\t\tlangTitle: 'Routing',\n\t\thtml: '<span id=\"span_bt_Routing\" class=\"t\" style=\"font-size:16px; margin-top:-2px;\">'+\n\t\t'<i class=\"t-square-rounded\" style=\"-webkit-transform:scale(1.25) scale(0.65) rotate(45deg);-moz-transform:scale(1.25) scale(0.65) rotate(45deg);transform:scale(1.25) scale(0.65) rotate(45deg)\"></i>'+\n\t\t'<i class=\"t-turn-90-l t-c-white\" style=\"-webkit-transform:scale(-1.3, 1.3);-moz-transform:scale(-1.3, 1.3);transform:scale(-1.3, 1.3)\"></i>'+\n\t\t'</span>',\n\t\ttooltip: 'right',\n\t\tmarker_style_origen: {\n\t\t\ticon : '',\n\t\t\tmarkerColor : 'green',\n\t\t\tdivColor:'transparent',\n\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\ticonSize : new L.Point(28, 42),\n\t\t\ticonColor : '#000000',\n\t\t\tprefix : 'fa',\n\t\t\tisCanvas:false,\n\t\t\tradius:6,\n\t\t\topacity:1,\n\t\t\tweight : 2,\n\t\t\tfillOpacity : 0.9,\n\t\t\tcolor : \"#ffffff\",\n\t\t\tfillColor :\"transparent\"\n\t\t},\n\t\tmarker_style_desti: {\n\t\t\ticon : '',\n\t\t\tmarkerColor : 'red',\n\t\t\tdivColor:'transparent',\n\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\ticonSize : new L.Point(28, 42),\n\t\t\ticonColor : '#000000',\n\t\t\tprefix : 'fa',\n\t\t\tisCanvas:false,\n\t\t\tradius:6,\n\t\t\topacity:1,\n\t\t\tweight : 2,\n\t\t\tfillOpacity : 0.9,\n\t\t\tcolor : \"#ffffff\",\n\t\t\tfillColor :\"transparent\"\n\t\t},\n\t\tmarker_style_intermig: {\n\t\t\ticon : '',\n\t\t\tmarkerColor : 'orange',\n\t\t\tdivColor:'transparent',\n\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\ticonSize : new L.Point(28, 42),\n\t\t\ticonColor : '#000000',\n\t\t\tprefix : 'fa',\n\t\t\tisCanvas:false,\n\t\t\tradius:6,\n\t\t\topacity:1,\n\t\t\tweight : 2,\n\t\t\tfillOpacity : 0.9,\n\t\t\tcolor : \"#ffffff\",\n\t\t\tfillColor :\"transparent\"\n\t\t},\n\t\toriginTexts: {\n\t\t\ttitle: \"Càlcul de rutes\",\n\t\t\tbtnStart: \"Defineix com a origen\",\n\t\t\tbtnEnd: \"Defineix com a destí\",\n\t\t\tbtnReverse: \"Ruta inversa\",\n\t\t\tbtnAdd: \"Afegir punts\",\n\t\t\tstart: \"Inici\",\n\t\t\tend: \"Destí\"\n\t\t},\n\t\ttexts: {\n\t\t\ttitle: \"Càlcul de rutes\",\n\t\t\tbtnStart: \"Defineix com a origen\",\n\t\t\tbtnEnd: \"Defineix com a destí\",\n\t\t\tbtnReverse: \"Ruta inversa\",\n\t\t\tbtnAdd: \"Afegir punts\",\n\t\t\tstart: \"Inici\",\n\t\t\tend: \"Destí\"\n\t\t}\n\t},\n\t\n\t//TODO ver el tema del lang para poder cambiar el idioma del control\n\t\n\tinitialize: function(options) {\n\t\tL.setOptions(this, options);\n\t\t\n\t\tvar self = this,\n\t\t\toptions = this.options,\n\t\t\tlang = options.lang,\n\t\t\tpuntIntermig = L.AwesomeMarkers.icon(options.marker_style_intermig),\n\t\t\tpuntDesti = L.AwesomeMarkers.icon(options.marker_style_desti),\n\t\t\tpuntOrigen = L.AwesomeMarkers.icon(options.marker_style_origen);\n\t\t\n\t\tthis._reversablePlan = L.Routing.Plan.extend({\n\t\t    createGeocoders: function() {\n\t\t        var container = L.Routing.Plan.prototype.createGeocoders.call(this),\n\t\t        title = (window.lang) ? window.lang.translate(options.originTexts.btnReverse) : options.texts.btnReverse,\n\t\t        reverseButton = self._createButton('<span class=\"glyphicon glyphicon-sort\" style=\"font-size:14px;\"></span>', container, title, lang);\n\t\t        L.DomEvent.on(reverseButton, 'click', function() {\n\t\t            var waypoints = this.getWaypoints();\n\t\t            this.setWaypoints(waypoints.reverse());\n\t\t        }, this);\n\t\t        return container;\n\t\t    }\n\t\t});\n\t\t\n\t\tvar createMarker = function(i, wp) {\n        \tvar numWp = this._route.getWaypoints().length;\n        \tif(i == 0){\n        \t\treturn L.marker(wp.latLng, {\n    \t\t\t\tdraggable: true,\n    \t\t\t\ticon: puntOrigen\n    \t\t\t});\n        \t}\n        \telse if (i === (numWp - 1)){\n        \t\treturn L.marker(wp.latLng, {\n    \t\t\t\tdraggable: true,\n    \t\t\t\ticon: puntDesti\n    \t\t\t});\n        \t}\n        \telse {\n        \t\treturn L.marker(wp.latLng, {\n    \t\t\t\tdraggable: true,\n    \t\t\t\ticon: puntIntermig\n    \t\t\t});\n        \t}\n        };\n\t\t\n\t\tthis._plan = new this._reversablePlan([], {\n\t        geocoder: L.Control.Geocoder.icgc(),\n\t        routeWhileDragging: true,\n\t        language: lang,\n\t        createMarker: createMarker.bind(self)\n\t    });\n\t\t\n\t\tvar language=\"ca-ES\";\n\t\tif (lang==\"ca\") language=\"ca-ES\";\n\t\telse if (lang=\"es\") language=\"es-ES\";\n\t\telse language=\"en-US\";\n\t\t\n\t\tthis._route = L.Routing.control({\n\t\t\trouter: L.Routing.mapzen('mapzen-aMHsmLA', {\n\t\t\t\tlanguage: lang,\n\t\t\t\t    costing:'auto',\n\t\t\t\t    directions_options: {\n\t\t\t\t        language: language\n\t\t\t\t      }\n\t\t\t\t    }),\n\t\t\t formatter: new L.Routing.mapzenFormatter(),\n\t         routeWhileDragging: true,\n\t         plan: this._plan,\n\t         position: 'topleft',\n\t         language: language,\n\t\t     showAlternatives: true,\n\t\t     lineOptions: {\n\t            styles: [\n\t              {color: '#00B3FD', opacity: 1, weight: 4},\n\t            ]\n\t           },\n\t         altLineOptions:{\n\t        \tstyles: [\n\t     \t      {color: 'black', opacity: 1, weight: 2},\n\t     \t    ]\n\t         }\n\t\t});\n\t\t\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\t\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\tself._map = map;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\n\t\t\t.on(container, 'click', self._toggle, self);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tshow: function() {\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\n\t\tvar _map = this._map,\n\t\t\toptions = this.options,\n\t\t\t_texts = options.texts,\n\t\t\t_route = this._route;\n\t\t\n\t\t_map.fire('showRouting'); //to track ga events\n\t\t\n\t\t_map.on('click', this._routingPopup, this);\n\t\t_route.addTo(_map);\n\t\t\n\t\tif(window.lang){\n\t\t\t_texts.title = window.lang.translate(options.originTexts.title);\n\t\t\t_texts.btnReverse = window.lang.translate(options.originTexts.btnReverse);\n\t\t\t_texts.btnAdd = window.lang.translate(options.originTexts.btnAdd);\n\t\t\t_texts.start = window.lang.translate(options.originTexts.start);\n\t\t\t_texts.end = window.lang.translate(options.originTexts.end);\n\t\t}\n\t\t\n\t\t$('.leaflet-routing-geocoders').before( '<div class=\"div-routing-title\"><span lang=\"ca\" class=\"routing-title\">'+_texts.title+'</span>&nbsp;<a href=\"http://www.liedman.net/leaflet-routing-machine/\" target=\"_blank\" class=\"div-routing-title\" style=\"display:inline;\"><span class=\"glyphicon glyphicon-info-sign white\" style=\"font-size:14px;\"></a></div>' );\n\t\t$('.leaflet-routing-add-waypoint').attr('title',_texts.btnAdd);\n\t\t$('.leaflet-routing-add-waypoint').attr('lang',options.lang);\n\t\t$('.leaflet-routing-geocoder').first().find('input').attr('placeholder',_texts.start);\n\t\t$('.leaflet-routing-geocoder').last().find('input').attr('placeholder',_texts.end);\n\t\t\n\t\tvar offset = $(this._div).offset();\n\t\t\n\t\tjQuery('.leaflet-routing-container').css('top', (offset.top-60)+'px');\n\t\tjQuery('.leaflet-routing-container').css('left', (offset.left + 35)+'px');\n\t\tjQuery('.leaflet-routing-container').css('position','absolute');\n\t\tjQuery('.leaflet-routing-container').css('z-index','100');\n\t\t\n\t},\n\n\thide: function() {\n\t\tvar self = this,\n\t\t_map = self._map,\n\t\t_route = self._route;\n\t\t\n\t\t\n\t\tL.DomUtil.removeClass(self._div, 'greenfort');\n\t\tL.DomUtil.addClass(self._div, 'grisfort');\n\t\tconsole.debug(\"AQUI\");\n\t\ttry{\n\t\t\t_route.removeFrom.call(_route,_map);\n\t\t}catch(e){\n\t\t\tconsole.debug(e);\n\t\t}finally{\n\t\t\t_map.off('click',self._routingPopup, self);\n\t\t}\n\t\t\n\t},\n\t\n\t_toggle: function(e){\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\n\t\tthis[collapsed ? 'show' : 'hide']();\n\t}, \n\t\n\t_routingPopup: function(e) {\n\t\tconsole.debug(\"routing\");\n\t\tvar options = this.options,\n\t\t_texts = options.texts;\n\t\t\n\t\tif(window.lang){\n\t\t\t_texts.title = window.lang.translate(options.originTexts.title);\n\t\t\t_texts.btnStart = window.lang.translate(options.originTexts.btnStart);\n\t\t\t_texts.btnEnd = window.lang.translate(options.originTexts.btnEnd);\n\t\t}\n\t\t\n\t\tvar container ='<div id=\"contentRoutingPopup\" class=\"contentRoutingPopup\">';\n\t\tcontainer +='<h4 style=\"border-bottom:0px;\" lang=\"ca\">'+_texts.title+'</h4>';\n\t\tcontainer +='<button class=\"btn startBtn\" lang=\"ca\" type=\"button\" id=\"startBtn\">'+_texts.btnStart+'</button>'+\n\t\t  \t'<span class=\"awesome-marker-icon-green awesome-marker leaflet-zoom-hide leaflet-clickable leaflet-marker-draggable icona icona-origen\" id=\"icona-origen\"></span>'+\n\t\t   \t'<button class=\"btn endBtn\" lang=\"ca\" type=\"button\" id=\"destBtn\">'+_texts.btnEnd+'</button>'+\n\t\t   \t'<span class=\"awesome-marker-icon-red awesome-marker leaflet-zoom-hide leaflet-clickable leaflet-marker-draggable icona icona-desti\" id=\"icona-desti\"></span>';\n\t\tcontainer += \"</div>\";\n\t\t\n\t\tvar _map = this._map,\n\t\t\t_route = this._route;\n\t\t\n\t\tL.popup().setContent(container).setLatLng(e.latlng).openOn(_map);\n\n\t\tjQuery(\".leaflet-popup-content\").css('width','184px');\n\t\tjQuery(\".leaflet-popup-content\").css('margin','5px 15px');\n\n\t    jQuery('#startBtn').on('click', function() {\n\t    \t_route.spliceWaypoints(0, 1, e.latlng);\n\t    \t_map.closePopup();\n\t    });\n\n\t    jQuery('#destBtn').on('click', function() {\n\t    \t_route.spliceWaypoints(_route.getWaypoints().length - 1, 1, e.latlng);\n\t        _map.closePopup();\n\t    });\n\n\t    jQuery('#icona-origen').on('click', function() {\n\t    \t_route.spliceWaypoints(0, 1, e.latlng);\n\t    \t_map.closePopup();\n\t    });\n\n\t    jQuery('#icona-desti').on('click', function() {\n\t    \t_route.spliceWaypoints(_route.getWaypoints().length - 1, 1, e.latlng);\n\t        _map.closePopup();\n\t    });\n\n\t}, \n\t\n\t_createButton: function(label, container, title, lang) {\n\t    var btn = L.DomUtil.create('button', '', container);\n\t    btn.setAttribute('type', 'button');\n\t    btn.setAttribute('lang', lang);\n\t    btn.setAttribute('title', title);\n\t    btn.innerHTML = label;\n\t    return btn;\n\t},\n\n\t_createSpan: function(label, container) {\n\t    var span = L.DomUtil.create('span', '', container);\n\t    span.innerHTML = label;\n\t    return span;\n\t}\n});\n\nL.control.routingControl = function(options){\n\treturn new L.Control.RoutingControl(options);\n};","/**\n * L.Control.SearchControl control que permite hacer busquedas con caja única \n */\nL.Control.SearchControl = L.Control.extend({\n\toptions: {\n\t\tposition: 'topleft',\n\t\tid: 'dv_bt_Find',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\n\t\ttitle: 'Cercar',\n\t\tlangTitle: 'Cercar',\n\t\thtml: '<span id=\"span_bt_Find\" class=\"fa fa-search\"></span>',\n\t\tidInputText: 'ctr_cerca',\n\t\tinputplaceholderText: 'Cercar llocs al món o coordenades  ...',\n\t\ttooltip: 'right'\n\t},\n\t\n\tinitialize: function(options){\n\t\tL.setOptions(this, options);\n\t\t\n\t\tvar self = this,\n\t\toptions = this.options,\n\t\tinputText = L.DomUtil.create('div', options.idInputText);\n\t\t\n\t\tinputText.id = options.idInputText;\n\t\tjQuery('#searchBar').addClass(\"input-group\").append(inputText);\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\toptions = self.options,\n\t\tstop = L.DomEvent.stopPropagation,\n\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\t//agregar el boton\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\t\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\n\t\t\t.on(container, 'click', self._toggle, self);\n\t\t\n\t\t//agregar el control\n\t\t//TODO extender el control de origen en lugar de modificarlo\n\t\tself.control = new L.Control.Search({url: options.searchUrl,\n\t\t\tposition:'topcenter',\n\t\t\tfilterJSON: self._filterJSON,\n\t\t\tanimateLocation: false,\n\t\t\tmarkerLocation: false,\n\t\t\tzoom: 12,\n\t\t\tminLength: 3,\n\t\t\tautoType: false,\n\t\t\ttext:options.inputplaceholderText,\n\t\t\tidInputText : '#'+options.idInputText,\n\t\t\tzoom : 14,\n\t\t\ttextSize : 22,\n\t\t\tautoCollapseTime: 3200\n\t\t}).addTo(map);\n\t\t\n\t\treturn container;\n\t},\n\t\n\t_filterJSON: function(rawjson){\n\t\tvar self = this,\n\t\tjsonData = JSON.parse(rawjson.resposta),\n\t\tjson = {},\n\t\tkey, \n\t\tloc, \n\t\tdisp = [];\n\t\t\n\t\tif (jsonData.resultats.length>1){\n\t\t\tfor (var i = 0; i < jsonData.resultats.length; i++) {\n\t\t\t    var resultat = jsonData.resultats[i];\n\t\t\t    var coordsSplit = resultat.coordenades.split(\",\");\n\t\t\t    json[ resultat.nom ] = L.latLng(coordsSplit[0], coordsSplit[1]);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (jsonData.resultats.length>0){\n\t\t\t\tvar coords= jsonData.resultats[0].coordenades;\n\t\t\t\tvar nom = jsonData.resultats[0].nom;\n\t\t\t\tvar coordsSplit = [];\n\t\t\t\tif (coords) {\n\t\t\t\t\tcoordsSplit = coords.split(\",\");\n\t\t\t\t\tloc = L.latLng(coordsSplit[0], coordsSplit[1] );\n\t\t\t\t\tconsole.debug(self);\n\t\t\t\t\tself.showLocation(loc,coords,nom); \n\t\t\t\t}\n\t\t\t}\n\t\t\telse{\n\t\t\t\t\n\t\t\tself.showAlert(window.lang.translate(\"No trobat\"));\n\t\t\t}\n\t\t}\n\t\treturn json;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\thide: function() {\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\n\t\t$('#searchBar').hide();\n\t},\n\t\n\tshow: function(e){\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\n\t\tvar offset = $(this._div).offset();\n\t\t$('#searchBar').css('top', (offset.top - 15) +'px');\n\t\t$('#searchBar').css('left', (offset.left + 35) +'px');\n\t\t$('#searchBar').show();\n\t}, \n\t\n\t_toggle: function(e){\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\n\t\tthis[collapsed ? 'show' : 'hide']();\n\t\t$.publish('analyticsEvent',{event:['visor','button#cercaTopo','label cercaTopo', 6]});\n\t},\n});\n\nL.control.searchControl = function(options){\n\treturn new L.Control.SearchControl(options);\n};","/**\n * L.Control.Snapshot control que permite obtener una captura de pantalla del mapa\n * \n * require: geocat.mapa.canvas\n */\nL.Control.Snapshot = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_captura',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_captura',\n\t\ttitle: 'Capturar la vista del mapa',\n\t\tlangTitle: 'Capturar la vista del mapa',\n\t\thtml: '<span class=\"glyphicon glyphicon-camera grisfort\"></span>',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._captureMap, self);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tonRemove: function (map) {\n\t\tmap.off('mapsnapshot', this._map, this);\n\t},\n\t\n\t_captureMap: function(e){\n\t\tvar _map = this._map;\n\t\t_map.fire('mapsnapshot'); //to track ga events\n\t\t//TODO crear el modulo de captura\n\t\tcapturaPantalla(CAPTURA_MAPA);  //geocat.mapa.canvas\n\t}\n});\n\nL.control.snapshot = function(options){\n\treturn new L.Control.Snapshot(options);\n};","/**\n * L.Control.Like control que permite sumar/restar uno a los like de los mapas\n */\nL.Control.Like = L.Control.extend({\n\toptions: {\n\t\tposition: 'topleft',\n\t\tid: 'dv_bt_likeMap',\n\t\tclassName: 'leaflet-bar  btn btn-default btn-sm',\n\t\ttitle: 'Vista inicial',\n\t\tlangTitle: 'Vista inicial',\n\t\thtml: '<span id=\"span_bt_likeMap\" class=\"fa fa-heart-o grisfort\"></span>',\n\t\ttooltip: 'right'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\t\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._like, self);\n\t\treturn container;\n\t},\n\t\n\tonRemove: function (map) {\n\t\tvar self = this;\n\t\tmap.off('loadconfig', self._updateMapConfig, self);\n\t\tmap.off('visorconfig', self._updateMapConfig, self);\n\t},\n\t\n\t_like: function(e){\n\t\tvar self = this;\n\t\t\n\t\t_mapConfig = self.options.mapConfig;\n\t\t\n\t\tvar data = {\n\t\t\tbusinessId: _mapConfig.businessId\n\t\t};\n\t\t\n\t\tif(self._isLiked()){\n\t\t\tdata.rank = -1;\n\t\t\tself._unLiked();\n\t\t}else{\n\t\t\tdata.rank = 1;\n\t\t\tself._liked();\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tself._updateRankAplicacio(data).then(function(results){\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\tvar btnSpan = $(self._div).find('span');\n\t\t\t\tbtnSpan.tooltip({\n\t\t\t\t\tplacement: 'right',\n\t\t\t        title: results.results,\n\t\t\t        \n\t\t\t    }).tooltip('show');\n\t\t\t\tsetTimeout(function(){\n\t\t\t\t\tbtnSpan.tooltip('destroy');\n\t\t\t    }, 800);\n\t\t\t\t\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#like','label like']});\n\t\t\t\t\n\t\t\t}\n\t\t});\n\t},\n\t\n\t_updateRankAplicacio: function(params){\n\t\treturn $.ajax({\n\t\t\turl: paramUrl.updateRankAplicacio, //geocat.config-1.0.0\n\t  \t\tdata: params,\n\t  \t\tmethod: 'post',\n\t  \t\tdataType: 'jsonp'\n\t\t}).promise();\n\t},\n\t\n\t_isLiked: function(){\n\t\tvar self = this,\n\t\tliked = false;\n\t\t\n\t\tvar btnSpan = $(self._div).find('span');\n\t\t\n\t\tif($(btnSpan).hasClass('fa-heart-o')){\n\t\t\tliked = false;\n\t\t}else if($(btnSpan).hasClass('fa-heart')){\n\t\t\tliked = true;\n\t\t} \n\t\treturn liked;\n\t},\n\t\n\t_liked: function(){\n\t\tvar self = this;\n\t\tvar btnSpan = $(self._div).find('span');\n\t\t$(btnSpan).removeClass('fa-heart-o').addClass('fa-heart');\n\t},\n\t\n\t_unLiked: function(){\n\t\tvar self = this;\n\t\tvar btnSpan = $(self._div).find('span');\n\t\t$(btnSpan).removeClass('fa-heart').addClass('fa-heart-o');\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\t_updateMapConfig: function(config){\n\t\tthis.options.mapConfig = config;\n\t}\n});\n\nL.control.like = function(options){\n\treturn new L.Control.Like(options);\n};","/**\n * L.Control.Printmap control que permite obtener una impresion del mapa\n * \n * require: geocat.mapa.canvas\n */\nL.Control.Printmap = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_captura',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_print',\n\t\ttitle: 'Imprimir la vista del mapa',\n\t\tlangTitle: 'Imprimir la vista del mapa',\n\t\thtml: '<span class=\"glyphicon glyphicon-print grisfort\"></span>',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._printMap, self);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tonRemove: function (map) {\n\t\tmap.off('mapprint', this._map, this);\n\t},\n\t\n\t_printMap: function(e){\n\t\tvar _map = this._map;\n\t\t_map.fire('mapprint'); //to track ga events\n\t\t//TODO crear el modulo de captura\n\t\tcapturaPantalla(CAPTURA_INFORME);  //geocat.mapa.canvas\n\t}\n});\n\nL.control.printmap = function(options){\n\treturn new L.Control.Printmap(options);\n};\n","/**\n * L.Control.Geopdf control que permite obtener un geopdf del mapa\n * \n * require: geocat.mapa.canvas\n */\nL.Control.Geopdf = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_geopdf',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_geopdf',\n\t\ttitle: 'Descarrega mapa en format GeoPDF',\n\t\tlangTitle: 'Descarrega mapa en format GeoPDF',\n\t\thtml: '<span class=\"fa fa-file-pdf-o geopdf\"></span>',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._geoPdfMap, self);\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tonRemove: function (map) {\n\t\tmap.off('mapgeopdf', this._map, this);\n\t},\n\t\n\t_geoPdfMap: function(e){\n\t\tvar _map = this._map;\n\t\t_map.fire('mapgeopdf'); //to track ga events\n\t\t//TODO crear el modulo de captura\n\t\tcapturaPantalla(CAPTURA_GEOPDF);  //geocat.mapa.canvas\n\t}\n});\n\nL.control.geopdf = function(options){\n\treturn new L.Control.Geopdf(options);\n};\n","/**\n * L.Control.Control3D control que permite cambiar entre la vista 2d y 3d del mapa.\n * \n * requiere: instamaps.mapa.3D\n */\nL.Control.Control3D = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_3d_2d',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_3D_2D',\n\t\ttitle: 'Canviar vista',\n\t\tlangTitle: 'Canviar vista',\n\t\thtml: '<span class=\"text3D\">3D</span>',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._toggleView, self);\n\t\t\n\t\tmap.on('loadconfig', self._addModul3D, self);\n\t\tmap.on('visorconfig', self._addModul3D, self);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tonRemove: function (map) {\n\t\tvar self = this;\n\t\tmap.off('map3dmode', self._map, self);\n\t\tmap.off('loadconfig', self._addModul3D, self);\n\t\tmap.off('visorconfig', self._addModul3D, self);\n\t},\n\t\n\t_toggleView: function(e){\n\t\tvar _map = this._map;\n\t\t_map.fire('map3dmode'); //to track ga events\n\t\t//TODO crear el modulo\n\t\t//activaVista3d_2d(this._div) //instamaps.mapa.3D\n\t},\n\t\n\t_addModul3D: function(config){\n\t\t//TODO crear el control del modulo de 3D\n\t\taddModul3D(config);\n\t}\n});\n\nL.control.control3d = function(options){\n\treturn new L.Control.Control3D(options);\n};","/**\n * L.Control.LegendBtn\n */\nL.Control.LegendBtn = L.Control.extend({\n\toptions: {\n\t\tposition: 'bottomright',\n\t\tid: 'mapLegend',\n\t\tclassName: 'info legend visor-legend mCustomScrollbar',\n\t\ttitle: 'Llegenda',\n\t\tlangTitle: 'Llegenda',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\n\t\t\t.on(container, 'click', self._toggle, self);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\thide: function() {\n\t\tL.DomUtil.removeClass(this._div, 'greenfort');\n\t\tL.DomUtil.addClass(this._div, 'grisfort');\n\t\tthis.options.control.hide();\n\t},\n\t\n\tshow: function(e){\n\t\tL.DomUtil.removeClass(this._div, 'grisfort');\n\t\tL.DomUtil.addClass(this._div, 'greenfort');\n\t\tthis.options.control.show();\n\t},\n\t\n\t_toggle: function(e){\n\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\n\t\tthis[collapsed ? 'show' : 'hide']();\n\t}\n\t\n});\n\nL.control.legenbtn = function(options){\n\treturn new L.Control.LegendBtn(options);\n};","/**\n * L.Control.Legend control que crea el boton de la legenda y agrega la legenda al mapa\n * \n * require /geocatweb/js/leaflet/L.IM_LegendDivControl.js\n * require /geocatonline/llibreries/js/jquery/plugins/jquery.transit.js\n */\nL.Control.Legend = L.Control.extend({\n\toptions: {\n\t\tposition: 'bottomright',\n\t\tidBtn: 'dv_bt_legend',\n\t\tclassNameBtn: 'leaflet-bar btn btn-default btn-sm bt_legend grisfort',\n\t\ttitle: 'Llegenda',\n\t\thtml: '<span class=\"fa fa-list-alt\"></span>',\n\t\tid: 'mapLegend',\n\t\tclassName: 'info legend visor-legend ',\n\t\ttipusllegenda: 'dinamica',\n\t\tllegendaOpt: 'tancada',\n\t\ttransition: true\n\t},\n\t\n\tinitialize: function(options){\n\t\tL.setOptions(this, options);\n\t\n\t\tvar self = this,\n\t\toptions = self.options;\n\t\t\n\t\tself.button = L.control.legenbtn({\n\t\t\tposition: options.position,\n\t\t\tid: options.idBtn,\n\t\t\tclassName: options.classNameBtn,\n\t\t\thtml: options.html,\n\t\t\ttitle: options.title,\n\t\t\tcontrol: self\n\t\t}).addTo(map);\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tmap.on('loadconfig', self._updateLegend, self);\n\t\tmap.on('visorconfig', self._updateLegend, self);\t\t\t\t\n\t\tmap.on('activaLegendTab', self._updateTabLegend, self);\n\t\tmap.on('onRedrawLegend', self._redraw, self);\n\t\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault);\n\t\t\n\t\tself.hide();\n\t\t\n\t\treturn container;\n\t},\n\t\n\tonRemove: function (map) {\n\t\tvar self = this;\n\t\tmap.off('loadconfig', self._updateLegend, self);\n\t\tmap.off('visorconfig', self._updateLegend, self);\t\t\t\t\n\t\tmap.off('activaLegendTab', self._updateTabLegend, self);\n\t\tmap.off('onRedrawLegend', self._redraw, self);\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\tself.button.hideBtn();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\tself.button.showBtn();\n\t},\n\t\n\thide: function() {\n\t\tvar _$this = $(this._div),\n\t\ty2 = _$this.height() +50;\n\t\tif(this.options.transition){\n\t\t\t//_$this.fadeOut({duration: 'fast'});\n\t\t\t_$this.hide();\n\t\t}else{\n\t\t\t_$this.hide();\n\t\t}\n\t\tthis._redrawTabs();\n\t},\n\t\n\tshow: function(e){\n\t\tvar self = this;\n\t\tvar _$this = $(self._div);\n\t\t_$this.show();\n\t\tif(self.options.transition){\n\t\t\t_$this.fadeIn({duration: 'fast'});\n\t\t}\n\t\tself._redrawTabs();\n\t\t$.publish('analyticsEvent',{event:['visor','button#llegenda','label llegenda', 4]});\n\t},\n\t\n\t_updateLegend: function(config){\n\t\tvar self = this;\n\t\tself.servidorsWMS=config.servidorsWMS;\t\t\n\t\tself.legend = (config.legend? $.parseJSON( config.legend):\"\");\t\t\n\t\t\n\t\tself._draw();\n\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\n\t},\n\t\t\n\t_redraw: function(config){\n\t\tvar self = this;\n\t\t//this.servidorsWMS=config.servidorsWMS;\t\t\t\t\t\t\n\t\tif(self.options && self.options.origenllegenda==\"mapa\"){\n\t\t\tself.legend=generallegendaMapaEdicio();\n\t\t}else{\n\t\t\tself.legend = (config.legend? $.parseJSON( config.legend):\"\");\t\t\t\n\t\t}\t\t\t\t\n\t\t$(self._div).html('');\t\n\t\tself._draw();\n\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\n\t},\n\t\n\t_redrawTabs: function(){\n\t\tvar self = this;\n\t\tif(!$('#nav_legend li:first-child').hasClass('dropdown') || $(\"#nav_legend li\").length > 1){\n\t\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\n\t\t}\n\t},\n\t\n\t_updateTabLegend:function(obje){\n\t\t\n\t\tvar self = this;\n\t\tself.fromLayer = true;\n\t\tif(obje.activo){\n\t\t\t$('#nav_legend a[href=\"#tab'+obje.id+'\"]').tab('show');\t\n\t\t}else{\t\t\t\n\t\t\tvar lastActive=controlCapes.getCountActiveLayers();\t\n\t\t\tlastActive.total >0?$('#nav_legend a[href=\"#tab'+lastActive.lastActive+'\"]').tab('show'):$('#nav_legend a[href=\"#tab'+obje.id+'\"]').tab('show');\t\t\t\t\t\t\t\t\t\t\n\t\t}\n\t},\t\n\t\n\t_getLastActived:function(){\t\n\t\tvar self = this,\n\t\tmapLegend = self.legend;\n\t\tvar lastPos={indexPos:0};\n\t\tvar indexPos=0;\t\t\t\n\t\tvar k=0;\n\t\t\n\t\ttry{\n\t\tjQuery.each(self.servidorsWMS, function(j, row){\n\t\t\t\n\t\t\t\n\t\t\tif (self.servidorsWMS[j].capesActiva==\"true\"){\n\t\t\t\tk=0;\n\t\t\t\tjQuery.each(mapLegend, function(index, row){\n\t\t\t\t\tk++;\n\t\t\t\t\tfor (var i = 0; i < row.length; i++) {\t\t\t\t\t\t\t\n\t\t\t    \t\tif(row[i].chck){\n\t\t\t    \t\t\tif (self.servidorsWMS[j].businessId==index){\t\t\t\t    \t\t\t\t\n\t\t\t    \t\t\t\tlastPos.indexPos=k-1;\n\t\t\t    \t\t\t}\n\t\t\t    \t\t}\n\t\t\t    \t}\n\t\t\t\t});\n\t\t\t}\t\t\t\n\t\t});\t\t\t\t\n\t\t\n\t\tif(lastPos.indexPos==-1){lastPos.indexPos=0}\n\t\t\treturn lastPos;\t\t\n\t\t}catch(Err){\n\t\t\treturn lastPos;\n\t\t}\t\n\t\t\n\t},\n\t\n\t_draw: function(){\n\t\tvar self = this,\n\t\tmapLegend = self.legend,\n\t\tdiv = self._div;\n\t\tif (self._checkEmptyMapLegend()){\n\t\t\tvar legendhtml = [];\n\t\t\tif (self.options.tipusllegenda && self.options.tipusllegenda==\"estatica\"){\n\t\t\t\tjQuery.each(mapLegend, function(i, row){\n\t\t\t\t\tvar layerType=self._getNameLayer(i);\n\t\t\t\t\tvar serverName=\"\";\n\t\t\t\t\tfor (var k = 0; k < row.length; k++) {\n\t\t\t\t\t\tif (row[k].chck) {\n\t\t\t\t\t\t\tserverName=layerType.serverName;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (row.length>=1 && undefined!=serverName && \"\"!=serverName){\n\t\t\t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\n\t\t\t    \t\t\t'<div class=\"visor-legend-name\">'+layerType.serverName+'</div>'+\n\t\t\t    \t\t\t'</div>'+\n\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\n\t\t\t\t\t}\n\t\t\t\t\telse if (row.length>=1 && \"\"!=row[0].name) {\n\t\t\t\t\t\tvar name=row[0].name;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\n\t\t\t\t    \t\t\t'<div class=\"visor-legend-name\">'+name.substring(0,name.indexOf(\"(\"))+'</div>'+\n\t\t\t\t    \t\t\t'</div>'+\n\t\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\n\t\t\t\t\t}\n\t\t\t\t\tfor (var i = 0; i < row.length; i++) {\n\t\t\t    \t\tif(row[i].chck){\n\t\t\t    \t\t\tif (row[i].symbol.indexOf(\"circle\")>-1){\n\t\t\t    \t\t\t\tvar padding_left=\"0px\";\n\t\t\t    \t\t\t\tvar midaStr = row[i].symbol.substring(row[i].symbol.indexOf(\"r=\"),row[i].symbol.indexOf(\"style\"));\n\t\t\t    \t\t\t\tmidaStr=midaStr.substring(midaStr.indexOf(\"=\")+2,midaStr.length-2);\n\t\t\t    \t\t\t\tvar mida=parseFloat(midaStr);\n\t\t\t    \t\t\t\tif (mida>0 && mida<=6) padding_left=\"15px\";\n\t\t\t    \t\t\t\telse if (mida>6 && mida<=14) padding_left=\"10px\";\n\t\t\t    \t\t\t\telse if (mida>14 && mida<=22) padding_left=\"5px\";\n\t\t\t    \t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\" style=\"padding-left:'+padding_left+'\">'+row[i].symbol+'</div>'+\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"float:right;width:40%\">'+row[i].name+'</div>'+\n\t\t\t\t\t    \t\t\t'</div>'+\n\t\t\t\t\t    \t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\n\t\t\t    \t\t\t} else{\n\t\t\t    \t\t\t\tlegendhtml.push($('<div class=\"visor-legend-row\">'+\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\">'+row[i].symbol+'</div>'+\n\t\t\t\t\t    \t\t\t'<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"float:right;\">'+row[i].name+'</div>'+\n\t\t\t\t\t\t\t\t\t'</div>'+\n\t\t\t\t\t\t\t\t\t'<div class=\"visor-separate-legend-row\"></div>'));\n\t\t\t    \t\t\t}\t    \t\t\t\n\t\t\t    \t\t}\n\t\t\t    \t}\n\t\t\t    });\n\t\t\t\t$(div).append(legendhtml);\n\t\t\t\t$(div).mCustomScrollbar();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar legendTab=[];\n\t\t\t\tvar legendCont=[];\n\t\t\t\tvar legendTabContent=[];\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tlegendCont.push('<div id=\"legend_cont\">');\n\t\t\t\tlegendTab.push('<div id=\"legend_cont\"><ul id=\"nav_legend\" class=\"nav nav-tabs\">');\n\t\t\t\tlegendTabContent.push('<div class=\"legendTabCont tab-content\">');\n\t\t\t\t\n\t\t\t\tvar index=0;\n\t\t\t\t\n\t\t\t\tvar lastPos=self._getLastActived();\n\t\t\t\t\n\t\t\t\tjQuery.each(mapLegend, function(j, row){\n\t\t\t\tvar layerType=self._getNameLayer(j);\n\t\t\t\tindex==lastPos.indexPos?active=' active':active=\"\";\n\t\t\t\t\t\t\t\t\n\t\t\t\tif(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\n\t\t\t\t\tlegendTabContent.push('<div style=\"padding-top:10px;\" class=\"dv_lleg tab-pane'+active+'\" id=\"tab'+j+'\">');\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvar serverName=\"\";\n\t\t\t\tvar posServerName=-1;\n\t\t\t\tfor (var i = 0; i < row.length; i++) {\n\t\t\t\t\tif(row[i].chck || self.options.origenllegenda=='mapa'){\n\t\t\t\t\t\tif ((undefined==serverName && \"\"==serverName) || (undefined!=layerType.serverName && layerType.serverName!=serverName)) {\n\t\t\t\t\t\t\tposServerName=i;\n\t\t\t\t\t\t\tserverName=layerType.serverName;\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tposServerName=i;\n\t\t\t\t\t\t\tvar name=row[i].name;\n\t\t\t\t\t\t\tserverName=name.substring(0,name.indexOf(\"(\"));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar padding_left=\"\";\n\t\t\t\t\t\tvar textalg='left';\n\t\t\t\t\t\tif (row[i].symbol.indexOf(\"circle\")>-1){\n\t\t\t\t\t\t\tpadding_left=\"padding-left:0px\";\n\t\t\t\t\t\t\ttextalg='center';\n\t\t\t\t    \t\tvar midaStr = row[i].symbol.substring(row[i].symbol.indexOf(\"r=\"),row[i].symbol.indexOf(\"style\"));\n\t\t\t\t    \t\tmidaStr=midaStr.substring(midaStr.indexOf(\"=\")+2,midaStr.length-2);\n\t\t\t\t    \t\tvar mida=parseFloat(midaStr);\n\t\t\t\t    \t\tif (mida>0 && mida<=6) padding_left=\"padding-left:15px\";\n\t\t\t\t    \t\telse if (mida>6 && mida<=14) padding_left=\"padding-left:10px\";\n\t\t\t\t    \t\telse if (mida>14 && mida<=22) padding_left=\"padding-left:5px\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar isWMS=false;\n\t\t\t\t\t\tif (row[i].symbol.indexOf(\"GetLegendGraphic\")>-1){\n\t\t\t\t\t\t\tisWMS=true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tindex==lastPos.indexPos?active=' active':active=\"\";\n\t\t\t\t\t\tindex==lastPos.indexPos?self.options.currentTab=j:null;\t\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tif(i==posServerName){legendTab.push('<li class=\"'+active+'\"><a href=\"#tab'+j+'\" data-toggle=\"tab\">'+shortString(serverName,25)+'</a></li>');}\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*if(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\n\t\t\t\t\t\t\tlegendTabContent.push(row[i].symbol);\n\t\t\t\t\t\t\tlegendTabContent.push('<br/>');\n\t\t\t\t\t\t}else{*/\n\t\t\t\t\t\t\tif(i==posServerName){legendTabContent.push('<div  class=\"dv_lleg tab-pane'+active+'\" id=\"tab'+j+'\">');}\n\t\t\t\t\t\t\tlegendTabContent.push('<div class=\"visor-legend-row\">'+\n\t\t\t\t\t\t    \t'<div class=\"visor-legend-symbol col-md-4 col-xs-4\" style=\"padding-top:1px;'+padding_left+'\">'+row[i].symbol+'</div>');\n\t\t\t\t\t\t\tif (isWMS){\n\t\t\t\t\t\t\t\tlegendTabContent.push('</div><div class=\"visor-separate-legend-row\"></div>');\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tlegendTabContent.push('<div class=\"visor-legend-name col-md-8 col-xs-8\" style=\"text-align:'+textalg+' ;padding-top:5px;\">'+row[i].name+'</div>'+\n\t\t\t\t\t\t    \t'</div><div class=\"visor-separate-legend-row\"></div>');\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif(i==row.length-1){legendTabContent.push('</div>');}\t\t\t\n\t\t\t\t\t\t//}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tindex=index+1;\n\t\t\t\tif(layerType.capesOrdre && layerType.capesOrdre.indexOf('sublayer') ==-1){\n\t\t\t\t\tlegendTabContent.push('</div>');\n\t\t\t\t}\n\t\t\t    });\n\t\t\t\t\n\t\t\t\tlegendTab.push('</ul>');\n\t\t\t\tlegendTabContent.push('</div></div>');\n\t\t\t\t\n\t\t\t\t$(div).append(legendTab.join(\"\"));\n\t\t\t\t$(div).append(legendTabContent.join(\"\"));\n\t\t\t\t$('#nav_legend').tabdrop({offsetTop: -5},'layout');\n\t\t\t\n\t\t\t\t$(\"#nav_legend\").on('click', function(event){ //enables click event\n\t\t\t\t\t$(\"#nav_legend .dropdown-menu\").toggle();\t\t\t\n\t\t\t\t});\n\t\t\t\t$(\"#nav_legend .dropdown-menu a\").on('click', function(event){\n\t\t\t\t\tvar href = $(location).attr('href');\n\t\t\t\t\thref=href.substring(0,href.indexOf(\"#\"));\n\t\t\t\t    var objecthref=event.target.href;\n\t\t\t\t    objecthref= objecthref.replace(href+'#tab',\"\");\n\t\t\t\t    $('#nav_legend a[href=\"#tab'+objecthref+'\"]').tab('show');\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\t$(div).on('click', function(e){\t\t\t\n\t\t\t\t\tchangeWMSQueryable(false);\n\t\t\t\t});\t\n\t\t\t\t \n\t\t\t\t$(div).on('mouseout', function(e){\t\t\t\t\n\t\t\t\t\tchangeWMSQueryable(true);\n\t\t\t\t});\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t$('.dv_lleg').on('click', function(e){\t\t\t\n\t\t\t\t\taturaClick(e);\n\t\t\t\t});\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t$('.legendTabCont').on('click', function(e){\t\t\t\n\t\t\t\t\taturaClick(e);\n\t\t\t\t});\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t$('.legendTabCont').on('mousedown', function(e){\t\t\t\n\t\t\t\t\taturaClick(e);\n\t\t\t\t});\t\n\t\t\t\n\t\t\t\t$(' #nav_legend a[data-toggle=\"tab\"]').on('shown.bs.tab', self._activaCapaTab.bind(self));\n\t\t\t}\n\t\t}\n\t},\n\t\n\t_activaCapaTab: function(e){\n\t\tvar self = this;\n\t\tself._redrawTabs();\n\t\tif(!self.fromLayer){\n\t\t\tvar idLayer=$(e.target).attr('href').replace('#tab','');\n\t\t\t$( \"#input-\"+idLayer).attr(\"checked\")==undefined ? $(\"#input-\"+idLayer).click():null;\n\t\t}else{\n\t\t\tself.fromLayer = false;\n\t\t}\n\t\t$.publish('analyticsEvent',{event:['visor','button#activaLlegendaTab','label activaLlegendaTab', 4]});\n\t},\n\t\n\t_getNameLayer:function(idLayer){\t\t\n\t\tvar self = this;\n\t\tservidorsWMS = self.servidorsWMS;\n\t\tvar layerType={};\n\t\tif(typeof servidorsWMS === \"string\" ){servidorsWMS = [servidorsWMS]};\n\t\t$.each(servidorsWMS, function(i, row){\t\t\t\n\t\t\t\tif(row.businessId==idLayer){\n\t\t\t\t\tlayerType.serverName=row.serverName.replace('##1','');\n\t\t\t\t\tlayerType.capesOrdre=row.capesOrdre;\n\n\t\t\t\t}\t\t\t\t\t\t\n\t\t});\t\n\n\tif(!layerType.serverName && getModeMapa()){\n\t\t\n\t\tlayerType=obteLListatCapesEditor(idLayer);\n\t}\t\n\t\t\n\t\t\n\t\treturn layerType;\t\t\n\t},\t\n\n\t_checkEmptyMapLegend: function(){\n\t\tvar trobat = false,\n\t\tself = this,\n\t\tmapLegend = self.legend;\n\t\tif(typeof mapLegend === \"string\" ){mapLegend = [mapLegend]};\n\t\t$.each(mapLegend, function(i, row){\n\t    \tfor (var i = 0; i < row.length && !trobat; i++) {\n\t    \t\tif(row[i].chck){\n\t    \t\t\ttrobat = true;\n\t    \t\t}\n\t    \t}\n\t\t});\n\t\treturn trobat;\n\t},\n});\n\nL.control.legend = function(options){\n\treturn new L.Control.Legend(options);\n};","/**\n * L.Control.LayersBtn control que agrega el control de capas\n * \n * require /geocatonline/geocatweb/js/leaflet/L.IM_ControlLayerManager.js\n * require /geocatonline/llibreries/js/jquery/plugins/jquery.transit.js\n */\nL.Control.LayersBtn = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_layers',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm grisfort',\n\t\ttitle: 'Llista de capes',\n\t\tlangTitle: 'Llista de capes',\n\t\thtml: '<span class=\"glyphicon glyphicon-th-list\"></span>',\n\t\ttransition: true,\n\t\tbutton: true,\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tcontainer,\n\t\t\tstop = L.DomEvent.stopPropagation;\n\t\t\n\t\tif(options.button){\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\tcontainer.id = options.id;\n\t\t\tcontainer.innerHTML = options.html;\n\t\t\tcontainer.title = options.title;\n\t\t\tcontainer.dataset.toggle = 'tooltip';\n\t\t\tcontainer.dataset.placement = options.tooltip;\n\t\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t}else{\n\t\t\tcontainer = L.DomUtil.create('div', '');\n\t\t}\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tmap.on('loadconfig', self._updateMapConfig, self);\n\t\tmap.on('visorconfig', self._updateMapConfig, self);\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', L.DomEvent.preventDefault)\n\t\t\t.on(container, 'click', self._toggle, self);\n\t\t\n\t\tself.control = L.control.orderlayers(null, null, {\n\t\t\tcollapsed : false,\n\t\t\tid : 'div_capes',\n\t\t\teditMode: false,\n\t\t\tautoUpdate: false,\n\t\t\tmapConfig: self.options.mapConfig\n\t\t}).addTo(map);\n\t\t\n\t\tcontrolCapes = self.control;\n\n\t\tmap.on('addItemFinish',function(){\n\t\t\t$(\".layers-list\").mCustomScrollbar(\"destroy\");\n\t\t\t$(\".layers-list\").mCustomScrollbar({\n\t\t\t   advanced:{\n\t\t\t     autoScrollOnFocus: false,\n\t\t\t     updateOnContentResize: true\n\t\t\t   }\n\t\t\t});\n\t\t});\n\t\t\n\t\tself.hide();\n\t\t\n\t\treturn container;\n\t},\n\t\n\tonRemove: function (map) {\n\t\tvar self = this;\n\t\tmap.off('loadconfig', self._updateMapConfig, self);\n\t\tmap.off('visorconfig', self._updateMapConfig, self);\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t\tvar div = self.control.getContainer();\n\t\t$(div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t\tif(!self.control.options.collapsed){\n\t\t\tvar div = self.control.getContainer();\n\t\t\t$(div).show();\n\t\t\t\n\t\t}\n\t},\n\t\n\thide: function() {\n\t\tvar self = this;\n\t\tL.DomUtil.removeClass(self._div, 'greenfort');\n\t\tL.DomUtil.addClass(self._div, 'grisfort');\n\t\tvar div = self.control.getContainer();\n\t\tself.control.options.collapsed = true;\n\t\tif(self.options.transition){\n\t\t\t$(div).fadeOut({duration: 'fast'});\n\t\t}else{\n\t\t\t$(div).hide();\n\t\t}\n\t},\n\t\n\tshow: function(e){\n\t\tvar self = this;\n\t\tL.DomUtil.removeClass(self._div, 'grisfort');\n\t\tL.DomUtil.addClass(self._div, 'greenfort');\n\t\tvar div = self.control.getContainer();\n\t\tself.control.options.collapsed = false;\n\t\tif(self.options.transition){\n\t\t\t$(div).fadeIn({duration: 'fast'});\n\t\t}else{\n\t\t\t$(div).show();\n\t\t}\n\t\t$.publish('analyticsEvent',{event:['visor','button#llistaCapes','label llistaCapes', 3]});\n\t},\n\t\n\t_toggle: function(e){\n\t\tvar self = this;\n\t\tvar collapsed = L.DomUtil.hasClass(self._div, 'grisfort');\n\t\tthis[collapsed ? 'show' : 'hide']();\n\t\t\n\t},\n\t\n\t_updateMapConfig: function(config){\n\t\tthis.options.mapConfig = config;\n\t}\n});\n\nL.control.layersBtn = function(options){\n\treturn new L.Control.LayersBtn(options);\n};","/**\n * L.Control.LocationControl control que hace lo mismo que el L.Control.Gps\n * \n * require L.Control.Gps\n */\nL.Control.LocationControl = L.Control.Gps.extend({\n\t\n\toptions: {\n\t\tposition: 'topleft',\n\t\tid: 'dv_bt_Location',\n\t\ttitle: 'Centrar mapa a la seva ubicació',\n\t\tlangTitle: 'Centrar mapa a la seva ubicació',\n\t\ttooltip: 'right'\n\t},\n\t\n\tinitialize: function(options){\n\t\tvar self = this,\n\t\t_options = self.options;\n\t\t\n\t\tif(options){\n\t\t\toptions = L.Util.extend({}, _options, options);\n\t\t}\n\t\tL.Util.setOptions(self, options);\n\t\tL.Control.Gps.prototype.initialize.call(self, options);\n\t},\n\t\n\tonAdd: function(map) {\n\t\tvar self = this,\n\t\toptions = self.options;\n\t\tvar container = L.Control.Gps.prototype.onAdd.call(self, map);\n\t\t\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._map\n\t\t\t.on('locationfound', this._publishFound, self)\n\t\t\t.on('locationerror', this._publishError, self);\n\t\t\n\t\tself._div = container;\n\t\treturn container;\n\t},\n\t\n\t_publishFound:function(){\n\t\t$.publish('analyticsEvent',{event:['visor','input#GPS_OK','label GPS', 10]});\n\t},\t\n\t\n\t_publishError:function(){\n\t\t$.publish('analyticsEvent',{event:['visor','input#GPS_FAIL','label GPS', 10]});\n\t},\t\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n});\n\nL.control.locationControl = function(options){\n\treturn new L.Control.LocationControl(options);\n};","/**\n * L.Control.Escala hace lo mismo que el L.Control.Scale\n * \n * require L.Control.Scale\n */\nL.Control.Escala = L.Control.Scale.extend({\n\tonAdd: function(map) {\n\t\tvar self = this;\n\t\tvar container = L.Control.Scale.prototype.onAdd.call(self, map);\n\t\tself._div = container;\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t}\n});\n\nL.control.escala = function(options){\n\treturn new L.Control.Escala(options);\n};","/**\n * L.Control.Minimapa igual que el L.Control.MiniMap\n * \n * require L.Control.MiniMap\n */\nL.Control.Minimapa = L.Control.MiniMap.extend({\n\tonAdd: function(map) {\n\t\tvar self = this;\n\t\tvar container = L.Control.MiniMap.prototype.onAdd.call(self, map);\n\t\tself._div = container;\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t\t$.publish('analyticsEvent',{event:['visor','button#miniMapa','label miniMapa', 5]});\n\t}\n});\n\nL.control.minimapa = function(layer, options){\n\treturn new L.Control.Minimapa(layer, options);\n};\n","/**\n * L.Control.Logos control para crear logos.\n */\nL.Control.Logos = L.Control.extend({\n\toptions: {\n\t\tposition: 'bottomleft',\n\t\tid: 'dv_logos',\n\t\tclassName: 'logos_footer',\n\t\tchildClassName: 'logo_footer'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\toptions = self.options,\n\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tif (L.DomEvent) {\n\t\t\tL.DomEvent.disableClickPropagation(container);\n\t\t}\n\t\t\n\t\tcontainer.id = options.id;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tself.addLogo({\n\t\t\tclassName: 'logo_icgc',\n\t\t\tid: 'logo_icgc',\n\t\t\ttitle: 'Institut Cartogràfic i Geològic de Catalunya',\n\t\t\turl: 'http://www.icgc.cat',\n\t\t\thtml: '<img height=\"45\" src=\"/llibreries/img/icgc.png\">'\n\t\t});\n\t\t\n\t\treturn container;\n\t},\n\t\n\taddLogo: function(options){\n\t\tvar self = this,\n\t\tcontainer = self._div,\n\t\tclassName = self.options.childClassName;\n\t\t\n\t\tif(options.className){\n\t\t\tclassName += \" \" + options.className;\n\t\t}\n\t\t\n\t\tvar link = L.DomUtil.create('a', className, container);\n\t\tlink.id = options.id;\n\t\tlink.innerHTML = options.html;\n\t\tlink.href = options.url;\n\t\tlink.title = options.title;\n\t\tlink.target = \"_blank\";\n\t\t\t\t\n\t\treturn link;\n\t},\n\t\n\taddLogoHtml: function(html){\n\t\tvar self = this,\n\t\tcontainer = self._div;\n\t\tcontainer.insertAdjacentHTML('beforeend', html);\n\t},\n\t\n\tremoveLogo: function(options){\n\t\tvar self = this,\n\t\tcontainer = self._div;\n\t\tif(options.id){\n\t\t\tvar logo = L.DomUtil.get(options.id);\n\t\t\tcontainer.removeChild(logo);\n\t\t}\n\t\tif(options.className){\n\t\t\tvar elements = container.getElementsByClassName(options.className);\n\t\t\tfor(var i = 0, length = elements.length; i < length; i++){\n\t\t\t\tcontainer.removeChild(elements[i]);\n\t\t\t}\n\t\t}\n\t}\n\n});\n\nL.control.logos = function(options){\n\treturn new L.Control.Logos(options);\n};","/**\n * \n */\nL.Control.Widgets = L.Control.extend({\n\toptions: {\n\t\tposition: 'topright',\n\t\tid: 'dv_bt_widgets',\n\t\tclassName: 'leaflet-bar btn btn-default btn-sm bt_widgets',\n\t\ttitle: 'Ginys',\n\t\tlangTitle: 'Ginys',\n\t\thtml: '<span class=\"fa fa-cogs widgets\"></span>',\n\t\tmodalContainer: '#mapa_modals',\n\t\ttooltip: 'left'\n\t},\n\t\n\tonAdd: function(map){\n\t\tvar self = this,\n\t\t\toptions = self.options,\n\t\t\tstop = L.DomEvent.stopPropagation,\n\t\t\tcontainer = L.DomUtil.create('div', options.className);\n\t\t\n\t\tcontainer.id = options.id;\n\t\tcontainer.innerHTML = options.html;\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\t\t\n\t\tself._div = container;\n\t\t\n\t\tL.DomEvent\n\t\t\t.on(container, 'click', stop)\n\t\t\t.on(container, 'mousedown', stop)\n\t\t\t.on(container, 'dblclick', stop)\n\t\t\t.on(container, 'click', self._showWidgets, self);\n\t\t\n\t\tself.widgets = {};\n\t\tself.subscriptions();\n\t\tself._addModalWidgets();\n\t\t\n\t\t//iniciar la lista de municipios\n\t\t$.publish('mapMoveend', map);\n\t\t\n\t\treturn container;\n\t},\n\t\n\thideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n\t\n\tonRemove: function (map) {\n\t\tmap.off('mapprint', this._map, this);\n\t\t\n\t\t//remove dialog\n\t\t$('.dialgo_widgets').remove();\n\t\t\n\t},\n\t\n\t_showWidgets: function(e){\n\t\tvar _map = this._map;\n\t\t\n\t\t$('.dialgo_widgets').modal('show');\n\t\t//TODO crear los eventos\n\t\t_map.fire('showwigets'); //to track ga events\n\t\t//TODO crear el modulo de captura\n\t\t//capturaPantalla(CAPTURA_INFORME);  //geocat.mapa.canvas\n\t}, \n\t\n\t_addModalWidgets: function(){\n\t\t\n\t\t\n    \tvar that = this;\n    \t$.get(\"templates/modalWidgets.html\",function(data){\n\t\t\t//TODO ver como pasar el modal container\n    \t\t$(that.options.modalContainer).append(data);\n    \t\tvar modalbody = $('.dialgo_widgets div.widgets-list');\n    \t\tvar selectdiv = $('.dialgo_widgets div.selectMunicipi');\n    \t\tvar listdiv = $('.dialgo_widgets div.listMunicipis');\t\t\t\n    \t\tthat._addSelectMunicipis(selectdiv);\n    \t\tthat._addListViewMunicipis(listdiv);\n    \t\tthat._addIdescatWidget(modalbody);\n    \t\tthat._addRPUCWidget(modalbody);\n    \t\tthat._addCartotecaWidget(modalbody);\n    \t\tthat._addMeteoWidget(modalbody);\n        \tthat._addCadastreWidget(modalbody);\n        \tthat._addInfoParcelaWidget(modalbody);\n\t\t\tthat._addMascaraWidget(selectdiv);\n        });\n    },\n    \n    _addSelectMunicipis: function(container){\n    \tvar select = SelectMunicipis.createSelect();\n    \tcontainer.append(select);\n    \t$(select).addClass(\"selectpicker\").selectpicker({liveSearch:true});\n\t\t\n    },\n    \n    _addListViewMunicipis: function(container){\n    \tvar _map = this._map;\n    \tListViewMunicipis.createList(container);\n    \t_map.on('moveend',function(e){\n      \t\t$.publish('mapMoveend', this);\n      \t});\n    },\n    \n\t\n    _addMeteoWidget: function(container){\n    \tthis.widgets.meteo = WidgetMeteo.getWidget();\n    \tWidgetMeteo.drawButton(container);\n    },\n    \n    _addIdescatWidget: function(container){\n    \tthis.widgets.idescat = WidgetIdescat.getWidget();\n    \tWidgetIdescat.drawButton(container);\n    \tWidgetIdescat.activate();\n    \t$('.widgets-list .widget-idescat').addClass(\"widget-button-active\");\n    },\n    \n    _addCadastreWidget: function(container){\n    \tthis.widgets.cadastre = WidgetCadastre.getWidget();\n    \tWidgetCadastre.drawButton(container);\n    },\n    \n    _addRPUCWidget: function(container){\n    \tthis.widgets.rpuc = WidgetRPUC.getWidget();\n    \tWidgetRPUC.drawButton(container);\n    },\n    \n    _addInfoParcelaWidget: function(container){\n    \tthis.widgets.rpuc = WidgetInfoparcela.getWidget();\n    \tWidgetInfoparcela.drawButton(container);\n    },\n\t\n\t\n\t _addMascaraWidget: function(container){\n    \tWidgetMascara.getWidget();\n    \tWidgetMascara.drawButton(container);\n    },\n\t\n\t\n\t\n\t\n    \n    _addCartotecaWidget: function(container){\n    \tthis.widgets.cartoteca = WidgetCartoteca.getWidget();\n    \tWidgetCartoteca.drawButton(container);\n    },\n    \n    deactivateWidgets: function(){\n    \tvar that = this;\n    \tfor(var widget in that.widgets){\n    \t\tthat.widgets[widget].deactivate();\n    \t}\n    \t$('.widgets-list .widget-button').removeClass(\"widget-button-active\");\n    },\n    \n    getWidgets: function(){\n    \tvar that = this;\n    \treturn that.widgets;\n    },\n    \n    subscriptions: function() {\n    \tvar that = this,\n    \t\t_map = this._map;\n    \t\n    \t$.subscribe('changeSelectMunicipis',function(e, data){\n\t\t\t\n\t\t\n\t\t\t\n    \t\tthat.activeMunicipi = data;\n    \t\t//zoom al municipio\n    \t\tif(data && _map){\n    \t\t\tvar bbox = data.bbox.split(\",\");\n    \t\t\tvar southWest = L.latLng(bbox[1], bbox[0]),\n    \t\t    northEast = L.latLng(bbox[3], bbox[2]),\n    \t\t    bounds = L.latLngBounds(southWest, northEast);\n    \t\t\t_map.fitBounds(bounds)\n    \t\t}\n    \t});\n    \t\n    \t$.subscribe('widgetActivated',function(e, data){\n    \t\tthat.deactivateWidgets();\n    \t\tvar classWidget = $(data.target).attr('class').split(\" \")[1];\n    \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widgets', classWidget, 1]});\n    \t\t$(data.target).addClass(\"widget-button-active\");\n    \t\tdata.widget.activate();\n    \t\tif(that.activeMunicipi){\n\t\t\t\tconsole.info(that.activeMunicipi);\n    \t\t\tdata.widget.draw(that.activeMunicipi);\n    \t\t}\n    \t});\n    \t\n    }\n});\n\nL.control.widgets = function(options){\n\treturn new L.Control.Widgets(options);\n};","/**\n * \n */\nL.Control.MapExport = L.Control\n\t\t.extend({\n\t\t\toptions : {\n\t\t\t\tposition : 'topright',\n\t\t\t\tid : 'dv_bt_mapExport',\n\t\t\t\tclassName : 'leaflet-bar btn btn-default btn-sm bt_exportfile grisfort',\n\t\t\t\ttitle : 'Exportar i imprimir mapa',\n\t\t\t\tlangTitle : 'Exportar i imprimir mapa',\n\t\t\t\thtml : '<span class=\"glyphicon glyphicon-paste\"></span>',\n\t\t\t\ttooltip : 'bottom'\n\t\t\t},\n\n\t\t\tonAdd : function(map) {\n\t\t\t\tvar self = this, options = self.options, stop = L.DomEvent.stopPropagation, container = L.DomUtil\n\t\t\t\t\t\t.create('div', options.className);\n\n\t\t\t\tcontainer.id = options.id;\n\t\t\t\tcontainer.innerHTML = options.html;\n\t\t\t\tcontainer.title = options.title;\n\n\t\t\t\tcontainer.dataset.toggle = 'tooltip';\n\t\t\t\tcontainer.dataset.placement = window.lang.translate(options.tooltip);\n\t\t\t\tcontainer.dataset.langTitle = window.lang.translate(options.langTitle);\n\n\t\t\t\tself._div = container;\n\n\t\t\t\tvar _scope = 'visor';\n\t\t\t\tvar tipus_user = \"\";\n\t\t\t\tgetModeMapa() ? _scope = 'mapa' : _scope = 'visor';\n\n\t\t\t\tif (_scope == 'mapa') {\n\t\t\t\t\ttipus_user = defineTipusUser();\n\t\t\t\t}else{\n\t\t\t\t\ttipus_user =\"button#\";\n\t\t\t\t}\t\n\n\t\t\t\tthis._div_H_Export = L.DomUtil.create('div',\n\t\t\t\t\t\t'div_barraexport div_gr40');\n\n\t\t\t\tvar btcamera = jQuery(\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_captura\\\" title=\\\"Capturar la vista del mapa\\\" data-lang-title=\\\"Capturar la vista del mapa\\\"><span class='glyphicon glyphicon-camera grisfort'></span></div>\")\n\t\t\t\t\t\t.on(\n\t\t\t\t\t\t\t\t'click',\n\t\t\t\t\t\t\t\tfunction(event) {\n\t\t\t\t\t\t\t\t\taturaClick(event);\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'captura pantalla',\n\t\t\t\t\t\t\t\t\t\t\t'label captura', 1]});\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA);\n\t\t\t\t\t\t\t\t\tself.hide()\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\tthis._div_H_Export.appendChild(btcamera[0]);\n\n\t\t\t\tvar btprint = jQuery(\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_print\\\" title=\\\"Imprimir la vista del mapa\\\" data-lang-title=\\\"Imprimir la vista del mapa\\\"><span class='glyphicon glyphicon-print grisfort'></span></div>\")\n\t\t\t\t\t\t.on(\n\t\t\t\t\t\t\t\t'click',\n\t\t\t\t\t\t\t\tfunction(event) {\n\n\t\t\t\t\t\t\t\t\taturaClick(event);\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'print',\n\t\t\t\t\t\t\t\t\t\t\t'label print', 1]});\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_INFORME);\n\t\t\t\t\t\t\t\t\tself.hide();\n\t\t\t\t\t\t\t\t});\n\t\t\t\tthis._div_H_Export.appendChild(btprint[0]);\n\n\t\t\t\tvar btgeopdf = jQuery(\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geopdf\\\" title=\\\"Descarrega mapa en format GeoPDF\\\" data-lang-title=\\\"Descarrega mapa en format GeoPDF\\\"><span class='fa fa-file-pdf-o geopdf'></span></div>\")\n\t\t\t\t\t\t.on(\n\t\t\t\t\t\t\t\t'click',\n\t\t\t\t\t\t\t\tfunction(event) {\n\n\t\t\t\t\t\t\t\t\taturaClick(event);\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geopdf',\n\t\t\t\t\t\t\t\t\t\t\t'label geopdf', 1]});\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_GEOPDF);\n\t\t\t\t\t\t\t\t\tself.hide();\n\t\t\t\t\t\t\t\t});\n\t\t\t\tthis._div_H_Export.appendChild(btgeopdf[0]);\n\n\t\t\t\tvar btgeotiff = jQuery(\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geotiff\\\" title=\\\"Descarrega mapa en format GeoTiff\\\" data-lang-title=\\\"Descarrega mapa en format GeoTiff\\\"><span class='fa fa-file-image-o grisfort'></span></div>\")\n\t\t\t\t\t\t.on(\n\t\t\t\t\t\t\t\t'click',\n\t\t\t\t\t\t\t\tfunction(event) {\n\t\t\t\t\t\t\t\t\taturaClick(event);\n\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geotiff',\n\t\t\t\t\t\t\t\t\t\t\t'label geotiff', 1]});\n\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA_GEOTIFF);\n\t\t\t\t\t\t\t\t\tself.hide();\n\n\t\t\t\t\t\t\t\t});\n\t\t\t\tthis._div_H_Export.appendChild(btgeotiff[0]);\n\n\t\t\t\tvar btgeopkg = jQuery(\n\t\t\t\t\t\t\"<div data-toggle=\\\"tooltip\\\" class=\\\"leaflet-bar btn btn-default btn-sm bt_geopkg\\\" title=\\\"Descarrega vectors en format GeoPackage\\\" data-lang-title=\\\"Descarrega vectors en format GeoPackage\\\"><span class='fa fa-database grisfort'></span></div>\")\n\t\t\t\t\t\t.on('click',\n\t\t\t\t\t\t\t\tfunction(event) {\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\taturaClick(event);\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:[ _scope,\n\t\t\t\t\t\t\t\t\t\t\ttipus_user + 'geopkg',\n\t\t\t\t\t\t\t\t\t\t\t'label geopkg', 1]});\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tcapturaPantalla(CAPTURA_MAPA_GEOPACKAGE);\n\t\t\t\t\t\t\t\t\tself.hide()\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\tthis._div_H_Export.appendChild(btgeopkg[0]);\n\n\t\t\t\tjQuery('body').append(this._div_H_Export);\n\n\t\t\t\tL.DomEvent.on(container, 'click', stop).on(container,\n\t\t\t\t\t\t'mousedown', stop).on(container, 'dblclick', stop).on(\n\t\t\t\t\t\tcontainer, 'click', L.DomEvent.preventDefault).on(\n\t\t\t\t\t\tcontainer, 'click', self._toggle, self);\n\n\t\t\t\treturn container;\n\t\t\t},\n\n\t\t\thideBtn : function() {\n\t\t\t\tvar self = this;\n\t\t\t\t$(self._div).hide();\n\t\t\t},\n\n\t\t\tshowBtn : function() {\n\t\t\t\tvar self = this;\n\t\t\t\t$(self._div).show();\n\t\t\t},\n\n\t\t\thide : function() {\n\t\t\t\tL.DomUtil.removeClass(this._div, 'greenfort');\n\t\t\t\tL.DomUtil.addClass(this._div, 'grisfort');\n\t\t\t\t$('.div_barraexport').hide();\n\t\t\t},\n\n\t\t\tshow : function(e) {\n\n\t\t\t\tL.DomUtil.removeClass(this._div, 'grisfort');\n\t\t\t\tL.DomUtil.addClass(this._div, 'greenfort');\n\t\t\t\tvar leftO = ($(this._div_H_Export).width() + parseInt(10));\n\t\t\t\tvar offset = $(this._div).offset();\n\t\t\t\t$('.div_barraexport').css('top', (offset.top - 10) + 'px');\n\t\t\t\t$('.div_barraexport').css('left', (offset.left - leftO) + 'px');\n\t\t\t\t$('.div_barraexport').show();\n\t\t\t\tjQuery('.leaflet-control-layers').hide();\n\t\t\t},\n\n\t\t\t_toggle : function(e) {\n\t\t\t\tvar collapsed = L.DomUtil.hasClass(this._div, 'grisfort');\n\t\t\t\tthis[collapsed ? 'show' : 'hide']();\n\t\t\t},\n\n\t\t});\n\nL.control.mapExport = function(options) {\n\treturn new L.Control.MapExport(options);\n};","L.Spinner = {\r\n\tspin: function (state, _options) {\r\n    \tif (!!state) {\r\n            // start spinning !\r\n    \t\tif (!this._spinner) {\r\n    \t\t\tthis._spinner = L.DomUtil.get(this.options.spinerDiv);\r\n    \t\t\tthis._spinning = 0;\r\n    \t\t}\r\n    \t\tif (this._spinner) {\r\n    \t\t\tthis._spinner.style.display = 'flex';\r\n    \t\t}\r\n    \t\tthis._spinning++;\r\n        }\r\n        else {\r\n            this._spinning--;\r\n            if (this._spinning <= 0) {\r\n                // end spinning !\r\n            \tif (this._spinner) {\r\n            \t\tthis._spinner.style.display = 'none';\r\n            \t\tthis._spinner = null;\r\n            \t}\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nL.Map.include(L.Spinner);\r\n\r\nL.Map.addInitHook(function () {\r\n\tthis.on('layeradd',function(e){\r\n\t\tif( e.layer instanceof L.TileLayer ){\r\n\t\t\tif (e.layer.loading) this.spin(true);\r\n\t\t\tif (typeof e.layer.on != 'function') return;\r\n\t        e.layer.on('data:loading', function () { this.spin(true); }, this);\r\n\t        e.layer.on('data:loaded',  function () { this.spin(false); }, this);\r\n\t\t}\r\n\t});\r\n\t\r\n\tthis.on('layerremove', function (e) {\r\n        // Clean-up\r\n        if (e.layer.loading) this.spin(false);\r\n        if (typeof e.layer.on != 'function') return;\r\n        e.layer.off('data:loaded');\r\n        e.layer.off('data:loading');\r\n    }, this);\r\n});","/**\n * Classe propia, layer de wikipedia\n */\n\nL.Wikipedia = L.FeatureGroup.extend({\n\toptions: {\n\t\tkey: ''\n\t},\n\n\tinitialize: function(options) {\n\t\tL.FeatureGroup.prototype.initialize.call(this);\n\t\tL.Util.setOptions(this, options);\n\t},\n\n\t\n\tonAdd: function(map, insertAtTheBottom) {\n\t\tthis._map = map;\n\t\tthis._insertAtTheBottom = insertAtTheBottom;\n\t\tthis._update('map');\n\t\tmap.on('moveend', this._update, this);\n\t\tthis.fire('add');\n\t},\n\n\tonRemove: function(map) {\n\t\tmap.off('moveend', this._update, this);\n\t\tthis.eachLayer(map.removeLayer, map);\n\t\tthis.fire('remove');\n\t},\n\n\t_load: function(data) {\n\t\tfor (var i = 0; i < data.geonames.length; i++) {\n\t\t\tvar wikiL = data.geonames[i];\n\t\t\tvar icoWikipedia = L.AwesomeMarkers.icon({\n\t\t\t\ticon : 'book',\n\t\t\t\tmarkerColor : 'gray',\n\t\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\t\ticonSize : new L.Point(28, 42),\n\t\t\t\ticonColor : '#000000',\n\t\t\t\tprefix : 'fa'\n\t\t\t});\t\t\t\t\n\t\t\tvar m = new L.Marker([wikiL.lat,wikiL.lng], {icon: icoWikipedia});\n\t\t\tm.bindPopup('<a  href=\"http://'+wikiL.wikipediaUrl+'\" target=\"_new\">'+wikiL.title+'</a><br/>');\n\t\t\tthis.fire('addlayer', {\n\t\t\t\tlayer: m\n\t\t\t});\n\t\t\tthis.addLayer(m);\n\t\t}\n\t\t/*SENSE MAXIM\n\t\tvar ks = [];\n\t\tfor(var key in this._layers)\n\t\t\tks.push(key);\n\t\tfor(var i = 0; i < ks.length-this.options.maxTotal; i++)\n\t\t\tthis.removeLayer(this._layers[ks[i]]);*/\n\t\tthis.fire(\"loaded\");\n\t},\n\n\t_update: function() {\n\t\tvar zoom = this._map.getZoom();\n\t\tvar bounds = this._map.getBounds();\n\t\tvar minll = bounds.getSouthWest();\n\t\tvar maxll = bounds.getNorthEast();\n  \t\t/*if(this._zoom && this._bbox)\n    \t\t\tif(this._zoom == zoom && minll.lng >= this._bbox[0] && minll.lat >= this._bbox[1] && maxll.lng <= this._bbox[2] && maxll.lat <= this._bbox[3])\n      \t\t\t\treturn;*/\n\t\t\n\t\t//Abans de recarregar elimino tots els markers\n\t\tthis.clearLayers();\n\t\t\n  \t\tvar bbox = [];\n  \t\tbbox[0] = minll.lng;\n  \t\tbbox[1] = minll.lat;\n  \t\tbbox[2] = maxll.lng;\n  \t\tbbox[3] = maxll.lat;\n\t\tthis._bbox = bbox;\n\t\tthis._zoom = zoom;\n\t\tvar _this = this;\n\t\t\n\t\tvar language = Cookies.get(\"langCookie\"); \n\t\tif (language == null || language == \"null\") language = 'ca';\n\t\tvar data={\n\t\t\t\tnorth: maxll.lat,\n\t\t\t\tsouth: minll.lat,\n\t\t\t\teast: maxll.lng,\n\t\t\t\twest: minll.lng,\n\t\t\t\tusername: 'geostarters',\n\t\t\t\tlang: language\n\t\t};\n\t\t\n\t\tgetWikipediaLayer(data).then(function(results){\n\t\t\t\t\t_this._load(results);\n\t\t\t},function(results){\n//\t\t\t\tconsole.debug('error getting wikipedia layer:'+results);\n\t\t});\n\t}\n\n});\n","/**\n * Classe propia, layer de twitter\n */\nL.Twitter = L.FeatureGroup.extend({\n\toptions: {\n\t\thashtag: 'Instamapes', \n\t\tgeocode: '41.387,2.168,100' \n\t},\n\n\tinitialize: function(options) {\n\t\tL.FeatureGroup.prototype.initialize.call(this);\n\t\tL.Util.setOptions(this, options);\n\t},\n\n\tonAdd: function(map, insertAtTheBottom) {\n\t\tthis._map = map;\n\t\tthis._insertAtTheBottom = insertAtTheBottom;\n\t\tthis._update('map');\n\t\tmap.on('moveend', this._update, this);\n\t\tthis.fire('add');\n\t},\n\n\tonRemove: function(map) {\n\t\tmap.off('moveend', this._update, this);\n\t\tthis.eachLayer(map.removeLayer, map);\n\t\tthis.fire('remove');\n\t},\t\n\n\t_load: function(data) {\n\t\tfor (var i = 0; i < data.length; i++) {\n\t\t\tvar obj = data[i];\n\t\t\tvar icoTwitter = L.AwesomeMarkers.icon({\n\t\t\t\ticon : 'twitter',\n\t\t\t\tmarkerColor : 'blue',\n\t\t\t\ticonAnchor : new L.Point(14, 42),\n\t\t\t\ticonSize : new L.Point(28, 42),\n\t\t\t\ticonColor : '#000000',\n\t\t\t\tprefix : 'fa'\n\t\t\t});\n\t\t\tvar coord = obj.coord;\n\t\t\tif (coord.indexOf(\"[\") != -1){\n\t\t\t\tcoord = coord.replace(\"[\",\"\");\n\t\t\t\tcoord = coord.replace(\"]\",\"\");\n\t\t\t}\n\t\t\tcoord = coord.split(\",\");\n\t\t\tvar m = new L.Marker([coord[1],coord[0]], {icon: icoTwitter});\n\t\t\tvar text = parseTwitterText(obj.text_message);\n\t\t\tm.bindPopup('<div class=\"twitter_layer_popup\"><a href=\"'+obj.profile_url+'\" target=\"_new\"><img src=\"'+obj.profile_image_url+'\"/></a></div><br><div>'+text+'</div>');\n\t\t\tthis.fire('addlayer', {\n\t\t\t\tlayer: m\n\t\t\t});\n\t\t\tthis.addLayer(m);\t\t\t\n\t\t}\n\t\t\n\t\t/*SENSE MAXIM\n\t\tvar ks = [];\n\t\tfor(var key in this._layers)\n\t\t\tks.push(key);\n\t\tfor(var i = 0; i < ks.length-this.options.maxTotal; i++)\n\t\t\tthis.removeLayer(this._layers[ks[i]]);*/\n\t\tthis.fire(\"loaded\");\n\t},\n\n\t_update: function() {\n\t\tvar zoom = this._map.getZoom();\n\t\tvar bounds = this._map.getBounds();\n\t\tvar minll = bounds.getSouthWest();\n\t\tvar maxll = bounds.getNorthEast();\n  \t\t/*if(this._zoom && this._bbox)\n    \t\t\tif(this._zoom == zoom && minll.lng >= this._bbox[0] && minll.lat >= this._bbox[1] && maxll.lng <= this._bbox[2] && maxll.lat <= this._bbox[3])\n      \t\t\t\treturn;*/\n  \t\t\n\t\t//Abans de recarregar elimino tots els markers\n\t\tthis.clearLayers();  \t\t\n  \t\t\n  \t\tvar bbox = [];\n  \t\tbbox[0] = minll.lng;\n  \t\tbbox[1] = minll.lat;\n  \t\tbbox[2] = maxll.lng;\n  \t\tbbox[3] = maxll.lat;\n\t\tthis._bbox = bbox;\n\t\tthis._zoom = zoom;\n\t\tvar _this = this;\n\t\n\t\tvar data = {\n\t\t\thashtag: this.options.hashtag,\n\t\t\tmapCenter: map.getCenter().lat+','+map.getCenter().lng,\n\t\t\tmapBbox: map.getBounds().toBBoxString()\n\t\t};\n\t\t\n\t\tgetTwitterLayer(data).then(function(results){\n\t\t\tif(results.status==='OK'){\n//\t\t\t\tconsole.debug('twitter ok');\n\t\t\t\t_this._load(results.results);\n\t\t\t}else{\n\t\t\t\tconsole.debug('Error al carregar capa twitter');\n\t\t\t}\t\t\t\t\n\t\t},function(results){\n\t\t\t//$('#modal_login_ko').modal('toggle');\n\t\t\tconsole.debug('Error al carregar capa twitter');\n\t\t});\t\t\t\n\n\t}\n\n});\n\n//function parseTwitterText(ptext){\n//\t\n////\tvar lwords = ptext.split(\" \"); \n//\tvar twitterText = \"\";\n//\t\n//\tfor(var i; i<ptext.lenght; i++){\n//\t\tvar text;\n//\t\tvar word = lwords[index];\n//\t\tif(ptext[i] == \"#\"){\n//\t\t\twhile()\n//\t\t\tword = word.replace(\"#\", \"\");\n//\t\t\ttext = \"<a href=\\\"https://twitter.com/hashtag/\"+word+\"\\\" target=\\\"_blank\\\">#\"+word+\"</a>\";\n//\t\t}else if(word.indexOf(\"@\") == 0){\n//\t\t\t\n//\t\t}else if(word.indexOf(\"http:/\") == 0){\n//\t\t\t\n//\t\t}else{\n//\t\t\ttext = word;\n//\t\t}\n//\t\ttwitterText+=\" \"+text;\n//\t}\n//\t\n//\treturn twitterText;\n//}\n\nfunction parseTwitterText(ptext){\n\t\n\tvar lwords = ptext.split(\" \"); \n\tvar twitterText = \"\";\n\tfor(index in lwords){\n\t\tvar text;\n\t\tvar word = lwords[index];\n\t\tif(word.indexOf(\"#\") == 0){\n\t\t\tword = word.replace(\"#\", \"\");\n\t\t\ttext = \"<a href=\\\"https://twitter.com/hashtag/\"+word+\"\\\" target=\\\"_blank\\\">#\"+word+\"</a>\";\n\t\t}else if(word.indexOf(\"@\") == 0){\n\t\t\tword = word.replace(\"@\", \"\");\n\t\t\ttext = \"<a href=\\\"https://twitter.com/\"+word+\"\\\" target=\\\"_blank\\\">@\"+word+\"</a>\";\t\t\t\n\t\t}else if(word.indexOf(\"http:/\") == 0){\n//\t\t\tword = word.replace(\"http://\", \"\");\n\t\t\ttext = \"<a href=\\\"\"+word+\"\\\" target=\\\"_blank\\\">\"+word.replace(\"http://\", \"\")+\"</a>\";\t\t\t\t\t\n\t\t}else{\n\t\t\ttext = word;\n\t\t}\n\t\ttwitterText+=\" \"+text;\n\t}\n\treturn twitterText;\n}\n","(function (window, document, undefined) {\n\tL.Polyline.include({\n\t    bindLabelEx: function (map,content, options) {\n\t    \tthis._map=map;\n\t      if (!this.label || this.label.options !== options) {\n\t        this.label = new L.Label(options, this);\n\t      }\n\t      this\n\t  \t\t.on('remove', this.hideLabel, this)\n\t  \t\t.on('move', this._moveLabel, this)\n\t  \t\t.on('add', this._onPolylineAdd, this);\n\t      var latlngs = this.getLatLngs();\n\t      var nPoint = latlngs.length;\n\n\t      var lats = [];\n\t      var lngs = [];\n\t      for(var i = 0; i < nPoint; i++) {\n\t        lats.push(latlngs[i].lat);\n\t        lngs.push(latlngs[i].lng);\n\t      }\n\n\t      var minLat = Math.min.apply(null, lats);\n\t      var maxLat = Math.max.apply(null, lats);\n\t      var minLng = Math.min.apply(null, lngs);\n\t      var maxLng = Math.max.apply(null, lngs);\n\n\t      var pointM = {\n\t        lat: (minLat + maxLat) / 2,\n\t        lng: (minLng + maxLng) / 2\n\t      };\n\t      //console.debug(pointM);\n\t      this.label.setContent(content);\n\t      this._showLabelAdded = true;\n\t      this._showLabel({\n\t        latlng: pointM\n\t      });\n\t    },\n\t    unbindLabel: function () {\n\t    \tthis\n\t\t\t.off('remove', this.hideLabel, this)\n\t\t\t.off('move', this._moveLabel, this)\n\t\t\t.off('add', this._onPolylineAdd, this);\n\t    \tif (this.label) {\n\t\t\t\tthis._hideLabel();\n\t\t\t\tthis.label = null;\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\n\t\t\t}\n\t    \t\n\t\t\treturn this;\n\t\t},\n\t    hideLabel: function () {\n\t\t\tif (this.label) {\n\t\t\t\tthis.label.close();\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t_showLabel: function (e) {\n\t\t\tthis.label.setLatLng(e.latlng);\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\n\t\t},\n\t\t_onPolylineAdd: function () {\n\t\t\tif (this._labelNoHide) {\n\t\t\t\tthis._showLabel();\n\t\t\t}\n\t\t}\n\t});\n\n\tL.Polygon.include({\n\t    bindLabelExPolygon: function (map,content, options) {\n\t       this._map=map;\n\t      if (!this.label || this.label.options !== options) {\n\t        this.label = new L.Label(options, this);\n\t      }\n\t  \t this\n\t  \t\t.on('remove', this.hideLabel, this)\n\t  \t\t.on('move', this._moveLabel, this)\n\t  \t\t.on('add', this._onPolygonAdd, this);\n\t     \n\t  \t var pointM = this.getBounds().getCenter();\n\t     \n\t      this.label.setContent(content);\n\t      this._showLabelAdded = true;\n\t      this._showLabel({\n\t        latlng: pointM\n\t      });\n\t    },\n\t    unbindLabel: function () {\n\t    \tthis\n\t\t\t.off('remove', this.hideLabel, this)\n\t\t\t.off('move', this._moveLabel, this)\n\t\t\t.off('add', this._onPolygonAdd, this);\n\t    \tif (this.label) {\n\t\t\t\tthis._hideLabel();\n\t\t\t\tthis.label = null;\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\thideLabel: function () {\n\t\t\tif (this.label) {\n\t\t\t\tthis.label.close();\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t_showLabel: function (e) {\n\t\t\tthis.label.setLatLng(e.latlng);\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\n\t\t},\n\t\t_onPolygonAdd: function () {\n\t\t\tif (this._labelNoHide) {\n\t\t\t\tthis._showLabel();\n\t\t\t}\n\t\t}\n\t  });\n\t\n\tL.MultiPolygon.include({\n\t    bindLabelExPolygon: function (map,content, options) {\n\t       this._map=map;\n\t      if (!this.label || this.label.options !== options) {\n\t        this.label = new L.Label(options, this);\n\t      }\n\t  \t this\n\t  \t\t.on('remove', this.hideLabel, this)\n\t  \t\t.on('move', this._moveLabel, this)\n\t  \t\t.on('add', this._onPolygonAdd, this);\n\t     \n\t  \t var pointM = this.getBounds().getCenter();\n\t     \n\t      this.label.setContent(content);\n\t      this._showLabelAdded = true;\n\t      this._showLabel({\n\t        latlng: pointM\n\t      });\n\t    },\n\t    unbindLabel: function () {\n\t    \tthis\n\t\t\t.off('remove', this.hideLabel, this)\n\t\t\t.off('move', this._moveLabel, this)\n\t\t\t.off('add', this._onPolygonAdd, this);\n\t    \tif (this.label) {\n\t\t\t\tthis._hideLabel();\n\t\t\t\tthis.label = null;\n\t\t\t\tthis._showLabelAdded = false;\t\t\t\t\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\thideLabel: function () {\n\t\t\tif (this.label) {\n\t\t\t\tthis.label.close();\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t_showLabel: function (e) {\n\t\t\tthis.label.setLatLng(e.latlng);\n\t\t\tif (this._map!=null) this._map.showLabel(this.label);\n\t\t},\n\t\t_onPolygonAdd: function () {\n\t\t\tif (this._labelNoHide) {\n\t\t\t\tthis._showLabel();\n\t\t\t}\n\t\t}\n\t  });\n}(window, document));","var HOST_APP = \"http://www.instamaps.cat/\";\nvar GEOCAT02 = \"http://www.instamaps.cat\";\nvar HOST_APP2 = \"http://www.instamaps.cat/\";\nvar HOST_GEOLOCAL = \"http://www.geolocal.cat/\";\nvar proxydir = \"maps\";\nvar tmpdir = \"/opt/geocat/maps/tmp/\";\nvar tmpdirPolling = \"poll/\";\nvar renovarPassword = \"/geocatweb/renovar.html?token=\";\n\nvar urlApp=document.location.href;\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)){\n//\tHOST_APP = \"http://172.70.1.12/\";\n//\tHOST_APP = \"http://localhost:8080/\";\n//\tHOST_APP = \"http://nicosia.icgc.local/\";//Local Jess\n//\tHOST_APP2 = \"http://nicosia.icgc.local/\";\n\tHOST_APP = \"http://localhost/\";//Local Jess\n\tHOST_APP2 = \"http://localhost/\";\n\t\n//\tHOST_APP = \"http://localhost/\";//Local Jess\n//\tGEOCAT02 = \"http://localhost:8181\";\n\tGEOCAT02 = \"http://localhost\";\n\t//GEOCAT02 = \"http://localhost\";\n\thttp://172.70.1.11\n\t//HOST_GEOLOCAL = \"http://localhost/\";\n\tHOST_GEOLOCAL = \"http://geolocaldev.icgc.local/\";\n\tproxydir=\"maps\"; //he creat un director maps al meu Apache\n\t//tmpdir=\"E://temp//\";\n}\n\nvar DOMINI = \"www.instamaps.cat\";\nif(urlApp.indexOf('172.70.1.11')!=-1){\n\tHOST_APP = \"http://172.70.1.11/\";\n\tHOST_APP2 = \"http://172.70.1.11/\";\n//\tHOST_APP = \"http://localhost:8080/\";\n\tGEOCAT02 = \"http://172.70.1.11\";\n\tHOST_GEOLOCAL = \"http://geolocaldev.icgc.local/\";\n\tproxydir=\"maps\"; //he creat un director maps al meu Apache\n}\n\n\n\n\nvar DOMINI = \"www.instamaps.cat\";\n\nvar paramUrl = {\n\tproxy:\"/\"+proxydir+\"/proxy.cgi\",\n\tuploadproxy:\"/\"+proxydir+\"/upload.cgi\",\n\tproxy_download:\"/\"+proxydir+\"/download.cgi\",\n\tproxy_betterWMS:\"/\"+proxydir+\"/proxy_betterWMS.cgi\",\n\tmainPage:\"/index.html\",\n\tloginPage:\"/geocatweb/sessio.html\",\n\tloginGeolocalPage:\"/geocatweb/sessio_geolocal.html\",\n\tmapaPage:\"/geocatweb/mapa.html\",\n\tvisorPage:\"/geocatweb/visor.html\",\n\tvisorCloudifier:\"/geocatweb/visor_cloudifier.html\",\n\tregistrePage:\"/geocatweb/registre.html\",\n\tgaleriaPage:\"/geocatweb/galeria.html\",\n\tperfilPage:\"/geocatweb/perfil.html\",\n\toblidatPage:\"/geocatweb/oblidat.html\",\n\tcomentarisPage:\"http://betaportal.icgc.cat\",\n\twmsOpenData:\"/dadesobertes/wms/service?\",\n\ttmsOpenData:\"/geocatcache/?\",\n\tgetAllMapsByUser: HOST_APP+\"geocat/aplications/map/getAllMapsByUser.action?\",\n\t//getAllPublicsMaps: HOST_APP+\"geocat/aplications/map/getAllPublicsMaps.action?\",\n\tgetAllPublicsMaps: HOST_APP+\"geocat/aplications/map/getAllGaleriaMaps.action?\",\n\tsearchGaleriaMaps: HOST_APP+\"geocat/aplications/map/searchGaleriaMaps.action?\",\n\tgetNumGaleria: HOST_APP+\"geocat/aplications/map/getNumGaleria.action?\",\n\tloadPrivateMapByBusinessId: HOST_APP+\"geocat/aplications/map/loadPrivateMapByBusinessId.action?\",\n\tdeleteMap: HOST_APP+\"geocat/aplications/map/deleteMap.action?\",\n\tresetClauMapa: HOST_APP+\"geocat/aplications/map/resetClauMapa.action?\",\n\tloginUser: HOST_APP+\"geocat/login.action?\",\n\tloginToken: HOST_APP+\"geocat/loginToken.action?\",\n\tloginUserIcgc: HOST_APP+\"geocat/loginIcgc.action?\",\n\tlogoutUser: HOST_APP+\"geocat/logout.action?\",\n\tsigninUser: HOST_APP+\"geocat/registreUser.action?\",\n\tsigninSocial: HOST_APP+\"geocat/social/createUser.action?\",\n\tsocialAuth: HOST_APP+\"geocat/social/auth.action?\",\n\tvalidateUsername: HOST_APP+\"geocat/validateUid?\",\n\tvalidateEmail: HOST_APP+\"geocat/validateEmail?\",\n\tgetUser: HOST_APP+\"geocat/user/getUser.action?\",\n\tgetUserSimple: HOST_APP+\"geocat/user/getUserSimple.action?\",\n\tupdateUser: HOST_APP+\"geocat/user/updateUser.action?\",\n\tdeleteUser: HOST_APP+\"geocat/user/deleteUser.action?\",\n\tupdatePassword: HOST_APP+\"geocat/user/updatePassword.action?\",\n\tcreateTematicLayerFeature: HOST_APP+\"geocat/layers/tematic/createTematicLayerFeature.action?\",\n\tdragFile: HOST_APP+\"share/jsp/upload.jsp?\",\n\tcreateRang: HOST_APP+\"geocat/layers/tematic/createRang.action?\",\n\tcreateData: HOST_APP+\"geocat/layers/data/createData.action?\",\n\tcreateFeature: HOST_APP+\"geocat/layers/feature/createFeature.action?\",\n\tgetTematicLayerByBusinessId:HOST_APP+\"geocat/layers/tematic/getTematicLayerByBusinessId.action?\",\n\tgetCacheVisualitzacioLayerByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getCacheVisualitzacioLayerByBusinessId.action?\",\n\tdadesObertes:GEOCAT02+\"/share/jsp/dadesObertes.jsp?\",\n\turlFile:GEOCAT02+\"/share/jsp/urlFile.jsp?\",\n\turlFileProves:GEOCAT02+\"/share/jsp/urlFileProves.jsp?\",\n\turlFileNoDin:GEOCAT02+\"/share/jsp/urlFileNoDin.jsp?\",\n\turlFileDin:GEOCAT02+\"/share/jsp/urlFileDin.jsp?\",\n\t//getMapById: HOST_APP+\"geocat/aplications/map/getMapById.action?\",\n\tgetMapByBusinessId: HOST_APP+\"geocat/aplications/map/getMapByBusinessId.action?\",\n\tupdateMap: HOST_APP+\"geocat/aplications/map/updateMap.action?\",\n\tcreateMap: HOST_APP+\"geocat/aplications/map/createMap.action?\",\n\tgetAllServidorsWMSByUser: HOST_APP+\"geocat/layers/servidor/wms/getAllServidorsWMSByUser.action?\",\n\taddServerToMap: HOST_APP+\"geocat/aplications/map/addServerToMap.action?\",\n\tgetAllTematicLayerByUid: HOST_APP+\"geocat/layers/tematic/getAllTematicLayerByUid.action?\",\n\tdeleteTematicLayerAll: HOST_APP+\"geocat/layers/tematic/deleteTematicLayerAll.action?\",\n\tupdateMap: HOST_APP+\"geocat/aplications/map/updateMap.action?\",\n\tgetTwitterLayer: HOST_APP+\"geocat/layers/getTwitterLayer.action?\",\n\tupdateServersOrderToMap: HOST_APP+\"geocat/aplications/map/updateServersOrderToMap.action?\",\n\tupdateServerOrderToMap: HOST_APP+\"geocat/aplications/map/updateServerOrderToMap.action?\",\n\tupdateMapName: HOST_APP+\"geocat/aplications/map/updateMapName.action?\",\n\tremoveServerToMap: HOST_APP+\"geocat/aplications/map/removeServerToMap.action?\",\n\tdeleteServerRemoved: HOST_APP+\"geocat/aplications/map/deleteServerRemoved.action?\",\n\tupdateServidorWMSName: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSName.action?\",\n\t\n\t\n\t//nous updates\n\tupdateServidorWMSOptions: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSOptions.action?\",\t\n\tupdateServidorWMSGroup: HOST_APP+\"geocat/aplications/map/updateServidorWMSGroup.action?\",\n\tupdateServidorWMSOpacity: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMSOpacity.action?\",\n\t\n\t\n\taddServerToMap: HOST_APP+\"geocat/aplications/map/addServerToMap.action?\",\n\tcreateServidorInMap: HOST_APP+\"geocat/layers/servidor/wms/createServidorInMap.action?\",\n\treadFile: HOST_APP+\"geocat/upload/readFile.action?\",\n\tuploadFile:  HOST_APP+\"geocat/upload/uploadFile.action?\",\n\turlGeoCoder:\"http://www.icc.cat/geocodificador/json?maxresultats=10&obtenirCoordGeografiques=si&metode=localitzaToponim&ordre=alfabetic&trobaTots=no&nom={s}&\",\n\tows2json:GEOCAT02+\"/share/jsp/ows2json.jsp?\",\n\tjson2jsonp:HOST_APP+\"share/jsp/json2jsonp.jsp?\",\n\tgetDownloadLayer:GEOCAT02+\"/share/jsp/download_layer.jsp?\",\n\tdeleteServidorWMS: HOST_APP+\"geocat/layers/servidor/wms/deleteServidorWMS.action?\",\n\taddFeatureToTematic: HOST_APP+\"geocat/layers/tematic/addFeatureToTematic.action?\",\n\tcreateTematicLayerEmpty: HOST_APP+\"geocat/layers/tematic/createTematicLayerEmpty.action?\",\n\tmoveFeatureToTematic: HOST_APP+\"geocat/layers/tematic/moveFeatureToTematic.action?\",\n\tdeleteFeature: HOST_APP+\"geocat/layers/feature/deleteFeature.action?\",\n\tupdateFeature: HOST_APP+\"geocat/layers/feature/updateFeature.action?\",\n\tshortUrl : \"https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDUUud-qayDcS4jmAUpr2PPjxHxu_qVbk0\",\n\tgetWikipediaLayer: \"http://api.geonames.org/wikipediaBoundingBoxJSON?\",\n\tupdateTematicRangs: HOST_APP+\"geocat/layers/tematic/updateTematicRangs.action\",\n\tcreateRandomUser: HOST_APP+\"geocat/createRandomUser.action?\",\n\tupdateServidorWMS: HOST_APP+\"geocat/layers/servidor/wms/updateServidorWMS.action?\",\n\tdeleteRandomUser: HOST_APP+\"geocat/deleteRandomUser.action?\",\n\tduplicateTematicLayer: HOST_APP+\"geocat/layers/tematic/duplicateTematicLayer.action?\",\n\treminderMail: HOST_APP+\"geocat/user/reminderMail.action?\",\n\trenewPassword: HOST_APP+\"geocat/user/renewPassword.action?\",\n\tgetNumEntitatsActives: HOST_APP+\"geocat/stats/getNumEntitatsActives.action?\",\n\tgetNumMapes: HOST_APP+\"geocat/stats/getNumMapes.action?\",\n\tgetNumCapes: HOST_APP+\"geocat/stats/getNumCapes.action?\",\n\tdownload_layer: HOST_APP+\"share/jsp/download_layer.jsp?\",\n\tupload_gdal: HOST_APP+\"share/jsp/upload_gdal.jsp?\",\n\tupload_gdal_nou: HOST_APP+\"share/jsp/upload_gdal_nou.jsp?\",\n\tupload_gdal_2015: HOST_APP+\"share/jsp/upload_gdal_2015.jsp?\",\n\tpolling: HOST_APP+\"share/jsp/polling.jsp?\",\t\n\tpublicarCapesMapa: HOST_APP+\"geocat/aplications/map/publicarCapesMapa.action?\",\n\tpresidentJSON: \"http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json\",\n\tdeleteUser: HOST_APP+\"geocat/user/deleteUser.action?\",\n\tgetUserSimple: HOST_APP+\"geocat/user/getUserSimple.action?\",\n\tpublicarMapConfig: HOST_APP+\"geocat/aplications/map/publicarMapConfig.action?\",\n\tgetCacheMapByBusinessId: HOST_APP+\"geocat/aplications/map/getCacheMapByBusinessId.action?\",\n\turluploadBase64:\"/share/jsp/uploadBase64.jsp?\",\n\turlgetMapImage:\"/share/jsp/getMapImage.jsp?\",\n\turlgetImageProxy:\"/share/jsp/getImageProxy.jsp?\",\n\t\n\turlMapToWMS:\"/share/jsp/getMapToWMS.jsp?\",\n\t\n\tupdatePasswordIcgc: HOST_APP+\"geocat/user/updatePasswordIcgc.action?\",\n\tsigninUserIcgc: HOST_APP+\"geocat/registreUserIcgc.action?\",\n\tsigninInstamaper: HOST_APP+\"geocat/registreInstamaper.action?\",\n\tupdateMapVisibility: HOST_APP+\"geocat/aplications/map/updateVisibility.action?\",\n\tsendMail: HOST_APP+\"geocat/mail/sendMail.action?\",\n\tgetEntitatsAplicacioRolByUidColaborador:  HOST_APP+\"geocat/entitatAplicacio/getEntitatsAplicacioRolByUidColaborador.action?\",\n\tgetEntitatsColaboradorsByAplicacio:  HOST_APP+\"geocat/entitatAplicacio/getAllEntitatsColaboradorsByAplicacio.action?\",\n\tgetConvidatsByBusinessId: HOST_APP+\"geocat/aplications/map/getConvidatsByBusinessId.action?\",\n\tdeleteConvidatByBusinessId: HOST_APP+\"geocat/aplications/map/deleteConvidatByBusinessId.action?\",\n\tupdateGeometria: HOST_APP+\"geocat/layers/geometriesColleccio/updateGeometria.action?\",\n\tcreateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioLayer.action?\",\n\tupdateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/updateVisualitzacioLayer.action?\",\n\tupdateNameVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/updateNameVisualitzacioLayer.action?\",\n\tgetVisualitzacioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getVisualitzacioByBusinessId.action?\",\n\tgetAllVisualitzacioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getAllVisualitzacioByBusinessId?\",\n\tgetAllVisualitzacioLayerByUid: HOST_APP+\"geocat/layers/visualitzacio/getAllVisualitzacioLayerByUid.action?\",\n\taddGeometriaToVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToVisualitzacio.action?\",\n\tmoveGeometriaToVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/moveGeometriaToVisualitzacio.action?\",\n\tduplicateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/duplicateVisualitzacioLayer.action?\",\n\tdeleteVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/deleteVisualitzacioLayer.action?\",\n\tdeleteVisualitzacioLayerAll: HOST_APP+\"geocat/layers/visualitzacio/deleteVisualitzacioLayerAll.action?\",\n\tcreateEstil: HOST_APP+\"geocat/layers/visualitzacio/createEstil.action?\",\n\tupdateEstil: HOST_APP+\"geocat/layers/visualitzacio/updateEstil.action?\",\n\tdeleteEstil: HOST_APP+\"geocat/layers/visualitzacio/deleteEstil.action?\",\n\taddGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToEstil.action?\",\n\tremoveGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaToEstil.action?\",\n\tmoveGeometriaToEstil: HOST_APP+\"geocat/layers/visualitzacio/moveGeometriaToEstil.action?\",\n\tmodificarEstiloGeometria: HOST_APP+\"geocat/layers/visualitzacio/modificarEstiloGeometria.action?\",\n\tremoveGeometriaFromVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaFromVisualitzacio.action?\",\n\tcreateVisualitzacioSimple: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioSimple.action?\",\n\tcreateVisualitzacioTematica: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioTematica.action?\",\n\tcreateVisualitzacioHeatCluster: HOST_APP+\"geocat/layers/visualitzacio/createVisualitzacioHeatCluster.action?\",\n\tgetGeometriesColleccioByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getGeometriesColleccioByBusinessId.action?\",\n\tgetGeometriesPropertiesLayer: HOST_APP+\"geocat/layers/visualitzacio/getGeometriesPropertiesLayer.action?\",\n\tremoveGeometriaFromProperties: HOST_APP+\"geocat/layers/visualitzacio/removeGeometriaFromProperties.action?\",\n\tupdateGeometriaProperties: HOST_APP+\"geocat/layers/geometriesColleccio/updateGeometriaProperties.action?\",\n\tupdateRankAplicacio: HOST_APP+\"geocat/aplications/map/updateRankAplicacio.action?\",\n\tcreateMapFile:  HOST_APP+\"geocat/layers/visualitzacio/createMapFile.action?\",\n\tsearchAction: HOST_APP+\"geocat/aplications/map/search.action?\",\n\tbuffer: HOST_APP+\"geocat/aplications/map/buffer.action?\",\n\tcentroid: HOST_APP+\"geocat/aplications/map/centroid.action?\",\n\tintersection: HOST_APP+\"geocat/aplications/map/intersection.action?\",\n\tunion: HOST_APP+\"geocat/aplications/map/union.action?\",\n\ttag: HOST_APP+\"geocat/aplications/map/tag.action?\",\n\tunionLayers: HOST_APP+\"geocat/aplications/map/unionLayers.action?\",\n\tgetVisualitzacioSimpleByBusinessId: HOST_APP+\"geocat/layers/visualitzacio/getVisualitzacioSimpleByBusinessId.action?\",\n\tfilterVisualitzacio: HOST_APP+\"geocat/layers/visualitzacio/filterVisualitzacio.action?\",\n\tcrearFitxerPolling: HOST_APP+\"/geocat/aplications/map/crearFitxerPolling.action?\",\n\tfilter: HOST_APP+\"geocat/aplications/map/filter.action?\",\n\tcallActions:\"/share/jsp/callActions.jsp?\",\n\t//loadAplicacionsUser: \"/geocatweb/dades/aplicacions_geolocal.json\",\n\tgetConfiguradesUser: HOST_GEOLOCAL+\"PRG/eines/getConfiguradesUser.action?\",\n\tprgIncasol: HOST_GEOLOCAL,\n\tcreateToken: HOST_APP +\"/geocat/createToken.action?\",\n\tuploadLogo: HOST_APP +\"share/jsp/uploadLogo.jsp?\",\n\tgetValuesFromKeysProperty: HOST_APP +\"geocat/aplications/map/getValuesFromKeysProperty.action?\",\n\tcolumnJoin: HOST_APP +\"geocat/aplications/map/columnJoin.action?\",\n\tspatialJoin: HOST_APP +\"geocat/aplications/map/spatialJoin.action?\",\n\tsearchCapesPubliques: HOST_APP+\"geocat/aplications/map/searchCapesPubliques.action?\",\n\taddServerDuplicateToMap: HOST_APP+\"geocat/aplications/map/addServerDuplicateToMap.action?\",\n\tduplicateVisualitzacioLayer: HOST_APP+\"geocat/layers/visualitzacio/duplicateVisualitzacioLayer.action?\",\n\tsearchCatalegIdec: HOST_APP+\"geocat/aplications/map/searchCatalegIdec.action?\",\n\tsearchGaleriaMapsByUser: HOST_APP+\"geocat/aplications/map/searchGaleriaMapsByUser.action?\",\n\teacat: \"https://idp.eacat.net/Logon.aspx?providerID=IDEC\",\n\turl_mapserver:HOST_APP+\"/geoservicelocal/\",\n\taddGeometriaToVisualitzacioTematic: HOST_APP+\"geocat/layers/visualitzacio/addGeometriaToVisualitzacioTematic.action?\",\n\tduplicateMap: HOST_APP+\"geocat/aplications/map/duplicateMap.action?\",\n\t//urlgetInspireCatalog:HOST_APP +\"/share/jsp/getInspireCatalog.jsp?\",\n\turlgetInspireCatalog:\"http://inspire-geoportal.ec.europa.eu/solr/select?\",\n\turlJsonPCC:\"/geocatweb/dades/pcc.json\",\n\tdesbloquejarMapa: HOST_APP+\"/geocat/aplications/map/desbloquejar.action?\",\n\tcrearFitxerSocrata:  HOST_APP+\"geocat/upload/crearFitxerSocrata.action?\",\n\tgenerateTokenRemember: HOST_APP+\"geocat/user/generateTokenRemember.action?\"\n\t\n}\n\nvar paramAplications = {\n\t'pcivil':{\n\t\t\"nom\":\"Protecció civil\",\n\t\t\"description\":\"Gestiona la informació relativa a Protecció civil per augmentar la seguretat dels ciutadans. Identifica els punts d'actuació prioritària en cas d'una emergència.\",\n\t\t\"img\":\"img/thumb_ed_pcivil.png\",\n\t\t\"url\":HOST_GEOLOCAL+\"geoLocal/crearAplicacionEditorPcivil.jsp?codiUsuari=\"\n\t},\n    'infoparcela':{\n    \t\"nom\":\"InfoParcela\",\n    \t\"description\":\"Permet realitzar un document amb informació referent a la parcel·la.\",\n    \t\"img\":\"img/thumb_ed_infoparcela.png\",\n    \t\"url\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela.action?fallback=infoparcela&codiUsuari=\",\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela/eliminar_geolocal.action?businessId=\",\n    \t\"editor\":HOST_GEOLOCAL+\"PRG/aplicacions/infoparcela/modificar.action?businessId=\" \n    },\n    'peolics':{\n    \t\"nom\":\"Editor de Parcs Eòlics\",\n    \t\"description\":\"Actualitza la informació dels parcs eòlics. Col·labora mantenint la informació.\",\n    \t\"img\":\"img/thumb_ed_peolics.png\",\n    \t\"url\":HOST_GEOLOCAL+\"geoLocal/crearAplicacionEditorParcsEolics.jsp?codiUsuari=\"\n    },\n    'carrerer':{\n    \t\"nom\":\"Gestor de canvis carrerer\",\n    \t\"description\":\"Gestiona els canvis del carrerer. Ajuda a mantenir la base de carrers de l'ICGC.\",\n    \t\"img\":\"img/thumb_ed_carrerer.png\",\n    \t\"url\":HOST_GEOLOCAL+\"EdCarrerer/editorCarrerer.action?codiUsuari=\"\n    },\n    'incasol':{\n    \t\"nom\":\"Visors INCASÒL\",\n    \t\"description\":\"Ja pots tenir un visor de mapes a la teva web!. Crea els teus propis visors personalitzats i afegeix-hi la teva cartografia.\",\n    \t\"img\":\"img/thumb_ed_incasol.png\",\n    \t\"url\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol.action?\",\n    \t\"editor\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol/modificar.action?businessId=\",\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/incasol/eliminar_geolocal.action?businessId=\"\n    },\n    'atles':{\n    \t\"eliminar\":HOST_GEOLOCAL+\"PRG/aplicacions/atles/eliminar_geolocal.action?businessId=\"\n    }\n};\n\nvar perfilConfig = {\n\t\"0\":[paramAplications.pcivil, paramAplications.infoparcela, paramAplications.peolics, paramAplications.carrerer, paramAplications.incasol],\n\t\"1\":[],\n\t\"2\":[paramAplications.pcivil, paramAplications.infoparcela, paramAplications.carrerer],\n\t\"3\":[paramAplications.pcivil],\n\t\"4\":[],\n\t\"5\":[],\n\t\"6\":[],\n\t\"7\":[paramAplications.peolics],\n\t\"8\":[paramAplications.incasol],\n\t\"9\":[paramAplications.pcivil]\n};\n\n$( document ).ajaxSend(function( event, jqxhr, settings ) {\n\t//$('.waiting_animation').show();\n\tif (typeof map !== 'undefined'){\n\t\ttry {map.spin(true);} catch (Err) {}\n\t\t\n\t}\n});\n\n$( document ).ajaxComplete(function( event, jqxhr, settings ) {\n\tif (typeof map !== 'undefined'){\n\t\ttry {map.spin(false);} catch (Err) {}\n\t}\n\tif (jqxhr.responseJSON){\n\t\tif (jqxhr.responseJSON.status == \"ERROR\" && jqxhr.responseJSON.results == \"expired\"){\n\t\t\tsessionExpired();\n\t\t}\n\t}\n});\n\n$( document ).ajaxStop(function() {\n\t//$('.waiting_animation').hide();\n\tif (typeof map !== 'undefined'){\n\t\ttry {map.spin(false);} catch (Err) {\n\t\t\t//console.error(Err);\n\t\t}\n\t}\n\tsetTimeout(function(){\n\t\ttry {map.spin(false);} catch (Err) {\n\t\t\t//console.error(Err);\n\t\t}\n\t},10000);\n});\n","//Global vars\nvar map, controlCapes, hashControl;\nvar mapConfig = {};\n\nvar factorH = 50;\nvar factorW = 0;\n\nvar capaUsrPunt, capaUsrLine, capaUsrPol,capaUsrActiva;\n\nvar initMevesDades = false;\nvar download_layer;\nvar lsublayers = [];\nvar tipus_user;\n\n//Arrays control elements repetits a la llegenda\nvar controlLegendPoint = [];//Boles\nvar controlLegendMarker = [];//Pintxos\nvar controlLegendLine = [];\nvar controlLegendPol = [];\nvar mapLegend = {};\nvar downloadableData = {};\nvar _UsrID;\n\nvar dades1;\n\n\n//Contants del mapa 3D\nvar estatMapa3D=false;\n\n//Evitem error javascript a les pagines html que no carreguen la llibreria de leaflet\nif((urlApp.indexOf('mapa')!=-1)||(urlApp.indexOf('visor')!=-1)){\n//default geometries style\nvar estilP={\n\t\ticon : '',\n\t\ticonFons:'awesome-marker-web awesome-marker-icon-orange',\n\t\ticonGlif:'fa fa-',\n\t\tcolorGlif:'#333333',\n\t\tfontsize:'14px',\n\t\tsize:'28'\n\t};\n\nvar default_line_style = {\n\t    weight: 3,\n\t    color: '#FFC400',\n\t    opacity:1,\n\t    dashArray: '3',\n\t    lineCap:'round',\n\t    lineJoin:'round'\n\t};\n\nvar default_area_style = {\n\t    weight: 3,\n\t    opacity: 1,\n\t    color: '#FFC400',\n\t    dashArray: '3',\n\t    fillColor: \"rgb(255,196,0)\",//hexToRgb('#FFC400'),\n\t    borderColor: '#FFC400',\n\t    borderWidth: '3',\n\t    fillOpacity: 0.5\n\t};\n\nvar default_marker_style = {\n\t\ticon : '',\n\t\tmarkerColor : 'orange',\n\t\tdivColor:'transparent',\n\t\ticonAnchor : new L.Point(14, 42),\n\t\ticonSize : new L.Point(28, 42),\n\t\ticonColor : '#000000',\n\t\tprefix : 'fa',\n\t\tisCanvas:false,\n\t\tradius:6,\n\t\topacity:1,\n\t\tweight : 2,\n\t\tfillOpacity : 0.9,\n\t\tcolor : \"#ffffff\",\n\t\tfillColor :\"transparent\"\n\t};\n\nvar default_circulo_style = {\n\t\tisCanvas:true,\n\t\tsimbolSize: 6,\n\t\tborderWidth: 2,\n\t\topacity: 90,\n\t\tborderColor : \"#ffffff\",\n\t\tcolor :\"#FFC500\",\n\t\tlineWidth: 3,\n\t};\n\nvar default_circuloglyphon_style = {\n\t\ticon : '',\n\t\tmarkerColor: 'punt_r',\n\t\tprefix : 'fa',\n\t\tdivColor:'transparent',\n\t\ticonAnchor : new L.Point(15, 15),\n\t\ticonSize : new L.Point(30, 30),\n\t\ticonColor : '#000000',\n\t\tisCanvas:false,\n\t\tradius:6,\n\t\topacity:1,\n\t\tweight : 2,\n\t\tfillOpacity : 0.9,\n\t\tcolor : \"#ffffff\",\n\t\tfillColor :\"#FFC500\"\n\t};\n\nvar default_onsoc_style = {\n\t\ticon : '',\n\t\tmarkerColor : 'red',\n\t\tdivColor:'transparent',\n\t\ticonAnchor : new L.Point(14, 42),\n\t\ticonSize : new L.Point(28, 42),\n\t\ticonColor : '#000000',\n\t\tprefix : 'fa',\n\t\tisCanvas:false,\n\t\tradius:6,\n\t\topacity:1,\n\t\tweight : 2,\n\t\tfillOpacity : 0.9,\n\t\tcolor : \"#ffffff\",\n\t\tfillColor :\"transparent\"\n\t};\n}\n\n//constants\nvar t_geojsonvt = \"geojsonvt\";\nvar t_dades_obertes = \"dades obertes\";\nvar t_wms = \"wms\";\nvar t_json = \"json\";\nvar t_xarxes_socials = \"xarxes socials\";\nvar t_tematic = \"tematic\";\nvar t_visualitzacio = \"visualitzacio\";\nvar t_url_file = \"url_file\";\nvar t_vis_wms = \"vis_wms\";\nvar t_vis_wms_noedit = \"vis_wms_noeditable\";\n\n/**tipus estandar instamaps**/\nvar t_polyline = \"polyline\";\nvar t_polygon = \"polygon\";\nvar t_marker = \"marker\";\n/************************/\n\nvar t_multiple = \"multiple\";\nvar t_point = \"point\";\nvar t_multipoint = \"multipoint\";\nvar t_linestring = \"linestring\";\nvar t_multilinestring = \"multilinestring\";\nvar t_multipolygon = \"multipolygon\";\nvar t_heatmap = \"heatmap\";\nvar t_cluster = \"cluster\";\nvar t_size = \"size\";\nvar tem_origen = \"origenTematic\";\nvar tem_simple = \"simpleTematic\";\nvar tem_clasic = \"clasicTematic\";\nvar tem_size = \"sizeTematic\";\nvar tem_heatmap = \"heatmapTematic\";\nvar tem_cluster = \"clusterTematic\";\nvar tem_heatmap_wms = \"heatmapTematic_wms\";\nvar tem_cluster_wms = \"clusterTematic_wms\";\nvar from_creaPopup = \"creaPopup\";\nvar from_creaCapa = \"creaCapa\";\nvar visibilitat_open = 'O';\nvar visibilitat_privat = 'P';\n\nvar t_file_csv = \".csv\";\nvar t_file_txt = \".txt\";\nvar t_file_gpx = \".gpx\";\nvar t_file_kml = \".kml\";\nvar t_file_gml = \".gml\";\nvar t_file_wkt = \".wkt\";\nvar t_file_json = \".json\";\nvar t_file_geojson = \".geojson\";\nvar t_file_topojson = \".topojson\";\nvar t_file_shp = \".shp\";\nvar t_file_dxf = \".dxf\";\nvar t_file_dgn = \".dgn\";\nvar t_file_xls = \".xls\";\nvar t_file_xlsx = \".xlsx\";\n\nvar t_user_loginat = '1#';\nvar t_user_random = '0#';\n\nvar num_max_pintxos = 250;\nvar capesOrdre_sublayer = \"sublayer\";//10000;\n\nvar msg_noguarda = \"Per publicar o compartir el mapa has d'iniciar sessió\";\n\nvar CAPTURA_MAPA = \"captura_mapa\";\nvar CAPTURA_GALERIA = \"captura_galeria\";\nvar CAPTURA_INFORME = \"captura_informe\";\nvar CAPTURA_FONS = \"captura_fons\";\nvar CAPTURA_GEOPDF = \"captura_geopdf\";\nvar CAPTURA_MAPA_GEOTIFF=\"captura_mapa_geotiff\";\nvar CAPTURA_MAPA_GEOPACKAGE=\"captura_mapa_geopackage\";\nvar NODATA_VALUE = \"nodata\";\nvar NODATA_COLOR = \"#CCCCCC\";\nvar NODATA_MIDA = 10;\n\nvar TIPUS_APLIACIO_INSTAMAPS = 1;\nvar TIPUS_APLIACIO_GEOLOCAL = 2;\nvar TIPUS_APLIACIO_AOC = 3;\n\n//VAR per nou model de dades\nvar nou_model = true;\n\nvar instamaps_email = \"instamapes@icgc.cat\";\n//var curs_instamaps = \"1er curs InstaMaps\";\n//var curs_instamaps = \"2n curs InstaMaps\";\n//var curs_instamaps = \"3r curs InstaMaps\";\n//var curs_instamaps = \"4rt curs InstaMaps\";\nvar curs_instamaps = \"5e curs InstaMaps\";\n\n\n//Llistat exemples de dades externes\nvar llista_dadesExternes = {\n\t\t\"dadesExternes\" : [\n\n\t\t\t\t{\n\t                \"titol\" : \"Actes president.cat\",\n\t                \"ORGANITZAC\" : \"president.cat\",\n\t                \"urlOrganitzacio\" : \"http://www.president.cat\",\n\t                \"urlDadesExternes\" : \"http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json?\"\n\t\t\t\t},\n   \t\t\t\t{\n\t                \"titol\" : \"Plaques Tectòniques\",\n\t                \"ORGANITZAC\" : \"earthquake.usgs.gov\",\n\t                \"urlOrganitzacio\" : \"http://earthquake.usgs.gov\",\n\t                \"urlDadesExternes\" : \"http://earthquake.usgs.gov/learn/plate-boundaries.kmz\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_kml,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t},\n\n\n\t\t\t\t{\n\t\t\t\t\t\"titol\" : \"Ciutats del món\",\n\t\t\t\t\t\"ORGANITZAC\" : \"Wikipedia\",\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://en.wikipedia.org/wiki/List_of_cities_by_longitude\",\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/mahemoff/geodata/master/cities.geojson\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"titol\" : \"Països del món\",\n\t\t\t\t\t\"ORGANITZAC\" : \"Wikimedia Foundation\",\n\t\t\t\t\t\"urlOrganitzacio\" : \"https://github.com/wikimedia\",\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/wikimedia/limn-data/master/geo/maps/world-countries.json\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"titol\" : \"Huracans a l'Atlàntic al 2004\",\n\t\t\t\t\t\"ORGANITZAC\" : \"Unisys weather\",\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://weather.unisys.com/hurricane/atlantic/2004H/index.html\",\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/colemanm/hurricanes/master/fl_2004_hurricanes.geojson\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t},\n\n\t\t\t\t{//https://github.com/FCC/lpfmpoints\n\t\t\t\t\t\"titol\" : \"U.S. Low Power FM station\",\n\t\t\t\t\t\"ORGANITZAC\" : \"LPFM\",\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://www.fcc.gov/encyclopedia/low-power-fm-broadcast-radio-stations-lpfm\",\n\t\t\t\t\t\"urlDadesExternes\" : \"https://raw.githubusercontent.com/FCC/lpfmpoints/gh-pages/data/lpfm_points.geojson\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_geojson,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t},\n\n\t\t\t\t{\n\t\t\t\t\t\"titol\" : \"Camí de Sant Jaume\",\n\t\t\t\t\t\"ORGANITZAC\" : \"Gencat\",\n\t\t\t\t\t\"urlOrganitzacio\" : \"http://www.gencat.cat/\",\n\t\t\t\t\t\"urlDadesExternes\" : \"http://www.gencat.cat/opendata/recursos/rutes/cami_de_sant_jaume.kml\",\n\t\t\t\t\t\"formatDadesExternes\": t_file_kml,\n\t\t\t\t\t\"epsgDadesExternes\":\"EPSG:4326\"\n\t\t\t\t}\n\t\t]\n};\n\nvar TIPUS_ENTITATS_GEOLOCAL = [2,3,4,5,6,7,8,9];\nvar TIPUS_ADMIN = 0;\nvar TIPUS_INSTAMAPS = 1;\nvar TIPUS_AOC = 10;\n\nvar guideLayers = new Array();\n","runningActions = [];\n\nfunction actionCompleted(jqXHR, status) {\n\t//Remove the completed action from the running actions\n\tvar index = runningActions.indexOf(jqXHR);\n\trunningActions.splice(index, 1);\n}\n\nfunction loadPublicGaleria(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getAllPublicsMaps,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction loadNumGaleria(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getNumGaleria,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\nfunction searchGaleriaMaps(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.searchGaleriaMaps,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction searchGaleriaMapsByUser(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.searchGaleriaMapsByUser,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteMap,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* registre.html */\n\nfunction registerUser(url, dataUrl){\n\tvar xhr = jQuery.ajax({\n\t\turl: url,\n\t\tdata: dataUrl,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\t\t\n}\n\nfunction checkUsername(username){\n\t  var xhr = jQuery.ajax({\n\t\t\turl: paramUrl.validateUsername,\n\t\t\tdata: {uid:username},\n\t\t\tmethod: 'post',\n\t\t\tdataType: 'jsonp',\n\t\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction checkEmail(user_email){\n\t  var xhr = jQuery.ajax({\n\t\t\turl: paramUrl.validateEmail,\n\t\t\tdata: {email: user_email},\n\t\t\tmethod: 'post',\n\t\t\tdataType: 'jsonp',\n\t\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* galeria.html */\n\n//solo galeria privada de geolocal para obtener las aplicaciones\nfunction getUserData(username){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getUserSimple,\n\t\tdata: {uid : username},\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* comuns */\nfunction doLogout(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.logoutUser,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* sessio.html */\n\nfunction doLogin(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.loginUser,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction doLoginIcgc(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.loginUserIcgc,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction loginToken(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.loginToken,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* map */\nfunction createTematicLayerFeature(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.createTematicLayerFeature,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction addFeatureToTematic(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.addFeatureToTematic,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getTematicLayerByBusinessId(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.getTematicLayerByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getCacheVisualitzacioLayerByBusinessId(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.getCacheVisualitzacioLayerByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createFeature(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.createFeature,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createData(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.createData,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createRang(data){\n\tvar xhr = $.ajax({\n\t\turl: paramUrl.createRang,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getLListaDadesObertes(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.dadesObertes,\n\t\tdata: {metode:'getDatasets'},\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getMapByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getMapByBusinessId,\n\t\t//url: paramUrl.getMapById,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getCacheMapByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getCacheMapByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/*//Local\nfunction updateMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}*/\n\nfunction updateMap(data){\n\tvar xhr = jQuery.ajax({\n//\t\turl: paramUrl.proxy + \"?url=\" + paramUrl.updateMap + \"&uid=\"+data.uid,\n\t\turl: paramUrl.updateMap,\n\t\tdata: data,\n\t\tmethod: 'POST',\n//\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getAllServidorsWMSByUser(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getAllServidorsWMSByUser,\n\t\tdata: data,\n\t\tmethod: 'POST',\n//\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction addServerToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.addServerToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getAllTematicLayerByUid(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getAllTematicLayerByUid,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteTematicLayerAll(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteTematicLayerAll,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction doUpdateMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateServersOrderToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServersOrderToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\nfunction updateServerOrderToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServerOrderToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateMapName(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateMapName,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getTwitterLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getTwitterLayer,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction removeServerToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.removeServerToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteServerRemoved(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteServerRemoved,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateServidorWMSName(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServidorWMSName,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\nfunction updateServidorWMSOptions(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServidorWMSOptions,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateServidorWMSGroup(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServidorWMSGroup,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateServidorWMSOpacity(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServidorWMSOpacity,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\n\nfunction addServerToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.addServerToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createServidorInMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createServidorInMap,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getWikipediaLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getWikipediaLayer,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction shortUrl(url){\n    var xhr = jQuery.ajax({\n    \turl: paramUrl.shortUrl,\n        contentType: \"application/json; charset=utf-8\",\n        method: 'POST',\n        data: JSON.stringify({longUrl: url}),\n        dataType: 'json',\n    \tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction doReadFile(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.readFile,\n\t\tdata: data,\n\t\t//async: false,\n\t\t//method: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction doUploadFile(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.uploadFile,\n\t\tdata: data,\n\t\t//async: false,\n\t\t//method: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getDownloadLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\t//url: paramUrl.proxy_download,\n\t\turl: paramUrl.download_layer,\n\t\tdata: data,\n\t\ttype: \"POST\",\n//\t\tdataType: 'html'\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteServidorWMS(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteServidorWMS,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createTematicLayerEmpty(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createTematicLayerEmpty,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction moveFeatureToTematic(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.moveFeatureToTematic,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteFeature(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteFeature,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateFeature(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateFeature,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateTematicRangs(data){\n    var xhr = jQuery.ajax({\n    \t//url: paramUrl.proxy + \"?url=\" + paramUrl.updateTematicRangs + \"&uid=\"+data.uid,\n        url: paramUrl.updateTematicRangs,\n        data: data,\n        method: 'post',\n    \tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createRandomUser(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createRandomUser,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteRandomUser(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteRandomUser,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getJSONPServei(url){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.json2jsonp,\n\t\tdata: {url:url},\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise()\n\t.fail(function(msg,err) {\n\t\tconsole.info(err);\n\t});\n}\n\nfunction updateServidorWMS(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateServidorWMS,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction duplicateTematicLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\t//url: paramUrl.proxy + \"?url=\" + paramUrl.duplicateTematicLayer + \"&uid=\"+data.uid,\n\t\turl: paramUrl.duplicateTematicLayer,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction reminderMail(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.reminderMail,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction renewPassword(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.renewPassword,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getNumEntitatsActives(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getNumEntitatsActives,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getNumMapes(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getNumMapes,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getNumCapes(){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getNumCapes,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction publicarCapesMapa(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.publicarCapesMapa,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\t//dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction publicarMapConfig(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.publicarMapConfig,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getUrlFile(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlFile,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteUser(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteUser,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getUrlFileProves(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlFileProves,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getUrlFileNoDin(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlFileNoDin,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getUrlFileDin(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlFileDin,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getUserSimple(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getUserSimple,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction uploadImageBase64(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urluploadBase64,\t\t\n\t\tdata: data,\t\t\n\t\tcontentType: \"application/x-www-form-urlencoded;charset=UTF-8\",\n\t\tmethod: 'POST',\n\t\tdataType: 'json',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\t\n\n\nfunction createGeoPdfMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlgetMapImage,\n\t\tdata: data,\t\n\t\tcontentType: \"application/x-www-form-urlencoded; charset=UTF-8\",\n\t\tmethod: 'POST',\n\t\tdataType: 'json',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\t\n\n\n\nfunction createMapToWMS(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlMapToWMS,\n\t\tdata: data,\t\n\t\tcontentType: \"application/x-www-form-urlencoded; charset=UTF-8\",\n\t\tmethod: 'POST',\n\t\tdataType: 'json',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\t\n\n\n\n//esborra imatge galeria\n\nfunction deleteImageGaleria(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.urlgetMapImage,\n\t\tdata:data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\n\n\n\nfunction updatePasswordIcgc(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updatePasswordIcgc,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n\n/*FUNCIONS NOU MODEL*/\nfunction createVisualitzacioLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createVisualitzacioLayer,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction addGeometriaToVisualitzacio(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.addGeometriaToVisualitzacio,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction moveGeometriaToVisualitzacio(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.moveGeometriaToVisualitzacio,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateGeometria(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateGeometria,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction modificarEstiloGeometria(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.modificarEstiloGeometria,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction removeGeometriaFromVisualitzacio(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.removeGeometriaFromVisualitzacio,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateNameVisualitzacioLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateNameVisualitzacioLayer,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteVisualitzacioLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteVisualitzacioLayer,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getVisualitzacioByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getVisualitzacioByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createVisualitzacioSimple(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createVisualitzacioSimple,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createVisualitzacioTematica(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createVisualitzacioTematica,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createVisualitzacioHeatCluster(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createVisualitzacioHeatCluster,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getGeometriesColleccioByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getGeometriesColleccioByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/*Data Table*/\n\nfunction getGeometriesPropertiesLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getGeometriesPropertiesLayer,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction removeGeometriaFromProperties(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.removeGeometriaFromProperties,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction updateGeometriaProperties(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateGeometriaProperties,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\n/* galeria.html */\nfunction updateMapVisibility(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateMapVisibility,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction sendMail(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.sendMail,\n\t\tdata: data,\n\t\tmethod: 'post',\n        dataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction loadMapsColaboracio(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getEntitatsAplicacioRolByUidColaborador,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction getEntitatsColaboradorsByAplicacio(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getEntitatsColaboradorsByAplicacio,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction getConvidatsByBusinessId(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getConvidatsByBusinessId,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction deleteConvidatByBusinessId(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteConvidatByBusinessId,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction deleteUser(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.deleteUser,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n/*\nfunction updateRankAplicacio(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateRankAplicacio,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n});\nrunningActions.push(xhr);\nreturn xhr.promise();\n}\n*/\nfunction buffer(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.buffer,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction centroid(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.centroid,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction intersection(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.intersection,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction union(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.union,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction tag(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.tag,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction getVisualitzacioSimpleByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getVisualitzacioSimpleByBusinessId,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction filterVisualitzacio(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.filterVisualitzacio,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction registreInstamaper(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.signinInstamaper,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction crearFitxerPolling(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.crearFitxerPolling,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction resetClauMapa(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.resetClauMapa,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction loadPrivateMapByBusinessId(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.loadPrivateMapByBusinessId,\n\t\tmethod: 'post',\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction filter(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.filter,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction callActions(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.callActions,\n\t\tdata: data,\n\t\tasync: false,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction loadAplicacionsUser(){\n\t/*\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.loadAplicacionsUser,\n\t\tmethod: 'get',\n\t\tdataType: 'json'\n\t\tcomplete: actionCompleted\n});\nrunningActions.push(xhr);\nreturn xhr.promise();\n\t*/\n\tvar defer = jQuery.Deferred();\n\tdefer.resolve(perfilConfig);\n\treturn defer.promise();\n}\n\nfunction getUser(username){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getUser,\n\t\tdata: {uid : username},\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getConfiguradesUser(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getConfiguradesUser,\n\t\tdata: data,\n\t\tcrossDomain: true,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction deleteAplicacionsGeolocal(url){\n\tvar xhr = jQuery.ajax({\n\t\turl: url,\n\t\tcrossDomain: true,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction createToken(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.createToken,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction getValuesFromKeysProperty(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.getValuesFromKeysProperty,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction columnJoin(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.columnJoin,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction spatialJoin(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.spatialJoin,\n  \t\tdata: params,\n  \t\tmethod: 'post',\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction searchCapesPubliques(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.searchCapesPubliques,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction addServerDuplicateToMap(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.addServerDuplicateToMap,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction duplicateVisualitzacioLayer(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.duplicateVisualitzacioLayer,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction searchCatalegIdec(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.searchCatalegIdec,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction addGeometriaToVisualitzacioTematic(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.addGeometriaToVisualitzacioTematic,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction updateVisualitzacioLayer(params){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.updateVisualitzacioLayer,\n\t\tdata: params,\n  \t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction searchCatalogInspire(params){\n\tvar xhr = jQuery.ajax({\n\t\t\turl: paramUrl.urlgetInspireCatalog,\n\t\t\tdata: params,\n\t\t\ttraditional:true,\n\t\t\tdataType: 'jsonp',\n\t\t\tjsonp: 'json.wrf',\n\t\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction desbloquejarMapa(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.desbloquejarMapa,\n\t\tdata: data,\n\t\tdataType: 'jsonp',\n\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\nfunction crearFitxerSocrata(data){\n\tvar xhr = jQuery.ajax({\n\t\t\turl: paramUrl.crearFitxerSocrata,\n\t\t\tdata: data,\n\t\t\tmethod: 'post',\n\t\t\tdataType: 'jsonp',\t\t\t\n\t\t\tcomplete: actionCompleted\n\t});\n\trunningActions.push(xhr);\n\treturn xhr.promise();\n}\n\nfunction generateTokenRemember(data){\n\tvar xhr = jQuery.ajax({\n\t\turl: paramUrl.generateTokenRemember,\n\t\tdata: data,\n\t\tmethod: 'post',\n\t\tdataType: 'jsonp',\t\t\t\n\t\tcomplete: actionCompleted\n});\nrunningActions.push(xhr);\nreturn xhr.promise();\n}\n","/**\n * Funcions i utilitats vàries\n */\n\n//Varible per esciure debug amb funcion\n//  _escriuDebug(_debug,_arxiuJs,_liniacodi)\n\nvar _globalDebug=false;\n\n\nfunction isValidEmailAddress(emailAddress) {\n    var pattern = new RegExp(/^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?$/i);\n    return pattern.test(emailAddress);\n}\n\nfunction isValidURL(url) {\n\tvar pattern = /((http(s)?|ftp):\\/\\/.)?(www\\.)?[-a-zA-Z0-9:%._\\+~#=]{2,256}\\.[a-z0-9]{2,6}\\b([-a-zA-Z0-9%_:?\\+.~#&//=]*)/;\n\treturn pattern.test(url);\n}\n\nfunction isImgURL(str) {\n\treturn (/\\.(gif|jpg|jpeg|png)$/i).test(str);\n}\n\nfunction isBusinessId(str){\n\tvar pattern = new RegExp('^[0-9a-f]{32}$');\n\treturn pattern.test(str);\n}\n\nfunction isBlank(str) {\n    return (!str || (/^\\s*$/).test(str));\n}\n\nfunction isHexColor(color){\n\tvar pattern = /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i;\n\treturn pattern.test(color);\n}\n\nfunction isDefaultMapTitle(str){\n//\tvar pattern = new RegExp('^\\d{4}[\\/\\-](0?[1-9]|1[012])[\\/\\-](0?[1-9]|[12][0-9]|3[01])[_](?:2[0-3]|[01]?[0-9]):[0-5][0-9]:[0-5][0-9]$');\n\tvar pattern = /^\\d{4}[\\/\\-](0?[1-9]|1[012])[\\/\\-](0?[1-9]|[12][0-9]|3[01])[_](?:2[0-3]|[01]?[0-9]):[0-5][0-9]:[0-5][0-9]$/;\n\treturn pattern.test(str);\n}\n\nfunction isValidValue(value){\n\treturn (value!==\"undefined\" && value!==undefined && value!==null && value !== \" \" && value !== \"\" && value!==\"null\" && value!==-1 && value!==\"-1\");\n}\n\nfunction toggleCollapseDiv(divName){\n\t$(divName).toggle();\n}\n\nfunction getTimeStamp() {\n    var now = new Date();\n    return (now.getFullYear()+'/'+(\n    \t((now.getMonth() + 1) < 10) ? (\"0\" + (now.getMonth() + 1)) : ((now.getMonth() + 1)))\n    \t+ '/' +\n        now.getDate() +'_'+\n        ((now.getHours() < 10) ? (\"0\" + now.getHours()) : (now.getHours()))\n        + ':' +\n        ((now.getMinutes() < 10) ? (\"0\" + now.getMinutes()) : (now.getMinutes()))\n        + ':' +\n        ((now.getSeconds() < 10) ? (\"0\" + now.getSeconds()) : (now.getSeconds()))\n    );\n}\n\nfunction calculateDistance(lLatLngs){\n\tvar totalDistance = 0;\n\tvar lastPoint;\n\tif(lLatLngs.length>0) lastPoint = lLatLngs[0];\n\n\tjQuery.each(lLatLngs, function( i, point){\n\t\ttotalDistance += point.distanceTo(lastPoint);\n\t\tlastPoint = point;\n\t});\n\treturn L.GeometryUtil.readableDistance(totalDistance, true);\n}\n\nfunction calculateArea(layer){\n\tvar totalArea = getAreaLayer(layer);\n\treturn L.GeometryUtil.readableArea(totalArea, true);\n}\n\nfunction getAreaLayer(layer){\n\tvar totalArea = 0,\n\t\tlLatLngs;\n\n\tif (layer._layers){\n\t\tlayer.eachLayer(function (layer) {\n\t\t\ttotalArea += getAreaLayer(layer);\n\t\t});\n\n\t}else if(layer.length > 0){\n\t\tfor(var i=0; i<layer.length;i++){\n\t\t\tlLatLngs = new L.latLng(0,0);\n\t\t\tif(layer[i].lat && layer[i].lng){\n\t\t\t\tlLatLngs = new L.latLng(layer[i].lat,layer[i].lng);\n\t\t\t}\n\t\t\ttotalArea += L.GeometryUtil.geodesicArea(lLatLngs);\n\t\t}\n\n\t}else{\n\t\tlLatLngs = layer.getLatLngs();\n\t\ttotalArea = L.GeometryUtil.geodesicArea(lLatLngs);\n\t}\treturn totalArea;\n}\n\nfunction transformTipusGeometry(geometrytype){\n\tvar ftype = geometrytype;\n\tif (ftype){\n\t\tftype = ftype.toLowerCase();\n\t\tif (ftype === t_point){\n\t\t\tftype = t_marker;\n\t\t}else if (ftype === t_linestring){\n\t\t\tftype = t_polyline;\n\t\t}else if (ftype === t_multilinestring){\n\t\t\tftype = t_polyline;\n\t\t}else if (ftype === t_multipolygon){\n\t\t\tftype = t_polygon;\n\t\t}\n\t}\n\treturn ftype;\n}\n\nfunction hexToRgb(hex) {\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n    return result ? {\n        r: parseInt(result[1], 16),\n        g: parseInt(result[2], 16),\n        b: parseInt(result[3], 16)\n    } : {r:0,g:0,b:0};\n}\n\nfunction hexToRgba(hex, opacity) {\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n    return result ? {\n        r: parseInt(result[1], 16),\n        g: parseInt(result[2], 16),\n        b: parseInt(result[3], 16),\n        a: opacity,\n    } : {r:0,g:0,b:0,a:1};\n}\n\nfunction hex(x) {\n\tvar hexDigits = new Array(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\");\n\treturn isNaN(x) ? \"00\" : hexDigits[(x - x % 16) / 16] + hexDigits[x % 16];\n}\n\n/**Function to convert hex format to a rgb color (incloent si passes transparencia o no)*/\nfunction rgb2hex(rgb){\n rgb = rgb.match(/^rgba?[\\s+]?\\([\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?/i);\n return (rgb && rgb.length === 4) ? \"#\" +\n  (\"0\" + parseInt(rgb[1],10).toString(16)).slice(-2) +\n  (\"0\" + parseInt(rgb[2],10).toString(16)).slice(-2) +\n  (\"0\" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';\n}\n\n/**Funcio per obtenir la transparencia d'un rgb*/\nfunction getRgbAlpha(rgba){\n\t var alpha=rgba.replace(/^.*,(.+)\\)/,'$1');\n\t return jQuery.trim(alpha);\n}\n\nfunction getMidaFromRadius(radius){\n\tif(radius == 8)return 21;\n\telse if(radius == 10)return 24;\n\telse if(radius == 12)return 30;\n\telse if(radius == 14)return 34;\n\telse return 16;\n}\n\nfunction getMidaFromFont(font){\n\tif(font == 'font15')return 30;\n\telse if(font == 'font12')return 24;\n\telse if(font == 'font11')return 21;\n\telse if(font == 'font9')return 16;\n\telse return 34;\n}\n\nfunction getRadiusFromMida(mida){\n\tif(mida == \"21px\")return 8;\n\telse if(mida == \"24px\")return 10;\n\telse if(mida == \"30px\")return 12;\n\telse if(mida == \"34px\")return 14;\n\telse return 6;\n}\n\nfunction getColorAwesomeMarker(markerColor, defaultColor){\n\tif(markerColor.indexOf(\"punt_r\")!=-1) return defaultColor;\n\telse if(markerColor.indexOf(\"orange\")!=-1) return \"#ffc500\";\n\telse if(markerColor.indexOf(\"darkorange\")!=-1) return \"#ff7f0b\";\n\telse if(markerColor.indexOf(\"red\")!=-1) return \"#ff4b3a\";\n\telse if(markerColor.indexOf(\"purple\")!=-1) return \"#ae59b9\";\n\telse if(markerColor.indexOf(\"blue\")!=-1) return \"#00afb5\";\n\telse if(markerColor.indexOf(\"green\")!=-1) return \"#7cbd00\";\n\telse if(markerColor.indexOf(\"darkgray\")!=-1) return \"#90a6a9\";\n\telse if(markerColor.indexOf(\"gray\")!=-1) return \"#ebf0f1\";\n}\n\nfunction parseUrlTextPopUp(txt,key){\n\t//console.debug(txt);\n\tif (key.toLowerCase() != \"geomorigen\"){\n\t    var parseText = \"\";\n\t    var isWkt=validateWkt(txt);\n\t    if (!isWkt) {\n\t\t    if(!$.isNumeric(txt) && (key=='link' || key=='Web')){\n\t\t          if( isImgURL(txt)){\n\t\t        \t  parseText = '<img width=\"100%\" src=\"'+txt+'\"/>';\n\t\t          }else if( txt.match(\"^http\")){\n\t\t              parseText = '<a target=\"_blank\" href=\"'+txt+'\"/>'+txt+'</a>';\n\t\t          }else{\n\t\t              parseText = '<a target=\"_blank\" href=\"http://'+txt+'\"/>'+txt+'</a>';\n\t\t          }\n\t\t          return parseText;\n\t\t    }\n\t\t\n\t\t    if (!$.isNumeric(txt)) {\n\t\t          if(txt.indexOf(\"href\")!= -1 || txt.indexOf(\"<a\")!= -1 || \n\t\t                 txt.indexOf(\"<img\")!= -1 || txt.indexOf(\"<iframe\")!= -1 ){\n\t\t                 return txt;\n\t\t          }\n\t\t    }\n\t\t\n\t\t\tvar lines = txt.split(/\\n/);\n\t\t\tfor(lineNum in lines)\n\t\t\t{\n\t\n\t\t\t\tvar line = lines[lineNum];\n\t\t\t    var lwords = line.split(\" \");\n\t\t\t    for(index in lwords){\n\t\t\t          var text;\n\t\t\t          var word = lwords[index];\n\t\t\t          if(!$.isNumeric(txt) ){\n\t\t\t                 if (isValidURL(word)){\n\t\t\t                 \t\tvar hasProtocol = ((-1 != word.indexOf('http://')) || (-1 != word.indexOf('https://')) || (-1 != word.indexOf('ftp://')))\n\t\t\t                        if(isImgURL(word)){\n\t\t\t                               text = \"<img src=\\\"\" + (!hasProtocol ? \"http://\" + word : word) + \"\\\" alt=\\\"img\\\" class=\\\"popup-data-img\\\"/>\";\n\t\t\t                        }\n\t\t\t                        else if (word.indexOf(\"html?\") != -1){\n\t\t\t                               text = \"<iframe width=\\\"100%\\\" height=\\\"200\\\" frameborder=\\\"0\\\" marginheight=\\\"0\\\"\"+\n\t\t\t                                            \"marginwidth=\\\"0\\\" src=\\\"\"+(!hasProtocol ? \"http://\" + word : word)+\"\\\"></iframe>\";\n\t\t\t                        }else if (txt.indexOf(\"<video\")==-1){\n\t\t\t                               text = \"<a href=\\\"\"+(!hasProtocol ? \"http://\" + word : word)+\"\\\" target=\\\"_blank\\\">\"+word.replace(\"http://\", \"\")+\"</a>\";\n\t\t\t                        }\n\t\t\t                        else text=word;\n\t\t\t                 }else{\n\t\t\t                        text = word;\n\t\t\t                 }\n\t\t\t\n\t\t\t          }else{\n\t\t\t                 text = word;\n\t\t\t          }\n\t\t\t          parseText+=\" \"+text;\n\t\t\t    }\n\t\n\t\t\t    if(\"\" == line)\n\t\t\t\t\tparseText += \"<br />\";\n\t\t\t\telse\n\t\t\t\t\tparseText += \"\\n\";\n\t\n\t\t\t}\n\t\t    return parseText;\n\t    }\n\t    else {\n\t    \treturn \"isWkt\";\n\t    }\n\t}\n}\n\nfunction redimensioMapa() {\n\tjQuery(window).resize(function() {\n\t\tvar factorW = 0, \n\t\tfactorH = 0;\n\t\t\n\t\tif(typeof url('?embed') == \"string\"){//Pel cas visor, embeded\n\t\t\tfactorH = 0;\n\t\t}else{\n\t\t\tfactorH = jQuery('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\n\t\t}\n\t\tjQuery('#map').css('top', factorH + 'px');\n\t\tjQuery('#map').height(jQuery(window).height() - factorH);\n\t\tjQuery('#map').width(jQuery(window).width() - factorW);\n\t});\n\tjQuery(window).trigger('resize');\n}\n\nfunction getLeafletIdFromBusinessId(businessId){\n\tfor(val in controlCapes._layers){\n\t\tif(controlCapes._layers[val].layer.options.businessId == businessId){\n\t\t\t//console.debug(\"leaflet Id:\");\n\t\t\t//console.debug(val);\n\t\t\treturn val;\n\t\t}\n\t}\n}\n\nfunction activaPanelCapes(obre) {\n\t\n\tif (obre) {\n\t\t\n\t\tjQuery('.leaflet-control-layers').toggle();\n\t\t\n\t\t//jQuery('.leaflet-control-layers').fadeOut({duration: 'fast'});\n\t} else {\n\t\t//jQuery('.leaflet-control-layers').fadeOut({duration: 'fast'});\n\t\tjQuery('.leaflet-control-layers').toggle();\n\t}\n\tvar cl,\n\t btnDiv;\n\tif(jQuery('.bt_llista span')){\n\t\tbtnDiv = jQuery('.bt_llista span');\n\t}else{\n\t\tbtnDiv = jQuery('#dv_bt_layers');\n\t}\n\tcl = btnDiv.attr('class');\n\tif (cl && cl.indexOf('grisfort') != -1) {\n\t\tbtnDiv.removeClass('grisfort');\n\t\tbtnDiv.addClass('greenfort');\n\t} else {\n\t\tbtnDiv.removeClass('greenfort');\n\t\tbtnDiv.addClass('grisfort');\n\t}\n\n\tif(getModeMapa()){updateSortablesElements();}\n\n}\n\nfunction gestionaPopOver(pop) {\n\t//console.debug(\"gestionaPopOver\");\n\tjQuery('.popover').popover('hide');\n\tjQuery('.pop').not(pop).popover('hide');\n\tjQuery(pop).popover('toggle');\n\tjQuery(\".popover\").css('left', pLeft());\n\tjQuery('.popover-title').append('<span id=\"popovercloseid#'+jQuery(pop).attr('id')+'\" class=\"glyphicon glyphicon-remove bt_tanca\"></span>');\n}\n\nfunction pLeft() {\n\treturn jQuery(\".leaflet-left\").css('left');\n}\n\nfunction gestioCookie(from){\n\tvar _cookie = Cookies.get('uid');\n\n\tswitch(from){\n\t\tcase 'createMap':\n\t\t\tif (isRandomUser(_cookie)){\n\t\t\t\tCookies.remove('uid');\n\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t}else{\n\t\t\t\twindow.location.href = paramUrl.galeriaPage;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'createMapError':\n\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\tbreak;\n\t\tcase 'getMapByBusinessId2':\n\t\t\tif (isRandomUser(_cookie)){\n\t\t\t\tCookies.remove('uid');\n\t\t\t\tjQuery(window).off('beforeunload');\n\t\t\t\t//jQuery(window).off('unload');\n\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t}else{\n\t\t\t\twindow.location.href = paramUrl.galeriaPage+\"?private=1\";\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'getMapByBusinessId':\n\t\t\tif (!_cookie){\n\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t}else{\n\t\t\t\tif (isRandomUser(_cookie)){\n\t\t\t\t\tCookies.remove('uid');\n\t\t\t\t\tjQuery(window).off('beforeunload');\n\t\t\t\t\t//jQuery(window).off('unload');\n\t\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t\t}else{\n\t\t\t\t\twindow.location.href = paramUrl.galeriaPage;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'loadApp':\n\t\t\tif (!_cookie){\n\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'diferentUser':\n\t\t\tvar mapacolaboratiu = url('?mapacolaboratiu');\n\t\t\tif (mapacolaboratiu && mapacolaboratiu=='si'){\n\t\t\t\tCookies.set('collaborateuid', url('?uid'));\n\t\t\t}\n\t\t\telse{\n\t\t\t\tCookies.remove('collaborateuid', { path: '/' });\n\t\t\t\tif (mapConfig.entitatUid != _cookie){\n\t\t\t\t\tCookies.remove('uid');\n\t\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'loadMapConfig':\n\t\t\tif (isRandomUser(_cookie) ){\n\t\t\t\tCookies.remove('uid');\n\t\t\t\tjQuery(window).off('beforeunload');\n\t\t\t\twindow.location.href = paramUrl.mainPage;\n\t\t\t}else{\n\t\t\t\twindow.location.href = paramUrl.galeriaPage;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'carregaDadesUsuari':\n\t\t\twindow.location.href = paramUrl.loginPage;\n\t\t\tbreak;\n\t\tcase 'refrescaPopOverMevasDades':\n\t\t\twindow.location.href = paramUrl.loginPage;\n\t\t\tbreak;\n\t\tcase 'getMapByBusinessIdError':\n\t\t\twindow.location.href = paramUrl.loginPage;\n\t\t\tbreak;\n\t\tcase 'mapaBloquejat':\n\t\t\t//Temps vida cookie bloqueig: 2 hores\n\t\t\tCookies.set('lockCookie', _cookie, {\n\t\t\t    expires: 1/12\n\t\t\t});\n\t\t\tbreak;\n\t}\n}\n\nfunction popUp(f, l) {\n\tvar out = [];\n\tif (f.properties) {\n\t\tfor (key in f.properties) {\n\t\t\tif(key!='gml_id'){\n\t\t\t\tif(key=='Name' || key=='Description'){\n\t\t\t\t\tout.push(f.properties[key]);\n\t\t\t\t}else if(key=='link' || key=='Web'){\n\t\t\t\t\tll=f.properties[key];\n\t\t\t\t\t//if(ll.indexOf('.gif')!=-1 || ll.indexOf('.jpg')!=-1){\n\t\t\t\t\tif(isImgURL(ll)){\n\t\t\t\t\t\tout.push('<img width=\"100\" src=\"'+ll+'\"/>');\n\t\t\t\t\t}else{\n\t\t\t\t\t\tout.push('<b>'+key +'</b>: <a target=\"_blank\" href=\"http://'+ll+'\"/>'+ll+'</a>');\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tout.push(\"<b>\"+key + \"</b>: \" + f.properties[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tl.bindPopup(out.join(\"<br />\"));\n\t}\n}\n\nfunction aturaClick(event){\n\ttry{\n\t\tevent.stopImmediatePropagation();\n\t}catch(err){\n\t\tconsole.info(err);\n\t}\n}\n\n//Funcions d'estils\nfunction retornaEstilaDO(dataset) {\n\tvar estil = { radius : 6, fillColor : \"#FC5D5F\", color : \"#ffffff\", weight : 2, opacity : 1, fillOpacity : 0.8, isCanvas: true };\n\tif(dataset==\"radars\"){ estil.fillColor = \"#A00698\";}\n\telse if(dataset==\"turisme_rural\"){ estil.fillColor = \"#06A010\";}\n\telse if(dataset==\"hotels\"){ estil.fillColor = \"#ED760E\";}\n\telse if(dataset==\"incidencies\"){ estil.fillColor = \"#991032\";}\n\telse if(dataset==\"cameres\"){ estil.fillColor = \"#495CBC\";}\n\telse if(dataset==\"campings\"){ estil.fillColor = \"#62A50B\";}\n\telse if(dataset==\"meteo_comarca\"){ estil.fillColor = \"#200BA5\";}\n\telse if(dataset==\"meteo_costa\"){ estil.fillColor = \"#E1EA3A\";}\n\telse if(dataset==\"json_president\"){ estil.fillColor =\"#0058A5\"; estil.color =\"#0058A5\"; }\n\telse{ estil.fillColor = randomColor();}\n\treturn estil;\n}\n\nfunction randomColor(){\n\treturn '#'+Math.floor(Math.random()*16777215).toString(16);\n}\n\n\n\nfunction getRamdomColorFromArray() {\n\tvar colors = ['#ffc500', '#ff7f0b', '#ff4b3a', '#ae59b9', '#00afb5', '#7cbd00', '#90a6a9', '#ebf0f1'];\n   return colors[Math.floor(Math.random() * colors.length)];\n}\n\n//Comptador mida dun objecte\n$.extend({\n    keyCount : function(o) {\n        if(typeof o == \"object\") {\n            var i, count = 0;\n            for(i in o) {\n                if(o.hasOwnProperty(i)) {\n                    count++;\n                }\n            }\n            return count;\n        } else {\n            return false;\n        }\n    }\n});\n\n//jQuery.fn.myScrollTo = function(elem) {\n//    $(this).scrollTop($(this).scrollTop() - $(this).offset().top + $(elem).offset().top);\n//    return this;\n//};\n\nfunction getCodiUnic() {\n//\tconsole.debug(\"getCodiUnic\");\n    return  randomString(2) + Math.floor(Math.random() * (999 + 1)) + \"_\";\n}\n\nfunction randomString(len, charSet) {\n    charSet = charSet || 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';\n    var randomString = '';\n    for (var i = 0; i < len; i++) {\n    \tvar randomPoz = Math.floor(Math.random() * charSet.length);\n    \trandomString += charSet.substring(randomPoz,randomPoz+1);\n    }\n//    console.debug(randomString);\n    return randomString;\n}\n\nfunction getRandomInt(min, max) {\n    return Math.floor(Math.random() * (max - min + 1)) + min;\n}\n\n//Comprovar i forcar carrega dun script\nfunction forceLoadScript(path){\n\n\tvar len = $('script[src*=\"'+path+'\"]').length;\n\tconsole.debug(\"len:\");\n\tconsole.debug(len);\n\tif (len === 0) {\n\t        console.debug('script not loaded');\n\t        loadScript(path);\n\n\t        if ($('script[src*=\"'+path+'\"]').length === 0) {\n\t        \tconsole.debug('still not loaded');\n\t        }\n\t        else {\n\t        \tconsole.debug('loaded now');\n\t        }\n    }else{\n    \tconsole.debug('script loaded');\n    }\n}\n\nfunction loadScript(scriptLocationAndName) {\n    var head = document.getElementsByTagName('head')[0];\n    var script = document.createElement('script');\n    script.type = 'text/javascript';\n    script.src = scriptLocationAndName;\n    head.appendChild(script);\n}\n\nfunction htmlentities(string, quote_style, charset, double_encode) {\n\t  //  discuss at: http://phpjs.org/functions/htmlentities/\n\t  // original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n\t  //  revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n\t  //  revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n\t  // improved by: nobbler\n\t  // improved by: Jack\n\t  // improved by: Rafał Kukawski (http://blog.kukawski.pl)\n\t  // improved by: Dj (http://phpjs.org/functions/htmlentities:425#comment_134018)\n\t  // bugfixed by: Onno Marsman\n\t  // bugfixed by: Brett Zamir (http://brett-zamir.me)\n\t  //    input by: Ratheous\n\t  //  depends on: get_html_translation_table\n\t  //   example 1: htmlentities('Kevin & van Zonneveld');\n\t  //   returns 1: 'Kevin &amp; van Zonneveld'\n\t  //   example 2: htmlentities(\"foo'bar\",\"ENT_QUOTES\");\n\t  //   returns 2: 'foo&#039;bar'\n\n\t  var hash_map = this.get_html_translation_table('HTML_ENTITIES', quote_style),\n\t    symbol = '';\n\t  string = string === null ? '' : string + '';\n\n\t  if (!hash_map) {\n\t    return false;\n\t  }\n\n\t  if (quote_style && quote_style === 'ENT_QUOTES') {\n\t    hash_map[\"'\"] = '&#039;';\n\t  }\n\n\t  if ( !! double_encode || double_encode === null) {\n\t    for (symbol in hash_map) {\n\t      if (hash_map.hasOwnProperty(symbol)) {\n\t        string = string.split(symbol)\n\t          .join(hash_map[symbol]);\n\t      }\n\t    }\n\t  } else {\n\t    string = string.replace(/([\\s\\S]*?)(&(?:#\\d+|#x[\\da-f]+|[a-zA-Z][\\da-z]*);|$)/g, function (ignore, text, entity) {\n\t      for (symbol in hash_map) {\n\t        if (hash_map.hasOwnProperty(symbol)) {\n\t          text = text.split(symbol)\n\t            .join(hash_map[symbol]);\n\t        }\n\t      }\n\n\t      return text + entity;\n\t    });\n\t  }\n\n\t  return string;\n\t}\n\nfunction get_html_translation_table(table, quote_style) {\n//discuss at: http://phpjs.org/functions/get_html_translation_table/\n//original by: Philip Peterson\n//revised by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)\n//bugfixed by: noname\n//bugfixed by: Alex\n//bugfixed by: Marco\n//bugfixed by: madipta\n//bugfixed by: Brett Zamir (http://brett-zamir.me)\n//bugfixed by: T.Wild\n//improved by: KELAN\n//improved by: Brett Zamir (http://brett-zamir.me)\n//input by: Frank Forte\n//input by: Ratheous\n//note: It has been decided that we're not going to add global\n//note: dependencies to php.js, meaning the constants are not\n//note: real constants, but strings instead. Integers are also supported if someone\n//note: chooses to create the constants themselves.\n//example 1: get_html_translation_table('HTML_SPECIALCHARS');\n//returns 1: {'\"': '&quot;', '&': '&amp;', '<': '&lt;', '>': '&gt;'}\nvar entities = {},\nhash_map = {},\ndecimal;\nvar constMappingTable = {},\nconstMappingQuoteStyle = {};\nvar useTable = {},\nuseQuoteStyle = {};\n//Translate arguments\nconstMappingTable[0] = 'HTML_SPECIALCHARS';\nconstMappingTable[1] = 'HTML_ENTITIES';\nconstMappingQuoteStyle[0] = 'ENT_NOQUOTES';\nconstMappingQuoteStyle[2] = 'ENT_COMPAT';\nconstMappingQuoteStyle[3] = 'ENT_QUOTES';\nuseTable = !isNaN(table) ? constMappingTable[table] : table ? table.toUpperCase() : 'HTML_SPECIALCHARS';\nuseQuoteStyle = !isNaN(quote_style) ? constMappingQuoteStyle[quote_style] : quote_style ? quote_style.toUpperCase() :\n'ENT_COMPAT';\nif (useTable !== 'HTML_SPECIALCHARS' && useTable !== 'HTML_ENTITIES') {\nthrow new Error('Table: ' + useTable + ' not supported');\n//return false;\n}\nentities['38'] = '&amp;';\nif (useTable === 'HTML_ENTITIES') {\nentities['160'] = '&nbsp;';\nentities['161'] = '&iexcl;';\nentities['162'] = '&cent;';\nentities['163'] = '&pound;';\nentities['164'] = '&curren;';\nentities['165'] = '&yen;';\nentities['166'] = '&brvbar;';\nentities['167'] = '&sect;';\nentities['168'] = '&uml;';\nentities['169'] = '&copy;';\nentities['170'] = '&ordf;';\nentities['171'] = '&laquo;';\nentities['172'] = '&not;';\nentities['173'] = '&shy;';\nentities['174'] = '&reg;';\nentities['175'] = '&macr;';\nentities['176'] = '&deg;';\nentities['177'] = '&plusmn;';\nentities['178'] = '&sup2;';\nentities['179'] = '&sup3;';\nentities['180'] = '&acute;';\nentities['181'] = '&micro;';\nentities['182'] = '&para;';\nentities['183'] = '&middot;';\nentities['184'] = '&cedil;';\nentities['185'] = '&sup1;';\nentities['186'] = '&ordm;';\nentities['187'] = '&raquo;';\nentities['188'] = '&frac14;';\nentities['189'] = '&frac12;';\nentities['190'] = '&frac34;';\nentities['191'] = '&iquest;';\nentities['192'] = '&Agrave;';\nentities['193'] = '&Aacute;';\nentities['194'] = '&Acirc;';\nentities['195'] = '&Atilde;';\nentities['196'] = '&Auml;';\nentities['197'] = '&Aring;';\nentities['198'] = '&AElig;';\nentities['199'] = '&Ccedil;';\nentities['200'] = '&Egrave;';\nentities['201'] = '&Eacute;';\nentities['202'] = '&Ecirc;';\nentities['203'] = '&Euml;';\nentities['204'] = '&Igrave;';\nentities['205'] = '&Iacute;';\nentities['206'] = '&Icirc;';\nentities['207'] = '&Iuml;';\nentities['208'] = '&ETH;';\nentities['209'] = '&Ntilde;';\nentities['210'] = '&Ograve;';\nentities['211'] = '&Oacute;';\nentities['212'] = '&Ocirc;';\nentities['213'] = '&Otilde;';\nentities['214'] = '&Ouml;';\nentities['215'] = '&times;';\nentities['216'] = '&Oslash;';\nentities['217'] = '&Ugrave;';\nentities['218'] = '&Uacute;';\nentities['219'] = '&Ucirc;';\nentities['220'] = '&Uuml;';\nentities['221'] = '&Yacute;';\nentities['222'] = '&THORN;';\nentities['223'] = '&szlig;';\nentities['224'] = '&agrave;';\nentities['225'] = '&aacute;';\nentities['226'] = '&acirc;';\nentities['227'] = '&atilde;';\nentities['228'] = '&auml;';\nentities['229'] = '&aring;';\nentities['230'] = '&aelig;';\nentities['231'] = '&ccedil;';\nentities['232'] = '&egrave;';\nentities['233'] = '&eacute;';\nentities['234'] = '&ecirc;';\nentities['235'] = '&euml;';\nentities['236'] = '&igrave;';\nentities['237'] = '&iacute;';\nentities['238'] = '&icirc;';\nentities['239'] = '&iuml;';\nentities['240'] = '&eth;';\nentities['241'] = '&ntilde;';\nentities['242'] = '&ograve;';\nentities['243'] = '&oacute;';\nentities['244'] = '&ocirc;';\nentities['245'] = '&otilde;';\nentities['246'] = '&ouml;';\nentities['247'] = '&divide;';\nentities['248'] = '&oslash;';\nentities['249'] = '&ugrave;';\nentities['250'] = '&uacute;';\nentities['251'] = '&ucirc;';\nentities['252'] = '&uuml;';\nentities['253'] = '&yacute;';\nentities['254'] = '&thorn;';\nentities['255'] = '&yuml;';\n}\nif (useQuoteStyle !== 'ENT_NOQUOTES') {\nentities['34'] = '&quot;';\n}\nif (useQuoteStyle === 'ENT_QUOTES') {\nentities['39'] = '&#39;';\n}\nentities['60'] = '&lt;';\nentities['62'] = '&gt;';\n//ascii decimals to real symbols\nfor (decimal in entities) {\nif (entities.hasOwnProperty(decimal)) {\nhash_map[String.fromCharCode(decimal)] = entities[decimal];\n}\n}\nreturn hash_map;\n}\n\nfunction getModeMapa(){\n\treturn  ($(location).attr('href').indexOf('/mapa.html')!=-1);\n}\n\nfunction sortByKey(array, key) {\n    return array.sort(function(a, b) {\n        var x = a[key]; var y = b[key];\n        return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n    });\n}\n\nfunction sortByKeyPath(array, key) {\n\t\n\treturn array.sort(function(a, b) {\n\t\t var x = a.layer.options[key]; var y = b.layer.options[key];\n\t\treturn ((x < y) ? -1 : ((x > y) ? 1 : 0));\n    });\n}\n\nfunction sortByValueMax(a, b){\n\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\tvar floatRegex2 = new RegExp('(^-?0\\,[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\t\n\tif (a!=null && b!=null) {\n\t\tvar aValue;\n\t\tif (a.value!=undefined) aValue= a.value;\n\t\telse if (a.v!=undefined) aValue=a.v;\n\t\telse aValue = a;\n\t\n\t\t\n\t\tvar bValue;\n\t\tif (b.value!=undefined) bValue= b.value;\n\t\telse if (b.v!=undefined) bValue=b.v;\n\t\telse bValue =b;\n\t\tvar aValueStr = \"\"+aValue;\n\t\tvar bValueStr = \"\"+bValue;\n\t\tif (floatRegex.test(aValue) && floatRegex.test(bValue)) {\n\t\t\tif (aValueStr.indexOf(\",\")>-1){\n\t\t\t\tif (aValueStr.indexOf(\".\")>-1){\n\t\t\t\t\taValue=aValue.replace(\".\",\"\");\n\t\t\t\t\taValue=aValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\taValue = aValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (aValueStr.indexOf(\"-\")>-1 && aValue.substring(0,aValue.indexOf(\"-\"))!=\"\") aValue=aValue.substring(0,aValue.indexOf(\"-\"));\n\t\n\t\t\tif (bValueStr.indexOf(\",\")>-1){\n\t\t\t\tif (bValueStr.indexOf(\".\")>-1){\n\t\t\t\t\tbValue=bValue.replace(\".\",\"\");\n\t\t\t\t\tbValue=bValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tbValue = bValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (bValueStr.indexOf(\"-\")>-1 && bValue.substring(0,bValue.indexOf(\"-\"))!=\"\") bValue=bValue.substring(0,bValue.indexOf(\"-\"));\n\t\t\treturn (aValue-bValue);\n\t\t}\n\t\telse if (floatRegex2.test(aValue) && floatRegex2.test(bValue)) {\n\t\t\tif (aValueStr.indexOf(\",\")>-1){\n\t\t\t\tif (aValueStr.indexOf(\".\")>-1){\n\t\t\t\t\taValue=aValue.replace(\".\",\"\");\n\t\t\t\t\taValue=aValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\taValue = aValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (aValueStr.indexOf(\"-\")>-1 && aValue.substring(0,aValue.indexOf(\"-\"))!=\"\") aValue=aValue.substring(0,aValue.indexOf(\"-\"));\n\t\t\tif (bValueStr.indexOf(\",\")>-1){\n\t\t\t\tif (bValueStr.indexOf(\".\")>-1){\n\t\t\t\t\tbValue=bValue.replace(\".\",\"\");\n\t\t\t\t\tbValue=bValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tbValue = bValue.replace(\",\",\".\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (bValueStr.indexOf(\"-\")>-1 && bValue.substring(0,bValue.indexOf(\"-\"))!=\"\") bValue=bValue.substring(0,bValue.indexOf(\"-\"));\n\t\t\treturn (aValue-bValue);\n\t\t}\n\t\telse {\n\t\t\tvar aName = aValueStr.toLowerCase();\n\t\t\tvar bName = bValueStr.toLowerCase();\n\t\t\treturn ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));\n\t\t}\n\t}\n}\n\nfunction isMobile() {\n\t try {\n\t    if(/Android|webOS|iPhone|iPad|iPod|pocket|psp|kindle|avantgo|blazer|midori|Tablet|Palm|maemo|plucker|phone|BlackBerry|symbian|IEMobile|mobile|ZuneWP7|Windows Phone|Opera Mini/i.test(navigator.userAgent)) {\n\t     return true;\n\t    };\n\t    return false;\n\t } catch(e){ console.log(\"Error in isMobile\"); return false; }\n}\n\n\nfunction isChrome(){\n\nvar isChromium = window.chrome,\nvendorName = window.navigator.vendor;\n\t\nvar _hoSoc=false;\n\t\t\n\t\tif(isChromium !== null && isChromium !== undefined && vendorName === \"Google Inc.\") {\n\t\t\t_hoSoc=true;\n\t\t}\n\n\treturn _hoSoc;\t\n\n\t\n}\t\n\nfunction refrescarPopUp(nom,props,_leaflet_id,type,capaLeafletId){\n\tvar html='';\n\thtml+='<h4 class=\"my-text-center\">'+nom+'</h4>';\n\t\n\t\n\tvar isADrawarker=false;\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t$.each(props, function( key, value ) {\n\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\n\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \n\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \n\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\n\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\n\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\tvar txt=value;\n\t\t\t\tif (!$.isNumeric(txt)) {\n\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t'</div>';\n\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\n\t\t\t\t\t}else{\n\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\tif(undefined != capa.isPropertyNumeric && capa.isPropertyNumeric[key] && ((\"\" == origen) || (\"\" != origen && (key == capa.options.trafficLightKey))))\n\t\t\t\t\t{\n\n\t\t\t\t\t\tvar leafletid = ((\"undefined\" !== typeof player.properties.capaLeafletId) ? player.properties.capaLeafletId : (capa.hasOwnProperty(\"layer\") ? capa.layer._leaflet_id : \"\"));\n\t\t\t\t\t\t//Només ensenyem la icona del semafòric si és una capa no temàtica o bé si ho és però és semafòrica sense semàfor fixe (sempre que el camp sigui numèric)\n\t\t\t\t\t\thtml+='<div class=\"traffic-light-icon\" data-leafletid=\"' + leafletid + '\" data-origen=\"' + origen + '\" title=\"'+window.lang.translate('Temàtic per escala de color')+'\"></div>';\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\n\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\thtml+= '</div>';\n\t\t\t\tif (key=='text' || key=='TEXT') isADrawarker=true;\n\t\t\t\telse isADrawarker=false;\n\t\t\t}\n\t\t}\n\t});\t\n\tconsole.debug(_leaflet_id);\n\tconsole.debug(type);\n\tconsole.debug(capaLeafletId);\n\thtml +='<div id=\"footer_edit\"  class=\"modal-footer\">'\n\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\n\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\n\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\n\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+_leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>';\n\thtml+='<li class=\"edicio-popup\" id=\"feature_data_table_'+_leaflet_id+'\"><a id=\"feature_data_table##'+_leaflet_id+'##'+type+'##'+capaLeafletId+'##\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>';\t\t\t\t\t\n\n\t\t\n\thtml+='<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#finestrapunt\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>';\n\t\n\thtml+='</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t+'</div>'\n\treturn html;\n\t\n}\n\nfunction changeWMSQueryable(queryable){\t\n\tmap.eachLayer(function (layer) { \n\t  try{\t \n\t \n\t\tlayer.options && layer.options.tipus && layer.options.tipus=='wms'?layer.options.queryable=queryable: null\t \n\t  }catch(err){\n\t\t  console.debug(err);\n\t  }  \n\t});\n}\t\n\n\n\nfunction decimalComa(nStr) {\n\tnStr += '';\n\tnStr = nStr.replace(\".\", \",\");\n\n\tx = nStr.split(',');\n\tx1 = x[0];\n\tx2 = x.length > 1 ? ',' + x[1] : '';\n\tvar rgx = /(\\d+)(\\d{3})/;\n\twhile (rgx.test(x1)) {\n\n\t\tx1 = x1.replace(rgx, '$1' + '.' + '$2');\n\t}\n\treturn x1 + x2;\n}\n\n\n\n(function($){\n\tvar o = $({});\n\t$.each({\n\t\ttrigger: 'publish',\n\t\ton: 'subscribe',\n\t\toff: 'unsubscribe'\n\t},function(key, val){\n\t\t$[val] = function(){\n\t\t\to[key].apply(o, arguments);\n\t\t};\n\t});\n\t\n\t$('body').on('change', 'input[type=\"text\"], input[type=\"password\"], textarea', function(){\n\t\t$(this).val(cleanScriptCode($(this).val()));\n\t});\n\t\n})(jQuery);\n\nfunction createClass(name,rules){\n    var style = document.createElement('style');\n    style.type = 'text/css';\n    document.getElementsByTagName('head')[0].appendChild(style);\n    if(!(style.sheet||{}).insertRule) \n        (style.styleSheet || style.sheet).addRule(name, rules);\n    else\n        style.sheet.insertRule(name+\"{\"+rules+\"}\",0);\n}\n\nfunction cleanScriptCode(txt){\n\tvar SCRIPT_REGEX = /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi;\n\twhile (SCRIPT_REGEX.test(txt)) {\n\t\ttxt = txt.replace(SCRIPT_REGEX, \"\");\n\t}\t\n\treturn txt;\n}\n\nfunction shortString(str,_length){\n\tif(str){\n\t\tstr.length > _length ?str=(str.substring(0,_length)+\"...\"):str;\n\t}\n\treturn str;\t\n}\t\n\nfunction validateWkt(txt){\n\tvar isWkt = false;\n\tif (typeof (txt) == \"string\") {\n\t\tisWkt = txt.indexOf(\"POLYGON\")>-1 || txt.indexOf (\"POINT\")>-1 || txt.indexOf(\"LINE\")>-1;\n\t}\t\n\treturn isWkt;\n}\n\nString.prototype.replaceAll = function(target, replacement) {\n  return this.split(target).join(replacement);\n};\n\n\tvar EuCountryCodes = new Array( 'be','bg', 'cz','dk','de','ee','ie','el','es','fr','it','cy','lv','lt','lu','hu','mt','nl','at','pl','pt','ro','si','sk','fi','se','uk','is','no','hr');\n\tvar EuCountryNamesEN = {'be': 'Belgium','bg': 'Bulgaria','cz': 'Czech Republic','dk': 'Denmark','de': 'Germany','ee': 'Estonia','ie': 'Ireland','el': 'Greece','es': 'Spain','fr': 'France','it': 'Italy','cy': 'Cyprus','lv': 'Latvia','lt': 'Lithuania','lu': 'Luxembourg','hu': 'Hungary','mt': 'Malta','nl': 'Netherlands','at': 'Austria','pl': 'Poland','pt': 'Portugal','ro': 'Romania','si': 'Slovenia','sk': 'Slovakia','fi': 'Finland','se': 'Sweden','uk': 'United Kingdom','is': 'Iceland','no': 'Norway','hr': 'Croatia','li': 'Liechtenstein','tr': 'Turkey','ch': 'Switzerland','eu': 'European Union' };\n\tvar EuCountryNames = { \t'be':'Bèlgica', 'bg':'Bulgària', 'cz':'República Txeca', 'dk':'Dinamarca', 'de':'Alemanya', 'ee':'Estònia', 'ie':'Irlanda', 'el':'Grècia', 'es':'Espanya', 'fr':'França', 'it':'Itàlia', 'cy':'Xipre', 'lv':'Letònia', 'lt':'Lituània', 'lu':'Luxemburg', 'hu':'Hongria', 'mt':'Malta', 'nl':'Països Baixos', 'at':'Àustria', 'pl':'Polònia', 'pt':'Portugal', 'ro':'Romania', 'si':'Eslovènia', 'sk':'Eslovàquia', 'fi':'Finlàndia', 'se':'Suècia', 'uk':'Regne Unit', 'is':'Islàndia', 'no':'Noruega', 'hr':'Croàcia', 'li':'Liechtenstein', 'tr':'Turquia', 'ch':'Suïssa', 'eu':'Unió Europea' };\n\tvar EuCountryBBOX = {\"al\":\"19.28168,39.64765,21.05782,42.66108\",\"at\":\"9.52998,46.37245,17.16080,49.01529\", \"ba\":\"15.72873,42.55977,19.62363,45.27632\", \"be\":\"2.54601,49.49724,6.40503,51.50246\", \"bg\":\"22.35718,41.23593,28.60746,44.21566\", \"by\":\"23.17834,51.26285,32.76946,56.17222\", \"ch\":\"5.95607,45.82264,10.49204,47.80146\", \"cy\":\"32.27442,34.56750,34.58717,35.69489\", \"cz\":\"12.09221,48.55176,18.84376,51.05495\", \"de\":\"5.86632,47.27013,15.04180,54.91165\", \"dk\":\"8.07534,54.80484,10.95898,57.07808\", \"ee\":\"23.40401,57.50931,28.20842,59.66855\", \"el\":\"20.00881,37.65570,26.62996,41.74850\", \"el\":\"21.10524,36.38543,23.52390,38.33868\", \"es\":\"-9.29803,36.00705,3.32232,43.78991\", \"fi\":\"20.55038,59.81231,31.58627,70.09227\", \"hr\":\"13.48987,42.93842,19.44735,46.54657\", \"hu\":\"16.11385,45.73705,22.89627,48.58523\", \"ie\":\"-10.48000,51.45107,-6.01468,55.38264\", \"is\":\"-24.53084,63.39450,-13.49510,66.53758\", \"it\":\"6.63000,37.91603,18.52059,47.09173\", \"li\":\"9.47605,47.05180,9.63326,47.27094\", \"lt\":\"21.04881,53.89667,26.83181,56.44985\", \"lu\":\"5.73576,49.45110,6.52973,50.18278\", \"lv\":\"20.97068,55.67687,28.24145,58.08558\", \"md\":\"26.61875,45.46630,30.16649,48.49196\", \"me\":\"18.43355,41.85313,20.35293,43.55870\", \"mk\":\"20.45242,40.85490,23.03406,42.37160\", \"nl\":\"3.43372,50.75345,7.22750,53.46593\", \"no\":\"4.94090,57.98025,31.06381,71.13312\", \"pl\":\"14.12762,49.00248,24.14578,54.83409\", \"pt\":\"-9.50053,36.96317,-6.18935,42.15442\", \"ro\":\"20.26430,43.62074,29.68696,48.26064\", \"rs\":\"18.84816,41.85779,23.00583,46.18793\", \"se\":\"11.11105,55.33685,24.15514,69.06008\", \"si\":\"13.37549,45.42493,16.59681,46.87630\", \"sk\":\"16.83326,47.73140,22.56684,49.61377\", \"tr\":\"26.06056,35.80857,44.81861,42.09693\", \"tr\":\"26.03482,40.04417,29.11728,42.09850\", \"ua\":\"22.13799,44.38787,40.22820,52.37523\", \"uk\":\"-6.22738,49.95864,1.76303,58.67236\", \"mt\":\"14.1311,35.8161,15.5685,36.0557\", \"fr\":\"-4.79544,42.33339,8.23257,51.08938\"}\n\t\n\t\nfunction stringBBOXtoArray(strBBOX){\n\tvar _BBOX=strBBOX.split(\",\");\n\treturn _BBOX;\n}\t\n\n\nfunction treuAccentsiEspais(nomIndexacio){\n\n\tnomIndexacio=nomIndexacio.replace(/[^0-9a-zA-Z ]/g, \"\");\n\tnomIndexacio=nomIndexacio.replace(/\\s/g, \"-\");\n\nreturn nomIndexacio;\t\n\t\n}\t\n\n\n\nfunction _escriuDebug(_debug, _scope,_linia){\n\t\n\tif(_globalDebug){\t\n\t\tconsole.debug(_scope +\" Linia:\"+_linia);\n\t\tconsole.debug(_debug);\n\t\tconsole.debug(\"****************\");\n\t}\t\n\t\n}\nfunction controlarBloqueigMapa(){\n\t lockController = SessionTimeout({\n\t\t warnAfter: 28700000, //desenv: 10000,//prod: 28700000,\n\t\t redirAfter: 28800000, //desenv: 15000,//prod: 8 hores = 28800000 ms\n         ignoreUserActivity: true,\n         keepAlive: false,\n         logoutButton: window.lang.translate('Sortir'),\n         title: window.lang.translate('Desbloquejar mapa'),\n         message: window.lang.translate('Han transcorregut 8 hores des que heu iniciat la sessió de treball. Premeu \"Continuar treballant\" per mantenir-la  oberta, o \"desbloquejar\" per alliberar el mapa. '+\n        \t\t \t\t\t\t\t\t'Si no responeu, el mapa quedarà alliberat en 3 minuts.'),\n         onWarn: function(){\n         },\n         onRedir: function () {\n        \t timeoutBloqueig = window.setTimeout(\"treureBloqueigMapa()\", 28980000);//desenv: 30000); //prod: 8 hores i 3 minuts = 28980000 ms\n        \t $('#dialog_bloqueig_mapa').modal('show');   \n        \t\n         }\n   });\n}\n\nfunction treureBloqueigMapa(){\n\tvar mapData = {\n  \t\t\tbusinessId: url('?businessid'),\n  \t\t\tuid: Cookies.get('uid')\n  \t };\n\t desbloquejarMapa(mapData).then(function(results){\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\t$.when.apply(null, runningActions).done(function() {\n\t\t\t\t\tlockController.stop();\n\t\t\t\t\t$('#dialog_bloqueig_mapa').modal('hide');\n\t\t\t\t\twindow.location.href = paramUrl.galeriaPage+\"?private=1\";\n        \t\t});\n\t\t\t}\n\t});\n}\n\nfunction generarScriptMarkupGoogle(url,nom,urlImage,autor,dataPublicacio,descripcio){\n\tvar generatedScript = \"{\\\"@context\\\":\\\"http://schema.org\\\",\"+\n\t    \"\\\"@type\\\": \\\"Map\\\",\"+\n\t    \"\\\"name\\\":\\\"\"+nom+\"\\\",\"+\n\t    \"\\\"url\\\":\\\"\"+url+\"\\\",\"+\n\t    \"\\\"image\\\":\\\"\"+urlImage+\"\\\",\"+\n\t    \"\\\"thumbnailUrl\\\":\\\"\"+urlImage+\"\\\",\"+\n\t    \"\\\"author\\\": {\"+\n\t    \t\"\\\"@type\\\":  \\\"Person\\\",\"+\n\t    \t\"\\\"name\\\":\\\"\"+autor+\"\\\"\"+\n\t  \t\"},\"+\n\t   \"\\\"datePublished\\\":\\\"\"+dataPublicacio+\"\\\",\"+\n\t   \"\\\"description\\\":\\\"\"+descripcio+\"\\\"\"+\n\t\t\"}\";\n\treturn generatedScript;\n}","window.lang = new Lang();\n\nvar lsLang;\nvar Cookies = Cookies.withConverter({\n\twrite: function (value, name) {\n\t\tif ( name === 'uid' ) {\n\t\t\t//Add \" to the string because @ is only a valid Cookie character if it goes between them\n\t\t\treturn '\"' + encodeURIComponent(value + \"\").replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,\n\t\t\t\tdecodeURIComponent) + '\"';\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn value;\n\t\t}\n\t},\n\tread: function (value, name) {\n\t\tif ( name === 'uid' ) {\n\t\t\t//Add \" to the string because @ is only a valid Cookie character if it goes between them\n\t\t\treturn value.replace(/(%[0-9A-Z]{2})+/g, decodeURIComponent).replace(/\\\"/g, '');\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn value;\n\t\t}\n\t}\n});\n\njQuery(document).ready(function() {\n\t\n\n\tweball_tornarInici();\n\tlang.dynamic('en', '/geocatweb/js/language/en.json');\n\tlang.dynamic('es', '/geocatweb/js/language/es.json');\n\twindow.lang.init({\n        defaultLang: 'ca'\n    });\n\tlsLang=web_determinaIdioma();\n\tisEditing = edit = (\"mapa\" == url('filename'));\n\tif (lsLang == null || lsLang == \"null\"){\n\t\tlsLang = \"ca\";\n\t\tcanviaIdioma(lsLang);\n\t}\n\tweb_menusIdioma(lsLang);\n\t\n\tinitHover();\n\tcheckUserLogin();\n    //dialeg expired\n    jQuery('#dialog_session_expired').on('hidden.bs.modal', function (e) {\n    \tlogoutUser();\n    });\n    initCookies();\n    \n    if ($(\".centered-form\").length > 0){\n    \tcontrolLandingForm();\n    }\n    cambiarTitle();\n});\n\nfunction initCookies(){\n\twindow.cookieconsent.initialise({\n\t\tcookies: {domain: 'instamaps.cat', analytics: {}},\n\t\tposition: 'bottom',\n\t    palette:{\n\t      popup: {background: \"#222222\"},\n\t      button: {background: \"#00b050\"}\n\t    },\n\t    content: {\n    \t  message: window.lang.translate(\"Per tal de fer el seguiment de visites al nostre lloc web, utilitzem galetes. En cap cas emmagatzemem la vostra informació personal\"),\n    \t  dismiss: window.lang.translate(\"Acceptar\")\n    \t},\n\t    showLink: false,\n\t    dismissOnScroll: true,\n\t    law: {\n\t      regionalLaw: false,\n\t    }\n\t});\n}\n\nfunction controlLandingForm(){\n\t$('.centered-form').transition({ opacity: 100, delay: 600  });\n\t//intro per enviament del form\n\tjQuery(document).keypress(function(e) {\n\t    if(e.which == 13 ) {\n\t    \te.preventDefault();\n\t    \tif($(\"#landing-form-email\").is(\":focus\")){\n\t    \t\tlandingFormButtonClick(\"\");  \n\t    \t}else if($(\"#landing-form-email-xs\").is(\":focus\")){\n\t    \t\tlandingFormButtonClick(\"-xs\");  \n\t    \t}\n\t    }\n\t});\t\n    \n    $('#landing-form-email, #landing-form-email-xs').focus(function(){\n    \t$('#landing-form-message').html('');\n    \t$('#landing-form-email').removeClass(\"invalid-landing-form\");\n    \t$('#landing-form-message-xs').html('');\n    \t$('#landing-form-email-xs').removeClass(\"invalid-landing-form\");\n    });\n    \n    $('#id-btn-landing-form').on(\"click\", function(){\n    \tlandingFormButtonClick(\"\"); \n    });\n    \n    $('#id-btn-landing-form-xs').on(\"click\", function(){\n    \tlandingFormButtonClick(\"-xs\");    \t\n    });\t\n}\n\nfunction insertDataInstamaper(email){\n\tvar defer = $.Deferred();\n\t\n\tvar dataInsert = {\n\t\temail: email,\n\t\toptions: curs_instamaps\n\t};\n\tvar insert_error = \"\";\n\tregistreInstamaper(dataInsert).then(function(results){\n\t\tif (results.status==\"ERROR\") {\n\t\t\t\n\t\t\tif(results.results == \"ORA-00001\"){\n\t\t\t\tinsert_error = \" (email ja inserit un cop durant el dia d'avui a la taula INSTAMAPERS)\";\n\t\t\t\tdefer.reject(insert_error);\n\t\t\t}else{\n\t\t\t\tinsert_error = \" (email no inserit correctament a la taula INSTAMAPERS)\";\n\t\t\t\tdefer.resolve(insert_error);\n\t\t\t}\n\t\t}else{\n\t\t\tdefer.resolve(insert_error);\n\t\t}\n\t},function(results){\n\t\tinsert_error = \" (email no inserit correctament a la taula INSTAMAPERS)\";\n\t\tdefer.resolve(insert_error);\n\t});\t\n\n\treturn defer.promise();\n}\n\nfunction sendEmailInstamaper(email,insert_error, type){//type per saber si es per pantalles petites o grans\n\tvar data = {\n\t\tuid: Cookies.get('uid'),\n\t\tto: instamaps_email,// to,\n\t\tsubject: curs_instamaps,\n\t\tcontent: email + insert_error,//contingut,\n\t\tesColaboratiu: 'N',\n\t\tbusinessId: \"\"\n\t};\n\tsendMail(data).then(function(results){\n\t\tif (results.status==\"OK\") {\n\t\t\t$('#landing-form-message'+type).html(\n\t\t\t\t\t'<div class=\"alert alert-success alert-dismissible\" role=\"alert\">'+\n\t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n\t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-ok\"></span></strong> '+window.lang.translate(\"Gràcies. Prenem nota del teu correu i t'avisarem quan comencem el proper taller.\")+'</div>'\n\t\t\t);\t\t\t\t\n\t\t}\n\t\telse {\n\t\t\t$('#landing-form-message'+type).html(\n\t\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\n\t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n\t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"Hi ha hagut un problema amb l'enviament del correu. Torni a intentar-ho.\")+'</div>'\n\t\t\t);\n\t\t}\n\t},function(results){\n\t\t$('#landing-form-message'+type).html(\n\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\n\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"Hi ha hagut un problema amb l'enviament del correu. Torni a intentar-ho.\")+'</div>'\n\t\t);\n\t});\t\n\t\n}\n\nfunction landingFormButtonClick(type){\n\n\tvar email =  $('#landing-form-email'+type).val();\n\t\n\tif(isBlank(email)){\n\t\t$('#landing-form-email'+type).addClass(\"invalid-landing-form\");\n\t\t$('#landing-form-message'+type).html(\n\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\n\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"El camp no pot estar buit\")+'</div>'\n\t\t);\t\t\t\n\t}else if(!isValidEmailAddress(email)){\n\t\t$('#landing-form-email'+type).addClass(\"invalid-landing-form\");\n\t\t$('#landing-form-message'+type).html(\n\t\t\t\t'<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">'+\n\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-warning-sign\"></span></strong> '+window.lang.translate(\"El correu no és correcte\")+'</div>'\n\t\t);\t\n\t}else{\n\n    \t$('#landing-form-message'+type).html(\n    \t\t\t'<div class=\"three-quarters-loader\">'+\n    \t\t\t'  Loading…'+\n    \t\t\t'</div>'\n    \t);\n\n    \tinsertDataInstamaper(email).then(function(results){\n    \t\t\tsendEmailInstamaper(email,results, type);\n    \t\t},function(results){\n    \t\t\t$('#landing-form-message'+type).html(\n    \t\t\t\t\t'<div class=\"alert alert-success alert-dismissible\" role=\"alert\">'+\n    \t\t\t\t\t  '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'+\n    \t\t\t\t\t  '<strong><span class=\"glyphicon glyphicon-ok\"></span></strong> '+window.lang.translate(\"Gràcies. Prenem nota del teu correu i t'avisarem quan comencem el proper taller.\")+'</div>'\n    \t\t\t);\t    \t\t\t\n    \t\t}\n    \t);\n\t}\t\n}\n\nfunction initHover(){\n\t$(\"#div_V\").hover(function(){\n\t\t$(\"#img_V\").attr('src','llibreries/img/Visualitza_pujat.jpg');\n\t},function(){\n\t\t$(\"#img_V\").attr('src','llibreries/img/Visualitza_.jpg');\n\t});\n\t\n\t$(\"#div_C\").hover(function(){\n\t\t$(\"#img_C\").attr('src','llibreries/img/Crea_pujat.jpg');\n\t},function(){\n\t\t$(\"#img_C\").attr('src','llibreries/img/Crea_.jpg');\n\t});\n\t\n\t$(\"#div_E\").hover(function(){\n\t\t$(\"#img_E\").attr('src','llibreries/img/Explora_pujat.jpg');\n\t},function(){\n\t\t$(\"#img_E\").attr('src','llibreries/img/Explora_.jpg');\n\t});\n\t\n\t$(\"#div_C1\").hover(function(){\n\t\t$(\"#img_C1\").attr('src','llibreries/img/Comparteix_pujat.jpg');\n\t},function(){\n\t\t$(\"#img_C1\").attr('src','llibreries/img/Comparteix_.jpg');\n\t});\n\t\n\t/*langing geolocal*/\n\t$(\"#div_PC\").hover(function(){\n\t\t//$(\"#img_PC\").attr('src','geocatweb/img/thumb_ed_pcivil.png');\n\t\t$(this).fadeTo( 0, 0.7 );\n\t},function(){\n\t\t//$(\"#img_PC\").attr('src','geocatweb/img/thumb_ed_pcivil.png');\n\t\t$(this).fadeTo( 0, 1 );\n\t});\n\t\n\t$(\"#div_IP\").hover(function(){\n\t\t//$(\"#img_IP\").attr('src','geocatweb/img/thumb_ed_infoparcela.png');\n\t\t$(this).fadeTo( 0, 0.7 );\n\t},function(){\n\t\t//$(\"#img_IP\").attr('src','geocatweb/img/thumb_ed_infoparcela.png');\n\t\t$(this).fadeTo( 0, 1 );\n\t});\n\t\n\t$(\"#div_CC\").hover(function(){\n\t\t//$(\"#img_CC\").attr('src','geocatweb/img/thumb_ed_carrerer.png');\n\t\t$(this).fadeTo( 0, 0.7 );\n\t},function(){\n\t\t//$(\"#img_CC\").attr('src','geocatweb/img/thumb_ed_carrerer.png');\n\t\t$(this).fadeTo( 0, 1 );\n\t});\n\t\n\tjQuery('#div_PC').on('click', function(e) {\n\t\te.preventDefault();\n\t\tconsole.debug(this);\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'protecció civil']});\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=pcivil\";\n\t});\n\tjQuery('#div_IP').on('click', function(e) {\n\t\te.preventDefault();\n\t\tconsole.debug(this);\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'infoParcela']});\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=infoparcela\";\n\t});\n\tjQuery('#div_CC').on('click', function(e) {\n\t\te.preventDefault();\n\t\tconsole.debug(this);\n\t$.publish('analyticsEvent',{event:[ 'aplicacions', t_user_loginat+'carrerer']});\n\t\tdocument.location.href = paramUrl.loginGeolocalPage + \"?from=carrerer\";\n\t});\n}\n\nfunction checkUserLogin(){\n\tvar uid = Cookies.get('uid');\n\tif (uid===undefined) uid=_UsrID;\n\tvar tipusEntitat = parseInt(Cookies.get('tipusEntitat'));\n\tvar logged = false;\n\tif(!uid || isRandomUser(uid)){\n\t\t$(\"#menu_login\").show();\n\t\t$(\"#menu_user\").hide();\n\t\t$(\"#text_username\").remove();\n\t}else {\n\t\tlogged = true;\n\t\t$(\"#menu_login\").hide();\n\t\t$(\"#menu_user\").show();\t\n\t\tvar nomUser = uid.split(\"@\");\n\t\t$(\"#text_username\").text(\" \"+nomUser[0]);\n\t\t\n\t\tvar galeria_url = paramUrl.galeriaPage + \"?private=1\";\n\t\t$(\"#galeria a\").attr('href', galeria_url);\n\t\t$(\"#aplicacions a\").attr('href', galeria_url + \"&aplicacions=1\");\n\t}\n\tif($.inArray(tipusEntitat,TIPUS_ENTITATS_GEOLOCAL) != -1){\n\t\t$(\"#aplicacions\").show();\n\t}else{\n\t\t$(\"#aplicacions\").hide();\n\t}\n\t\n\tif(url('file') === \"galeria_geolocal.html\" || \n\t\turl('file') === \"sessio_geolocal.html\" ||\n\t\turl('file') === \"geolocal.html\" \n\t){\n\t\tCookies.set('perfil', 'geolocal');\n\t}else if(url('file') === \"galeria.html\" ||\n\t\turl('file') === \"sessio.html\" ||\n\t\turl('file') === \"index.html\"\n\t){\n\t\tCookies.set('perfil', 'instamaps');\n\t}\n\t\n\tif(!tipusEntitat){\n\t\tvar perfil = Cookies.get('perfil');\n\t\tswitch(perfil){\n\t\t\tcase 'instamaps':\n\t\t\t\ttipusEntitat = 1;\n\t\t\t\tbreak;\n\t\t\tcase 'geolocal':\n\t\t\t\ttipusEntitat = 2;\n\t\t\t\tbreak;\n\t\t\tdefault: tipusEntitat = 1;\n\t\t}\n\t}\n\t\n\tvar instamapsOptions = {\n\t\tuid: uid,\n\t\ttipusEntitat: tipusEntitat,\n\t\tlogged: logged\n\t};\n\tvar instamaps = Instamaps(instamapsOptions);\n\tinstamaps.changeBrand('.brand-txt').changeBrandLink('.navbar-brand')\n\t.changeGaleria('.instamaps_galeria').changeSession('.instamaps_sessio')\n\t.changeFooter('.instamaps_footer').changeContact('#hl_contact');\n}\n\nfunction web_menusIdioma(lsLang){\n\tjQuery('#ch_idioma li').each(function() {\n\t\tjQuery(this).removeClass('active');\n\t\tif (jQuery(this).attr('id') == lsLang){\n\t\t\tjQuery(this).addClass('active');\n\t\t}\n\t\tjQuery(this).click(function() {\n\t\t\tjQuery('#ch_idioma li').removeClass('active');\n\t\t\tjQuery(this).addClass('active');\n\t\t\tcanviaIdioma(jQuery(this).attr('id'));\n\t    });\n  });\n}\n\nfunction canviaIdioma(lsLang){\n\twindow.lang.change(lsLang);\n\t$(\"body\").trigger( \"change-lang\", lsLang );\n\t$.publish('change-lang',{lang: lsLang});\n}\n\nfunction web_determinaIdioma(){//Determinar idioma per paràmetre\n\tif (url('?hl')){\n\t\tvar lsLang = url('?hl');//obteValorURL(\"hl\");\n\t\twindow.lang.change(lsLang);\t\t\n\t\tjQuery(\"a[id^='hl_']\").each(function(index){\n\t\t\tvar _href=jQuery(this).attr('href');\n\t\t\t_href.indexOf('?') == -1 ? jQuery(this).attr('href',_href+'?hl='+lsLang): jQuery(this).attr('href',_href+'&hl='+lsLang);\n\t\t});\n\t}\n\telse if (Cookies.get(\"langCookie\")){\n\t\tvar lsLang = Cookies.get(\"langCookie\");\n\t\tif (lsLang != null && lsLang != \"null\"){\n\t\t\twindow.lang.change(lsLang);\n\t\t}\n\t}\n\treturn lsLang;\n}\n\nfunction web_roundCircles(){\n\tjQuery('#div_E').on('click', function() {\n\t\tdocument.location.href = \"#row_E\";\n\t});\n\tjQuery('#div_C').on('click', function() {\n\t\tdocument.location.href = \"#row_C\";\n\t});\n\tjQuery('#div_V').on('click', function() {\n\t\tdocument.location.href = \"#row_V\";\n\t});\n\tjQuery('#div_C1').on('click', function() {\n\t\tdocument.location.href = \"#row_C1\";\n\t});\n}\n\t\n\t\n\t\nfunction weball_tornarInici(){\n\t\njQuery(\"#back-top\").hide();\njQuery('#fes-mapa-inici').hide();\n\t\n\tjQuery(function () {\n\t\tjQuery(window).scroll(function () {\n\t\t\tif (jQuery(this).scrollTop() > 150) {\n\t\t\t\tjQuery('#back-top').fadeIn();\n\t\t\t\tjQuery('#fes-mapa-inici').fadeIn();\n\t\t\t} else {\n\t\t\t\tjQuery('#back-top').fadeOut();\n\t\t\t\tjQuery('#fes-mapa-inici').fadeOut();\n\t\t\t}\n\t\t});\n\n\t\tjQuery('#back-top button').click(function () {\n\t\t\tjQuery('body,html').animate({\n\t\t\t\tscrollTop: 0\n\t\t\t}, 800);\n\t\t\treturn false;\n\t\t});\n\t\tjQuery('#fes-mapa-inici').click(function () {\n\t\t\twindow.open(\"../geocatweb/mapa.html\",\"_self\");\n\t\t});\n\t});\n}\t\n\nfunction defineTipusUser(){\n\tif(!Cookies.get('uid') || Cookies.get('uid').indexOf('random')!=-1){\n\t\ttipus_user = t_user_random;\n\t}else{\n\t\ttipus_user = t_user_loginat;\n\t}\n\treturn tipus_user;\n}\n\nfunction logoutUser(){\n\tif (isRandomUser(Cookies.get('uid'))){\n\t\tdeleteRandomUser({uid: Cookies.get('uid')});\n\t}\n\tvar redirect = \"/index.html\";\n\tif(isGeolocalUser()){\n\t\tredirect = \"/geolocal.html\";\n\t}\n\tCookies.remove('uid');\n\tCookies.remove('tipusEntitat');\n\tCookies.remove('token');\n\tdoLogout().then(function(results){\n\t\tif(results.status==='OK'){\n\t\t\tCookies.remove('uid');\n\t\t\tCookies.remove('tipusEntitat');\n\t\t\tCookies.remove('token');\n\t\t\twindow.location.href=redirect;\n\t\t}else{\n\t\t\talert(\"no logout\");\n\t\t}\t\t\t\n\t},function(results){\n\t\talert(\"no logout\");\n\t\t//jQuery('#div_msg').html('<div class=\"alert alert-danger my-alert\" lang=\"ca\">No s\\'ha iniciat la sessi&oacute;. <strong>Torni a intentar.</strong></div>');\n\t});\n}\n\nfunction sessionExpired(){\n\tjQuery('#dialog_session_expired').modal('show');\n}\n\nfunction isRandomUser(user){\n\tvar isRandom = false;\n\tif (user && user.indexOf(\"random_\") != -1 && user.indexOf(\"random_\") == 0){\n\t\tisRandom = true;\n\t}\n\treturn isRandom;\n}\n\n//Funcions afegir modals\nfunction addHtmlModalMessages(){\n\tjQuery('#mapa_modals').append(\n\t\t'\t<!-- Modal messages -->'+\n\t\t'\t<div id=\"dialgo_messages\" class=\"modal fade\">'+\n\t\t'\t<div class=\"modal-dialog\">'+\n\t\t'\t\t<div class=\"modal-content\">'+\n\t\t'\t\t\t<div class=\"modal-header\">'+\n\t\t'\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t\t'\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t\t'\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">&nbsp;</h4>'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t\t<div class=\"modal-body\">'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t\t<div class=\"modal-footer\">'+\n\t\t'\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Acceptar</button>'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t</div>'+\n\t\t'\t\t<!-- /.modal-content -->'+\n\t\t'\t</div>'+\n\t\t'\t<!-- /.modal-dialog -->'+\n\t\t'</div>'+\n\t\t'<!-- fi messages -->'\n\t);\n}\n\nfunction addHtmlModalExpire(){\n\tjQuery('#mapa_modals').append(\n\t\t'\t<!-- Modal expired -->'+\n\t\t'\t<div class=\"modal fade\" id=\"dialog_session_expired\">'+\n\t\t'\t<div class=\"modal-dialog\">'+\n\t\t'\t\t<div class=\"modal-content\">'+\n\t\t'\t\t\t<div class=\"modal-header\">'+\n\t\t'\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t\t'\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t\t'\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Sessió caducada</h4>'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t\t<div lang=\"ca\" class=\"modal-body\">'+\n\t\t'\t\t\t\tHa caducat la sessió. Si vols continuar treballant torna a iniciar la sessió'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t\t<div class=\"modal-footer\">'+\n\t\t'\t\t    \t<button id=\"bt_upload_cancel\" lang=\"ca\" type=\"button\" class=\"btn\" data-dismiss=\"modal\">Acceptar</button>'+\n\t\t'\t\t    </div>'+\n\t\t'\t\t</div>'+\n\t\t'\t\t<!-- /.modal-content -->'+\n\t\t'\t</div>'+\n\t\t'\t<!-- /.modal-dialog -->'+\n\t\t'</div>'+\n\t\t'<!-- /.modal -->'+\n\t\t'<!-- fi Modal expired -->'\t\n\t);\n}\n\n\nfunction addHtmlModalLeave(){\n\tjQuery('#mapa_modals').append(\n\t\t'\t<!-- Modal Leave -->'+\n\t\t'\t\t<div id=\"dialgo_leave\" class=\"modal fade\">'+\n\t\t'\t\t<div class=\"modal-dialog\">'+\n\t\t'\t\t\t<div class=\"modal-content\">'+\n\t\t'\t\t\t\t<div class=\"modal-header\">'+\n\t\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Edició en mode demostració</h4>'+\n\t\t'\t\t\t\t</div>'+\n\t\t'\t\t\t\t<div class=\"modal-body\" lang=\"ca\">'+\n\t\t'\t\t\t\t\tPer poder guardar les dades has d\\'entrar com un usuari registrat'+\n\t\t'\t\t\t\t</div>'+\n\t\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn bt-sessio\"'+ \n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'inici sessio\\', \\'modal inici mapa\\']);\">Inicia la sessió</button>'+\n\t\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn bt_orange\"'+ \n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'registre\\', \\'modal inici mapa\\']);\">Crea un compte</button>'+\n\t\t'\t\t\t\t\t<button id=\"btn-guest\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\"'+ \n\t\t'\t\t\t\t\t\t\tonClick=\"$.publish(\\'analyticsEvent\\',{event:[\\'mapa\\', \\'guest\\', \\'modal inici mapa\\']);\">Més tard</button>'+\n\t\t'\t\t\t\t</div>'+\n\t\t'\t\t\t</div>'+\n\t\t'\t\t\t<!-- /.modal-content -->'+\n\t\t'\t\t</div>'+\n\t\t'\t\t<!-- /.modal-dialog -->'+\n\t\t'\t</div>'+\n\t\t'\t<!-- fi Modal Leave -->'\t\t\n\t);\n}\n\n\nfunction addHtmlModalOldBrowser(){\n\tjQuery('#mapa_modals').append(\n\t'\t<!-- Modal Old Browser -->'+\n\t'\t\t<div id=\"dialgo_old_browser\" class=\"modal\">'+\n\t'\t\t<div class=\"modal-dialog\">'+\n\t'\t\t\t<div class=\"modal-content\">'+\n\t'\t\t\t\t<div class=\"modal-header\">'+\n\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Sabia vostè que el seu navegador no està actualitzat?</h4>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-body\">'+\n\t'\t\t\t\t\t<div lang=\"ca\">Per aconseguir la millor experiència possible utilitzant el nostre lloc web nosaltres recomanem que vostè actualitzeu a una nova versió d\\'Internet Explorer o utilitzi un altre navegador web. Una llista dels navegadors web més populars pot ser trobada sota.</div>'+\n\t'\t\t\t\t\t<div>'+\n\t'\t\t\t\t\t<a href=\"http://www.microsoft.com/windows/Internet-explorer/default.aspx\" target=\"_blank\"><div class=\\'ie_img browser_img\\'></div></a>'+\n\t'\t\t\t\t\t<a href=\"http://www.mozilla.com/firefox/\" target=\"_blank\"><div class=\\'firefox_img browser_img\\'></div></a>'+\n\t'\t\t\t\t\t<a href=\"http://www.apple.com/safari/download/\" target=\"_blank\"><div class=\\'safari_img browser_img\\'></div></a>'+\n\t'\t\t\t\t\t<a href=\"http://www.opera.com/download/\" target=\"_blank\"><div class=\\'opera_img browser_img\\'></div></a>'+\n\t'\t\t\t\t\t<a href=\"http://www.google.com/chrome\" target=\"_blank\"><div class=\\'chrome_img browser_img\\'></div></a>'+\n\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t\t<div lang=\"ca\">Només faci clic a les icones per anar a la pàgina de descàrrega</div>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t'\t\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Continuar</button>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t<!-- /.modal-content -->'+\n\t'\t\t</div>'+\n\t'\t\t<!-- /.modal-dialog -->'+\n\t'\t</div>'+\n\t'\t<!-- fi Modal Old Browser -->'\t\t\n\t);\n}\n\nfunction isGeolocalUser(){\n\tvar isGeolocal = false;\n\t\n\t\n\tif(Cookies.get('tipusEntitat')){\n\t\tif($.inArray(parseInt(Cookies.get('tipusEntitat')),TIPUS_ENTITATS_GEOLOCAL) != -1){\n\t\t\tisGeolocal = true;\n\t\t}\n\t}\n\t\n\treturn isGeolocal;\n}\n\nfunction cambiarTitle(){\n\tif(Cookies.get('tipusEntitat')){\n\t\tif(isGeolocalUser()){\n\t\t\t$('.brand-txt').text(\"InstaMaps.GeoLocal\");\n\t\t\t$('.navbar-brand').prop('href','/geolocal.html');\n\t\t}else{\n\t\t\t$('.brand-txt').text(\"InstaMaps\");\n\t\t\t$('.navbar-brand').prop('href','/index.html');\n\t\t}\n\t}\n\telse if (typeof url('?tipus') == \"string\" && url('?tipus')==\"geolocal\"){\n\t\t$('.brand-txt').text(\"InstaMaps.GeoLocal\");\n\t\t$('.navbar-brand').prop('href','/geolocal.html');\n\t}\n}\n","/**\n * Funcionalitat compartir en xarxes socials\n */\n\nfunction addCompartirMapa(){\n\t\n\taddHtmlInterficieCompartirMapa();\n\t\n\tvar v_url = window.location.href;\n\tif (!url('?id')){\n\t\tv_url += \"&id=\"+jQuery('#userId').val();\n\t}\n\tv_url = v_url.replace('localhost',DOMINI);\n\tv_url = v_url.replace('mapa','visor');\t\n\t\n\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\n\t\n\t\n\t//Compartir en xarxes socials\n\tif (isRandomUser(Cookies.get('uid'))){\n\t\n\t\tjQuery(window).on('beforeunload',function(event){\n\t\t\treturn 'Are you sure you want to leave?';\n\t\t});\t\t\t\t\t\t\t\n\t\n\t\tjQuery('#socialShare').share({\n\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\n\t\t\ttheme: 'square'\n\t\t});\n\t\t\n\t\tjQuery('#socialShare .pop-social').off('click').on('click', function(event){\n\t\t\tevent.preventDefault();\n\t\t\tjQuery('.modal').modal('hide');\n\t\t\t$('#dialgo_messages').modal('show');\n\t\t\t$('#dialgo_messages .modal-body').html(window.lang.translate(msg_noguarda));\n\t\t});\n\t}else{\n\t\tshortUrl(v_url).then(function(results){\n\t\t\tjQuery('#socialShare').share({\n\t\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\n\t\t\t\ttheme: 'square',\n\t\t\t\turlToShare: results.id\n\t\t\t});\n\t\t\t\n\t\t\tjQuery('#socialShare .pop-social').on('click', function(event){\n//\t\t\t\tconsole.debug(\"social share click, publiquem!\");\n\t\t\t\tpublicarMapa(true);\n\t\t\t});\t\t\t\t\n\t\t});\n\t}\t\n}\n\nfunction addCompartirVisor(){\n\tvar v_url = window.location.href;\n\tif(v_url.indexOf('localhost')!=-1){\n\t\tv_url = v_url.replace('localhost',DOMINI);\n\t}\n\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\n\t\n\tshortUrl(v_url).then(function(results){\n\t\tjQuery('#socialShare_visor').share({\n\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\n\t\t\t//orientation: 'vertical',\n\t\t\t//affix: 'left center',\n\t\t\ttheme: 'square',\n\t\t\turlToShare: results.id\n\t\t});\n\t});\t\n\t\n\tjQuery('.share-square a').attr('target','_blank');\n\t\n\t/*\n\t * se declara el evento en el control \n\tjQuery(\"#dv_bt_Share\").on('click',function(e){\n\t\tposaClassActiu('#span_bt_Share');\n\t\tjQuery('#socialShare_visor').css('top', (e.clientY - 30) +'px');\n\t\tjQuery('#socialShare_visor').css('left', (e.clientX + 20) +'px');\n\t\tjQuery('#socialShare_visor').toggle();\n\t\taturaClick(e);\n\t});\n\t*/\n}\n\nfunction posaClassActiu(_element){\n\tvar cl = jQuery(_element).attr('class');\n\tif (cl.indexOf('grisfort') != -1) {\n\t\tjQuery(_element).removeClass('grisfort');\n\t\tjQuery(_element).addClass('greenfort');\n\t} else {\n\t\tjQuery(_element).removeClass('greenfort');\n\t\tjQuery(_element).addClass('grisfort');\n\t}\n}\n\nfunction addHtmlInterficieCompartirMapa(){\n\tjQuery(\"#funcio_compartir\").append(\n\t\t\t'<div id=\"socialShare\" class=\"div_gr5_social\">'+\n\t\t\t\t'<h5 lang=\"ca\">Compartir</h5>'+\n\t\t\t'</div>'\n\t);\n}","/**\n * Se encargar de agregar el ga y controlar los eventos\n * \n * require jQuery.cookie\n * require geocat.utils\n */\nvar _gaq = _gaq || [];\n \n(function() {\n\t$.subscribe('loadConfig', function(e, data){\n\t\tvar _mapConfig = data,\n\t\t\tperfil = Cookies.get('perfil');\n\t\t//Diferenciem entre usuari Geolocal i Instamaps\n\t\tif (isGeolocalUser() || $(location).attr('href').indexOf('geolocal.html') != -1 || perfil === 'geolocal') {\t  \n\t\t\t_gaq.push(['_setAccount', 'UA-46332195-6']);\n\t\t}else if (_mapConfig && _mapConfig.tipusAplicacioId == TIPUS_APLIACIO_GEOLOCAL || _mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC){\n\t\t\t_gaq.push(['_setAccount', 'UA-46332195-6']);\n\t\t}else{ \n\t\t\t_gaq.push(['_setAccount', 'UA-46332195-3']);\n\t\t}\n\t  \t$.publish('trackPageview', null);\n\n\t\t//TODO poner el subscriber\n\t\t$.publish('loadGaEvents');\n\t});\n\t\n\t$.subscribe('trackEvent', function(e, data){\n\t\tcheckIfAnalyticsLoaded(data);\n\t});\n\t\n\t$.subscribe('trackPageview', function(e, data){\n\t\t$.publish('trackPageview', null);\n\t});\n})();\n\nfunction checkIfAnalyticsLoaded(data) {\n\tif($.isArray(_gaq)){\n\t\tsetTimeout(function(){\n\t\t\tcheckIfAnalyticsLoaded(data);\n\t\t}, 500);\n\t}else{\n\t\t_gaq.push(data.event);\n\t}\n}\n \n(function() {\n\tvar ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;\n    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';\n    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);\n})();\n","var group_sortable1=null;\nvar group_sortable2=null;\n\n/**\n * Funcionalitat edicio nom del mapa\n * */\nfunction addFuncioRenameMap(){\n\t$('#nomAplicacio').editable({\n\t\ttype: 'text',\n\t\tmode: 'inline',\n\t\tvalidate: function(value) {\n\t\t\tif($.trim(value) == '') {\n\t\t\t\treturn {newValue: this.innerHTML};\n\t\t\t}\n\t\t},\n\t\tsuccess: function(response, newValue) {\n\t\t\tvar data = {\n\t\t\t\tbusinessId: url('?businessid'),\n\t\t\t \tnom: newValue,\n\t\t\t \tuid: Cookies.get('uid')\n\t\t\t}\n\t\t\tupdateMapName(data).then(function(results){\n\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'editar nom aplicacio', 'label editar nom', 1]});\n\n\t\t\t\tif(results.status=='OK'){\n\t\t\t\t\t$('#dialgo_publicar #nomAplicacioPub').val(results.results);\n\t\t\t\t\tmapConfig.nomAplicacio = results.results;\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\t$('#nomAplicacio').val(mapConfig.nomAplicacio);\n\t\t\t});\n\t\t}\n\t});\n}\n\n\n\nfunction reOrderGroupsAndLayers(action){\n\tvar z_order=-1,\n\t_groupName, \n\t_groupId, \n\t_groupSubId, \n\t_businessId, \n\t_expanded;\n\t\n\t$(\"div.leaflet-control-accordion-layers\").each(function( index, element ) {\n\t\tvar $this = $(this);\n\t\tvar gr=$this.children(\"label\").children('span.span_ac');\n\t\t_groupId=index;\n\t\t_groupName=gr.text();\n\t\tvar _exp=$this.children(\"label\").children('i.label_gl');\n\t\tvar _id=$(_exp).attr(\"id\");\n\t\t_expanded=true;\n\t\tif($('#'+_id).hasClass('glyphicon-triangle-right')){\n\t\t\t_expanded=false;\n\t\t}\n\t\t$this.children(\"ol.ac-large\").children(\"li.leaflet-row\").each(function(){\n\t\t\t$this; // parent li\n\t\t\t_businessId=this.id.replace(\"LI-\",\"\"); // child li\n\t\t\tz_order=z_order+1;\n\t\t\t\n\t\t\tif(action){\n\t\t\t\tcontrolCapes.updateTreeGroupLayers(_groupId,_groupName,_businessId,z_order,_expanded).then(function(resp_Layer){\n\t\t\t\tif(resp_Layer){\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\tbusinessId: resp_Layer.options.businessId, //url('?businessid')\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\toptions: JSON.stringify(resp_Layer.options.group)\n\t\t\t\t\t };\n\t\t\t\t\t\n\t\t\t\t\tvar data2 = {\n\t\t\t\t\t\tservidorWMSbusinessId:resp_Layer.options.businessId,\n\t\t\t\t\t\tbusinessId:url('?businessid'), //url('?businessid')\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\torder: z_order\n\t\t\t\t\t };\n\t\t\n\t\t\t\t\tupdateGroupsLayerGroup(data,data2);\n\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n}\n\nfunction updateGroupsLayerGroup(data,data2){\n\tupdateServidorWMSGroup(data).then(function(results){\n\t\tif(results.status==='OK'){\n\t\t\tif(data2){\n\t\t\t\t//TODO validar si es necesario hacer esta llamada\n\t\t\t\tupdateServerOrderToMap(data2).then(function(results) {\n\t\t\t\t\tif (results.status != 'OK')\n\t\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que\n\t\t\t\t\t\t\t\t// no es faci tampoc a client, i es\n\t\t\t\t\t\t\t\t// mostri un error\n\t\t\t\t}, function(results) {\n\t\t\t\t\treturn;// SI no ha anat be el canvi a BD. que no es\n\t\t\t\t\t\t\t// faci tampoc a client, i es mostri un\n\t\t\t\t\t\t\t// error\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t});\n}\n\nfunction refreshSortablesElements(){\n\tupdateSortablesElements();\n}\n\nfunction updateSortablesElements(){\n\tif(getModeMapa()){\n\t\tgroup_sortable1 = $(\"ol.leaflet-control-layers-overlays\").sortable({\n\t\t\tconnectWith: \"ol.leaflet-control-layers-overlays\",\n\t\t\thandle: \".label_ac\", //hadle para el drag issue 540\n\t\t\tchange: function( event, ui ) {\n\t\t\t\tsetTimeout(function(){ reOrderGroupsAndLayers(true); }, 1000);\n\t\t\t}\n\t\t});\n\n\t\tgroup_sortable2 = $(\"ol.ac-large\").sortable({\n\t\t\tconnectWith: \"ol.ac-large\",\n\t\t\tstop: function( event, ui ) {\n\t\t\t\treOrderGroupsAndLayers(true);\n\t\t\t}\n\t\t});\n\t}\n}\n\n\n/**\n * Funcionalitats edicio noms capes\n * */\nfunction updateEditableElements(){\n\t$('.label_ac .editable').editable({\n\t\ttype: 'text',\n\t\tmode: 'inline',\n\t\tvalidate: function(value) {\n\t\t\tif($.trim(value) == '') {\n\t\t\t\treturn {newValue: this.innerHTML};\n\t\t\t}\n\t\t},\n\t\tsuccess: function(response, newName) {\n\t\t\tvar oldName=this.groupName;\n\t\t\tvar resp_Layer=\tcontrolCapes.updateGroupName(oldName,newName,this.groupId);\n\t\t\tfor(i=0;i < resp_Layer.length;i++){\n\t\t\t\tvar data = {\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t \tbusinessId: resp_Layer[i].options.businessId, //url('?businessid')\n\t\t\t\t \tuid: Cookies.get('uid'),\n\t\t\t\t \toptions: JSON.stringify(resp_Layer[i].options.group)\n\t\t\t\t };\n\t\t\t\tupdateGroupsLayerGroup(data,null);\n\t\t\t}\n\t\t}\n\t});\n\n\t $('.label_ac .editable').on('shown', function(e, editable) {\n\t\t jQuery('.group-conf').hide();\n\t });\n\t\t\n\t $('.label_ac .editable').on('hidden', function(e, editable) {\n\t\t jQuery('.group-conf').show();\n\t });\n\n\t $('.leaflet-name .editable').editable({\n\t\t type: 'text',\n\t\t mode: 'inline',\n\t\t validate: function(value) {\n\t\t\t if($.trim(value) == '') {\n\t\t\t\t return {newValue: this.innerHTML};\n\t\t\t }\n\t\t },\n\t\t success: function(response, newValue) {\n\t\t\t map.closePopup();//Perque no queden desactualitzats\n\t\t\t var id = this.id;\n\t\t\t var idParent = this.idParent;\n\t\t\t //Controlem si es sublayer\n\t\t\t var editableLayer;\n\t\t\t if(idParent){\n\t\t\t\t editableLayer = controlCapes._layers[this.idParent]._layers[this.id];\n\t\t\t }else{\n\t\t\t\t editableLayer = controlCapes._layers[this.id];\n\t\t\t }\n\t\t\t var op=\"\";\n\t\t\t if(editableLayer.layer.options.tipus.indexOf(t_wms) != -1){\n\t\t\t\t op=\"##\"+ editableLayer.layer.options.opacity;\n\t\t\t }\n\t\t\t var data = {\n\t\t\t\tbusinessId: editableLayer.layer.options.businessId, //url('?businessid')\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tserverName: newValue + op\n\t\t\t };\n\t\t\t var oldName = this.innerHTML;\n\t\t\t \n\t\t\t updateServidorWMSName(data).then(function(results){\n\t\t\t\t if(results.status==='OK'){\n\t\t\t\t\t $.publish('analyticsEvent',{event:['mapa', tipus_user+'editar nom capa', 'label editar nom', 1]});\n\n\t\t\t\t\t var layerName=newValue;\t\t\t\n\t\t\t\t    \t(layerName.length > 71)?layerName=layerName.substring(0,71)+\"...\":layerName;\t\t\n\t\t\t\t    \t\n\t\t\t\t\t //editableLayer.name = newValue;\n\t\t\t\t     editableLayer.name = layerName;\t\n\t\t\t\t\t editableLayer.layer.options.nom = newValue;\n\t\t\t\t\t $('.leaflet-name label span#'+id).text(layerName);\n\t\t\t\t\t if(editableLayer.layer.options.businessId == $(\"#mapLegendEdicio\").data(\"businessid\")){\n\t\t\t\t\t\t $(\".titol-legend\").html(newValue);\n\t\t\t\t\t }\n\t\t\t\t }else{\n\t\t\t\t\t editableLayer.name = oldName;\n\t\t\t\t\t $('.leaflet-name label span#'+id).text(results.results.nom);\n\t\t\t\t }\n\t\t\t },function(results){\n\t\t\t\t editableLayer.name = oldName;\n\t\t\t\t var obj = $('.leaflet-name label span#'+id).text();\n\t\t\t\t $('.leaflet-name label span#'+id).text(oldName);\n\t\t\t });\n\t\t }\n\t });\n\n\t $('.leaflet-name .editable').on('shown', function(e, editable) {\n\t\t jQuery('.opcio-conf').hide();\n\t\t jQuery('.subopcio-conf').hide();\n\t\t jQuery('.leaflet-data-table').hide();\n\t });\n\t $('.leaflet-name .editable').on('hidden', function(e, editable) {\n\t\t jQuery('.opcio-conf').show();\n\t\t jQuery('.leaflet-data-table').show();\n\t });\n}\n\n/**\n * Funcionalitat de descarrega de capes\n * */\nfunction addFuncioDownloadLayer(from){\n\taddHtmlModalDownloadLayer(from);\n}\n\n/**\n * Funcionalitat remove layers\n **/\nfunction removeAtomicLayer(data,matriuObj){\n\tremoveServerToMap(data).then(function(results){\n\t\tif(results.status==='OK'){\n\t\t\tfor(var j=0; j < matriuObj.length;j++){\n\t\t\tvar obj=matriuObj[j];\n\t\t\tmap.closePopup();\n\t\t\tmap.removeLayer(obj.layer);\n\t\t\t//Eliminem la capa de controlCapes\n\t\t\tcontrolCapes.removeLayer(obj);\n\t\t\t//Esborrem la llegenda de la capa eliminada\n\t\t\t////emptyMapLegendEdicio(obj.layer);\n\t\t\t//actualitzem valors zindex de la resta si no es sublayer\n\t\t\tif(!obj.sublayer){\n\t\t\t\tvar removeZIndex = obj.layer.options.zIndex;\n\t\t\t\tcontrolCapes._lastZIndex--;\n\t\t\t\tvar aux = controlCapes._layers;\n\t\t\t\tfor (var i in aux) {\n\t\t\t\t\tif (aux[i].layer.options.zIndex > removeZIndex) aux[i].layer.options.zIndex--;\n\t\t\t\t}\n\t\t\t\t//Eliminem les seves sublayers en cas que tingui\n\t\t\t\tfor(indexSublayer in obj._layers){\n\t\t\t\t\tmap.removeLayer(map._layers[indexSublayer]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//Actualitzem capaUsrActiva\n\t\t\tif(capaUsrActiva!=null && capaUsrActiva.options.businessId == obj.layer.options.businessId){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t\tcapaUsrActiva = null;\n\t\t\t}\n\n\t\t\tdeleteServerRemoved(data).then(function(results){\n\t\t\t\t//se borran del listado de servidores\n\t\t\t});\n\n\t\t\t}\n\t\t}else{\n\t\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\n\t\t}\n\t},function(results){\n\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\n\t});\n}\n\nfunction addFuncioRemoveLayer(){\n\taddHtmlModalRemoveLayer();\n\taddHtmlModalRemoveGroup();\n}\n\n/**\n * Funcionalitat addToolTips Panell de capes\n **/\nfunction addTooltipsConfOptions(businessId){\n\n\t$(\".conf-\"+businessId+\".leaflet-up\").tooltip({\n\t\tplacement : 'bottom',\n\t\tcontainer : 'body',\n\t\ttitle : window.lang.translate(\"puja\")\n\t});\n\n\t$(\".conf-\"+businessId+\".leaflet-down\").tooltip({\n\t\tplacement : 'bottom',\n\t\tcontainer : 'body',\n\t\ttitle : window.lang.translate(\"baixa\")\n\t});\n\n\t$(\".conf-\"+businessId+\".leaflet-remove\").tooltip({\n\t\tplacement : 'bottom',\n\t\tcontainer : 'body',\n\t\ttitle : window.lang.translate(\"elimina\")\n\t});\n\n\t$(\".conf-\"+businessId+\".leaflet-download\").tooltip({\n\t\tplacement : 'bottom',\n\t\tcontainer : 'body',\n\t\ttitle : window.lang.translate(\"descarrega\")\n\t});\n\n\t$(\".data-table-\"+businessId+\".leaflet-data-table\").tooltip({\n\t\tplacement : 'bottom',\n\t\tcontainer : 'body',\n\t\ttitle : window.lang.translate(\"dades\")\n\t});\n}\n\nfunction addFuncioEtiquetesCapa(){\n\taddHtmlModalEtiquetesLayer();\n}\n\nfunction addHtmlModalDownloadLayer(from){\n\t$.get(\"/geocatweb/templates/modalDownloadLayer.html\",function(data){\n\t\t//TODO ver como pasar el modal container\n\t\t$('#mapa_modals').append(data);\n\t\t\n\t\t//Si la capa conté polígons no es podrà descarregar en format GPX\n\t\t$('#modal_download_layer').on('show.bs.modal', function (e) {\n\t\t\t  if(download_layer.layer.options.geometryType\n\t\t\t\t\t  && download_layer.layer.options.geometryType==t_polygon){\n\t\t\t\t  $(\"#select-download-format option[value='GPX#.gpx']\").attr('disabled','disabled');\n\t\t\t  }else{\n\t\t\t\t  $(\"#select-download-format option[value='GPX#.gpx']\").removeAttr('disabled');\n\t\t\t  }\n\n\t\t\t  //Reset the modal values\n\t\t\t  $(\"#input-download-name\").val(\"\");\n\t\t\t  $(\"#select-download-format\").val($(\"#select-download-format option:first\").val());\n\t\t\t  $(\"#select-download-epsg\").val($(\"#select-download-epsg option:first\").val());\n\t\t});\n\n\t\tjQuery('#select-download-format').change(function() {\n\t\t\tvar ext = jQuery(this).val();\n\t\t\tif ((ext==\"KML#.kml\")||(ext==\"GPX#.gpx\")){\n\t\t\tjQuery(\"#select-download-epsg\").val(\"EPSG:4326\").attr('disabled',true);\n\t\t\t}else{\n\t\t\t\tjQuery(\"#select-download-epsg\").attr('disabled',false);\n\t\t\t}\n\t\t});\n\n\t\t$('#bt_download_accept').on('click', function(evt){\n\t\t\tvar formatOUT = $('#select-download-format').val();\n\t\t\tvar epsgOUT = $('#select-download-epsg').val();\n\t\t\tvar filename = $('#input-download-name').val();\n\t\t\tvar layer_GeoJSON = download_layer.layer.toGeoJSONcustom();\n\n\t\t\tvar data = {\n\t\t\t\tcmb_formatOUT: formatOUT,\n\t\t\t\tcmb_epsgOUT: epsgOUT,\n\t\t\t\tlayer_name: filename,\n\t\t\t\tfileIN: JSON.stringify(layer_GeoJSON)\n\t\t\t};\n\n\t\t\t$.publish('analyticsEvent',{event:[from, tipus_user+'descarregar capa', formatOUT+\"-\"+epsgOUT, 1]});\n\n\t\t\tgetDownloadLayer(data).then(function(results){\n\t\t\t\tresults = results.trim();\n\t\t\t\tif (results == \"ERROR\"){\n\t\t\t\t\t$('#modal-body-download-error').show();\n\t\t\t\t\t$('#modal-body-download').hide();\n\t\t\t\t\t$('#modal_download_layer .modal-footer').hide();\n\t\t\t\t\t$('#modal_download_layer').modal('show');\n\t\t\t\t}else{\n\t\t\t\t\tvar iframe = $(\"#downloadFrame\");\n\t\t\t\t\tif(0 == iframe.length)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tiframe = $(\"<iframe/>\").attr({\n\t\t\t\t\t\t\tid: \"downloadFrame\",\n\t\t\t\t\t\t\tstyle: \"visibility:hidden;display:none\"\n\t\t\t\t\t\t}).appendTo('#modal_download_layer');\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tiframe.attr(\"src\", GEOCAT02 + results)\n\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\t$('#modal-body-download-error').show();\n\t\t\t\t$('#modal-body-download').hide();\n\t\t\t\t$('#modal_download_layer .modal-footer').hide();\n\t\t\t\t$('#modal_download_layer').modal('show');\n\t\t\t});\n\n\t\t});\n\t\t\n\t});\n}\n\nfunction addHtmlModalRemoveLayer(){\n\t$.get(\"templates/modalRemoveLayer.html\",function(data){\n\t\t//TODO ver como pasar el modal container\n\t\t$('#mapa_modals').append(data);  \n\t\t\n\t\t$('#dialog_delete_capa .btn-danger').on('click', function(event){\n\t\t\tvar $this = $(this);\n\t\t\tvar data = $this.data(\"data\");\n\t\t\tvar obj = $this.data(\"obj\");\n\t\t\tvar matriuObj=[];\n\t\t\tmatriuObj.push(obj);\n\t\t\tremoveAtomicLayer(data,matriuObj);\n\t\t});\n\t});\n}\n\nfunction addHtmlModalRemoveGroup(){\n\t$.get(\"templates/modalRemoveGroup.html\",function(data){\n\t\t//TODO ver como pasar el modal container\n\t\t$('#mapa_modals').append(data); \n\t\t\n\t\t//Esborra grup capes\n\t\t$('#dialog_delete_group .btn-danger').on('click', function(event){\n\t\t\tvar $this = $(this);\n\t\t\tvar group = $this.data(\"group\");\n\t\t\tvar matriuCapesGroup=controlCapes.getLayersFromGroupId(group.groupId,group.groupName);\n\t\t\tvar lbusinessId = [];\n\t\t\tvar matriuObj=[];\n\t\t\t\tfor(i=0; i < matriuCapesGroup.length;i++){\n\t\t\t\t\tvar obj;\n\t\t\t\t\tvar layerIdParent = matriuCapesGroup[i].layerIdParent;\n\t\t\t\t\tif(!layerIdParent){\n\t\t\t\t\t\tobj = matriuCapesGroup[i];\n\t\t\t\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t\t\t\t\tfor(j in obj._layers){\n\t\t\t\t\t\t\tlbusinessId.push(obj._layers[j].layer.options.businessId);\n\t\t\t\t\t\t}\n\t\t\t\t\t}else{\n\t\t\t\t\t\tobj =matriuCapesGroup[i];\n\t\t\t\t\t\tlbusinessId.push(obj.layer.options.businessId);\n\t\t\t\t\t}\n\t\t\t\t\tmatriuObj.push(obj);\n\t\t\t\t\tif(!obj.overlay) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(typeof url('?businessid') == \"string\"){\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tbusinessId: url('?businessid'),\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\tservidorWMSbusinessId:lbusinessId.toString()\n\t\t\t\t\t};\n\t\t\t\t\tremoveAtomicLayer(data,matriuObj);\n\t\t\t\t}\n\n\t\t\t\tcontrolCapes.removeGroup(group.groupName,group.groupId);\n\t\t});\n\t});\n}\n\nfunction addHtmlModalEtiquetesLayer(){\n\t$.get(\"templates/modalEtiquetesLayer.html\",function(data){\n\t\t//TODO ver como pasar el modal container\n\t\t$('#mapa_modals').append(data); \n\t\t\n\t\t$('#colorpalette_etiqueta').colorPalette().on('selectColor', function(e) {   \t\n\t\t\t$('#dv_color_etiqueta').css('background-color',e.color);\t\t\n\t\t});\n\t\t\n\t\t$('#colorpalette_caixa_etiqueta').colorPalette().on('selectColor', function(e) {   \t\n\t\t\t$('#dv_color_caixa_etiqueta').css('background-color',e.color);\t\t\n\t\t});\n\t\t\n\t\t/*$('#dialog_etiquetes_capa .btn-success').on('click', function (e) {\n\t\t\t\n\t\t\tif (jQuery('#dataFieldEtiqueta').val()!=undefined && jQuery('#dataFieldEtiqueta').val()==\"---\"){\n\t\t\t\talert(\"Cal escollir un camp per etiquetar\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar capaLeafletId = $('#dialog_etiquetes_capa #leafletIdCapaEtiqueta').val();\n\t\t\t\tvar capaLeafletIdControl = $('#dialog_etiquetes_capa #leafletIdCapaEtiquetaControl').val();\n\t\t\t\tvar color = rgb2hex($('.color_etiqueta').css('background-color'));\n\t\t\t\tvar zoomInicial = $( \"#slider\" ).slider( \"values\", 0 );\n\t\t\t\tvar zoomFinal = $( \"#slider\" ).slider( \"values\", 1 );\n\t\t\t\tvar options = {\n\t\t\t\t\t\tcampEtiqueta:jQuery('#dataFieldEtiqueta').val(),\n\t\t\t\t\t\tfontFamily:jQuery('#font-family').val(),\n\t\t\t\t\t\tfontSize:jQuery('#font-size').val(),\n\t\t\t\t\t\tfontStyle:jQuery('#font-style').val(),\n\t\t\t\t\t\tfontColor:color,\n\t\t\t\t\t\topcionsVis:$(\"input[name=etiqueta]:checked\").val(),\n\t\t\t\t\t\tzoomInicial:zoomInicial,\n\t\t\t\t\t\tzoomFinal:zoomFinal\n\t\t\t\t};\n\t\t\t\tvar layerMap=map._layers[capaLeafletId];\n\t\t\t\tvar optionsMap;\n\t\t\t\tif (layerMap==undefined) {\n\t\t\t\t\tlayerMap = controlCapes._layers[capaLeafletId];\n\t\t\t\t\toptionsMap=layerMap.layer.options;\n\t\t\t\t}\n\t\t\t\telse optionsMap=layerMap.options;\n\t\t\t\t\n\t\t\t\tvar data={\n\t\t\t\t\t\tbusinessId: $('#dialog_etiquetes_capa #businessIdCapaEtiqueta').val(),\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\toptions:  JSON.stringify(options),\n\t\t\t\t\t\tnom:optionsMap.nom,\n\t\t\t\t\t\ttipus:optionsMap.tipusRang,\n\t\t\t\t\t\tgeometryType:optionsMap.geometryType\n\t\t\t\t};\n\t\t\t\tupdateVisualitzacioLayer(data).then(function(results){\n\t\t\t\t\treloadVisualitzacioLayer(layerMap, results.visualitzacio, results.layer, map);\n\t\t\t\t});\n\t\t\t}\n\t\t});*/\n\t});\n}\n","/**\n * Funcionalitats d'afegir features al mapa (punts, línies poligons) i\n * edició de les seves característiques: estils, coordenades, \n * dades, capa on pertanyen...\n * */\n\nvar drawControl;\nvar featureActive,crt_Editing,crt_Remove;\nvar defaultPunt;\nvar canvas_linia={\"id\":\"cv_linia\",\"strokeStyle\":\"#FFC500\",\"lineWidth\":\"3\",\"tipus\":\"linia\",\"opacity\":\"100\"};\nvar canvas_pol={\"id\":\"cv_pol\",\"strokeStyle\":\"#FFC500\",\"opacity\":\"0.5\",\"fillStyle\":\"rgba(255, 197, 0,0.5)\",\"lineWidth\":\"3\",\"tipus\":\"pol\"};\nvar canvas_obj_l,cv_ctx_l;\nvar canvas_obj_p,cv_ctx_p;\nvar objEdicio={'esticEnEdicio':false,'obroModalFrom':'creaCapa','featureID':null,'esticSobre':false,'edicioPopup':'textFeature'};\n\nvar drawnItems = new L.FeatureGroup();\n\nfunction changeRandomDefaults(){\n\n\tvar randomColorInit=getRamdomColorFromArray();\n\tcanvas_linia.strokeStyle=randomColorInit;\n\tcanvas_pol.strokeStyle=randomColorInit;\n\tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(randomColorInit).r+\", \"+hexToRgb(randomColorInit).g+\", \"+hexToRgb(randomColorInit).b+\",0.5)\";\n\tvar colorText=getClassFromColor(randomColorInit)\t\n\tdefault_marker_style.markerColor = colorText,\n\tdefault_line_style.color=randomColorInit;\n\tdefault_area_style.color=randomColorInit;\n\tdefault_area_style.borderColor=randomColorInit;\n\tdefault_area_style.fillColor=\"rgb(\"+hexToRgb(randomColorInit).r+\", \"+hexToRgb(randomColorInit).g+\", \"+hexToRgb(randomColorInit).b+\")\";\t\n\testilP.colorGlif=\"#000000\";\n\testilP.iconFons=\"awesome-marker-web awesome-marker-icon-\"+colorText;\n\n}\n\nfunction addRandomStyleInit(){\n\n\tjQuery('#div_punt').removeClass();\n\tjQuery('#div_punt').addClass('awesome-marker-web awesome-marker-icon-'+default_marker_style.markerColor+' fa fa-');\t\n\tjQuery('#div_punt').css({\"font-size\":\"14px\", \"width\": \"28px\", \"height\": \"42px\", \"color\": \"rgb(0, 0, 0)\", \"background-color\": \"transparent\"});\t\n\tchangeDefaultLineStyle(canvas_linia);\n\tchangeDefaultPointStyle(estilP);\n\tchangeDefaultAreaStyle(canvas_pol);\n\n}\n\nfunction addDialegEstilsDraw() {\n\t\n\tchangeRandomDefaults();\n\taddHtmlInterficieDraw();\n\t\n\tjQuery('#div_mes_punts').on(\"click\", function(e) {\t\n\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaCapa);\n\t});\n\n\tjQuery('#div_mes_linies').on(\"click\", function(e) {\t\t\t\n\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaCapa);\n\t});\n\t\n\tjQuery('#div_mes_arees').on(\"click\", function(e) {\t\n\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaCapa);\n\t});\n\n\t\n\n}\n\n/**\n * Funcio que obre el menu dialeg d'estils per punts, linies i poligons\n * */\nfunction obrirMenuModal(_menuClass,estat,_from){\n\tobjEdicio.obroModalFrom=_from;\n\t//console.debug(_menuClass+\",\"+estat+\",\"+_from);\n\t//Udate dialog estils a mostrar\n\tif(_from == from_creaCapa){\n\t\t\n\t\tif(_menuClass.indexOf(\"arees\")!=-1){\n\t\t\tvar defPol = document.getElementById(\"cv_pol\").getContext(\"2d\");\n\t\t\tvar fillColor = defPol.fillStyle;\n\t\t\tif(fillColor.indexOf(\"rgb\")!=-1) fillColor = rgb2hex(defPol.fillStyle);\n\t\t\tvar icon = {color: defPol.strokeStyle,\n\t\t\t\t\t\tfillOpacity : getRgbAlpha(defPol.fillStyle),\n\t\t\t\t\t\tfillColor: fillColor,//rgb2hex(defPol.fillStyle),\n\t\t\t\t\t\tweight: defPol.lineWidth,\n\t\t\t\t\t\ttipus: t_polygon\n\t\t\t\t\t};\n\t\t\tupdateDialogStyleSelected(icon);\n\t\t\t\n\t\t}else if(_menuClass.indexOf(\"linies\")!=-1){\n\t\t\tvar defLine = document.getElementById(\"cv_linia\").getContext(\"2d\");\n\t\t\tvar icon = {color: defLine.strokeStyle,\n\t\t\t\t\t\tweight: defLine.lineWidth,\n\t\t\t\t\t\ttipus: t_polyline\n\t\t\t\t\t};\n\t\t\tupdateDialogStyleSelected(icon);\t\t\t\n\t\t\n\t\t}else{//es t_marker\n\n\t\t\t var styleProps = $(\"#div_punt\").css([\"width\",\"height\",\"color\",\"background-color\",\"font-size\"]);\n\t\t\t var punt_class = $(\"#div_punt\").attr(\"class\");\n\t\t\t \n\t\t\t console.info(punt_class);\n\t\t\t var lclass = punt_class.split(\" \");\n\t\t\t //console.debug(punt_class);\n\t\t\t //Si es punt inicial per defecte\n\t\t\t if(punt_class == \"dibuix_punt\"){\n\t\t\t\t\tvar icon = {icon: \"\",//glyph\n\t\t\t\t\t\t \ticonColor: \"#000000\",\n\t\t\t\t\t\t \tisCanvas: false,\n\t\t\t\t\t\t \tclassName: \"awesome-marker\",\n\t\t\t\t\t\t \tmarkerColor: 'orange',\n\t\t\t\t\t\t \ttipus: t_marker\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\tconsole.info(icon);\n\t\t\t\tupdateDialogStyleSelected(icon);\t\t\t\t \n\t\t\t }else if (punt_class.indexOf(\"punt_r\")!=-1){\n\t\t\t\t \t\n\n\t\t\t\t \t//Es punt sense glyphon, CANVAS\n\t\t\t\t \tif(!lclass[3] || lclass[3] === \"fa-\"){\n\t\t\t\t\t\tvar icon = {icon: \"\",//glyph\n\t\t\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\n\t\t\t\t\t\t\t\t \tfillColor: rgb2hex(styleProps[\"background-color\"]),\n\t\t\t\t\t\t\t\t \tradius: getRadiusFromMida(styleProps.width),\n\t\t\t\t\t\t\t\t \tisCanvas: true,\n\t\t\t\t\t\t\t\t \ttipus: t_marker\n\t\t\t\t\t\t};\n\t\t\t\t\t\tupdateDialogStyleSelected(icon);\n\t\t\t\t\t\t\n\t\t\t\t \t}else{//Es punt amb glyphon\n\t\t\t\t\t \tvar iconGlyph = \"\";\n\t\t\t\t\t \tif(lclass[3]) iconGlyph = lclass[3];\n\t\t\t\t\t \t\n\t\t\t\t\t \tvar font = \" font\"+styleProps[\"font-size\"].substring(0,2);\n\t\t\t\t\t\tvar icon = {icon: iconGlyph.substring(3) + font,//glyph\n\t\t\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\n\t\t\t\t\t\t\t\t \tdivColor: rgb2hex(styleProps[\"background-color\"]),\n\t\t\t\t\t\t\t\t \tisCanvas: false,\n\t\t\t\t\t\t\t\t \tmarkerColor: punt_class,\n\t\t\t\t\t\t\t\t \ttipus: t_marker\n\t\t\t\t\t\t};\n\t\t\t\t\t\tupdateDialogStyleSelected(icon);\t\t\t\t\t \t\n\t\t\t\t \t}\n\t\t\t }else{//Pintxo\n\t\t\t\tvar markerColor = (lclass[1].split(\"-\"))[3];\n\t\t\t \tvar iconGlyph = \"\";\n\t\t\t \tif(lclass[3]) iconGlyph = lclass[3];\n\t\t\t \t\n\t\t\t\tvar icon = {icon: iconGlyph.substring(3),//glyph\n\t\t\t\t\t\t \ticonColor: rgb2hex(styleProps.color),\n\t\t\t\t\t\t \tisCanvas: false,\n\t\t\t\t\t\t \tclassName: \"awesome-marker\",\n\t\t\t\t\t\t \tmarkerColor: markerColor,\n\t\t\t\t\t\t \ttipus: t_marker\n\t\t\t\t};\n\t\t\t\tupdateDialogStyleSelected(icon);\n\t\t\t }\n\t\t}\n\t}\t\n\t\n    if (jQuery.isPlainObject( _from )){\n    \tif (_from.from == tem_clasic){\n    \t\t//TODO\n    \t\t/*\n    \t\tjQuery('.fila-awesome-markers').hide();\n            activaPuntZ();\n            jQuery('#dialog_tematic_rangs').modal('hide');\n            jQuery(_menuClass).modal(estat);\n            */\n    \t}else{\n    \t\t\n\n    \t\t\n    \t\tvar layers_from = controlCapes._layers[_from.leafletid].layer.getLayers();\n        \tif( layers_from.length > num_max_pintxos || _from.tipus == t_url_file){\n                jQuery('.fila-awesome-markers').hide();\n                jQuery('#filaM').hide();\n                estilP.iconGlif = \"fa fa-\";\n                activaPuntZ();\n        \t}else{\n        \t\tjQuery('#filaM').show();\n                jQuery('.fila-awesome-markers').show();\n               \n        \t}\n        \tjQuery('.modal').modal('hide');     \n            jQuery(_menuClass).modal(estat);\n    \t}\n    }else{\n    \tjQuery('.fila-awesome-markers').show();\n    \tjQuery('#filaM').show();\n    \tjQuery('.modal').modal('hide');     \n        jQuery(_menuClass).modal(estat);\n    }\n    \n}\n\nfunction initCanvas(){\n\taddGeometryInitP(document.getElementById(canvas_pol.id),\"inicial\");\n\taddGeometryInitP(document.getElementById(canvas_pol.id+\"0\"));\n\taddGeometryInitL(document.getElementById(canvas_linia.id),\"inicial\");\t\n\taddGeometryInitL(document.getElementById(canvas_linia.id+\"0\"));\n\t\n    $('#colorpalette_pf').colorPalette().on('selectColor', function(e) {   \t\n    \t$('.fill_color_pol').css('background-color',e.color);\n        $('.fill_color_pol').css('color',e.color);\n        canvas_pol.opacity=jQuery('#cmb_trans').val();//Forcem el valor de opacity pq en Chrome no anava bé\n        canvas_pol.fillStyle=\"rgba(\"+hexToRgb(e.color).r+\", \"+hexToRgb(e.color).g+\", \"+hexToRgb(e.color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\n    });\t\n    \n    $('#colorpalette_pl').colorPalette().on('selectColor', function(e) {    \t\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\n    \t$('.border_color_pol').css('border-color',e.color);\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();//Forcem el valor de opacity pq en Chrome no anava bé\n    \tcanvas_pol.strokeStyle=e.color;\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));  \n    });\n\t\n\t$('#colorpalette_ll').colorPalette().on('selectColor', function(e) {   \t\n    $('.border_color_linia').css('background-color',e.color);\n\t\tcanvas_linia.strokeStyle=e.color;\n\t\taddGeometryInitL(document.getElementById(\"cv_linia0\"));\n\t});\n \n\t$('#colorpalette_icon').colorPalette().on('selectColor', function(e) {  \n\t\t $('.fill_color_icon').css('background-color',e.color);\n\t\t\testilP.colorGlif=e.color;\t\t\t\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\n\t\t\tif(e.color==\"#FFFFFF\"){\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\n\t\t\t}else{\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\n\t\t\t}\n\t\t\tjQuery('#div_punt0').css('color',estilP.colorGlif);\n\t\t\tjQuery(this).addClass(\"estil_selected\");\n\t});\n\t\n\n\n\t$('#colorpalette_punt').colorPalette().on('selectColor', function(e) {  \n\t\t $('.fill_color_punt').css('background-color',e.color);\t\t\t\n\t\t if(!jQuery('#div_puntZ').hasClass(\"estil_selected\")){\n\t\t\t\tactivaPuntZ();\t\t\t\t\n\t\t }else{\t\t \n\t\t\testilP.divColor=e.color;\t\t\t\t\n\t\t\tjQuery('#div_punt0').css('background-color',estilP.divColor);\n\t\t }\n\t\t    jQuery('#div_punt9').css('background-color',e.color);\t\t\n\t\t});\n\t\n\tvar options = {\n\t\t\tcolors:[['#ffc500', '#ff7f0b', '#ff4b3a', '#ae59b9', '#00afb5', '#7cbd00', '#90a6a9', '#ebf0f1']]\n\t};\n\t\n\t$('#colorpalette_marker').colorPalette(options).on('selectColor', function(e) {  \n\t\t $('.fill_color_marker').css('background-color',e.color);\t\n\t\t activaPuntM(e.color);\n\t});\t\n\n\tjQuery(\"#cmb_trans\").on('change', function(e) { \n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\n    \tcanvas_pol.opacity=jQuery(this).val();\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\n    });\n    \n    jQuery(\"#cmb_gruix\").on('change', function(e) { \n    \tcanvas_pol.lineWidth=jQuery(this).val();\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\n    \taddGeometryInitP(document.getElementById(\"cv_pol0\"));\n    });\n    \n    jQuery(\"#cmb_gruix_l\").on('change', function(e) { \n    \tcanvas_linia.lineWidth=jQuery(this).val();\n    \tvar color=rgb2hex($('.fill_color_pol').css('background-color'));\n    \tcanvas_pol.opacity=jQuery('#cmb_trans').val();\n    \tcanvas_pol.fillStyle=\"rgba(\"+hexToRgb(color).r+\", \"+hexToRgb(color).g+\", \"+hexToRgb(color).b+\",\"+jQuery('#cmb_trans').val()+\")\";\n    \taddGeometryInitL(document.getElementById(\"cv_linia0\"));\n    });\n}\n\nfunction addGeometryInitL(canvas,inicial){\n\tvar\tcv_ctx_l=canvas.getContext(\"2d\");\n\tcv_ctx_l.clearRect(0, 0, canvas.width, canvas.height);\n\tcv_ctx_l.moveTo(0.7,39.42);\n\tcv_ctx_l.lineTo(2.05,34.43);\n\tcv_ctx_l.lineTo(3.62,31.00);\n\tcv_ctx_l.lineTo(5.95,27.72);\n\tcv_ctx_l.lineTo(8.17,25.61);\n\tcv_ctx_l.lineTo(10.72,23.84);\n\tcv_ctx_l.lineTo(13.059,22.73);\n\tcv_ctx_l.lineTo(15.32,22.28);\n\tcv_ctx_l.lineTo(17.76,22.08);\n\tcv_ctx_l.lineTo(20.30,21.47);\n\tcv_ctx_l.lineTo(23.28,20.51);\n\tcv_ctx_l.lineTo(25.88,18.90);\n\tcv_ctx_l.lineTo(28.265,16.83);\n\tcv_ctx_l.lineTo(29.9,14.71);\n\tcv_ctx_l.lineTo(31.89,12.195);\n\tcv_ctx_l.lineTo(33.62,9.42);\n\tcv_ctx_l.lineTo(34.81,6.64);\n\tcv_ctx_l.lineTo(35.46,3.92);\n\tcv_ctx_l.lineTo(35.52,0.54);\n\tcv_ctx_l.strokeStyle=canvas_linia.strokeStyle;\n\tcv_ctx_l.lineWidth=canvas_linia.lineWidth;\n\tvar idLinia = canvas.id;\n\tif ((inicial==null || inicial==undefined) && idLinia=='cv_linia0'){\n\t\tcv_ctx_l.shadowColor = '#999999';\n\t\tcv_ctx_l.shadowBlur = 20;\n\t\tcv_ctx_l.shadowOffsetX = 15;\n\t\tcv_ctx_l.shadowOffsetY = 15;\n\t\tcv_ctx_l.stroke(); \t\n\t\tcv_ctx_l.shadowOffsetX = -15;\n\t\tcv_ctx_l.stroke(); \t\n\t\tcv_ctx_l.shadowOffsetY = -15;\n\t\tcv_ctx_l.stroke(); \n\t\tcv_ctx_l.shadowOffsetX = 15;\n\t}\n\tcv_ctx_l.stroke(); \t\n}\n\nfunction addGeometryInitP(canvas,inicial){\n\tvar\tcv_ctx_p=canvas.getContext(\"2d\");\n\tcv_ctx_p.clearRect(0, 0, canvas.width, canvas.height);\n\tcv_ctx_p.moveTo(5.13,15.82);\n\tcv_ctx_p.lineTo(25.49,5.13);\n\tcv_ctx_p.lineTo(37.08,13.16);\n\tcv_ctx_p.lineTo(20.66,38.01);\n\tcv_ctx_p.lineTo(2.06,33.67);\n\tcv_ctx_p.closePath();\n\tcv_ctx_p.strokeStyle=canvas_pol.strokeStyle;\n//\tconsole.debug(canvas_pol);\n\tif(canvas_pol.fillStyle.indexOf(\"rgb\")!= -1) cv_ctx_p.fillStyle = canvas_pol.fillStyle;\n\telse cv_ctx_p.fillStyle=hexToRgba(canvas_pol.fillStyle,canvas_pol.opacity );\n\t\n//\tcv_ctx_p.fillStyle=canvas_pol.fillStyle;\n\tcv_ctx_p.lineWidth=canvas_pol.lineWidth;\n//\tcv_ctx_p.opacity=canvas_pol.opacity;\n\tvar idPol = canvas.id;\n\tif ((inicial==null || inicial==undefined) && idPol=='cv_pol0'){\n\t\tcv_ctx_p.shadowColor = '#999999';\n\t\tcv_ctx_p.shadowBlur = 20;\n\t\tcv_ctx_p.shadowOffsetX = 15;\n\t\tcv_ctx_p.shadowOffsetY = 18;\t\n\t\tcv_ctx_p.fill();\n\t\tcv_ctx_p.stroke(); \n\t\tcv_ctx_p.shadowOffsetX = -15;\n\t\tcv_ctx_p.fill();\n\t\tcv_ctx_p.stroke(); \t\n\t\tcv_ctx_p.shadowOffsetY = -18;\n\t\tcv_ctx_p.fill();\n\t\tcv_ctx_p.stroke(); \n\t\tcv_ctx_p.shadowOffsetX = 15;\n\t}\n\t\tcv_ctx_p.fill();\n\t\tcv_ctx_p.stroke(); \n}\n\n//Funcio inicialitzar i afegir drawControl\nfunction addDrawToolbar() {\n\tinitCanvas();\n\t\n\tvar ptbl = L.Icon.extend({\n\t\toptions : {\n\t\t\tshadowUrl : null,\n\t\t\ticonAnchor : new L.Point(14, 40),\n\t\t\ticonSize : new L.Point(28, 40)\n\t\t}\n\t});\n\n\tdefaultPunt= L.AwesomeMarkers.icon(default_marker_style);\n\tmap.addLayer(drawnItems);\n\t\n\tvar options = {\n\t\tdraw : false,\n\t\tpolyline : {\n\t\t\tguidelineDistance : 2,\n\t\t\trepeatMode:false,\n\t\t\tshapeOptions : {\n\t\t\t\tcolor : '#FFC400',\n\t\t\t\tweight : 3,\n\t\t\t\topacity : 1,\n\t\t\t\ttipus: t_polyline\n\t\t\t},\n\t\t\tguideLayers: guideLayers\n\t\t},\n\t\tpolygon : {\n\t\t\tallowIntersection : true, // Restricts shapes\n\t\t\trepeatMode:false,\n\t\t\tguidelineDistance : 2,\t\t\t\n\t\t\tshapeOptions : {\n\t\t\t\tcolor : '#FFC400',\n\t\t\t\tfillColor: '#FFC400',\n\t\t\t\tweight : 3,\n\t\t\t\tfillOpacity : 0.5,\n\t\t\t\ttipus: t_polygon\n\t\t\t},\n\t\t\tsnapDistance: 10,\n\t\t\tguideLayers: guideLayers\n\t\t},\n\t\tmarker:{repeatMode:false,\n\t\t\ticon:L.icon({iconUrl:'/geocatweb/css/images/blank.gif'}),\t\t\n\t\t\tsnapDistance: 10,\n\t\t\tsnapVertices: false,\n\t\t\tguideLayers: guideLayers\n\t\t},\n\t\tedit :{\n\t\t    featureGroup: drawnItems, //REQUIRED!!\n\t\t    remove: false,\n\t\t    edit:false\n\t\t    }\n\t};\n\tdrawControl = new L.Control.Draw(options);\n\t\n\tmap.addControl(drawControl);\n\taddDrawTooltips();\n\taddRandomStyleInit();\n}\n\n//function showEditText(accio){\n//\tjQuery('.search-edit').animate({\n//\t\theight :accio\n//\t});\n//}\n\nfunction activaEdicioUsuari() {\n\tjQuery('#div_punt').on('click', function() {\n\t\tif(featureActive){featureActive.disable();}\n\t\tfeatureActive = new L.Draw.Marker(map, drawControl.options.marker);\t\t \n\t\tfeatureActive.enable();\n\t});\n\n\tjQuery('#div_linia').on('click', function() {\n\t\tif(featureActive){featureActive.disable();}\n\t\tfeatureActive = new L.Draw.Polyline(map, drawControl.options.polyline);\n\t\tfeatureActive.enable();\n\t});\n\n\tjQuery('#div_area').on('click', function() {\n\t\tif(featureActive){featureActive.disable();}\n\t\tfeatureActive = new L.Draw.Polygon(map, drawControl.options.polygon);\n\t\tfeatureActive.enable();\n\t});\n\n\tmap.on('draw:drawstart',function(e){\n\t\tmap.off('click',L.TileLayer.BetterWMS.getFeatureInfo);\t\t\n\t});\n\t\n\t//Edicio de feature existent\n\tmap.on('click',function(e){\n\t\tfor(var i = 0;i < guideLayers.length; i++) {\t\t\t\n\t\t\t\t\n\t\t\t\t\tif (guideLayers[i].snapediting!=undefined)  guideLayers[i].snapediting.disable();\n\t\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\n\t\t\t\ttry{\n\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.disable();\n\t\t\t\t}catch(exc){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t}\n\t\t\n\t\tif(objEdicio.esticEnEdicio){\t\t\t\n\t\t\ttry{\n\t\t\t\tupdateFeatureMove(objEdicio.featureID, crt_Editing._featureGroup._leaflet_id, objEdicio.capaEdicioLeafletId);\n\t\t\t}catch(exc){\n\t\t\t\t\n\t\t\t}\n\t\t\tif(crt_Editing){\n\t\t\t\ttry{\n\t\t\t\t\tcrt_Editing.disable();\n\t\t\t\t}catch(exc){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n//\t\t\tupdateFeatureMove(objEdicio.featureID, objEdicio.capaEdicioLeafletId);\t\t\n\t\t}\n\t\tif(crt_Editing){\n\t\t\ttry{\n\t\t\t\tcrt_Editing.disable();\n\t\t\t}catch(exc){\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t});\n\t\n\t//Controlem que si hi ha un click en un altre lloc del mapa l'edició de features es desactiva\n\t$('body').click(function(event) {\t\t\n\t\tif(objEdicio.esticEnEdicio){\n\t\t\t var target = $(event.target);\n\t\t\t for(var i = 0;i < guideLayers.length; i++) {\t\t\t\n\t\t\t\t \t\n\t\t\t\t\t\tif (guideLayers[i].snapediting!=undefined)  guideLayers[i].snapediting.disable();\n\t\t\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\n\t\t\t\t\ttry{\n\t\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.disable();\n\t\t\t\t \t}catch(exc){\n\t\t\t\t \t\t\n\t\t\t\t \t}\n\t\t\t}\n\t\t\t if(objEdicio.esticEnEdicio){\t\t\t\n\t\t\t\t\ttry{\n\t\t\t\t\t\tupdateFeatureMove(objEdicio.featureID, crt_Editing._featureGroup._leaflet_id, objEdicio.capaEdicioLeafletId);\n\t\t\t\t\t}catch(exc){\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\tif(crt_Editing){\n\t\t\t\t\t\ttry{\n\t\t\t\t\t\t\tcrt_Editing.disable();\n\t\t\t\t\t\t}catch(exc){\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n//\t\t\t\t\tupdateFeatureMove(objEdicio.featureID, objEdicio.capaEdicioLeafletId);\t\t\n\t\t\t\t}\n\t\t\n\t\t\tif(crt_Editing){\n\t\t\t\ttry{\n\t\t\t\t\tcrt_Editing.disable();\n\t\t\t\t}catch(exc){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\ttarget.click();\n\t\t}\n\t});\n\t\n\tmap.on('preclick',function(e){\n\t\tif(crt_Editing){\n\t\t\tcrt_Editing.disable();\n\t\t}\n\t});\n\t\n\t//Afegir features: point, lines and polygons\n\tmap.on('draw:created', function(e) {\n\t\tvar type = e.layerType, layer = e.layer;\n\t\tvar totalFeature;\n\t\tvar tipusCat,tipusCatDes;\n\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dibuixar geometria', type, 1]});\n\t\t//_kmq.push(['record', 'dibuixar geometria', {'from':'mapa', 'tipus user':tipus_user, 'type':type}]);\n\t\t drawnItems.addLayer(layer);\n\t\tif (type === t_marker) {\n\t\t\ttipusCat=window.lang.translate('Títol Punt');\n\t\t\ttipusCatDes=window.lang.translate('Descripció Punt');\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Punt');\n\t\t\t\n\t\t\t//Mira si és icona\n\t\t\tif(!defaultPunt.options.isCanvas){\n\t\t\t\t var divIcon = L.divIcon({ \n\t\t\t\t\t  html: \"<span style='color:blue;'>textToDisplay</span>\"\n\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\n\t\t\t\t\n\t\t\t\tlayer=L.marker([layer.getLatLng().lat,layer.getLatLng().lng],\n\t\t\t\t\t{icon: defaultPunt,isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t tipus: t_marker}).addTo(map);//.bindLabel('Look revealing label!', { noHide: true , direction: 'center',className: \"my-label\", offset: [0, 0]}).addTo(map);\n\t\t\t}else{\n\t\t\t\t//Si és cercle sense glifon\n\t\t\t\tlayer= L.circleMarker([layer.getLatLng().lat,layer.getLatLng().lng],\n\t\t\t\t\t\t{ radius : defaultPunt.options.radius, \n\t\t\t\t\t\t  isCanvas:defaultPunt.options.isCanvas,\n\t\t\t\t\t\t  fillColor : defaultPunt.options.fillColor,\n\t\t\t\t\t\t  color :  defaultPunt.options.color,\n\t\t\t\t\t\t  weight :  defaultPunt.options.weight,\n\t\t\t\t\t\t  opacity :  defaultPunt.options.opacity,\n\t\t\t\t\t\t  fillOpacity : defaultPunt.options.fillOpacity,\n\t\t\t\t\t\t  tipus: t_marker}\n\t\t\t\t\t\t\n\t\t\t\t).addTo(map);//.bindLabel('Look revealing label!', { noHide: true, direction: 'center',className: \"my-label\", offset: [0, 0] }).addTo(map);\n\t\t\t}\n\t\t\t\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_marker){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+ index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_marker\n\t\t\t\t};\t\t\t\t\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t\t\n\t\t\t}else if(capaUsrActiva == null){\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_marker\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t}\n\t\t\t\n\t\t\tlayer.properties={\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\n\t\t\t\t\t'tipusFeature':t_marker};\t\n\t\t\t\n\t\t\tlayer.properties.data={\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\n\t\t\t};\n\t\t\t/*try{\n\t\t\t\t//Active snapping\n\t\t\t\t//layer.snapediting = new L.Handler.MarkerSnap(map, layer,{snapDistance:10});\n\t\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\n\t\t\t\t        // Add every already drawn layer to snap list\n\t\t\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\n\t\t\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\n\t\t\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\n\t\t\t\t        guideLayers[i].snapediting.disable();\n\t\t\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \n\t\t\t\t }\n\t\t\t}catch(exc){\n\t\t\t\t\n\t\t\t}*/\n\t\t\t\n\t\t\t  // Add to drawnItems\n\t\t\t drawnItems.addLayer(layer);\n\t\t\t // Add newly drawn feature to list of snappable features\n\t\t\t  guideLayers.push(layer);\n\t\t    \n\t\t\tcapaUsrActiva.addLayer(layer);\n\t\t\t\n\t\t} else if (type === t_polyline) {\n\t\t\ttipusCat=window.lang.translate('Títol Línia');\n\t\t\ttipusCatDes=window.lang.translate('Descripció Línia');\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Línia');\n\t\t\t\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_polyline){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_polyline\n\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t}else if(capaUsrActiva == null){\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_polyline\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t}\n\t\t\t\n\t\t\tlayer.properties={\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\n\t\t\t\t\t'tipusFeature':t_polyline,\n\t\t\t\t\t'mida': calculateDistance(layer.getLatLngs()) };\t\n\t\t\t\n\t\t\tlayer.properties.data={\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\n\t\t\t};\t\n\t\t\t//Activate snapping\n\t\t\t/*layer.snapediting = new L.Handler.PolylineSnap(map, layer,{snapDistance:10});\n\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\n\t\t        // Add every already drawn layer to snap list\n\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\n\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\n\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\n\t\t        guideLayers[i].snapediting.disable();\n\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \n\t\t\t }*/\n\t\t\t \n\t\t\t // Add to drawnItems\n\t\t\t drawnItems.addLayer(layer);\n\t\t\t // Add newly drawn feature to list of snappable features\n\t\t\t  guideLayers.push(layer);\n\t\t   \n\t\t\tcreateClass('.polyline-style',\"font-family:Verdana;font-size:20px;color:red;\");\n\t\t\tcapaUsrActiva.addLayer(layer);\n\t\t\t\n\t\t} else if (type === t_polygon) {\n\t\t\ttipusCat=window.lang.translate('Títol Polígon');\n\t\t\ttipusCatDes=window.lang.translate('Descripció Polígon');\t\n\t\t\tvar nomDefecteCapa = window.lang.translate('Capa Polígon');\n\t\t\tvar mida = L.GeometryUtil.geodesicArea(layer.getLatLngs());\n\t\t\tmida = L.GeometryUtil.readableArea(mida,true);\n\t\t\t\n\t\t\tif(capaUsrActiva != null && capaUsrActiva.options.geometryType != t_polygon){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_polygon\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\t\t\t\t\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t}else if(capaUsrActiva == null){\n\t\t\t\tcapaUsrActiva = new L.FeatureGroup();\n\t\t\t\tvar index = parseInt(controlCapes._lastZIndex)+1;\n\t\t\t\tcapaUsrActiva.options = {\n\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\tnom : nomDefecteCapa+' '+index,\n\t\t\t\t\tzIndex :  -1,\n//\t\t\t\t\ttipus : t_tematic,\n\t\t\t\t\ttipus : t_visualitzacio,\n\t\t\t\t\tgeometryType: t_polygon\n\t\t\t\t};\n\t\t\t\tmap.addLayer(capaUsrActiva);\n\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\n\t\t\t}\n\t\t\tlayer.properties={\n\t\t\t\t\t'capaNom':capaUsrActiva.options.nom,//TODO desactualitzat quan es canvii nom capa!\n\t\t\t\t\t'capaBusinessId':capaUsrActiva.options.businessId,\n\t\t\t\t\t'capaLeafletId': capaUsrActiva._leaflet_id,\n\t\t\t\t\t'tipusFeature':t_polygon,\n\t\t\t\t\t'mida': calculateArea(layer)};\n\t\t\t\n\t\t\tlayer.properties.data={\n\t\t\t\t\t'nom':tipusCat+' '+capaUsrActiva.getLayers().length,\n\t\t\t\t\t'text':tipusCatDes+' '+capaUsrActiva.getLayers().length,\n\t\t\t};\t\t\n\t\t\t//Activate snapping\n\t\t\t/*layer.snapediting = new L.Handler.PolylineSnap(map, layer,{snapDistance:10});\n\t\t\tfor(var i = 0;i < guideLayers.length; i++) {\n\t\t        // Add every already drawn layer to snap list\n\t\t        layer.snapediting.addGuideLayer(guideLayers[i]);\n\t\t        // Add the currently drawn layer to the snap list of the already drawn layers\n\t\t        guideLayers[i].snapediting.addGuideLayer(layer);\n\t\t        guideLayers[i].snapediting.disable();\n\t\t        if (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \n\t\t\t }\n\t\t\t*/\n\t\n\t\t\t  // Add to drawnItems\n\t\t\t drawnItems.addLayer(layer);\n\t\t\t // Add newly drawn feature to list of snappable features\n\t\t\tguideLayers.push(layer);\n\t\t\tcapaUsrActiva.addLayer(layer);\t\t\t\n\t\t}\n\t});\n\t\n}\n\n//Funcio que crea Pop up de la feature quan te opcio d'edicio\nfunction createPopupWindow(layer,type){\n//\tconsole.debug('createPopupWindow');\n\tvar html = createPopUpContent(layer,type);\n\tlayer.bindPopup(html,{'offset':[0,-25]});\n\t\n\t//eventos del popup\n\tjQuery(document).on('click', \"#titol_pres\", function(e) {\n\t\tmodeEditText();\n\t});\n\t\n\tjQuery(document).on('click', \"#des_pres\", function(e) {\n\t\tmodeEditText();\n\t});\n\n\tjQuery(document).on('click', \".bs-ncapa li a\", function(e) {\n\t\te.preventDefault();\n\t\tvar accio;\n\t\tif(jQuery(this).attr('id').indexOf('#')!=-1){\t\t\t\n\t\t\taccio=jQuery(this).attr('id').split(\"#\");\t\t\t\t\n\t\t}\n\t\t\n\t\tobjEdicio.featureID=accio[1];\n\t\tif(accio[0].indexOf(\"layer_edit\")!=-1){\n\t\t\tobjEdicio.edicioPopup='textCapa';\n\t\t\tjQuery('#layer_accio').text(window.lang.translate('Canviar el nom de la capa'))\n\t\t\tjQuery('#capa_edit').val(jQuery('#cmbCapesUsr').val());\n\t\t\tmodeLayerTextEdit();\n\n\t\t}else if(accio[0].indexOf(\"layer_add\")!=-1){\n\t\t\tobjEdicio.edicioPopup='nouCapa';\n\t\t\tjQuery('#layer_accio').text(window.lang.translate('Nom nova capa'))\n\t\t\tjQuery('#capa_edit').val(\"\").attr('placeholder',window.lang.translate('Nova capa'));\n\t\t\tmodeLayerTextEdit();\n\t\t}else{\n\t\t\t\n\t\t}\n\t});\n\t\n\t jQuery(document).on('focus', \".bs-ncapa li select\", function(e) {\n\t\t $(this).data('cmbCapesUsr_old',$(this).val());\n\t });\t \n\t \n\t jQuery(document).on('change', \".bs-ncapa li select\", function(e) {\n\t\t    e.stopImmediatePropagation();\n\t\t    \n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\t\t    \n//\t\t    console.debug('on change select cmbusrcapa');\n\t\t\tvar accio;\n\t\t\tif(jQuery(this).attr('id').indexOf('-')!=-1){\t\t\t\n\t\t\t\taccio=jQuery(this).attr('id').split(\"-\");\t\t\t\t\n\t\t\t}\n\t\t\tobjEdicio.featureID=accio[1];\n\t\t\t\t\t\t\n\t\t\tvar toBusinessId = jQuery(this).val().split(\"#\");\n\t\t\tvar fromBusinessId = $(this).data('cmbCapesUsr_old').split(\"#\");\n\t\t\t//Actualitzem valor antic\n\t\t\t$(this).data('cmbCapesUsr_old',$(this).val());\n\t\t\t\n\t\t\tobjEdicio.featureID=accio[1];\n\t\t\tvar obj = map._layers[objEdicio.featureID];\n\t\t\t\n\t\t\t\n\t\t\t/*NOU MODEL*/\n\t\t\tvar features = {\n\t\t\t\t\ttype: obj.properties.tipusFeature,\n\t\t\t\t\tid:3124,\n\t\t\t\t\tbusinessId: obj.properties.businessId,//Bid de la geometria q estas afegint\n\t\t\t\t\tproperties: obj.properties.data,\n\t\t\t\t\testil: obj.properties.estil,\n\t\t\t\t\tgeometry: obj.properties.feature.geometry\n\t\t\t\t};\n\t\t\t\n\t\t\tfeatures = JSON.stringify(features);\n\t\t\t\n\t\t\tdata= {\n\t\t\t\ttoBusinessId: toBusinessId[0],//bID de la visualitzacio-capa\n\t\t\t\tfromBusinessId: fromBusinessId[0],//bID de la visualitzacio-capa\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tfeatures: features\n\t\t\t}\t\n\t\t\t\n\t\t\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\n//\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\n\t\t\t\tif(resultsMove.status === 'OK'){\n\t\t\t\t\tvar toLayer = controlCapes._layers[''+toBusinessId[1]+''].layer;//map._layers[''+toBusinessId[1]+''];\n\t\t\t\t\tvar fromLayer = map._layers[''+fromBusinessId[1]+''];\n\t\t\t\t\tfromLayer.removeLayer(obj);\n\t\t\t\t\t//Actualitzem capa activa\n\t\t\t\t\t//Primer desactivo l'event, per si la capaActiva coincideix amb la capa toLayer\n\t\t\t\t\tif(toLayer) toLayer.removeEventListener('layeradd');\n\t\t\t\t\t\n\t\t\t\t\ttoLayer.addLayer(obj);\n\t\t\t\t\t//Refresh de la capa\n\t\t\t\t\tcontrolCapes._map.removeLayer(toLayer);\n\t\t\t\t\tcontrolCapes._map.addLayer(toLayer);\t\t\t\t\t\n\t\t\t\t\tcapaUsrActiva = toLayer;\n\t\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tobj.properties.capaBusinessId = capaUsrActiva.options.businessId;\n\t\t\t\t\tobj.properties.capaNom = capaUsrActiva.options.nom;\n\t\t\t\t\tobj.properties.capaLeafletId = capaUsrActiva._leaflet_id;\n\t\t\t\t\tobj.properties.estil.businessId = resultsMove.estilBid;\n\t\t\t\t\t//Actualitzem popup del marker\n\t\t\t\t\t//var html = createPopUpContent(obj,obj.options.tipus);\n\t\t\t\t\t//obj.setPopupContent(html);\n\t\t\t\t\t\n\t\t\t\t\tvar nom=resultsMove.results.properties.nom;\n\t\t\t\t\tvar props=resultsMove.results.properties;\n\t\t\t\t\tvar html = refrescarPopUp(nom,props,obj._leaflet_id,obj.properties.tipusFeature,obj.properties.capaLeafletId);\n\t\t\t\t\tmap.closePopup();\n\t\t\t\t\tobj.closePopup();\n\t\t\t\t\tconsole.debug(obj);\n\t\t\t\t\tobj.bindPopup(html,{'offset':[0,-25]});\t\t\t\t\t\n\t\t\t\t\tobj.openPopup();\n\t\t\t\t\tvar toLayer1 = controlCapes._layers[''+toBusinessId[1]+''];\n\t\t\t\t\t\n\t\t\t\t\tactualitzacioTematic(toLayer1,toLayer.options.businessId,\"3124\",obj,features,\"modificacio\");\n\t\t\t\n\t\t\t\t\t//Actualitzem l'enllaç d'obrir la finestra de dades\n\t\t\t\t\tvar htmlDataTable =jQuery(\"#feature_data_table_\"+accio[1]).html();\n\t\t\t\t\tif (undefined != htmlDataTable){\n\t\t\t\t\t\tvar stringsDataTableA = htmlDataTable.split(\"##\");\n\t\t\t\t\t\tjQuery(\"#feature_data_table_\"+accio[1]).html(stringsDataTableA[0]+\"##\"+stringsDataTableA[1]+\"##\"+stringsDataTableA[2]+\"##\"+toLayer._leaflet_id+\"##\"+stringsDataTableA[4]);\n\t\t\t\t\t}\n\t\t\t\t\t//NO CAL: com cridem addLayer, de controlCapes, ja s'actualitzen els comptadors de les capes\n\t\t\t\t\t//updateFeatureCount(fromBusinessId, toBusinessId);\t\t\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t\t\t});\t\t\t\t\t\n\t });\n\t \n\tjQuery(document).on('click', \".bs-popup li a\", function(e) {\n\t\te.stopImmediatePropagation();\n\t\tvar accio;\n\t\tif(jQuery(this).attr('id').indexOf('#')!=-1){\t\t\t\n\t\t\tif (jQuery(this).attr('id').indexOf('##')>-1) accio=jQuery(this).attr('id').split(\"##\");\t\t\t\n\t\t\telse accio=jQuery(this).attr('id').split(\"#\");\t\t\t\t\n\t\t}\n\t\tobjEdicio.featureID=accio[1];\n\t\t\n\t\tif(accio[0].indexOf(\"feature_edit\")!=-1){\n\n\t\t\t//Update modal estils, amb estil de la feature seleccionada\n\t\t\tvar obj = map._layers[accio[1]];\n\t\t\tif(obj.options.icon /*|| obj.options.icon.options.markerColor.indexOf(\"punt_r\")!=-1*/){\n\t\t\t\tvar icon = obj.options.icon.options;\t\n\t\t\t}else if(obj._options){\n\t\t\t\tvar icon = obj._options;\n\t\t\t}else{\n\t\t\t\tvar icon = obj.options;\n\t\t\t}\n\t\t\t\n\t\t\n\t\t\tupdateDialogStyleSelected(icon);\n\n\t\t\t\n\t\t\tif(accio[2].indexOf(\"marker\")!=-1){\n\t\t\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaPopup);\n\t\t\t}else if(accio[2].indexOf(\"polygon\")!=-1){\n\t\t\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaPopup);\n\t\t\t}else{\n\t\t\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaPopup);\n\t\t\t}\n\t\t}else if(accio[0].indexOf(\"feature_remove\")!=-1){\n\t\t\tmap.closePopup();\n\t\t\tvar data = {\n\t            businessId: map._layers[objEdicio.featureID].properties.businessId,\n\t            uid: Cookies.get('uid')\n\t        };\n\t\t\t\n\t\t\tvar features = {\n\t\t\t\t\ttype:\"Feature\",\n\t\t\t\t\tid: 3124,\n\t\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.businessId,\n\t\t\t\t\tproperties: map._layers[objEdicio.featureID].properties.data,\n\t\t\t\t\testil: map._layers[objEdicio.featureID].properties.estil,\n\t\t\t\t\tgeometry: map._layers[objEdicio.featureID].properties.feature.geometry\n\t\t\t\t};\t\t\t\t\n\t\t\t\n\t\t\tfeatures = JSON.stringify(features);\n\t\t\t\n\t\t\tvar data = {\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.capaBusinessId,//bID de la visualitzacio-capa\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tfeatures: features\n\t\t\t};\n\t\t\tvar businessIdCapaOrigen=map._layers[objEdicio.featureID].properties.capaBusinessId;\n\t\t\tremoveGeometriaFromVisualitzacio(data).then(function(results){\n\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t/*var capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\n\t\t\t\t\t//Actualitzem comptador de la capa\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) updateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\n\t\t\t\t\telse {\t\t\t\t\t\t\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\n\t\t\t\t\t}*/\n\t\t\t\t\t\n\t\t\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) {\n\t\t\t\t\t\tupdateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\n\t\t\t\t\t}\n\t\t\t\t\telse {\t\t\t\t\t\t\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\n\t\t\t\t\t}\t\t\n\t\t\t\t\t var layer = controlCapes._layers[capaLeafletId];\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\n\t\t\t\t\tactualitzacioTematic(layer,businessIdCapaOrigen,null,null,null,\"baixa\");\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\n\t\t\t});\t\t\n\t\t\t\n\t\t}else if(accio[0].indexOf(\"feature_text\")!=-1){\n\t\t\tmodeEditText();\n\t\t}else if(accio[0].indexOf(\"feature_move\")!=-1){\n\t\t\tobjEdicio.esticEnEdicio=true;\n\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\n\t\t\tif (capaLeafletId==undefined) capaLeafletId =  map._layers[objEdicio.featureID]._leaflet_id;\n\t\t\tobjEdicio.capaEdicioLeafletId = capaLeafletId;\n\t\t\t//Actualitzem capa activa\n\t\t\tif (capaUsrActiva){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t}\n\t\t\tcapaUsrActiva = map._layers[capaLeafletId];\n\t\t\tvar capaEdicio = new L.FeatureGroup();\n\t\t\tcapaEdicio.addLayer(map._layers[objEdicio.featureID]);\n\t\t\t\n\t\t\ttry{\n\t\t\t\tcapaUsrActiva.removeLayer(map._layers[objEdicio.featureID]);\n\t\t\t}\n\t\t\tcatch(ex){\n\t\t\t\t\n\t\t\t}\n\t\t\tmap.addLayer(capaEdicio);\n\t\t\t\n\t\t\tvar opcionsSel={\n\t\t\t\t\tcolor: '#FF1EE5',\n\t\t\t\t\t\"weight\": 7,\n\t\t\t\t\topacity: 0.6,\n\t\t\t\t\tdashArray: '1, 1',\n\t\t\t\t\tfill: true,\n\t\t\t\t\tfillColor: '#fe57a1',\n\t\t\t\t\tfillOpacity: 0.1\n\t\t\t\t};\n\t\t\t\n\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\n\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\tselectedPathOptions: opcionsSel\n\t\t\t});\n\t\t\tcrt_Editing.enable();\n\t\t\n\t\t\n\t\t/*\tif(map._layers[objEdicio.featureID].properties.tipusFeature==\"marker\" && map._layers[objEdicio.featureID].options.isCanvas){\n\t\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\n\t\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\t\tselectedPathOptions: opcionsSel\n\t\t\t\t});\n\t\t\t\tcrt_Editing.enable();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcrt_Editing=new L.EditToolbar.SnapEdit(map, {\n\t\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\t\tselectedPathOptions: opcionsSel,\n\t\t\t\t\tsnapOptions: {\n\t\t\t\t\t\tguideLayer: guideLayers\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tcrt_Editing.enable();\n\t\t\t\t//activarSnapping(capaEdicio);\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t*/\n\t\t\t\n\t\t\t\n\t\t\tmap.closePopup();\n\t\t\t\n\t\t\t\n\t\t}else if(accio[0].indexOf(\"feature_no\")!=-1){\n\t\t\tjQuery('.popup_pres').show();\n\t\t\tjQuery('.popup_edit').hide();\n\t\t\t\n\t\t}else if(accio[0].indexOf(\"feature_ok\")!=-1){\n\t\t\tif(objEdicio.edicioPopup=='textFeature'){\n\t\t\t\tvar txtTitol=jQuery('#titol_edit').val();\n\t\t\t\tvar txtDesc=jQuery('#des_edit').val();\n\t\t\t\tif (txtDesc.indexOf(\"'\")>-1) txtDesc = txtDesc.replaceAll(\"'\",'\"');\n\t\t\t\tupdateFeatureNameDescr(map._layers[objEdicio.featureID],txtTitol,txtDesc);\n\n\t\t\t}else if(objEdicio.edicioPopup=='textCapa'){\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\n\t\t\t\t\tjQuery('#cmbCapesUsr option:selected').text(jQuery('#capa_edit').val());\t\n\t\t\t\t\tjQuery('.popup_pres').show();\n\t\t\t\t\tjQuery('.popup_edit').hide();\n\t\t\t\t}else{\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\n\t\t\t\t}\n\t\t\t}else if(objEdicio.edicioPopup=='nouCapa'){\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\n\t\t\t\t\tgeneraNovaCapaUsuari(map._layers[objEdicio.featureID],jQuery('#capa_edit').val());\n\t\t\t\t}else{\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\n\t\t\t\t}\n\t\t\t}\n\t\t}else if(accio[0].indexOf(\"feature_data_table\")!=-1){\n\t\t\t$('#modal_data_table').modal('show');\n\t\t\tvar featureId=objEdicio.featureID;\n\t\t\tif (featureId==undefined) featureId=accio[2];\n\t\t\t\n\t\t\tif (map._layers[featureId]==undefined) {\n\t\t\t\ttry{\n\t\t\t\t\tif (accio[6]!=undefined) featureId=accio[6];\n\t\t\t\t\tvar props=map._layers[featureId].properties;\n\t\t\t\t\tif (props==undefined) props=map._layers[featureId].options;\n\t\t\t\t\tif (accio[3]==undefined)  fillModalDataTable(controlCapes._layers[accio[2]],props.businessId);\n\t\t\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],props.businessId);\n\t\t\t\t}\n\t\t\t\tcatch(err){\n\t\t\t\t\t$.publish('analyticsEvent',{event:['erro', 'feature_data_table',err]});\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],map._layers[featureId].properties.businessId);\n\t\t\n\t\t\n\t\t}else{\n\t\t//accio tanca\n\t\t\tmap.closePopup();\n\t\t}\n\t});\t\n\n\tlayer.on('popupopen', function(e){\n\t\tif(objEdicio.esticEnEdicio){//Si s'esta editant no es pot editar altre element\n\t\t\tmap.closePopup();\n\t\t}else{\n\t\t\t//actualitzem popup\n\t\t\tjQuery('#cmbCapesUsr-'+layer._leaflet_id+'-'+layer.options.tipus+'').html(reFillCmbCapesUsr(layer.options.tipus, layer.properties.capaBusinessId));\n\t\t\tif (layer.properties.data.nom){\n\t\t\t\tjQuery('#titol_pres').text(layer.properties.data.nom).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t}\n\t\t\tif (layer.properties.data.text){\n\t\t\t\tvar txt = layer.properties.data.text;\n\t\t\t\t\n\t\t\t\tif (!$.isNumeric(txt) && !validateWkt(txt)) {\n\t\t\t\t\ttxt = parseUrlTextPopUp(txt,\"\");\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\n\t\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t\t\t}else{\n\t\t\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\n\t\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+layer.properties.data.text+'</span>');\n\t\t\t\t\tjQuery('#des_pres').text(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t\t}\n\t\t\t\t\n\t\t\t}\n\n\t\t\tif(layer.properties.mida)\t\n\t\t\t{\n\n\t\t\t\tvar text = window.lang.translate(\"Longitud\");\n\t\t\t\tif(layer.properties.tipusFeature == t_polygon)\n\t\t\t\t{\n\n\t\t\t\t\ttext = window.lang.translate(\"Àrea\");\n\n\t\t\t\t}\n\n\t\t\t\t$(\"#mida_pres\").html(\"<b>\" + text + \":</b> \" + layer.properties.mida);\n\n\t\t\t}\n\t\t}\n\t});\n\n\treturn html;\n}\n\nfunction reFillCmbCapesUsr(type, businessIdCapa){\n\tvar html = \"\";\n\t$.each( controlCapes._layers, function(i,val) {\n\t\tvar layer = val.layer.options;\n\t\tif(layer.tipus==t_tematic && layer.geometryType==type ){\n\t        html += \"<option value=\\\"\";\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\n\t        if(businessIdCapa == layer.businessId) html += \" selected\";\n\t        html += \">\"+ layer.nom + \"</option>\";            \t\t\n\t\t}else if(layer.tipus==t_visualitzacio && layer.geometryType==type ){\n\t        html += \"<option value=\\\"\";\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\n\t        if(businessIdCapa == layer.businessId) html += \" selected\";\n\t        html += \">\"+ layer.nom + \"</option>\";            \t\t\n\t\t}\n\t});\t\t\n\treturn html;\n}\n\n\nfunction objecteUserAdded(f){\n\t\n\tvar fId = this.toGeoJSON().features.length;\n\t\n\tvar feature = f.layer.toGeoJSON();\n\t\n//\t//Invertim lng,lat perque es recuperi be desde el servidor despres\n//    if(f.layer.options.tipus == t_marker){\n//          var lng = feature.geometry.coordinates[0]\n//          feature.geometry.coordinates[0] = feature.geometry.coordinates[1];\n//          feature.geometry.coordinates[1] = lng;         \n//    }else if(f.layer.options.tipus==t_polyline){\n//          for(var i=0;i<feature.geometry.coordinates.length;i++){\n//                var lng = feature.geometry.coordinates[i][0]\n//                feature.geometry.coordinates[i][0] = feature.geometry.coordinates[i][1];\n//                feature.geometry.coordinates[i][1] = lng;\n//          }\n//    }else if(f.layer.options.tipus==t_polygon){\n//          var lcoordinates = [];\n//          $.each( feature.geometry.coordinates[0], function(i,val) {\n//                lcoordinates.push([val[1], val[0]]);\n//          }); \n//          feature.geometry.coordinates[0] = lcoordinates;                  \n//    }       \n\n\tfeature.properties.data = f.layer.properties.data;    \t\n\n\tvar features = JSON.stringify(feature);\n\n\tvar rangsJSON = getFeatureStyle(f,fId);\n\tvar rangs = JSON.stringify(rangsJSON);\n\t\n\tif (fId == 1) {\n\t\t\n\t\tvar _this = this;\n\t\t\n\t\t/*NOU MODEL: Crear nova visualització*/\n\t\tvar data ={\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tnom: f.layer.properties.capaNom,\n\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\tgeometryType: f.layer.options.tipus,\n//\t\t\t\t\ttipus : tem_origen,//no cal, per defecte li posa origen a servidor\n//\t\t\t\t\tcalentas: false,\n//\t\t\t\t\torder: controlCapes._lastZIndex+1,\n\t\t\t\tactivas: true,\n\t\t\t\tvisibilitats: true,\t\t\t\t\n\t\t\t\tpublica : true\n\t\t};\t\t\n\t\t\n\t\tcreateVisualitzacioLayer(data).then(function(results) {\n\t\t\t\n\t\t\tif(results.status === 'OK'){\n\t\t\t\t\n\t\t\t\t_this.options.businessId = results.results.businessId;\n\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\n\t\t\t\t//Ara afegim nova geometria\n\t\t\t\tvar features = {\n\t\t\t\t\t\ttype:f.layer.options.tipus,\n\t\t\t\t\t\tid:fId,\n\t\t\t\t\t\tproperties: feature.properties.data,\n\t\t\t\t\t\testil: rangsJSON,\n\t\t\t\t\t\tgeometry: feature.geometry\n\t\t\t\t\t};\n\t\t\t\t\n\t\t\t\tfeatures = JSON.stringify(features);\t\t\t\t\n\t\t\t\t\n\t\t\t\tdata = {\n\t\t\t\t\t\tbusinessId: f.layer.properties.capaBusinessId,//Bid de la visualitzacio\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\tfeatures: features,\n\t\t\t\t\t\tgeometryType: f.layer.options.tipus,\n\t\t\t\t\t\toptions: \"text,nom\"\n//\t\t\t\t\t\t\tgeometriaBusinessId: '4c216bc1cdd8b3a69440b45b2713b014'//Bid de la geometria q estas afegint\t\t\t\t\t\t\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\taddGeometriaToVisualitzacio(data).then(function(results) {\n\t\t\t\t\tif(results.status === 'OK'){\n\t\t\t\t\t\n//\t\t\t\t\t\t\t_this.options.businessId = results.results.businessId;\n//\t\t\t\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\n\t\t\t\t\t\tf.layer.properties.businessId = results.feature.businessId;\n\t\t\t\t\t\tf.layer.properties.estil = results.results.estil[0];\n\t\t\t\t\t\tf.layer.properties.feature = results.feature;\t\n\t\t\t\t\t\tfinishAddFeatureToTematic(f.layer);\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\n\t\t\t\t\t}\n\t\t\t\t},function(results){\n\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\n\t\t\t\t});\n\t\t\t\t\n\t\t\t}else{//ERROR: control Error\n\t\t\t\tconsole.debug('createVisualitzacioLayer ERROR');\n\t\t\t}\n\t\t},function(results){//ERROR: control Error\n\t\t\tconsole.debug('createVisualitzacioLayer ERROR');\n\t\t});\t\t\t\n\n\t} else if (this.getLayers().length > 1) {\n\t\n\t\tvar features = {\n\t\t\t\ttype:f.layer.options.tipus,\n\t\t\t\tid:fId,\n\t\t\t\tproperties: feature.properties.data,\n\t\t\t\testil: rangsJSON,\n\t\t\t\tgeometry: feature.geometry\n\t\t\t};\n\t\tfeatures = JSON.stringify(features);\t\t\t\t\n\t\t\n\t\tdata = {\n\t\t\t\tbusinessId: this.options.businessId,//f.layer.properties.capaBusinessId,//Bid de la visualitzacio\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tfeatures: features\n//\t\t\t\t\tgeometriaBusinessId: '4c216bc1cdd8b3a69440b45b2713b014'//Bid de la geometria q estas afegint\t\t\t\t\t\t\n\t\t};\t\t\n\t\tvar businessIdCapaOrigen = data.businessId;\n\t\taddGeometriaToVisualitzacio(data).then(function(results) {\n\t\t\tif(results.status === 'OK'){\n\t\t\t\t\n//\t\t\t\t\t_this.options.businessId = results.results.businessId;\n//\t\t\t\t\tf.layer.properties.capaBusinessId = results.results.businessId;\n\t\t\t\tf.layer.properties.businessId = results.feature.businessId;\n\t\t\t\tf.layer.properties.estil = results.results.estil[0];\n\t\t\t\tf.layer.properties.feature = results.feature;\n\t\t\t\tfinishAddFeatureToTematic(f.layer);\t\t\n\t\t\t\t\n\t\t\t\tvar capaEdicio = controlCapes._layers[capaUsrActiva._leaflet_id];\n\t\t\t\tif (capaEdicio!=undefined) {\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\n\t\t\t\t\tactualitzacioTematic(capaEdicio,businessIdCapaOrigen,fId,f,features,\"alta\");\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\n\t\t\t}\n\t\t},function(results){\n\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\n\t\t});\t\t\t\n\t}\n}\n\nfunction getFeatureStyle(f, fId){\n\tvar rangs = {};\n\t//ESTIL MARKER\n\tif(f.layer.options.tipus == t_marker){\n\t\tif (!f.layer._ctx && f.layer.options.icon!= undefined){\n\t\t\trangs = {\n\t\t\t\tcolor : f.layer.options.icon.options.fillColor,//Color principal\n\t\t\t\tmarker: f.layer.options.icon.options.markerColor,//Si es de tipus punt_r o el color del marker\n\t\t\t\tsimbolColor: f.layer.options.icon.options.iconColor,//Glyphon\n\t\t\t\tradius : f.layer.options.icon.options.radius,//Radius\n\t\t\t\ticonSize : f.layer.options.icon.options.iconSize.x+\"#\"+f.layer.options.icon.options.iconSize.y,//Size del cercle\n\t\t\t\ticonAnchor : f.layer.options.icon.options.iconAnchor.x+\"#\"+f.layer.options.icon.options.iconAnchor.y,//Anchor del cercle\n\t\t\t\tsimbol : jQuery.trim(f.layer.options.icon.options.icon),//tipus glyph\n\t\t\t\tsimbolSize : f.layer.options.icon.options.simbolSize,//mida glyphon\n//\t\t\t\tpuntTMP.options.symbolSize = style.symbolSize;//mida glyphon\n\t\t\t\topacity : (f.layer.options.opacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000',\n\t\t\t};\n\t\t}else{\n\t\t\trangs = {\n\t\t\t\tcolor : f.layer.options.fillColor,\n\t\t\t\tsimbolSize : f.layer.options.radius,\n\t\t\t\topacity : (f.layer.options.fillOpacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000',\n\t\t\t\tborderWidth : f.layer.options.weight,\n\t\t\t\tborderColor : f.layer.options.color,\n\t\t\t};\n\t\t}\n\t//ESTIL LINE\n\t}else if(f.layer.options.tipus == t_polyline){\n\t\trangs = {\n\t\t\tcolor : f.layer.options.color,\n\t\t\tlineWidth : f.layer.options.weight,\n\t\t\tlineStyle : 'solid',\n\t\t\tborderWidth : 2,\n\t\t\tborderColor : f.layer.options.color,\n\t\t\topacity : (f.layer.options.opacity * 100),\n\t\t\tlabel : false,\n\t\t\tlabelSize : 10,\n\t\t\tlabelFont : 'arial',\n\t\t\tlabelColor : '#000000',\n\t\t};\t\n\t//ESTIL POLIGON\t\t\n\t}else{\n\t\tvar fillColor = f.layer.options.color;\n\t\tif(f.layer.options.fillColor) fillColor = rgb2hex(f.layer.options.fillColor);\t\n\t\tvar fillOpacity = f.layer.options.fillOpacity;\n\t\trangs = {\n\t\t\t\tcolor : fillColor,\n\t\t\t\tfillColor: fillColor,\n\t\t\t\tfillOpacity: fillOpacity,\n\t\t\t\tlineWidth : f.layer.options.dashArray,\n\t\t\t\tlineStyle : 'solid',\n\t\t\t\tborderWidth : f.layer.options.dashArray,\n\t\t\t\tborderColor : f.layer.options.color,\n\t\t\t\topacity : (f.layer.options.fillOpacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000'\n\t\t\t};\t\t\t\t\n\t}\n\treturn rangs;\n}\n\n\nfunction getFeatureStyle2(estil,tipus){\n\tvar rangs = {};\n\t//ESTIL MARKER\n\tif( tipus == t_marker){\n\t\tif (estil.icon!= undefined){\n\t\t\trangs = {\n\t\t\t\tcolor : estil.icon.options.fillColor,//Color principal\n\t\t\t\tmarker:estil.icon.options.markerColor,//Si es de tipus punt_r o el color del marker\n\t\t\t\tsimbolColor:estil.icon.options.iconColor,//Glyphon\n\t\t\t\tradius :estil.icon.options.radius,//Radius\n\t\t\t\ticonSize :estil.icon.options.iconSize.x+\"#\"+estil.icon.options.iconSize.y,//Size del cercle\n\t\t\t\ticonAnchor :estil.icon.options.iconAnchor.x+\"#\"+estil.icon.options.iconAnchor.y,//Anchor del cercle\n\t\t\t\tsimbol : jQuery.trim(estil.icon.options.icon),//tipus glyph\n\t\t\t\tsimbolSize : estil.icon.options.simbolSize,//mida glyphon\n//\t\t\t\tpuntTMP.options.symbolSize = style.symbolSize;//mida glyphon\n\t\t\t\topacity : (estil.opacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000',\n\t\t\t\tbusinessId: estil.businessId\n\t\t\t};\n\t\t}else{\n\t\t\trangs = {\n\t\t\t\tcolor : estil.fillColor,\n\t\t\t\tsimbolSize : estil.radius,\n\t\t\t\topacity : (estil.fillOpacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000',\n\t\t\t\tborderWidth : estil.weight,\n\t\t\t\tborderColor : estil.color,\n\t\t\t\tbusinessId: estil.businessId\n\t\t\t};\n\t\t}\n\t//ESTIL LINE\n\t}else if(tipus == t_polyline){\n\t\trangs = {\n\t\t\tcolor : estil.color,\n\t\t\tlineWidth : estil.weight,\n\t\t\tlineStyle : 'solid',\n\t\t\tborderWidth : 2,\n\t\t\tborderColor : estil.color,\n\t\t\topacity : (estil.opacity * 100),\n\t\t\tlabel : false,\n\t\t\tlabelSize : 10,\n\t\t\tlabelFont : 'arial',\n\t\t\tlabelColor : '#000000',\n\t\t\tbusinessId: estil.businessId\n\t\t};\t\n\t//ESTIL POLIGON\t\t\n\t}else{\n\t\tvar fillColor = estil.color;\n\t\tif(estil.fillColor) fillColor = rgb2hex(estil.fillColor);\t\n\t\tvar fillOpacity = estil.fillOpacity;\n\t\trangs = {\n\t\t\t\tcolor : fillColor,\n\t\t\t\tfillColor: fillColor,\n\t\t\t\tfillOpacity: fillOpacity,\n\t\t\t\tlineWidth : estil.dashArray,\n\t\t\t\tlineStyle : 'solid',\n\t\t\t\tborderWidth : estil.dashArray,\n\t\t\t\tborderColor : estil.color,\n\t\t\t\topacity : (estil.fillOpacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000',\n\t\t\t\tbusinessId: estil.businessId\n\t\t\t};\t\t\t\t\n\t}\n\treturn rangs;\n}\n\nfunction finishAddFeatureToTematic(layer){\n\t\n\tvar type = layer.options.tipus;\n\t//Afegir capa edicio a control de capes en cas que sigui nova\n\tif (capaUsrActiva.toGeoJSON().features.length == 1 ) {\n\t\t//Actualitzem zIndex abans d'afegir al control de capes\n\t\tcapaUsrActiva.options.zIndex = controlCapes._lastZIndex+1; \t\t\t\t\t\t\t\t\n\t\tcontrolCapes.addOverlay(capaUsrActiva,\tcapaUsrActiva.options.nom, true);\n\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t}else{\n\t\t\t//Actualitzem comptador de la capa\n\t\t\tupdateFeatureCount(null, capaUsrActiva.options.businessId);\n\t}\n\t\t\n\tcreatePopupWindow(layer,type);\n\tlayer.openPopup();\n\tmap.eachLayer(function(layer) {\n\t\tif (layer.options\n\t\t\t\t&& layer.options.tipus == \"wms\") {\n\t\t\tmap.on('click',layer.getFeatureInfo,layer);\n\t\t}\n\n\t});\n}\n\nfunction updateFeatureNameDescr(layer, titol, descr){\n\t\n\tlayer.properties.data.nom=titol;\n\tlayer.properties.data.text=descr;\n\t\n//\t//VELL!!\n//\tif(!nou_model){\n//\t\tif (layer.properties.feature.properties){\n//\t\t\tlayer.properties.feature.properties.nom = titol;\n//\t\t\tlayer.properties.feature.properties.text = descr;\n//\t\t}\n//\t\t\t\n//\t\tvar feature = layer.toGeoJSON();\n//\t\tfeature.geometry = layer.properties.feature.geometry;\n//\t\t//CAL???\n//\t\tif (layer.properties.feature.properties){\t\n//\t\t\tfeature.properties = layer.properties.feature.properties;\n//\t\t}else{\n//\t\t\t//Obsolet a nou model\n//\t\t\tfeature.properties = layer.properties;\n//\t\t\t//\n//\t\t}\t\t\n//\t}\n\n\tvar features = {\n\t\t\ttype: layer.properties.tipusFeature,\n\t\t\tid:3124,\n\t\t\tbusinessId: layer.properties.businessId,//Bid de la geometria q estas afegint\n\t\t\tproperties: layer.properties.data,\n\t\t\testil: layer.properties.estil,\n\t\t\tgeometry: layer.properties.feature.geometry\n\t\t};\n\t\n\tfeatures = JSON.stringify(features);\n\t\n    var data = {\n            uid : Cookies.get('uid'),\n            features : features,\n            businessId: layer.properties.businessId\n        };      \t\n\t\n    \n    updateGeometria(data).then(function(results){\n\t    if(results.status == 'OK'){\n\t\t\tjQuery('#titol_pres').text(titol).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\tvar txt = descr;\t\t\t\n\t\t\tif (!$.isNumeric(txt) && !validateWkt(txt)) {\n\t\t\t\ttxt = parseUrlTextPopUp(txt,\"\");\n\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\n\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t\t}else{\n\t\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\n\t\t\t\t\tjQuery('#des_pres').append(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#des_pres').html('');\n\t\t\t\tjQuery('#des_pres').append('<span id=\"descrText\" style=\"display:none;\">'+descr+'</span>');\n\t\t\t\tjQuery('#des_pres').text(txt).append(' <i class=\"glyphicon glyphicon-pencil blau\"></i>');\n\t\t\t}\n\t\t\t\n\t\t\tjQuery('.popup_pres').show();\n\t\t\tjQuery('.popup_edit').hide();   \n\t\t\t\t\t\t\n\t\t\t//recarrego les sublayers de la capa modificada\n\t\t\tvar capaEdicio = controlCapes._layers[layer.properties.capaLeafletId];\n\t\t\tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,\"3124\",null,features,\"modificacioInfo\");\n\t    }else{\n\t        console.debug(\"updateGeometria ERROR\");\n\t    }\n\t}, function(results){\n\t\t  console.debug(\"updateGeometria ERROR\");\n\t}); \t\t\n        \n}\n\nfunction updateFeatureMove(featureID, capaEdicioID, capaEdicioLeafletId){\n\t\n    var layer = map._layers[featureID];\n    \n    var feature = layer.toGeoJSON();\n    \n    feature.geometry = layer.properties.feature.geometry;      \n        \n    if(layer.properties.tipusFeature == t_marker){\n        var newLatLng = layer.getLatLng();\n        feature.geometry.coordinates[1] = newLatLng.lat;\n        feature.geometry.coordinates[0] = newLatLng.lng;           \n    }else{\n\t    var lcoordinates = [];\n\t    $.each(layer._latlngs, function(i,val) {\n\t    \tlcoordinates.push([val.lng, val.lat]);\n\t    });              \n\t    if(layer.properties.tipusFeature == t_polyline){\n\t    \tfeature.geometry.coordinates = lcoordinates;\n\t    \tlayer.properties.mida = calculateDistance(layer.getLatLngs());\n\t    }else{\n\t    \tlcoordinates.push(lcoordinates[0]);\n\t    \tfeature.geometry.coordinates[0] = lcoordinates;\n\t    \tlayer.properties.mida = calculateArea(layer);\n\t    }\n    }\n\t\n\tvar features = {\n\t\t\ttype: layer.properties.tipusFeature,\n\t\t\tid:3124,\n\t\t\tbusinessId: layer.properties.businessId,//Bid de la geometria q estas afegint\n\t\t\tproperties: layer.properties.data,\n\t\t\testil: layer.properties.estil,\n\t\t\tgeometry: feature.geometry\n\t\t};\n\tfeatures = JSON.stringify(features);\n\t\n    var data = {\n            uid : Cookies.get('uid'),\n            features : features,\n            businessId: layer.properties.businessId\n        };      \t\n\t\n    updateGeometria(data).then(function(results){\n\t    if(results.status == 'OK'){\n\t    \tif (layer.properties.tipusFeature==\"marker\" && layer.properties.data.nom &&  layer.properties.data.text) createPopupWindow(layer,\"marker\");\n\t    \tjQuery('.popup_pres').show();\n\t    \t//Actualitzem visualitzacions de la capa on estava la geometria modificada\n\t    \tvar capaEdicio = controlCapes._layers[capaEdicioLeafletId];\n\t    \t//recarrego les sublayers de la capa modificada\t\n\t    \tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,null,null,null,\"baixa\");\n\t\t\t/*jQuery.each(capaEdicio._layers, function(i, sublayer){\n            \tif(jQuery.type(sublayer.layer.options)== \"string\"){\n\t\t\t\t\tsublayer.layer.options = $.parseJSON(sublayer.layer.options);\n\t\t\t\t}\t            \t  \n\t\t\t\t//Sublayer visualitzacio, carrego la capa\n\t\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\n            \t\t  \n            \t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\n            \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\n            \t\t  sublayer.layer.capesActiva = \"true\";\n            \t\t  sublayer.layer.options.origen = layer.properties.capaBusinessId;//BusinessIdCapaorigen\n            \t\t  //tipusRang\n            \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\n            \t\t  sublayer.layer.options = JSON.stringify(sublayer.layer.options);\n            \t\t  loadVisualitzacioLayer(sublayer.layer).then(function(results){\n            \t\t\t//console.debug(\"LoadVisualitzacio despres de update Geometria\"); \n\t\t\t\t\t\tmap.closePopup();\n\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\n\t\t\t\t\t\t//Eliminem la capa de controlCapes\n\t\t\t\t\t\tcontrolCapes.removeLayer(sublayer);\n            \t\t  });\n            \t  }\n            \t\n              });*/\n\t    \n\t    \t\n\t    }else{\n\t        console.debug(\"updateFeature ERROR\");\n\t    }\n\t}, function(results){\n\t\t  console.debug(\"updateFeature ERROR\");\n\t});      \t\n  \n    //Retornem la geometria a la seva capa original\n    capaUsrActiva.addLayer(layer);\n    capaUsrActiva.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\n    map._layers[capaEdicioID].removeLayer(layer);\n    //Refresh de la capa\n    controlCapes._map.removeLayer(capaUsrActiva);\n\tcontrolCapes._map.addLayer(capaUsrActiva);\n\tmap.removeLayer(map._layers[capaEdicioID]);\n    \n    //Fi edicio\n    objEdicio.esticEnEdicio=false;\n}\n\nfunction fillCmbCapesUsr(type){\n\tvar html = \"\";\n\t$.each( controlCapes._layers, function(i,val) {\n\t\tvar layer = val.layer.options;\n\t\tif(layer.tipus==t_tematic && layer.geometryType==type ){\n\t        html += \"<option value=\\\"\";\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\n\t        if(capaUsrActiva && (capaUsrActiva.options.businessId == layer.businessId)) html += \" selected\";\n\t        html += \">\"+ layer.nom + \"</option>\";\n\t    //nou model    \n\t\t}else if(layer.tipus==t_visualitzacio && layer.geometryType==type /*&& !layer.source*/){\n\t        html += \"<option value=\\\"\";\n\t        html += layer.businessId +\"#\"+val.layer._leaflet_id+\"\\\"\";\n\t        if(capaUsrActiva && (capaUsrActiva.options.businessId == layer.businessId)) html += \" selected\";\n\t        html += \">\"+ layer.nom + \"</option>\";\n\t\t}\n\t});\t\t\n\treturn html;\n}\n\nfunction createPopUpContent(player,type){\n\t\n\tvar auxNom = window.lang.translate('Nom');\n\tvar auxText = window.lang.translate('Descripció');\n\tvar auxLon,auxLat;\n\tif(player.properties.data.nom) auxNom = player.properties.data.nom;\n\tif(player.properties.data.text) auxText = player.properties.data.text;\n\tif (player.options.tipus==\"marker\" && player._latlng) {\n\t\tauxLat = player._latlng.lat;\n\t\tauxLat= auxLat.toFixed(5);\n\t\tauxLon = player._latlng.lng;\n\t\tauxLon= auxLon.toFixed(5);\n\t}\n\tvar html='<div class=\"div_popup\">' \n\t+'<div class=\"popup_pres\">'\t\t\t\t\t\t\t\n\t+'<div id=\"titol_pres\">'+auxNom+' <i class=\"glyphicon glyphicon-pencil blau\"></i></div>'\t\n\t+'<div id=\"des_pres\">'+auxText+' <i class=\"glyphicon glyphicon-pencil blau\"></i></div>';\n\t\n\tif (player.options.tipus==\"marker\" && auxLat!=undefined && auxLon!=undefined) {\n\t\thtml+='<div id=\"auxLat\">'+auxLat+'</div>'\n\t\t+'<div id=\"auxLon\">'+auxLon+'</div>';\n\t}\n\n\t\n\tif(type == t_polyline && player.properties.mida){\n\t\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Longitud')+':</b> '+player.properties.mida+'</div>';\t\n\t}else if(type == t_polygon && player.properties.mida){\n\t\tif (player.properties.mida.indexOf(\"NaN\")==-1)\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+player.properties.mida+'</div>';\n\t\telse html+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+L.GeometryUtil.readableArea(L.GeometryUtil.geodesicArea(player.getLatLngs()),true)+'</div>';\n\t}\n\t\n\t//+'<div id=\"capa_pres\">'\n\thtml+='<ul class=\"bs-ncapa\">'\n\t\t+'<li><span lang=\"ca\" class=\"small\">'+window.lang.translate('Capa actual:')+'</span>'\n\t\t\t+'<select id=\"cmbCapesUsr-'+player._leaflet_id+'-'+type+'\" data-leaflet_id='+player._leaflet_id+'>';\n\t\t\thtml+= fillCmbCapesUsr(type);\n\t\t\thtml+= '</select></li>'\n\t\t//+'<li><a id=\"layer_edit#'+player._leaflet_id+'#'+type+'\" lang=\"ca\" title=\"Canviar el nom de la capa\" href=\"#\"><span class=\"glyphicon glyphicon-pencil blau12\"></span></a></li>'\n\t+'<li><a id=\"layer_add#'+player._leaflet_id+'#'+type+'\" lang=\"ca\" title=\"Crear una nova capa\" href=\"#\"><span class=\"glyphicon glyphicon-plus verd12\"></span></a></li>'\n\t+'</ul>'\t\n\t//'</div>'\t\n\t+'<div id=\"footer_edit\"  class=\"modal-footer\">'\n\t\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\n\t\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>';\n\t\n\tif (player.properties.estil) {\n\t\thtml+='<li class=\"edicio-popup\" id=\"feature_data_table_'+player._leaflet_id+'\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+player.properties.capaLeafletId+'##\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>';\t\t\t\t\t\n\t}\n\telse {\n\t\thtml+='<li class=\"edicio-popup\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span>  </li>';\t\t\t\t\t\n\t}\n\t\n\thtml+='<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#finestrapunt\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>';\n\t\n\thtml+='</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t+'</div>'\n\t\n\t+'</div>'\t\n\t+'<div class=\"popup_edit\">'\n\t+'<div style=\"display:block\" id=\"feature_txt\">'\n\t+'<input class=\"form-control\" id=\"titol_edit\" type=\"text\" value=\"'+auxNom+'\" placeholder=\"\">'\n\t+'<textarea id=\"des_edit\" class=\"form-control\" rows=\"2\">'+auxText+'</textarea>'\t;\n\tif (player.options.tipus==\"marker\" && auxLat!=undefined && auxLon!=undefined) {\n\t\thtml+='<input class=\"form-control\" id=\"lat\" type=\"text\" value=\"'+auxLat+'\" placeholder=\"\" disabled>'\n\t\t+'<input class=\"form-control\" id=\"lon\" type=\"text\" value=\"'+auxLon+'\" placeholder=\"\" disabled>';\n\t}\n\thtml+='</div>'\t\n\t+'<div  style=\"display:block\" id=\"capa_txt\">'\n\t+'<div id=\"layer_accio\"></div>'\n\t+'<input class=\"form-control\" id=\"capa_edit\" type=\"text\" value=\"'+player.properties.capaGrup+'\" placeholder=\"\">'\n\t+'</div>'\n\t+'<div class=\"modal-footer\">'\n\t+'<ul class=\"bs-popup\">'\n\t+'<li><a id=\"feature_no##'+player._leaflet_id+'##'+type+'\"  class=\"btn btn-default btn-xs\">'+window.lang.translate('Cancel·lar')+'</a></li>'\t\t\t\n\t+'<li><a id=\"feature_ok##'+player._leaflet_id+'##'+type+'\"  class=\"btn btn-success btn-xs\">'+window.lang.translate('Acceptar')+'</a></li>'\t\t\t\t\t\t\t\t\n\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t+'</div>'\t\t\t\t\t\t\t\t\n\t+'</div>'\t\t\t\t\t\t\t\t\n\t+'</div>';\n\treturn html;\n}\n\nfunction generaNovaCapaUsuari(feature,nomNovaCapa){\n\t\n\t/*NOU MODEL: Crear nova visualització*/\n\tvar data ={\n\t\t\tuid: Cookies.get('uid'),\n\t\t\tnom: nomNovaCapa,\n\t\t\tmapBusinessId: url('?businessid'),\n\t\t\tgeometryType: feature.properties.tipusFeature,\n//\t\t\t\ttipus : tem_origen,//no cal, per defecte li posa origen a servidor\n//\t\t\t\tcalentas: false,\n//\t\t\t\torder: controlCapes._lastZIndex+1,\n\t\t\tactivas: true,\n\t\t\tvisibilitats: true,\t\t\t\t\n\t\t\tpublica : true\t\t\t\t\n\t};\t\t\n\t\n\tcreateVisualitzacioLayer(data).then(function(results){\n//\t\t\t\n\t\tif(results.status === 'OK'){\n\t\t\t\n\t\t\tcapaUsrActiva2= new L.FeatureGroup();\n\t\t\tcapaUsrActiva2.options = {\n\t\t\t\tbusinessId : results.results.businessId,\n\t\t\t\tnom : nomNovaCapa,\n//\t\t\t\ttipus: t_tematic,\n\t\t\t\ttipus: t_visualitzacio,\n\t\t\t\tgeometryType : feature.properties.tipusFeature\n//\t\t\t\t\tzIndex : controlCapes._lastZIndex//+1\t\t\n\t\t\t};\n\t\t\t//Afegim nova capa al combo\n\t\t\tjQuery('#cmbCapesUsr-'+feature._leaflet_id+'-'+feature.properties.tipusFeature+'').append(\"<option selected value=\\\"\"+results.results.businessId+\"\\\">\"+nomNovaCapa+\"</option>\");\t\n\t\t\tjQuery('.popup_pres').show();\n\t\t\tjQuery('.popup_edit').hide();\n\t\t\t\n\t\t\tmap.addLayer(capaUsrActiva2);\n\t\t\tcapaUsrActiva2.options.zIndex = controlCapes._lastZIndex+1;\n\t\t\tcontrolCapes.addOverlay(capaUsrActiva2,\tcapaUsrActiva2.options.nom, true);\n\t\t\tcontrolCapes._lastZIndex++;\n\t\t\tactivaPanelCapes(true);\t\t\t\n\t\t\t\n\t\t\tvar features = {\n\t\t\t\t\ttype: feature.properties.tipusFeature,\n\t\t\t\t\tid:3124,\n\t\t\t\t\tbusinessId: feature.properties.businessId,//Bid de la geometria q estas afegint\n\t\t\t\t\tproperties: feature.properties.data,\n\t\t\t\t\testil: feature.properties.estil,\n\t\t\t\t\tgeometry: feature.properties.feature.geometry\n\t\t\t\t};\n\t\t\t\n\t\t\tfeatures = JSON.stringify(features);\n\t\t\t\n\t\t\tdata= {\n\t\t\t\ttoBusinessId: results.results.businessId,//'4c216bc1cdd8b3a69440b45b2713b000',//bID de la visualitzacio-capa\n\t\t\t\tfromBusinessId: feature.properties.capaBusinessId,//'4c216bc1cdd8b3a69440b45b2713b001',//bID de la visualitzacio-capa\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tfeatures: features\n\t\t\t}\t\n\t\t\t\n\t\t\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\n\t\t\t\tif(resultsMove.status === 'OK'){\n\t\t\t\t\tvar layer=feature._leaflet_id;\n\t\t\t\t\tif(capaUsrActiva) capaUsrActiva.removeLayer(feature);\n\t\t\t\t\tcapaUsrActiva2.addLayer(feature);//.on('layeradd', objecteUserAdded);\n\t\t\t\t\t//feature.openPopup();\n\t\t\t\t\t//Actualitzem capa activa\n\t\t\t\t\tif(capaUsrActiva) capaUsrActiva.removeEventListener('layeradd');\n\t\t\t\t\tcapaUsrActiva = capaUsrActiva2;//map._layers[capaUsrActiva2._leaflet_id];;\n\t\t\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\n\t\t\t\t\t//Actualitzem properties de la layer\n\t\t\t\t\tfeature.properties.capaBusinessId = capaUsrActiva.options.businessId;\n\t\t\t\t\tfeature.properties.capaNom = capaUsrActiva.options.nom;\t\n\t\t\t\t\tfeature.properties.capaLeafletId = capaUsrActiva._leaflet_id;\n\t\t\t\t\tfeature.properties.estil.businessId = resultsMove.estilBid;\n\t\t\t\t\t//Actualitzem popup del marker\n//\t\t\t\t\t\tvar html = createPopUpContent(feature,feature.options.tipus);\n\t\t\t\t\t//feature.setPopupContent(html);\n\t\t\t\t\tmap.closePopup();\n\t\t\t\t\tfeature.openPopup();\n\t\t\t\t\t\n\t\t\t\t\t//update rangs\n\t\t\t\t    //getRangsFromLayer(capaUsrActiva);\n\t\t\t\t    \n\t\t\t\t\t//Actualitzem comptador de la capa\n\t\t\t\t    updateFeatureCount(data.fromBusinessId, data.toBusinessId);\t\t\n\t\t\t\t    \n\t\t\t\t    //actualitzacioTematic(toLayer1,toLayer.options.businessId,\"3124\",obj,features,\"modificacio\");\n\t\t\t\t  //Actualitzem l'enllaç d'obrir la finestra de dades\n\t\t\t\t    console.debug(layer);\n\t\t\t\t   var htmlDataTable =jQuery(\"#feature_data_table_\"+layer).html();\n\t\t\t\t\tvar stringsDataTableA = htmlDataTable.split(\"##\");\n\t\t\t\t\tjQuery(\"#feature_data_table_\"+layer).html(stringsDataTableA[0]+\"##\"+stringsDataTableA[1]+\"##\"+stringsDataTableA[2]+\"##\"+capaUsrActiva._leaflet_id+\"##\"+stringsDataTableA[4]);\n\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t\t\t});\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"createVisualitzacioLayer ERROR\");\n\t\t}\n\t});\t\t\n\n}\n\nfunction moveFeatureToLayer(feature_businessId,layer_fromBusinessId,layer_toBusinessId){\n\n\t/*NOU MODEL*/\n\tvar features = {\n\t\t\ttype: feature.options.tipus,\n\t\t\tid:3124,\n\t\t\tbusinessId: feature.properties.businessId,//Bid de la geometria q estas afegint\n\t\t\tproperties: feature.properties.feature.properties,\n\t\t\testil: feature.properties.estil,\n\t\t\tgeometry: feature.properties.feature.geometry\n\t\t};\n\t\n\tfeatures = JSON.stringify(features);\n\t\n\tdata= {\n\t\ttoBusinessId: results.results.businessId,//'4c216bc1cdd8b3a69440b45b2713b000',//bID de la visualitzacio-capa\n\t\tfromBusinessId: feature.properties.capaBusinessId,//'4c216bc1cdd8b3a69440b45b2713b001',//bID de la visualitzacio-capa\n\t\tuid: Cookies.get('uid'),\n\t\tfeatures: features\n\t}\t\n\t\n\tmoveGeometriaToVisualitzacio(data).then(function(resultsMove) {\n\t\tconsole.debug(\"moveGeometriaToVisualitzacio:\"+ resultsMove.status);\n\t\tif(resultsMove.status === 'OK'){\n\t\t\t\n\t\t\tif(capaUsrActiva) capaUsrActiva.removeLayer(feature);\n\t\t\tcapaUsrActiva2.addLayer(feature);//.on('layeradd', objecteUserAdded);\n\t\t\t//feature.openPopup();\n\t\t\t//Actualitzem capa activa\n\t\t\tif(capaUsrActiva) capaUsrActiva.removeEventListener('layeradd');\n\t\t\tcapaUsrActiva = capaUsrActiva2;//map._layers[capaUsrActiva2._leaflet_id];;\n\t\t\tcapaUsrActiva.on('layeradd',objecteUserAdded);\t\n\t\t\t//Actualitzem properties de la layer\n\t\t\tfeature.properties.capaBusinessId = capaUsrActiva.options.businessId;\n\t\t\tfeature.properties.capaNom = capaUsrActiva.options.nom;\t\n\t\t\tfeature.properties.capaLeafletId = capaUsrActiva._leaflet_id;\n\t\t\t//Actualitzem popup del marker\n//\t\t\tvar html = createPopUpContent(feature,feature.options.tipus);\n\t\t\t//feature.setPopupContent(html);\n\t\t\tmap.closePopup();\n\t\t\tfeature.openPopup();\n\t\t\t\n\t\t\t//update rangs\n\t\t    //getRangsFromLayer(capaUsrActiva);\n\t\t    \n\t\t\tvar capaEdicio = controlCapes._layers[capaUsrActiva._leaflet_id];\n\t\t\t//recarrego les sublayers de la capa modificada\t\n\t\t\tactualitzacioTematic(capaEdicio,layer.properties.capaBusinessId,\"3124\",feature,features,\"modificacio\");\n\t\t\t\n\t\t\t//Actualitzem comptador de la capa\n\t\t    updateFeatureCount(data.fromBusinessId, data.toBusinessId);\t\t\t\t\t\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t\t}\n\t},function(results){\n\t\tconsole.debug(\"moveGeometriaToVisualitzacio ERROR\");\n\t});\t\t\n\n}\n\nfunction modeLayerTextEdit(){\n\tjQuery('#capa_txt').show();\n\tjQuery('#feature_txt').hide();\n\tjQuery('.popup_pres').hide();\n\tjQuery('.popup_edit').show();\t\n}\n\nfunction modeEditText(){\n\tobjEdicio.edicioPopup='textFeature';\n\tjQuery('#capa_txt').hide();\n\tjQuery('#feature_txt').show();\n\tvar txtTitol=jQuery('#titol_pres').text();\n\tvar txtDesc=jQuery('#descrText').html();\n\tjQuery('#titol_edit').val(txtTitol);\t\n\tjQuery('#des_edit').val(txtDesc);\n\tjQuery('.popup_pres').hide();\n\tjQuery('.popup_edit').show();\t\n}\n\n/*funcio que actulitza l'estil seleccionat al dialeg d'estils, \n * amb el de la feature que es col editar \n * */\nfunction updateDialogStyleSelected(icon){\n  \n\tif(icon.tipus == t_polyline){\n\t\t\n\t\tcanvas_linia.lineWidth = icon.weight;\n\t\tcanvas_linia.strokeStyle = icon.color;\n\t\t\n\t\t$(\"#cmb_gruix_l option[value='\"+icon.weight+\"']\").prop(\"selected\", \"selected\");\n\t\t$('.border_color_linia').css('background-color',icon.color);\n\t\taddGeometryInitL(document.getElementById(\"cv_linia0\"));\t\t\t\n\t\t\n\t}else if(icon.tipus == t_polygon){\n\t\t\n\t\tcanvas_pol.strokeStyle = icon.color;\n\t\tcanvas_pol.opacity = icon.fillOpacity;\n\t\tcanvas_pol.fillStyle = icon.fillColor; //rgb2hex(icon.fillColor);\n\t\tcanvas_pol.lineWidth = icon.weight;\n\t\t\n\t\t$('.border_color_pol').css('border-color',icon.color);\n\t\t$('.fill_color_pol').css('color',icon.fillColor);\n\t\t$('.fill_color_pol').css('background-color',icon.fillColor);\n\t\t$(\"#cmb_gruix option[value='\"+icon.weight+\"']\").prop(\"selected\", \"selected\");\n\t\t$(\"#cmb_trans option[value='\"+icon.fillOpacity+\"']\").prop(\"selected\", \"selected\");\n\t\t\n\t    addGeometryInitP(document.getElementById(\"cv_pol0\"));\n\t    \n\t}else{//es t_marker\n\t\t\n\t\t//Deselecciono estil al modal \n\t\tjQuery(\"#div_puntM\").removeClass(\"estil_selected\");\n\t\tjQuery(\"#div_puntZ\").removeClass(\"estil_selected\");\n\t\tjQuery(\".bs-glyphicons li\").removeClass(\"estil_selected\");\t\t\n\t\t\n\t\t\n\t\tif(icon.isCanvas){//Si es un punt\n\t\t\t\n\t\t\tvar midaPunt = getMidaFromRadius(icon.radius);\n\t\t\t\n\t\t\testilP.iconFons = 'awesome-marker-web awesome-marker-icon-punt_r';\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\n\t\t\testilP.colorGlif = icon.iconColor;\n\t\t\testilP.divColor = icon.fillColor;\n\t\t\testilP.width = midaPunt+'px';\n\t\t\testilP.height = midaPunt+'px';\n\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tjQuery(\"#div_puntZ\").addClass(\"estil_selected\");\n\t\t\tjQuery(\"#div_punt9\").css(\"background-color\",icon.fillColor);\n\t\t\t$('#cmb_mida_Punt option[value=\"'+midaPunt+'\"]').prop(\"selected\", \"selected\");\n\t\t\tjQuery(\"#dv_fill_color_punt\").css(\"background-color\",icon.fillColor);\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",icon.iconColor);\n//\t\t\t\n\t\t}else if(icon.markerColor.indexOf(\"punt_r\")!=-1){\n\t\t\t\n\t\t\tvar licon = icon.icon.split(\" \");\n\t\t\tmidaPunt = getMidaFromFont(licon[1]);\n\t\t\t\n\t\t\testilP.iconFons = 'awesome-marker-web awesome-marker-icon-punt_r';\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\n\t\t\testilP.colorGlif =icon.iconColor;\n\t\t\testilP.fontsize = licon[1];\t\n\t\t\testilP.width = midaPunt+'px';\n\t\t\testilP.height = midaPunt+'px';\n\t\t\testilP.divColor = icon.divColor;\n\t\t\t\n\t\t\n\t\t\tjQuery(\"#div_puntZ\").addClass(\"estil_selected\");\n\t\t\tjQuery(\"#div_punt9\").css(\"background-color\",icon.divColor);\n\t\t\t$('#cmb_mida_Punt option[value=\"'+midaPunt+'\"]').prop(\"selected\", \"selected\");\n\t\t\t\n\t\t\tjQuery(\"#dv_fill_color_punt\").css(\"background-color\",icon.divColor);\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",icon.iconColor);\t\t\t\t\n\t\t\t\n\t\t\tjQuery(\".bs-glyphicons li .fa-\"+licon[0]).parent('li').addClass(\"estil_selected\");\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",estilP.colorGlif);\t\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\n\t\t\tif(estilP.colorGlif==\"#FFFFFF\"){\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\n\t\t\t}else{\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\n\t\t\t}\t\t\t\n\t\t\t\n\t\t\t\n\t\t}else{//Si es marker\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\testilP.iconFons = icon.className+'-web awesome-marker-icon-'+icon.markerColor;\n\t\t\testilP.iconGlif = 'fa fa-'+icon.icon;\n\t\t\testilP.colorGlif = icon.iconColor;\n\t\t\testilP.fontsize = '14px';\n\t\t\testilP.divColor = 'transparent';\n\t\t\testilP.width = '28px';\n\t\t\testilP.height = '42px';\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tjQuery(\"#div_puntM\").addClass(\"estil_selected\");\n\t\t\tjQuery(\"#dv_fill_color_marker\").css(\"background-color\",getColorFromClass(icon.markerColor));\n\t\t\tjQuery('#div_punt_1').removeClass().addClass('awesome-marker-web awesome-marker-icon-'+icon.markerColor);\n\t\t\t\n\t\t\tjQuery(\".bs-glyphicons li .fa-\"+icon.icon).parent('li').addClass(\"estil_selected\");\n\t\t\tjQuery(\"#dv_fill_color_icon\").css(\"background-color\",estilP.colorGlif);\n\t\t\tjQuery('.bs-glyphicons li').css('color',estilP.colorGlif);\n\t\t\tif(estilP.colorGlif==\"#FFFFFF\"){\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#aaaaaa');\t\n\t\t\t}else{\n\t\t\t\tjQuery('.bs-glyphicons li').css('background-color','#FFFFFF');\t\n\t\t\t}\t\t\t\n\t\t}\n\t\t\n\t\tjQuery('#div_punt0').removeClass();\n\t\tjQuery('#div_punt0').addClass(estilP.iconFons+\" \"+estilP.iconGlif);\n\t\tjQuery('#div_punt0').css('width',estilP.width);\n\t\tjQuery('#div_punt0').css('height',estilP.height);\t\n\t\tjQuery('#div_punt0').css('font-size',estilP.fontsize);\n\t\tjQuery('#div_punt0').css('background-color',estilP.divColor);\n\t\tjQuery('#div_punt0').css('color',estilP.colorGlif);\t\t\t\n\t}\n}\n\nfunction getColorFromClass(classe){\n\tswitch (classe)\n\t{\n\t\tcase 'orange':\n\t\t  return '#ffc500';\n\t\tcase 'darkorangeb':\n\t\t  return '#ff7f0b';\n\t\tcase 'red':\n\t\t  return '#ff4b3a';\n\t\tcase 'purple':\n\t\t  return '#ae59b9';\t\n\t\tcase 'blue':\n\t\t  return '#00afb5';\n\t\tcase 'green':\n\t\t  return '#7cbd00';\n\t\tcase 'darkgray':\n\t\t  return '#90a6a9';\n\t\tcase 'gray':\n\t\t  return '#ebf0f1';\t\t  \n\t\t default:\n\t\t\t return '#ffc500';\n\t} \t\t\n}\n\nfunction updateFeatureCount(fromBusinessId, toBusinessId){\n\t\n\t//Actualitzem comptador de la capa\n\tif(fromBusinessId){\n\t\tvar sFromCount = $(\"#count-\"+fromBusinessId).html();\n\t\tif (sFromCount!=undefined){\n\t\t\tsFromCount = sFromCount.replace(\"(\", \" \");\n\t\t\tsFromCount = sFromCount.replace(\")\", \" \");\t\n\t\t\tvar fromCount = parseInt(sFromCount.trim());\n\t\t\tfromCount=fromCount-1;\n\t\t\t$(\"#count-\"+fromBusinessId).html(' ('+fromCount+')');\n\t\t}\n\t}\n\n\tif(toBusinessId){\n\t\tvar sToCount = $(\"#count-\"+toBusinessId).html();\n\t\tif (sToCount!=undefined){\n\t\t\tsToCount = sToCount.replace(\"(\", \" \");\n\t\t\tsToCount = sToCount.replace(\")\", \" \");\t\n\t\t\tvar toCount = parseInt(sToCount.trim());\n\t\t\ttoCount=toCount+1;\n\t\t\t$(\"#count-\"+toBusinessId).html(' ('+toCount+')');\t\t\n\t\t}\n\t}\n//\tconsole.debug(\"Fi updateFeatureCount\");\n}\n\nfunction addDrawTooltips() {\n\tL.drawLocal = {\n\t\tdraw : {\n\t\t\thandlers : {\n\t\t\t\tmarker : {\n\t\t\t\t\t\n\t\t\t\t\ttooltip : {\n\t\t\t\t\t\tstart : window.lang.translate('Fes clic al mapa per posar un punt')\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpolygon : {\n\t\t\t\t\ttooltip : {\n\t\t\t\t\t\tstart : window.lang.translate('Clica per començar a dibuixar una àrea'),\n\t\t\t\t\t\tcont : window.lang.translate('Clica per continuar dibuixant una àrea'),\n\t\t\t\t\t\tend : window.lang.translate('Clica el primer punt per tancar aquesta àrea')\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpolyline : {\n\t\t\t\t\terror : '<strong>Error:</strong> àrees no es poden creuar!',\n\t\t\t\t\t\n\t\t\t\t\ttooltip : {\n\t\t\t\t\t\tstart : window.lang.translate('Clica per començar a dibuixar una línia'),\n\t\t\t\t\t\tcont : window.lang.translate('Clica per continuar dibuixant una línia'),\n\t\t\t\t\t\tend : window.lang.translate('Clica el darrer punt per acabar la línia')\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tedit : {\n\t\t\thandlers : {\n\t\t\t\tedit : {\n\t\t\t\t\t\n\t\t\t\t\ttooltip : {\n\t\t\t\t\t\ttext : window.lang.translate(\"Arrossega els vèrtex o el punt per editar l'objecte\"),\n\t\t\t\t\t\tsubtext : window.lang.translate('Fes clic sobre el mapa per finalitzar')\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\treturn L.drawLocal;\n}\n\nfunction addHtmlInterficieDraw(){\n\tjQuery(\"#funcio_draw\").append(\n\t\t'<h5 lang=\"ca\" id=\"funcio_draw_titol_1\">Situar un punt</h5>'+\n\t\t'\t<div class=\"add_costat_r\" style=\"margin-right: 33%;\">'+\n\t\t'\t<div lang=\"ca\" id=\"div_mes_punts\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més tipus de punts\" title=\"Més tipus de punts\"></div>'+\n\t\t'</div>'+\n\t\t'<div style=\"height:50px \">'+\n\t\t'\t<div id=\"div_punt\" class=\"dibuix_punt\" data-toggle=\"tooltip\" data-lang-title=\"Clica per situar un punt\" title=\"Clica per situar un punt\">'+\n\t\t'\t</div>'+\n\t\t'</div>'+\n\t\t'<h5 lang=\"ca\" id=\"funcio_draw_titol_2\">Dibuixar una línia o un polígon</h5>'+\n\t\t'<div class=\"div_auto\">'+\n\t\t'\t<div id=\"div_linia\" class=\"dibuix_linia\" data-toggle=\"tooltip\" data-lang-title=\"Clica per començar a dibuixar una línia\" title=\"Clica per començar a dibuixar una línia\">'+\n\t\t'\t<canvas id=\"cv_linia\" width=\"40\" height=\"40\"></canvas>'+\n\t\t'\t</div>'+\n\t\t'\t<div class=\"add_costat\">'+\n\t\t'\t\t<div lang=\"ca\" id=\"div_mes_linies\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més estils de línia\" title=\"Més estils de línia\"></div>'+\n\t\t'\t</div>'+\n\t\t'</div>'+\n\t\t'<div class=\"div_auto\">'+\n\t\t'\t<div id=\"div_area\" class=\"dibuix_poligon\" data-toggle=\"tooltip\" data-lang-title=\"Clica per començar a dibuixar una àrea\" title=\"Clica per començar a dibuixar una àrea\">'+\n\t\t'\t<canvas id=\"cv_pol\" width=\"40\" height=\"40\"></canvas>'+\n\t\t'\t</div>'+\n\t\t'\t<div class=\"add_costat\">'+\n\t\t'\t\t<div lang=\"ca\" id=\"div_mes_arees\" class=\"icon-add taronja\" data-toggle=\"tooltip\" data-lang-title=\"Més estils d\\'àrees\" title=\"Més estils d\\'àrees\"></div>'+\n\t\t'\t</div>'+\n\t\t'</div>'\n\t);\n\t\n\t$('#div_punt').tooltip({placement : 'bottom',container : 'body'});\n\t$('#div_linia').tooltip({placement : 'bottom',container : 'body'});\n\t$('#div_area').tooltip({placement : 'bottom',container : 'body'});\t\n\t\n\t$('#div_mes_punts').tooltip({placement : 'right',container : 'body'});\n\t$('#div_mes_linies').tooltip({placement : 'right',container : 'body'});\n\t$('#div_mes_arees').tooltip({placement : 'right',container : 'body'});\t\n}\n\nfunction activarSnapping(capaEdicio){\n\tif (capaEdicio.getLayers()[0].snapediting==undefined){\n\t\t//Activate snapping\n\t\tif (capaEdicio.getLayers()[0].properties.tipusFeature != undefined && capaEdicio.getLayers()[0].properties.tipusFeature==\"marker\"){\n\t\t\ttry{\n\t\t\t\tcapaEdicio.getLayers()[0].editing = new L.Handler.MarkerSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\n\t\t\t\tcapaEdicio.getLayers()[0].snapediting = new L.Handler.MarkerSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\n\t\t\t}catch(exc){\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t\telse{\t\t\t\t\t\n\t\t\tcapaEdicio.getLayers()[0].editing = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\n\t\t\tcapaEdicio.getLayers()[0].snapediting = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\n\t\t}\n\t}\n\t\tfor(var i = 0;i < guideLayers.length; i++) {\n\t\t\t // Add every already drawn layer to snap list\n\t\t\tcapaEdicio.getLayers()[0].snapediting.addGuideLayer(guideLayers[i]);\n\t        // Add the currently drawn layer to the snap list of the already drawn layers\n\t\t\tif ( guideLayers[i].snapediting!=undefined){\n\t\t\t\tguideLayers[i].snapediting.addGuideLayer(capaEdicio.getLayers()[0]);\n\t\t\t\tguideLayers[i].snapediting.enable();\n\t\t\t\tif (guideLayers[i].editing!=undefined) guideLayers[i].editing.disable();\n\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (guideLayers[i].properties.tipusFeature != undefined && guideLayers[i].properties.tipusFeature==\"marker\"){\n\t\t\t\t\ttry{\n\t\t\t\t\t\tguideLayers[i].snapediting = new L.Handler.MarkerSnap(map, layer,{snapDistance:10});\n\t\t\t\t\t}catch(exc){\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tguideLayers[i].snapediting = new L.Handler.PolylineSnap(map, capaEdicio.getLayers()[0],{snapDistance:10});\n\t\t\t\t}\n\t\t\t\tif (guideLayers[i].snapediting!=undefined) {\n\t\t\t\t\tguideLayers[i].snapediting.addGuideLayer(capaEdicio.getLayers()[0]);\n\t\t\t\t\tguideLayers[i].snapediting.enable();\n\t\t\t\t}\n\t\t\t\tif (guideLayers[i].editing!=undefined)  guideLayers[i].editing.disable();\n\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable(); \n\t\t\t}\n\t\t\tif (capaEdicio.getLayers()[0].properties.tipusFeature != undefined && capaEdicio.getLayers()[0].properties.tipusFeature==\"marker\"){\n\t\t\t\ttry{\n\t\t\t\t\tif (guideLayers[i].editing!=undefined)  guideLayers[i].editing.disable();\n\t\t\t\t\tif (guideLayers[i].dragging!=undefined) guideLayers[i].dragging.enable();\n\t\t\t\t}catch(exc){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t }\n\t\ttry{\n\t\t\tcapaEdicio.getLayers()[0].snapediting.enable();\n\t\t}\n\t\tcatch(exc){\n\t\t\t\n\t\t}\n\t\t// capaEdicio.getLayers()[0].editing.enable();\n\t\t  // Add to drawnItems\n\t\t drawnItems.addLayer(capaEdicio.getLayers()[0]);\n\t\t // Add newly drawn feature to list of snappable features\n\t\tguideLayers.push(capaEdicio.getLayers()[0]);\n}\n\n\n\n","var _htmlServeisWMS = [],\n_NomServer2 = \"\",\nWMS_BBOX,\nActiuWMS = {\n\t\"servidor\" : \"servidor\",\n\t\"url\" : \"url\",\n\t\"layers\" : \"layers\",\n\t\"epsg\" : 'L.CRS.EPSG4326',\n\t\"tileSize\":\"512\",\n\t\"wmstime\":false\n};\n\nfunction generaLlistaServeisWMS() {\n\t_htmlServeisWMS.push('<div class=\"panel-success\"><ul class=\"bs-dadesO panel-heading\">');\n\tvar llista_servidorsWMS = {\n\t\t\"WMS\" : [\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Base municipal\",\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\n\t\t\t\t\"IDARXIU\" : \"http://galileo.icc.cat/arcgis/services/icc_limadmin_v_r/MapServer/WMSServer?\",\n\t\t\t\t\"URN\" : \"urn:uuid:761da3ce-233c-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Delimitació municipal\",\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\n\t\t\t\t\"IDARXIU\" : \"http://geoserveis.icc.cat/icc_atlm/wms/service?\",\n\t\t\t\t\"URN\" : \"urn:uuid:761da3ce-233c-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t\n\t\t\t/*\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Mapa Urbanístic\",\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\n\t\t\t\t\"IDARXIU\" : \"http://dtes.gencat.cat/webmap/MUC/service.svc/get?\",\n\t\t\t\t\"URN\" : \"urn:uuid:e7a15a72-233b-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t*/\n\t\t\t\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Mapa Cadastral\",\n\t\t\t\t\"ORGANITZAC\" : \"Dirección General del Catastro\",\n\t\t\t\t\"IDARXIU\" : \"http://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?\",\n\t\t\t\t\"URN\" : \"urn:uuid:260c0ccb-233c-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t\n\t\t\t/*\n\t\t\t{ \n\t\t\t\t\"TITOL\" : \"Atermenament i usos de costes\",\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\n\t\t\t\t\"IDARXIU\" : \"http://sig.gencat.cat/ows/COSTES/wms?\", \n\t\t\t\t\"URN\" :\"urn:uuid:873ee728-cc2c-11e2-a37e-f96b77832722\"\n\t\t\t},\n\t\t\t\n\t\t\t*/\n\t\t\t\n\t\t\t{ \n\t\t\t\t\"TITOL\" : \"Població de Catalunya 2014 \",\n\t\t\t\t\"ORGANITZAC\" : \"Institut d'Estadistica de Catalunya\",\n\t\t\t\t\"IDARXIU\" :  HOST_APP2+\"geotimeservices/idescat\", \n\t\t\t\t\"URN\" :\"urn:uuid:873ee728-cc2c-11e2-a37e-f96b77832722\"\n\t\t\t},\n\t\t\t\n\t\t\t\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Establiments industrials\",\n\t\t\t\t\"ORGANITZAC\" : \"Direccio General de Difusio\",\n\t\t\t\t\"IDARXIU\" : \"http://pcivil.icgc.cat/ogc/geoservei?map=/opt/idec/dades/pcivil/risc_quimic.map&amp\",\n\t\t\t\t\"URN\" : \"urn:uuid:0a71e360-7f73-11e4-b2ac-e7f91a2c3576\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Mapes Medi Natural\",\n\t\t\t\t\"ORGANITZAC\" : \"Departament d'Agricultura, Ramaderia, Pesca, Alimentació i Medi Natural\",\n\t\t\t\t\"IDARXIU\" : \"http://magrana.gencat.cat/SIG_ws/services/PUBLIC_OGC/MapServer/WMSServer?\",\n\t\t\t\t\"URN\" : \"urn:uuid:6661c209-1462-11e3-8d85-e315c0a1d933\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Ortofotos històriques\",\n\t\t\t\t\"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\n\t\t\t\t\"IDARXIU\" : \"http://historics.icc.cat:80/lizardtech/iserv/ows?\",\n\t\t\t\t\"URN\" : \"urn:uuid:6434ad48-66df-11e2-8be5-bd1ed7ebebe1\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Risc Sísmic\",\n\t\t\t\t\"ORGANITZAC\" : \"Direccio General de Difusio\",\n\t\t\t\t\"IDARXIU\" : \"http://pcivil.icgc.cat/ogc/geoservei?map=/opt/idec/dades/pcivil/risc_sismic.map&\",\n\t\t\t\t\"URN\" : \"urn:uuid:09e7f2c8-7f73-11e4-b2ac-e7f91a2c3576\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Cobertes del Sòl\",\n\t\t\t\t\"ORGANITZAC\" : \"Centre de Recerca Ecològica i Aplicacions Forestals (CREAF) - UAB\",\n\t\t\t\t\"IDARXIU\" : \"http://www.opengis.uab.es/cgi-bin/MCSC/MiraMon.cgi?\",\n\t\t\t\t\"URN\" : \"urn:uuid:54012596-233b-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Mapes Ambientals\",\n\t\t\t\t\"ORGANITZAC\" : \"Departament de Territori i Sostenibilitat\",\n\t\t\t\t\"IDARXIU\" : \"http://sima.gencat.cat/DMAH_ws/SIMA_OGC/MapServer/WMSServer?\",\n\t\t\t\t\"URN\" : \"urn:uuid:e84cb5ba-233b-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"TITOL\" : \"Nodes guifi.net\",\n\t\t\t\t\"ORGANITZAC\" : \"GUIFI.NET\",\n\t\t\t\t\"IDARXIU\" : \"http://guifi.net/cgi-bin/mapserv?map=/home/guifi/maps.guifi.net/guifimaps/GMap.map&\",\n\t\t\t\t\"URN\" : \"urn:uuid:63013742-233c-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t{\n                \"TITOL\" : \"Mapa trànsit en temps real\",\n                \"ORGANITZAC\" : \"Servei Català de Trànsit \",\n                \"IDARXIU\" : \"http://sctwms.gencat.cat/WMS/mapserv.exe?map=//sctbrsscc05/AGATA/EstatdelTransit.map&amp\",\n                \"URN\" : \"urn:uuid:fe8365ca-233c-11e2-a4dd-13da4f953834\"\n\t\t\t},\n\t\t\t{\n                \"TITOL\" : \"Mapa Cadastral per anys\",\n                \"ORGANITZAC\" : \"Dirección General de Cadastro\",\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/catastro_dgc\",\n                \"WMST\" : true\n\t\t\t},\n\t\t\t{\n                \"TITOL\" : \"Ortofotos per anys\",\n                \"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/orto_icgc\",\n                \"WMST\" : true\n\t\t\t},\n\t\t\t{\n                \"TITOL\" : \"Seccions Censals per anys\",\n                \"ORGANITZAC\" : \"Institut Cartogràfic i Geològic de Catalunya\",\n                \"IDARXIU\" : HOST_APP2+\"geotimeservices/seccionsc_icgc\",\n                \"WMST\" : true\n\t\t\t}\n\t\t]\n\t};\t\n\t\n\tjQuery.each(llista_servidorsWMS.WMS, function(key, WMS) {\n\t\tif(WMS.WMST){\n\t\t\t_htmlServeisWMS.push('<li><a class=\"label-wms\" href=\"#\" id=\"' +\n\t\t\t\tWMS.IDARXIU +\n\t\t\t\t'\">' +\n\t\t\t\twindow.lang.translate(WMS.TITOL) +\n\t\t\t\t'</a>' +\n\t\t\t\t'<a target=\"_blank\" lang=\"ca\" title=\"Servei WMS-TIME\" href=\"' +\n\t\t\t\tWMS.IDARXIU +'?&Request=GetCapabilities&service=WMS' +\n\t\t\t\t'\"><span class=\"glyphicon glyphicon-time info-wms\"></span></a>' +\n\t\t\t\t'</li>');\n\t\t}else{\n\t\t\t_htmlServeisWMS.push('<li><a class=\"label-wms\" href=\"#\" id=\"' +\n\t\t\t\tWMS.IDARXIU +\n\t\t\t\t'\">' +\n\t\t\t\twindow.lang.translate(WMS.TITOL) +\n\t\t\t\t'</a>' +\n\t\t\t\t//'<a target=\"_blank\" lang=\"ca\" title=\"Informació dels serveis\" href=\"http://www.geoportal.cat/wefex/client?idioma=ca&do=cercaAssociacions&resposta=detall&id=' +\n\t\t\t\t//WMS.URN +\n\t\t\t\t'<a target=\"_blank\" lang=\"ca\" title=\"'+WMS.ORGANITZAC+'\" href=\"' +\n\t\t\t\tWMS.IDARXIU +'?Request=GetCapabilities&service=WMS' +\n\t\t\t\t'\"><span class=\"glyphicon glyphicon-info-sign info-wms\"></span></a>' +\n\t\t\t\t'</li>');\n\t\t}\n\t});\n\t//TODO cambiar y cargar algun template externo\n\t_htmlServeisWMS.push('<li></li>');\n\t_htmlServeisWMS.push('<li><div class=\"input-group txt_ext\"><input type=\"text\" lang=\"ca\" id=\"txt_URLWMS_cataleg\" style=\"height:33px\" placeholder=\"Cercar catàleg IDEC\" class=\"form-control\">');\n\t_htmlServeisWMS.push('<span class=\"input-group-btn\"><button class=\"btn btn-success\" id=\"bt_cercaWMS\"  type=\"button\"><span class=\"glyphicon glyphicon-search\"></span></button></span>');\n\t_htmlServeisWMS.push('</div></li>');\n\t_htmlServeisWMS.push('</ul></div>');\n\t_htmlServeisWMS.push('<div id=\"resultats_idec\">');\n\t_htmlServeisWMS.push('</div>');\n\t_htmlServeisWMS.push('<div id=\"div_controlWMS\"></div>');\n\t_htmlServeisWMS.push('<div id=\"div_emptyWMS\"></div>');\n}\n\njQuery(document).on('keyup', \"#txt_URLWMS_cataleg\", function(e) {\n    var code = e.which; // recommended to use e.which, it's normalized across browsers\n    if(code==13) {//enter\n    \te.preventDefault();\n    \te.stopImmediatePropagation();\n    \tvar cerca = $.trim(jQuery('#txt_URLWMS_cataleg').val());\n    \tif (cerca === \"\") {\n    \t\talert(window.lang.translate(\"Has d'introduïr un valor per fer la cerca\"));\n    \t} else {\n    \t\tcercaCataleg(cerca);\n    \t\t\n    \t}\n    }\n});\n\njQuery(document).on('click', \"#bt_cercaWMS\", function(e) {\n\tvar cerca = $.trim(jQuery('#txt_URLWMS_cataleg').val());\n\tif (cerca === \"\") {\n\t\talert(window.lang.translate(\"Has d'introduïr un valor per fer la cerca\"));\n\t} else {\n\t\tcercaCataleg(cerca);\n\t}\n});\n\nfunction cercaCataleg(cerca){\n\tcerca = encodeURI(cerca);\n\tvar data ={\n\t\tsearchInput : cerca\t\n\t};\n\t//Cerca catàleg IDEC\n\tsearchCatalegIdec(data).then(function(results){\n\t\tvar resultats = JSON.parse(results.resultats);\n\t\tjQuery('#div_layersWMS').attr(\"style\",\"display:none;\");\n\t\tvar lDadesIdec = '<ul class=\"panel-heading llista-dadesIdec\">';\n\t\tjQuery.each(resultats.aaData, function( index, wmsidec ) {\n\t\t\tvar titol=wmsidec.TITOL;\n\t\t\tvar titolShort=shortString(titol,27);\n\t\t\tvar desc=wmsidec.DESCRIPCIO;\n\t\t\tvar org =wmsidec.ORGANITZAC;\n\t\t\tvar idarxiu=wmsidec.IDARXIU;\n\t\t\tvar classificaico=wmsidec.CLASSIFICA;\n\t\t\tvar urn=wmsidec.URN;\n\t\t\tvar xmin=wmsidec.XMIN;\n\t\t\tvar xmax=wmsidec.XMAX;\n\t\t\tvar ymin=wmsidec.YMIN;\n\t\t\tvar ymax=wmsidec.YMAX;\n\t\t\tvar escala=wmsidec.ESCALA;\n\t\t\tvar conjunt=wmsidec.CONJUNT;\n\t\t\tvar temes=wmsidec.TEMES;\n\t\t\tlDadesIdec += '<li><a class=\"label-dadesIdec\" href=\"#\" title=\"'+titol+'\"  data-nom=\"'+titol+'\" data-wms_url=\"'+idarxiu+'\">'+titolShort;\n\t\t\tlDadesIdec += '<a lang=\"ca\" href=\"http://www.geoportal.cat/wefex/client?idioma=ca&do=cercaAssociacions&resposta=detall&id='+urn+'&idioma=ca&\" target=\"_blank\">';\n\t\t\tlDadesIdec += '&nbsp;<span class=\"glyphicon glyphicon-info-sign\"></span></a></li>';\n\t\t});\n\t\tlDadesIdec += '</ul>';\n\t\tif (resultats.aaData.length>0) {\n\t\t\tjQuery('#resultats_idec').html(lDadesIdec);\n\t\t\t//TODO llamar al control\n\t\t\tjQuery('#txt_URLWMS').attr(\"style\",\"display:none\");\n\t\t\tjQuery('#bt_connWMS').attr(\"style\",\"display:none\");\n\t\t\tjQuery(\".label-dadesIdec\").on('click', function(e) {\n\t\t\t\tjQuery('#resultats_idec').empty();\n\t\t\t\tvar urlWMS= this.dataset.wms_url;\n\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'afegir WMS catàleg IDEC', this.dataset.nom, 1]});\n\t\t\t\tjQuery('#txt_URLWMS').attr(\"style\",\"display:block;height:33px;\");\n\t\t\t\tjQuery('#bt_connWMS').attr(\"style\",\"display:inline\");\n\t\t\t\tjQuery('#txt_URLWMS').val(urlWMS);\n\t\t\t\tjQuery('#bt_connWMS').click();\n\t\t\t});\n\t\t}\n\t});\n}\n\nfunction getCapabilitiesWMS(url, servidor) {\n\tvar _htmlLayersWMS = [];\n\tvar instamapsWms = InstamapsWms({\n\t\tloadTemplateParam :false});\n\tvar dataWMS = {url: url};\n\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\tvar bbox,\n\t\tsouce_capabilities_template = $(\"#capabilities-template\").html(),\n\t\tcapabilities_template = Handlebars.compile(souce_capabilities_template);\n\t\t\n\t\tHandlebars.registerPartial( \"list-template\", $( \"#list-template\" ).html() );\n\t\tHandlebars.registerHelper('layer', function(context, options) {\n\t\t  var ret = \"\";\n\t\t  if (!Handlebars.Utils.isArray(context)){\n\t\t\t  context = [context];\n\t\t  }\n\t\t  for(var i=0, j=context.length; i<j; i++) {\n\t\t\t  if (!Handlebars.Utils.isArray(context[i])){\n\t\t\t\t  ret = ret + options.fn(context[i]);\n\t\t\t  }else{\n\t\t\t\t  for(var k=0, l=context.length; k<l; k++) {\n\t\t\t\t\t  ret = ret + options.fn(context[i][k]);\n\t\t\t\t  }\n\t\t\t  }\n\t\t  }\n\t\t  return ret;\n\t\t});\n\t\t\n\t\tjQuery('#div_layersWMS').html('');\n\t\tjQuery(\"#div_layersWMS\").show();\n\t\tjQuery('#div_emptyWMS').empty();\n\n\t\tif (servidor === null) {\n\t\t\tservidor = results.Service.Title;\n\t\t}\n\t\ttry{\n\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\n\t\t\t\tbbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\n\t\t\t\tbbox = results.Capability.Layer.LatLonBoundingBox;\n\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t}else{\n\t\t\t\tWMS_BBOX=null;\n\t\t\t}\t\n\t\t} catch (err) {\n\t\t\tWMS_BBOX=null;\n\t\t}\n\t\t\n\t\ttry {\n\t\t\tvar matriuEPSG = results.Capability.Layer.CRS,\n\t\t\tepsg = [],\n\t\t\thtml = capabilities_template({Layer: [results.Capability.Layer]});\n\t\t\t\n\t\t\tActiuWMS.servidor = servidor;\n\t\t\t_NomServer2=ActiuWMS.servidor;\n\t\t\tActiuWMS.url = jQuery.trim(url);\n\t\t\t\n\t\t\t\n\t\t\tif (!matriuEPSG) {\n\t\t\t\tmatriuEPSG = results.Capability.Layer.SRS;\n\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].CRS;\n\t\t\t\t\t\n\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].SRS;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (jQuery.isArray(matriuEPSG)){\n\t\t\t\tjQuery.each(matriuEPSG, function(index, value) {\n\t\t\t\t\tepsg.push(value);\n\t\t\t\t});\n\t\t\t}else{\n\t\t\t\tepsg.push(matriuEPSG);\n\t\t\t}\n\t\n\t\t\tif (jQuery.inArray('EPSG:3857', epsg) != -1) {\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t} else if (jQuery.inArray('EPSG:900913', epsg) != -1) {\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t} else if (jQuery.inArray('EPSG:4326', epsg) != -1) {\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t} else if (jQuery.inArray('CRS:84', epsg) != -1) {\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t} else if (jQuery.inArray('EPSG:4258', epsg) != -1) {\n\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\tActiuWMS.epsgtxt = '4326';\t\n\t\t\t} else {\n\t\t\t\talert(window.lang.translate(\"No s'ha pogut visualitzar aquest servei: Instamaps només carrega serveis WMS globals en EPSG:3857 i EPSG:4326\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tjQuery('#div_layersWMS').empty().append(html);\n\t\t\taddTreeEvents();\n\t\t\tjQuery('#div_emptyWMS').empty();\n\t\t\tjQuery('#div_emptyWMS').html(\n\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" id=\"bt_addWMS\" class=\"btn btn-success\" >' +\n\t\t\t\twindow.lang.translate(\"Afegir capes\") + '</button></div>');\n\t\t} catch (err) {\n\t\t\tjQuery('#div_layersWMS').html('<hr>Error interpretar capabilities: ' + err + '</hr>');\n\t\t}\n\t},function(){ console.info(\"time out\")});\n}\n\nfunction addWmsToMap(wms){\n\t\n\n\t\n\tvar wmsLayer,\n\ttipus_user = defineTipusUser();  //geocat.web-1.0.0\n\t//$.publish('analyticsEvent',{event:[ 'mapa', tipus_user+'wms', wms.url, 1]});\n\t//TODO eliminar esto pero primero hay que cargar el instamaps.google-analytics.js en lugar del geocat.google-analytics.js\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wms', wms.url, 1]});\n\t\t\n\n\t\n\n\t\n\tif(wms.wmstime){\n\t\twmsLayer = L.tileLayer.wms(wms.url, {\n\t\t\tlayers : wms.layers,\n\t\t\tcrs : wms.epsg,\n\t\t\ttransparent : true,\n\t\t\tformat : 'image/png',\n\t\t\twmstime:wms.wmstime,\n\t\t\ttileSize:512\n\t\t});\n\t}else{\n\t\twmsLayer = L.tileLayer.betterWms(wms.url, {\n\t\t\tlayers : wms.layers,\n\t\t\tcrs : wms.epsg,\n\t\t\ttransparent : true,\n\t\t\t//exceptions:'application/vnd.ogc.se_blank',\n\t\t\texceptions:checkExceptionsType(wms.url),\n\t\t\tformat : 'image/png',\n\t\t\twmstime:wms.wmstime,\n\t\t\ttileSize:512\n\t\t});\n\t}\n\t\n\twmsLayer.options.businessId = '-1';\n\twmsLayer.options.nom = wms.servidor;\n\twmsLayer.options.tipus = t_wms;\n\t\n\tif(typeof url('?businessid') == \"string\"){\n\t\tvar data = {\n\t\t\tuid:Cookies.get('uid'),\n\t\t\tmapBusinessId: url('?businessid'),\n\t\t\tserverName: wms.servidor,\n\t\t\tserverType: t_wms,\n\t\t\tversion: wmsLayer.wmsParams.version,\n\t\t\tcalentas: false,\n            activas: true,\n            visibilitats: true,\n            order: controlCapes._lastZIndex+1,\n            epsg: ActiuWMS.epsgtxt,\n            imgFormat: 'image/png',\n            infFormat: 'text/html',\n            tiles: true,\t            \n            transparency: true,\n            opacity: 1,\n            visibilitat: 'O',\n            url: wms.url,\n            layers: JSON.stringify([{name:wms.layers,title:wms.layers,group:0,check:true,query:true}]),\n            calentas: false,\n            activas: true,\n            visibilitats: true,\n\t\t\toptions: '{\"url\":\"'+wms.url+'\",\"layers\":\"'+wms.layers+'\",\"opacity\":\"'+1+'\",\"wmstime\":'+wms.wmstime+'}'\n\t\t};\n\t\tcreateServidorInMap(data).then(function(results){\n\t\t\tmap.spin(false);\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\twmsLayer.options.businessId = results.results.businessId;\n\t\t\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,wms.servidor);\n\t\t\t\t//dfd.resolve(true);\n\t\t\t}else{\n\t\t\t\tconsole.debug('createServidorInMap ERROR');\n\t\t\t\t//dfd.resolve(false);\n\t\t\t}\n\t\t});\n\t}else{\n\t\t//dfd.reject();\n\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,wms.servidor);\n\t}\n\t\n}\n\n/*\n * fromParam = true -> Si afegim WMS directamente dun parametre de la url\n * fromParam = false -> Si afegim WMS des de la interficie dInstaMaps\n * */\nfunction addExternalWMS(fromParam) {\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wms', ActiuWMS.url, 1]});\n\t\n\tvar dfd = $.Deferred();\n\tvar _dateFormat=false,\n\tnomCapaWMS,\n\twmsLayer;\n\t\n\tif(!fromParam){\n\t\tvar cc = $('#div_layersWMS input:checked').map(function(){\n\t\t\tif($('#geoservicetime_'+this.value).length > 0){\n\t\t\t\t_dateFormat=true;\n\t\t\t}\n\t\t\treturn this.value;\n\t\t});\n\t\tcc = jQuery.makeArray(cc);\n\t\tActiuWMS.layers = cc.join(',');\n\t\t\n\t\tvar _nomCapesWMS=[];\n\t\tvar cc1 = $('#div_layersWMS input:checked').map(function(){\t\t\t\n\t\t\treturn this.id;\n\t\t});\n\t\t\n\t\tcc1 = jQuery.makeArray(cc1);\t\n\t\t\n\t\tif(cc1.length==1){\n\t\t\tActiuWMS.servidor=cc1.join(\" \");\n\t\t}else{\n\t\t\tActiuWMS.servidor=_NomServer2;\t\t\n\t\t}\n\t\t\n\n\t\tActiuWMS.wmstime=_dateFormat;\n\t\t\n\t\t\n\t\t\n\t}\n\tif(ActiuWMS.wmstime){\n\t\twmsLayer =L.tileLayer.wms(ActiuWMS.url, {\n\t\t\tlayers : ActiuWMS.layers,\n\t\t\tcrs : ActiuWMS.epsg,\n\t\t\ttransparent : true,\n\t\t\tformat : 'image/png',\n\t\t\twmstime:ActiuWMS.wmstime,\n\t\t\ttileSize:512\n\t\t});\n\t}else{\n\t\twmsLayer = L.tileLayer.betterWms(ActiuWMS.url, {\n\t\t\tlayers : ActiuWMS.layers,\n\t\t\tcrs : ActiuWMS.epsg,\n\t\t\ttransparent : true,\n\t\t\t//exceptions:'application/vnd.ogc.se_blank',\n\t\t\texceptions:checkExceptionsType(ActiuWMS.url),\n\t\t\tformat : 'image/png',\n\t\t\twmstime:ActiuWMS.wmstime,\n\t\t\ttileSize:512\n\t\t});\n\t}\n\t\n\tnomCapaWMS=ActiuWMS.servidor;\t\n\t\n\t\n\twmsLayer.options.businessId = '-1';\n\twmsLayer.options.nom = nomCapaWMS;\n\twmsLayer.options.tipus = t_wms;\n\tif(typeof url('?businessid') == \"string\"){\n\t\tvar data = {\n\t\t\tuid:Cookies.get('uid'),\n\t\t\tmapBusinessId: url('?businessid'),\n\t\t\tserverName: ActiuWMS.servidor,\n\t\t\tserverType: t_wms,\n\t\t\tversion: wmsLayer.wmsParams.version,\n\t\t\tcalentas: false,\n            activas: true,\n            visibilitats: true,\n            order: controlCapes._lastZIndex+1,\n            epsg: ActiuWMS.epsgtxt,\n            imgFormat: 'image/png',\n            infFormat: 'text/html',\n            tiles: true,\t            \n            transparency: true,\n            opacity: 1,\n            visibilitat: 'O',\n            url: ActiuWMS.url,\n            layers: JSON.stringify([{name:ActiuWMS.layers,title:ActiuWMS.layers,group:0,check:true,query:true}]),\n            calentas: false,\n            activas: true,\n            visibilitats: true,\n\t\t\toptions: '{\"url\":\"'+ActiuWMS.url+'\",\"layers\":\"'+ActiuWMS.layers+'\",\"opacity\":\"'+1+'\",\"wmstime\":'+ActiuWMS.wmstime+'}'\n\t\t};\n\t\tcreateServidorInMap(data).then(function(results){\n\t\t\tmap.spin(false);\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\twmsLayer.options.businessId = results.results.businessId;\n\t\t\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,ActiuWMS.servidor);\n\t\t\t\t//Issue #581: zoom capa cloudifier\n\t\t\t\tif (results.results!=undefined && results.results.url!=undefined && results.results.url.indexOf(\"http://betaserver.icgc.cat/geoservice/\")!=-1){\n\t\t\t\t\tvar instamapsWms = InstamapsWms({\n\t\t\t\t\t\tloadTemplateParam :false});\n\t\t\t\t\tvar dataWMS = {url: results.results.url};\n\t\t\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results2) {\n\t\t\t\t\t\ttry{\n\t\t\t\t\t\t\tif(results2.Capability.Layer.Layer.LatLonBoundingBox){\n\t\t\t\t\t\t\t\tvar bbox = results2.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t\t\t}else if(results2.Capability.Layer.LatLonBoundingBox){\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tvar bbox = results2.Capability.Layer.LatLonBoundingBox;\n\t\t\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (WMS_BBOX !=null) map.fitBounds(WMS_BBOX);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tdfd.resolve(true);\n\t\t\t}else{\n\t\t\t\tconsole.debug('createServidorInMap ERROR');\n\t\t\t\tdfd.resolve(false);\n\t\t\t}\n\t\t});\n\t}else{\n\t\tdfd.reject();\n\t\tcheckAndAddTimeDimensionLayer(wmsLayer,false,ActiuWMS.servidor);\n\t}\n\t\n\t return dfd.promise();\n}\n\nfunction showTimeControl(show){\n\tshow ? $('.barra_temps').show() : $('.barra_temps').hide();\n}\n\nfunction checkAndAddTimeDimensionLayer(wmsLayer,ckeckCapaActiva,_nomServidor,capesActiva,_map){\n\tvar DL= wmsLayer.options.wmstime;\n\t\n\t_map = _map || map;\n\t\n\tif(wmsLayer.options.wmstime) {\n\t\tvar dimensionsTimeLayer  = L.timeDimension.layer.wms(wmsLayer, {\n\t\t    proxy: paramUrl.proxy_betterWMS,\n\t\t    updateTimeDimension: true,\n\t\t    updateTimeDimensionMode:'intersect',//replace, union,intersect\n\t\t    tileSize:512,\n\t\t    setDefaultTime:false,\n\t\t    tipus : t_wms\n\t\t});\n\t\tdimensionsTimeLayer.options=wmsLayer.options;\n\t\tdimensionsTimeLayer.addTo(_map);\n\t\tdimensionsTimeLayer.bringToFront();\n\t\tdimensionsTimeLayer.options.zIndex = controlCapes._lastZIndex+ 1;\n\t\tif(controlCapes){\n\t\t\tcontrolCapes.addOverlay(dimensionsTimeLayer, _nomServidor, true);\n\t\t\tcontrolCapes._lastZIndex++;\n\t\t\tactivaPanelCapes(true);\n\t\t}\n\t\tjQuery('#dialog_dades_ex').modal('hide');\t\n\t\t\n\t\tshowTimeControl(true);\n\t}else{\n\t\tif(ckeckCapaActiva){\n\t\t\tif (capesActiva === true || capesActiva === 'true' ){\n\t\t\t\twmsLayer.addTo(_map);\n\t\t\t}\n\t\t\tif(controlCapes){\n\t\t\t\tcontrolCapes.addOverlay(wmsLayer, _nomServidor, true);\n\t\t\t\tcontrolCapes._lastZIndex++;\t\n\t\t\t}\n\t\t}else{\n\t\t\t_map.addLayer(wmsLayer);\n\t\t\twmsLayer.bringToFront();\n\t\t\twmsLayer.options.zIndex = controlCapes._lastZIndex+ 1;\n\t\t\tif(controlCapes){\n\t\t\t\tcontrolCapes.addOverlay(wmsLayer, _nomServidor, true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tactivaPanelCapes(true);\n\t\t\t}\n\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\n\t\t}\n\t}\n}\n\n\nfunction loadWmsLayer(layer, _map){\n\tvar op = layer.opacity,\n\tjsonOptions,\n\tnewWMS,\n\tnomServidor = layer.serverName;\n\t\n\tif(layer.serverName.indexOf('##') !=-1){\n\t\tvar valors = layer.serverName.split(\"##\");\n\t\top = valors[1];\n\t\tnomServidor=valors[0];\n\t}  \n\tif(typeof (layer.options)==\"string\"){\n\t\ttry {\n\t\t\tjsonOptions = JSON.parse(layer.options);\n\t\t}\n\t\tcatch (err) {\n\t\t\tjsonOptions = layer.options;\t\n\t\t}\n\t}else{\n\t\tjsonOptions = layer.options;\t\n\t}\n\tif(!layer.options){\n\t\tjsonOptions=layer;\n\t}\n\tvar wmsOptions = {\n\t    layers: layer.layers,\n\t    format: layer.imgFormat,\n\t    transparent: layer.transparency,\n\t    version: layer.version,\n\t    opacity:op ,\n\t    crs: layer.epsg,\n\t\tnom :nomServidor ,\n\t\ttipus: layer.serverType,\n\t\tzIndex :  parseInt(layer.capesOrdre),\n\t    businessId: layer.businessId,\n\t    tileSize:512\n\t};\n\tif(layer.random){\n\t\twmsOptions.random=layer.random;\n\t}\n\tnewWMS = L.tileLayer.betterWms(layer.url, wmsOptions);\n\tnewWMS.options.wmstime=jsonOptions.wmstime;\n\tnewWMS.options.group=jsonOptions.group;\n\t\t\n\tcheckAndAddTimeDimensionLayer(newWMS,true,nomServidor,layer.capesActiva, _map);\n}\n\n\nfunction checkExceptionsType(_server){\n\t\t\n\tvar exceptions='application/vnd.ogc.se_blank';\n\n\t\tif(_server.indexOf('instamaps.cat')==-1 ||\n\t\t _server.indexOf('betaserver.icgc')==-1 ||\n\t\t _server.indexOf('localhost')==-1 ||\n\t\t _server.indexOf('172.70.1.11')==-1){\n\t\t\t\n\t\t\texceptions='application/vnd.ogc.se_inimage';\n\n\t\t}\n\t\t\n\t\treturn exceptions;\n}","\n/**\n * Funcions tematics generals*\n * */\n\n\nfunction initButtonsTematic(){\n\t\n\taddHtmlInterficieTematics();\n\taddHtmlModalLayersTematic();\n\taddHtmlModalCategories();\n\taddHtmlModalBubbles();\n\t\n\t//botons tematic\n\tjQuery('#st_Color').on('click',function(){\n\t\tshowTematicLayersModal(tem_simple,jQuery(this).attr('class'));\n\t});\n\t\n\tjQuery('#st_Tema').on('click',function(){\n\t\tshowTematicLayersModal(tem_clasic,jQuery(this).attr('class'));\n\t});\n\n\tjQuery('#st_Size').on('click',function(){\n\t\tshowTematicLayersModal(tem_size,jQuery(this).attr('class'));\n\t});\n\t\n\tjQuery('#st_Heat').on('click',function(e) {\n\t\tshowTematicLayersModal(tem_heatmap,jQuery(this).attr('class'));\n\t\t\n\t});\t\n\n\tjQuery('#st_Clust').on('click',function(e) {\t\t\n\t\tshowTematicLayersModal(tem_cluster,jQuery(this).attr('class'));\n\t\t\n\t});\t\n}\n\nfunction showTematicLayersModal(tipus,className){\n//\tconsole.debug(\"showTematicLayersModal\");\n\tvar warninMSG=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest estil no es pot aplicar a cap capa de les que tens en el mapa')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\n\tvar warninMSG3D=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest estil no es pot aplicar amb modus 3D')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\n\t\n\t\n\tjQuery('.modal').modal('hide');\n\t\n\tjQuery('#dialog_layers_tematic').modal('show');\n\t\n\tjQuery('#stActiu').removeClass();\n\tjQuery('#stActiu').addClass(className);\n\t\n\tvar basicHTML ='<span lang=\"ca\">L\\'estil bàsic genera una visualització dels elements d\\'una capa uniformement per al conjunt.</span>'+\n\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t'<div class=\"imagePeu\">'+\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\n\t\t\t\t\t'\t<img src=\"css/images/basic.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\n\t\t\t\t\t'</div>' ;\n\tvar categoriesHTML ='<span lang=\"ca\">L\\'estil categories genera una visualització dels elements d\\'una capa a partir d\\'un camp, numèric o de text, de les dades.</span>'+\n\t\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t\t'<div class=\"imagePeu\">'+\n\t\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\n\t\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\n\t\t\t\t\t\t'\t<img src=\"css/images/categories.jpg\">'+\n\t\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\n\t\t\t\t\t\t'</div>' ;\n\tvar midesHTML ='<span lang=\"ca\">L\\'estil mides genera una visualització dels elements d\\'una capa a partir d\\'un camp numèric de les dades. Permet escollir entre interval graduat o proporcional al valor.</span>'+\n\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t'<div class=\"imagePeu\">'+\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\n\t\t\t\t\t'\t<img src=\"css/images/mides.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\n\t\t\t\t\t'</div>' ;\n\tvar heatMapHTML='<span lang=\"ca\">L\\'estil concentració genera una visualització dels elements d\\'una capa a partir de la densitat de les dades en forma de mapa de calor (heatmap).</span>'+\n\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t'<div class=\"imagePeu\">'+\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\n\t\t\t\t\t'\t<img src=\"css/images/concentracio.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\n\t\t\t\t\t'</div>' ;\n\tvar clusterHTML ='<span lang=\"ca\">L\\'estil agrupació genera una visualització dels elements d\\'una capa a partir de la densitat de les dades agrupats en grups de proximitat (clusters).</span>'+\n\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t'<div class=\"imagePeu\">'+\n\t\t\t\t\t'\t<img class=\"img1\" src=\"css/images/original.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu\" lang=\"ca\">Capa d\\'origen</span>'+\n\t\t\t\t\t'\t<img src=\"css/images/agrupacio.jpg\">'+\n\t\t\t\t\t'\t<span class=\"peu2\" lang=\"ca\">Visualització</span>'\n\t\t\t\t\t'</div>' ;\n\t\n\tif(tipus==tem_simple) jQuery('#txtTematic').html(basicHTML);\n\telse if (tipus==tem_clasic) jQuery('#txtTematic').html(categoriesHTML);\n\telse if (tipus==tem_size) jQuery('#txtTematic').html(midesHTML);\n\telse if (tipus==tem_heatmap)  jQuery('#txtTematic').html(heatMapHTML);\n\telse if (tipus==tem_cluster) jQuery('#txtTematic').html(clusterHTML); \n\t\n\tvar layers = [];\n\tjQuery.each( controlCapes._layers, function( key, value ) {\n\t\tvar layerOptions = this.layer.options;\n\t\t\n\t\tvar tipusCapa = layerOptions.tipus;\n\t\t//Si la capa no es multigeometrias\n\t\tif (layerOptions.geometryType != t_multiple){\n\t\t\t//Si la capa no esta tematitzada\n\t\t\tif(!layerOptions.tipusRang || layerOptions.tipusRang == tem_origen){\n\t\t\t\tif(tipus==tem_simple) {\n\t\t\t\t\tif (tipusCapa == t_tematic || tipusCapa == t_json || tipusCapa == t_visualitzacio || tipusCapa == t_url_file){ //tematic\n\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t}else if(tipusCapa == t_dades_obertes){ //dades obertes\n\t\t\t\t\t\tvar dataset = layerOptions.dataset;\n\t\t\t\t\t\tif (dataset != \"incidencies\" &&\n\t\t\t\t\t\t\tdataset != \"cameres\" &&\n\t\t\t\t\t\t\tdataset != \"meteo_comarca\" &&\n\t\t\t\t\t\t\tdataset != \"meteo_costa\"){\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else if (tipus==tem_clasic){\n\t\t\t\t\tif (tipusCapa == t_tematic || tipusCapa == t_visualitzacio || tipusCapa == t_url_file){ //tematic\n\t\t\t\t\t\tif (this.layer.options.dades){\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else if (tipus==tem_cluster || tipus==tem_heatmap) {\t\n\t\t\t\t\tif(estatMapa3D){\n\t\t\t\t\t\t$('#list_tematic_layers').html(warninMSG3D);\n\t\t\t\t\t}else{\n\t\t\t\t\t\tvar ftype = transformTipusGeometry(layerOptions.geometryType);\n\t\t\t\t\t\t//var ftype = layerOptions.geometryType;\n\t\t\t\t\t\tif(tipusCapa == t_dades_obertes || tipusCapa == t_json ||\n\t\t\t\t\t\t\t(tipusCapa == t_tematic && ftype == t_marker) ||\n\t\t\t\t\t\t\t(tipusCapa == t_url_file && ftype == t_marker) ||\n\t\t\t\t\t\t\t(tipusCapa == t_visualitzacio && ftype == t_marker) ||\n\t\t\t\t\t\t\t(tipusCapa == t_vis_wms)){\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else if (tipus==tem_size) {\n\t\t\t\t\tvar ftype = transformTipusGeometry(layerOptions.geometryType);\n\t\t\t\t\tif ((tipusCapa == t_tematic || tipusCapa == t_visualitzacio || tipusCapa == t_url_file) && ftype == t_marker){ //tematic\n\t\t\t\t\t\tif (this.layer.options.dades){\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tlayers.push(this);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else{\t\t\n\t\t\t\t\t$('#list_tematic_layers').html(warninMSG);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});// fi each\n\tif(layers.length ==0){\n\t\t\n\t\tif(estatMapa3D){\n\t\t\t\t\t\t$('#list_tematic_layers').html(warninMSG3D);\n\t\t\t\t\treturn;\n\t\t}else{\n\t\t$('#list_tematic_layers').html(warninMSG);\t\t\n\t\treturn;\n\t\t}\n\t}\n\tlayers = {layers: layers};\n\n\tvar source = jQuery(\"#tematic-layers-template\").html();\n\tvar template = Handlebars.compile(source);\n\tvar html = template(layers);\n\t$('#list_tematic_layers').html(html);\n\t\n\t$('.usr_wms_layer').on('click',function(e){\n\t\tvar _this = jQuery(this);\n\t\tvar data = _this.data();\n\t\tdata.from = tipus;\n\t\t//Revisar majus minus del \"geometryType\"!\n\t\tvar ftype = \"\";\n\t\tif(data.geometrytype) ftype = transformTipusGeometry(data.geometrytype);\n\t\telse ftype = transformTipusGeometry(data.geometrType);\n\t\t\n\t\tif (tipus == tem_simple){\n\t\t\tif (ftype == t_marker  || data.tipus == t_dades_obertes || data.tipus == t_json ){\n\t\t\t\tif (busy){\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\n\t\t\t\t}\n\t\t\t\telse obrirMenuModal('#dialog_estils_punts','toggle',data);\n\t\t\t}else if (ftype == t_polyline){\n\t\t\t\tif (busy){\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\n\t\t\t\t}\n\t\t\t\telse obrirMenuModal('#dialog_estils_linies','toggle',data);\n\t\t\t}else if (ftype == t_polygon){\n\t\t\t\tif (busy){\n\t\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\n\t\t\t\t\t$('#dialog_info_upload').modal('show');\n\t\t\t\t}\n\t\t\t\telse obrirMenuModal('#dialog_estils_arees','toggle',data);\n\t\t\t}\n\t\t}else if(tipus == tem_clasic){\n\t\t\tif (busy){\n\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\n\t\t\t\t$('#dialog_info_upload').modal('show');\n\t\t\t}\n\t\t\telse showModalTematicCategories(data);\n\t\t}else if(tipus == tem_heatmap){\n\t\t\tcreateHeatMap(controlCapes._layers[data.leafletid]);\n\t\t\tjQuery('#dialog_layers_tematic').modal('hide');\n\t\t}else if(tipus == tem_cluster){\n\t\t\tcreaClusterMap(controlCapes._layers[data.leafletid]);\n\t\t\tjQuery('#dialog_layers_tematic').modal('hide');\n\t\t}else if(tipus == tem_size){\n\t\t\tif (busy){\n\t\t\t\t$('#dialog_info_upload_txt').html(window.lang.translate(\"S'està executant una operació. Si us plau, espereu que aquesta acabi.\"));\n\t\t\t\t$('#dialog_info_upload').modal('show');\n\t\t\t}\n\t\t\telse showModalTematicBubbles(data);\n\t\t}\n\t});\n}\n\nfunction loadCacheTematicLayer(layer){\n\tvar defer = $.Deferred();\n\tvar data={\n\t\tbusinessId: layer.businessId,\n\t\tuid: layer.entitatUid\n\t};\n\t\n\tvar layerWms = layer;\n\tgetCacheTematicLayerByBusinessId(data).then(function(results){\n\t\tresults.results = jQuery.parseJSON( results.results );\n\t\treadTematic(defer, results, layerWms, layer);\n\t},function(results){\n\t\t//console.debug('getTematicLayerByBusinessId ERROR');\n\t\tdefer.reject();\n\t});\n\treturn defer.promise();\n}\n\nfunction loadTematicLayer(layer){\n\ttry {map.spin(true);} catch (Err) {}\n\tvar defer = $.Deferred();\n\tvar data={\n\t\tbusinessId: layer.businessId\n\t};\n\t\n\tvar layerWms = layer;\n\t\n\t//console.time(\"loadTematicLayer \" + layerWms.serverName);\n\tgetTematicLayerByBusinessId(data).then(function(results){\n\t\ttry {map.spin(false);} catch (Err) {}\n\t\treadTematic(defer, results, layerWms, layer);\n\t},function(results){\n\t\t//console.debug('getTematicLayerByBusinessId ERROR');\n\t\ttry {map.spin(false);} catch (Err) {}\n\t\tdefer.reject();\n\t});\n\treturn defer.promise();\n}\n\nfunction createPopupWindowData(player,type, editable, origen, capa){\n//\tconsole.debug(\"createPopupWindowData\");\n//\tconsole.debug(player);\n\tvar html='';\n\tif (player.properties.data.nom && !isBusinessId(player.properties.data.nom)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nom+'</h4>';\n\t}else if (player.properties.data.Nom && !isBusinessId(player.properties.data.Nom)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.Nom+'</h4>';\n\t}else if (player.properties.data.NOM && !isBusinessId(player.properties.data.NOM)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NOM+'</h4>';\n\t}else if(player.properties.name && !isBusinessId(player.properties.name)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.name+'</h4>';\n\t}else if(player.properties.data.name && !isBusinessId(player.properties.data.name)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.name+'</h4>';\n\t}else if(player.properties.data.Name && !isBusinessId(player.properties.data.Name)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.Name+'</h4>';\n\t}else if(player.properties.data.NAME && !isBusinessId(player.properties.data.NAME)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NAME+'</h4>';\n\t}else if(player.properties.nom && !isBusinessId(player.properties.nom)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.nom+'</h4>';\n\t}else if(player.properties.nombre && !isBusinessId(player.properties.nombre)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.nombre+'</h4>';\n\t}else if(player.properties.data.nombre && !isBusinessId(player.properties.data.nombre)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nombre+'</h4>';\n\t}else if(player.properties.data.nombre && !isBusinessId(player.properties.data.nombre)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.nombre+'</h4>';\n\t}else if(player.properties.data.NOMBRE && !isBusinessId(player.properties.data.NOMBRE)){\n\t\thtml+='<h4 class=\"my-text-center\">'+player.properties.data.NOMBRE+'</h4>';\n\t}\n\t\n\t\n\tvar isADrawarker=false;\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\tvar esVisor = ($(location).attr('href').indexOf('mapa')==-1);\n\t$.each( player.properties.data, function( key, value ) {\n\t\tif (key.toLowerCase()!=\"geomorigen\"){\n\t\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\n\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \n\t\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \n\t\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\n\t\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\n\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\tvar txt=value;\n\t\t\t\t\tif (!$.isNumeric(txt)) {\n\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t\t'</div>';\n\t\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\n\t\t\t\t\t\tif(undefined != capa.isPropertyNumeric && capa.isPropertyNumeric[key] && \n\t\t\t\t\t\t\t(esVisor && visor.colorscalecontrol && (\"\" == origen)) || (!esVisor && (\"\" == origen)) || (\"\" != origen && (key == capa.options.trafficLightKey)))\n\t\t\t\t\t\t{\n\t\n\t\t\t\t\t\t\tvar leafletid = ((\"undefined\" !== typeof player.properties.capaLeafletId) ? player.properties.capaLeafletId : (capa.hasOwnProperty(\"layer\") ? capa.layer._leaflet_id : \"\"));\n\t\t\t\t\t\t\t//Només ensenyem la icona del semafòric si és una capa no temàtica o bé si ho és però és semafòrica sense semàfor fixe (sempre que el camp sigui numèric)\n\t\t\t\t\t\t\thtml+='<div class=\"traffic-light-icon\" data-leafletid=\"' + leafletid + '\" data-origen=\"' + origen + '\" title=\"'+window.lang.translate('Temàtic per escala de color')+'\"></div>';\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\n\t\t\t\t\t\t\thtml += '<div class=\"traffic-light-icon-empty\"></div>';\n\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\tif (key=='text' || key=='TEXT') isADrawarker=true;\n\t\t\t\t\telse isADrawarker=false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\t\n\tif (isADrawarker && type==\"marker\") {\n\t\tvar auxLat = player._latlng.lat;\n\t\tauxLat = auxLat.toFixed(5);\n\t\tvar auxLon = player._latlng.lng;\n\t\tauxLon = auxLon.toFixed(5);\n\t\thtml+='<div class=\"popup_data_row\">';\n\t\thtml+='<div class=\"popup_data_key\">Latitud</div>';\n\t\thtml+='<div class=\"popup_data_value\">'+auxLat+'</div>';\n\t\thtml+= '</div>';\n\t\t\n\t\thtml+='<div class=\"popup_data_row\">';\n\t\thtml+='<div class=\"popup_data_key\">Longitud</div>';\n\t\thtml+='<div class=\"popup_data_value\">'+auxLon+'</div>';\n\t\thtml+= '</div>';\n\t}\n\t\n\tif(editable){\n\t\thtml+= '<div id=\"footer_edit\"  class=\"modal-footer\">'\n\t\t\t+'<ul class=\"bs-popup\">'\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_edit##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-map-marker verd\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Estils')+'\"></span></a>   </li>'\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_move##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-move magenta\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Editar')+'\"></span></a>   </li>'\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_remove##'+player._leaflet_id+'##'+type+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-trash vermell\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Esborrar')+'\"></span></a>   </li>'\n\t\t\t\t+'<li class=\"edicio-popup\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+player.properties.capaLeafletId+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"'+window.lang.translate('Dades')+'\"></span></a>   </li>'\n\t\t\t\t+'<li class=\"edicio-popup\"><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#mapestematics\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></li>'\n\t\t\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t+'</div>';\t\n\t}else{\n\t\tvar capaLeafletId = player.properties.capaLeafletId;\n\t\tif(isValidValue(origen)) {\n\t\t\tcapaLeafletId = origen; \n\t\t}\n\t\thtml+= '<div id=\"footer_edit\"  class=\"modal-footer\">'\n\t\t\t+'<ul class=\"bs-popup\">'\t\t\t\t\t\t\n\t\t\t\t+'<li class=\"consulta-popup\"><a id=\"feature_data_table##'+player._leaflet_id+'##'+type+'##'+capaLeafletId+'\" lang=\"ca\" href=\"#\"><span class=\"glyphicon glyphicon-list-alt blau-left\" data-toggle=\"tooltip\" data-placement=\"right\" title=\"'+window.lang.translate('Obrir la taula de dades')+'\"></span></a>   </li>'\n\t\t\t+'</ul>'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t+'</div>';\t\t\t\n\t}\n\n\tif(type == t_polyline && player.properties.mida){\n\t\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Longitud')+':</b> '+player.properties.mida+'</div>';\t\n\t}else if(type == t_polygon && player.properties.mida){\n\t\tif (player.properties.mida.indexOf(\"NaN\")==-1)\thtml+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+player.properties.mida+'</div>';\n\t\telse html+='<div id=\"mida_pres\"><b>'+window.lang.translate('Àrea')+':</b> '+L.GeometryUtil.readableArea(L.GeometryUtil.geodesicArea(player.getLatLngs()),true)+'</div>';\n\t}\n\thtml+='</div>';\n\t//he quitado el openPopup() ya que si la capa no està activa no se ha cargado en el mapa y da error.\n\tplayer.bindPopup(html,{'offset':[0,-25]});\n\n\t//Afegim els events de clicks per al semafòric\n\tjQuery(document).on('click', \".traffic-light-icon\", function(e) {\n\n\t\te.stopImmediatePropagation();\n\t\tvar layerId = $(this).data(\"leafletid\");\n\t\tvar parentId = $(this).data(\"origen\");\n\t\tvar key = $(this).prev().prev().text();\n\t\tvar value = parseFloat($(this).prev().text());\n\t\tvar layer = null;\n\t\tvar control = null;\n\t\tif(\"\" == parentId)\n\t\t{\n\n\t\t\t//És una capa no temàtica, hem de crear la de previsualització\n\t\t\tlayer = controlCapes._layers[layerId].layer;\n\t\t\tcontrol = Semaforic(self.isEditing);\n\n\t\t}\n\t\telse\n\t\t{\n\n\t\t\t//És una capa temàtica, mirem si és una capa semafòrica de previsualització\n\t\t\tlayer = controlCapes._layers[parentId].layer;\n\t\t\tif(layer.hasOwnProperty(\"semaforics\") && \"undefined\" !== typeof layer.semaforics[layerId])\n\t\t\t\tcontrol = layer.semaforics[layerId];\n\t\t\telse\n\t\t\t{\n\n\t\t\t\t//Si hem arribat aquí és que és una capa semafòrica, utilitzem la capa actual\n\t\t\t\tcontrol = Semaforic();\n\t\t\t\tvar businessId = controlCapes._layers[parentId]._layers[layerId].layer.options.businessId;\n\t\t\t\tvar options = JSON.parse(controlCapes._visLayers[businessId].options);\n\t\t\t\tvar paletaEstils = [controlCapes._visLayers[businessId].estil[0].color,\n\t\t\t\t\tcontrolCapes._visLayers[businessId].estil[1].color,\n\t\t\t\t\tcontrolCapes._visLayers[businessId].estil[2].color\n\t\t\t\t\t]\n\t\t\t\tcontrol.setVisualization(controlCapes._layers[parentId]._layers[layerId]);\n\t\t\t\tcontrol.setLayer(controlCapes._visLayers[businessId]);\n\t\t\t\tcontrol.setLayerOptions(controlCapes._options[businessId]);\n\t\t\t\tcontrol.setPalette(paletaEstils, options.reverse);\n\n\t\t\t}\n\n\t\t}\n\n\t\tcontrol.render($.Deferred(), key, value, layer).then(function(data) {\n\t\t\tif(!layer.hasOwnProperty(\"semaforics\"))\n\t\t\t\tlayer.semaforics = {};\n\t\t\n\t\t\tlayer.semaforics[data] = control;\n\t\t\t//Canviem el valor de referència de la capa al control de capes si el conté\n\t\t\tvar name = Semaforic.getUpdatedLayerName($(\"#\" + layerId + \".editable\").text(), value);\n\t\t\tif(self.isEditing)\n\t\t\t\t$(\"#\" + layerId + \".editable\").editable(\"setValue\", name, true);\n\t\t\telse\n\t\t\t\t$(\"#\" + layerId + \".editable\").text(name);\n\n\t\t});\n\n\t});\n\t\n\t//Afegim events/accions al popUp\n\tjQuery(document).on('click', \".bs-popup li a\", function(e) {\n\t\te.stopImmediatePropagation();\n\t\tvar accio;\n\t\tif(undefined != jQuery(this).attr('id') && jQuery(this).attr('id').indexOf('##')!=-1){\t\n\t\t\taccio=jQuery(this).attr('id').split(\"##\");\t\t\t\t\n\t\t}\n\t\t\n\t\tif (accio!=undefined && accio[1]!=undefined) objEdicio.featureID=accio[1];\n\t\t\n\t\tif(undefined != accio[0] && accio[0].indexOf(\"feature_edit\")!=-1){\n\n\t\t\t//Update modal estils, amb estil de la feature seleccionada\n\t\t\tvar obj = map._layers[accio[1]];\n\t\t\t//console.debug(obj);\n\t\t\tif(obj.options.icon /*|| obj.options.icon.options.markerColor.indexOf(\"punt_r\")!=-1*/){\n\t\t\t\tvar icon = obj.options.icon.options;\t\n\t\t\t}else if(obj._options){\n\t\t\t\tvar icon = obj._options;\n\t\t\t}else{\n\t\t\t\tvar icon = obj.options;\n\t\t\t}\n\t\t\tupdateDialogStyleSelected(icon);\n\t\t\t\n\t\t\tif(accio[2].indexOf(\"marker\")!=-1){\n\t\t\t\tobrirMenuModal('#dialog_estils_punts','toggle',from_creaPopup);\n\t\t\t}else if(accio[2].indexOf(\"polygon\")!=-1){\n\t\t\t\tobrirMenuModal('#dialog_estils_arees','toggle',from_creaPopup);\n\t\t\t}else{\n\t\t\t\tobrirMenuModal('#dialog_estils_linies','toggle',from_creaPopup);\n\t\t\t}\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_data_table\")!=-1){\n\t\n\t\t\t$('#modal_data_table').modal('show');\n\t\t\tvar featureId=objEdicio.featureID;\n\t\t\tif (featureId==undefined) featureId=accio[2];\n\t\t\tif (map._layers[featureId]==undefined) {\n\t\t\t\ttry{\n\t\t\t\t\tif (accio[6]!=undefined) featureId=accio[6];\n\t\t\t\t\tvar props=map._layers[featureId].properties;\n\t\t\t\t\tif (props==undefined) props=map._layers[featureId].options;\n\t\t\t\t\tif (accio[3]==undefined)  fillModalDataTable(controlCapes._layers[accio[2]],props.businessId);\n\t\t\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],props.businessId);\n\t\t\t\t}\n\t\t\t\tcatch(err){\n\t\t\t\t\tconsole.debug(err);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse fillModalDataTable(controlCapes._layers[accio[3]],map._layers[featureId].properties.businessId);\n\t\t\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_remove\")!=-1){\n\t\t\tmap.closePopup();\n\t\t\tvar data = {\n\t            businessId: map._layers[objEdicio.featureID].properties.businessId,\n\t            uid: Cookies.get('uid')\n\t        };\n\t\t\n\t\t\tvar features = {\n\t\t\t\ttype:\"Feature\",\n\t\t\t\tid: 3124,\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.businessId,\n\t\t\t\tproperties: map._layers[objEdicio.featureID].properties.data,\n\t\t\t\testil: map._layers[objEdicio.featureID].properties.estil,\n\t\t\t\tgeometry: map._layers[objEdicio.featureID].properties.feature.geometry\n\t\t\t};\t\t\t\t\n\t\t\t\n\t\t\tfeatures = JSON.stringify(features);\n\t\t\t\n\t\t\tvar data = {\n\t\t\t\tbusinessId: map._layers[objEdicio.featureID].properties.capaBusinessId,//bID de la visualitzacio-capa\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tfeatures: features\n\t\t\t};\n\t\t\tvar businessIdCapaOrigen=map._layers[objEdicio.featureID].properties.capaBusinessId;\n\t\t\tremoveGeometriaFromVisualitzacio(data).then(function(results){\n\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t/*var capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\n\t\t\t\t\tvar layer = map._layers[objEdicio.featureID];\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\n\t\t\t\t\tvar layerMap=map._layers[capaLeafletId];\n\t\t\t\t\tvar layerMare = controlCapes._layers[capaLeafletId];\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\n\t\t\t\t\tactualitzacioTematic(layerMare,businessIdCapaOrigen,null,null,null,\"baixa\");  \n\t\t\t\t\t*/\n\t\t\t\t\t\n\t\t\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\n\t\t\t\t\tvar capaBusinessId = map._layers[objEdicio.featureID].properties.capaBusinessId;\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) map._layers[capaLeafletId].removeLayer(map._layers[objEdicio.featureID]);\t\t\t\t\t\n\t\t\t\t\tif(map._layers[objEdicio.featureID]!= null) map.removeLayer(map._layers[objEdicio.featureID]);\t\n\t\t\t\t\tif(map._layers[capaLeafletId]!= undefined) {\n\t\t\t\t\t\tupdateFeatureCount(map._layers[capaLeafletId].options.businessId, null);\n\t\t\t\t\t}\n\t\t\t\t\telse {\t\t\t\t\t\t\n\t\t\t\t\t\tupdateFeatureCount(capaBusinessId, null);\t\t\n\t\t\t\t\t}\t\t\n\t\t\t\t\t var layer = controlCapes._layers[capaLeafletId];\n\t\t\t\t\t//recarrego les sublayers de la capa modificada\t\n\t\t\t\t\tactualitzacioTematic(layer,businessIdCapaOrigen,null,null,null,\"baixa\");\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\n\t\t\t\t}\n\t\t\t},function(results){\n\t\t\t\tconsole.debug(\"ERROR deleteFeature\");\n\t\t\t});\t\t\t\t\t\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_text\")!=-1){\n\t\t\tmodeEditText();\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_move\")!=-1){\n\t\t\tobjEdicio.esticEnEdicio=true;\n\t\t\tvar capaLeafletId = map._layers[objEdicio.featureID].properties.capaLeafletId;\t\n\t\t\tobjEdicio.capaEdicioLeafletId = capaLeafletId;//Ho guarda per despres poder actualitzar vis filles\n\t\t\t//Actualitzem capa activa\n\t\t\tif (capaUsrActiva){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t}\n\t\t\tcapaUsrActiva = map._layers[capaLeafletId];\n\t\t\t\n\t\t\tvar capaEdicio = new L.FeatureGroup();\n\t\t\tcapaEdicio.addLayer(map._layers[objEdicio.featureID]);\n\t\t\tcapaUsrActiva.removeLayer(map._layers[objEdicio.featureID]);\n\t\t\tmap.addLayer(capaEdicio);\n\t\t\t\n\t\t\tvar opcionsSel={\n\t\t\t\t\tcolor: '#FF1EE5',\n\t\t\t\t\t\"weight\": 7,\n\t\t\t\t\topacity: 0.6,\n\t\t\t\t\tdashArray: '1, 1',\n\t\t\t\t\tfill: true,\n\t\t\t\t\tfillColor: '#fe57a1',\n\t\t\t\t\tfillOpacity: 0.1\n\t\t\t\t};\n\t\t\t\n\t\t\t/*crt_Editing=new L.EditToolbar.SnapEdit(map, {\n\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\tselectedPathOptions: opcionsSel,\n\t\t\t\tsnapOptions: {\n\t\t\t\t\tguideLayer: guideLayers\n\t\t\t\t}\n\t\t\t});*/\n\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\n\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\tselectedPathOptions: opcionsSel\n\t\t\t});\n\t\t\tcrt_Editing.enable();\n\t\t\t\n\t\t\t//crt_Editing.enable();\n\t\t\t\n\t\t\t/*if(map._layers[objEdicio.featureID].properties.tipusFeature==\"marker\" && map._layers[objEdicio.featureID].options.isCanvas){\n\t\t\t\tcrt_Editing=new L.EditToolbar.Edit(map, {\n\t\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\t\tselectedPathOptions: opcionsSel\n\t\t\t\t});\n\t\t\t\tcrt_Editing.enable();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcrt_Editing=new L.EditToolbar.SnapEdit(map, {\n\t\t\t\t\tfeatureGroup: capaEdicio,\n\t\t\t\t\tselectedPathOptions: opcionsSel,\n\t\t\t\t\tsnapOptions: {\n\t\t\t\t\t\tguideLayer: guideLayers\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tcrt_Editing.enable();\n\t\t\t\t//activarSnapping(capaEdicio);\n\t\t\t}*/\n\t\t\t\n\t\t\t//activarSnapping(capaEdicio);\t\t\t\n\t\t\t\n\t\t\tmap.closePopup();\n\t\t\t\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_no\")!=-1){\n\t\t\tjQuery('.popup_pres').show();\n\t\t\tjQuery('.popup_edit').hide();\n\t\t\t\n\t\t}else if(undefined != accio[0] && accio[0].indexOf(\"feature_ok\")!=-1){\n\t\t\tif(objEdicio.edicioPopup=='textFeature'){\n\t\t\t\tvar txtTitol=jQuery('#titol_edit').val();\n\t\t\t\tvar txtDesc=jQuery('#des_edit').val();\n\t\t\t\tif (txtDesc.indexOf(\"'\")>-1) txtDesc = txtDesc.replaceAll(\"'\",'\"');\n\t\t\t\tupdateFeatureNameDescr(map._layers[objEdicio.featureID],txtTitol,txtDesc);\n\n\t\t\t}else if(objEdicio.edicioPopup=='textCapa'){\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\n\t\t\t\t\tjQuery('#cmbCapesUsr option:selected').text(jQuery('#capa_edit').val());\t\n\t\t\t\t\tjQuery('.popup_pres').show();\n\t\t\t\t\tjQuery('.popup_edit').hide();\n\t\t\t\t}else{\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\n\t\t\t\t}\n\t\t\t}else if(objEdicio.edicioPopup=='nouCapa'){\n\t\t\t\tif(jQuery('#capa_edit').val()!=\"\"){\n\t\t\t\t\tgeneraNovaCapaUsuari(map._layers[objEdicio.featureID],jQuery('#capa_edit').val());\n\t\t\t\t}else{\n\t\t\t\t\talert(window.lang.translate('Has de posar un nom de capa'));\t\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t//accio tanca\n\t\t\tmap.closePopup();\n\t\t}\n\t});\t\n\n\tplayer.on('popupopen', function(e){\n\t\t//console.debug(e);\n\t\tif(objEdicio.esticEnEdicio){//Si s'esta editant no es pot editar altre element\n\t\t\tmap.closePopup();\n\t\t}\n\t});\n\n\treturn html;\n}\n\n/*****************************/\n\n\n/** Funcions que actualitzen l'estil per defecte, al seleccionat al dialeg d'estils\n * \tper punts, línies, i polígons. \n * */\n\nfunction changeDefaultLineStyle(canvas_linia){\n\tvar estilTMP = default_line_style;\n\testilTMP.color=canvas_linia.strokeStyle;\n\testilTMP.weight=canvas_linia.lineWidth;\n\testilTMP.tipus=t_polyline;\n\t\n\t\n\t\n\tif(objEdicio.obroModalFrom==from_creaCapa){\n\t\t drawControl.options.polyline.shapeOptions= estilTMP;\n\t}\n\treturn estilTMP;\n}\n\nfunction changeDefaultAreaStyle(canvas_pol){\n\tvar estilTMP= default_area_style;\n\testilTMP.fillColor=canvas_pol.fillStyle;\n\testilTMP.fillOpacity=canvas_pol.opacity;\n\testilTMP.weight=canvas_pol.lineWidth;\n\testilTMP.color=canvas_pol.strokeStyle;\n\testilTMP.tipus=t_polygon;\n\t\n\tif(objEdicio.obroModalFrom==from_creaCapa){\n\t\tdrawControl.options.polygon.shapeOptions= estilTMP;\n\t}\n\treturn estilTMP;\n}\n\nfunction changeDefaultPointStyle(estilP) {\n\t//console.debug(\"changeDefaultPointStyle\");\n\tvar puntTMP= new L.AwesomeMarkers.icon(default_marker_style);\n\tvar _iconFons=estilP.iconFons.replace('awesome-marker-web awesome-marker-icon-','');\n\tvar _iconGlif=estilP.iconGlif;\t\n\tvar cssText=\"\";\n\t\n\tif(_iconGlif.indexOf(\"fa fa-\")!=-1){\n\t\t_iconGlif=estilP.iconGlif.replace('fa fa-','');\n\t};\n\t\n\tif (_iconGlif.indexOf(\"font\")!=-1){\n\t\t_iconGlif = _iconGlif.substring(0,_iconGlif.indexOf(\" \")) ;\n\t}\n//\tconsole.debug(_iconFons);\n\t\n\tvar _colorGlif=estilP.colorGlif;\n\t\n\tif(_iconFons.indexOf(\"_r\")!=-1){ //sóc rodó\t\t\n\t\tvar num=estilP.size;\n\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\n\t\tvar tt=estilP.fontsize;\n\t\tpuntTMP.options.divColor=estilP.divColor;\n\t\tif(tt==\"9px\" || tt==\"8px\"){\n\t\t\tcssText=\"font9\";\t\t\t\n\t\t}else if(tt==\"11px\" || tt==\"10.5px\"){\n\t\t\tcssText=\"font11\";\n\t\t}else if(tt==\"12px\"){\n\t\t\tcssText=\"font12\";\n\t\t}else if(tt==\"15px\"){\n\t\t\tcssText=\"font15\";\n\t\t}else if(tt==\"17px\"){\n\t\t\tcssText=\"font17\";\t\t\n\t\t}\n\t\t\t\t\n\t\tpuntTMP.options.fillColor =estilP.divColor;\n\t\tif(_iconGlif==\"\" || _iconGlif==\"undefined\" || _iconGlif==null){//no tin glif soc Canvas\n\t\t\tpuntTMP.options.icon=\"\";\n\t\t\tpuntTMP.options.radius = parseInt(estilP.size/2.4);\n\t\t\tpuntTMP.options.isCanvas=true;\n\t\t}else{\n\t\t\tpuntTMP.options.iconAnchor= new L.Point(parseInt(num/2), parseInt(num/2));\n\t\t\tpuntTMP.options.iconSize = new L.Point(num, num);\n\t\t\tconsole.debug(puntTMP.options.icon);\n\t\t\tpuntTMP.options.icon=_iconGlif + \" \"+cssText;\n\t\t\tconsole.debug(puntTMP.options.icon);\n\t\t\tpuntTMP.options.isCanvas=false;\n\t\t}\n\t}else{ // sóc pinxo\n\t\tpuntTMP.options.iconAnchor= new L.Point(14, 42);\n\t\tpuntTMP.options.iconSize = new L.Point(28, 42);\n\t\tpuntTMP.options.shadowSize = new L.Point(36, 16);\n\t\tpuntTMP.options.divColor='transparent';\n\t\tif(_iconGlif==\"\" || _iconGlif==\"undefined\" || _iconGlif==null){\n\t\t\tpuntTMP.options.icon=\"\";\n\t\t}else{\n\t\t\tpuntTMP.options.icon=_iconGlif + \" \"+cssText;\t\t\t\n\t\t}\n\t\tpuntTMP.options.isCanvas=false;\n\t}\n\tpuntTMP.options.markerColor=_iconFons;\n\tif(puntTMP.options.icon==\"\"){\n\t\tpuntTMP.options.iconColor=\"#000000\";\n\t}else{\n\t\tpuntTMP.options.iconColor=_colorGlif;\n\t}\n\t\n\tif(objEdicio.obroModalFrom==from_creaCapa){\n\t\tdefaultPunt=puntTMP;\n\t}\n\treturn puntTMP;\n}\n/*****************************/\n\n/**Funcions per crear un objecte de tipus estil, amb les característiques que li passes\n * per punt, línia, poligon */\n\nfunction createFeatureLineStyle(style){\n\tvar estilTMP = default_line_style;\n\testilTMP.color=style.color;\n\testilTMP.weight=style.lineWidth;\n\testilTMP.tipus=t_polyline;\n\treturn estilTMP;\n}\n\nfunction createFeatureAreaStyle(style){\n\tvar estilTMP= default_area_style;\n\testilTMP.fillColor=style.color;\n\testilTMP.fillOpacity=style.opacity/100;\n\testilTMP.weight=style.borderWidth;\n\testilTMP.color=style.borderColor;\n\testilTMP.tipus=t_polygon;\n\treturn estilTMP;\n}\n\nfunction createFeatureMarkerStyle(style, num_geometries){\n\t//console.debug(\"createFeatureMarkerStyle\");\n\tif (!num_geometries){\n\t\tnum_geometries = num_max_pintxos - 1;\n\t}\n\tif (style.marker && num_geometries <= num_max_pintxos){\n\t\t//Especifiques per cercle amb glyphon\n\t\tif(style.marker == 'punt_r'){\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_circuloglyphon_style);\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\n\t\t\tpuntTMP.options.icon = style.simbol;\n\t\t\tpuntTMP.options.markerColor = style.marker;\n\t\t\tpuntTMP.options.isCanvas=false;\n\t\t\tpuntTMP.options.divColor= style.color;\n\t\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\n\t\t\tpuntTMP.options.radius = style.radius;\n\t\t\tvar anchor = style.iconAnchor.split(\"#\");\n\t\t\tvar size = style.iconSize.split(\"#\");\n\t\t\tpuntTMP.options.iconAnchor.x = parseInt(anchor[0]);\n\t\t\tpuntTMP.options.iconAnchor.y = parseInt(anchor[1]);\n\t\t\tpuntTMP.options.iconSize.x = size[0];\n\t\t\tpuntTMP.options.iconSize.y = size[1];\n\t\t}else{\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_marker_style);\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\n\t\t\tpuntTMP.options.icon = style.simbol;\n\t\t\tpuntTMP.options.markerColor = style.marker;\n\t\t\tpuntTMP.options.isCanvas=false;\n\t\t\tpuntTMP.options.iconAnchor.x = 14;\n\t\t\tpuntTMP.options.iconAnchor.y = 42;\n\t\t\tpuntTMP.options.iconSize.x = 28;\n\t\t\tpuntTMP.options.iconSize.y = 42;\n\t\t}\n\t}else{ //solo circulo\n\t\tvar puntTMP = { \n\t\t\tradius: style.simbolSize, \n\t\t\tisCanvas: true,\n\t\t\tfillColor: style.color,\n\t\t\tcolor:  style.borderColor,\n\t\t\tweight:  style.borderWidth,\n\t\t\tfillOpacity: style.opacity/100,\n\t\t\topacity: 1,\n\t\t\ttipus: t_marker\n\t\t};\n\t}\n\treturn puntTMP;\n}\n\nfunction createRangStyle(ftype, style, num_geometries){\n\tvar rangStyle;\n\tif (style){\n\t\tif (ftype === t_marker){\n\t\t\trangStyle = createFeatureMarkerStyle(style, num_geometries);\n\t\t}else if (ftype === t_multipoint){\n\t\t\trangStyle = createFeatureMarkerStyle(style, num_geometries);\n\t\t}else if (ftype === t_polyline){\n\t\t\trangStyle = createFeatureLineStyle(style);\n\t\t}else if (ftype === t_multilinestring){\n\t\t\trangStyle = createFeatureLineStyle(style);\n\t\t}else if (ftype === t_polygon){\n\t\t\trangStyle = createFeatureAreaStyle(style);\n\t\t}else if (ftype === t_multipolygon){\n\t\t\trangStyle = createFeatureAreaStyle(style);\n\t\t}\n\t}else{\n\t\tif (ftype === t_marker){\n\t\t\trangStyle = L.AwesomeMarkers.icon(default_marker_style);\n\t\t}else if (ftype === t_multipoint){\n\t\t\trangStyle = L.AwesomeMarkers.icon(default_marker_style);\n\t\t}else if (ftype === t_polyline){\n\t\t\trangStyle = default_line_style;\n\t\t}else if (ftype === t_multilinestring){\n\t\t\trangStyle = default_line_style;\n\t\t}else if (ftype === t_polygon){\n\t\t\trangStyle = default_area_style;\n\t\t}else if (ftype === t_multipolygon){\n\t\t\trangStyle = default_area_style;\n\t\t}\n\t}\n\treturn rangStyle;\n}\n/*************************************************/\n\n/**Funcio que actualitza els rangs de la capa quan: \n * - Es canvia l'estil d'una feature\n * - Es mou una feature d'una capa a un altre\n * - Cada cop que es carrega un fitxer (dragdrop urlfile) i es vol centrar al mapa als features*/\t\nfunction getRangsFromLayer(layer){\n\t//console.debug(\"getRangsFromLayer\");\n\tif (layer.options.tipus == t_tematic){\n\t\tvar styles = jQuery.map(layer.getLayers(), function(val, i){\n\t\t\treturn {key: val.properties.businessId, style: val};\n\t\t});\n\t\t\n\t\tvar tematic = layer.options;\n\t\ttematic.tipusRang = tematic.tipusRang ? tematic.tipusRang : tem_origen;\n\t\ttematic.businessid = tematic.businessId; \n\t\ttematic.leafletid = layer._leaflet_id;\n\t\ttematic.geometrytype = tematic.geometryType;\n\t\ttematic.from = tematic.tipusRang;\n\t\t\n\t\tvar rangs = getRangsFromStyles(tematic, styles);\n        rangs = JSON.stringify({rangs:rangs});\n        \n        var data = {\n          businessId: tematic.businessid,\n          uid: Cookies.get('uid'),\n          tipusRang: tematic.from,\n          rangs: rangs\n        };\n              \n        updateTematicRangs(data).then(function(results){\n        \t//console.debug(results);\n        },function(results){\n\t\t\t//TODO error\n\t\t\tconsole.debug(\"getRangsFromLayer ERROR\");\n\t\t});\n\t}\n}\n\n\nfunction getMarkerRangFromStyle(styles){\n\t\n\tif (styles.options.isCanvas){\n\t\tvar rang = {\n\t\t\tisCanvas: true,\t\n\t\t\tsimbolSize : styles.options.radius, \n\t\t\tcolor :  jQuery.Color(styles.options.fillColor).toHexString(),\n\t\t\tborderColor :  styles.options.color,\n\t\t\tborderWidth :  styles.options.weight,\n\t\t\topacity: (styles.options.fillOpacity * 100),\n\t\t\tlabel : false,\n\t\t\tlabelSize : 10,\n\t\t\tlabelFont : 'arial',\n\t\t\tlabelColor : '#000000',\t\t\t\t\t\n\t\t};\n\t}else{\n\t\t//CAL??\n\t\tif(jQuery.type(styles.options.icon) === \"object\"){\n\t\t\tvar auxOptions = styles.options.icon.options;\n\t\t}else{\n\t\t\tvar auxOptions = styles.options;\n\t\t}\n\t\t\n\t\tvar rang = {\n\t\t\tisCanvas: false,\n\t\t\tcolor : auxOptions.divColor,//auxOptions.fillColor,//Color principal\n\t\t\tmarker: auxOptions.markerColor,//Si es de tipus punt_r o el color del marker\n\t\t\tsimbolColor: auxOptions.iconColor,//Glyphon\n\t\t\tradius : auxOptions.radius,//Radius\n\t\t\ticonSize : auxOptions.iconSize.x+\"#\"+auxOptions.iconSize.y,//Size del cercle\n\t\t\ticonAnchor : auxOptions.iconAnchor.x+\"#\"+auxOptions.iconAnchor.y,//Anchor del cercle\n\t\t\tsimbol : $.trim(auxOptions.icon),//tipus glyph\n\t\t\topacity : (auxOptions.opacity * 100),\n\t\t\tlabel : false,\n\t\t\tlabelSize : 10,\n\t\t\tlabelFont : 'arial',\n\t\t\tlabelColor : '#000000',\n\t\t};\n\t}\n\treturn rang;\n}\n\nfunction getLineRangFromStyle(styles){\n\tvar rang = {\n\t\tcolor: styles.strokeStyle,//styles.color,\n\t\tlineWidth: styles.lineWidth,//styles.weight,\n\t\tlineStyle : 'solid',\n\t\tborderWidth : 2,\n\t\tborderColor : styles.strokeStyle,\t\t\t\t\n\t\t//opacity: (styles.opacity * 100),\n\t\topacity: 100,\n\t\tlabel : false,\n\t\tlabelSize : 10,\n\t\tlabelFont : 'arial',\n\t\tlabelColor : '#000000'\n\t};\t\n\treturn rang;\n}\n\nfunction getPolygonRangFromStyle(styles){\n\tstyles.fillColor = jQuery.Color(styles.fillColor).toHexString();\n\n\tvar rang = {\n\t\tborderWidth: styles.lineWidth,//styles.weight,\n\t\tborderColor: styles.strokeStyle,//styles.color,\n\t\tcolor: rgb2hex(styles.fillStyle),//styles.fillColor,\n\t\topacity: (styles.opacity * 100),//(styles.fillOpacity * 100),\n\t\tlineStyle : 'solid',\n\t\tlabel : false,\n\t\tlabelSize : 10,\n\t\tlabelFont : 'arial',\n\t\tlabelColor : '#000000',\n\t\tweight: styles.lineWidth\n\t};\t\n\t\n\treturn rang;\n}\n\nfunction getRangsFromStyles(tematic, styles){\n\t//console.debug(\"getRangsFromStyles\");\n\tif (tematic.tipus == t_dades_obertes){\n\t\ttematic.geometrytype = t_marker;\n\t}\n\t\n//\tvar ftype_vell = transformTipusGeometry(tematic.geometrytype);\n//\tvar ftype = transformTipusGeometry(tematic.geometryType);\n\t\n\t//Revisar majus minus del \"geometryType\"!\n\tvar ftype = \"\";\n\tif(tematic.geometrytype) ftype = transformTipusGeometry(tematic.geometrytype);\n\telse if(tematic.geometryType) ftype = transformTipusGeometry(tematic.geometryType);\n\telse ftype = transformTipusGeometry(tematic.geometrType);\n\t\n\t/*Control cas multiple\n\tif(ftype == t_multiple && styles.options){\n\t\t ftype = transformTipusGeometry(styles.options.tipus);\n\t}*/\n\t\n\tvar rangs = [];\n\tif (jQuery.isArray(styles)){\n\t\tjQuery.each(styles, function(i, val){\n\t\t\tvar rang = getRangsFromStyles(tematic, val.style);\n\t\t\tif(rang[0]){\n\t\t\t\trang[0].featureLeafletId = val.style._leaflet_id;\n\t\t\t\trang = rang[0];\n\t\t\t\trang.valorMax = val.key;\n\t\t\t\trangs.push(rang);\t\t\t\n\t\t\t}\n\n\t\t});\n\t}else{\n\t\tif (ftype == t_marker){\n\t\t\t\n\t\t\tif (styles.options.isCanvas){\n\t\t\t\tvar rang = {\n\t\t\t\t\tisCanvas: true,\t\n\t\t\t\t\tsimbolSize : styles.options.radius, \n\t\t\t\t\tcolor :  jQuery.Color(styles.options.fillColor).toHexString(),\n\t\t\t\t\tborderColor :  styles.options.color,\n\t\t\t\t\tborderWidth :  styles.options.weight,\n\t\t\t\t\topacity: (styles.options.fillOpacity * 100),\n\t\t\t\t\tlabel : false,\n\t\t\t\t\tlabelSize : 10,\n\t\t\t\t\tlabelFont : 'arial',\n\t\t\t\t\tlabelColor : '#000000',\t\t\t\t\t\n\t\t\t\t};\n\t\t\t}else{\n\t\t\t\t\n//\t\t\t\tvar auxOptions = styles.options;\n//\t\t\t\twhile(jQuery.type(styles.options.icon) === \"object\"){\n//\t\t\t\t\t//if(jQuery.trim(styles.options.icon) != \"\" && jQuery.isPlainObject(styles.options.icon)){\n//\t\t\t\t\tstyles.options = styles.options.icon.options;\n//\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif(jQuery.type(styles.options.icon) === \"object\"){\n\t\t\t\t\tvar auxOptions = styles.options.icon.options;\n\t\t\t\t}else{\n\t\t\t\t\tvar auxOptions = styles.options;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvar rang = {\n\t\t\t\t\tisCanvas: false,\n\t\t\t\t\t//legenda : 'TODO ficar llegenda',//TODO ficar nom de la feature del popup de victor\n//\t\t\t\t\tvalorMax : \"feature\" + fId,\n\t\t\t\t\t//Canviat a divColor, si es marker, sera sempre 'transparent'\n\t\t\t\t\tcolor : auxOptions.divColor,//auxOptions.fillColor,//Color principal\n\t\t\t\t\tmarker: auxOptions.markerColor,//Si es de tipus punt_r o el color del marker\n\t\t\t\t\tsimbolColor: auxOptions.iconColor,//Glyphon\n\t\t\t\t\tradius : auxOptions.radius,//Radius\n\t\t\t\t\ticonSize : auxOptions.iconSize.x+\"#\"+auxOptions.iconSize.y,//Size del cercle\n\t\t\t\t\ticonAnchor : auxOptions.iconAnchor.x+\"#\"+auxOptions.iconAnchor.y,//Anchor del cercle\n\t\t\t\t\tsimbol : $.trim(auxOptions.icon),//tipus glyph\n\t\t\t\t\topacity : (auxOptions.opacity * 100),\n\t\t\t\t\tlabel : false,\n\t\t\t\t\tlabelSize : 10,\n\t\t\t\t\tlabelFont : 'arial',\n\t\t\t\t\tlabelColor : '#000000',\n\t\t\t\t};\n\t\t\t}\n\t\t}else if (ftype == t_polyline){\n\t\t\t\n\t\t\tif (styles._options){\n\t\t\t\tstyles.options = styles._options;\n\t\t\t}else if(!styles.options) styles.options = styles;\n\t\t\t\n\t\t\tvar rang = {\n\t\t\t\tcolor: styles.options.color,\n\t\t\t\tlineWidth: styles.options.weight,\n\t\t\t\tlineStyle : 'solid',\n\t\t\t\tborderWidth : 2,\n\t\t\t\tborderColor : styles.options.color,\t\t\t\t\n\t\t\t\topacity: (styles.options.opacity * 100),\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000'\n\t\t\t};\n\t\t}else if (ftype == t_polygon){\n\t\t\tif (styles._options){\n\t\t\t\tstyles = styles._options;\n\t\t\t}else if(styles.options){\n\t\t\t\tstyles = styles.options;\n\t\t\t}\n\t\t\tstyles.fillColor = jQuery.Color(styles.fillColor).toHexString();\n\t\t\tvar rang = {\n\t\t\t\tborderWidth: styles.weight,\n\t\t\t\tborderColor: styles.color,\n\t\t\t\tcolor: styles.fillColor,\n\t\t\t\topacity: (styles.fillOpacity * 100),\n\t\t\t\tlineStyle : 'solid',\n\t\t\t\tlabel : false,\n\t\t\t\tlabelSize : 10,\n\t\t\t\tlabelFont : 'arial',\n\t\t\t\tlabelColor : '#000000'\t\t\t\t\t\n\t\t\t};\n\t\t}\n//\t\trang.businessId = styles.properties.businessId;\n//\t\trang.featureLeafletId = styles._leaflet_id;\n\t\trangs.push(rang);\n\t}\n\treturn rangs;\n}\n\n/*******************************************************************/\n\nfunction canviaStyleSinglePoint(cvStyle,feature,capaMare,openPopup){\n\tvar isCanvas=false;\n\tif(feature._ctx){isCanvas=true;}\n\tvar featureID=feature._leaflet_id\n\t\n\tvar noCanvi=(isCanvas==cvStyle.options.isCanvas);\n\n\tif(noCanvi && !isCanvas){//pinxo i/o glifons\n\t\tmap._layers[featureID].setIcon(cvStyle);\t\t\n\t}else if (noCanvi && isCanvas){//Nomes punt\n\t\tmap._layers[featureID].setStyle(cvStyle.options);\n\t\tmap._layers[featureID].setRadius(cvStyle.options.radius);\n\t}else if (!noCanvi ){\n\t\tcapaMare.removeLayer(map._layers[featureID]);\n\t\tvar layerTMP;\n\t\tif(isCanvas){//hi ha canvi de punt a pinxo i/o glifon\n\t\t\tlayerTMP=L.marker([feature.getLatLng().lat,feature.getLatLng().lng],\n\t\t\t\t\t{icon: cvStyle,isCanvas:cvStyle.options.isCanvas,\n\t\t\t\t\t tipus: t_marker});\n\t\t}else{//hi ha canvia de pinxo a punt canvas\n\t\t\tlayerTMP= L.circleMarker([feature.getLatLng().lat,feature.getLatLng().lng],\n\t\t\t\t{ radius : cvStyle.options.radius, \n\t\t\t\t  isCanvas:cvStyle.options.isCanvas,\n\t\t\t\t  fillColor : cvStyle.options.fillColor,\n\t\t\t\t  color :  cvStyle.options.color,\n\t\t\t\t  weight :  cvStyle.options.weight,\n\t\t\t\t  opacity :  cvStyle.options.opacity,\n\t\t\t\t  fillOpacity : cvStyle.options.fillOpacity,\n\t\t\t\t  tipus: t_marker}\t\n\t\t\t);\n\t\t}\n\t\tlayerTMP.properties=feature.properties;\t\n\t\tlayerTMP.addTo(capaMare);\n\t\tif (capaMare.options.tipus == t_dades_obertes){\n\t\t\t//popUp(feature, capaMare);\n\t\t}else{\n\t\t\tcreatePopupWindow(layerTMP,layerTMP.options.tipus);\t\n\t\t\tif(!openPopup){\n\t\t\t\t//map.closePopup();\n\t\t\t}\n\t\t}\n\t}\n\tmap.closePopup();\t\n}\n\nfunction addHtmlInterficieTematics(){\n\tjQuery(\"#funcio_tematics\").append(\n\t\t\t'<h5 lang=\"ca\">Triar l\\'estil de la capa</h5>'+\n\t\t\t'<div class=\"div_gr3_estils\">'+\n\t\t\t'\t<div id=\"st_Color\" lang=\"ca\" class=\"div_estil_1\" data-toggle=\"tooltip\" data-lang-title=\"Bàsic\" title=\"Bàsic\"></div>'+\n\t\t\t'\t<div id=\"st_Tema\" lang=\"ca\" class=\"div_estil_2\" data-toggle=\"tooltip\" data-lang-title=\"Categories\" title=\"Categories\"></div>'+\n\t\t\t'\t<div id=\"st_Size\" lang=\"ca\" class=\"div_estil_3\" data-toggle=\"tooltip\" data-lang-title=\"Mides\" title=\"Mides\"></div>'+\n\t\t\t'\t<div id=\"st_Heat\" lang=\"ca\" class=\"div_estil_4\" data-toggle=\"tooltip\" data-lang-title=\"Concentració\" title=\"Concentració\"></div>'+\n\t\t\t'\t<div id=\"st_Clust\" lang=\"ca\" class=\"div_estil_5\" data-toggle=\"tooltip\" data-lang-title=\"Agrupació\" title=\"Agrupació\"></div>'+\n\t\t\t'</div>'\t\t\t\n\t);\n\t\n\tjQuery('.div_gr3_estils [data-toggle=\"tooltip\"]').tooltip({container : 'body', placement: 'bottom'});\n\t\t\n\t/*\n\t$('#st_Color').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Bàsic\")});\n\t$('#st_Tema').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Categories\")});\n\t$('#st_Size').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Mides\")});\t\n\t$('#st_Heat').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Concentració\")});\n\t$('#st_Clust').tooltip({placement : 'bottom',container : 'body',title : window.lang.translate(\"Agrupació\")});\n\t*/\n}\n\nfunction addHtmlModalLayersTematic(){\n\t\n\tjQuery('#mapa_modals').append(\n\t'\t<!-- Modal Tematics Layers -->'+\n\t'\t\t<div class=\"modal fade\" id=\"dialog_layers_tematic\">'+\n\t'\t\t<div class=\"modal-dialog\">'+\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t'\t\t\t\t\t<h4 class=\"modal-title\"><span lang=\"ca\">Triar una capa per aplicar-hi l\\'estil</span><span><a class=\"faqs_link\" href=\"http://betaportal.icgc.cat/wordpress/faq-dinstamaps/#mapestematics\" target=\"_blank\"><i class=\"fa fa-question-circle-o fa-lg fa-fw\"></i></a></span></h4>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-body\">'+\n\t'\t\t\t\t\t<div class=\"alert alert-success\" id=\"txtTematic\">'+\n\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t\t<script id=\"tematic-layers-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<div class=\"panel-warning\">'+\t\t\t\t\t\n\t'\t\t\t\t\t<ul class=\"bs-dadesO_USR panel-heading\">'+\n\t'\t\t\t\t\t\t{{#each layers}}'+\n\t'\t\t\t\t\t\t<li><a class=\"usr_wms_layer lable-usr\" data-leafletid=\"{{layer._leaflet_id}}\" data-businessId=\"{{layer.options.businessId}}\" data-geometryType=\"{{layer.options.geometryType}}\" data-tipus=\"{{layer.options.tipus}}\" data-propName=\"{{layer.options.propName}}\">{{name}}</a></li>'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t</ul>'+\t\n\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<div id=\"list_tematic_layers\"></div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t'\t\t\t\t<div style=\"float:right;line-height: 40px;\"><span lang=\"ca\">Estil actiu</span>:  <div style=\"float: right;width:42px;height:42px\" id=\"stActiu\"></div></div>'+\n\t'\t\t\t\t\t<!-- <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Tancar</button>'+\n\t'        <button type=\"button\" class=\"btn btn-success\">Canviar</button> -->'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t<!-- /.modal-content -->'+\n\t'\t\t</div>'+\n\t'\t\t<!-- /.modal-dialog -->'+\n\t'\t</div>'+\n\t'\t<!-- /.modal -->'+\n\t'\t<!-- fi Modal Tematics Layers -->'\t\t\n\t);\n\t\n}\n\nfunction addHtmlModalCategories(){\n\t\n\tjQuery('#mapa_modals').append(\n\t'\t<!-- Modal Tematics Rangs -->'+\n\t'\t\t<div class=\"modal fade\" id=\"dialog_tematic_rangs\">'+\n\t'\t\t<div class=\"modal-dialog\">'+\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\"'+\n\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>'+\n\t'\t\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Defineix les categories</h4>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-body\">'+\n\t'\t\t\t\t\t<div class=\"labels_fields\">'+\n\t'\t\t\t\t\t\t<span>1.</span><span lang=\"ca\">Escull el camp per simbolitzar</span>:'+\n\t'\t\t\t\t\t\t<select name=\"dataField\" id=\"dataField\">'+\n\t'\t\t\t\t\t\t</select>'+\n\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t\t<script id=\"tematic-layers-fields\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t\t<option value=\"---\" lang=\"ca\">Escull el camp</option>'+\n\t'\t\t\t\t\t\t{{#each fields}}'+\n\t'\t\t\t\t\t\t<option value=\"{{this}}\">{{@key}}</option>'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<br/>'+\t\t\t\t\t\t\t\t\t\t\n\t'\t\t\t\t\t<div id=\"tipus_agrupacio_grp\" class=\"labels_fields\">'+\n\t'\t\t\t\t\t\t<span>2.</span><span lang=\"ca\">Escull l\\'interval</span>:'+\n\t'\t\t\t\t\t\t<span class=\"rd_separator\"></span>'+\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_unic\" name=\"rd_tipus_agrupacio\" value=\"U\">'+\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_unic\" lang=\"ca\">'+window.lang.translate(\"únic\")+'</label>'+\n\t'\t\t\t\t\t\t<span class=\"rd_separator\"></span>'+\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_semaforic\" name=\"rd_tipus_agrupacio\" value=\"S\">'+\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_semaforic\" lang=\"ca\">Escala de color</label>'+\n\t'\t\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_rang\" name=\"rd_tipus_agrupacio\" value=\"R\">'+\n\t'\t\t\t\t\t\t<label for=\"rd_tipus_rang\" lang=\"ca\">per intervals</label>'+\n\t'<!-- \t\t\t\t\t\t<select id=\"cmb_tipus_agrupacio\"> -->'+\n\t'<!-- \t\t\t\t\t\t\t<option lang=\"ca\" value=\"U\">Únic</option> -->'+\n\t'<!-- \t\t\t\t\t\t\t<option lang=\"ca\" value=\"R\">Rang</option> -->'+\n\t'<!-- \t\t\t\t\t\t</select> -->'+\n\t'\t\t\t\t\t</div>'+\t\t\t\n\t'\t\t\t\t\t<div id=\"num_rangs_grp\" class=\"labels_fields\" >'+\n\t'\t\t\t\t\t\t<select id=\"cmb_num_rangs\">'+\n\t'\t\t\t\t\t\t\t<option value=\"---\" selected >Intervals</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"2\">2</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"3\">3</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"4\">4</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"5\">5</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"6\">6</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"7\">7</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"8\">8</option>'+\n\t'\t\t\t\t\t\t\t<option value=\"9\">9</option>'+\n\t'\t\t\t\t\t\t</select>'+\n\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-punt-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\n\t'\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-polyline-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-unic-polygon-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'\t\t\t\t\t\t<tr><td>{{v}}</td><td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-punt-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<thead>'+\n\t'\t\t\t\t\t\t<tr>'+\n\t'     \t\t\t\t\t\t<th lang=\"ca\">Valor min</th>'+\n\t'     \t\t\t\t\t\t<th lang=\"ca\">Valor max</th>'+\n\t'  \t\t\t\t\t\t</tr>'+\n\t' \t\t\t\t\t\t</thead>'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'                       {{#if v.nodata}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\n\t'\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{else}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t{{#if style.isCanvas}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: {{style.fillColor}};\"> </div>'+\n\t'\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-{{style.markerColor}} fa'+\n\t'\t\t\t\t\t\t\t\t\t{{#if style.icon}}'+\n\t'\t\t\t\t\t\t\t\t\t\tfa-{{style.icon}}\"></div>'+\t\n\t'\t\t\t\t\t\t\t\t\t{{else}}'+\n\t'\t\t\t\t\t\t\t\t\t\t\"></div>'+\n\t'\t\t\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t\t{{/if}}'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{/if}}'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-polyline-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'                       {{#if v.nodata}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{else}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{/if}}'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-rangs-polygon-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t{{#each values}}'+\n\t'                       {{#if v.nodata}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{else}}'+\n\t'\t\t\t\t\t\t<tr><td><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\n\t'\t\t\t\t\t\t\t<td><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol{{index}}\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'                       {{/if}}'+\n\t'\t\t\t\t\t\t{{/each}}'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-punt-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<div id=\"div_punt0\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<div id=\"div_punt1\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<div id=\"div_punt2\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa-dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 8px; width: 16px; height: 16px; color: rgb(51, 51, 51); background-color: ;\"> </div>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-polyline-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol0\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol1\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol2\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<script id=\"tematic-values-semaforic-polygon-template\" type=\"text/x-handlebars-template\">'+\n\t'\t\t\t\t\t<table class=\"table\">'+\n\t'\t\t\t\t\t\t<tbody>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors menors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol0\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td><span lang=\"ca\">Valor de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td><input id=\"refValue\" type=\"text\" value=\"{{value}}\" name=\"ref\"></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol1\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t<tr><td colspan=\"2\"><span lang=\"ca\">Valors majors que el de referència</span></td>'+\n\t'\t\t\t\t\t\t\t<td>'+\n\t'\t\t\t\t\t\t\t<canvas id=\"cv_pol2\" height=\"30\" width=\"30\" class=\"shadow dropdown-toggle\" data-toggle=\"dropdown\"></canvas>'+\n\t'\t\t\t\t\t\t</td></tr>'+\n\t'\t\t\t\t\t\t</tbody>'+\n\t'\t\t\t\t\t</table>'+\t\n\t'\t\t\t\t\t</script>'+\n\t'\t\t\t\t\t<div id=\"palet_warning\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\n\t'\t\t\t\t\t<span lang=\"ca\">Per facilitar la llegibilitat del mapa hem limitat el número màxim de colors per a aquest estil a 9. La resta de categories es simbolitzaran amb color gris</span></div>'+\n\t'\t\t\t\t\t<div id=\"list_tematic_values\"></div>'+\n\n\t'\t\t\t\t\t<div id=\"paletes_colors\">'+\n\t'\t\t\t\t\t\t<div><span lang=\"ca\">Tria la paleta de colors</span><span class=\"glyphicon glyphicon-arrow-down btn-reverse-palete\"></span><span lang=\"ca\" class=\"btn-reverse-palete\">Inverteix paleta</span></div>'+\n\t'<div class=\"ramp BuGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(237,248,251)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(178,226,226)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(102,194,164)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(44,162,95)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,109,44)\"/></svg></div>'+\n\t'<div class=\"ramp BuPu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(237,248,251)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(179,205,227)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(140,150,198)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(136,86,167)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(129,15,124)\"/></svg></div>'+\n\t'<div class=\"ramp GnBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(240,249,232)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(186,228,188)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(123,204,196)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(67,162,202)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(8,104,172)\"/></svg></div>'+\n\t'<div class=\"ramp OrRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(254,240,217)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,204,138)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(252,141,89)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(227,74,51)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(179,0,0)\"/></svg></div>'+\n\t'<div class=\"ramp PuBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(241,238,246)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(189,201,225)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(116,169,207)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(43,140,190)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(4,90,141)\"/></svg></div>'+\n\t'<div class=\"ramp PuBuGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(246,239,247)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(189,201,225)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(103,169,207)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(28,144,153)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(1,108,89)\"/></svg></div>'+\n\t\n\t'<div class=\"ramp PuRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(241,238,246)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(215,181,216)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(223,101,176)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(221,28,119)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(152,0,67)\"/></svg></div>'+\n\t'<div class=\"ramp RdPu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(254,235,226)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(251,180,185)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,104,161)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(197,27,138)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(122,1,119)\"/></svg></div>'+\n\t'<div class=\"ramp YlGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,204)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(194,230,153)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(120,198,121)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(49,163,84)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,104,55)\"/></svg></div>'+\n\t'<div class=\"ramp YlGnBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,204)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(161,218,180)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(65,182,196)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(44,127,184)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(37,52,148)\"/></svg></div>'+\n\t'<div class=\"ramp YlOrBr\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,212)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(254,217,142)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(254,153,41)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(217,95,14)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(153,52,4)\"/></svg></div>'+\n\t'<div class=\"ramp YlOrRd\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(255,255,178)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(254,204,92)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(253,141,60)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(240,59,32)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(189,0,38)\"/></svg></div>'+\n\t\n\t'<div class=\"ramp BrBG\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(166,97,26)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(223,194,125)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(245,245,245)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(128,205,193)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(1,133,113)\"/></svg></div>'+\n\t'<div class=\"ramp PRGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(123,50,148)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(194,165,207)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,247,247)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(166,219,160)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(0,136,55)\"/></svg></div>'+\n\t'<div class=\"ramp PuOr\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(230,97,1)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,184,99)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(247,247,247)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(178,171,210)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(94,60,153)\"/></svg></div>'+\n\t'<div class=\"ramp RdGy\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(202,0,32)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(244,165,130)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,255)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(186,186,186)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(64,64,64)\"/></svg></div>'+\n\t'<div class=\"ramp RdYlBu\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(171,217,233)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(44,123,182)\"/></svg></div>'+\n\t'<div class=\"ramp RdYlGn\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(166,217,106)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(26,150,65)\"/></svg></div>'+\n\t'<div class=\"ramp Spectral\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(215,25,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(253,174,97)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(255,255,191)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(171,221,164)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(43,131,186)\"/></svg></div>'+\n\t\n\t'<div class=\"ramp Paired\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(166,206,227)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(31,120,180)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(178,223,138)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(51,160,44)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(251,154,153)\"/></svg></div>'+\n\t'<div class=\"ramp Set3\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(141,211,199)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(255,255,179)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(190,186,218)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(251,128,114)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(128,177,211)\"/></svg></div>'+\n\t'<div class=\"ramp Set1\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(228,26,28)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(55,126,184)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(77,175,74)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(152,78,163)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(255,127,0)\"/></svg></div>'+\n\t'<div class=\"ramp Dark2\"><svg height=\"75\" width=\"15\"><rect y=\"0\" height=\"15\" width=\"15\" fill=\"rgb(27,158,119)\"/><rect y=\"15\" height=\"15\" width=\"15\" fill=\"rgb(217,95,2)\"/><rect y=\"30\" height=\"15\" width=\"15\" fill=\"rgb(117,112,179)\"/><rect y=\"45\" height=\"15\" width=\"15\" fill=\"rgb(231,41,138)\"/><rect y=\"60\" height=\"15\" width=\"15\" fill=\"rgb(102,166,30)\"/></svg></div>'+\n\t\n//\t'\t\t\t\t\t\t<img id=\"paletaPaired\" src=\"img/paleta2.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Paired\">'+\n//\t'\t\t\t\t\t\t<img id=\"paletaPastel\" src=\"img/paleta1.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Pastel\">'+\n//\t'\t\t\t\t\t\t<img id=\"paletaDivergent\" src=\"img/paleta_divergent.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Divergent\">'+\n//\t'\t\t\t\t\t\t<img id=\"paletaSecuencial\" src=\"img/paleta_sequencial.png\" class=\"btn-paleta\" lang=\"ca\" title=\"Sequencial\">'+\n\t'\t\t\t\t\t</div>'+\n\t\n\t\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\n\t'         \t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Canviar</button>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t<!-- /.modal-content -->'+\n\t'\t\t</div>'+\n\t'\t\t<!-- /.modal-dialog -->'+\n\t'\t</div>'+\n\t'\t<!-- /.modal -->'+\n\t'\t<!-- fi Modal Tematics Rangs -->'\t\t\n\t);\n}\n\n\nfunction addHtmlModalBubbles(){\n\tjQuery('#mapa_modals').append(\n\t\t\t'<!-- Modal Tematics Bubble -->'+\n\t\t\t'<div class=\"modal fade\" id=\"dialog_tematic_bubble\">'+\n\t\t\t'\t<div class=\"modal-dialog\">'+\n\t\t\t'\t\t<div class=\"modal-content panel-primary\">'+\n\t\t\t'\t\t\t<div class=\"modal-header panel-heading\">'+\n\t\t\t'\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>'+\n\t\t\t'\t\t\t\t<h4 class=\"modal-title\" lang=\"ca\">Defineix les categories</h4>'+\n\t\t\t'\t\t\t</div>'+\n\t\t\t'\t\t\t<div class=\"modal-body\">'+\n\t\t\t'\t\t\t\t<div class=\"labels_fields\">'+\n\t\t\t'\t\t\t\t\t<span lang=\"ca\">Escull el camp per simbolitzar</span>:'+\n\t\t\t'\t\t\t\t\t<select name=\"dataFieldBubble\" id=\"dataFieldBubble\">'+\n\t\t\t'\t\t\t\t\t</select>'+\n\t\t\t'\t\t\t\t</div>'+\n\t\t\t'                <script id=\"tematic-layers-fields-bubble\" type=\"text/x-handlebars-template\">'+\n\t\t\t'\t\t\t\t\t\t<option value=\"---\" lang=\"ca\">Escull el camp</option>'+\n\t\t\t'\t\t\t\t\t\t{{#each fields}}'+\n\t\t\t'\t\t\t\t\t\t<option value=\"{{this}}\">{{@key}}</option>'+\n\t\t\t'\t\t\t\t\t\t{{/each}}'+\n\t\t\t'\t\t\t\t\t</script>'+\n\t\t\t'\t\t\t\t<br/>'+\t\t\t\t\t\t\t\t\t\t\n\t\t\t'\t\t\t\t<div id=\"tipus_agrupacio_grp_bubble\" class=\"labels_fields\">'+\n\t\t\t\"\t\t\t\t\t<span lang='ca'>Escull l'interval</span>:\"+\n\t\t\t'\t\t\t\t\t<input type=\"radio\" id=\"rd_tipus_graduado\" name=\"rd_tipus_agrupacio_bubble\" value=\"G\">'+\n\t\t\t'\t\t\t\t\t<label for=\"rd_tipus_graduado\" lang=\"ca\">graduat</label>'+\n\t\t\t'\t\t\t\t\t<span class=\"rd_separator\"></span>'+\n\t\t\t'                   <input type=\"radio\" id=\"rd_tipus_proporcional\" name=\"rd_tipus_agrupacio_bubble\" value=\"P\">'+\n\t\t\t'\t\t\t\t\t<label for=\"rd_tipus_proporcional\" lang=\"ca\">proporcional</label>'+\n\t\t\t'\t\t\t\t</div>'+\t\t\t\n\t\t\t'\t\t\t\t<div id=\"num_rangs_grp_bubble\" class=\"labels_fields\" >'+\n\t\t\t'\t\t\t\t\t<select id=\"cmb_num_rangs_bubble\">'+\n\t\t\t'\t\t\t\t\t\t<option value=\"---\" selected >Intervals</option>'+\n\t\t\t'\t\t\t\t\t\t<option value=\"3\">3</option>'+\n\t\t\t'\t\t\t\t\t\t<option value=\"4\">4</option>'+\n\t\t\t'\t\t\t\t\t\t<option value=\"5\">5</option>'+\n\t\t\t'\t\t\t\t\t\t<option value=\"6\">6</option>'+\n\t\t\t'\t\t\t\t\t\t<option value=\"7\">7</option>'+\n\t\t\t'\t\t\t\t\t</select>'+\n\t\t\t'\t\t\t\t</div>'+\n\t\t\t'\t\t\t\t<script id=\"tematic-values-rangs-punt-template-bubble\" type=\"text/x-handlebars-template\">'+\n\t\t\t'\t\t\t\t<table class=\"table\">'+\n\t\t\t'\t\t\t\t\t<thead>'+\n\t\t\t'\t\t\t\t\t<tr>'+\n\t\t    ' \t\t\t\t\t\t<th lang=\"ca\">Valor min.</th>'+\n\t\t    ' \t\t\t\t\t\t<th lang=\"ca\">Valor max.</th>'+\n\t\t\t'\t\t\t\t\t\t<th lang=\"ca\">Mida</th>'+\n\t\t\t'\t\t\t\t\t\t<th lang=\"ca\"></th>'+\n\t\t  \t'\t\t\t\t\t</tr>'+\n\t\t \t'\t\t\t\t\t</thead>'+\n\t\t\t'\t\t\t\t\t<tbody>'+\n\t\t\t'\t\t\t\t\t{{#each values}}'+\n\t\t\t'                   {{#if v.nodata}}'+\n\t\t\t'\t\t\t\t\t<tr><td class=\"td_15\"><input type=\"text\" value=\"{{v.min}}\" name=\"min\" disabled></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"text\" value=\"{{v.max}}\" name=\"max\" disabled></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida nodata\"></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"\">'+\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\n\t\t\t'\t\t\t\t\t</td></tr>'+\n\t\t\t'                   {{else}}'+\n\t\t\t'\t\t\t\t\t<tr><td class=\"td_15\"><input type=\"text\" value=\"{{v.min}}\" name=\"min\"></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"text\" value=\"{{v.max}}\" name=\"max\"></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"td_15\"><input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida\"></td>'+\n\t\t\t'\t\t\t\t\t\t<td class=\"\">'+\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt{{index}}\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\n\t\t\t'\t\t\t\t\t</td></tr>'+\n\t\t\t'                   {{/if}}'+\n\t\t\t'\t\t\t\t\t{{/each}}'+\n\t\t\t'\t\t\t\t\t</tbody>'+\n\t\t\t'\t\t\t\t</table>\t'+\n\t\t\t'\t\t\t\t</script>'+\n\t\t\t'\t\t\t\t<script id=\"tematic-values-proportional-punt-template-bubble\" type=\"text/x-handlebars-template\">'+\n\t\t\t'\t\t\t\t<table class=\"table text-center buble_table\">'+\n\t\t\t'\t\t\t\t\t<tbody>'+\n\t\t\t'\t\t\t\t\t{{#each values}}'+\n\t\t\t'                   {{#if v.nodata}}'+\n\t\t\t'                   <tr><td colspan=\"2\">'+\n\t\t\t'                     <div class=\"buble_prop\">'+\n\t\t\t'                       <div><label lang=\"ca\">Sense valor</label>&nbsp;{{v.min}}<input type=\"hidden\" value=\"{{v.min}}\" name=\"min\"></div>'+\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida nodata\"></div>'+\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_nodata\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\n\t\t\t'                     </div></td>'+\n\t\t\t'                   </td></tr>'+\n\t\t\t'                   {{else}}'+\n\t\t\t'\t\t\t\t\t<tr><td>'+\n\t\t\t'                     <div class=\"buble_prop\">'+\n\t\t\t'                       <div><label lang=\"ca\">Valor min.</label>&nbsp;{{v.min}}<input type=\"hidden\" value=\"{{v.min}}\" name=\"min\"></div>'+\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.size}}\" name=\"mida\" class=\"mida\"></div>'+\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_min\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.size}}px; height: {{style.size}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radius}}px\"> </div>'+\n\t\t\t'                     </div></td>'+\n\t\t\t'\t\t\t\t\t\t<td><div class=\"buble_prop\">'+\n\t\t\t'                        <div><label lang=\"ca\">Valor max.</label>&nbsp;{{v.max}}<input type=\"hidden\" value=\"{{v.max}}\" name=\"max\"></div>'+\n\t\t\t'                       <div><label lang=\"ca\">mida</label>&nbsp;<input type=\"number\" value=\"{{style.sizeMax}}\" name=\"mida_max\" class=\"mida\"></div>'+\n\t\t\t'\t\t\t\t\t\t<div id=\"div_punt_max\" class=\"awesome-marker-web awesome-marker-icon-punt_r fa fa- dropdown-toggle\" data-toggle=\"dropdown\"'+ \n\t\t\t'\t\t\t\t\t\t\t\tstyle=\"font-size: 10.5px; width: {{style.sizeMax}}px; height: {{style.sizeMax}}px; color: rgb(51, 51, 51); background-color: {{style.fillColor}}; border-radius:{{style.radiusMax}}px\"> </div>'+\n\t\t\t'\t\t\t\t\t</td></tr>'+\n\t\t\t'                   {{/if}}'+\n\t\t\t'\t\t\t\t\t{{/each}}'+\n\t\t\t'\t\t\t\t\t</tbody>'+\n\t\t\t'\t\t\t\t</table>\t'+\n\t\t\t'\t\t\t\t</script>'+\n\t\t\t'\t\t\t\t<div id=\"list_tematic_values_bubble\"></div>'+\n\t\t\t'\t\t\t\t<div id=\"size_warning_bubble_grad\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\n\t\t\t'\t\t\t\t<span lang=\"ca\">Les mides han de ser creixents</span></div>'+\n\t\t\t'\t\t\t\t<div id=\"size_warning_bubble_prop\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\n\t\t\t'\t\t\t\t<span lang=\"ca\">La mida mínima ha de ser inferior a la màxima</span></div>'+\n\t\t\t'\t\t\t\t<div id=\"palet_warning_bubble\" class=\"alert alert-warning\"><span class=\"glyphicon glyphicon-info-sign\"></span>'+\n\t\t\t'\t\t\t\t<span lang=\"ca\">Has de seleccionar un camp amb valors numèrics</span></div>'+\n\t\t\t'\t\t\t</div>'+\n\t\t\t'\t\t\t<div class=\"modal-footer\">'+\n\t\t\t'\t\t\t\t<div id=\"paletes_colors\">'+\n\t\t\t'\t\t\t\t\t<div lang=\"ca\">Tria el color</div>'+\n\t\t\t'\t\t\t\t\t<div class=\"btn-group\">'+\n\t\t\t'\t\t\t\t\t\t<a class=\"btn btn-mini dropdown-toggle\" data-toggle=\"dropdown\">'+\n\t\t\t'\t\t\t\t\t\t\t<div id=\"dv_fill_color_punt_bubble\" class=\"fill_color_punt\"></div>'+\n\t\t\t'\t\t\t\t\t\t</a>'+\n\t\t\t'\t\t\t\t\t\t<ul class=\"dropdown-menu\">'+\n\t\t\t'\t\t\t\t\t\t\t<li><div id=\"colorpalette_punt_bubble\"></div></li>'+\n\t\t\t'\t\t\t\t\t\t</ul>'+\n\t\t\t'\t\t\t\t\t</div>'+\n\t\t\t'\t\t\t\t</div>'+\n\t\t\t'\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\n\t\t    '     \t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Canviar</button>'+\n\t\t\t'\t\t\t</div>'+\n\t\t\t'\t\t</div>'+\n\t\t\t'\t\t<!-- /.modal-content -->'+\n\t\t\t'\t</div>'+\n\t\t\t'\t<!-- /.modal-dialog -->'+\n\t\t\t'</div>'+\n\t\t\t'<!-- /.modal -->'+\n\t\t\t'<!-- fi Modal Tematics Bubble -->'\n\t);\n}\n\n\n/*NOU MODEL VISUALITZACIO*/\nfunction loadVisualitzacioLayer(layer,removed){\n\tvar businessId;\n\tif (layer.businessId!=undefined){\n\t\tbusinessId=layer.businessId;\n\t}else if (layer.options.businessId!=undefined){\n\t\tbusinessId = layer.options.businessId;\n\t}\n\t\n\tvar defer = $.Deferred();\n\tvar data={\n\t\tuid : Cookies.get('uid'),\n\t\tbusinessId: businessId\n\t};\n\t\n\tgetVisualitzacioByBusinessId(data).then(function(results){\n\t\tif(results.status == \"OK\" ){\n\t\t\tif (removed){\n\t\t\t\tvar data ={\n\t\t\t\t\tbusinessId: businessId,\n\t\t\t\t\tuid:Cookies.get('uid')\n\t\t\t\t};\n\t\t\t\tvar resultats = results.results;\n\t\t\t\tgetGeometriesPropertiesLayer(data).then(function(results2){\n\t\t\t\t\t readVisualitzacio(defer, resultats, results2.layer);\n\t\t\t\t});\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\n\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\n\t\t\t\t{\n\t\t\t\t\n\t\t\t\t\tcontrolCapes._visLayers = {};\n\t\t\t\t\tcontrolCapes._options = {};\n\t\t\t\t}\n\t\t\t\tcontrolCapes._visLayers[businessId] = results.results;\n\t\t\t\tcontrolCapes._options[businessId] = layer;\n\t\t\t\treadVisualitzacio(defer, results.results, layer);\n\t\t\t}\n\t\t}else{\n\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\n\t\t\tdefer.reject();\n\t\t}\n\t},function(results){\n\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\n\t\tdefer.reject();\n\t});\n\treturn defer.promise();\n}\n\nfunction reloadVisualitzacioLayer(capaVisualitzacio, visualitzacio, layer, map){\n\tvar defer = $.Deferred();\n\t//update del options de la capa\n\tvar optionsVis = getOptions(visualitzacio);\n\tcapaVisualitzacio.options = $.extend(capaVisualitzacio.options, optionsVis);\n\tif(capaVisualitzacio.options.propName && jQuery.type( capaVisualitzacio.options.propName ) === \"string\"){\n\t\tcapaVisualitzacio.options.propName = capaVisualitzacio.options.propName.split(\",\");\n\t}\n\t\t\n\t//limpiar las geometrias\t\n\ttry{\n\t\tcapaVisualitzacio.clearLayers();\n\t}catch(err){\n\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.clearLayers();\n\t}\n\t//cargar las geometrias a la capa\n\tvar layOptions = getOptions(layer);\n\tvar origen = getOrigenLayer(layer);\n\tvar hasSource = (optionsVis && optionsVis.source!=undefined) \n\t|| (optionsVis.options && undefined != optionsVis.options.source)\n\t|| (layOptions && layOptions.source!=undefined );\n\ttry{\n\t\tcapaVisualitzacio.off('layeradd',objecteUserAdded);//Deixem desactivat event layeradd, per la capa activa\n\t}catch(err){\n\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.off('layeradd',objecteUserAdded);//Deixem desactivat event layeradd, per la capa activa\n\t}\n\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\n\t\n\ttry{\n\t\tcapaVisualitzacio.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\n\t}catch(err){\n\t\tif (capaVisualitzacio.layer!=undefined) \tcapaVisualitzacio.layer.on('layeradd',objecteUserAdded);//Deixem activat event layeradd, per la capa activa\n\t}\n\t\n\tdefer.resolve(capaVisualitzacio);\n\t\n\treturn defer.promise();\n}\n\nfunction getOptions(visualitzacio){\n\tvar visOptions = visualitzacio.options;\n\tif(typeof (visOptions)==\"string\"){\t\n\t\ttry {\n\t\t\toptionsVis = JSON.parse(visOptions);\n\t\t}\n\t\tcatch (err) {\n\t\t\toptionsVis = visOptions;\t\t\n\t\t}\n\t}else{\t\t\t\n\t\toptionsVis = visOptions;\t\n\t}\n\treturn optionsVis;\n}\n\nfunction getOrigenLayer(layer){\n\tvar origen = \"\",\n\toptions;\n\tif (layer.options){\n\t\toptions = getOptions(layer);\n\t\tif(options.origen){//Si es una sublayer\n\t\t\torigen = getLeafletIdFromBusinessId(options.origen);\n\t\t}\n\t}\n\treturn origen;\n}\n\nfunction readVisualitzacio(defer, visualitzacio, layer, geometries){\n\tvar layOptions; \n\tif(typeof (layer.options)==\"string\"){\t\n\t\ttry {\n\t\t\tlayOptions = JSON.parse(layer.options);\n\t\t}\n\t\tcatch (err) {\n\t\t\tlayOptions = layer.options;\t\t\n\t\t}\n\t}else{\t\t\t\n\t\tlayOptions = layer.options;\t\n\t}\n\tvar hasSource = (visualitzacio.options && (visualitzacio.options.indexOf(\"source\")!=-1) ) \n\t\t|| (layOptions && (layOptions.toString().indexOf(\"source\")!=-1) );\n\tif(visualitzacio.tipus == tem_heatmap){\n\t\tloadVisualitzacioHeatmap(visualitzacio, layer.capesOrdre, layer.options, layer.capesActiva, defer);\n\t}else if(visualitzacio.tipus == tem_cluster){\n\t\tloadVisualitzacioCluster(visualitzacio, layer.capesOrdre, layer.options, layer.capesActiva, defer);\n\t}else{\n\t\tvar capaVisualitzacio = new L.FeatureGroup();\n\t\tif(layOptions && layOptions.group){\n\t\t\tcapaVisualitzacio.options = {\n\t\t\t\tbusinessId : layer.businessId,\n\t\t\t\tnom : layer.serverName,\n\t\t\t\ttipus : layer.serverType,\n\t\t\t\ttipusRang: visualitzacio.tipus, \n\t\t\t\tgeometryType: visualitzacio.geometryType,\n\t\t\t\testil: visualitzacio.estil,\n\t\t\t\tgroup: layOptions.group\n\t\t\t};\n\t\t}else{\n\t\t\tcapaVisualitzacio.options = {\n\t\t\t\tbusinessId : layer.businessId,\n\t\t\t\tnom : layer.serverName,\n\t\t\t\ttipus : layer.serverType,\n\t\t\t\ttipusRang: visualitzacio.tipus, \n\t\t\t\tgeometryType: visualitzacio.geometryType,\n\t\t\t\testil: visualitzacio.estil\n\t\t\t};\n\t\t}\n\t\t\n\t\tvar visOptions = visualitzacio.options;\n\t\tvar optionsVis = getOptions(visualitzacio);\n\t\t\n\t\tif(hasSource) {\n\t\t\tcapaVisualitzacio.options.source = optionsVis.source;\n\t\t}\n\t\t\n\t\t//Pel cas de del tematic categories, tenir els rangs d'estils\n\t\tif(visOptions && visOptions.indexOf(\"estilsRangs\")!=-1) {\n\t\t\tcapaVisualitzacio.options.estilsRangs = optionsVis.estilsRangs;\n\t\t}\n\n\t\t//Pel cas de del tematic categories, tenir els rangs d'estils\n\t\tif(visOptions && visOptions.indexOf(\"rangsEstilsLegend\")!=-1) {\n\t\t\tcapaVisualitzacio.options.rangsEstilsLegend = optionsVis.rangsEstilsLegend;\n\t\t}\t\n\t\t\n\t\t//Pel cas de del tematic categories, tenir la paleta\n\t\tif(visOptions && visOptions.indexOf(\"paleta\")!=-1) {\n\t\t\tcapaVisualitzacio.options.paleta = optionsVis.paleta;\n\t\t}\n\t\t\n\t\t//Pel cas de del tematic categories, tenir la propietat reverse\n\t\tif(visOptions && visOptions.indexOf(\"reverse\")!=-1) {\n\t\t\tcapaVisualitzacio.options.reverse = optionsVis.reverse;\n\t\t}\n\t\t\n\t\t//Pel cas de del tematic categories, tenir la propietat dataField\n\t\tif(visOptions && visOptions.indexOf(\"dataField\")!=-1) {\n\t\t\tcapaVisualitzacio.options.dataField = optionsVis.dataField;\n\t\t}\n\t\t\n\t\t//Pel cas de del tematic categories, tenir la propietat labelField\n\t\tif(visOptions && visOptions.indexOf(\"labelField\")!=-1) {\n\t\t\tcapaVisualitzacio.options.labelField = optionsVis.labelField;\n\t\t}\n\t\t\n\t\t//Pel cas de del tematic categories, tenir la propietat tipusClasicTematic\n\t\tif(visOptions && visOptions.indexOf(\"tipusClasicTematic\")!=-1) {\n\t\t\tcapaVisualitzacio.options.tipusClasicTematic = optionsVis.tipusClasicTematic;\n\t\t}\n\n\t\t//Pel cas de del tematic semafòric, tenir la propietat de l'atribut fixat\n\t\tif(optionsVis && optionsVis.hasOwnProperty(\"trafficLightKey\")) {\n\t\t\tcapaVisualitzacio.options.trafficLightKey = optionsVis.trafficLightKey;\n\t\t}\n\t\t\n\t\t//Per les etiquetes\n\t\tvar isCapaAmbEtiquetes=false;\n\t\tif(optionsVis && optionsVis.campEtiqueta!=undefined) {\n\t\t\tisCapaAmbEtiquetes=true;\n\t\t\tcapaVisualitzacio.options.campEtiqueta = optionsVis.campEtiqueta;\n\t\t\tif(optionsVis && optionsVis.fontFamily!=undefined) capaVisualitzacio.options.fontFamily = optionsVis.fontFamily;\n\t\t\tif(optionsVis && optionsVis.fontSize!=undefined) capaVisualitzacio.options.fontSize = optionsVis.fontSize;\n\t\t\tif(optionsVis && optionsVis.fontColor!=undefined) capaVisualitzacio.options.fontColor = optionsVis.fontColor;\n\t\t\tif(optionsVis && optionsVis.fontStyle!=undefined) capaVisualitzacio.options.fontFamily = optionsVis.fontStyle;\n\t\t\tif(optionsVis && optionsVis.opcionsVis!=undefined) capaVisualitzacio.options.opcionsVisEtiqueta = optionsVis.opcionsVis;\n\t\t\tif(optionsVis && optionsVis.zoomInicial!=undefined) capaVisualitzacio.options.zoomInicial = optionsVis.zoomInicial;\n\t\t\tif(optionsVis && optionsVis.zoomFinal!=undefined) capaVisualitzacio.options.zoomFinal = optionsVis.zoomFinal;\n\t\t\t//Noves opcions de contorn i caixa\n\t\t\tif(optionsVis && optionsVis.contorn!=undefined) capaVisualitzacio.options.contorn = optionsVis.contorn;\n\t\t\tif(optionsVis && optionsVis.caixa!=undefined) capaVisualitzacio.options.caixa = optionsVis.caixa;\n\t\t\tif(optionsVis && optionsVis.caixaColor!=undefined) capaVisualitzacio.options.caixaColor = optionsVis.caixaColor;\n\t\t}\n\t\t\n\t\tvar origen = getOrigenLayer(layer);\n\t\t\n\t\t//ordenar los estilos de mayor a menor para los bubbles\n\t\tif (visualitzacio.tipus == tem_size){\n\t\t\tvar estilDesc = visualitzacio.estil.sort(sordDesc(\"simbolSize\"));\n\t\t\tvisualitzacio.estil = estilDesc;\n\t\t}\n\t\t\n\t\tvar isCapaActiva=false;\n\t\tif (!layer.capesActiva || layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\t\n\t\t\t//Afegim geometries a la capa\n\t\t\tcapaVisualitzacio.addTo(map);\n\t\t\t$.publish(\"addMapLayer\");\n\t\t\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\n\t\t\t\n\t\t\t\n\t\t}\t\n\t\telse {\n\t\t\t//Afegim geometries a la capa pero no la capa al mapa\n\t\t\tloadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource);\n\t\t\tif (isCapaAmbEtiquetes){\n\t\t\t\tjQuery.each(capaVisualitzacio._layers, function(i, lay){\n\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\tlay.label.setOpacity(0);\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t}\n\t\t}\n\t\t\n\t\t//Afegim num d'elements al nom de la capa, si és un fitxer\n\t\tif(layer.dragdrop || layer.urlFile){\n\t\t\tcapaVisualitzacio.options.nom = capaVisualitzacio.options.nom;// + \" (\"+capaTematic.getLayers().length+\")\";\n\t\t\tvar data = {\n\t\t\t \tbusinessId: capaVisualitzacio.options.businessId, //url('?businessid') \n\t\t\t \tuid: Cookies.get('uid'),\n\t\t\t \tserverName: capaVisualitzacio.options.nom\n\t\t\t };\n\t\t\t\t\n\t\t\tupdateServidorWMSName(data).then(function(results){\n\t\t\t\n\t\t\t});\t\t\t\t\t\n\t\t}\n\t\t\t\n\t\tif (layer.options){\n\t\t\tvar options2;\n\t\t\tif(typeof (layer.options)==\"string\"){\t\t\n\t\t\t\ttry {\n\t\t\t\t\toptions2 = JSON.parse(layer.options);\n\t\t\t\t}\n\t\t\t\tcatch (err) {\n\t\t\t\t\toptions2 = layer.options;\n\t\t\t\t}\t\t\t\t\t\t\n\t\t\t}else{\t\t\t\t\n\t\t\t\toptions2 = layer.options;\t\n\t\t\t}\n\t\t\tif (options2.propName != undefined) {\n\t\t\t\tcapaVisualitzacio.options.propName = options2.propName;\n\t\t\t}\n\t\t\telse if (visualitzacio.options){\n\t\t\t\tvar options2;\n\t\t\t\tif(typeof (visualitzacio.options)==\"string\"){\t\n\t\t\t\t\ttry {\n\t\t\t\t\t\toptions2 = JSON.parse(visualitzacio.options);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\toptions2 = visualitzacio.options;\n\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t}else{\t\t\t\t\n\t\t\t\t\toptions2 = visualitzacio.options;\t\n\t\t\t\t}\t\t\n\t\t\t\tif (options2.propName != undefined) {\n\t\t\t\t\tvar dataNames = options2.propName.split(',');\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\n\t\t\t\t}\t\t\n\t\t\t\telse if (geometries!=undefined){\n\t\t\t\t\tif (  geometries.options){\n\t\t\t\t\t\tvar dataNames = geometries.options.split(',');\n\t\t\t\t\t\t//console.debug(dataNames);\n\t\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t}else{\n\t\t\tif (geometries!=undefined){\n\t\t\t\tif (  geometries.options){\n\t\t\t\t\tvar dataNames = geometries.options.split(',');\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (capaVisualitzacio.options.propName== undefined) {\n\t\t\tif (visualitzacio.estil!=undefined && visualitzacio.estil[0]!=undefined){\n\t\t\t\tif ( visualitzacio.estil[0].geometria!=undefined &&  visualitzacio.estil[0].geometria.features!=undefined &&\n\t\t\t\t\t\tvisualitzacio.estil[0].geometria.features.length>0){\n\t\t\t\t\t//var props = console.debug(visualitzacio.estil[0].geometria.features[0].properties);\n\t\t\t\t\t\n\t\t\t\t\tvar props;\n\t\t\t\t\tif(typeof (visualitzacio.estil[0].geometria.features[0].properties)==\"string\"){\t\t\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tprops = JSON.parse(visualitzacio.estil[0].geometria.features[0].properties);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\tprops = visualitzacio.estil[0].geometria.features[0].properties;\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t}else{\t\t\t\t\n\t\t\t\t\t\tprops = visualitzacio.estil[0].geometria.features[0].properties;\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tvar dataNames =\"\";\n\t\t\t\t\tjQuery.each(props, function( index, value ) {\n\t\t\t\t\t\tdataNames+=index+\",\";\t\t\t\t\t\t\n\t\t\t\t\t});\n\t\t\t\t\tcapaVisualitzacio.options.propName = dataNames.substring(0,dataNames.length-1);\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t}\n\t\tif (capaVisualitzacio.options.propName== undefined) {\n\t\t\tvar dataNames=[];\n\t\t\tdataNames[0]=\"nom\";\n\t\t\tdataNames[1]=\"text\";\n\t\t\tcapaVisualitzacio.options.propName = dataNames;\n\t\t}\n\n\t\tif(layer.options && origen !== \"\"){//Si es una sublayer\n\t\t\tcontrolCapes.addOverlay(capaVisualitzacio, capaVisualitzacio.options.nom, true, origen);\n\t\t}else {\n\t\t\tif (!layer.capesOrdre){\n\t\t\t\tcapaVisualitzacio.options.zIndex = controlCapes._lastZIndex + 1;\n\t\t\t}else{\n\t\t\t\tcapaVisualitzacio.options.zIndex = parseInt(layer.capesOrdre);\n\t\t\t}\n\t\t\tcontrolCapes.addOverlay(capaVisualitzacio, capaVisualitzacio.options.nom, true);\n\t\t\tcontrolCapes._lastZIndex++;\n\t\t}\n\t\t\n\t\t//Si la capa es tematic categories, afegir llegenda al mode edicio\n\t\tif ((visualitzacio.tipus == tem_clasic || visualitzacio.tipus == tem_size) && $(location).attr('href').indexOf('/mapa.html')!=-1){\n\t\t\tloadMapLegendEdicio(capaVisualitzacio);\n\t\t}\n\t\t\n\t\tdefer.resolve(capaVisualitzacio);\n\t}\t\t\n\treturn defer.promise();\n}\n\nfunction loadGeometriesToLayer(capaVisualitzacio, visualitzacio, optionsVis, origen, map, hasSource){\n\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined){\n\t\tvar style = \"font-family:\"+optionsVis.fontFamily+\";font-size:\"+optionsVis.fontSize+\";color:\"+optionsVis.fontColor;\n\t\tif (optionsVis.contorn!=undefined && optionsVis.contorn==\"si\") {\n\t\t\tstyle+=\";text-shadow:1px 1px #ffffff\";\n\t\t}\n\t\telse \tstyle+=\";text-shadow:0px 0px #ffffff\";\n\t\tif (optionsVis.fontStyle!=undefined){\n\t\t\tif (optionsVis.fontStyle==\"normal\" || optionsVis.fontStyle==\"bold\") style+= \";font-weight:\"+optionsVis.fontStyle;\n\t\t\telse if (optionsVis.fontStyle==\"italic\") style+= \";font-style:\"+optionsVis.fontStyle;\n\t\t}\n\t\tif (optionsVis.caixa!=undefined && optionsVis.caixa==\"si\"){\n\t\t\tstyle += \";background-color:\"+optionsVis.caixaColor;\n\t\t}\n\t\telse style += \";background-color:transparent\";\n\t\tcreateClass('.etiqueta_style_'+visualitzacio.businessId,style);\n\t}\n\t\n\tvar zoomInicialEtiqueta = \"2\";\n\tif (optionsVis!=undefined && optionsVis.zoomInicial!=undefined) zoomInicialEtiqueta=optionsVis.zoomInicial;\n\tvar zoomFinalEtiqueta = \"19\";\n\tif (optionsVis!=undefined && optionsVis.zoomFinal!=undefined)  zoomFinalEtiqueta=optionsVis.zoomFinal;\n\n\tvar canSpiderify = (visualitzacio.tipus == tem_clasic || visualitzacio.tipus == tem_simple || visualitzacio.tipus == tem_origen);\n\tif(visualitzacio.businessId && optionsVis && optionsVis.hasOwnProperty(\"trafficLightKey\") && optionsVis.hasOwnProperty(\"trafficLightValue\"))\n\t{\n\n\t\t//Canviem la visualització perquè pot ser que la del servidor no estigui bé (passa quan un cop creada la capa es publica el mapa\n\t\t//havent canviat el valor pivot de la visualització. En el servidor només s'actualitza el valor i no la geometria associada als estils)\n\t\tvar sorted = Semaforic.sortGeometry(visualitzacio.estil, optionsVis.trafficLightKey, optionsVis.trafficLightValue);\n\n\t\t//Actualitzem la geometria dels estils a partir de les geometries ordenades i els colors que té el semafòric\n\t\tvisualitzacio.estil[0].color = optionsVis.trafficLightLowerColor;\n\t\tvisualitzacio.estil[1].color = optionsVis.trafficLightEqualColor;\n\t\tvisualitzacio.estil[2].color = optionsVis.trafficLightHigherColor;\n\t\tvisualitzacio.estil[0].geometria.features = sorted.lowerGeom;\n\t\tvisualitzacio.estil[1].geometria.features = sorted.equalGeom;\n\t\tvisualitzacio.estil[2].geometria.features = sorted.higherGeom;\n\n\t\t//Actualitzem el nom de la capa\n\t\tvisualitzacio.nom = Semaforic.getUpdatedLayerName(visualitzacio.nom, optionsVis.trafficLightValue);\n\t\tcapaVisualitzacio.options.nom = visualitzacio.nom;\n\n\t}\n\t\n\tvar props = [];\n\tvar checkNumericProperties = false;\n\tvar veientMapa = ($(location).attr('href').indexOf('mapa')!=-1);\n\tif(\"undefined\" !== typeof optionsVis && optionsVis.hasOwnProperty(\"propName\") && !capaVisualitzacio.hasOwnProperty(\"isPropertyNumeric\"))\n\t{\n\t\n\t\tprops = optionsVis.propName.split(',');\n\t\tcapaVisualitzacio.isPropertyNumeric = new Array(props.length);\n\t\t$.each(props, function(index, prop) {\n\t\t\tcapaVisualitzacio.isPropertyNumeric[prop] = true;\n\t\t});\n\t\tcheckNumericProperties = true;\n\n\t}\n\t\n\t//per cada estil de la visualitzacio\n\tjQuery.each(visualitzacio.estil, function(index, estil){\n\t\tvar geomTypeVis = visualitzacio.geometryType;\n\t\tvar geomStyle;\n\t\t\n\t\tif (geomTypeVis === t_marker){\n\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length);\n\t\t}else if (geomTypeVis === t_multipoint){\n\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length);\n\t\t}else if (geomTypeVis === t_polyline){\n\t\t\tgeomStyle = createLineStyle(estil);\n\t\t}else if (geomTypeVis === t_multilinestring){\n\t\t\tgeomStyle = createLineStyle(estil);\n\t\t}else if (geomTypeVis === t_polygon){\n\t\t\tgeomStyle = createAreaStyle(estil);\n\t\t}else if (geomTypeVis === t_multipolygon){\n\t\t\tgeomStyle = createAreaStyle(estil);\n\t\t}\n\t\t\n\t\t//per cada geometria d'aquell estil\n\t\tjQuery.each(estil.geometria.features, function(indexGeom, geom){\t\t\t\t\n\t\t\tvar featureTem = [];\n\t\t\tif (undefined != geom.geometry){\n\t\t\tvar geomType = (geom.geometry.type?geom.geometry.type.toLowerCase():geomTypeVis);\n\n\t\t\t//Actualitzem el vector de propietats de tipus numèrics de la visualització\n\t\t\t//Els que són falsos en algun feature ja no cal repassar-los, els eliminem del \n\t\t\t//vector de propietats a comprovar\n\t\t\t\n\t\t\tif(checkNumericProperties)\n\t\t\t{\n\n\t\t\t\t//Actualitzem el vector de propietats de tipus numèrics de la visualització\n\t\t\t\t//Els que són falsos en algun feature ja no cal repassar-los, els eliminem del \n\t\t\t\t//vector de propietats a comprovar\n\t\t\t\tvar toRemove = [];\n\t\t\t\t$.each(props, function(index, prop) {\n\t\t\t\t\tcapaVisualitzacio.isPropertyNumeric[prop] = capaVisualitzacio.isPropertyNumeric[prop] && $.isNumeric(geom.properties[prop]);\n\t\t\t\t\tif(!capaVisualitzacio.isPropertyNumeric[prop])\n\t\t\t\t\t\ttoRemove.push(index);\n\t\t\t\t});\n\t\t\t\tfor(var i=toRemove.length-1; i>=0; i--)\n\t\t\t\t\tprops.splice(toRemove[i], 1);\n\n\t\t\t}\n\n\t\t\t//MultyPoint\n\t\t\tif (geomTypeVis === t_marker && geomType === t_multipoint){\n\t\t\t\t//TODO revisar que funcione\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\n\t\t\t\t\tvar c=coords[i];\n\t\t\t\t\tif(!geomStyle.isCanvas){\n\t\t\t\t\t\tfeatureTem.push(new L.marker([c[1], c[0]],\n\t\t\t\t\t\t\t{icon: geomStyle, isCanvas:false, tipus: t_marker}));\n\t\t\t\t\t}else{\n\t\t\t\t\t\tfeatureTem.push(new L.circleMarker([c[1], c[0]],geomStyle));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t//Punt\n\t\t\t}else if (geomTypeVis === t_marker || geomType === \"point\"){\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tif(!geomStyle.isCanvas){\n\t\t\t\t\tvar marker=new L.marker([coords[1],coords[0]],{icon: geomStyle, isCanvas:false,tipus: t_marker});\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\n\t\t\t\t\t\tmarker.setOpacity(0);\n\t\t\t\t\t}\t\t\t\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\n\t\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && \n\t\t\t\t\t\t\t\t(optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\") && origen==\"\"){\n\t\t\t\t\t\t\t\tmarker.bindLabel(geom.properties[optionsVis.campEtiqueta],\n\t\t\t\t\t\t\t\t{opacity:1, noHide: true, clickable:true, direction: 'center',className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0]});\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\n\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\n\t\t\t\t\t\t\tif (marker.label!=undefined) marker.label.setOpacity(0);\n\t\t\t\t\t\t\telse marker.hideLabel();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tfeatureTem.push(marker);\n\t\t\t\t}else{\n\t\t\t\t\tvar markerCircle=new L.circleMarker([coords[1],coords[0]],geomStyle);\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\n\t\t\t\t\t\tgeomStyle = createMarkerStyle(estil, estil.geometria.features.length,0);\n\t\t\t\t\t\tmarkerCircle=new L.circleMarker([coords[1],coords[0]],geomStyle);\n\t\t\t\t\t}\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\n\t\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && \n\t\t\t\t\t\t\t\t(optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\") && origen==\"\"){\n\t\t\t\t\t\t\tmarkerCircle.bindLabel(geom.properties[optionsVis.campEtiqueta],\n\t\t\t\t\t\t\t\t{opacity:1, noHide: true,clickable:true,  direction: 'altre',className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0]});\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\n\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\n\t\t\t\t\t\t\t\ttry{\n\t\t\t\t\t\t\t\t\tif (markerCircle.label!=undefined) markerCircle.label.setOpacity(0);\n\t\t\t\t\t\t\t\t\telse markerCircle.hideLabel();\n\t\t\t\t\t\t\t\t}catch(err){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tfeatureTem.push(markerCircle);\n\t\t\t\t}\n\t\t\t//MultiPoint\n\t\t\t}else if (geomTypeVis === t_polyline && geomType === t_multilinestring){\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tvar llistaLines=[];\n\t\t\t\tvar llistaLines2=[];\n\t\t\t\t\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\n\t\t\t\t\tvar lines=coords[i];\n\t\t\t\t\tvar llistaPunts=[];\n\t\t\t\t\tvar myPolyline = new L.polyline(llistaPunts,geomStyle);\n\t\t\t\t\t\n\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\n\t\t\t\t\t\tvar c=lines[k];\n\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\n\t\t\t\t\t\tmyPolyline.addLatLng(punt);\n\t\t\t\t\t}\n\t\t\t\t\tfeatureTem.push(myPolyline);\n\t\t\t\t}\n\n\t\t\t//multiLine\n\t\t\t}else if (geomTypeVis === t_polyline){\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tvar llistaPunts=[];\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\n\t\t\t\t\tvar c=coords[i];\n\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\n\t\t\t\t\tllistaPunts.push(punt);\n\t\t\t\t}\n\t\t\t\tvar polyline= (new L.polyline(llistaPunts, geomStyle));\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\n\t\t\t\t\tgeomStyle = createLineStyle(estil,0);\n\t\t\t\t\tpolyline= (new L.polyline(llistaPunts, geomStyle));\n\t\t\t\t}\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\n\t\t\t\t\t\t\t\tpolyline.bindLabelEx(map,geom.properties[optionsVis.campEtiqueta], \n\t\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId ,offset: [0, 0]});\n\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\n\t\t\t\t\t\t\t\tpolyline.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\n\t\t\t\t\t\t\t\tpolyline.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfeatureTem.push(polyline);\n\t\t\t//multiPolygon\n\t\t\t}else if(geomTypeVis === t_polygon && geomType === t_multipolygon){\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tvar llistaPoligons=[];\n\t\t\t\tfor (var p = 0; p < coords.length; p++){\n\t\t\t\t\tvar poligons=coords[p];\n\t\t\t\t\tvar llistaLines=[];\n\t\t\t\t\tfor (var i = 0; i < poligons.length; i++){\n\t\t\t\t\t\tvar lines=poligons[i];\n\t\t\t\t\t\tvar llistaPunts=[];\n\t\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\n\t\t\t\t\t\t\tvar c=lines[k];\n\t\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\n\t\t\t\t\t\t\tllistaPunts.push(punt);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tllistaLines.push(llistaPunts);\n\t\t\t\t\t}\n\t\t\t\t\tllistaPoligons.push(llistaLines);\n\t\t\t\t}\n\t\t\t\tvar multipolygon = new L.multiPolygon(llistaPoligons, geomStyle);\n\t\t\t\tmultipolygon._options = jQuery.extend({}, multipolygon._options);\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\n\t\t\t\t\tgeomStyle = createAreaStyle(estil,0);\n\t\t\t\t\tmultipolygon = new L.multiPolygon(llistaLines, geomStyle);\n\t\t\t\t}\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\n\t\t\t\t\t\t\t\tmultipolygon.bindLabelExPolygon(map,geom.properties[optionsVis.campEtiqueta], \n\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0] });\n\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\n\t\t\t\t\t\t\t\tmultipolygon.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\n\t\t\t\t\t\t\t\tmultipolygon.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfeatureTem.push(multipolygon);\n\t\t\t//polygon\n\t\t\t}else if (geomTypeVis === t_polygon){\n\t\t\t\tvar coords=geom.geometry.coordinates;\n\t\t\t\tvar llistaLines=[];\n\t\t\t\tfor (var i = 0; i < coords.length; i++){\n\t\t\t\t\tvar lines=coords[i];\n\t\t\t\t\tvar llistaPunts=[];\n\t\t\t\t\tfor (var k = 0; k < lines.length; k++){\n\t\t\t\t\t\tvar c=lines[k];\n\t\t\t\t\t\tvar punt=new L.LatLng(c[1], c[0]);\n\t\t\t\t\t\tllistaPunts.push(punt);\n\t\t\t\t\t}\n\t\t\t\t\tllistaLines.push(llistaPunts);\n\t\t\t\t}\n\t\t\t\tvar polygon = new L.Polygon(llistaLines, geomStyle);\n\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined && optionsVis.opcionsVis==\"nomesetiqueta\" && origen==\"\"){\n\t\t\t\t\tgeomStyle = createAreaStyle(estil,0);\n\t\t\t\t\tpolygon = new L.Polygon(llistaLines, geomStyle);\n\t\t\t\t}\n\t\t\t\tif (optionsVis!=undefined && optionsVis.campEtiqueta!=undefined) {\n\t\t\t\t\tif (optionsVis!=undefined && optionsVis.opcionsVis!=undefined) {\n\t\t\t\t\t\t\tif ((optionsVis.opcionsVis==\"nomesetiqueta\" || optionsVis.opcionsVis==\"etiquetageom\")  && origen==\"\"){\n\t\t\t\t\t\t\t\tpolygon.bindLabelExPolygon(map,geom.properties[optionsVis.campEtiqueta], \n\t\t\t\t\t\t\t\t\t{ noHide: true, direction: 'center',clickable:true, className: \"etiqueta_style_\"+visualitzacio.businessId,offset: [0, 0] });\n\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\tif (optionsVis.opcionsVis==\"geometries\"){\n\t\t\t\t\t\t\t\tpolygon.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ((zoomInicialEtiqueta!=undefined && map.getZoom()<zoomInicialEtiqueta) ||\n\t\t\t\t\t\t\t\t\t(zoomFinalEtiqueta!=undefined && map.getZoom() > zoomFinalEtiqueta)) {//ocultem labels\n\t\t\t\t\t\t\t\tpolygon.hideLabel();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfeatureTem.push(polygon);\n\t\t\t}\n\t\t\tjQuery.each(featureTem, function(index, feat){\n\t\t\t\tfeat.properties = {};\n\t\t\t\tfeat.properties.businessId = geom.businessId;\n\t\t\t\tfeat.properties.data = geom.properties;\n\t\t\t\tfeat.properties.estil = estil;\n\t\t\t\tfeat.properties.capaLeafletId = capaVisualitzacio._leaflet_id;\n\t\t\t\tfeat.properties.capaNom = capaVisualitzacio.options.nom;\n\t\t\t\tfeat.properties.capaBusinessId = capaVisualitzacio.options.businessId;\n\t\t\t\tfeat.properties.tipusFeature = geomTypeVis;\n\t\t\t\t//Cal??\n\t\t\t\tif (feat.options){\n\t\t\t\t\tfeat.options.tipus = geomTypeVis;\n\t\t\t\t}else{\n\t\t\t\t\tfeat.options = {tipus: geomTypeVis};\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfeat.properties.feature = {};\n\t\t\t\tfeat.properties.feature.geometry = geom.geometry;\n\t\t\t\ttry{\n\t\t\t\t\tcapaVisualitzacio.addLayer(feat);\n\t\t\t\t}catch(err){\n\t\t\t\t\tif (capaVisualitzacio.layer!=undefined) capaVisualitzacio.layer.addLayer(feat);\n\t\t\t\t}\n\t\t\t\n\t\t\t\tif(geomTypeVis == t_polygon){\n\t\t\t\t\tfeat.properties.mida = calculateArea(feat);\n\t\t\t\t}else if(geomTypeVis == t_polyline){\n\t\t\t\t\tfeat.properties.mida = calculateDistance(feat.getLatLngs());\n\t\t\t\t}\n\t\t\t\telse if(geomTypeVis == t_marker && map.hasOwnProperty(\"oms\") && canSpiderify ) {\n\t\t\t\t\tmap.oms.addMarker(feat);\n\t\t\t\t}\n\t\t\t\n\t\t\t\tif(!geom.hasOwnProperty(\"popupData\"))\n\t\t\t\t{\n\t\t\t\t\n\t\t\t\t\t//Si la capa no ve de fitxer\n\t\t\t\t\tvar html;\n\t\t\t\t\tif(!hasSource){\n\t\t\t\t\t\t//\"no te source, no ve de fitxer\");\n\t\t\t\t\t\tif(veientMapa && ((capaVisualitzacio.options.tipusRang == tem_origen) || !capaVisualitzacio.options.tipusRang) ){\n\t\t\t\t\t\t\thtml = createPopupWindow(feat,geomTypeVis);\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t//\"Estem mode vis i no es tem origen:\"\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, false, origen, capaVisualitzacio);\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\t//\"Te source, ve de fitxer\";\n\t\t\t\t\t\tif(veientMapa && capaVisualitzacio.options.tipusRang == tem_origen){\n\t\t\t\t\t\t\t//\"Estem mode mapa i es tem origen\"\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, true, origen, capaVisualitzacio);\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t//\"Estem mode vis i no es tem origen:\"\n\t\t\t\t\t\t\thtml = createPopupWindowData(feat,geomTypeVis, false, origen, capaVisualitzacio);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tgeom.popupData = html;\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\tfeat.bindPopup(geom.popupData, {'offset':[0,-25]});\n\n\t\t\t\t}\n\t\t\t\t/*try{\n\t\t\t\t\tif (geomTypeVis===t_marker || geomTypeVis===t_multipoint){\n\t\t\t\t\t\tfeat.snapediting = new L.Handler.MarkerSnap(map, feat,{snapDistance:10});\n\t\t\t\t\t\tfeat.dragging.disable(); \n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tfeat.snapediting = new L.Handler.PolylineSnap(map, feat,{snapDistance:10});\n\t\t\t\t\t}\n\t\t\t\t\tguideLayers.push(feat);\n\t\t\t\t}catch(err){\n\t\t\t\t\t\n\t\t\t\t}*/\n\t\t\t\tmap.closePopup();\t\t\t\t\t\n\t\t\t});\n\t\t\t}\n\t\t});\n\t});\t\n\t//FIN EACH\n}\n\n/**Funcions per crear un objecte de tipus estil, amb les característiques que li passes\n * per punt, línia, poligon */\n\nfunction createMarkerStyle(style, num_geometries,opacity){\n\t//console.debug(\"createFeatureMarkerStyle\");\n\tif (!num_geometries){\n\t\tnum_geometries = num_max_pintxos - 1;\n\t}\n\tif (style.marker && num_geometries <= num_max_pintxos){\n\t\t//Especifiques per cercle amb glyphon\n\t\tif(style.marker == 'punt_r'){\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_circuloglyphon_style);\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\n\t\t\tpuntTMP.options.icon = style.simbol;\n\t\t\tpuntTMP.options.markerColor = style.marker;\n\t\t\tpuntTMP.options.isCanvas=false;\n\t\t\tpuntTMP.options.divColor= style.color;\n\t\t\tpuntTMP.options.shadowSize = new L.Point(1, 1);\n\t\t\tpuntTMP.options.radius = style.radius;\n\t\t\tvar anchor = style.iconAnchor.split(\"#\");\n\t\t\tvar size = style.iconSize.split(\"#\");\n\t\t\tpuntTMP.options.iconAnchor.x = parseInt(anchor[0]);\n\t\t\tpuntTMP.options.iconAnchor.y = parseInt(anchor[1]);\n\t\t\tpuntTMP.options.iconSize.x = size[0];\n\t\t\tpuntTMP.options.iconSize.y = size[1];\n\t\t}else{\n\t\t\tvar puntTMP = new L.AwesomeMarkers.icon(default_marker_style);\n\t\t\tpuntTMP.options.iconColor = style.simbolColor;\n\t\t\tpuntTMP.options.icon = style.simbol;\n\t\t\tpuntTMP.options.markerColor = style.marker;\n\t\t\tpuntTMP.options.isCanvas=false;\n\t\t\tpuntTMP.options.iconAnchor.x = 14;\n\t\t\tpuntTMP.options.iconAnchor.y = 42;\n\t\t\tpuntTMP.options.iconSize.x = 28;\n\t\t\tpuntTMP.options.iconSize.y = 42;\n\t\t}\n\t}else{ //solo circulo\n\t\tvar fillOpacity=style.opacity/100;\n\t\tvar opacitat=1;\n\t\tif (opacity!=undefined) {\n\t\t\tfillOpacity=opacity;\n\t\t\topacitat=0;\n\t\t}\n\t\t\n\t\tvar puntTMP = { \n\t\t\tradius: style.simbolSize, \n\t\t\tisCanvas: true,\n\t\t\tfillColor: style.color,\n\t\t\tcolor:  style.borderColor,\n\t\t\tweight:  style.borderWidth,\n\t\t\tfillOpacity: fillOpacity,\n\t\t\topacity: opacitat,\n\t\t\ttipus: t_marker\n\t\t};\n\t}\n\treturn puntTMP;\n}\n\nfunction createLineStyle(style,opacity){\n\tvar estilTMP = default_line_style;\n\testilTMP.color=style.color;\n\testilTMP.weight=style.lineWidth;\n\testilTMP.tipus=t_polyline;\n\tif (opacity!=undefined) {\n\t\testilTMP.fillOpacity=opacity;\n\t\testilTMP.opacity=opacity;\n\t}\n\treturn estilTMP;\n}\n\nfunction createAreaStyle(style,opacity){\n\t\n\tvar estilTMP= default_area_style;\n\tvar opacitat=style.opacity/100;\n\tif (opacity!=undefined) {\n\t\topacitat=opacity;\n\t\testilTMP.opacity=opacity;\n\t}\n\testilTMP.fillColor=style.color;\n\testilTMP.fillOpacity=opacitat;\n\testilTMP.weight=style.borderWidth;\n\testilTMP.color=style.borderColor;\n\testilTMP.tipus=t_polygon;\n\treturn estilTMP;\n}\n\nfunction loadCacheVisualitzacioLayer(layer){\n\tvar defer = $.Deferred();\n\tvar data={\n\t\tbusinessId: layer.businessId,\n\t\tuid: layer.entitatUid\n\t};\n\t\n\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\n\t{\n\t\n\t\tcontrolCapes._visLayers = {};\n\t\tcontrolCapes._options = {};\n\t}\n\n\t$.get(HOST_APP+'capesuser/'+data.uid+'/'+data.businessId+'.json', function(results) { \n\t\tif(results){\n\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\n\t\t\tcontrolCapes._options[data.businessId] = layer;\n\t\t\treadVisualitzacio(defer, results.results, layer);\t\t\t\n\t\t}else{\t\t\t\t\n\t\t\tgetCacheVisualitzacioLayerByBusinessId(data).then(function(results){\n\t\t\t\tif(results.status == \"OK\" ){\n\t\t\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\n\t\t\t\t\tcontrolCapes._options[data.businessId] = layer;\n\t\t\t\t\treadVisualitzacio(defer, results.results, layer);\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\n\t\t\t\t\tdefer.reject();\t\n\t\t\t\t}\t\n\t\t\t});\n\t\t}\t\t\n\t}).fail(function() {\n\t   getCacheVisualitzacioLayerByBusinessId(data).then(function(results){\n\t\t\tif(results.status == \"OK\" ){\n\t\t\t\tcontrolCapes._visLayers[data.businessId] = results.results;\n\t\t\t\tcontrolCapes._options[data.businessId] = layer;\n\t\t\t\treadVisualitzacio(defer, results.results, layer);\n\t\t\t}else{\n\t\t\t\tconsole.debug('getVisualitzacioByBusinessId ERROR');\n\t\t\t\tdefer.reject();\t\n\t\t\t}\t\n\t\t});\n\t  });\n\treturn defer.promise();\n}\n\nfunction sordDesc(property) {\n    var sortOrder = 1;\n    if(property[0] === \"-\") {\n        sortOrder = -1;\n        property = property.substr(1);\n    }\n    return function (a,b) {\n        var result = (a[property] > b[property]) ? -1 : (a[property] < b[property]) ? 1 : 0;\n        return result * sortOrder;\n    }\n}\nfunction escapeSpecialChars(jsonString) {\n\tvar myJSONString = JSON.stringify(jsonString);\n\tvar myEscapedJSONString = myJSONString.replace(/\\n/g, \"\\\\n\");\n\t//console.debug(myEscapedJSONString);\n\treturn myEscapedJSONString;\n  }\n\nfunction actualitzacioTematic(layerMare,businessIdCapaMare,fId,feature,features,tipusModificacio) {\n\t//console.debug(layerMare);\n\tvar isClasicTematic=false;\n\tif (layerMare!=undefined) {\n\t\tjQuery.each(layerMare._layers, function(i, sublayer){\n\t\t\t//console.debug(sublayer);\n\t\t\tif(jQuery.type(sublayer.layer.options)== \"string\"){\n\t\t\t\t\tsublayer.layer.options = $.parseJSON(sublayer.layer.options);\n\t\t\t}\t            \t  \n\t\t\t//Sublayer visualitzacio, carrego la capa\n\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\n\t\t\t\t//if (sublayer.layer.options.tipusRang==\"simpleTematic\"){\t\t\n\t\t\t\t\tif (tipusModificacio==\"alta\" || tipusModificacio==\"modificacio\"){\n\t\t\t\t\t\tif (sublayer.layer.options.tipusRang!=\"clusterTematic\" && sublayer.layer.options.tipusRang!=\"heatmapTematic\"){\n\t\t\t\t\t\t\tif (sublayer.layer.options.tipusRang==\"clasicTematic\"){\n\t\t\t\t\t\t\t\tvar dataRemove = {\n\t\t\t\t\t\t\t\t\t\tbusinessId: url('?businessid'),\n\t\t\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\t\t\t\t\tservidorWMSbusinessId:sublayer.layer.options.businessId.toString()\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tremoveLayerFromMap(dataRemove,sublayer);\n\t\t\t\t\t\n\t\t\t\t\t\t\t\tvar props;\n\t\t\t\t\t\t\t\tif (layerMare.layer.options.propName!=undefined) props = layerMare.layer.options.propName.toString();\n\t\t\t\t\t\t\t\telse props='[\"nom\",\"text\"]';\n\t\t\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\t\t\tbusinessid: businessIdCapaMare,\n\t\t\t\t\t\t\t\t\t\tfrom:\"clasicTematic\",\n\t\t\t\t\t\t\t\t\t\tgeometrytype:layerMare.layer.options.geometryType,\n\t\t\t\t\t\t\t\t\t\tleafletid:layerMare.layer._leaflet_id,\n\t\t\t\t\t\t\t\t\t\tpropname:props,\n\t\t\t\t\t\t\t\t\t\ttipus:layerMare.layer.options.tipus\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tbusy=true;\n\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tcreateTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\t\n\t\t\t\t\t\t\t\t//Eliminem la capa de controlCapes\n\t\t\t\t\t\t\t\tcontrolCapes.removeLayer(sublayer);\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tvar rangsJSON2 = getFeatureStyle2(sublayer.layer.options.estil[0],sublayer.layer.options.geometryType);\n\t\t\t\t\t\t\t\tif (features==null){\n\t\t\t\t\t\t\t\t\tfeatures = {\n\t\t\t\t\t\t\t\t\t\t\ttype:feature.layer.options.tipus,\n\t\t\t\t\t\t\t\t\t\t\tid:fId,\n\t\t\t\t\t\t\t\t\t\t\tproperties: feature.properties.data,\n\t\t\t\t\t\t\t\t\t\t\testil: rangsJSON2,\n\t\t\t\t\t\t\t\t\t\t\tgeometry: feature.geometry\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\tfeatures = JSON.stringify(features);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\t\t\tbusinessId: sublayer.layer.options.businessId,//f.layer.properties.capaBusinessId,//Bid de la visualitzacio\n\t\t\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\t\t\t\t\tfeatures: features,\n\t\t\t\t\t\t\t\t\t\testilBusinessId: sublayer.layer.options.estil[0].businessId\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\taddGeometriaToVisualitzacioTematic(data).then(function(results) {\n\t\t\t\t\t\t\t\t\t\tif(results.status === 'OK'){\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.serverName = sublayer.layer.options.nom;\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.serverType = sublayer.layer.options.tipus;\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.capesActiva = \"true\";\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.options.origen = businessIdCapaMare;\t\n\t\t\t\t\t\t\t\t\t\t\tsublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t//eliminem sublayer del mapa, i recarreguem\n\t\t\t\t\t\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\n\t\t\t\t\t\t\t\t\t\t\tloadVisualitzacioLayer(sublayer.layer);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\t\tconsole.debug('addGeometriaToVisualitzacio ERROR');\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tsublayer.layer.serverName = sublayer.layer.options.nom;\n\t\t\t\t\t\t\tsublayer.layer.serverType = sublayer.layer.options.tipus;\n\t\t\t\t\t\t\tsublayer.layer.capesActiva = \"true\";\n\t\t\t\t\t\t\tsublayer.layer.options.origen = businessIdCapaMare;\t\n\t\t\t\t\t\t\tsublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\n\t\t\t\t\t\t\t//eliminem sublayer del mapa, i recarreguem\n\t\t\t\t\t\t\tmap.removeLayer(sublayer.layer);\n\t\t\t\t\t\t\tloadVisualitzacioLayer(sublayer.layer);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (tipusModificacio==\"baixa\"){\n\t\t\t\t\t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\n\t\t\t\t  \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\n\t\t\t\t  \t\t  sublayer.layer.capesActiva = \"true\";\n\t\t\t\t  \t\t  sublayer.layer.options.origen =businessIdCapaMare;//layer.properties.capaBusinessId;//BusinessIdCapaorigen\n\t\t\t\t  \t\t  //tipusRang\n\t\t\t\t  \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\n\t\t\t\t  \t\t  //console.debug(sublayer);\n\t\t\t\t  \t\t  //eliminem sublayer del mapa, i recarreguem\n\t\t\t\t  \t\t  map.closePopup();\n\t\t\t\t  \t\t  map.removeLayer(sublayer.layer);\n\t\t\t\t  \t\t  controlCapes.removeLayer(sublayer);\n\t\t\t\t  \t\t  loadVisualitzacioLayer(sublayer.layer);\n\t\t\t\t  \t\t  \n\t\t\t\t  \t\t  \n\t\t\t\t\t}\n\t\t\t\t\telse if (tipusModificacio==\"modificacioInfo\"){\n\t\t\t\t\t\t//Modificació informació d'una geometria - cal refer el temàtic.\n\t\t\t\t\t\tvar dataRemove = {\n\t\t\t\t\t\t\t\tbusinessId: url('?businessid'),\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\t\t\tservidorWMSbusinessId:lbusinessId.toString()\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\tremoveLayerFromMap(dataRemove,sublayer);\n\t\t\t\t\t\tif (sublayer.layer.options.tipusRang==\"clasicTematic\"){\n\t\t\t\t\t\t\tvar props;\n\t\t\t\t\t\t\tif (layerMare.layer.options.propName!=undefined) props = layerMare.layer.options.propName.toString();\n\t\t\t\t\t\t\telse props='[\"nom\",\"text\"]';\n\t\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\t\tbusinessid: businessIdCapaMare,\n\t\t\t\t\t\t\t\t\tfrom:\"clasicTematic\",\n\t\t\t\t\t\t\t\t\tgeometrytype:layerMare.layer.options.geometryType,\n\t\t\t\t\t\t\t\t\tleafletid:layerMare.layer._leaflet_id,\n\t\t\t\t\t\t\t\t\tpropname:props,\n\t\t\t\t\t\t\t\t\ttipus:layerMare.layer.options.tipus\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\tbusy=true;\n\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tcreateTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t//}\n\t\t\t}\n\t\t });\n\t}\n\t\n}\n\nfunction removeLayerFromMap(data,obj){\n\tremoveServerToMap(data).then(function(results){\n\t\tif(results.status==='OK'){\n\n\n\t\t\tmap.removeLayer(obj.layer);\n\t\t\t//Eliminem la capa de controlCapes\n\t\t\tcontrolCapes.removeLayer(obj);\n\t\t\t//Esborrem la llegenda de la capa eliminada\n\t\t\temptyMapLegendEdicio(obj.layer);\n\t\t\t//actualitzem valors zindex de la resta si no es sublayer\n\t\t\tif(!obj.sublayer){\n\t\t\t\tvar removeZIndex = obj.layer.options.zIndex;\n\t\t\t\tcontrolCapes._lastZIndex--;\n\t\t\t\tvar aux = controlCapes._layers;\n\t\t\t\tfor (var i in aux) {\n\t\t\t\t\tif (aux[i].layer.options.zIndex > removeZIndex) aux[i].layer.options.zIndex--;\n\t\t\t\t}\n\t\t\t\t//Eliminem les seves sublayers en cas que tingui\n\t\t\t\tfor(indexSublayer in obj._layers){\n\t\t\t\t\tmap.removeLayer(map._layers[indexSublayer]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//Actualitzem capaUsrActiva\n\t\t\tif(capaUsrActiva!=null && capaUsrActiva.options.businessId == obj.layer.options.businessId){\n\t\t\t\tcapaUsrActiva.removeEventListener('layeradd');\n\t\t\t\tcapaUsrActiva = null;\n\t\t\t}\n\n\t\t\tdeleteServerRemoved(data).then(function(results){\n\t\t\t\t//se borran del listado de servidores\n\t\t\t});\n\n\t\t\t\n\n\n\t\t}else{\n\t\t\treturn;//SI no ha anat be el canvi a BD. que no es faci tampoc a client, i es mostri un error\n\t\t}\n\t});\n}\n\n\n","/**\n * \n */\nfunction createURLfileLayer(urlFile, tipusFile, epsgIN, dinamic, nomCapa, colX, colY, tipusAcc, tipusFont, tipusCodi, nomCampCodi){\n\t//Estil defecte\n\tvar estil_do = retornaEstilaDO(t_url_file);\n\tvar estil_lin_pol = estil_do;\n\n\t//Recuperem estils de la barra d'eines\n\tvar lineStyle = getLineRangFromStyle(canvas_linia);\n\tlineStyle.weight = lineStyle.lineWidth;\n\n\tvar polygonStyle = getPolygonRangFromStyle(canvas_pol);\n\tpolygonStyle.weight = polygonStyle.borderWidth;//lineWidth;\n\tpolygonStyle.fillColor = polygonStyle.color;\n\tpolygonStyle.color = polygonStyle.borderColor;\n\tpolygonStyle.fillOpacity = polygonStyle.opacity/100; \n\tpolygonStyle.opacity = 1;\n\n\tvar markerStyle = getMarkerRangFromStyle(defaultPunt);\n\n\tif(markerStyle.isCanvas){\n\t\testil_do.color = markerStyle.borderColor;\n\t\testil_do.fillColor = markerStyle.color;\n\t\testil_do.fillOpacity = 1;\n\t\testil_do.opacity = 1;\n\t\testil_do.radius = markerStyle.simbolSize;\n\t\testil_do.weight = markerStyle.borderWidth;\n\t}else{\n\t\testil_do.fillColor = getColorAwesomeMarker(markerStyle.marker, markerStyle.color);\n\t}\n\n\t/***Parseig url en cas google drive****/\n\t//https://drive.google.com/file/d/FILE_ID/edit?usp=sharing\n\t//https://drive.google.com/uc?export=download&id=FILE_ID\n\n\tif(urlFile.indexOf(\"https://drive.google.com/file/d/\")!=-1){\n\t\turlFile = urlFile.replace(\"https://drive.google.com/file/d/\", \"\");\n\t\tvar res = urlFile.split(\"/\");\n\t\tvar fileId = res[0];\n\t\turlFile = \"https://drive.google.com/uc?export=download&id=\"+fileId;\n\t}\n\telse if(urlFile.indexOf(\"https://www.dropbox.com\")!=-1){\n\t\turlFile = urlFile.replace(\"https://www.dropbox.com\", \"https://dl.dropboxusercontent.com\");\t\t\n\t}\n\n\t/*** DINAMIC ***/\n\tif(dinamic){\n\t\tbusy = false;\n\t\tvar propName = \"\";\n\t\tvar param_url = paramUrl.urlFileDin\t+\"tipusFile=\" + tipusFile+\n\t\t\"&tipusAcc=\"+tipusAcc+\n\t\t\"&tipusCodi=\"+tipusCodi+\n\t\t\"&tipusFont=\"+tipusFont+\n\t\t\"&nomCampCodi=\"+nomCampCodi+\n\t\t\"&urlFile=\"+encodeURIComponent(urlFile)+\n\t\t\"&epsgIN=\"+epsgIN+\n\t\t\"&dinamic=\"+dinamic+\n\t\t\"&uploadFile=\"+paramUrl.uploadFile+\n\t\t\"&colX=\"+colX+\n\t\t\"&colY=\"+colY+\n\t\t\"&uid=\"+Cookies.get('uid');\t\t\n\t\t\n\t\tif ((urlFile.indexOf(\"socrata\")>-1 || urlFile.indexOf(\"https\")>-1) && (urlFile.indexOf(\"drive\")==-1)\n\t\t\t\t&& (urlFile.indexOf(\"dropbox\")==-1)) \t{\n\t\t\tparam_url = urlFile;\n\t\t}\n\n\t\t$('#dialog_dades_ex').modal('hide');\n\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\tjQuery(\"#div_uploading_txt\").html('<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\"> '+\n\t\t\t\twindow.lang.translate('Carregant dades')+\n\t\t'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>');\t\t\n\t\tjQuery('#info_uploadFile').show();\n\n\t\tvar capaURLfile = new L.GeoJSON.AJAX(param_url, {\n\t\t\tnom : nomCapa,\n\t\t\ttipus : t_url_file,\n\t\t\testil_do: estil_do,\n\t\t\tstyle: estil_lin_pol,//Estil de poligons i linies\n\t\t\tpointToLayer : function(feature, latlng) {\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\tpropName = \"\";\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tpropName = propName+key+\",\";\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t\tpropName = propName.substr(0, propName.length-1);\n\t\t\t\thtml+='</div></div>'; \n\t\t\t\treturn geom.bindPopup(html);\n\t\t\t},\n\t\t\tonEachFeature : function(feature, latlng) {\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\tpropName = \"\";\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tpropName = propName+key+\",\";\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t\tpropName = propName.substr(0, propName.length-1);\n\t\t\t\thtml+='</div></div>'; \n\t\t\t\treturn latlng.bindPopup(html);\n\t\t\t},\t\t\t  \n\t\t\tmiddleware:function(data){\n\t\t\t\tif(data.status && data.status.indexOf(\"ERROR\")!=-1){\n\t\t\t\t\tprocessFileError(data, urlFile);\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t}else{\n\t\t\t\t\tvar stringData = JSON.stringify(data);\n\t\t\t\t\tvar geometryType = defineGeometryType(stringData);\n\n\t\t\t\t\tif(geometryType.indexOf(\"point\")!=-1){\n\t\t\t\t\t\tcapaURLfile.options.style = estil_do;\n\t\t\t\t\t}else if(geometryType.indexOf(\"line\")!=-1){\n\t\t\t\t\t\tcapaURLfile.options.style = lineStyle;\n\t\t\t\t\t}else if(geometryType.indexOf(\"polygon\")!=-1){\n\t\t\t\t\t\tcapaURLfile.options.style = polygonStyle;\n\t\t\t\t\t}\n\t\t\t\t\ttry{\n\t\t\t\t\t\tcapaURLfile.addData(data);\n\t\t\t\t\t}catch(err){\n\t\t\t\t\t\tconsole.debug(err);\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tvar llista_options = '{\"tipusFile\":\"'+tipusFile+\n\t\t\t\t\t'\",\"nom\":\"'+nomCapa+\n\t\t\t\t\t'\",\"propName\":\"'+propName+\n\t\t\t\t\t'\",\"url\":\"'+urlFile+\n\t\t\t\t\t'\",\"tipus\":\"'+t_url_file+\n\t\t\t\t\t'\",\"epsgIN\":\"'+epsgIN+\n\t\t\t\t\t'\", \"geometryType\":\"'+geometryType+\n\t\t\t\t\t'\",\"colX\":\"'+colX+\n\t\t\t\t\t'\",\"colY\":\"'+colY+\n\t\t\t\t\t'\", \"dinamic\":\"'+dinamic+\n\t\t\t\t\t'\", \"tipusAcc\":\"'+tipusAcc+\n\t\t\t\t\t'\", \"tipusCodi\":\"'+tipusCodi+\n\t\t\t\t\t'\", \"tipusFont\":\"'+tipusFont+\n\t\t\t\t\t'\", \"nomCampCodi\":\"'+nomCampCodi+\n\t\t\t\t\t'\", \"style\":'+JSON.stringify(capaURLfile.options.style)+\n\t\t\t\t\t',\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}';\n\n\t\t\t\t\t//Un cop tinc la capa a client, la creo a servidor\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\tserverName: nomCapa,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\n\t\t\t\t\t\tserverType: t_url_file,\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t\t\tactivas: true,\n\t\t\t\t\t\tvisibilitats: true,\n\t\t\t\t\t\torder: controlCapes._lastZIndex+1,\n\t\t\t\t\t\tepsg: '4326',\n\t\t\t\t\t\timgFormat: 'image/png',\n\t\t\t\t\t\tinfFormat: 'text/html',\n\t\t\t\t\t\ttiles: true,\t            \n\t\t\t\t\t\ttransparency: true,\n\t\t\t\t\t\topacity: 1,\n\t\t\t\t\t\tvisibilitat: 'O',\n\t\t\t\t\t\turl: urlFile,//Provar jQuery(\"#txt_URLJSON\")\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t\t\tactivas: true,\n\t\t\t\t\t\tvisibilitats: true,\n\t\t\t\t\t\toptions: llista_options\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques', urlFile, 1]});\n\n\t\t\t\t\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\t\t\t\t\n\n\t\t\t\t\t\t\tcapaURLfile.options.businessId = results.results.businessId;\n\t\t\t\t\t\t\tcapaURLfile.options.nom = nomCapa;\n\t\t\t\t\t\t\tcapaURLfile.options.tipus = t_url_file;\n\t\t\t\t\t\t\tcapaURLfile.options.url = urlFile;\n\t\t\t\t\t\t\tcapaURLfile.options.epsgIN = epsgIN;\n\t\t\t\t\t\t\tcapaURLfile.options.tipusFile = tipusFile;\n\t\t\t\t\t\t\tcapaURLfile.options.options = jQuery.parseJSON('{\"tipusFile\":\"'+tipusFile+'\"}');\n\t\t\t\t\t\t\tcapaURLfile.options.options.estil_do = estil_do;\n\t\t\t\t\t\t\tcapaURLfile.options.geometryType = geometryType;\n\t\t\t\t\t\t\tcapaURLfile.options.colX = colX;\n\t\t\t\t\t\t\tcapaURLfile.options.colY = colY;\n\t\t\t\t\t\t\tcapaURLfile.options.dinamic = dinamic;\n\t\t\t\t\t\t\tcapaURLfile.options.propName = propName;\n\t\t\t\t\t\t\tcapaURLfile.options.tipusAcc = tipusAcc;\n\t\t\t\t\t\t\tcapaURLfile.options.tipusCodi = tipusCodi;\n\t\t\t\t\t\t\tcapaURLfile.options.tipusFont = tipusFont;\n\t\t\t\t\t\t\tcapaURLfile.options.nomCampCodi = nomCampCodi;\n\n\t\t\t\t\t\t\tcapaURLfile.addTo(map);\n\t\t\t\t\t\t\tcapaURLfile.options.zIndex = controlCapes._lastZIndex+1; \n\t\t\t\t\t\t\tcontrolCapes.addOverlay(capaURLfile, nomCapa, true);\n\t\t\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\t\tactivaPanelCapes(true);\t\n\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.debug(\"1.Error a createServidorInMap:\"+results.status);\n\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error createServidorInMap1', urlFile, 1]});\n\t\t\t\t\t\t\tvar txt_error = window.lang.translate(\"Error durant la càrrega de dades. Torni a intentar-ho\");\n\t\t\t\t\t\t\tjQuery(\"#div_url_file_message\").html(txt_error);\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t},function(results){\n\t\t\t\t\t\tconsole.debug(\"2.Error a createServidorInMap:\"+results.status);\n\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error createServidorInMap2', urlFile, 1]});\n\t\t\t\t\t\tvar txt_error = window.lang.translate(\"Error durant la càrrega de dades. Torni a intentar-ho\");\n\t\t\t\t\t\tjQuery(\"#div_url_file_message\").html(txt_error);\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\t\t\n\n\t/*** NO DINAMICA ***/\t\t\n\t}else{\n\t\t//console.debug(\"getUrlFile PROVES NO DINAMICA\");\n\t\tvar codiUnic = getCodiUnic();\n\t\tif ((urlFile.indexOf(\"socrata\")>-1 || urlFile.indexOf(\"https\")>-1) && (urlFile.indexOf(\"drive\")==-1)\n\t\t\t\t&& (urlFile.indexOf(\"dropbox\")==-1)) {\n\t\t\tvar response = $.ajax({ type: \"GET\",   \n\t            url: urlFile,   \n\t            async: false\n\t          }).responseText;\n\t\t\t\n\t\t\t\n\t\t\tvar dataSocrata={\n\t\t\t\t\tserverName: nomCapa,\n\t\t\t\t\tjsonSocrata: response\n\t\t\t};\n\t\t\t\n\t\t\t\n\t\t\tcrearFitxerSocrata(dataSocrata).then(function(results){\n\t\t\t\tif (results.status=\"OK\"){\n\t\t\t\t\turlFile =results.filePath;\n\t\t\t\t\tvar midaFitxer = results.midaFitxer;\n\t\t\t\t\tvar tmpFilePath = results.tmpFilePath;\n\t\t\t\t\tvar tmpFileName = results.tmpFileName;\n\t\t\t\t\t\n\t\t\t\t\tvar data2 = {\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\t\tserverName:nomCapa,\n\t\t\t\t\t\t\tpath:urlFile,\n\t\t\t\t\t\t\ttmpFilePath:tmpFilePath,\n\t\t\t\t\t\t\tmidaFitxer:midaFitxer,\n\t\t\t\t\t\t\tsourceExtension:'geojson',\n\t\t\t\t\t\t\tmarkerStyle: JSON.stringify(getMarkerRangFromStyle(defaultPunt)),\n\t\t\t\t\t\t\tlineStyle: JSON.stringify(getLineRangFromStyle(canvas_linia)),\n\t\t\t\t\t\t\tpolygonStyle: JSON.stringify(getPolygonRangFromStyle(canvas_pol))\n\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t$('#dialog_dades_ex').modal('hide');\n\n\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Descarregant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>'+\n\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'</div>'+\n\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\n\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t\t\t);\t\t\t\t\n\t\t\t\t\t\tjQuery('#info_uploadFile').show();\t\t\t\n\t\t\t\t\t\tjQuery('#info_uploadFile').show();\t\t\n\n\t\t\t\t\t\tvar pollTime = 2000;\n\n\t\t\t\t\t\t//Fem polling\n\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tpoll = function(){\n\t\t\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ tmpFileName,\n\t\t\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS2\")!=-1){\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"PAS3\")!=-1){\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_current\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1){\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_check\" lang=\"ca\">3. '+window.lang.translate('Geometries creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_current\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'//+\t\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t//$.get(HOST_APP+tmpdirPolling +codiUnic + url('?businessid')+\"_response.json\", function(data) { \n\t\t\t\t\t\t\t\t\t\t\t//if(data.status.indexOf(\"OK\")!=-1){\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t//addDropFileToMap(data);\n\t\t\t\t\t\t\t\t\t\t\t\t//\t\t}\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t//});\n\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlFile, 1]});\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1){\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(\"Error al carregar fitxer:\");\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\t\t\tbusy = false;\n\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\n\t\t\t\t\t\t\t\t\t\t\tif(data.codi){\n\n\t\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error '+data.codi, urlFile, 1]});\n\n\t\t\t\t\t\t\t\t\t\t\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Exception durant el tractament del fitxer\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la càrrega del fitxer.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: Error durant les conversions de format del fitxer\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[02]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: OGRInfo ha donat resposta fallida\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[03]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: Accedeix a fileDefault_Error, no li ha arribat be el nom del fitxer\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[06]: \" + window.lang.translate(\"Problema de comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: EnviaFileReady a myUtils.jsp ha donat una excepcio\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[07]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Mida de fitxer supera els 50MB permesos per dades externes dinamiques\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[08]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes no dinàmiques (50MB).\");\n\t\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error sense codi', urlFile, 1]});\n\t\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error en la càrrega de l'arxiu\"));\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\t\t\tpoll();\n\t\t\t\t\t\t\t},pollTime);\n\n\t\t\t\t\t\t})();\t\t\n\n\t\t\t\t\t\tdoUploadFile(data2).then(function(results){\n\t\t\t\t\t\t\taddDropFileToMap(results);\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tvar data = {\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\tserverName: nomCapa,\n\t\t\t\t\ttipusFile: tipusFile,\n\t\t\t\t\turlFile: urlFile,\n\t\t\t\t\tepsgIN: epsgIN,\n\t\t\t\t\tdinamic: dinamic,\n\t\t\t\t\tuploadFile: paramUrl.uploadFile,\n\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\tcolX: colX,\n\t\t\t\t\tcolY: colY,\n\t\t\t\t\ttipusAcc: tipusAcc,\n\t\t\t\t\ttipusFont: tipusFont,\n\t\t\t\t\ttipusCodi: tipusCodi,\n\t\t\t\t\tnomCampCodi: nomCampCodi,\n\t\t\t\t\tcodiUnic: codiUnic,\n\t\t\t\t\tmarkerStyle: JSON.stringify(getMarkerRangFromStyle(defaultPunt)),\n\t\t\t\t\tlineStyle: JSON.stringify(getLineRangFromStyle(canvas_linia)),\n\t\t\t\t\tpolygonStyle: JSON.stringify(getPolygonRangFromStyle(canvas_pol))\n\t\t\t\t};\n\n\t\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t$('#dialog_dades_ex').modal('hide');\n\n\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Descarregant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</span></div>'+\n\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'</div>'+\n\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\n\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t);\t\t\t\t\n\t\t\t\tjQuery('#info_uploadFile').show();\t\t\t\n\t\t\t\tjQuery('#info_uploadFile').show();\t\t\n\n\t\t\t\tvar pollTime = 2000;\n\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpoll = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ codiUnic + url('?businessid')+\".json\",\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS2\")!=-1){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Analitzant fitxer')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_uncheck\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'</div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"PAS3\")!=-1){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_current\" lang=\"ca\">3. '+window.lang.translate('Creant geometries')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_uncheck\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'</div>'//+\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Fitxer descarregat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Fitxer analitzat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step3\" class=\"status_check\" lang=\"ca\">3. '+window.lang.translate('Geometries creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step4\" class=\"status_current\" lang=\"ca\">4. '+window.lang.translate('Processant la resposta')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'//+\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$.get(HOST_APP+tmpdirPolling +codiUnic + url('?businessid')+\"_response.json\", function(data) { \n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"OK\")!=-1){\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\taddDropFileToMap(data);\n\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlFile, 1]});\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error al carregar fitxer:\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\n\t\t\t\t\t\t\t\t\tif(data.codi){\n\n\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error '+data.codi, urlFile, 1]});\n\n\t\t\t\t\t\t\t\t\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Exception durant el tractament del fitxer\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la càrrega del fitxer.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: Error durant les conversions de format del fitxer\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[02]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: OGRInfo ha donat resposta fallida\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[03]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: Accedeix a fileDefault_Error, no li ha arribat be el nom del fitxer\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[06]: \" + window.lang.translate(\"Problema de comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: EnviaFileReady a myUtils.jsp ha donat una excepcio\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[07]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t\t\t\t\t\t\t\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Mida de fitxer supera els 50MB permesos per dades externes dinamiques\n\t\t\t\t\t\t\t\t\t\t\tvar msg = \"[08]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes no dinàmiques (50MB).\");\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(msg);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error sense codi', urlFile, 1]});\n\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error en la càrrega de l'arxiu\"));\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpoll();\n\t\t\t\t\t},pollTime);\n\n\t\t\t\t})();\t\t\n\n\t\t\t\tgetUrlFileNoDin(data);\n\t\t}\n\t\t\n\t\t\n\t}\n}\n\nfunction processFileError(data, urlFile){\n\n\tif(data.codi){\n\n\t\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes dinamiques error '+data.codi, urlFile, 1]});\n\t\tvar txt_error=\"\";\n\t\tif(data.codi.indexOf(\"01\")!=-1){//cas 01: Erro al descarregar el fitxer zip (download_zip_file)\n\t\t\ttxt_error = \"[01]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la descàrrega del fitxer.\");\n\n\t\t}else if(data.codi.indexOf(\"02\")!=-1){//cas 02: EnviaFileReadyCodiDin a myUtils.jsp ha donat una excepcio\n\t\t\ttxt_error = \"[02]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant la comunicació amb el servidor. Si us plau, torni a intentar-ho.\");\n\n\t\t}else if(data.codi.indexOf(\"03\")!=-1){//cas 03: Error de conversio del fitxer\n\t\t\ttxt_error = \"[03]: \" + window.lang.translate(\"Error durant el procés de conversió de format del fitxer. Comprovi que el fitxer és correcte.\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"04\")!=-1){//cas 04: OGRInfo ha donat una excepció\n\t\t\ttxt_error = \"[04]: \" + window.lang.translate(\"Ha ocorregut un error inesperat durant l'anàlisi de la informació del fitxer.\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"05\")!=-1){//cas 05: OGRInfo ha tornat resposta buida\n\t\t\ttxt_error = \"[05]: \" + window.lang.translate(\"L'anàlisi de la informació del fitxer no ha tornat resultats. Comprovi el fitxer i torni a intentar-ho.\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"06\")!=-1){//cas 06: OGRInfo ha donat resposta fallida\n\t\t\ttxt_error = \"[06]: \" + window.lang.translate(\"Error durant l'anàlisi de la informació del fitxer. Comprovi que el fitxer és correcte.\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"07\")!=-1){//cas 07: Num maxim de punts excedit\n\t\t\ttxt_error = \"[07]: \" + window.lang.translate(\"El número de punts supera el màxim permès. Redueixi a 10000 o menys i torni a intentar-ho\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"08\")!=-1){//cas 08: Num maxim de linies/poligons exedit\n\t\t\ttxt_error = \"[08]: \" + window.lang.translate(\"El número total de geometries supera el màxim permès. Redueixi a 6000 o menys i torni a intentar-ho.\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\n\t\t}else if(data.codi.indexOf(\"09\")!=-1){//cas 09: Mida de fitxer supera els 25MB permesos per dades externes dinamiques\n\t\t\ttxt_error = \"[09]: \" + window.lang.translate(\"La mida del fitxer supera el límit preestablert per a dades externes dinàmiques (25MB).\");\n//\t\t\t$('#dialog_error_upload_txt').html(msg);\n\t\t}\t\t\t\n\n\t}else{\n\t\tif(data.results && (data.results.indexOf(\"EXCEPTION1\")  != -1))\n\t\t\ttxt_error = window.lang.translate(\"No s'ha trobat el fitxer: \") + \"<a href=\\\"\" + urlFile + \"\\\" target=_blank>\" + urlFile + \"</a>\";\n\t\telse\n\t\t\ttxt_error = window.lang.translate(\"Error durant el tractament de les dades\");\n\t}\n\n\t/*\n\tif(data.results.indexOf(\"CONVERT ERROR\")!= -1){\n\t\tvar txt_error = window.lang.translate(\"Error de conversió: format o EPSG incorrectes\");\n\t}else if(data.results.indexOf(\"501\")!= -1){//+ de 5000 punts\n\t\ttxt_error += \": \"+window.lang.translate(\"El número de punts supera el màxim permès. Redueixi a 10000 o menys i torni a intentar-ho\");\n\t}else if(data.results.indexOf(\"502\")!= -1){//+ de 1000 features\n\t\ttxt_error += \": \"+window.lang.translate(\"El número de línies/polígons supera el màxim permès. Redueixi a 2000 o menys i torni a intentar-ho\");\n\t}else if(data.results.indexOf(\"503\")!= -1){//+ de 6000 geometries\n\t\ttxt_error += \": \"+window.lang.translate(\"El número total de geometries supera el màxim permès. Redueixi a 6000 o menys i torni a intentar-ho\");\n\t}*/\n\n\t//$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes error', data.results, 1]});\n\t$('#dialog_error_upload_txt').html(txt_error);\n\t$('#dialog_error_upload').modal('show');\n}\n\nfunction loadURLfileLayer(layer){\n\n\tvar defer = $.Deferred();\n\n\tvar options;\n\tif(typeof (layer.options)==\"string\"){\n\t\ttry {\n\t\t\toptions = JSON.parse(layer.options);\n\t\t}\n\t\tcatch (err) {\n\t\t\toptions = layer.options;\t\n\t\t}\n\t}else{\n\t\toptions = layer.options;\t\n\t}\n\t\n\t//Variables comunes para todos los casos\n\tvar style = options.style;\n\tvar tipusFile = options.tipusFile;\n\tvar geometryType = options.geometryType;\n\tvar epsgIN = options.epsgIN;\n\tvar colX = options.colX;\n\tvar colY = options.colY;\n\tvar urlFile = layer.url;\n\tvar dinamic = options.dinamic;\n\t\n\tvar estil_do = options.estil_do;\n\tif(options.tem == tem_heatmap){\n\t\testil_do = retornaEstilaDO(t_url_file); //TODO revisar si se puede quitar esto\n\t}\n\t\n\tvar param_url = paramUrl.urlFileDin +  \"tipusFile=\" + tipusFile+\n\t\t\"&colX=\"+colX+\n\t\t\"&colY=\"+colY+\n\t\t\"&epsgIN=\"+epsgIN+\n\t\t\"&dinamic=\"+dinamic+\n\t\t\"&urlFile=\"+encodeURIComponent(urlFile)+\n\t\t\"&uploadFile=\"+paramUrl.uploadFile;\n\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) { \n\t\t\tparam_url +=\"&uid=\"+_UsrID;\n\t\t}\n\t\telse {\n\t\t\tparam_url +=\"&uid=\"+Cookies.get('uid');\t\n\t\t}\n\t\n\tvar capaURLfileLoad;\n\t/**\n\t * ORIGEN O TEMATIC SIMPLE\n\t */\t\n\tif(options.tem == null || options.tem == tem_simple){\n\t\tvar tipusAcc = options.tipusAcc;\n\t\tvar tipusCodi = options.tipusCodi;\n\t\tvar tipusFont = options.tipusFont;\n\t\tvar nomCampCodi = options.nomCampCodi;\n\n\t\toptions.nom = layer.serverName;\n\t\toptions.businessId = layer.businessId;\n\n\t\tparam_url += \"&tipusAcc=\"+tipusAcc+\n\t\t\t\"&tipusCodi=\"+tipusCodi+\n\t\t\t\"&tipusFont=\"+tipusFont+\n\t\t\t\"&nomCampCodi=\"+nomCampCodi;\n\n\t\t//SOCRATA\t\t\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\n\t\t\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\n\t\t\tnom : layer.serverName,\n\t\t\ttipus : layer.serverType,\n\t\t\tgeometryType: geometryType,\n\t\t\tbusinessId : layer.businessId,\n\t\t\tstyle: style,\n\t\t\tpointToLayer : function(feature, latlng) {\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t\thtml+='</div></div>';    \t\n\t\t\t\tvar popup = L.popup().setContent(html);\n\t\t\t\treturn geom.bindPopup(popup);\n\t\t\t},\n\t\t\tonEachFeature : function(feature, latlng) {\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\t\n\t\t\t\thtml+='</div></div>';\n\t\t\t\treturn latlng.bindPopup(html);\n\t\t\t}\n\t\t});\t\n\t}\t\n\t/**\n\t * TEMATIC CLASIC O MIDES\n\t */\t\n\telse if(options.tem == tem_clasic || options.tem == tem_size){\n\t\tvar tipusAcc = options.tipusAcc;\n\t\tvar tipusCodi = options.tipusCodi;\n\t\tvar tipusFont = options.tipusFont;\n\t\tvar nomCampCodi = options.nomCampCodi;\t\t\n\n\t\toptions.nom = layer.serverName;\n\t\toptions.businessId = layer.businessId;\n\n\t\tparam_url += \"&tipusAcc=\"+tipusAcc+\n\t\t\t\"&tipusCodi=\"+tipusCodi+\n\t\t\t\"&tipusFont=\"+tipusFont+\n\t\t\t\"&nomCampCodi=\"+nomCampCodi;\n\n\t\t//SOCRATA\t\t\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\n\t\t\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\n\t\t\tnom : layer.serverName,\n\t\t\ttipus : layer.serverType,\n\t\t\tgeometryType: geometryType,\n\t\t\tbusinessId : layer.businessId,\n\t\t\tpointToLayer : function(feature, latlng) {\n\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar dataFieldValue = \"\";\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif(key.toLowerCase()==estil_do.dataField) dataFieldValue = value;\n\t\t\t\t});\t\n\t\t\t\thtml+='</div></div>';    \t\n\n\t\t\t\tvar estilGeom; //ficat default point style????\n\t\t\t\t$.each( estil_do.estils, function( index, estil ) {\n\t\t\t\t\tif((estil.valueMax == estil.ValueMin && dataFieldValue == estil.valueMax) || //rang unic\n\t\t\t\t\t\t\t(dataFieldValue>=estil.valueMin && dataFieldValue<=estil.valueMax)){//per valors\n\t\t\t\t\t\testilGeom = { radius : estil.estil.simbolSize, fillColor : estil.estil.color, color : \"#ffffff\", weight : 2, opacity : 1, fillOpacity : 0.8, isCanvas: true };\n\t\t\t\t\t\treturn false;\t\n\t\t\t\t\t}\n\n\t\t\t\t});\n\t\t\t\tvar geom = L.circleMarker(latlng, estilGeom);\t\t    \t\n\t\t\t\tvar popup = L.popup().setContent(html);\n\t\t\t\treturn geom.bindPopup(popup);\n\t\t\t},\n\t\t\tonEachFeature : function(feature, latlng) {\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar dataFieldValue = \"\";\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif(key.toLowerCase()==estil_do.dataField) dataFieldValue = value;\n\t\t\t\t});\t\n\t\t\t\thtml+='</div></div>'; \n\t\t\t\t$.each( estil_do.estils, function( index, estil ) {\n\t\t\t\t\tif((estil.valueMax == estil.valueMin && dataFieldValue == estil.valueMax) || //rang unic\n\t\t\t\t\t\t\t(parseFloat(dataFieldValue)>=parseFloat(estil.valueMin) && parseFloat(dataFieldValue)<=parseFloat(estil.valueMax))){//per valors\t\n\n\t\t\t\t\t\tif(latlng.feature.geometry.type.toLowerCase() == t_polygon ){\t\t\n\t\t\t\t\t\t\tlatlng.setStyle({\n\t\t\t\t\t\t\t\tweight: 2,\n\t\t\t\t\t\t\t\tfillColor: estil.estil.color,\n\t\t\t\t\t\t\t\tcolor: estil.estil.borderColor,\n\t\t\t\t\t\t\t\tfillOpacity: 0.5,\n\t\t\t\t\t\t\t\topacity: 1\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}else if(latlng.feature.geometry.type.toLowerCase().indexOf(t_polyline)!=-1 \n\t\t\t\t\t\t\t\t|| latlng.feature.geometry.type.toLowerCase().indexOf(t_linestring)!=-1){\n\t\t\t\t\t\t\tlatlng.setStyle({\n\t\t\t\t\t\t\t\tweight: 2,\n\t\t\t\t\t\t\t\tcolor: estil.estil.color,\n\t\t\t\t\t\t\t\tfillOpacity: 1,\n\t\t\t\t\t\t\t\topacity: 1\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}else if(latlng.feature.geometry.type.toLowerCase() == t_multipolygon ){\n\t\t\t\t\t\t\tlatlng.setStyle({\n\t\t\t\t\t\t\t\tweight: 2,\n\t\t\t\t\t\t\t\tfillColor: estil.estil.color,\n\t\t\t\t\t\t\t\tcolor: estil.estil.borderColor,\n\t\t\t\t\t\t\t\tfillOpacity: 0.5,\n\t\t\t\t\t\t\t\topacity: 1\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn false;\t\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t\treturn latlng.bindPopup(html);\n\t\t\t}\n\t\t});\t\n\t}\t\n\t/**\n\t * TEMATIC CLUSTER\n\t */\t\n\telse if(options.tem == tem_cluster){\n\t\tparam_url += \"&tem=\"+tem_cluster;\t\n\t\t//SOCRATA\t\t\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\n\t\t\tnom : layer.serverName,\n\t\t\ttipus : layer.serverType,\n\t\t\tgeometryType: geometryType,\n\t\t\testil_do: estil_do,\n\t\t\tbusinessId : layer.businessId,\n\t\t\tpointToLayer : function(feature, latlng) {\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\t\n\t\t\t\thtml+='</div></div>';    \t\n\t\t\t\tvar popup = L.popup().setContent(html);\n\t\t\t\treturn geom.bindPopup(popup);\n\t\t\t},\n\t\t\tonEachFeature : function(feature, latlng) {\n\t\t\t\tvar pp = feature.properties;\n\t\t\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\t\t$.each( pp, function( key, value ) {\n\t\t\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\t\t\n\t\t\t\thtml+='</div></div>';\n\t\t\t\treturn latlng.bindPopup(html);\n\t\t\t}\n\t\t});\n\t}\n\t/**\n\t * TEMATIC HEATMAP\n\t */\n\telse if(options.tem == tem_heatmap){\n\t\t\t\t\n\t\tparam_url += \"&tem=\"+tem_heatmap;\t\n\t\t//SOCRATA\t\t\n\t\tif (urlFile.indexOf(\"socrata\")>-1)\tparam_url = urlFile;\n\t\tcapaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\n\t\t\tnom : layer.serverName,\n\t\t\ttipus : layer.serverType,\n\t\t\tgeometryType: geometryType,\n\t\t\testil_do: estil_do,\n\t\t\tbusinessId : layer.businessId,\n\t\t\tpointToLayer : function(feature, latlng) {\n\t\t\t\tvar geom = L.circleMarker(latlng, estil_do);\n\t\t\t\tvar popup = L.popup().setContent(\"\");\n\t\t\t\treturn geom.bindPopup(popup);\n\t\t\t}\n\t\t});\n\t}\n\t\n\tcapaURLfileLoad.on('data:loaded', function(e){\n\t\tvar self = this;\n\t\t\n\t\tif(options.tem == null || options.tem == tem_simple){\n\t\t\tself.options = options;\n\t\t\taddLayerUrlToMap(self, layer, controlCapes, options.origen, map);\n\t\t}else if(options.tem == tem_clasic || options.tem == tem_size){\n\t\t\tself.options = options;\n\t\t\taddLayerUrlToMap(self, layer, controlCapes, options.origen, map);\n\t\t\tif ($(location).attr('href').indexOf('/mapa.html')!=-1){\n\t\t\t\tloadMapLegendEdicioDinamics(self);\n\t\t\t}\n\t\t}else if(options.tem == tem_cluster){\n\t\t\tvar clusterLayer = L.markerClusterGroup({\n\t\t\t\tsingleMarkerMode : true\n\t\t\t});\n\t\t\tself.eachLayer(function(layer) {\n\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\t\ttitle : layer._leaflet_id\n\t\t\t\t});\n\t\t\t\tmarker.bindPopup(layer._popup._content);\n\t\t\t\tclusterLayer.addLayer(marker);\n\t\t\t});\n\t\t\t\n\t\t\tclusterLayer.options.businessId = layer.businessId;\n\t\t\tclusterLayer.options.nom = layer.serverName;\n\t\t\tclusterLayer.options.zIndex = parseInt(layer.capesOrdre);\n\t\t\tclusterLayer.options.tipus = layer.serverType;\n\t\t\tclusterLayer.options.dataset = options.dataset;\n\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\t\t\tif(self.error){\n\t\t\t\tclusterLayer.error = true;\n\t\t\t}\n\t\t\t\n\t\t\taddLayerUrlToMap(clusterLayer, layer, controlCapes, options.origen, map);\n\t\t\t\n\t\t}else if(options.tem == tem_heatmap){\n\t\t\tvar arrP=[];\n\t\t\tself.options = options;\n\t\t\tself.eachLayer(function(layer){\n\t\t\t\tvar d = [layer.getLatLng().lat,layer.getLatLng().lng,1];\t\n\t\t\t\tarrP.push(d);\t\n\t\t\t});\n\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{\n\t\t\t\tradius:20,\n\t\t\t\tblur:15,\n\t\t\t\tmax:1,\n\t\t\t\tgradient: {\t\t\t\n\t\t\t\t\t0.35: \"#070751\",\n\t\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t\t1: \"#720404\"\n\t\t\t\t}\t\n\t\t\t});\n\n\t\t\theatLayerActiu.options.businessId = layer.businessId;\n\t\t\theatLayerActiu.options.nom = layer.serverName;\n\t\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\n\t\t\theatLayerActiu.options.tipus = layer.serverType;\n\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\tif(self.error){\n\t\t\t\theatLayerActiu.error = true;\n\t\t\t}\n\t\t\taddLayerUrlToMap(heatLayerActiu, layer, controlCapes, options.origen, map);\t\n\t\t}\n\t\t\n\t\tdefer.resolve();\n\t});\n\t\t\n\tcapaURLfileLoad.on('data:progress', function (e) {\n\t\tif (e.error) {\n\t\t\t// handle error\n\t\t\tvar self = this;\n\t\t\tself.error = true;\n\t\t\tdefer.reject(e.error);\n\t\t}\n\t});\n\t\t\n\treturn defer.promise();\n}\n\nfunction addLayerUrlToMap(capaURLfileLoad, layer, controlCapes, origen, map){\n\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\tcapaURLfileLoad.addTo(map);\n\t}\n\n\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\n\t\tcapaURLfileLoad.options.zIndex = controlCapes._lastZIndex + 1;\n\t}else if(layer.capesOrdre != capesOrdre_sublayer){\n\t\tcapaURLfileLoad.options.zIndex = parseInt(layer.capesOrdre);\n\t}\t\t\n\n\tif(!origen){\n\t\tcapaURLfileLoad.options.businessId = layer.businessId;\n\t\tcontrolCapes.addOverlay(capaURLfileLoad, layer.serverName, true);\n\t\tcontrolCapes._lastZIndex++;\t\n\t}else{//Si te origen es una sublayer\n\t\tvar origenL = getLeafletIdFromBusinessId(origen);\n\t\tcapaURLfileLoad.options.zIndex = capesOrdre_sublayer;\n\t\tcontrolCapes.addOverlay(capaURLfileLoad, layer.serverName, true, origenL);\n\t}\n}\n\nfunction constructLayer(layer, estil_do){\n\tlayer.eachLayer(function(marker) {\n\t\tvar geometryType = transformTipusGeometry(marker.feature.geometry.type);\n\t\tif(geometryType == t_marker){\n\t\t\tvar geom = L.circleMarker(marker._latlng, estil_do);\n\t\t}else if(geometryType == t_polyline){\n\t\t\tvar geom = L.polyline(marker._latlngs, {color: estil_do.fillColor, weight: \"3\", opacity: \"1\"});\n\t\t}else if(geometryType == t_polygon){\n\t\t\tvar geom = L.polygon(marker._latlngs, {color: estil_do.color, fillColor: estil_do.fillColor, fillOpacity: estil_do.fillOpacity, weight: estil_do.weight});\n\t\t}\n\t\tvar pp = marker.toGeoJSON().properties;\n\t\tvar html ='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t$.each( pp, function( key, value ) {\n\t\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\tvar txt = value;\n\t\t\t\t\tif (!$.isNumeric(txt)) {\t\t    \t\t\t\t\n\t\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t}\n\t\t\t\t\thtml+= '</div>';\n\t\t\t\t}\n\t\t\t}\n\t\t});\t\t\n\t\thtml+='</div></div>';    \t\n\t\tgeom.bindPopup(html);\n\t\tlayer.removeLayer(marker);\n\t\tlayer.addLayer(geom);\n\t});\n}\n\nfunction loadURLfileLayer2(layer) {\n\tvar defer = $.Deferred();\n\tvar options = jQuery.parseJSON( layer.options );\n\tvar tipusFile = options.tipusFile;\n\tvar estil_do = options.estil_do;\n\tvar urlFile = layer.url;\n\n\tif(tipusFile == t_file_geojson){\n\t\tvar capaURLfile = omnivore.geojson(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_topojson){\n\t\tvar capaURLfile = omnivore.topojson(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_wkt){\n\t\tvar capaURLfile = omnivore.wkt(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_wkt){\n\t\tvar capaURLfile = omnivore.wkt(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_kml){\n\t\tvar capaURLfile = omnivore.kml(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_gpx){\n\t\tvar capaURLfile = omnivore.gpx(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}else if(tipusFile == t_file_csv){\n\t\tvar capaURLfile = omnivore.csv(urlFile, null, L.FeatureGroup())\n\t\t.on('ready', function() {\n\t\t\tconstructLayer(this, estil_do);\n\t\t})\n\t\t.on('error', function() {\n\t\t\tconsole.debug(\"Error omnivore\");\n\t\t})\n\t\t.addTo(map);\t\t\t\t\t\n\t}\n\n\tcapaURLfile.options.businessId = layer.businessId;\n\tcapaURLfile.options.nom = layer.serverName;\n\tcapaURLfile.options.tipus = t_url_file;\n\tcapaURLfile.options.url = urlFile;\n\tcapaURLfile.options.options = jQuery.parseJSON('{\"tipusFile\":\"'+tipusFile+'\"}');\n\tcapaURLfile.options.options.estil_do = estil_do;\n\tcapaURLfile.options.zIndex = controlCapes._lastZIndex+1; \n\tcontrolCapes.addOverlay(capaURLfile, layer.serverName, true);\n\tcontrolCapes._lastZIndex++;\n\tactivaPanelCapes(true);\t\n\treturn defer.promise();\n}\n\nfunction defineGeometryType(data){\n\tif(data.indexOf(\"Point\")!=-1){\n\t\treturn t_point;\n\t}else if(data.indexOf(\"Line\")!=-1){\n\t\treturn t_linestring;\n\t}else if(data.indexOf(\"Polygon\")!=-1){\n\t\treturn t_polygon;\n\t}\n}\n\nfunction loadUrlFileHeatmapLayer(layer){\n\n\tvar options = jQuery.parseJSON( layer.options );\n\tvar style = options.style;\n\tvar tipusFile = options.tipusFile;\n\tvar geometryType = options.geometryType;\n\tvar epsgIN = options.epsgIN;\n\tvar colX = options.colX;\n\tvar colY = options.colY;\n\tvar urlFile = layer.url;\n\tvar dinamic = options.dinamic;\n\tvar param_url = paramUrl.urlFileDin + \"tipusFile=\" + tipusFile+\"&colX=\"+colX+\"&colY=\"+colY+\"&epsgIN=\"+epsgIN+\"&dinamic=\"+dinamic+\"&urlFile=\"+encodeURIComponent(urlFile);\t\n\n\tvar capaURLfileLoad = new L.GeoJSON.AJAX(param_url, {\n\t\tnom : layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tgeometryType: geometryType,\n\t\testil_do: estil_do,\n\t\tstyle: style,\n\t\tbusinessId : layer.businessId,\n\t\tpointToLayer : function(feature, latlng) {\n\t\t\tvar geom = L.circleMarker(latlng, estil_do);\n\t\t}\n\t});\t\t\n\n\tcapaURLfileLoad.on('data:loaded', function(e){\n\n\t\tvar arrP=[];\n\t\tcapaURLfileLoad.eachLayer(function(layer){\n\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\n\t\t\tarrP.push(d);\t\t\t\n\t\t});\n\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\t\tgradient: {\t\t\t\n\t\t\t\t0.35: \"#070751\",\n\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t1: \"#720404\"\n\t\t\t}\t\n\t\t});\n\n\t\theatLayerActiu.options.businessId = layer.businessId;\n\t\theatLayerActiu.options.nom = layer.serverName;\n\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\n\t\theatLayerActiu.options.tipus = layer.serverType;\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tmap.addLayer(heatLayerActiu);\n\t\t}\n\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\n\t\tactivaPanelCapes(true);\t\t\n\t});\n\n}\n\n","/**\n * \n */\n\nfunction loadVisualitzacioWmsLayer(layer){\n\t\n//\tconsole.debug(\"loadVisualitzacioWmsLayer\");\n//\tconsole.debug(layer);\n\t\n\tvar jsonOptions;\t\n\t\n\tif(typeof (layer.options)==\"string\"){\n\t\ttry {\n\t\t\tjsonOptions = JSON.parse(layer.options);\n\t\t}\n\t\tcatch (err) {\n\t\t\tjsonOptions = layer.options;\t\n\t\t}\n\t}else{\n\t\t\n\t\tjsonOptions = layer.options;\t\n\t}\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\tvar optionsWMS = {\n\t        layers : layer.businessId,\n\t        crs : L.CRS.EPSG3857,\n\t        transparent : true,\n\t        format : layer.imgFormat,//'image/png'\n\t    \tversion: layer.version,\n\t    \ttileSize:512,\n\t       opacity: layer.opacity,\t    \n\t    \tnom : layer.serverName,\n\t    \ttipus: layer.serverType,\n\t    \tzIndex :  parseInt(layer.capesOrdre),\n\t    \tgroup: jsonOptions.group,\n\t    \tbusinessId: layer.businessId\t        \t\n\t}\n\tvar wmsLayer = new L.tileLayer.betterWms(layer.url, optionsWMS);\n\n\tvar optionsUtfGrid = {\n            layers : layer.businessId,\n            crs : L.CRS.EPSG4326,\n            srs: \"EPSG:4326\",\n            transparent : true,\n            format : 'utfgrid',\n            nom : layer.serverName + \" utfgrid\",\n\t    \ttipus: layer.serverType,\n\t    \tgroup: jsonOptions.group,\n\t    \t//zIndex :  parseInt(layer.capesOrdre),\t    \n\t    \tbusinessId: layer.businessId            \n\t}\n\tvar utfGridLayer = createUtfGridLayer(layer.url,optionsUtfGrid);\n\t\n//\tvar utfGrid = new L.UtfGrid(layer.url,optionsUtfGrid);\n\t//Mostrar informacio\n\t/*\n\tutfGrid.on('mouseover', function (e) {});\n\tutfGrid.on('mouseout', function (e) {});\n\n\tutfGrid.on('click', function (e) {\n\t\tif (e.data!=null){\n\t\t\tconsole.debug(e.data);\n\t\t\t\n\t\t\tjQuery('#bt_info_geojsonvt_close').on('click', function (e) {\n//\t\t\t\ttancaFinestra();\n\t\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html('');\n\t\t\t\tjQuery('#info_geojsonvt').hide();\n\t\t\t});\n\t\t\t\n\t\t\tvar html ='';\n\t\t\thtml+='<div class=\"popup_pres\">';\n\t\t\t$.each( e.data, function( key, value ) {\n\t\t\t\tconsole.debug( key + \": \" + value );\n\t\t\t\tconsole.debug(\"key : data\");\n\t\t\t\tconsole.debug(key);\n\t\t\t\tconsole.debug(data);\n\t\t\t\tif(key.indexOf(\"slot\")==-1 && value!=undefined && value!=null && value != \" \"){\n\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar txt = parseUrlTextPopUp(String(value), key);\n\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t\t'</div>';\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\thtml+= '</div>';\n\t\t\t\n\t\t\t//var html = '<p>Hello world!<br />This is a nice popup.</p>';\n\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html(html);\n\t\t\tjQuery('#info_geojsonvt').show();\n\t\t\tconsole.debug(\"html:\");\n\t\t\tconsole.debug(html);\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"null\");\n\t\t}\n\t});\n\t*/\t\n\t\n\tif (!layer.capesActiva || layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\tmap.addLayer(wmsLayer).addLayer(utfGridLayer);\n\t\twmsLayer.options.utfGridLeafletId = utfGridLayer._leaflet_id; \n\t}\n\t\n\tif (!layer.capesOrdre){\n\t\twmsLayer.options.zIndex = controlCapes._lastZIndex + 1;\n\t}else{\n\t\twmsLayer.options.zIndex = parseInt(layer.capesOrdre);\n\t}\n\tcontrolCapes.addOverlay(wmsLayer, wmsLayer.options.nom, true);\n\tcontrolCapes._lastZIndex++;\t\n}\n\nfunction loadVisualitzacioWmsLayerSenseUtfGrid(layer){\n\tvar defer = $.Deferred();\n\tvar optionsWMS = {\n\t        layers : layer.serverName,\n\t        crs : L.CRS.EPSG3857,\n\t        transparent : true,\n\t        format : layer.imgFormat,//'image/png'\n\t    \tversion: layer.version,\n\t    \ttileSize:512,\n\t    \t//    opacity: layer.opacity,\t    \n\t    \tnom : layer.serverName,\n\t    \ttipus: layer.serverType,\n\t    \tzIndex :  parseInt(layer.capesOrdre),\t    \n\t    \tbusinessId: layer.businessId\t        \t\n\t}\n\tvar wmsLayer =L.tileLayer.betterWms(layer.url, optionsWMS);\n\tmap.addLayer(wmsLayer);\n\t\n\tvar jsonOptions;\n\tif(typeof (layer.options)==\"string\"){\n\t\ttry {\n\t\t\tjsonOptions = JSON.parse(layer.options);\n\t\t}\n\t\tcatch (err) {\n\t\t\tjsonOptions = layer.options;\t\n\t\t}\n\t}else{\t\t\n\t\tjsonOptions = layer.options;\t\n\t}\t\n\t\n\tvar origen = getLeafletIdFromBusinessId(jsonOptions.origen);\n    wmsLayer.options.zIndex = capesOrdre_sublayer;\n\tcontrolCapes.addOverlay(wmsLayer, wmsLayer.options.nom, true,origen);\n\tdefer.resolve();\n\t\n}\n\nfunction createUtfGridLayer(url,options){\n\n\tvar utfGrid = new L.UtfGrid(url,options);\n\n\tutfGrid.on('click', function (e) {\n\t\tif (e.data!=null){\n//\t\t\tconsole.debug(e.data);\n\t\t\t\n\t\t\tjQuery('#bt_info_geojsonvt_close').on('click', function (e) {\n//\t\t\t\ttancaFinestra();\n\t\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html('');\n\t\t\t\tjQuery('#info_geojsonvt').hide();\n\t\t\t});\n\t\t\t\n\t\t\tvar html ='';\n\t\t\thtml+='<div class=\"popup_pres\">';\n\t\t\t$.each( e.data, function( key, value ) {\n//\t\t\t\tconsole.debug( key + \": \" + value );\n\t\t\t\tif(key.indexOf(\"slot\")==-1 && value!=undefined && value!=null && value != \" \"){\n\t\t\t\t\t//treiem caracter '_' del nom de la propietat\n\t\t\t\t\tkey = key.replace('_', ' ');\n\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\t\t\thtml+='<div class=\"popup_data_row width100\">';\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar txt = value;\n\t    \t\t\t\tif (!$.isNumeric(txt) && !validateWkt(value)){\t    \t\t\t\t\n\t\t    \t\t\t\ttxt = parseUrlTextPopUp(value,key);\n\t\t    \t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t\t\t'</div>';\n\t\t    \t\t\t\t}else{\n\t\t    \t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t    \t\t\t\t}\n\t    \t\t\t\t}\n\t    \t\t\t\telse {\n\t    \t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t    \t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t\t\t'</div>';\n\t    \t\t\t\t}\n\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\thtml+= '</div>';\n\t\t\t\n\t\t\t//var html = '<p>Hello world!<br />This is a nice popup.</p>';\n\t\t\tjQuery('#info_geojsonvt .div_popup_visor').html(html);\n\t\t\tjQuery('#info_geojsonvt').show();\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"null\");\n\t\t}\n\t});\t\n\t\n\treturn utfGrid;\n}","/**\n * Gestió de la creació i carrega de capes de tipus social:\n * - L.Panoramio.custom.js\n * - L.Wikipedia.custom.js\n * - L.Twitter.custom.js\n */\n\nfunction addPanoramioLayer(){\n\t\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'panoramio', 'label panoramio', 1]});\n\t//_kmq.push(['record', 'panoramio', {'from':'mapa', 'tipus user':tipus_user}]);\n\t\n\tvar panoramio = new L.Panoramio.custom({\n\t\tmaxLoad: 10, \n\t\tmaxTotal: 250, \n\t\tnom : 'panoramio',\n\t\tbusinessId: '-1',\n\t\ttipus: t_xarxes_socials\n\t});\n\t\n\tif(typeof url('?businessid') == \"string\"){\n\t\tvar data = {\n\t\t\tuid:Cookies.get('uid'),\n\t\t\tmapBusinessId: url('?businessid'),\n\t\t\tserverName: 'panoramio',\n\t\t\tserverType: t_xarxes_socials,\n\t\t\tcalentas: false,\n            activas: true,\n            visibilitats: true,\n            order: controlCapes._lastZIndex+1,\n            epsg: '4326',\n            transparency: true,\n            visibilitat: visibilitat_open,\n\t\t\toptions: '{\"xarxa_social\": \"panoramio\"}'\n\t\t};\n\t\t\n\t\tcreateServidorInMap(data).then(function(results){\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\tpanoramio.options.businessId = results.results.businessId;\n\t\t\t\tpanoramio.options.xarxa_social=\"panoramio\";\n\t\t\t\tpanoramio.addTo(map);\n\t\t\t\tpanoramio.options.zIndex = controlCapes._lastZIndex+1;\n\t\t\t\tcontrolCapes.addOverlay(panoramio, 'panoramio', true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tactivaPanelCapes(true);\n\t\t\t}else{\n\t\t\t\tconsole.debug('error create server in map');\n\t\t\t}\n\t\t});\t\n\t}else{\n\t\tpanoramio.addTo(map);\n\t\tpanoramio.options.zIndex = controlCapes._lastZIndex+1;\n\t\tcontrolCapes.addOverlay(panoramio, 'panoramio', true);\n\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t}\t\n}\n\nfunction loadPanoramioLayer(layer){\t\n\t\n\t\n\t\n\tvar panoramio = new L.Panoramio.custom({\n\t\tmaxLoad: 10, \n\t\tmaxTotal: 250, \n\t\tzIndex: parseInt(layer.capesOrdre),\n\t\tnom : layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tbusinessId: layer.businessId,\n\t\toptions: '{\"xarxa_social\": \"panoramio\"}'\n\t});\t\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\tif (options.group){\n\t\tpanoramio.options.group=options.group;\n\t\tpanoramio.options.xarxa_social=\"panoramio\";\n\t}\n\t\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\tpanoramio.addTo(map);\n\t}\n\tcontrolCapes.addOverlay(panoramio, layer.serverName, true);\n\tcontrolCapes._lastZIndex++;\n}\n\nfunction addTwitterLayer(){\n\t\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'twitter', hashtag, 1]});\t\n\t//_kmq.push(['record', 'twitter', {'from':'mapa', 'tipus user':tipus_user, 'hashtag':hashtag}]);\n\t\n\tvar hashtag = $('#twitter-collapse .input-group #hashtag_twitter_layer').val();\n\t//Control no afegit #\n\tif(hashtag.indexOf(\"#\") == 0) hashtag = hashtag.substr(1);\n\t\n\tif(hashtag == null || hashtag == \"\") return;\n\t\n\t$('#twitter-collapse .input-group #hashtag_twitter_layer').val(\"\");\n\tvar twitter = new L.Twitter({\n\t\thashtag: hashtag,\n\t\tnom: 'twitter #'+ hashtag,\n\t\tbusinessId: '-1',\n\t\ttipus: t_xarxes_socials\n\t});\n\n\t//Si el mapa existeix a BD\n\tif(typeof url('?businessid') == \"string\"){\t\n\t\tvar data = {\n\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\tserverName: 'twitter #'+ hashtag,\n\t\t\t\tserverType: t_xarxes_socials,\n\t\t\t\tcalentas: false,\n\t            activas: true,\n\t            visibilitats: true,\n\t            order: controlCapes._lastZIndex+1,\n\t            epsg: '4326',\n\t            transparency: true,\n\t            visibilitat: visibilitat_open,\n\t\t\t\toptions: '{\"xarxa_social\": \"twitter\", \"hashtag\": \"'+hashtag+'\"}'\n\t\t};\n\t\t\n\t\tcreateServidorInMap(data).then(function(results){\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\ttwitter.options.businessId = results.results.businessId;\n\t\t\t\ttwitter.options.xarxa_social=\"twitter\";\n\t\t\t\ttwitter.options.hashtag=hashtag;\n\t\t\t\ttwitter.addTo(map);\n\t\t\t\ttwitter.options.zIndex = controlCapes._lastZIndex+1;\n\t\t\t\tcontrolCapes.addOverlay(twitter, 'twitter #'+ hashtag, true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tactivaPanelCapes(true);\n\t\t\t}else{\n\t\t\t\tconsole.debug('error create server in map');\n\t\t\t}\n\t\t});\t\n\t}else{\n\t\ttwitter.addTo(map);\n\t\ttwitter.options.zIndex = controlCapes._lastZIndex+1;\n\t\tcontrolCapes.addOverlay(twitter, 'twitter #'+ hashtag, true);\n\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t}\t\n\t//Tanquem input twitter\n\t$('#twitter-collapse').hide();\n} \n\nfunction loadTwitterLayer(layer, hashtag){\n\tvar twitter = new L.Twitter({\n\t\thashtag: hashtag,\n\t\tnom: layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tzIndex: parseInt(layer.capesOrdre), \n\t\tbusinessId: layer.businessId\n\t});\t\n\t\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\tif (options.group){\n\t\ttwitter.options.group=options.group;\n\t}\n\t\n\t\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\ttwitter.addTo(map);\n\t}\n\tcontrolCapes.addOverlay(twitter, layer.serverName, true);\n\tcontrolCapes._lastZIndex++;\n}\n\n\n\n\n\nfunction addWikipediaLayer(){\t\n\t\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'wikipedia', 'label wikipedia', 1]});\n\t//_kmq.push(['record', 'wikipedia', {'from':'mapa', 'tipus user':tipus_user}]);\n\t\n\tvar keyName = $('#wikipedia-collapse .input-group #name_wikipedia_layer').val();\t\n\t\n\tvar wikipedia = new L.Wikipedia({\n\t\tnom : 'wikipedia',\n\t\tbusinessId: '-1',\n\t\ttipus: t_xarxes_socials,\n\t\tkey: keyName\n\t});\n\t\n\tif(typeof url('?businessid') == \"string\"){\n\t\t\n\t\tvar data = {\n\t\t\tuid:Cookies.get('uid'),\n\t\t\tmapBusinessId: url('?businessid'),\n\t\t\tserverName: 'wikipedia',\n\t\t\tserverType: t_xarxes_socials,\n\t\t\tcalentas: false,\n            activas: true,\n            visibilitats: true,\n            order: controlCapes._lastZIndex+1,\n            epsg: '4326',\n            transparency: true,\n            visibilitat: visibilitat_open,\n\t\t\toptions: '{\"xarxa_social\": \"wikipedia\", \"key\": \"'+keyName+'\"}'\n\t\t};\n\t\t\n\t\t\n\t\t\n\t\tcreateServidorInMap(data).then(function(results){\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\twikipedia.options.businessId = results.results.businessId;\t\t\t\n\t\t\t\twikipedia.options.xarxa_social = \"wikipedia\";\t\t\t\t\n\t\t\t\twikipedia.options.key = keyName;\t\t\t\t\t\t\t\t\n\t\t\t\twikipedia.addTo(map);\n\t\t\t\twikipedia.options.zIndex = controlCapes._lastZIndex+1;\n\t\t\t\tcontrolCapes.addOverlay(wikipedia, 'wikipedia', true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tactivaPanelCapes(true);\n\t\t\t}else{\n\t\t\t\tconsole.debug('error create server in map');\n\t\t\t}\n\t\t});\n\t}else{\n\t\t\n\t\t\n\t\t\n\t\t\n\t\twikipedia.addTo(map);\n\t\twikipedia.options.zIndex = controlCapes._lastZIndex+1;\n\t\tcontrolCapes.addOverlay(wikipedia, 'wikipedia', true);\n\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t}\t\n}\n\nfunction loadWikipediaLayer(layer){\n\t\n\tvar wikipedia = new L.Wikipedia({\n\t\tzIndex: parseInt(layer.capesOrdre),\n\t\tnom : layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tbusinessId: layer.businessId\n\t});\t\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\tif (options.group){\n\t\twikipedia.options.group=options.group;\n\t}\n\t\n\t\n\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\twikipedia.addTo(map);\n\t}\n\tcontrolCapes.addOverlay(wikipedia, layer.serverName, true);\n\tcontrolCapes._lastZIndex++;\n}\n","/**\n * Gestió de la creació i carrega de capes de Dades obertes\n */\n\nvar _htmlDadesObertes = [];\nfunction generaLListaDadesObertes() {\n\tgetLListaDadesObertes().then(function(results) {\n\t\t_htmlDadesObertes.push('<div class=\"panel-danger\"><ul class=\"bs-dadesO llista-do panel-heading\">');\n\t\t$.each(results.dadesObertes, function(key, dataset) {\n\t\t\t_htmlDadesObertes.push('<li><a class=\"label-explora\" lang=\"ca\" title=\"Afegir capa\" href=\"#\" id=\"'\n\t\t\t\t+ dataset.dataset\n\t\t\t\t+ '\">'\n\t\t\t\t+ dataset.text\n\t\t\t\t+ '</a>'\n\t\t\t\t+ '<a target=\"_blank\" lang=\"ca\" title=\"Informació de les dades\" href=\"'+dataset.urn+'\"><span class=\"glyphicon glyphicon-info-sign info-explora\"></span></a>'\t\t\t\t\t\t\t\n\t\t\t\t+'</li>');\n\t\t});\n\t\t_htmlDadesObertes.push('</ul><div id=\"div_do_message\"></div></div>');\n\t});\n}\n\nfunction addCapaDadesObertes(dataset,nom_dataset) {\n\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades obertes', nom_dataset, 1]});\n\n\t\n\tvar param_url = paramUrl.dadesObertes + \"dataset=\" + dataset;\n\tvar estil_do = retornaEstilaDO(dataset);\n\t\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(param_url, {\n\t\tonEachFeature : createPopupWindowDadesObertes,\n\t\tnom : dataset,\n\t\ttipus : t_dades_obertes,\n\t\tdataset: dataset,\n\t\testil_do: estil_do,\n\t\tbusinessId : '-1',\n\t\tgeometryType:t_marker,\n\t\tpointToLayer : function(feature, latlng) {\n\t\t\tif(dataset.indexOf('meteo')!=-1){\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t\t    iconUrl: feature.style.iconUrl,\n\t\t\t\t\t    iconSize:     [44, 44], \n\t\t\t\t\t    iconAnchor:   [22, 22], \t\t\t\t   \n\t\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t\t})});\n\t\t\t}else if(dataset.indexOf('incidencies')!=-1){\n\t\t\t\tvar inci=feature.properties.descripcio_tipus;\n\t\t\t\tvar arr = [\"Obres\", \"Retenció\", \"Cons\", \"Meterologia\" ];\n\t\t\t\tvar arrIM = [\"st_obre.png\", \"st_rete.png\", \"st_cons.png\", \"st_mete.png\" ];\n\t\t\t\tvar imgInci=\"/geocatweb/img/\"+arrIM[jQuery.inArray( inci, arr )];\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t    iconUrl: imgInci,\n\t\t\t\t    iconSize:     [30, 26], \n\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \n\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t})});\n\t\t\t}else if(dataset.indexOf('cameres')!=-1){\n\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t    iconUrl: \"/geocatweb/img/st_came.png\",\n\t\t\t\t    iconSize:     [30, 26], \n\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \n\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t})});\n\t\t\t}else{\n\t\t\treturn L.circleMarker(latlng, estil_do);\n\t\t\t}\n\t\t},\n\t\tmiddleware:function(data){\n            \n            if(data.status && data.status.indexOf(\"ERROR\")!=-1){\n        \t\tif(data.results.indexOf(\"CONVERT ERROR\")!= -1){\n    \t\t\tvar txt_error = window.lang.translate(\"Error en el tractament de les dades\");\n    \t\t\tjQuery(\"#div_do_message\").html('<div class=\"alert alert-danger\">'+txt_error+'</div>');\n\t    \t\t}\n\t    \t\telse{\n\t    \t\t\tvar txt_error = window.lang.translate(\"Impossible accedir a la font de dades\");\n\t    \t\t\tjQuery(\"#div_do_message\").html('<div class=\"alert alert-danger\">'+txt_error+'</div>');\n\t    \t\t}            \t\n            }else{\n            \tif (data!=null && data.features!=\"undefined\"){\n            \t\tjQuery(\"#div_do_message\").html(\"\");\n\t            \tcapaDadaOberta.addData(data);\n\t            \t\n\t            \tif(typeof url('?businessid') == \"string\"){\n\t    \t\t\t\tvar data = {\n\t    \t\t\t\t\tuid:Cookies.get('uid'),\n\t    \t\t\t\t\tmapBusinessId: url('?businessid'),\n\t    \t\t\t\t\tserverName: nom_dataset,\n\t    \t\t\t\t\tserverType: t_dades_obertes,\n\t    \t\t\t\t\tcalentas: false,\n\t    \t\t            activas: true,\n\t    \t\t            visibilitats: true,\n\t    \t\t            order: controlCapes._lastZIndex+1,\n\t    \t\t            epsg: '4326',\n\t    \t\t            transparency: true,\n\t    \t\t            visibilitat: visibilitat_open,\n\t    \t\t\t\t\toptions: '{\"dataset\":\"'+dataset+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\t\t\t\n\t    \t\t\t\t};\n\t    \t\t\t\t\n\t    \t\t\t\tcreateServidorInMap(data).then(function(results){\n\t    \t\t\t\t\tif (results.status == \"OK\"){\n\t    \t\t\t\t\t\tcapaDadaOberta.nom = nom_dataset;// +\" (\"+datasetLength+\")\";\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\tcapaDadaOberta.options={\"dataset\":dataset,\n\t    \t\t\t\t\t\t\t\t\"estil_do\":{\"radius\":estil_do.radius,\n\t    \t\t\t\t\t\t\t\t\t\"fillColor\":estil_do.fillColor,\n\t    \t\t\t\t\t\t\t\t\t\"color\":estil_do.color,\n\t    \t\t\t\t\t\t\t\t\t\"weight\":estil_do.weight,\n\t    \t\t\t\t\t\t\t\t\t\"opacity\":estil_do.opacity,\n\t    \t\t\t\t\t\t\t\t\t\"fillOpacity\":estil_do.fillOpacity,\n\t    \t\t\t\t\t\t\t\t\t\"isCanvas\":estil_do.isCanvas}};\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\tcapaDadaOberta.options.businessId = results.results.businessId;\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex+1;\n\t    \t\t\t\t\t\tcapaDadaOberta.options.tipus= t_dades_obertes;\n\t    \t\t\t\t\t\tcapaDadaOberta.options.nom = nom_dataset;\n\t    \t\t\t\t\t\tcapaDadaOberta.addTo(map)\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, nom_dataset, true);\n\t    \t\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t    \t\t\t\t\t\tactivaPanelCapes(true);\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t}\n\t    \t\t\t\t});\n\t    \t\t\t}else{\n\t    \t\t\t\tcapaDadaOberta.nom = nom_dataset;// +\" (\"+datasetLength+\")\";\n\t    \t\t\t\tcapaDadaOberta.addTo(map);\n\t    \t\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex+1;\n\t    \t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, nom_dataset, true);\n\t    \t\t\t\tcontrolCapes._lastZIndex++;\n\t    \t\t\t\tactivaPanelCapes(true);\n\t    \t\t\t}\t\n            \t}\n            }\n        }\n\t});\n}\n\nfunction loadDadesObertesLayer(layer){\n\t\n\tvar defer = $.Deferred();\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\tif(options.tem == null || options.tem == tem_simple){\n\t\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\n\t\tvar estil_do = options.estil_do;\n\t\t\n\t\tif (options.tem == tem_simple){\n\t\t\testil_do = createFeatureMarkerStyle(options.style);\n\t\t}\n\t\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\n\t\t\tonEachFeature : createPopupWindowDadesObertes,\n\t\t\tnom : layer.serverName,\n\t\t\ttipus : layer.serverType,\n\t\t\tdataset: options.dataset,\n\t\t\tbusinessId : layer.businessId,\n\t\t\tdataType : \"jsonp\",\n\t\t\testil_do : estil_do, //per la llegenda\n\t\t\tpointToLayer : function(feature, latlng) {\n\t\t\t\tif(options.dataset.indexOf('meteo')!=-1){\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t\t\t    iconUrl: feature.style.iconUrl,\n\t\t\t\t\t\t    iconSize:     [44, 44], \n\t\t\t\t\t\t    iconAnchor:   [22, 22], \t\t\t\t   \n\t\t\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t\t\t})});\n\t\t\t\t}else if(options.dataset.indexOf('incidencies')!=-1){\n\t\t\t\t\tvar inci=feature.properties.descripcio_tipus;\n\t\t\t\t\tvar arr = [\"Obres\", \"Retenció\", \"Cons\", \"Meterologia\" ];\n\t\t\t\t\tvar arrIM = [\"st_obre.png\", \"st_rete.png\", \"st_cons.png\", \"st_mete.png\" ];\n\t\t\t\t\tvar imgInci=\"/geocatweb/img/\"+arrIM[jQuery.inArray( inci, arr )];\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t\t    iconUrl: imgInci,\n\t\t\t\t\t    iconSize:     [30, 26], \n\t\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \n\t\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t\t\t})});\n\t\t\t\t}else if(options.dataset.indexOf('cameres')!=-1){\n\t\t\t\t\treturn L.marker(latlng, {icon:L.icon({\t\t\t\t\t\n\t\t\t\t\t    iconUrl: \"/geocatweb/img/st_came.png\",\n\t\t\t\t\t    iconSize:     [30, 26], \n\t\t\t\t\t    iconAnchor:   [15, 13], \t\t\t\t   \n\t\t\t\t\t    popupAnchor:  [-3, -3] \n\t\t\t\t\t})});\n\t\t\t\t}else{\n\t\t\t\t\tif (estil_do.isCanvas){\n\t\t\t\t\t\treturn L.circleMarker(latlng, estil_do);\n\t\t\t\t\t}else{\n\t\t\t\t\t\treturn L.marker(latlng, {icon:estil_do,isCanvas:false, tipus: t_marker});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\t\n\t\t\n\t\t\n\t\t//afegim group\n\t\tif (options.group){\n\t\t\tcapaDadaOberta.options.group=options.group;\n\t\t}\n\t\t\n\t\t\n\t\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tcapaDadaOberta.addTo(map);\n\t\t}\n\t\t\t\t\n\t\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\n\t\t\tcapaDadaOberta.options.zIndex = controlCapes._lastZIndex + 1;\n\t\t}else{\n\t\t\tcapaDadaOberta.options.zIndex = parseInt(layer.capesOrdre);\n\t\t}\t\t\n\t\t\n\t\tif(!options.origen){\n\t\t\t//Fins que no estigui carregada del tot no afegim al controlcapes (per tenir be el comptador de features)\n\t\t\tcapaDadaOberta.on('data:loaded', function(e){\n\t\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tdefer.resolve();\n\t\t\t});\n\t\t}else{//Si te origen es una sublayer\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\t\tcapaDadaOberta.options.zIndex = capesOrdre_sublayer;\n\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true, origen);\n\t\t\tdefer.resolve();\n\t\t}\t\t\n\t\t\n\t}else if(options.tem == tem_cluster){\n\t\tloadDadesObertesClusterLayer(layer,defer);\n\t}else if(options.tem == tem_heatmap){\n\t\tloadDOHeatmapLayer(layer,defer);\n\t}\n\treturn defer.promise();\n}\n\nfunction createPopupWindowDadesObertes(player,l){\n\t//console.debug(\"createPopupWindowData\");\n\tvar html='';\n\tvar out = [];\n\tif (player.properties.nom && !isBusinessId(player.properties.nom)){\n\t\thtml+='<h4>'+player.properties.nom+'</h4>';\n\t}else if(player.properties.name && !isBusinessId(player.properties.name)){\n\t\thtml+='<h4>'+player.properties.name+'</h4>';\n\t}else if(player.properties.Name && !isBusinessId(player.properties.Name)){\n\t\thtml+='<h4>'+player.properties.Name+'</h4>';\n\t}\n\tif (player.properties.description){\n\t\tif (!$.isNumeric(player.properties.description) && !validateWkt(player.properties.description)) html+='<div>'+parseUrlTextPopUp(player.properties.description)+'</div>';\n\t\telse html+='<div>'+player.properties.description+'</div>';\n\t}\n\thtml+='<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\tvar pp = player.properties;\n\n\t$.each( pp, function( key, value ) {\n\t\tif(isValidValue(value) && !validateWkt(value)){\n\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50'){\n\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\tvar txt = value;\n\t\t\t\tif (!$.isNumeric(txt)) {\n\t\t\t\t\ttxt = parseUrlTextPopUp(value,key);\t\t\t\t\n\t\t\t\t\n\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t}else{\n\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t}\n\t\t\t\thtml+= '</div>';\n\t\t\t}\n\t\t}\n\t});\t\n\t\n\thtml+='</div></div>';\n\tl.bindPopup(html,{'offset':[0,-25]});\n}","//var _htmlServeisJSON = [];\n//\n//_htmlServeisJSON.push('<div class=\"panel-success\"><div panel-heading\">');\n//\n//_htmlServeisJSON.push('<div class=\"input-group txt_ext\"><input type=\"text\" lang=\"ca\" id=\"txt_URLJSON\" style=\"height:33px\" placeholder=\"Entrar URL servei JSON\" value=\"\" class=\"form-control\">');\n//_htmlServeisJSON.push('<span class=\"input-group-btn\"><button class=\"btn btn-success\" id=\"bt_connJSON\"  type=\"button\"><span class=\"glyphicon glyphicon-play\"></span></button></span>');\n//\n////_htmlServeisJSON.push('<div class=\"small\"\n//\n////http://www.president.cat/pres_gov/dades/president/actes-territori-ca.json?\n//\n//_htmlServeisJSON.push('</div>');\n//_htmlServeisJSON.push('</div>');\n//_htmlServeisJSON.push('<div style=\"height:230px;overflow:auto\" id=\"div_layersJSON\"  class=\"tbl\"></div>');\n//_htmlServeisJSON.push('<div id=\"div_emptyJSON\" style=\"height: 35px;margin-top: 2px\"></div>');\n\nvar respostaJSON;\nvar urlJSON;\nfunction getServeiJSONP(purlJson) {\n\turlJSON = purlJson;\n\tjQuery(\"#txt_URLJSON\");\n\tvar _htmlJSONFields = [];\n\n\n\n\t\tgetJSONPServei(purlJson).then(function(results) {\n\t\t\t\t\t\t\tvar op = [];\n\t\t\t\t\t\t\tif (jQuery.isArray(results)) {\n\t\t\t\t\t\t\t\trespostaJSON = results;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfor (key in results) {\n\t\t\t\t\t\t\t\t\tif (jQuery.isArray(results[key])) {\n\t\t\t\t\t\t\t\t\t\trespostaJSON = results[key];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(purlJson.indexOf(paramUrl.presidentJSON)!= -1){\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tcreaCapaFromJSON(1);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (!jQuery.isArray(respostaJSON)) {\n\t\t\t\t\t\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\top.push(\"<option value='null'>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Selecciona un camp')\n\t\t\t\t\t\t\t\t\t+ \"</option>\");\n\t\t\t\t\t\t\tfor (key in respostaJSON[0]) {\n\t\t\t\t\t\t\t\top.push(\"<option value=\" + key + \">\" + key\n\t\t\t\t\t\t\t\t\t\t+ \"</option>\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//jQuery('#div_layersJSON').removeClass('waiting_animation');\n\t\t\t\t\t\t\tjQuery('#div_layersJSON').empty();\n\t\t\t\t\t\t\tjQuery('#div_emptyJSON').empty();\n\n\t\t\t\t\t\t\t_htmlJSONFields.push('<ul class=\"bs-dadesO_JSON\">');\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><label>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Camps necessaris')\n\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><label>\"\n\t\t\t\t\t\t\t\t\t\t\t+ window.lang\n\t\t\t\t\t\t\t\t\t\t\t\t\t.convert('Selecciona el camp corresponent')\n\t\t\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t\t\t+ window.lang.translate('Coordenada X o Longitud')\n\t\t\t\t\t\t\t\t\t\t\t+ \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_x'>\"\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Coordenada Y o Latitud') + \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><select id='cmd_json_y'>\"\n\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li><label>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Opcionals')\n\t\t\t\t\t\t\t\t\t+ \"</label></li>\");\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Títol') + \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_titol'>\"\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Descripció')\n\t\t\t\t\t\t\t\t\t+ \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_desc'>\"\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Imatge') + \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><select  id='cmd_json_img'>\"\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push(\"<li>\"\n\t\t\t\t\t\t\t\t\t+ window.lang.translate('Vincle') + \"</li>\");\n\t\t\t\t\t\t\t_htmlJSONFields\n\t\t\t\t\t\t\t\t\t.push(\"<li><select id='cmd_json_vin'>\"\n\t\t\t\t\t\t\t\t\t\t\t+ op.join(\" \") + \"</select></li>\");\n\n\t\t\t\t\t\t\t_htmlJSONFields.push('</ul>');\n\n\t\t\t\t\t\t\tjQuery('#div_layersJSON').html(\n\t\t\t\t\t\t\t\t\t_htmlJSONFields.join(\" \"));\n\t\t\t\t\t\t\tjQuery('#div_emptyJSON')\n\t\t\t\t\t\t\t\t\t.html(\n\t\t\t\t\t\t\t\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" id=\"bt_addJSON\" class=\"btn btn-success\" >'\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ window.lang\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.convert(\"Mapificar\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ '</button></div>');\n\n\t\t\t\t\t\t\t$('#cmd_json_x option:contains(\"long\")').prop(\n\t\t\t\t\t\t\t\t\t'selected', true);\n\t\t\t\t\t\t\t$('#cmd_json_x option:contains(\"lng\")').prop(\n\t\t\t\t\t\t\t\t\t'selected', true);\n\n\t\t\t\t\t\t\t$('#cmd_json_y option:contains(\"latitu\")').prop(\n\t\t\t\t\t\t\t\t\t'selected', true);\n\t\t\t\t\t\t\t$('#cmd_json_y option:contains(\"lat\")').prop(\n\t\t\t\t\t\t\t\t\t'selected', true);\n\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\n\t\tjQuery(document).on('click', \"#bt_addJSON\", function(e) {\n\t\t\tcreaCapaFromJSON(0);\n\t\t});\t\t\n\t\t\n\n//\t} else {\n//\n//\t\talert(window.lang.translate(\"La URL no sembla vàlida\"));\n//\t\treturn;\n//\t}\n}\n\n\n\nfunction creaCapaFromJSON(directe) {\n\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'dades externes', urlJSON, 1]});\n\t\n\tvar cmd_json_x = \"longitude\";\n\t\t\tvar cmd_json_y = \"latitude\";\n\t\t\tvar cmd_json_titol =\"titular\";\n\t\t\tvar cmd_json_desc = \"municipio\";\n\t\t\tvar cmd_json_img = \"imagen\";\n\t\t\tvar cmd_json_vin = \"url\";\n\t\n\t\n\tif(directe!=1){\n\t\tcmd_json_x = jQuery('#cmd_json_x').val();\n\t\tcmd_json_y = jQuery('#cmd_json_y').val();\n\t\tcmd_json_titol = jQuery('#cmd_json_titol').val();\n\t\tcmd_json_desc = jQuery('#cmd_json_desc').val();\n\t\tcmd_json_img = jQuery('#cmd_json_img').val();\n\t\tcmd_json_vin = jQuery('#cmd_json_vin').val();\t\n\t}\n\t\n\tif ((cmd_json_x == \"null\") || (cmd_json_y == \"null\")) {\n\n\t\talert(window.lang.translate(\"Els camps de coordenades no poden estar buits\"));\n\t\treturn;\n\n\t} else {\n\n\t\t//nom per defecte agafat de la url del json a mostrar\n\t\tvar paraules = urlJSON.split(\"/\");\n\t\tvar paraula = paraules[paraules.length-1].split(\".\");\n\t\tvar nomCapaJson = paraula[0];\n\t\tif(!nomCapaJson) nomCapaJson = 'Capa JSON';\n\t\t\n\t\tvar capaJSON = new L.FeatureGroup();\n\t\tcapaJSON.options = {\n\t\t\tbusinessId : -1,\n\t\t\tnom : nomCapaJson,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\n\t\t\ttipus:t_json,\n\t\t\turl: urlJSON\n//\t\t\tzIndex : controlCapes._lastZIndex// + 1\n\t\t};\n\t\t\n\t\tvar param_estil = 'json';\n\t\tif(urlJSON.indexOf(\"president\")!=-1) param_estil = 'json_president';\n\t\tvar estil_do = retornaEstilaDO(param_estil);\n\t\t\n\t\tif(typeof url('?businessid') == \"string\"){\n\t\t\tvar data = {\n\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\tserverName: nomCapaJson,//+' '+ (parseInt(controlCapes._lastZIndex) + 1),\n\t\t\t\tserverType: t_json,\n\t\t\t\tcalentas: false,\n\t            activas: true,\n\t            visibilitats: true,\n\t            order: controlCapes._lastZIndex+1,\n\t            epsg: '4326',\n\t            imgFormat: 'image/png',\n\t            infFormat: 'text/html',\n\t            tiles: true,\t            \n\t            transparency: true,\n\t            opacity: 1,\n\t            visibilitat: 'O',\n\t            url: urlJSON,//Provar jQuery(\"#txt_URLJSON\")\n\t            calentas: false,\n\t            activas: true,\n\t            visibilitats: true,\n\t            options: '{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\n\t\t\t};\n\t\t\t\n\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\n\t\t\t\t\tfor (key in respostaJSON) {\n\t\t\t\t\t\tvar lat = respostaJSON[key][cmd_json_y];\n\t\t\t\t\t\tvar lon = respostaJSON[key][cmd_json_x];\n\t\t\t\t\t\tpp = L.circleMarker([ lat, lon ], estil_do)\n\n\t\t\t\t\t\tpp.properties = {};\n\t\t\t\t\t\tvar empty = true;\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (cmd_json_titol == \"null\") {\n\t\t\t\t\t\t\tpp.properties.nom = \"\"\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpp.properties.nom = respostaJSON[key][cmd_json_titol];\n\t\t\t\t\t\t\tempty = empty && false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (cmd_json_desc == \"null\") {\n\t\t\t\t\t\t\tpp.properties.text = \"\"\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpp.properties.text = respostaJSON[key][cmd_json_desc];\n\t\t\t\t\t\t\tempty = empty && false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (cmd_json_img == \"null\") {\n\t\t\t\t\t\t\tpp.properties.img = \"\"\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_img] + '\">';\n\t\t\t\t\t\t\tempty = empty && false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (cmd_json_vin == \"null\") {\n\t\t\t\t\t\t\tpp.properties.vincle = \"\"\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpp.properties.vincle = '<a href=\"'\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_vin]\n\t\t\t\t\t\t\t\t\t+ '\" target=\"_blank\">'\n\t\t\t\t\t\t\t\t\t+ respostaJSON[key][cmd_json_vin] + '</a>';\n\t\t\t\t\t\t\tempty = empty && false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(!empty){\n\t\t\t\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div>\"\n\t\t\t\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\n\t\t\t\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\n\t\t\t\t\t\t\t\t\t+ \"</div>\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpp.addTo(capaJSON);\n\t\t\t\t\t}\n\n//\t\t\t\t\tjQuery('#dialog_dades_ex').modal('toggle');\n\t\t\t\t\tjQuery('#dialog_dades_ex').modal('hide');\t\n\t\t\t\t\tcapaJSON.options.businessId = results.results.businessId;\n\t\t\t\t\tcapaJSON.options.options = jQuery.parseJSON('{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\"}');\n\t\t\t\t\tcapaJSON.options.options.estil_do = estil_do;\n\t\t\t\t\tcapaJSON.addTo(map);\n\t\t\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex+1; \n\t\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\n\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\tactivaPanelCapes(true);\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\n//\t\t\t\t\t\t   advanced:{\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\n//\t\t\t\t\t\t     updateOnContentResize: true\n//\t\t\t\t\t\t   }           \n//\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t}else{\n\t\t\tcapaJSON.addTo(map)\n\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex+1; \n\t\t\tcapaJSON.options.options = jQuery.parseJSON('{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\"}');\n\t\t\tcapaJSON.options.options.estil_do = estil_do;\n\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\n\t\t\tcontrolCapes._lastZIndex++;\n\t\t\tactivaPanelCapes(true);\n//\t\t\t$(\".layers-list\").mCustomScrollbar({\n//\t\t\t\t   advanced:{\n//\t\t\t\t     autoScrollOnFocus: false,\n//\t\t\t\t     updateOnContentResize: true\n//\t\t\t\t   }           \n//\t\t\t});\t\n\t\t}\t\t\n\t}\n\t\n\t//Buidem dialeg creacio capa JSON\n//\tjQuery('#div_layersJSON').empty();\n//\tjQuery('#txt_URLJSON').val('');\t\n\tjQuery('#div_url_file').empty();\n\tjQuery('#txt_URLfile').val('');\t\t\n}\n\nfunction loadCapaFromJSON(layer) {\n\n\tvar defer = $.Deferred();\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\t\n\tif(options.tem == tem_heatmap){\n\t\tloadJsonHeatmapLayer(layer);\n\t\treturn defer.resolve();\n\t}else if(options.tem == tem_cluster){\n\t\tloadJsonClusterLayer(layer);\n\t\treturn defer.resolve();\n\t}else{\t\n\t\tvar v_respotaJSON;\n\t\tgetJSONPServei(layer.url).then(function(results) {\n\t\t\tvar op = [];\n\t\t\tif (jQuery.isArray(results)) {\n\t\t\t\tv_respotaJSON = results;\n\t\t\t} else {\n\t\t\t\tfor (key in results) {\n\t\t\t\t\tif (jQuery.isArray(results[key])) {\n\t\t\t\t\t\tv_respotaJSON = results[key];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\n\t\t\tif (!jQuery.isArray(v_respotaJSON)) {\n\t\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tvar capaJSON = new L.FeatureGroup();\n\t\t\tcapaJSON.options = {\n\t\t\t\tbusinessId : layer.businessId,\n\t\t\t\tnom : layer.serverName,\n\t\t\t\ttipus:layer.serverType,\n\t\t\t\tzIndex : layer.capesOrdre,\n\t\t\t\turl: layer.url,\n\t\t\t\toptions: options\n\t\t\t};\t\t\n\t\t\t\n\t\t\tif (options.group){\n\t\t\t\tcapaJSON.options.group=options.group;\n\t\t\t}\n\t\t\t\n//\t\t\tvar options = jQuery.parseJSON( layer.options );\n\t//\t\tvar estil_do = retornaEstilaDO('json');\n\t\t\tvar estil_do = options.estil_do;\n\t\t\t\n\t\t\tfor (key in v_respotaJSON) {\n\t\t\t\tvar lat = v_respotaJSON[key][options.y];\n\t\t\t\tvar lon = v_respotaJSON[key][options.x];\n\t\t\t\tvar pp = L.circleMarker([ lat, lon ], estil_do)\n\t\n\t\t\t\tpp.properties = {};\n\t\t\t\tvar empty = true;\n\t\t\t\t\n\t\t\t\tif (options.titol == \"null\") {\n\t\t\t\t\tpp.properties.nom = \"\"\n\t\t\t\t} else {\n\t\t\t\t\tpp.properties.nom = v_respotaJSON[key][options.titol];\n\t\t\t\t\tempty = empty && false;\n\t\t\t\t}\n\t\t\t\tif (options.descripcio == \"null\") {\n\t\t\t\t\tpp.properties.text = \"\"\n\t\t\t\t} else {\n\t\t\t\t\tpp.properties.text = v_respotaJSON[key][options.descripcio];\n\t\t\t\t\tempty = empty && false;\n\t\t\t\t}\n\t\t\t\tif (options.imatge == \"null\") {\n\t\t\t\t\tpp.properties.img = \"\"\n\t\t\t\t} else {\n\t\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.imatge] + '\">';\n\t\t\t\t\tempty = empty && false;\n\t\t\t\t}\n\t\t\t\tif (options.vincle == \"null\") {\n\t\t\t\t\tpp.properties.vincle = \"\"\n\t\t\t\t} else {\n\t\t\t\t\tpp.properties.vincle = '<a href=\"'\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle]\n\t\t\t\t\t\t\t+ '\" target=\"_blank\">'\n\t\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle] + '</a>';\n\t\t\t\t\tempty = empty && false;\n\t\t\t\t}\n\t\n\t\t\t\tif(!empty){\n\t\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div id='text-popup-json'>\"\n\t\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\n\t\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\n\t\t\t\t\t\t\t+ \"</div>\");\n\t\t\t\t}\n\t\t\t\tpp.addTo(capaJSON);\n\t\t\t}\n\t\n\t\t\tcapaJSON.options.businessId = layer.businessId;\n\t\t\t\n\t\t\tif (layer.capesActiva== null || layer.capesActiva == 'null' || layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\t\tcapaJSON.addTo(map)\n\t\t\t}\t\t\n\t\t\t\n\t\t\tif (!layer.capesOrdre || layer.capesOrdre == null || layer.capesOrdre == 'null'){\n\t\t\t\tcapaJSON.options.zIndex = controlCapes._lastZIndex + 1;\n\t\t\t}else{\n\t\t\t\tcapaJSON.options.zIndex = parseInt(layer.capesOrdre);\n\t\t\t}\t\t\t\n\t\t\t\t\n//\t\t\tcontrolCapes.addOverlay(capaDadaOberta, layer.serverName, true);\t\n//\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\n\t\t\tif(!options.origen){\n\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true);\n\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t}else{//Si te origen es una sublayer\n\t\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\t\t\tcapaJSON.options.zIndex = capesOrdre_sublayer;\n\t\t\t\tcontrolCapes.addOverlay(capaJSON, capaJSON.options.nom, true, origen);\n\t\t\t}\t\t\t\n\t\t\t\n\t\t\tactivaPanelCapes(true);\t\n\t\t\treturn defer.resolve();\n\t\t},function(results){\n\t\t\talert(window.lang.translate(\"No s'ha interpretar l'estructura del JSON\"));\n\t\t\treturn defer.reject();\t\t\n\t\t});\n\t}\n\treturn defer.promise();\n}\n","\nfunction createHeatMap(capa,tipus){\n\t\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'heatmap', 1]});\n\t\n\tvar nom = window.lang.translate(\"Concentració\");\n\t//Heatmap\n\tif (tipus == t_vis_wms){\n\t\tvar instamapsWms = InstamapsWms({\n\t\t\tloadTemplateParam :false});\n\t\tvar dataWMS = {url: capa.layer._url};\n\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\t\tvar layers = [];\n\t\t\tlayers=results.Capability.Layer.Layer;\n\t\t\tfor (var i=0;i<layers.length;i++){\n\t\t\t\tvar layer = layers[i];\n\t\t\t\tif (layers[i].Name.indexOf(\"heatmap\")>-1) {\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t            nom: layers[i].Name,//nom nombre de la nueva visualizacion\n\t\t\t\t            activas: true,\n\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\t\t\ttem: tem_heatmap,\n\t\t\t\t\t\t\tserverType: tem_heatmap_wms,//tem_heatmap\n\t\t\t\t\t\t\turl: capa.layer._url\n//\t\t\t\t            estils: JSON.stringify(rangs[0])\n\t\t\t\t\t};\n\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\n\t\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(results.layer);\t\t\t\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", false );\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\n\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\n\t\t\t\t\t\t\tactivaPanelCapes(true);\t\n\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t},function(results){\n\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\telse {\n\t\t\tvar arrP=[];\n\t\t\t\n\t\t\tcapa.layer.eachLayer(function(layer){\n\t\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\n\t\t\t\tarrP.push(d);\t\t\t\n\t\t\t});\n\t\t\t\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\t\t\tgradient: {\t\t\t\n\t\t\t\t\t0.35: \"#070751\",\n\t\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t\t1: \"#720404\"\n\t\t\t\t\t}\t\n\t\t\t});\n\t\t\t\n\t\t\tif(typeof url('?businessid') == \"string\"){\n\t\t\t\t//Si capa origen dades obertes, creem nova capa\n\t\t\t\tif(capa.layer.options.tipus == t_dades_obertes){\n\t\t\t\t\tdata = {\n\t\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n\t\t\t\t\t\t\tserverType: t_dades_obertes,\n\t\t\t\t\t\t\tcalentas: false,\n\t\t\t\t            activas: true,\n\t\t\t\t            order: capesOrdre_sublayer,\n\t\t\t\t            visibilitats: true,\n\t\t\t\t            epsg: '4326',\n\t\t\t\t            imgFormat: 'image/png',\n\t\t\t\t            infFormat: 'text/html',\n\t\t\t\t            tiles: true,\t            \n\t\t\t\t            transparency: true,\n\t\t\t\t            opacity: 1,\n\t\t\t\t            visibilitat: 'O',\n\t\t\t\t            options: '{\"dataset\":\"'+capa.layer.options.dataset+'\",\"tem\":\"'+tem_heatmap+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\n\t\t\t\t\t};\t\n\t\t\t\t\t\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_dades_obertes;\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.debug('error create server in map');\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t});\t\t\t\t\n\t\t\t\t\n\t\t\t\t//tipus json \n\t\t\t\t}else if(capa.layer.options.tipus == t_json){\n\t\t\t\t\t\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n\t\t\t\t\t\tserverType: t_json,\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t\t    activas: true,\n\t\t\t\t\t    visibilitats: true,\n\t\t\t\t\t    order: capesOrdre_sublayer,\n\t\t\t\t\t    epsg: '4326',\n\t\t\t\t\t    imgFormat: 'image/png',\n\t\t\t\t\t    infFormat: 'text/html',\n\t\t\t\t\t    tiles: true,\t            \n\t\t\t\t\t    transparency: true,\n\t\t\t\t\t    opacity: 1,\n\t\t\t\t\t    visibilitat: 'O',\n\t\t\t\t\t    url: capa.layer.options.url,\n\t\t\t\t\t    calentas: false,\n\t\t\t\t\t    activas: true,\n\t\t\t\t\t    visibilitats: true,\n\t\t\t\t\t    options: '{\"x\":\"'+capa.layer.options.options.x+'\", \"y\":\"'+capa.layer.options.options.y+'\",\"tem\":\"'+tem_heatmap+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\n\t\t//\t\t\t    options: '{\"x\":\"'+cmd_json_x+'\", \"y\":\"'+cmd_json_y+'\",\"titol\":\"'+cmd_json_titol+'\",\"descripcio\":\"'+cmd_json_desc+'\", \"imatge\":\"'+cmd_json_img+'\",\"vincle\":\"'+cmd_json_vin+'\",\"estil_do\":{\"radius\":\"'+estil_do.radius+'\",\"fillColor\":\"'+estil_do.fillColor+'\",\"color\":\"'+estil_do.color+'\",\"weight\":\"'+estil_do.weight+'\",\"opacity\":\"'+estil_do.opacity+'\",\"fillOpacity\":\"'+estil_do.fillOpacity+'\",\"isCanvas\":\"'+estil_do.isCanvas+'\"}}'\n\t\t\t\t\t};\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_json;\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined)\t$( \"#input-\"+capa.layer.options.businessId).click();\n\t\t//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\n\t\t//\t\t\t\t\t\t   advanced:{\n\t\t//\t\t\t\t\t\t     autoScrollOnFocus: false,\n\t\t//\t\t\t\t\t\t     updateOnContentResize: true\n\t\t//\t\t\t\t\t\t   }           \n\t\t//\t\t\t\t\t});\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.debug(\"Error add heatmap JSON\");\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}else if(capa.layer.options.tipus == t_url_file){\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tvar options = {\n\t\t\t\t\t\t\turl: capa.layer.options.url,//capaMare.options.url,\n\t\t\t\t\t\t\ttem: tem_heatmap,\n\t\t\t\t\t\t\torigen: capa.layer.options.businessId,\n\t\t\t\t\t\t\ttipus : t_url_file,\n\t\t//\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\t\t\ttipusFile: capa.layer.options.tipusFile,\n\t\t//\t\t\t\t\testil_do: estil_do,\n\t\t\t\t\t\t\tepsgIN: capa.layer.options.epsgIN,\n\t\t\t\t\t\t\tgeometryType: capa.layer.options.geometryType,\n\t\t\t\t\t\t\tcolX: capa.layer.options.colX,\n\t\t\t\t\t\t\tcolY: capa.layer.options.colY,\n\t\t\t\t\t\t\tdinamic: capa.layer.options.dinamic\n\t\t\t\t\t\t};\n\t\t\t\t\t\n\t\t//\t\t\t\tconsole.debug(options);\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n\t\t//\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\t\t\tserverType: capa.layer.options.tipus,\n\t\t\t\t\t\t\tcalentas: false,\n\t\t\t\t            activas: true,\n\t\t\t\t            visibilitats: true,\n\t\t\t\t            order: capesOrdre_sublayer,\t\t\t\t\n\t\t\t\t            epsg: capa.layer.options.epsgIN,\n\t\t\t\t            imgFormat: 'image/png',\n\t\t\t\t            infFormat: 'text/html',\n\t\t//\t\t            tiles: true,\t            \n\t\t\t\t            transparency: true,\n\t\t\t\t            opacity: 1,\n\t\t\t\t            visibilitat: 'O',\n\t\t\t\t            url: capa.layer.options.url,//capaMare.options.url,\n\t\t\t\t\t\t\toptions: JSON.stringify(options)\n\t\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.results.businessId;\n\t\t\n\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\n\t\t\t\t\t\t\theatLayerActiu.options.tipus = t_url_file;\n\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tmap.addLayer(heatLayerActiu);\n\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\n\t\t//\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.debug(\"Error add heatmap URL FILE\");\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t}else if (capa.layer.options.tipus == t_visualitzacio){\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\n\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t            nom: capa.layer.options.nom+\" \"+nom,//nom nombre de la nueva visualizacion\n\t\t\t\t            activas: true,\n\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\t\t\ttem: tem_heatmap//tem_heatmap\n\t\t//\t\t            estils: JSON.stringify(rangs[0])\n\t\t\t\t\t\t};\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\n\t\t\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\theatLayerActiu.options.businessId = results.layer.businessId;\n\t\t\t\t\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\n\t\t\t\t\t\t\t\theatLayerActiu.options.tipus = capa.layer.options.tipus;\n\t\t\t\t\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\n\t\t//\t\t\t\t\t\tmap.addLayer(heatLayerActiu);Comentat per control de un heatmap actiu alhora\n\t\t\t\t\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\t\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\n\t\t//\t\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).click();\n\t\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},function(results){\n\t\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioHeat ERROR\");\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\n\t\t\t}else{\n\t\t\t\theatLayerActiu.options.businessId = -1;\n\t\t\t\theatLayerActiu.options.nom = capa.layer.options.nom+\" \"+nom;\n\t\t\t\theatLayerActiu.options.tipus = capa.layer.options.tipus;\n\t\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\t\t\n\t\t\t\tmap.addLayer(heatLayerActiu);\n\t\t\t\theatLayerActiu.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, capa.layer._leaflet_id);\n\t\t//\t\tcontrolCapes._lastZIndex++;\n\t\t\t\tactivaPanelCapes(true);\n\t\t\t}\t\n\t}\n\t\n}\n\nfunction loadDOHeatmapLayer(layer, dfd){\n\t//console.debug(layer);\n\tvar options = jQuery.parseJSON( layer.options );\n\tvar estil_do = retornaEstilaDO(options.dataset);\n\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\t\n\t\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\n\t\tonEachFeature : popUp,\n\t\tnom : layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tdataset: options.dataset,\n\t\tbusinessId : layer.businessId,\n\t\tdataType : \"jsonp\",\n\t\tzIndex: parseInt(layer.capesOrdre),\n\t\tpointToLayer : function(feature, latlng) {\n\t\t\treturn L.circleMarker(latlng, estil_do);\n\t\t}\t\n\t});\n\t\n\tcapaDadaOberta.on('data:loaded', function(e){\n\t\t//console.debug(\"data:loaded\");\n\t\t\n\t\tvar arrP=[];\n\t\tcapaDadaOberta.eachLayer(function(layer){\n\t\t\tvar d =[layer.getLatLng().lat,layer.getLatLng().lng,1];\t\n\t\t\tarrP.push(d);\t\t\t\n\t\t});\n\t\t\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\t\tgradient: {\t\t\t\n\t\t\t\t0.35: \"#070751\",\n\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t1: \"#720404\"\n\t\t\t\t}\t\n\t\t});\n\t\t\n\t\theatLayerActiu.options.businessId = layer.businessId;\n\t\theatLayerActiu.options.nom = layer.serverName;\n\t\theatLayerActiu.options.zIndex = parseInt(layer.capesOrdre);\n\t\theatLayerActiu.options.tipus = layer.serverType;\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tmap.addLayer(heatLayerActiu);\n\t\t}\n\t\t\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\n//\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t\t\n\t\tif(dfd){\n\t\t\ttry{\n\t\t\t\tdfd.resolve();\n\t\t\t}catch(e){\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t});\n}\n\nfunction loadJsonHeatmapLayer(layer){\n\tconsole.debug(\"loadJsonHeatmapLayer\");\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\n\tvar v_respotaJSON;\n\tgetJSONPServei(layer.url).then(function(results) {\n\t\tvar op = [];\n\t\tif (jQuery.isArray(results)) {\n\t\t\tv_respotaJSON = results;\n\t\t} else {\n\t\t\tfor (key in results) {\n\t\t\t\tif (jQuery.isArray(results[key])) {\n\t\t\t\t\tv_respotaJSON = results[key];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!jQuery.isArray(v_respotaJSON)) {\n\t\t\talert(window.lang.translate(\"No s'ha interpretat bé l'estructura del JSON\"));\n\t\t\treturn;\n\t\t}\n\t\tvar arrP=[];\n\t\t\n\t\tfor (key in v_respotaJSON) {\n\t\t\tvar lat = v_respotaJSON[key][options.y];\n\t\t\tvar lon = v_respotaJSON[key][options.x];\n\t\t\tvar d =[parseFloat(lat),parseFloat(lon),1];\t\n\t\t\tarrP.push(d);\n\t\t}\n\t\t\n\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\t\tgradient: {\t\t\t\n\t\t\t\t0.35: \"#070751\",\n\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t1: \"#720404\"\n\t\t\t\t}\t\n\t\t});\n\t\t\n\t\theatLayerActiu.options.businessId = layer.businessId;\n\t\theatLayerActiu.options.nom = layer.serverName;\n\t\theatLayerActiu.options.zIndex = layer.capesOrdre;\n\t\theatLayerActiu.options.tipus = layer.serverType;\n\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tmap.addLayer(heatLayerActiu);\n\t\t}\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\n\t\tactivaPanelCapes(true);\n\t\tconsole.debug(\"FI loadJsonHeatmapLayer\");\n\t});\n}\n\n\nfunction loadTematicHeatmap(layer, zIndex, layerOptions, capesActiva){\n\t\n\tvar options = jQuery.parseJSON(layerOptions);\n\t\n\tvar arrP=[];\n\t$.each(layer.geometries.features.features, function(i, feature) {\n\t\tconsole.debug(feature.geometry);\n\t\tvar d =[feature.geometry.coordinates[1],feature.geometry.coordinates[0],1];\t\n\t\tarrP.push(d);\t\t\t\n\t});\n\t\n\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\tgradient: {\t\t\t\n\t\t\t0.35: \"#070751\",\n\t\t\t0.40: \"#0095DE\",\n\t\t\t0.45: \"#02D5FF\",\n\t\t\t0.50: \"#02E0B9\",\n\t\t\t0.55: \"#00B43F\",\n\t\t\t0.60: \"#97ED0E\",\n\t\t\t0.61: \"#FFF800\",\n\t\t\t0.65: \"#FF9700\",\n\t\t\t0.70: \"#FF0101\",\n\t\t\t1: \"#720404\"\n\t\t\t}\t\n\t});\t\n\t\n\theatLayerActiu.options.businessId = layer.businessId;\n\theatLayerActiu.options.nom = layer.nom;\n\theatLayerActiu.options.zIndex = parseInt(zIndex);\n\theatLayerActiu.options.tipus = t_tematic;\n\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\n//\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n//\t\tmap.addLayer(heatLayerActiu);\n//\t}\n\t\n\tif (capesActiva.indexOf(\"false\")==-1){\n\t\tmap.addLayer(heatLayerActiu);\n\t}\n\t\n\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\n//\tcontrolCapes._lastZIndex++;\n\tactivaPanelCapes(true);\t\t\n\t\n}\n\nfunction loadVisualitzacioHeatmap(layer, zIndex, layerOptions, capesActiva, dfd){\n\t\n\t//var options = jQuery.parseJSON(layerOptions);\n\t\n\tvar options; \n\tif(typeof (layerOptions)==\"string\"){\t\n\t\ttry {\n\t\t\toptions = JSON.parse(layerOptions);\n\t\t}\n\t\tcatch (err) {\n\t\t\toptions = layerOptions;\t\t\n\t\t}\n\t}else{\t\t\t\n\t\toptions = layerOptions;\t\n\t}\n\t\n\t\n\tvar businessId;\n\tif (layer.geometriesBusinessId){\n\t\tbusinessId=layer.geometriesBusinessId\n\t}\n\telse businessId=options.origen;\n\tvar data = {\n\t\t\tbusinessId: businessId,//businessId id de la visualización de origen\n\t\t\tuid: Cookies.get('uid')//uid id de usuario\n\t\t};\t\n\t\n\t//Carrego llistat geometries\n\tgetGeometriesColleccioByBusinessId(data).then(function(results){\n\t\tif(results.status == 'OK'){\n\t\t\t\n\t\t\tvar arrP=[];\n\t\t\t$.each(results.geometries.geometria.features, function(i, feature) {\n\t\t\t\tif (feature.geometry.type==\"MultiPoint\"){\n\t\t\t\t\t$.each(feature.geometry.coordinates, function(j, coord) {\t\n\t\t\t\t\t\tvar d =[coord[1],coord[0],1];\t\n\t\t\t\t\t\tarrP.push(d);\t\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar d =[feature.geometry.coordinates[1],feature.geometry.coordinates[0],1];\t\n\t\t\t\t\tarrP.push(d);\t\t\t\t\n\t\t\t\t}\n\t\t\t});\n\t\t\t//console.debug(arrP);\n\t\t\tvar heatLayerActiu = L.heatLayer(arrP,{radius:20,blur:15,max:1,\n\t\t\t\tgradient: {\t\t\t\n\t\t\t\t\t0.35: \"#070751\",\n\t\t\t\t\t0.40: \"#0095DE\",\n\t\t\t\t\t0.45: \"#02D5FF\",\n\t\t\t\t\t0.50: \"#02E0B9\",\n\t\t\t\t\t0.55: \"#00B43F\",\n\t\t\t\t\t0.60: \"#97ED0E\",\n\t\t\t\t\t0.61: \"#FFF800\",\n\t\t\t\t\t0.65: \"#FF9700\",\n\t\t\t\t\t0.70: \"#FF0101\",\n\t\t\t\t\t1: \"#720404\"\n\t\t\t\t\t}\t\n\t\t\t});\t\n\t\t\t\n\t\t\theatLayerActiu.options.businessId = layer.businessId;\n\t\t\theatLayerActiu.options.nom = layer.nom;\n\t\t\theatLayerActiu.options.zIndex = parseInt(zIndex);\n\t\t\theatLayerActiu.options.tipus = t_visualitzacio;\n\t\t\theatLayerActiu.options.tipusRang = tem_heatmap;\n\t\t\t\n//\t\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n//\t\t\t\tmap.addLayer(heatLayerActiu);\n//\t\t\t}\n\t\t\t\n\t\t\tif (capesActiva!=undefined && capesActiva.indexOf(\"false\")==-1){\n\t\t\t\tmap.addLayer(heatLayerActiu);\n\t\t\t}\n\t\t\telse if (capesActiva==undefined) map.addLayer(heatLayerActiu);\n\t\t\t\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\t\tcontrolCapes.addOverlay(heatLayerActiu,\theatLayerActiu.options.nom, true, origen);\n//\t\t\tcontrolCapes._lastZIndex++;\n\t\t\tactivaPanelCapes(true);\n\t\t\t\n\t\t\tif(dfd){\n\t\t\t\ttry{\n\t\t\t\t\tdfd.resolve();\n\t\t\t\t}catch(e){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\t\n$.publish('analyticsEvent',{event:['error', 'getGeometriesColleccioByBusinessId']});\t\t\t\n\t\t}\n\t},function(results){\n\t\t//TODO error\n\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\n\t\t$.publish('analyticsEvent',{event:['error', 'getGeometriesColleccioByBusinessId']});\n\t});\t\n}\n\n","function creaClusterMap(capa) {\n\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'cluster', 1]});\n\n\t\n\tvar nom = window.lang.translate(\"Agrupació\");\n\t\n\tvar clusterLayer = L.markerClusterGroup({\n\t\tsingleMarkerMode : true\n\t});\n\t\n\tif(typeof url('?businessid') == \"string\"){\n\t\tvar data;\n\t\t//Si capa origen dades obertes, creem nova capa\n\t\tif(capa.layer.options.tipus == t_dades_obertes){\n\t\t\t\n\t\t\tdata = {\n\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n\t\t\t\t\tserverType: t_dades_obertes,\n\t\t\t\t\tcalentas: false,\n\t\t            activas: true,\n\t\t            visibilitats: true,\n\t\t            order: capesOrdre_sublayer,\n\t\t            epsg: '4326',\n\t\t            imgFormat: 'image/png',\n\t\t            infFormat: 'text/html',\n\t\t            tiles: true,\t            \n\t\t            transparency: true,\n\t\t            opacity: 1,\n\t\t            visibilitat: 'O',\n\t\t            calentas: false,\n\t\t            activas: true,\n\t\t            visibilitats: true,\n\t\t            options: '{\"dataset\":\"'+capa.layer.options.dataset+'\",\"tem\":\"'+tem_cluster+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\n\t\t\t};\t\n\t\t\t\n\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\n\t\t\t\t\t});\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\n\t\t\t\t\tclusterLayer.options.tipus = t_dades_obertes;\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\t\t\t\tmap.addLayer(clusterLayer);\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\n//\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\n//\t\t\t\t\t\t   advanced:{\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\n//\t\t\t\t\t\t     updateOnContentResize: true\n//\t\t\t\t\t\t   }           \n//\t\t\t\t\t});\t\t\t\t\t\t\n\n//\t\t\t\t\tmap.removeLayer(capa.layer);\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug('error create server in map');\n\t\t\t\t}\n\t\t\t});\t\t\t\t\n\t\t\t//tipus json\n\t\t}else if(capa.layer.options.tipus == t_url_file){\n\t\t\t\n\t\t\t\n\t\t\tvar options = {\n\t\t\t\t\turl: capa.layer.options.url,//capaMare.options.url,\n\t\t\t\t\ttem: tem_cluster,\n\t\t\t\t\torigen: capa.layer.options.businessId,\n\t\t\t\t\ttipus : t_url_file,\n//\t\t\t\t\tbusinessId : '-1',\n\t\t\t\t\ttipusFile: capa.layer.options.tipusFile,\n//\t\t\t\t\testil_do: estil_do,\n\t\t\t\t\tepsgIN: capa.layer.options.epsgIN,\n\t\t\t\t\tgeometryType: capa.layer.options.geometryType,\n\t\t\t\t\tcolX: capa.layer.options.colX,\n\t\t\t\t\tcolY: capa.layer.options.colY,\n\t\t\t\t\tdinamic: capa.layer.options.dinamic\n\t\t\t\t};\n\t\t\t\n//\t\t\t\tconsole.debug(options);\t\t\t\n\t\t\t\n\t\t\tvar data = {\n\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n//\t\t\t\t\tserverName: capa.layer.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\tserverType: capa.layer.options.tipus,\n\t\t\t\t\tcalentas: false,\n\t\t            activas: true,\n\t\t            visibilitats: true,\n\t\t            order: capesOrdre_sublayer,\t\t\t\t\n\t\t            epsg: capa.layer.options.epsgIN,\n\t\t            imgFormat: 'image/png',\n\t\t            infFormat: 'text/html',\n//\t\t            tiles: true,\t            \n\t\t            transparency: true,\n\t\t            opacity: 1,\n\t\t            visibilitat: 'O',\n\t\t            url: capa.layer.options.url,//capaMare.options.url,\n\t\t\t\t\toptions: JSON.stringify(options)\n\t\t\t\t};\n\t\t\t\n\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\n\t\t\t\t\t});\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\n\t\t\t\t\tclusterLayer.options.tipus = t_url_file;\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\t\t\t\tmap.addLayer(clusterLayer);\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\n\n\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug('error create server in map');\n\t\t\t\t}\n\t\t\t});\t\t\t\t\n\t\t\t//tipus json\n\t\t}else if(capa.layer.options.tipus == t_json){\n\t\t\t\n\t\t\tvar data = {\n\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\tserverName: capa.layer.options.nom+\" \"+nom,\n\t\t\t\tserverType: t_json,\n\t\t\t\tcalentas: false,\n\t\t\t    activas: true,\n\t\t\t    visibilitats: true,\n\t\t\t    order: capesOrdre_sublayer,\n\t\t\t    epsg: '4326',\n\t\t\t    imgFormat: 'image/png',\n\t\t\t    infFormat: 'text/html',\n\t\t\t    tiles: true,\t            \n\t\t\t    transparency: true,\n\t\t\t    opacity: 1,\n\t\t\t    visibilitat: 'O',\n\t\t\t    url: capa.layer.options.url,\n\t\t\t    calentas: false,\n\t\t\t    activas: true,\n\t\t\t    visibilitats: true,\n\t\t\t    options: '{\"x\":\"'+capa.layer.options.options.x+'\", \"y\":\"'+capa.layer.options.options.y+'\",\"titol\":\"'+capa.layer.options.options.titol+'\",\"descripcio\":\"'+capa.layer.options.options.descripcio+'\", \"imatge\":\"'+capa.layer.options.options.imatge+'\",\"vincle\":\"'+capa.layer.options.options.vincle+'\",\"tem\":\"'+tem_cluster+'\",\"origen\":\"'+capa.layer.options.businessId+'\"}'\n\t\t\t};\t\t\t\n\t\t\t\n\t\t\tcreateServidorInMap(data).then(function(results){\n\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\n\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\t\t\t\ttitle : layer._leaflet_id\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmarker.bindPopup(layer._popup._content);\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\n\t\t\t\t\t});\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tclusterLayer.options.businessId = results.results.businessId;\n\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\n\t\t\t\t\tclusterLayer.options.tipus = t_json;\n\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\t\t\t\tmap.addLayer(clusterLayer);\n\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer;//controlCapes._lastZIndex + 1;\n\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\n//\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n//\t\t\t\t\t$(\".layers-list\").mCustomScrollbar({\n//\t\t\t\t\t\t   advanced:{\n//\t\t\t\t\t\t     autoScrollOnFocus: false,\n//\t\t\t\t\t\t     updateOnContentResize: true\n//\t\t\t\t\t\t   }           \n//\t\t\t\t\t});\t\n\n//\t\t\t\t\tmap.removeLayer(capa.layer);\n\t\t\t\t}else{\n\t\t\t\t\tconsole.debug(\"Error add cluster JSON\");\n\t\t\t\t}\n\t\t\t});\t\n\n\t\t}else if (capa.layer.options.tipus == t_visualitzacio){\n\t\t\tvar data = {\n\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\n\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t            nom: capa.layer.options.nom+\" \"+nom,//nom nombre de la nueva visualizacion\n\t\t            activas: true,\n\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\ttem: tem_cluster//tem_heatmap\n//\t\t            estils: JSON.stringify(rangs[0])\n\t\t\t\t};\t\n\t\t\t\t\n\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\n\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\n\t\t\t\t\t\tcapa.layer.eachLayer(function(layer) {\n\t\t\t\t\t\t\tconsole.debug(layer);\n\t\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\t\t\t\t\ttitle : layer._leaflet_id\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tvar html='';\n\t\t\t\t\t\t\t$.each( layer.properties.data, function( key, value ) {\n\t\t\t\t\t\t\t\tif(isValidValue(key) && isValidValue(value) && !validateWkt(value)){\n\t\t\t\t\t\t\t\t\tif (key != 'id' && key != 'businessId' && key != 'slotd50' && \n\t\t\t\t\t\t\t\t\t\t\tkey != 'NOM' && key != 'Nom' && key != 'nom' && \n\t\t\t\t\t\t\t\t\t\t\tkey != 'name' && key != 'Name' && key != 'NAME' &&\n\t\t\t\t\t\t\t\t\t\t\tkey != 'nombre' && key != 'Nombre' && key != 'NOMBRE'){\n\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\t\t\t\tif (!$.isNumeric(txt)) {\n\t\t\t\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\n\t\t\t\t\t\t\t\t\t\t\tif(txt.indexOf(\"iframe\")==-1 && txt.indexOf(\"img\")==-1){\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+\n\t\t\t\t\t\t\t\t\t\t\t\t(isBlank(txt)?window.lang.translate(\"Sense valor\"):txt)+\n\t\t\t\t\t\t\t\t\t\t\t\t'</div>';\n\t\t\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_img_iframe\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_key\">'+key+'</div>';\n\t\t\t\t\t\t\t\t\t\t\thtml+='<div class=\"popup_data_value\">'+txt+'</div>';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\thtml+= '</div>';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tmarker.bindPopup(html);\n\t\t\t\t\t\t\t//marker.bindPopup(\"<b>\"+layer.properties.data.nom+\"</b><br><b>\"+layer.properties.data.text+\"</b>\");\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tclusterLayer.addLayer(marker);\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tclusterLayer.options.businessId = results.layer.businessId;\n\t\t\t\t\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\n\t\t\t\t\t\tclusterLayer.options.tipus = capa.layer.options.tipus;\n\t\t\t\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\t\t\t\t\t\t\n\t\t\t\t\t\tmap.addLayer(clusterLayer);\n\t\t\t\t\t\tclusterLayer.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex+1;\n\t\t\t\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\n//\t\t\t\t\t\tcontrolCapes._lastZIndex++;\n\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t},function(results){\n\t\t\t\t\t//TODO error\n\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\n\t\t\t\t});\t\t\t\n\t\t}\n\t\telse if (capa.layer.options.tipus == t_vis_wms){\n\t\t\tvar instamapsWms = InstamapsWms({\n\t\t\t\tloadTemplateParam :false});\n\t\t\tvar dataWMS = {url: capa.layer._url};\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\t\t\tvar layers = [];\n\t\t\t\tlayers=results.Capability.Layer.Layer;\n\t\t\t\tfor (var i=0;i<layers.length;i++){\n\t\t\t\t\tvar layer = layers[i];\n\t\t\t\t\tif (layers[i].Name.indexOf(\"cluster\")>-1) {\n\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\tbusinessId: capa.layer.options.businessId,//businessId id de la visualización de origen\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t\t            mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t\t            nom: layers[i].Name,//nom nombre de la nueva visualizacion\n\t\t\t\t\t            activas: true,\n\t\t\t\t\t            order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\t\t\t\ttem: tem_heatmap,\n\t\t\t\t\t\t\t\tserverType: tem_cluster_wms,//tem_cluster\n\t\t\t\t\t\t\t\turl: capa.layer._url\n//\t\t\t\t\t            estils: JSON.stringify(rangs[0])\n\t\t\t\t\t\t};\n\t\t\t\t\t\tcreateVisualitzacioHeatCluster(data).then(function(results){\n\t\t\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(results.layer);\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", false );\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).trigger( \"click\" );\n\t\t\t\t\t\t\t\t$('#input-'+results.layer.businessId).prop( \"checked\", true );\n\t\t\t\t\t\t\t\tactivaPanelCapes(true);\t\n\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},function(results){\n\t\t\t\t\t\t\t//TODO error\n\t\t\t\t\t\t\tconsole.debug(\"createVisualitzacioCluster ERROR\");\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t}else{\n\t\t\n\t\tclusterLayer.options.businessId = '-1';\n\t\tclusterLayer.options.nom = capa.layer.options.nom +\" \"+nom;\n\t\tclusterLayer.options.tipus = capa.layer.options.tipus;\n\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\tmap.addLayer(clusterLayer);\n\t\tclusterLayer.options.zIndex = capesOrdre_sublayer; //controlCapes._lastZIndex + 1;\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, capa.layer._leaflet_id);\n//\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\n\t\t//Desactivem la capa mare\n\t\tif ($( \"#input-\"+capa.layer.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capa.layer.options.businessId).click();\n//\t\t$(\".layers-list\").mCustomScrollbar({\n//\t\t\t   advanced:{\n//\t\t\t     autoScrollOnFocus: false,\n//\t\t\t     updateOnContentResize: true\n//\t\t\t   }           \n//\t\t});\t\t\t\n\t}\t\n}\n\nfunction loadDadesObertesClusterLayer(layer, dfd){\n\tvar options = jQuery.parseJSON( layer.options );\n\tvar estil_do = retornaEstilaDO(options.dataset);\n\tvar url_param = paramUrl.dadesObertes + \"dataset=\" + options.dataset;\t\n\t\n\tvar capaDadaOberta = new L.GeoJSON.AJAX(url_param, {\n\t\tonEachFeature : popUp,\n\t\tnom : layer.serverName,\n\t\ttipus : layer.serverType,\n\t\tdataset: options.dataset,\n\t\tbusinessId : layer.businessId,\n\t\tdataType : \"jsonp\",\n\t\tzIndex: parseInt(layer.capesOrdre),\n\t\tpointToLayer : function(feature, latlng) {\n\t\t\treturn L.circleMarker(latlng, estil_do);\n\t\t}\t\n\t});\n\t\n//\tmap.addLayer(capaDadaOberta);\n\tcapaDadaOberta.on('data:loaded', function(e){\n\t\t//console.debug(\"data:loaded\");\n\t\tmap.removeLayer(capaDadaOberta);\n\t\tvar clusterLayer = L.markerClusterGroup({\n\t\t\tsingleMarkerMode : true\n\t\t});\n\t\t\n\t\tcapaDadaOberta.eachLayer(function(layer) {\n\t\t\tvar marker = L.marker(new L.LatLng(layer.getLatLng().lat, layer.getLatLng().lng), {\n\t\t\t\ttitle : layer._leaflet_id\n\t\t\t});\n\t\t\tmarker.bindPopup(layer._popup._content);\n\t\t\tclusterLayer.addLayer(marker);\n\t\t});\t\n\t\t\n\t\tclusterLayer.options.businessId = layer.businessId;\n\t\tclusterLayer.options.nom = layer.serverName;\n\t\tclusterLayer.options.zIndex = layer.capesOrdre;\n\t\tclusterLayer.options.tipus = layer.serverType;\n\t\tclusterLayer.options.dataset = options.dataset;\n\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tmap.addLayer(clusterLayer);\n\t\t}\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\n//\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\t\t\n\t\t\n\t\tif(dfd){\n\t\t\ttry{\n\t\t\t\tdfd.resolve();\n\t\t\t}catch(e){\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t});\t\n}\n\n\nfunction loadJsonClusterLayer(layer){\n\t\n\tvar options = jQuery.parseJSON( layer.options );\n\n\tvar v_respotaJSON;\n\tgetJSONPServei(layer.url).then(function(results) {\n\t\tvar op = [];\n\t\tif (jQuery.isArray(results)) {\n\t\t\tv_respotaJSON = results;\n\t\t} else {\n\t\t\tfor (key in results) {\n\t\t\t\tif (jQuery.isArray(results[key])) {\n\t\t\t\t\tv_respotaJSON = results[key];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!jQuery.isArray(v_respotaJSON)) {\n\t\t\talert(window.lang.translate(\"No s'ha interpretat bé l'estructura del JSON\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tvar clusterLayer = L.markerClusterGroup({\n\t\t\tsingleMarkerMode : true\n\t\t});\t\t\n\t\t\n\t\tfor (key in v_respotaJSON) {\n\t\t\t\n\t\t\tvar lat = v_respotaJSON[key][options.y];\n\t\t\tvar lon = v_respotaJSON[key][options.x];\n\t\t\tvar pp = L.marker(new L.LatLng(parseFloat(lat), parseFloat(lon)), {\n\t\t\t\ttitle : layer._leaflet_id\n\t\t\t});\n//\t\t\tmarker.bindPopup(layer._popup._content);\n//\t\t\tvar pp = L.circleMarker([ lat, lon ], estil_do);\n\n\t\t\tpp.properties = {};\n\t\t\tvar empty = true;\n\t\t\tif (options.titol == \"null\") {\n\t\t\t\tpp.properties.nom = \"\"\n\t\t\t} else {\n\t\t\t\tpp.properties.nom = v_respotaJSON[key][options.titol];\n\t\t\t\tempty = empty && false;\n\t\t\t}\n\t\t\tif (options.descripcio == \"null\") {\n\t\t\t\tpp.properties.text = \"\"\n\t\t\t} else {\n\t\t\t\tpp.properties.text = v_respotaJSON[key][options.descripcio];\n\t\t\t\tempty = empty && false;\n\t\t\t}\n\t\t\tif (options.imatge == \"null\") {\n\t\t\t\tpp.properties.img = \"\"\n\t\t\t} else {\n\t\t\t\tpp.properties.img = '<img width=\"250px\" src=\"'\n\t\t\t\t\t\t+ v_respotaJSON[key][options.imatge] + '\">';\n\t\t\t\tempty = empty && false;\n\t\t\t}\n\t\t\tif (options.vincle == \"null\") {\n\t\t\t\tpp.properties.vincle = \"\"\n\t\t\t} else {\n\t\t\t\tpp.properties.vincle = '<a href=\"'\n\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle]\n\t\t\t\t\t\t+ '\" target=\"_blank\">'\n\t\t\t\t\t\t+ v_respotaJSON[key][options.vincle] + '</a>';\n\t\t\t\tempty = empty && false;\n\t\t\t}\n\n\t\t\tif(!empty){\n\t\t\t\tpp.bindPopup(\"<div id='nom-popup-json'>\" + pp.properties.nom + \"</div><div id='text-popup-json'>\"\n\t\t\t\t\t\t+ pp.properties.text + \"</div><div id='image-popup-json'>\"\n\t\t\t\t\t\t+ pp.properties.img + \"</div><div>\" + pp.properties.vincle\n\t\t\t\t\t\t+ \"</div>\");\n\t\t\t}\n\t\t\t\n\t\t\tclusterLayer.addLayer(pp);\n\t\t}\n\t\t\n\t\tclusterLayer.options.businessId = layer.businessId;\n\t\tclusterLayer.options.nom = layer.serverName;\n\t\tclusterLayer.options.zIndex = layer.capesOrdre;\n\t\tclusterLayer.options.tipus = layer.serverType;\n\t\tclusterLayer.options.tipusRang = tem_cluster;\n\n\t\tif (layer.capesActiva == true || layer.capesActiva == \"true\"){\n\t\t\tmap.addLayer(clusterLayer);\n\t\t}\n\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\n//\t\tcontrolCapes._lastZIndex++;\n\t\tactivaPanelCapes(true);\t\n\n\t});\n}\n\nfunction loadTematicCluster(layer, zIndex, layerOptions, capesActiva){\n\t\n\tvar options = jQuery.parseJSON(layerOptions);\n\t\n\tvar clusterLayer = L.markerClusterGroup({\n\t\tsingleMarkerMode : true\n\t});\t\n\t\n\t$.each(layer.geometries.features.features, function(i, feature) {\n\t\tvar marker = L.marker(new L.LatLng(feature.geometry.coordinates[1],feature.geometry.coordinates[0]), {\n\t\t\t//title : layer._leaflet_id\n\t\t});\n\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\n\t\tclusterLayer.addLayer(marker);\n\t});\n\t\n\tclusterLayer.options.businessId = layer.businessId;\n\tclusterLayer.options.nom =layer.nom;\n\tclusterLayer.options.zIndex = parseInt(zIndex);\n\tclusterLayer.options.tipus = t_tematic;\n\tclusterLayer.options.tipusRang = tem_cluster;\n\t\n\tif (capesActiva.indexOf(\"false\")==-1){\n\t\tmap.addLayer(clusterLayer);\n\t}\t\t\n\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\tcontrolCapes.addOverlay(clusterLayer,\tclusterLayer.options.nom, true, origen);\n//\tcontrolCapes._lastZIndex++;\n\tactivaPanelCapes(true);\t\t\n}\n\nfunction loadVisualitzacioCluster(layer, zIndex, layerOptions, capesActiva, dfd){\n\tvar options; \n\tif(typeof (layerOptions)==\"string\"){\t\n\t\ttry {\n\t\t\toptions = JSON.parse(layerOptions);\n\t\t}\n\t\tcatch (err) {\n\t\t\toptions = layerOptions;\t\t\n\t\t}\n\t}else{\t\t\t\n\t\toptions = layerOptions;\t\n\t}\n\n\tvar businessId;\n\tif (layer.geometriesBusinessId){\n\t\tbusinessId=layer.geometriesBusinessId\n\t}\n\telse businessId=options.origen;\n\t\n\tvar data = {\n\t\t\tbusinessId: businessId,//businessId id de la visualización de origen\n\t\t\tuid: Cookies.get('uid')//uid id de usuario\n\t\t};\t\n\t\n\t//Carrego llistat geometries\n\tgetGeometriesColleccioByBusinessId(data).then(function(results){\n\t\tif(results.status == 'OK'){\n\t\t\t\n\t\t\tvar clusterLayer = L.markerClusterGroup({\n\t\t\t\tsingleMarkerMode : true\n\t\t\t});\t\t\t\t\n\t\t\t\n\t\t\tvar arrP=[];\n\t\t\t$.each(results.geometries.geometria.features, function(i, feature) {\n\t\t\t\tif (feature.geometry.type==\"MultiPoint\"){\n\t\t\t\t\t$.each(feature.geometry.coordinates, function(j, coord) {\t\n\t\t\t\t\t\tvar marker = L.marker(new L.LatLng(coord[1],coord[0]), {\n\t\t\t\t\t\t\t//title : layer._leaflet_id\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\n\t\t\t\t\t\tclusterLayer.addLayer(marker);\t\t\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar marker = L.marker(new L.LatLng(feature.geometry.coordinates[1],feature.geometry.coordinates[0]), {\n\t\t\t\t\t\t//title : layer._leaflet_id\n\t\t\t\t\t});\n\t\t\t\t\tmarker.bindPopup(\"<b>\"+feature.properties.nom+\"</b><br><b>\"+feature.properties.text+\"</b>\");\n\t\t\t\t\tclusterLayer.addLayer(marker);\t\t\t\t\n\t\t\t\t}\t\t\n\t\t\t});\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tclusterLayer.options.businessId = layer.businessId;\n\t\t\tclusterLayer.options.nom =layer.nom;\n\t\t\tclusterLayer.options.zIndex = parseInt(zIndex);\n\t\t\tclusterLayer.options.tipus = t_visualitzacio;\n\t\t\tclusterLayer.options.tipusRang = tem_cluster;\n\t\t\t\n\t\t\tif (capesActiva!=undefined && capesActiva.indexOf(\"false\")==-1){\n\t\t\t\tmap.addLayer(clusterLayer);\n\t\t\t}\t\t\n\t\t\telse if (capesActiva==undefined) map.addLayer(clusterLayer);\n\t\t\t\n\t\t\tvar origen = getLeafletIdFromBusinessId(options.origen);\n\t\t\tcontrolCapes.addOverlay(clusterLayer, clusterLayer.options.nom, true, origen);\n//\t\t\tcontrolCapes._lastZIndex++;\n\t\t\tactivaPanelCapes(true);\t\n\t\t\t\n\t\t\tif(dfd){\n\t\t\t\ttry{\n\t\t\t\t\tdfd.resolve();\n\t\t\t\t}catch(e){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t}else{\n\t\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\t\t\t\t\t\n\t\t}\n\t},function(results){\n\t\t//TODO error\n\t\tconsole.debug(\"getGeometriesColleccioByBusinessId ERROR\");\n\t});\t\n}\n","var context,\n    newCanvas,\n    objLLegenda = null,\n    ldpercent_img = 0,\n    matriuCapesLL = {\n        layers: [],\n        n_layers: [],\n        id_layers: [],\n        t_layers: [],\n        c_layers: []\n    };\n\nfunction comportamentCaptura(inicial, titol, text_progress) {\n    if (inicial == 0) {\n        ldpercent_img = 0;\n        jQuery('.bt_desc_img').hide();\n        jQuery('#bt_desc_ll').hide();\n        jQuery('#div_captura').hide();\n        //jQuery('#img_canvas').attr('src', '/llibreries/img/loading.gif');\n        jQuery('#progress_bar_carrega_img').show();\n        jQuery('#dialog_captura').modal('show');\n\n        jQuery('#dialog_captura_title').text(window.lang.translate(titol));\n        \n        jQuery('#div_msg_export').html(window.lang.translate(text_progress));\n        \n        \n        //jQuery('#dialog_captura_text').html(window.lang.translate(text_progress));\n\n        uploadprogress_img();\n    } else if (inicial == 1) {\n        jQuery('#progress_bar_carrega_img').hide();\n        jQuery('.bt_desc_img').show();\n        //jQuery('#div_captura').show();\n    } else if (inicial == 3) {\n        jQuery('#progress_bar_carrega_img').hide();\n        //jQuery('#bt_desc_img').show();\n        //jQuery('#div_captura').show();\n    } else if (inicial == 2) {\n        jQuery('#progress_bar_carrega_img').hide();\n        jQuery('#dialog_captura').modal('hide');\n    }\n}\n\nfunction uploadprogress_img() {\n    ldpercent_img += 10;\n    if (ldpercent_img > 100) {\n        ldpercent_img = 100;\n    }\n    jQuery('#prg_bar_img').css('width', ldpercent_img + \"%\");\n    if (ldpercent_img < 100) {\n        setTimeout(\"uploadprogress_img()\", 1500);\n    }\n}\n\n\nfunction errorCaptura() {\n    comportamentCaptura(2);\n    alert(window.lang.translate(\"Error: No es pot generar el document\"));\n}\n\nfunction capturaPantalla(tipus) {\n\t\n\t\n\t\n    if (estatMapa3D) {\n        disparaEventMapa = false;\n        mapaEstatNOPublicacio = false;\n    }\n    if (tipus == CAPTURA_MAPA) {\n        comportamentCaptura(0, 'Capturar la vista del mapa', 'Es genera una impressió de pantalla del que mostra el mapa en el moment de clicar el botó.');\n        ActDesPrintMode(true);\n        setTimeout(function() {\n            generaCaptura(CAPTURA_MAPA, null, null, 2);\n\n            //generaCaptura(CAPTURA_MAPA_GEOTIFF, null, null, 2);\n\n        }, 500);\n\n\n    } else if (tipus == CAPTURA_MAPA_GEOPACKAGE) {\n    \t\n\t\tif(checkDataVectorlayers()){\n\t\t\t\t\tcomportamentCaptura(0, 'Descarrega les capes vectorials en format GeoPackage', 'Es genera un arxiu GeoPackage (base de dades) que conté només les capes vectorials del mapa i els seus atributs.');\n\t\t\t\t\t//ActDesPrintMode(true);\n\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tgeneraCaptura(CAPTURA_MAPA_GEOPACKAGE, null, null, 2);\n\n\n\t\t\t\t\t}, 500);\n\t\t}\n    } else if (tipus == CAPTURA_MAPA_GEOTIFF) {\n        comportamentCaptura(0, 'Descarrega el mapa en format GeoTIFF', 'Es genera un arxiu TIF que conté coordenades -longitud i latitud -. Llegible per aplicacions de tractament d’imatge o SIG.');\n        ActDesPrintMode(true);\n        \n        \n       \n        \n        setTimeout(function() {\n            generaCaptura(CAPTURA_MAPA_GEOTIFF, null, null, 2);\n        }, 500);\n\n    } else if (tipus == CAPTURA_INFORME) {\n        comportamentCaptura(0, 'Imprimir la vista del mapa', 'Es genera una vista prèvia que permet imprimir el que es visualitza a pantalla dins un full A4.');\n        ActDesPrintMode(true);\n        setTimeout(function() {\n            generaCaptura(CAPTURA_INFORME, null, null, 2);\n        }, 500);\n    } else if (tipus == CAPTURA_GALERIA) {\n        ActDesPrintMode(true);\n        setTimeout(function() {\n            generaCaptura(CAPTURA_GALERIA, null, null, 2);\n        }, 500);\n    } else if (tipus == CAPTURA_GEOPDF) {\n        comportamentCaptura(0, 'Descarrega mapa en format GeoPDF', 'Es genera un arxiu PDF que conté capes i coordenades - longitud i latitud -.Llegible per aplicacions com Adobe Acrobat, Adobe Reader i altres.');\n        ActDesPrintMode(true);\n        setTimeout(function() {\n            generaCaptura(CAPTURA_GEOPDF, null, null, 2);\n        }, 500);\n    }\n}\n\nfunction pucPassar(item) {\n    var passo = false;\n\n\n\n    if (document.getElementById('input-' + item.layer.options.businessId) != null) {\n        if (document.getElementById('input-' + item.layer.options.businessId).checked) {\n            if (item.layer._map != null && item.layer.options.tipus != t_wms &&\n                item.layer.options.tipus != t_wms &&\n                item.layer.options.tipus != t_heatmap &&\n                item.layer.options.tipus != t_cluster &&\n                item.layer.options.tipus != t_size) {\n                passo = true;\n                try {\n                    item.layer.toGeoJSONcustom();\n                    passo = true;\n                } catch (err) {\n                    passo = false;\n                    return passo;\n                }\n\n\n                //options.geometrytype\n\n            }\n        } else {\n            passo = false;\n        }\n    }\n    return passo;\n}\n\nfunction ompleCapesMatriu(item) {\n    var mainColor = \"#FF0000\";\n    if (pucPassar(item)) {\n        var L_JSON = item.layer.toGeoJSONcustom();\n        jQuery.each(L_JSON.features, function(i, feature) {\n            var tipus = feature.geometry.type;\n            if (tipus.indexOf(\"Point\") != -1) {\n                if (!feature.styles.icon) {\n                    feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:6px);BRUSH(fc:\" + feature.styles.fillColor + \")\";\n                    mainColor = feature.styles.fillColor;\n                } else {\n                    var icona;\n                    if (feature.styles.icon.options.markerColor) {\n                        icona = \"/opt/geocat/maps/galeria/\" + feature.styles.icon.options.markerColor;\n                        mainColor = icona;\n                    } else {\n                        var ff = feature.styles.icon.options.iconUrl\n                        icona = \"/opt/geocat/maps/galeria/\" + ff.substring(ff.lastIndexOf(\"/\") + 1, ff.lastIndexOf(\".\"));\n                        mainColor = icona;\n                    }\n                    feature.properties.OGR = \"SYMBOL(c:#ff0000,id:\" + icona + \".png)\";\n                }\n            } else if (tipus.indexOf(\"Line\") != -1) { //Polyline\n                feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:\" + (parseInt(feature.styles.weight) + 3) + \"px)\";\n                mainColor = feature.styles.color;\n            } else if (tipus.indexOf(\"Polygon\") != -1) {\n                mainColor = feature.styles.fillColor;\n                if (!mainColor || mainColor.indexOf(\"rgba\") != -1) {\n                    mainColor = feature.styles.color + \"90 \";\n                }\n                feature.properties.OGR = \"PEN(c:\" + feature.styles.color + \",w:\" + (parseInt(feature.styles.weight) + 3) + \"px);BRUSH(fc:\" + mainColor + \")\";\n            } else {\n                feature.properties.OGR = \"PEN(c:#0000ff,w:5px);BRUSH(fc:#0000ff90)\";\n            }\n        });\n        try {\n            matriuCapesLL.layers.push(JSON.stringify(L_JSON));\n        } catch (Err) {\n            var cache = [];\n            matriuCapesLL.layers.push(JSON.stringify(L_JSON, function(key, value) {\n                if (typeof value === 'object' && value !== null) {\n                    if (cache.indexOf(value) !== -1) {\n                        // Circular reference found, discard key\n                        return;\n                    }\n                    // Store value in our collection\n                    cache.push(value);\n                }\n                return value;\n            }));\n            cache = null;\n        }\n        matriuCapesLL.n_layers.push(item.name);\n        matriuCapesLL.id_layers.push(item.layer.options.businessId);\n        var geoM = item.layer.options.geometryType ? item.layer.options.geometryType : t_marker;\n        matriuCapesLL.t_layers.push(geoM);\n        matriuCapesLL.c_layers.push(mainColor);\n    }\n}\n\nfunction getCapesVectorActives() {\n    matriuCapesLL.layers = [];\n    matriuCapesLL.n_layers = [];\n    matriuCapesLL.id_layers = [];\n    matriuCapesLL.t_layers = [];\n    matriuCapesLL.c_layers = [];\n\n    jQuery.each(controlCapes._layers, function(i, item) {\n        ompleCapesMatriu(item);\n        jQuery.each(item._layers, function(j, item2) {\n            ompleCapesMatriu(item2);\n        });\n    });\n    return matriuCapesLL;\n}\n\n\nfunction calculaWF() {\n    var d = map.getSize();\n    w = d.x;\n    h = d.y;\n    var topMap = jQuery('#map').position().top;\n    var puntIn = map.getBounds().getNorthWest();\n    var NW = L.CRS.EPSG3857.project(puntIn);\n    var SE = L.CRS.EPSG3857.project(map.getBounds().getSouthEast());\n    var ff_Pixels = new L.Point(0, 0);\n    var ff_MM = map.layerPointToLatLng(ff_Pixels);\n    var ff_3557 = L.CRS.EPSG3857.project(ff_MM);\n    var pNW_Pixels = new L.Point(0, -topMap);\n    var pNW = map.layerPointToLatLng(pNW_Pixels);\n    var FACT = parseFloat(ff_MM.lat) - parseFloat(pNW.lat);\n    var pNW_3557 = L.CRS.EPSG3857.project(pNW);\n    var FACT = parseFloat(ff_3557.y) - parseFloat(pNW_3557.y);\n    var _FACT = parseFloat(ff_MM.lat) - parseFloat(pNW.lat);\n    var pNE_Pixels = new L.Point(w, h - topMap);\n    var pNE = map.layerPointToLatLng(pNE_Pixels);\n    var pNE_3557 = L.CRS.EPSG3857.project(pNE);\n    var mapW = (pNE_3557.x - pNW_3557.x) / w;\n    var mapH = (pNW_3557.y - pNE_3557.y) / h;\n    var nouY = parseFloat(parseFloat(NW.y) - (parseFloat(FACT)));\n    var _nouY = parseFloat(parseFloat(puntIn.lat) - (parseFloat(_FACT)));\n    var _nouYMIN = parseFloat(parseFloat(puntIn.lat) + (parseFloat(_FACT)));\n    var mapW4326 = (pNE.lng - pNW.lng) / w;\n    var mapH4326 = (pNW.lat - pNE.lat) / h;\n    var WF = {};\n    WF.imgW = w;\n    WF.imgH = h;\n    WF.resW4326 = mapW4326;\n    WF.resH4326 = mapH4326;\n    WF.resW = mapW;\n    WF.resH = mapH;\n\n    /*\n    mapW4326=(mapW4326 - 0.000040);\n    mapH4326=(mapH4326 - 0.000040);\n    */\n    //WF.x=NW.x;\n\n    WF.x1 = SE.x;\n    WF.y1 = nouY\n    WF.x = NW.x;\n    WF.y = SE.y;\n\n    WF.x4326 = map.getBounds().getNorthWest().lng;\n    WF.y14326 = _nouY;\n    WF.x14326 = map.getBounds().getSouthEast().lng;\n    WF.y4326 = map.getBounds().getSouthEast().lat;\n\n    return WF;\n}\n\nfunction tornaLLoc(tr) {\n    jQuery(\".leaflet-map-pane\").css({\n        left: 0,\n        top: 0,\n        \"transform\": tr\n    });\n}\n\n\nfunction tornaLLocGeoPDF(tr) {\n    if (L.Browser.webkit) {\n        jQuery(\".leaflet-map-pane\").css({\n            \"transform\": tr\n        });\n    }\n}\n\nfunction hackCaptura() {\n    if (jQuery(\".leaflet-map-pane\").css(\"transform\")) {\n        var transform = jQuery(\".leaflet-map-pane\").css(\"transform\")\n        var comp = transform.split(\",\") //split up the transform matrix\n        var mapleft = parseFloat(comp[4]) //get left value\n        var maptop = parseFloat(comp[5]) //get top value\n        $(\".leaflet-map-pane\").css({ //get the map container. not sure if stable\n            \"transform\": \"none\",\n            \"left\": mapleft,\n            \"top\": maptop,\n        });\n    }\n    return transform;\n}\n\nfunction hackGeoPDF() {\n    if (L.Browser.webkit) {\n        if (jQuery(\".leaflet-map-pane\").css(\"transform\")) {\n            var transform = jQuery(\".leaflet-map-pane\").css(\"transform\");\n            var comp = transform.split(\",\") //split up the transform matrix\n            var mapleft = parseFloat(comp[4]) //get left value\n            var maptop = parseFloat(comp[5]) //get top value\n            $(\".leaflet-map-pane\").css({ //get the map container. not sure if stable\n                \"transform\": \"translate3d(0px,0px,0px)\",\n            });\n        }\n    }\n}\n\nfunction generaCaptura(_tipusCaptura, w, h, factor) {\n\n   \n    map.setView([map.getCenter().lat, map.getCenter().lng], map.getZoom());\n    if ((!w) || (w == null)) {\n        var d = map.getSize();\n        w = d.x;\n        h = d.y;\n    }\n    var transform = \"\";\n\n\n    jQuery('#map .leaflet-marker-pane').find('div').has('.marker-cluster').attr('data-html2canvas-ignore', 'true');\n    jQuery('#map .leaflet-overlay-pane').find('canvas').not('.leaflet-heatmap-layer').removeAttr('data-html2canvas-ignore');\n    jQuery(\".leaflet-sidebar\").attr(\"data-html2canvas-ignore\", \"true\");\n    jQuery(\".leaflet-top.leaflet-left\").attr(\"data-html2canvas-ignore\", \"true\");\n    jQuery(\".leaflet-top.leaflet-right\").attr(\"data-html2canvas-ignore\", \"true\");\n    jQuery(\".leaflet-bottom.leaflet-left\").attr(\"data-html2canvas-ignore\", \"true\");\n    jQuery(\".leaflet-bottom.leaflet-right div\").attr(\"data-html2canvas-ignore\", \"true\");\n\n    if (jQuery('#dv_bt_legend').hasClass('greenfort')) {\n        jQuery(\"#mapLegend\").removeAttr(\"data-html2canvas-ignore\");\n        jQuery(\"#mapLegend div\").removeAttr(\"data-html2canvas-ignore\");\n    }\n\n\n    var divActiuCanvas = '.leaflet-map-pane';\n    var colorMapBackGround = jQuery('#map').css('background-color');\n\n    if (estatMapa3D) {\n        divActiuCanvas = '.cesium-widget';\n        disparaEventMapa = false;\n        mapaEstatNOPublicacio = false;\n    }\n    if (_tipusCaptura == CAPTURA_MAPA) {\n        transform = hackCaptura();\n        var snd = new Audio(\"/llibreries/sons/camera.wav\"); // buffers\n        snd.play();\n        html2canvas(jQuery(divActiuCanvas), {\n            onrendered: function(canvas) {\n                ActDesPrintMode(false);\n\n\n                var imgData = canvas.toDataURL('image/png', 0.92);\n                imgData = JSON.stringify(imgData.replace(\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\n                uploadImageBase64(imgData).then(\n                    function(results) {\n                        if (results.status == \"OK\") {\n                            var urlIMG = paramUrl.urlgetMapImage +\n                                \"&request=getCaptura&uuid=\" +\n                                results.UUID;\n                            capturaLlegenda(true);\n                            comportamentCaptura(1);\n                            var $desc_img = jQuery('#dialog_captura').find('.desc_img');\n\n                            $desc_img.prop('href', urlIMG);\n\n                            $desc_img.prop('download', 'mapa_captura.png');\n                            //$desc_img.html(\"Desar mapa\" +\" <i class='fa fa-picture-o'></i>\");\n                            //jQuery('#dialog_captura').find('.bt_desc_img').show();\n                            tornaLLoc(transform);\n                            if (estatMapa3D) {\n                                mapaEstatNOPublicacio = true;\n                            }\n                        } else {\n                            errorCaptura();\n                        }\n                        imgData = \"\";\n                    });\n            },\n            useCORS: true,\n            allowTaint: false,\n            proxy: paramUrl.urlgetImageProxy,\n            background: colorMapBackGround,\n            width: w,\n            height: h,\n            logging: false\n        });\n\n\n    } else if (_tipusCaptura == CAPTURA_MAPA_GEOTIFF) {\n        transform = hackCaptura();\n        var data = calculaWF();\n        html2canvas(jQuery(divActiuCanvas), {\n            onrendered: function(canvas) {\n                ActDesPrintMode(false);\n\n\n                var imgData = canvas.toDataURL('image/png', 0.92);\n                imgData = JSON.stringify(imgData.replace(\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\n                uploadImageBase64(imgData).then(\n                    function(results) {\n                        if (results.status == \"OK\") {\n                            var urlIMG = paramUrl.urlgetMapImage +\n                                \"&request=getCapturaGeoTiff&uuid=\" +\n                                results.UUID +\n                                \"&resW=\" + data.resW +\n                                \"&resH=\" + data.resH +\n                                \"&x=\" + data.x +\n                                \"&y=\" + data.y +\n                                \"&x1=\" + data.x1 +\n                                \"&y1=\" + data.y1 +\n                                \"&resW4326=\" + data.resW4326 +\n                                \"&resH4326=\" + data.resH4326 +\n                                \"&x4326=\" + data.x4326 +\n                                \"&y4326=\" + data.y4326 +\n                                \"&x14326=\" + data.x14326 +\n                                \"&y14326=\" + data.y14326 +\n                                \"&entitatUid=\" + mapConfig.entitatUid + \"&businessId=\" + mapConfig.businessId;\n                            capturaLlegenda(true);\n                            comportamentCaptura(1);\n                            var $desc_img = jQuery('#dialog_captura').find('.desc_img');\n\n                            $desc_img.prop('href', urlIMG);\n\n                            $desc_img.prop('download', 'mapa_geo.tiff');\n\n                            tornaLLoc(transform);\n                            if (estatMapa3D) {\n                                mapaEstatNOPublicacio = true;\n                            }\n                        } else {\n                            errorCaptura();\n                        }\n                        imgData = \"\";\n                    });\n            },\n            useCORS: true,\n            allowTaint: false,\n            proxy: paramUrl.urlgetImageProxy,\n            background: colorMapBackGround,\n            width: w,\n            height: h,\n            logging: false\n        });\n\n\n\n    } else if (_tipusCaptura == CAPTURA_GALERIA) {\n        transform = hackCaptura();\n        html2canvas(jQuery(divActiuCanvas), {\n            onrendered: function(canvas) {\n                ActDesPrintMode(false);\n                var imgCaptura = canvas.toDataURL('image/jpeg', 0.50);\n                imgCaptura = JSON.stringify(imgCaptura.replace(\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\n                tornaLLoc(transform);\n                try {\n                    map.spin(false);\n                } catch (Err) {}\n                uploadImageBase64(imgCaptura).then(\n                    function(results) {\n                        if (results.status == \"OK\") {\n                            var urlIMG = paramUrl.urlgetMapImage +\n                                \"&request=getGaleria&update=true&businessid=\" +\n                                mapConfig.businessId + \"&uuid=\" + results.UUID;\n                            var img = document.createElement('img');\n                            img.src = urlIMG;\n                            tornaLLoc(transform);\n                        } else {\n                            //alert(\"Error\");\n                        }\n                        imgCaptura = \"\";\n                    });\n            },\n            useCORS: true,\n            allowTaint: false,\n            proxy: paramUrl.urlgetImageProxy,\n            background: colorMapBackGround,\n            width: parseInt(w),\n            height: parseInt(h),\n            logging: false\n        });\n    } else if (_tipusCaptura == CAPTURA_INFORME) {\n        transform = hackCaptura();\n        html2canvas(jQuery(divActiuCanvas), {\n            onrendered: function(canvas) {\n                ActDesPrintMode(false);\n                var imgData = canvas.toDataURL('image/jpeg', 0.72);\n                imgData = JSON.stringify(imgData.replace(\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\n                uploadImageBase64(imgData).then(\n                    function(results) {\n                        if (results.status == \"OK\") {\n                            var urlIMG = paramUrl.urlgetMapImage +\n                                \"&request=getCaptura&uuid=\" +\n                                results.UUID;\n                            jQuery('#img_canvas').attr('src', urlIMG);\n                            capturaLlegenda(false);\n                            comportamentCaptura(2);\n                            tornaLLoc(transform);\n                            window.open(\"/geocatweb/print.html\", \"Imprimir\",\n                                \"resizable=yes,status=yes,toolbar=yes,menubar=yes,location=no,scrollbars=yes\")\n                            if (estatMapa3D) {\n                                mapaEstatNOPublicacio = true;\n                            }\n                        } else {\n                            errorCaptura();\n                        }\n                        imgData = \"\";\n                    });\n            },\n            useCORS: true,\n            allowTaint: false,\n            proxy: paramUrl.urlgetImageProxy,\n            background: colorMapBackGround,\n            width: parseInt(w / 1.2),\n            height: parseInt(h / 1.2),\n            logging: false\n        });\n    } else if (_tipusCaptura == CAPTURA_GEOPDF) {\n        jQuery('#map .leaflet-overlay-pane').find('canvas').not('.leaflet-heatmap-layer').attr('data-html2canvas-ignore', 'true');\n\n        //hack Marker com imatge\n        jQuery('#map .leaflet-marker-pane').attr('data-html2canvas-ignore', 'true');\n\n\n        //In some browsers the initial transform is not set correctly\n        //we move the map a pixel so it resets itself\n\n\n\n        map.addOneTimeEventListener('moveend', captureGEOPDF);\n        //map.addOneTimeEventListener('moveend', captureGEOPackage);\n\n        map.panBy([0, 1], {\n            animate: false,\n            noMoveStart: true,\n            duration: 0\n        });\n    } else if (_tipusCaptura == CAPTURA_MAPA_GEOPACKAGE) {\n\n\n        captureGEOPackage();\n\n    }\n\n}\n\nfunction checkDataVectorlayers(){\n\t\n\tvar data=getCapesVectorActives();\n\n\tif( data.layers.length ==0){\n\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Aquest mapa no té capes vector. No es pot generar un vector GeoPackage\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\treturn false;\n\t}else{\n\t\t\treturn true;\t\n\t}\t\n\t\n}\t\n\n\nfunction captureGEOPackage(event) {\n    var data = getCapesVectorActives();\n\n\tif(matriuCapesLL.layers.length >=1){\n\t\n    data.request = \"createGeoPackage\";\n    data.entitatUid = mapConfig.entitatUid;\n    data.businessId = mapConfig.businessId;\n    data.nomAplicacio = mapConfig.nomAplicacio;\n\n    createGeoPdfMap(data).then(\n        function(geopackageresult) {\n            if (geopackageresult.status == \"OK\") {\n                var urlIMG = paramUrl.urlgetMapImage +\n                    \"&request=getGeoPackage&uuid=\" +\n                    geopackageresult.UUID;\n                var $desc_img = jQuery('#dialog_captura').find('.desc_img');\n                $desc_img.prop('href', urlIMG);\n                $desc_img.prop('download', 'mapa_geoPackage.gpkg');\n                //jQuery('#desc_img').html(window.lang.translate(\"Desar mapa\") +\" <i class='fa fa-file-pdf-o'></i>\");\n                comportamentCaptura(3);\n                $('#dialog_captura').find('.bt_desc_img').show();\n\n\n            } else {\n\n                errorCaptura();\n            }\n        });\n\n\t}else{\n\t\t\n\n\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Aquest mapa no té capes vector. No es pot genera GeoPackage\"));\t\t\t\t\t\t\t\t\t\t\n\t\t$('#dialog_error_upload').modal('show');\n\t\t\n\t}\t\n\n\n\n\n\n}\n\n\nfunction captureGEOPDF(event) {\n    transform = hackCaptura();\n    var WF = calculaWF();\n    var data = getCapesVectorActives();\n    capturaLlegenda(false);\n    var colorMapBackGround = jQuery('#map').css('background-color');\n    html2canvas(jQuery('#map .leaflet-map-pane'), {\n        onrendered: function(canvas) {\n            ActDesPrintMode(false);\n            var imgData = canvas.toDataURL('image/png', 0.95);\n            imgData = JSON.stringify(imgData.replace(\n                /^data:image\\/(png|jpeg);base64,/, \"\"));\n            uploadImageBase64(imgData).then(\n                function(results) {\n                    if (results.status == \"OK\") {\n                        data.imgW = WF.imgW;\n                        data.imgH = WF.imgH;\n                        data.resW = WF.resW;\n                        data.resH = WF.resH;\n                        data.resW = WF.resW;\n                        data.resH = WF.resH;\n                        data.resW4326 = WF.resW4326;\n                        data.resH4326 = WF.resH4326;\n                        data.x = WF.x;\n                        data.y = WF.y;\n                        data.x1 = WF.x1;\n                        data.y1 = WF.y1;\n                        data.x4326 = WF.x4326;\n                        data.y4326 = WF.y4326;\n                        data.x14326 = WF.x14326;\n                        data.y14326 = WF.y14326;\n                        data.request = \"createGeoPDF\";\n                        data.uuid = results.UUID;\n                        data.entitatUid = mapConfig.entitatUid;\n                        data.businessId = mapConfig.businessId;\n                        data.nomAplicacio = mapConfig.nomAplicacio;\n                        data.llegenda = objLLegenda;\n                        createGeoPdfMap(data).then(\n                            function(geopdfresults) {\n                                if (geopdfresults.status == \"OK\") {\n                                    var urlIMG = paramUrl.urlgetMapImage +\n                                        \"&request=getGeoPDF&uuid=\" +\n                                        results.UUID;\n                                    var $desc_img = jQuery('#dialog_captura').find('.desc_img');\n                                    $desc_img.prop('href', urlIMG);\n                                    $desc_img.prop('download', 'mapa_geoPDF.pdf');\n                                    //jQuery('#desc_img').html(window.lang.translate(\"Desar mapa\") +\" <i class='fa fa-file-pdf-o'></i>\");\n                                    $('#dialog_captura').find('.bt_desc_img').show();\n                                    comportamentCaptura(3);\n                                    if (!L.Browser.webkit) {\n                                        tornaLLoc(transform);\n                                    }\n                                } else {\n                                    comportamentCaptura(2);\n                                    errorCaptura();\n                                }\n                            });\n                    } else {\n                        alert(\"Error\");\n                    }\n                    imgData = \"\";\n                });\n        },\n        useCORS: true,\n        allowTaint: false,\n        proxy: paramUrl.urlgetImageProxy,\n        background: colorMapBackGround,\n        width: w,\n        height: h,\n        logging: false\n    });\n}\n\nfunction capturaLlegenda(ensenyaBoto) {\n    objLLegenda = null;\n    if (jQuery('#dv_bt_legend').hasClass('greenfort')) {\n        var w = jQuery('#mapLegend').width();\n        var h = jQuery('#mapLegend').height();\n        html2canvas(jQuery('#mapLegend'), {\n            onrendered: function(canvas) {\n                var imgCapturaLL = canvas.toDataURL('image/jpeg', 0.75);\n                imgCapturaLL = JSON.stringify(imgCapturaLL.replace(\n                    /^data:image\\/(png|jpeg);base64,/, \"\"));\n                uploadImageBase64(imgCapturaLL).then(\n                    function(results) {\n                        if (results.status == \"OK\") {\n                            objLLegenda = results.UUID;\n                            var urlIMG = paramUrl.urlgetMapImage +\n                                \"&request=getCaptura&uuid=\" +\n                                results.UUID;\n                            if (ensenyaBoto) {\n                                jQuery('#desc_ll').attr('href', urlIMG);\n                                jQuery('#desc_ll').attr('download', 'llegenda_captura.jpeg');\n                                jQuery('#desc_ll').html(window.lang.translate(\"Desar llegenda\") + \" <i class='fa fa-bars'></i>\");\n                                jQuery('#bt_desc_ll').show();\n                            } else {\n                                jQuery('#ll_canvas').attr('src', urlIMG);\n                                jQuery('#bt_desc_ll').hide();\n                            }\n                        } else {\n                            objLLegenda = null;\n                        }\n                    }\n                );\n            },\n            useCORS: true,\n            allowTaint: false,\n            proxy: paramUrl.urlgetImageProxy,\n            background: undefined,\n            logging: false\n        });\n    }\n}\n\nfunction imatgeCarregada() {\n    ActDesPrintMode(false);\n}\n\nfunction ActDesPrintMode(printMode) {\n    try {\n        if (map.options.typeMap == FONS_TOPOMAP) {\n            map.topoMap(printMode);\n        } else if (map.options.typeMap == FONS_ORTOMAP) {\n            map.ortoMap(printMode);\n        } else if (map.options.typeMap == FONS_HIBRIDMAP) {\n            map.hibridMap(printMode);\n        } else if (map.options.typeMap == FONS_TOPOGISMAP) {\n            map.topoGrisMap(printMode);\n        }\n        return true;\n    } catch (err) {\n        return true;\n    }\n}\n\nfunction calculaDistanciaMetres(PuntIn, PuntFi) {\n    var lat1 = PuntIn.lat;\n    var lon1 = PuntIn.lng;\n    var lat2 = PuntFi.lat;\n    var lon2 = PuntFi.lng;\n\n    var R = 6371; // Radius of the earth in km\n    var dLat = deg2rad(lat2 - lat1); // deg2rad below\n    var dLon = deg2rad(lon2 - lon1);\n    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) *\n        Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\n    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    var d = R * c; // Distance in km\n    return d;\n}\n\nfunction deg2rad(deg) {\n    return deg * (Math.PI / 180)\n}\n\nfunction rag2deg(deg) {\n    return deg * (180 / Math.PI)\n}\n",";(function(global, $){\r\n\t\r\n\tvar Semaforic = function(isEditing){\r\n\t\treturn new Semaforic._init(isEditing);\r\n\t}\r\n\t\r\n\tSemaforic.prototype = {\r\n\t\t_createPaletteSelector: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar html = \r\n\t\t\t'\t<div id=\"interactivePalette\">' +\r\n\t\t\t'\t\t<div id=\"paletteBackground\"></div>' +\r\n\t\t\t'\t\t<div id=\"innerPalette\">' +\r\n\t\t\t'\t\t\t<div lang=\"ca\" class=\"paletteTitle\">Temàtic per escala de color</div>' + \r\n\t\t\t'\t\t\t<div lang=\"ca\" style=\"font-size: 12px;\">Tria la paleta de colors</div>' +\r\n\t\t\t'\t\t\t<div>' +\r\n\t\t\t'\t\t\t\t<div class=\"paletteLabels\">' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors menors</div>' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors iguals</div>' +\r\n\t\t\t'\t\t\t\t\t<div style=\"height: 20px;\" lang=\"ca\">Valors majors</div>' +\r\n\t\t\t'\t\t\t\t</div>' +\r\n\t\t\t'\t\t\t\t<div class=\"palettes\" style=\"display: inline-block;\">';\r\n\t\t\t\r\n\t\t\tvar palettes = $(\"#paletes_colors > .ramp\");\r\n\t\t\tpalettes.splice(0, 0, \"carto\");\r\n\t\t\tif(1 == palettes.length)\r\n\t\t\t\tpalettes = [\"carto\", \"BuGn\", \"BuPu\", \"GnBu\", \"OrRd\", \"PuBu\", \"PuBuGn\", \"PuRd\", \"RdPu\", \"YlGn\", \"YlGnBu\", \"YlOrBr\", \"YlOrRd\", \r\n\t\t\t\t\t\"BrBG\", \"PRGn\", \"PuOr\", \"RdGy\", \"RdYlBu\", \"RdYlGn\", \"Spectral\", \"Paired\", \"Set3\", \"Set1\", \"Dark2\"];\r\n\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\tvar palName;\r\n\t\t\t\tif($(palette).hasClass(\"ramp\"))\r\n\t\t\t\t\tpalName = $(palette).attr(\"class\").replace(\"ramp \", \"\");\r\n\t\t\t\telse\r\n\t\t\t\t\tpalName = palette;\r\n\t\t\t\tvar scale = self._createScaleAux(palName, 3, false);\r\n\t\t\t\thtml += '\t\t\t\t\t<div class=\"ramp border ' + palName + '\">' +\r\n\t\t\t\t'\t\t\t\t\t<svg height=\"60\" width=\"15\">' + \r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"0\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[0]).hex() + '\"/>' + \r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"20\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[1]).hex() + '\"/>' +\r\n\t\t\t\t'\t\t\t\t\t\t<rect y=\"40\" height=\"20\" width=\"15\" fill=\"' + scale(self._paletteColorSteps[2]).hex() + '\"/>' +\r\n\t\t\t\t'\t\t\t\t\t</svg>' +\r\n\t\t\t\t'\t\t\t\t</div>';\r\n\t\t\t});\r\n\r\n\t\t\thtml += '\t\t\t\t</div>' + \r\n\t\t\t'\t\t\t\t<div class=\"paletteButtons\">'+\r\n\t\t\t'\t\t\t\t\t<div style=\"display: inline-block; float:left;\">'+\r\n\t\t\t'\t\t\t\t\t\t<input id=\"cbSoftColors\" type=\"checkbox\"><span style=\"padding-left: 10px;\" lang=\"ca\">' + window.lang.translate('Colors suaus') + '</span>' +\r\n\t\t\t'\t\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t\t<div class=\"innerPaletteButtons\">'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-invert-palette\"><span lang=\"ca\">Inverteix paleta</span><span id=\"invert-palette-arrow\" class=\"glyphicon glyphicon-arrow-down\" style=\"padding-left: 5px;\"></span></button>'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" lang=\"ca\">Cancel·lar</button>'+\r\n\t\t\t'\t\t\t\t\t\t<button type=\"button\" class=\"btn btn-success\" lang=\"ca\">Acceptar</button>'+\r\n\t\t\t'\t\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t</div>' +\r\n\t\t\t'\t\t</div>' + \r\n\t\t\t'\t</div>' +\r\n\t\t\t'\t<div id=\"dismissPaletteDialog\" class=\"modal fade\">' + \r\n\t\t\t'\t\t<div class=\"modal-dialog\">'+\r\n\t\t\t'\t\t\t<div class=\"modal-content panel-primary\">'+\r\n\t\t\t'\t\t\t\t<div id=\"id_sw\" class=\"modal-body\">'+\r\n\t\t\t'\t\t\t\t\t<h4><span lang=\"ca\">Vols sortir sense guardar aquesta escala de color?</span></h4>' +\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t\t<div class=\"modal-footer\">'+\r\n\t\t\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Cancel·lar</button>'+\r\n\t\t\t'\t\t\t        <button type=\"button\" class=\"btn btn-danger\" data-dismiss=\"modal\" lang=\"ca\">Esborrar</button>'+\r\n\t\t\t'\t\t\t\t</div>'+\r\n\t\t\t'\t\t\t</div>'+\r\n\t\t\t'\t\t</div>'+\r\n\t\t\t'\t</div>';\r\n\t\t\t$(\"#mapa_modals\").append(html);\r\n\r\n\t\t\t$('#cbSoftColors').iCheck({\r\n\t\t\t\tcheckboxClass: 'icheckbox_flat-blue',\r\n\t\t\t\tradioClass: 'iradio_flat-blue'\r\n\t\t\t});\r\n\r\n\t\t\tself._isPaletteDialogCreated = true;\r\n\r\n\t\t},\r\n\r\n\t\t_bindPaletteButtons: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar aux = $(\"#interactivePalette .ramp\");\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(evt){\r\n\t\t\t\tvar _this = $(this);\r\n\t\t\t\t$(\"#interactivePalette .ramp.active\").removeClass(\"active\");\r\n\t\t\t\tvar brewerClass = _this.attr('class').replace(\"ramp border \",\"\").replace(\" active\", \"\");\r\n\t\t\t\tself._palette = brewerClass;\r\n\t\t\t\t_this.addClass(\"active\");\r\n\r\n\t\t\t\t//If we are editing, update the values of the category popup\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif(\"carto\" == brewerClass)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\tbrewerClass = [\"#1a9850\",\"#ffffbf\",\"#d73027\"];\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"paleta\", brewerClass);\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#interactivePalette .btn-invert-palette\");\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(evt){\r\n\t\t\t\tself._isPaletteReversed = !self._isPaletteReversed;\r\n\r\n\t\t\t\tif(self._isPaletteReversed)\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\t$(\"#invert-palette-arrow\").removeClass(\"glyphicon-arrow-down\").addClass(\"glyphicon-arrow-up\");\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$(\"#invert-palette-arrow\").removeClass(\"glyphicon-arrow-up\").addClass(\"glyphicon-arrow-down\");\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"reverse\",self._isPaletteReversed);\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar palettes = $(\"#interactivePalette .ramp\");\r\n\t\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\t\tvar svg = $(palette).children();\r\n\t\t\t\t\tvar rects = $(svg).children();\r\n\t\t\t\t\tvar startColor = $(rects[0]).attr(\"fill\");\r\n\t\t\t\t\tvar endColor = $(rects[2]).attr(\"fill\");\r\n\t\t\t\t\t$(rects[0]).attr(\"fill\", endColor);\r\n\t\t\t\t\t$(rects[2]).attr(\"fill\", startColor);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $('#interactivePalette .btn-success');\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(e){\r\n\r\n\t\t\t\t$('#interactivePalette').hide();\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$('#info_uploadFile').show();\r\n\t\t\t\t\tbusy=true;\r\n\t\t\t\t\t$(\"#div_uploading_txt\").html(\"\");\r\n\t\t\t\t\t$(\"#div_uploading_txt\").html(\r\n\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\r\n\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tvar key = $(\"#dialog_tematic_rangs #dataField\").val();\r\n\t\t\t\t\tvar rangs = $(\"#dialog_tematic_rangs\").data(\"rangs\");\r\n\t\t\t\t\tvar value = rangs[1].min;\r\n\t\t\t\t\tvar data = {nom: key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + value + \")\", \r\n\t\t\t\t\t\ttrafficLightKey: key, trafficLightValue: value, trafficLightLowerColor: self._previsualizationLayer.estil[0].color,\r\n\t\t\t\t\t\ttrafficLightEqualColor: self._previsualizationLayer.estil[1].color, trafficLightHigherColor: self._previsualizationLayer.estil[2].color};\r\n\t\t\t\t\tcreateTematicLayerCategories(e, {}, data, $.Deferred()).then(function(layerId) {\r\n\t\t\t\t\t\t//Update the map legend\r\n\t\t\t\t\t\tvar arrRangsEstilsLegend = sortObject(controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend);\r\n\t\t\t\t\t\tarrRangsEstilsLegend.sort(sortByValueMax);\r\n\t\t\t\t\t\t//Change the businessId from the styles and ranges to sort them correctly\r\n\t\t\t\t\t\t//(When geocat.mapa.legend.js addLayerToLegend is called, the ranges are sorted by its businessId so they are not guaranteed to \r\n\t\t\t\t\t\t//mantain the lower-equal-bigger legend)\r\n\t\t\t\t\t\tvar estils = controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.estil;\r\n\t\t\t\t\t\tvar nousEstils = [];\r\n\t\t\t\t\t\tfor(var i=0; i<estils.length; ++i)\r\n\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\tif(arrRangsEstilsLegend[0].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Lower style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[0] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[0].businessId = 0;\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(arrRangsEstilsLegend[1].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Equal style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[1] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[1].businessId = 1;\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(arrRangsEstilsLegend[2].key == estils[i].businessId)\r\n\t\t\t\t\t\t\t{\t//Bigger style\r\n\r\n\t\t\t\t\t\t\t\tnousEstils[2] = estils[i];\r\n\t\t\t\t\t\t\t\tnousEstils[2].businessId = 2;\r\n\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.estil = nousEstils;\r\n\t\t\t\t\t\tcontrolCapes._visLayers[controlCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.businessId].estil = nousEstils;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[0].value = key + window.lang.translate(\" menor de \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[0].key = 0;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[1].value = key + window.lang.translate(\" igual a \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[1].key = 1;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[2].value = key + window.lang.translate(\" major de \") + value;\r\n\t\t\t\t\t\tarrRangsEstilsLegend[2].key = 2;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend = [];\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[0].key] = arrRangsEstilsLegend[0].value;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[1].key] = arrRangsEstilsLegend[1].value;\r\n\t\t\t\t\t\tcontrolCapes._layers[self._previsualizationLayer.parentid]._layers[layerId].layer.options.rangsEstilsLegend[arrRangsEstilsLegend[2].key] = arrRangsEstilsLegend[2].value;\r\n\t\t\t\t\t\t//Remove the previsualization layer from the layer control\r\n\t\t\t\t\t\tmap.removeLayer(self._capaVisualitzacio);\r\n\t\t\t\t\t\tcontrolCapes.removeLayer(controlCapes._layers[self._previsualizationLayer.parentid]._layers[self._capaVisualitzacio._leaflet_id]);\r\n\t\t\t\t\t\tself._previsualizationLayer = null;\r\n\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t\taux = $('#interactivePalette .btn-default');\r\n\t\t\taux.off('click');\r\n\t\t\taux.on('click',function(e){\r\n\t\t\t\t//Activate the parent layer\r\n\t\t\t\t$( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).click();\r\n\t\t\t\tself._closePalette();\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#paletteBackground\");\r\n\t\t\taux.off(\"click\");\r\n\t\t\taux.on(\"click\", function(e) {\r\n\t\t\t\t$(\"#dismissPaletteDialog\").modal(\"show\");\r\n\t\t\t});\r\n\r\n\t\t\taux = $(\"#dismissPaletteDialog .btn-danger\");\r\n\t\t\taux.off(\"click\");\r\n\t\t\taux.on(\"click\", function(e) {\r\n\t\t\t\tself._closePalette();\r\n\t\t\t});\r\n\r\n\t\t\t$(\"#cbSoftColors\").on(\"ifToggled\", function(e) {\r\n\t\t\t\tself._softColorsCheckboxChanged();\r\n\r\n\t\t\t\tif(self._isEditing)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tupdatePaletaRangs(self._useSoftColors);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar palettes = $(\"#interactivePalette .ramp\");\r\n\t\t\t\t$.each(palettes, function(index, palette) {\r\n\t\t\t\t\tvar svg = $(palette).children();\r\n\t\t\t\t\tvar rects = $(svg).children();\r\n\t\t\t\t\tvar paletteName = $(palette).attr(\"class\").replace(\"ramp border \", \"\").replace(\" active\", \"\");\r\n\t\t\t\t\tvar scale = self._createScaleAux(paletteName, 3, self._isPaletteReversed);\r\n\t\t\t\t\t$(rects[0]).attr(\"fill\", scale(self._paletteColorSteps[0]).hex());\r\n\t\t\t\t\t$(rects[1]).attr(\"fill\", scale(self._paletteColorSteps[1]).hex());\r\n\t\t\t\t\t$(rects[2]).attr(\"fill\", scale(self._paletteColorSteps[2]).hex());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif(null != self._previsualizationLayer)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//Update the previsualization layer\r\n\t\t\t\t\tself._updateFakeLayer();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t},\r\n\r\n\t\t_softColorsCheckboxChanged: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tself._useSoftColors = !self._useSoftColors;\r\n\r\n\t\t\tif(self._useSoftColors)\r\n\t\t\t\tself._paletteColorSteps = [0.75, 1.5, 2.25];\r\n\t\t\telse\r\n\t\t\t\tself._paletteColorSteps = [0, 1.5, 3];\r\n\r\n\t\t},\r\n\r\n\t\t_closePalette: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\t$('#interactivePalette').hide();\r\n\t\t\tmap.removeLayer(self._capaVisualitzacio);\r\n\t\t\tcontrolCapes.removeLayer(controlCapes._layers[self._previsualizationLayer.parentid]._layers[self._capaVisualitzacio._leaflet_id]);\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\t\t\tself._previsualizationLayer = null;\r\n\r\n\t\t},\r\n\r\n\t\t_showPaletteSelector: function()\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tif(!self._isPaletteDialogCreated)\r\n\t\t\t\tself._createPaletteSelector();\r\n\r\n\t\t\tself._bindPaletteButtons();\r\n\t\t\t$(\"#interactivePalette\").show();\r\n\r\n\t\t},\r\n\r\n\t\t_createTrafficLightStyle: function(color, bId, features)\r\n\t\t{\r\n\r\n\t\t\treturn {\r\n\t\t\t\tbusinessId : bId,\r\n\t\t\t\tborderColor: \"#ffffff\",\r\n\t\t\t\tborderWidth: 1,\r\n\t\t\t\tcolor: color,\r\n\t\t\t\topacity: 75,\r\n\t\t\t\tlabel: false,\r\n\t\t\t\tlabelHaloWidth: 0,\r\n\t\t\t\tlabelSize: 0,\r\n\t\t\t\tlineWidth: 0,\r\n\t\t\t\tradius: 0,\r\n\t\t\t\tsimbolSize: 6,\r\n\t\t\t\tgeometria: {\r\n\t\t\t\t\tfeatures: features\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t},\r\n\r\n\t\t_randomStringAux: function(length, chars)\r\n\t\t{\r\n\r\n\t\t\tvar result = '';\r\n\t\t\tfor (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];\r\n\t\t\treturn result;\r\n\r\n\t\t},\r\n\r\n\t\t_randomString: function(length)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treturn self._randomStringAux(length, '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');\r\n\r\n\t\t},\r\n\r\n\t\t_createTempTrafficLightLayer: function(key, value, baseLayer, layerOptions)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar newLayer = {};\r\n\t\t\tvar id = randomString(32);\r\n\t\t\tvar newOptions = {businessId: id,\r\n\t\t\t\tcapesActiva: \"true\",\r\n\t\t\t\tcapesCalenta: null,\r\n\t\t\t\tcapesGroup: \"\",\r\n\t\t\t\tcapesOrdre: \"sublayer\",\r\n\t\t\t\tcapesVisibilitat: null,\r\n\t\t\t\tentitatUid: null, //<----\r\n\t\t\t\tepsg: {},\r\n\t\t\t\tid: null, //<----\r\n\t\t\t\timgFormat: \"\",\r\n\t\t\t\tinfFormat: \"\",\r\n\t\t\t\tlayers: null,\r\n\t\t\t\tlegend: \"\",\r\n\t\t\t\topacity: 1,\r\n\t\t\t\toptions: JSON.stringify({\r\n\t\t\t\t\ttem: \"clasicTematic\",\r\n\t\t\t\t\tid: null,  //<----\r\n\t\t\t\t\tbusinessId: id,\r\n\t\t\t\t\tnom: key + \" \" + window.lang.translate(\"Escala de color\"),\r\n\t\t\t\t\torigen: baseLayer.businessId,\r\n\t\t\t\t\tgeometryType: baseLayer.geometryType,\r\n\t\t\t\t\ttipus: \"clasicTematic\",\r\n\t\t\t\t\toptions: {\r\n\t\t\t\t\t\tsource: baseLayer.source,\r\n\t\t\t\t\t\tpropName: baseLayer.propName.join(),\r\n\t\t\t\t\t},\r\n\t\t\t\t\tgeometriesColleccio: {\r\n\t\t\t\t\t\tid: baseLayer.id,\r\n\t\t\t\t\t\tbusinessId: baseLayer.businessId,\r\n\t\t\t\t\t\tnom: baseLayer.nom, \r\n\t\t\t\t\t\toptions: baseLayer.propName.join(),\r\n\t\t\t\t\t\tgeometryType: baseLayer.geometryType\r\n\t\t\t\t\t},\r\n\t\t\t\t\tentitat: null,  //<----\r\n\t\t\t\t\tgroup: {\r\n\t\t\t\t\t\tname: baseLayer.group.name, \r\n\t\t\t\t\t\tgroupName: baseLayer.group.groupName,\r\n\t\t\t\t\t\tid: baseLayer.group.id,\r\n\t\t\t\t\t\tz_order: baseLayer.group.z_order,\r\n\t\t\t\t\t\texpanded: baseLayer.group.expanded\r\n\t\t\t\t\t},\r\n\t\t\t\t\ttrafficLightKey : key,\r\n\t\t\t\t\ttrafficLightValue: value,\r\n\t\t\t\t\tpropName: baseLayer.propName.join()\r\n\t\t\t\t}),\r\n\t\t\t\tquery:null,\r\n\t\t\t\tserverName: key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + value + \")\",\r\n\t\t\t\tserverType: baseLayer.tipus,\r\n\t\t\t\ttiles:\"\",\r\n\t\t\t\ttitles:null,\r\n\t\t\t\ttransparency:\"\",\r\n\t\t\t\turl:\"\",\r\n\t\t\t\tversion:\"\",\r\n\t\t\t\tvisibilitat:\"O\"\r\n\t\t\t};\r\n\r\n\t\t\tnewLayer.options = newOptions.options;\r\n\t\t\tnewLayer.businessId = null; //<----\r\n\t\t\tnewLayer.geometriesBusinessId = baseLayer.businessId;\r\n\t\t\tnewLayer.geometryType = baseLayer.geometryType;\r\n\t\t\tnewLayer.id = null; //<----\r\n\t\t\tnewLayer.nom = newOptions.options.serverName;\r\n\t\t\tnewLayer.tipus = \"clasicTematic\";\r\n\t\t\tnewLayer.uid = null;//<----\r\n\r\n\t\t\t//Set the parentid property. If the baseLayer doesn't have it, look for it on \r\n\t\t\t//the layer control\r\n\t\t\tif(baseLayer.hasOwnProperty(\"leafletid\"))\r\n\t\t\t\tnewLayer.parentid = baseLayer.leafletid;\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\tvar keys = Object.keys(controlCapes._layers);\r\n\t\t\t\tvar trobat = false;\r\n\t\t\t\tvar key;\r\n\t\t\t\tfor(var i=0; i<keys.length && !trobat; ++i)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tkey = keys[i];\r\n\t\t\t\t\ttrobat = (controlCapes._layers[keys[i]].layer.options.businessId == baseLayer.businessId);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewLayer.parentid = key;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$.extend(layerOptions, newOptions);\r\n\r\n\t\t\treturn newLayer;\r\n\r\n\t\t},\r\n\r\n\t\t_setupTematicLayerDialog: function(layer, key, pivot, min, highestLowerValue, lowestHigherValue, max)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tif(self._isEditing)\r\n\t\t\t{\r\n\r\n\t\t\t\t//Set the category popup values to use its own click and do the\r\n\t\t\t\t//same process done on a 3 interval category\r\n\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"capamare\", {\r\n\t\t\t\t\tbusinessid: layer.options.businessId,\r\n\t\t\t\t\tfrom: layer.options.from,\r\n\t\t\t\t\tgeometrytype: layer.options.geometryType,\r\n\t\t\t\t\tleafletid: layer.options.leafletid,\r\n\t\t\t\t\tpropname: layer.options.propName.join(),\r\n\t\t\t\t\ttipus: layer.options.tipus\r\n\t\t\t\t});\r\n\r\n\t\t\t\tvar src;\r\n\t\t\t\tif (layer.options.geometryType == t_marker)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-punt-template\").html();\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse if (layer.options.geometryType == t_polyline)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-polyline-template\").html();\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\telse if (layer.options.geometryType == t_polygon)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tsrc = $(\"#tematic-values-semaforic-polygon-template\").html();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar template = Handlebars.compile(src);\r\n\t\t\t\t$(\"#rd_tipus_semaforic\").prop(\"checked\", true);\r\n\t\t\t\t$(\"#list_tematic_values\").html(template({values: [{index:0, v: {min: min, max: highestLowerValue}}, {index:1, v: {min: pivot, max: pivot}}, {index:2, v:{min: lowestHigherValue, max: max}}]}));\r\n\r\n\t\t\t\t$(\"#dialog_tematic_rangs\").data(\"rangs\", [{min: min, max: highestLowerValue}, {min: pivot, max: pivot}, {min: lowestHigherValue, max: max}]);\r\n\t\t\t\tshowTematicRangs(layer.options.geometryType);\r\n\t\t\t\t$(\"#dataField\").html(\"<option value=\\\"\" + key + \"\\\">\" + key + \"</option>\");\r\n\t\t\t\t$(\"#dataField\").val(key);\r\n\t\t\t\t$(\"#cmb_num_rangs\").val(3);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tself._showPaletteSelector();\r\n\r\n\t\t},\r\n\r\n\t\t_createScaleAux: function(paleta, rang, reversed)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar auxPaleta = paleta;\r\n\t\t\tif(\"carto\" == auxPaleta)\r\n\t\t\t{\r\n\r\n\t\t\t\tauxPaleta = self._cartoPaletteColors;\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn createScale(auxPaleta, rang, reversed);\r\n\r\n\t\t},\r\n\r\n\t\tsortGeometry: function(inStyles, key, pivot)\r\n\t\t{\r\n\r\n\t\t\tvar styles = inStyles;\r\n\t\t\tvar equalGeom = [];\r\n\t\t\tvar lowerGeom = []; \r\n\t\t\tvar higherGeom = [];\r\n\t\t\tvar highestLowerValue = Number.MIN_SAFE_INTEGER;\r\n\t\t\tvar lowestHigherValue = Number.MAX_SAFE_INTEGER;\r\n\t\t\tvar min = Number.MAX_SAFE_INTEGER;\r\n\t\t\tvar max = Number.MIN_SAFE_INTEGER;\r\n\r\n\t\t\t$.each(inStyles, function(i, estil) {\r\n\t\t\t\t$.each(estil.geometria.features, function(j, feature) {\r\n\r\n\t\t\t\t\tvar aux = feature;\r\n\t\t\t\t\tvar val = parseFloat(aux.properties[key]);\r\n\t\t\t\t\tmin = (min > val ? val : min);\r\n\t\t\t\t\tmax = (max < val ? val : max);\r\n\t\t\t\t\tif(val == pivot)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Equal color\r\n\t\t\t\t\t\tequalGeom.push(feature);\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(val < pivot)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Less than color\r\n\t\t\t\t\t\tlowerGeom.push(feature);\r\n\t\t\t\t\t\tif(val >= highestLowerValue)\r\n\t\t\t\t\t\t\thighestLowerValue = val;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse \r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Greater than color\r\n\t\t\t\t\t\thigherGeom.push(feature);\r\n\t\t\t\t\t\tif(val < lowestHigherValue)\r\n\t\t\t\t\t\t\tlowestHigherValue = val;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\treturn {\r\n\t\t\t\tlowerGeom: lowerGeom,\r\n\t\t\t\tequalGeom: equalGeom,\r\n\t\t\t\thigherGeom: higherGeom,\r\n\t\t\t\thighestLowerValue: highestLowerValue,\r\n\t\t\t\tlowestHigherValue: lowestHigherValue,\r\n\t\t\t\tmin: min, \r\n\t\t\t\tmax: max\r\n\t\t\t};\r\n\r\n\t\t},\r\n\r\n\t\t_renderFakeLayer: function(defer)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treadVisualitzacio($.Deferred(), self._previsualizationLayer, self._previsualizationLayerOptions).then(function(data) {\r\n\t\t\t\t//Desactivem la capa mare\r\n\t\t\t\tif ($( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).attr(\"checked\")!=undefined) $( \"#input-\" + self._previsualizationLayer.geometriesBusinessId).click();\r\n\t\t\t\tself._capaVisualitzacio = data;\r\n\t\t\t\tdefer.resolve(data._leaflet_id);\r\n\t\t\t\t$(\"#interactivePalette .ramp.carto\").click();\r\n\t\t\t});\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\r\n\t\t},\r\n\r\n\t\t_renderLayer: function(defer)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\treloadVisualitzacioLayer(self._capaVisualitzacio, self._previsualizationLayer, self._previsualizationLayerOptions, map);\r\n\t\t\tdefer.resolve(self._capaVisualitzacio._leaflet_id);\r\n\t\t\tcontrolCapes.forceUpdate(false);\r\n\r\n\t\t},\r\n\r\n\t\trender: function(defer, key, pivot, inLayer)\r\n\t\t{\t\t\t\r\n\r\n\t\t\tvar self = this;\r\n\t\t\t//Create each style and sort the geometry on each bucket\r\n\t\t\tvar rangColors = self._createScaleAux(self._palette, 3, self._isPaletteReversed);\r\n\t\t\tvar estilActual = [\r\n\t\t\t\trangColors(self._paletteColorSteps[0]).hex(), \r\n\t\t\t\trangColors(self._paletteColorSteps[1]).hex(), \r\n\t\t\t\trangColors(self._paletteColorSteps[2]).hex()\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\tvar layerOptions = {};\r\n\t\t\tvar layer = (null != self._previsualizationLayer ? self._previsualizationLayer : inLayer);\r\n\r\n\t\t\tvar sorted = self.sortGeometry(inLayer.options.estil, key, pivot);\r\n\t\t\tvar lowerStyle = self._createTrafficLightStyle(estilActual[0], 0, sorted.lowerGeom);\r\n\t\t\tvar equalStyle = self._createTrafficLightStyle(estilActual[1], 1, sorted.equalGeom);\r\n\t\t\tvar higherStyle = self._createTrafficLightStyle(estilActual[2], 2, sorted.higherGeom);\r\n\r\n\t\t\tif(null == self._previsualizationLayer)\r\n\t\t\t{\r\n\r\n\t\t\t\tself._setupTematicLayerDialog(layer, key, pivot, sorted.min, sorted.highestLowerValue, sorted.lowestHigherValue, sorted.max);\r\n\t\t\t\tlayer = self._createTempTrafficLightLayer(key, pivot, layer.options, layerOptions);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tlayer.estil = [lowerStyle, equalStyle, higherStyle];\r\n\t\t\t\r\n\t\t\t//Draw the layer\r\n\t\t\tif(null == self._previsualizationLayerOptions)\r\n\t\t\t{\r\n\r\n\t\t\t\tself._previsualizationLayerOptions = layerOptions;\r\n\t\t\t\tself._previsualizationLayer = layer;\r\n\t\t\t\tself._renderFakeLayer(defer);\t\t\t\t\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t//Update mapConfig legend if exists\r\n\t\t\t\tvar lowerThanLabel = key + window.lang.translate(\" menor de \") + pivot;\r\n\t\t\t\tvar equalToLabel = key + window.lang.translate(\" igual a \") + pivot;\r\n\t\t\t\tvar higherThanLabel = key + window.lang.translate(\" major de \") + pivot;\r\n\t\t\t\tif(self._capaVisualitzacio.hasOwnProperty(\"layer\"))\r\n\t\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\t\tself._updateMapLegend(layer, lowerThanLabel, equalToLabel, higherThanLabel);\r\n\t\t\t\t\tself._updateStyleRangeLegend(layer, lowerThanLabel, equalToLabel, higherThanLabel, \r\n\t\t\t\t\t\tlowerStyle, equalStyle, higherStyle, pivot);\r\n\r\n\t\t\t\t}\r\n\t\t\t\tself._renderLayer(defer);\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn defer.promise();\r\n\r\n\t\t},\r\n\r\n\t\t_updateStyleRangeLegend: function(layer, lowerThanLabel, equalToLabel, higherThanLabel, lowerStyle, equalStyle, higherStyle, pivot)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar aux = JSON.parse(layer.options);\r\n\t\t\taux.rangsEstilsLegend = {};\r\n\t\t\taux.rangsEstilsLegend[layer.estil[0].businessId] = lowerThanLabel;\r\n\t\t\taux.rangsEstilsLegend[layer.estil[1].businessId] = equalToLabel;\r\n\t\t\taux.rangsEstilsLegend[layer.estil[2].businessId] = higherThanLabel;\r\n\t\t\tlayer.options = JSON.stringify(aux);\r\n\t\t\tself._capaVisualitzacio.layer.options.rangsEstilsLegend = aux.rangsEstilsLegend;\r\n\t\t\tself._capaVisualitzacio.layer.options.estil = [lowerStyle, equalStyle, higherStyle];\r\n\r\n\t\t\t//Update the layer properties so they are saved when publishing\r\n\t\t\tself._capaVisualitzacio.layer.options.trafficLightValue = pivot;\r\n\t\t\tvar newName = self._getNewLayerName(self._capaVisualitzacio.name, pivot)\r\n\t\t\tself._capaVisualitzacio.layer.options.nom = newName;\r\n\t\t\tself._capaVisualitzacio.name = newName;\r\n\t\t\tvar aux = JSON.parse(self._previsualizationLayer.options);\r\n\t\t\taux.trafficLightValue = pivot;\r\n\t\t\tself._previsualizationLayer.options = JSON.stringify(aux);\r\n\r\n\t\t},\r\n\r\n\t\t_updateMapLegend: function(layer, lowerThanLabel, equalToLabel, higherThanLabel)\r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar _mapConfig = (\"undefined\" == typeof visor) ? mapConfig : visor._mapConfig;\r\n\t\t\tif(undefined != _mapConfig.legend && \"\" != _mapConfig.legend)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar auxLegend = JSON.parse(_mapConfig.legend);\r\n\t\t\t\tif(null != auxLegend)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tvar layerLegend;\r\n\t\t\t\t\tlayerLegend = auxLegend[self._capaVisualitzacio.layer.options.businessId];\r\n\r\n\t\t\t\t\tif(null != layerLegend)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t//Check which bucket is by its color (should we be using the style businessId?)\r\n\t\t\t\t\t\tvar lowerThanColor = hexToRgb(layer.estil[0].color);\r\n\t\t\t\t\t\tvar lowerThanFill = \"fill:rgb(\" + lowerThanColor.r +\", \" + lowerThanColor.g+ \", \"+lowerThanColor.b+\");\"\r\n\t\t\t\t\t\tvar equalToColor = hexToRgb(layer.estil[1].color);\r\n\t\t\t\t\t\tvar equalToFill = \"fill:rgb(\" + equalToColor.r +\", \" + equalToColor.g+ \", \"+equalToColor.b+\");\"\r\n\t\t\t\t\t\tvar higherThanColor = hexToRgb(layer.estil[2].color);\r\n\t\t\t\t\t\tvar higherThanFill = \"fill:rgb(\" + higherThanColor.r +\", \" + higherThanColor.g+ \", \"+higherThanColor.b+\");\"\r\n\t\t\t\t\t\tfor(var i=0; i<layerLegend.length; ++i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(-1 != layerLegend[i].symbol.indexOf(lowerThanFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = lowerThanLabel;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(-1 != layerLegend[i].symbol.indexOf(equalToFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = equalToLabel;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse if(-1 != layerLegend[i].symbol.indexOf(higherThanFill))\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tlayerLegend[i].name = higherThanLabel;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif(\"undefined\" == typeof visor)\r\n\t\t\t\t\t\t\tmapConfig = JSON.stringify(auxLegend);\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tvisor._mapConfig.legend = JSON.stringify(auxLegend);\r\n\t\t\t\t\t\tmapLegend = auxLegend;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t},\r\n\r\n\t\t_getNewLayerName: function(oldName, pivot)\r\n\t\t{\r\n\r\n\t\t\t//If the name contains the \"Reference value\" string, update it with the new value\r\n\t\t\tvar newName = oldName;\r\n\t\t\tvar refString = window.lang.translate(\"(Valor de ref: \");\r\n\t\t\tvar indexValor = oldName.indexOf(refString);\r\n\t\t\tif(-1 !== indexValor)\r\n\t\t\t{\r\n\t\t\t\t\r\n\t\t\t\tnewName = oldName.substring(0, indexValor+refString.length) + pivot + \")\";\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn newName;\r\n\r\n\t\t},\r\n\r\n\t\t_updateFakeLayer: function() \r\n\t\t{\r\n\r\n\t\t\tvar self = this;\r\n\t\t\tvar scale = self._createScaleAux(self._palette, 3, self._isPaletteReversed);\r\n\t\t\tself._previsualizationLayer.estil[0].color = scale(self._paletteColorSteps[0]).hex();\r\n\t\t\tself._previsualizationLayer.estil[1].color = scale(self._paletteColorSteps[1]).hex();\r\n\t\t\tself._previsualizationLayer.estil[2].color = scale(self._paletteColorSteps[2]).hex();\r\n\r\n\t\t\t//Removes the additional data from the map.\r\n\t\t\treloadVisualitzacioLayer(self._capaVisualitzacio, self._previsualizationLayer, self._previsualizationLayerOptions, map);\r\n\r\n\t\t},\r\n\r\n\t\tsetVisualization: function(vis)\r\n\t\t{\r\n\r\n\t\t\tthis._capaVisualitzacio = vis;\r\n\r\n\t\t},\r\n\r\n\t\tsetLayer: function(layer)\r\n\t\t{\r\n\r\n\t\t\tthis._previsualizationLayer = layer;\r\n\r\n\t\t},\r\n\r\n\t\tsetLayerOptions: function(options)\r\n\t\t{\r\n\r\n\t\t\tthis._previsualizationLayerOptions = options;\r\n\r\n\t\t},\r\n\r\n\t\tsetPalette: function(palette, isReversed)\r\n\t\t{\r\n\r\n\t\t\tthis._palette = palette;\r\n\t\t\tthis._isPaletteReversed = isReversed;\r\n\r\n\t\t},\r\n\r\n\t};\r\n\t\r\n\tSemaforic._init = function(isEditing){\r\n\r\n\t\tvar self = this;\r\n\r\n\t\tself._isEditing = (\"undefined\" !== typeof isEditing && isEditing)\r\n\t\tself._previsualizationLayer = null;\r\n\t\tself._previsualizationLayerOptions = null;\r\n\t\tself._isInitialized = true;\r\n\t\tself._capaVisualitzacio = null;\r\n\r\n\t\tself._isPaletteDialogCreated = ( 0 != $(\"#interactivePalette\").length);\r\n\t\tif(self._isPaletteDialogCreated && self._isEditing)\r\n\t\t{\r\n\r\n\t\t\t//Get the parameters from the palette dialog\r\n\t\t\tself._isPaletteReversed = $(\"#dialog_tematic_rangs\").data(\"reverse\");\r\n\t\t\tself._palette = $(\"#dialog_tematic_rangs\").data(\"paleta\");\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tself._isPaletteReversed = false;\r\n\t\t\tself._palette = \"carto\";\r\n\r\n\t\t}\r\n\r\n\t\t$(\"#cbSoftColors\").iCheck('uncheck');\r\n\t\tself._useSoftColors = false;\r\n\t\tself._paletteColorSteps = [0, 1.5, 3];\r\n\t\tself._cartoPaletteColors = [\"#00a84b\", \"#e2e174\", \"#cc0001\"];\r\n\r\n\t\treturn this;\r\n\t}\r\n\t\r\n\tSemaforic._init.prototype = Semaforic.prototype;\r\n\tSemaforic.sortGeometry = Semaforic.prototype.sortGeometry;\r\n\tSemaforic.getUpdatedLayerName = Semaforic.prototype._getNewLayerName;\r\n\tglobal.Semaforic = Semaforic;\r\n\t\r\n}(window, jQuery));","/**\n * Gestio del temàtic de tipus Basic \n */\n\nfunction createTematicLayerBasic(tematic, styles){\n\tvar defer = $.Deferred();\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'basic', 1]});\n\t\n\t\n\tvar rangs = getRangsFromStyles(tematic, styles);\n\tvar capaMare = controlCapes._layers[tematic.leafletid].layer;\n\t\n\n\t\n\tif(capaMare.options.tipus == t_dades_obertes){\n\t\tvar data1 = {\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t}\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tloadDadesObertesLayer(data.results);\n\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error creant el temàtic bàsic\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error creant el temàtic bàsic\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\tvar options = {\n\t\t\t\t\t\tdataset: capaMare.options.dataset,\n\t\t\t\t\t\ttem: tem_simple,\n\t\t\t\t\t\tstyle: rangs[0],\n\t\t\t\t\t\torigen: capaMare.options.businessId\n\t\t\t\t\t};\n\t\t\t\t\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\t\tserverType: capaMare.options.tipus,\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t        activas: true,\n\t\t\t\t        visibilitats: true,\n\t\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\n\t\t\t\t        epsg: '4326',\n\t\t\t\t        imgFormat: 'image/png',\n\t\t\t\t        infFormat: 'text/html',\n\t\t\t\t        tiles: true,\t            \n\t\t\t\t        transparency: true,\n\t\t\t\t        opacity: 1,\n\t\t\t\t        visibilitat: 'O',\n\t\t\t\t\t\toptions: JSON.stringify(options),\n\t\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\t\ttipusTematic:\"t_dades_obertes\",\n\t\t\t\t\t\turlTematic:paramUrl.createServidorInMap\n\t\t\t\t\t};\n\t\t\t\n\t\t\t\tcallActions(data);\n\t\t\t\t//createServidorInMap(data);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\n\t\t\t/*.then(function(results){\n\t\t\t\tbusy=false;\n\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\tif (results.status=\"OK\") {\n\t\t\t\t\tloadDadesObertesLayer(results.results);\n\t\t\t\t}\t\t\n\t\t\t\n\t\t\t});*/\n\t\t });\n\t\t\n\t}else if(capaMare.options.tipus == t_url_file){\n\t\tvar data1 = {\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t}\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =1000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tloadURLfileLayer(data.results).then(function(results){\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\tvar estil_do = capaMare.options.estil_do;\n\t\t\t\t\n\t\t\t\tif(capaMare.options.geometryType.indexOf(\"line\")!=-1){\n\t\t\t\t\trangs[0].weight = rangs[0].lineWidth;\n\t\t\t\t\t\n\t\t\t\t}else if(capaMare.options.geometryType.indexOf(\"polygon\")!=-1){\n\t\t\t\t\t\n\t\t\t\t\t var polygonStyle = rangs[0];//getPolygonRangFromStyle(canvas_pol);\n\t\t\t\t\t rangs[0].weight = polygonStyle.borderWidth;//lineWidth;\n\t\t\t\t\t rangs[0].fillColor = polygonStyle.color;\n\t\t\t\t\t rangs[0].color = polygonStyle.borderColor;\n\t\t\t\t\t rangs[0].fillOpacity = polygonStyle.opacity/100; \n\t\t\t\t\t rangs[0].opacity = 1;\t\t\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tvar markerStyle2 = rangs[0];\n\t\t\t\t\trangs[0].fillColor = markerStyle2.color;\n\t\t\t\t\trangs[0].color = markerStyle2.borderColor;\n\t\t\t\t\trangs[0].fillOpacity = 1;\n\t\t\t\t\trangs[0].opacity = 1;\n\t\t\t\t\trangs[0].radius = markerStyle2.simbolSize;\n\t\t\t\t\trangs[0].weight = markerStyle2.borderWidth;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvar options = {\n\t\t\t\t\turl: capaMare.options.url,\n\t\t\t\t\ttem: tem_simple,\n\t\t\t\t\tstyle: rangs[0],\n\t\t\t\t\torigen: capaMare.options.businessId,\n\t\t\t\t\ttipus : t_url_file,\n\t\t\t//\t\tbusinessId : '-1',\n\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\n\t\t\t\t\testil_do: rangs[0],\n\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\n\t\t\t\t\tgeometryType: capaMare.options.geometryType,\n\t\t\t\t\tcolX: capaMare.options.colX,\n\t\t\t\t\tcolY: capaMare.options.colY,\n\t\t\t\t\tdinamic: capaMare.options.dinamic\n\t\t\t\t};\n\t\t\t\n\t\t\t//\tconsole.debug(options);\n\t\t\t\t\n\t\t\t\tvar data = {\n\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\tserverType: capaMare.options.tipus,\n\t\t\t\t\tcalentas: false,\n\t\t\t        activas: true,\n\t\t\t        visibilitats: true,\n\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\n\t\t\t        epsg: capaMare.options.epsgIN,\n\t\t\t//        imgFormat: 'image/png',\n\t\t\t//        infFormat: 'text/html',\n\t\t\t//        tiles: true,\t            \n\t\t\t        transparency: true,\n\t\t\t        opacity: 1,\n\t\t\t        visibilitat: 'O',\n\t\t\t        url: capaMare.options.url,\n\t\t\t\t\toptions: JSON.stringify(options),\n\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\ttipusTematic:\"t_url_file\",\n\t\t\t\t\turlTematic:paramUrl.createServidorInMap\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\tcallActions(data);\n\t\t\t\t/*createServidorInMap(data);.then(function(results){\n\t\t\t\t\tbusy=false;\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\tif (results.status=\"OK\") {\n\t\t\t\t\t\tloadURLfileLayer(results.results).then(function(results){\t\t\t\t\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});*/\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\t\n\n\t\t\t\n\t\t });\n\t\t\n\t\t\n\t}else if(capaMare.options.tipus == t_json){\n\n\t\tvar data1 = {\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t}\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tloadCapaFromJSON(data.results).then(function(results){\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\tvar capaMareOptions = capaMare.options.options;\n\t\t\t\tvar data = {\n\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\tserverName: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\tserverType: t_json,\n\t\t\t\t\tcalentas: false,\n\t\t\t        activas: true,\n\t\t\t        visibilitats: true,\n\t\t\t        order: capesOrdre_sublayer,\n\t\t\t        epsg: '4326',\n\t\t\t        imgFormat: 'image/png',\n\t\t\t        infFormat: 'text/html',\n\t\t\t        tiles: true,\t            \n\t\t\t        transparency: true,\n\t\t\t        opacity: 1,\n\t\t\t        visibilitat: 'O',\n\t\t\t        url: capaMare.options.url,//Provar jQuery(\"#txt_URLJSON\")\n\t\t\t        calentas: false,\n\t\t\t        activas: true,\n\t\t\t        visibilitats: true,\n\t\t\t        options: '{\"origen\":\"'+capaMare.options.businessId+'\",\"tem\":\"'+tem_simple+'\",\"x\":\"'+capaMareOptions.x+'\", \"y\":\"'+capaMareOptions.y+'\",\"titol\":\"'+capaMareOptions.titol+'\",\"descripcio\":\"'+capaMareOptions.descripcio+'\", \"imatge\":\"'+capaMareOptions.imatge+'\",\"vincle\":\"'+capaMareOptions.vincle+'\",\"estil_do\":{\"radius\":\"'+styles.options.radius+'\",\"fillColor\":\"'+styles.options.fillColor+'\",\"color\":\"'+styles.options.color+'\",\"weight\":\"'+styles.options.weight+'\",\"opacity\":\"'+styles.options.opacity+'\",\"fillOpacity\":\"'+styles.options.fillOpacity+'\",\"isCanvas\":\"'+styles.options.isCanvas+'\"}}',\n\t\t\t        tmpFilePath: tmpFile,\n\t\t\t\t\ttipusTematic:\"t_json\",\n\t\t\t\t\turlTematic:paramUrl.createServidorInMap\n\t\t\t\t};\t\t\n\t\t\t\t\n\t\t\t\tcallActions(data);\n\t\t\t\t/*createServidorInMap(data);.then(function(results){\n\t\t\t\t\tbusy=false;\n\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\tif (results.status=\"OK\") {\n\t\t\t\t\t\tloadCapaFromJSON(results.results).then(function(results){\t\t\t\t\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});*/\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\t\n\t\t });\n\t\t\n\t}else if (tematic.tipus == t_tematic){\n\t\tvar data1 = {\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t}\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tloadTematicLayer(data.results);\n\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\t rangs = JSON.stringify({rangs:rangs});\n\t\t\t\t\t\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tbusinessId: tematic.businessid,\n\t\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t        mapBusinessId: url('?businessid'),\t           \n\t\t\t\t        nom: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t        activas: true,\n\t\t\t\t        visibilitats: true,    \n\t\t\t\t        order: capesOrdre_sublayer,\n\t\t\t\t\t\ttipusRang: tematic.from,\n\t\t\t\t\t\trangs: rangs,\n\t\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\t\ttipusTematic:\"t_tematic\",\n\t\t\t\t\t\turlTematic:paramUrl.duplicateTematicLayer\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tcallActions(data);\n\t\t\t\t\t/*\n\t\t\t\t\tduplicateTematicLayer(data);/*.then(function(results){\n\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\tloadTematicLayer(results.results);\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t}\n\t\t\t\t\t});*/\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\t\n\t\t });\n\t//NOU MODEL\t\n\t}else if (tematic.tipus == t_visualitzacio){\n\t\tvar data1 = {\n\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t}\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant temàtic bàsic')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Temàtic bàsic creat')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\t\t\t\t\n\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tbusy=false;\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\tvar data = {\n\t\t\t\t\t\tbusinessId: tematic.businessid,//businessId id de la visualización de origen\n\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t        mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t        nom: capaMare.options.nom+\" \"+window.lang.translate(\"Bàsic\"),//nom nombre de la nueva visualizacion\n\t\t\t\t        activas: true,\n\t\t\t\t        order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\t\ttem: tematic.from,//tem_simple\n\t\t\t\t        estils: JSON.stringify(rangs[0]),\n\t\t\t\t        tmpFilePath: tmpFile,\n\t\t\t\t\t\ttipusTematic:\"t_visualitzacio\",\n\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioSimple  \n\t\t\t\t        \n\t\t\t\t\t};\t\n\t\t\t\t\t\n\t\t\t\tcallActions(data);\n\t\t\t\t\t/*createVisualitzacioSimple(data);/*.then(function(results){\n\t\t\t\t\t\tbusy=false;\t\t\t\t\t\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\t\t\tvar defer = $.Deferred();\t\t\t\t\n\t\t\t\t\t\t\treadVisualitzacio(defer, results.visualitzacio, results.layer).then(function(results){\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\t\t\n\t\t\t\t\t });\t*/\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\trangs = JSON.stringify({rangs:rangs});\n\t\n\t\t\n\t\t\n\t});\n\t\n}\n\treturn defer.promise();\t\n}","/**\n * Gestio del temàtic de tipus Categories \n */\n\nfunction showModalTematicCategories(data){\n\t//console.debug(\"showModalTematicCategories\");\n\tjQuery('.modal').modal('hide');\n\tjQuery('#dialog_tematic_rangs').modal('show');\n\t\n\t//se ponen los off para evitar el doble evento\n\t//TODO hay que revisar como evitar el doble evento.\n\tjQuery('#dialog_tematic_rangs .btn-success').off('click');\n\tjQuery('#dialog_tematic_rangs .btn-success').on('click',function(e){\n\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\tjQuery('#info_uploadFile').show();\n\t\tbusy=true;\n\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\n\t\t);\t\n\t\tcreateTematicLayerCategories(e);\n\t});\t\n\t\n\tjQuery('#palet_warning').hide();\n\t\n\tjQuery(\".ramp\").off('click');\n\tjQuery(\".ramp\").on('click',function(evt){\n\t\tvar _this = jQuery(this);\n\t\tvar brewerClass = _this.attr('class').replace(\"ramp \",\"\");\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"paleta\", brewerClass);\n\t\tif (jQuery('#list_tematic_values').html() !== \"\"){\n\t\t\tupdatePaletaRangs();\n\t\t}\n\t});\n\t\n\tjQuery(\"#dialog_tematic_rangs\").data(\"capamare\", data);\n\t\n\tjQuery('#tipus_agrupacio_grp').hide();\n\tjQuery('#num_rangs_grp').hide();\n\tjQuery('#list_tematic_values').html(\"\");\n\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\n\tjQuery('.btn-reverse-palete').off('click');\n\tjQuery('.btn-reverse-palete').on('click',function(evt){\n\t\tvar glyp = jQuery('.btn-reverse-palete.glyphicon');\n\t\tvar reverse = false;\n\t\tif(glyp.hasClass('glyphicon-arrow-down')){\n\t\t\treverse = true;\n\t\t\tglyp.removeClass('glyphicon-arrow-down').addClass('glyphicon-arrow-up');\n\t\t}else{\n\t\t\treverse = false;\n\t\t\tglyp.removeClass('glyphicon-arrow-up').addClass('glyphicon-arrow-down');\n\t\t}\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"reverse\",reverse);\n\t\t//console.debug(jQuery(\"#dialog_tematic_rangs\").data(\"reverse\"));\n\t\tif (jQuery('#list_tematic_values').html() !== \"\"){\n\t\t\tupdatePaletaRangs();\n\t\t}\n\t});\n\t\n\tvar dataTem={\n\t\tbusinessId: data.businessid,\n\t\tuid: Cookies.get('uid')\n\t};\n\t\n\tif(data.tipus == t_url_file){\n\t\tvar urlFileLayer = controlCapes._layers[data.leafletid].layer;\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\", urlFileLayer.options);\n\t\tvar fields = {};\n\t\t//fields[window.lang.translate('Escull el camp')] = '---';\n\t\t//Recollim propName de les geometries de la capa\n\t\tvar dataNames = urlFileLayer.options.propName.split(',');\n\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\tfields[value] = value;\n\t\t});\n\t\t//creamos el select con los campos\n\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\n\t\tvar template1 = Handlebars.compile(source1);\n\t\tvar html1 = template1({fields:fields});\n\t\tjQuery('#dataField').html(html1);\n\t\t\n\t\tjQuery('#dataField').off('change');\n\t\tjQuery('#dataField').on('change',function(e){\n\t\t\tvar this_ = jQuery(this);\n\t\t\tif (this_.val() == \"---\"){\n\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\n\t\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t}else{\t\t\t\t\n\t\t\t\treadDataUrlFileLayer(urlFileLayer, this_.val()).then(function(results){\n\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\n\t\t\t\t\tgetTipusValuesVisualitzacio(results,data.geometrytype);\n\t\t\t\t});\t\t\t\n\t\t\t}\n\t\t});\t\t\t\n\t\t\n\t}else{\n\t\tvar dataNames = [];\n\t\tvar fields = {};\n\t\t//fields[window.lang.translate('Escull el camp')] = '---';\n\t\tdataNames = data.propname.split(',');\n\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\tif (value!='') \tfields[value] = value;\n\t\t});\n\t\tif(data.propname=='null' || data.propname==''){\n\t\t\tfields['nom']='nom';\n\t\t\tfields['text']='text';\n\t\t}\n\t\t\n\t\t//creamos el select con los campos\n\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\n\t\tvar template1 = Handlebars.compile(source1);\n\t\t\n\t\t\n\t\tvar html1 = template1({fields:fields});\n\t\tjQuery('#dataField').html(html1);\n\t\t\n\t\tjQuery('#dataField').off('change');\n\t\tjQuery('#dataField').on('change',function(e){\n\t\t\tvar this_ = jQuery(this);\n\t\t\tif (this_.val() == \"---\"){\n\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\n\t\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t}else{\n\t\t\t\tvar dataVis={\n\t\t\t\t\t\tbusinessId1: data.businessid,\n\t\t\t\t\t\tkey: this_.val(),\n\t\t\t\t\t\tuid: Cookies.get('uid')\n\t\t\t\t};\n\t\t\t\tgetValuesFromKeysProperty(dataVis).then(function(results){\n\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\n\t\t\t\t\tgetTipusValuesVisualitzacio(results);\t\t\t\t\t\n\t\t\t\t});\n\t\t\t}\n\t\t});\t\n\t\t\n\t\t//Si es una visualitzacio\n\t\t/*getVisualitzacioByBusinessId(dataTem).then(function(results){\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\tvar visualitzacio = results.results;\n\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\", visualitzacio);\n\t\t\t\tvar fields = {};\n\t\t\t\tfields[window.lang.translate('Escull el camp')] = '---';\n\t\t\t\tvar dataNames = [];\n\t\t\t\tif (visualitzacio.options){\n\t\t\t\t\t//var options = JSON.parse(visualitzacio.options);\n\t\t\t\t\tvar options;\n\t\t\t\t\tif(typeof (visualitzacio.options)==\"string\"){\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\toptions = JSON.parse(visualitzacio.options);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\toptions = visualitzacio.options;\t\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\t\n\t\t\t\t\t\toptions = visualitzacio.options;\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(options.propName){\n\t\t\t\t\t\tdataNames = options.propName.split(',');\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\t\t\t\t\tfields[value] = value;\n\t\t\t\t\t\t});\n\t\t\t\t\t}else{\n\t\t\t\t\t\tif (results.geometries && results.geometries.options){\n\t\t\t\t\t\t\tdataNames = results.geometries.options.split(',');\n\t\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\t\t\t\t\t\tfields[value] = value;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tif (results.geometries && results.geometries.options){\n\t\t\t\t\t\tdataNames = results.geometries.options.split(',');\n\t\t\t\t\t\tjQuery.each(dataNames, function( index, value ) {\n\t\t\t\t\t\t\tfields[value] = value;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t//creamos el select con los campos\n\t\t\t\tvar source1 = jQuery(\"#tematic-layers-fields\").html();\n\t\t\t\tvar template1 = Handlebars.compile(source1);\n\t\t\t\tvar html1 = template1({fields:fields});\n\t\t\t\tjQuery('#dataField').html(html1);\n\t\t\t\t\n\t\t\t\tjQuery('#dataField').off('change');\n\t\t\t\tjQuery('#dataField').on('change',function(e){\n\t\t\t\t\tvar this_ = jQuery(this);\n\t\t\t\t\tif (this_.val() == \"---\"){\n\t\t\t\t\t\tjQuery('#tipus_agrupacio_grp').hide();\n\t\t\t\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t\t\t}else{\n\t\t\t\t\t\treadDataVisualitzacio(visualitzacio, this_.val()).then(function(results){\n\t\t\t\t\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values\", results);\n\t\t\t\t\t\t\tgetTipusValuesVisualitzacio(results);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t}\n\t\t\t\t});\t\t\t\t\n\t\t\t}else{\n\t\t\t\t//TODO error\n\t\t\t\tconsole.debug(\"getVisualitzacioByBusinessId ERROR\");\t\t\t\t\n\t\t\t}\n\t\t},function(results){\n\t\t\t//TODO error\n\t\t\tconsole.debug(\"getVisualitzacioByBusinessId ERROR\");\n\t\t});\t*/\n\t}\n\t\t\t\t\n}\n\nfunction getTipusValuesVisualitzacio(results,geomType){\n\t//console.debug(\"getTipusValuesVisualitzacio\");\n\tvar resultats;\n\tif (results.valors!=undefined) resultats=results.valors;\n\telse resultats=results;\n\t\n\tvar geometryType;\n\tif (results.geomType!=undefined) geometryType=results.geomType;\n\telse geometryType=geomType;\n\n\t\n\tif (resultats.length === 0){\n\t\tvar warninMSG=\"<div class='alert alert-danger'><strong>\"+window.lang.translate('Aquest camp no te valors')+\"<strong>  <span class='fa fa-warning sign'></span></div>\";\n\t\tjQuery('#list_tematic_values').html(warninMSG);\n\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t}else{\n\t\tvar nodata = [];\n\t\tvar esText = false;\n\t\tvar arr = jQuery.grep(resultats, function( n, i ) {\n\t\t\tvar isText = false;\n\t\t\tif (!jQuery.isNumeric(n)){\n\t\t\t\tif (n == \"Sense valor\" || n == \"Sin valor\" || n == \"Empty value\" || n == NODATA_VALUE){\n\t\t\t\t\tnodata.push(n);\n\t\t\t\t}else{\n\t\t\t\t\tisText = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn isText;\n\t\t});\n\t\tif (nodata.length !== 0){\n\t\t\tjQuery(\"#dialog_tematic_rangs\").data(\"nodata\",true);\n\t\t}\n\t\tif (arr.length === 0){ //rangos o semafòric\n\t\t\tjQuery('#tipus_agrupacio_grp').show();\n\t\t\tjQuery('#num_rangs_grp').show();\n\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\n\t\t\tjQuery( \"input:radio[name=rd_tipus_agrupacio]\").on('change',function(e){\n\t\t\t\tvar this_ = jQuery(this);\n\t\t\t\tif (this_.val() == \"U\"){\n\t\t\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\t\t\tshowVisualitzacioDataUnic(resultats,geometryType).then(function(results1){\n\t\t\t\t\t\tloadTematicValueTemplate(results1,'unic');\n\t\t\t\t\t});\n\t\t\t\t}else if(this_.val() == \"S\") {\n\t\t\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\t\t\tcreateSemaforicValues(geometryType);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t\t\tjQuery('#num_rangs_grp').show();\n\t\t\t\t\tjQuery('#cmb_num_rangs').val(\"---\");\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\tjQuery('#cmb_num_rangs').on('change',function(e){\n\t\t\t\tvar this_ = jQuery(this);\n\t\t\t\tif (this_.val() == \"---\"){\n\t\t\t\t\tjQuery('#list_tematic_values').html(\"\");\n\t\t\t\t\tjQuery('#dialog_tematic_rangs .btn-success').hide();\n\t\t\t\t}else{\n\t\t\t\t\tcreateRangsValues(this_.val(),geometryType);\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\tjQuery('#rd_tipus_rang').click().change();\t\t\n\t\t}else{ //unicos\n\t\t\tjQuery('#tipus_agrupacio_grp').hide();\n\t\t\tjQuery('#num_rangs_grp').hide();\n\t\t\tshowVisualitzacioDataUnic(resultats,geometryType).then(function(results1){\n\t\t\t\tloadTematicValueTemplate(results1,'unic');\n\t\t\t});\n\t\t}\n\t}\n}\n\nfunction showVisualitzacioDataUnic(values,geomType){\n\tvar defer = jQuery.Deferred();\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\n\tjQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\",\"unic\");\n\t//Ordenar valores\n\tvalues.sort(sortByValueMax);\n\t//console.debug(paleta);\n\tpaleta = paleta ? paleta : 'Paired';\n\t//console.debug(values.length);\n\tvar scale = createScale(paleta, values.length, reverse);\t\n\tvar ftype = transformTipusGeometry(geomType);\t\n\tvar valuesStyle = jQuery.map( values, function( a, i) {\n\t\t//console.debug(createIntervalStyle(i,ftype,scale));\n\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale), index: i};\n\t});\n\tdefer.resolve(valuesStyle);\n\treturn defer.promise();\n}\n\nfunction createIntervalStyle(index, geometryType, paleta, nodata){\n\t//console.debug(\"createIntervalStyle\");\n\tvar defStyle;\n\tvar ftype = transformTipusGeometry(geometryType);\n\t\t\n\tif (ftype == t_marker){\n\t\tdefStyle = jQuery.extend({}, default_circulo_style);\n\t\tdefStyle.fillColor = paleta(index).hex();\n\t\tif(nodata){\n\t\t\tdefStyle.fillColor = NODATA_COLOR;\n\t\t}\n\t\tdefStyle.isCanvas = true;\t\t\n\t}else if (ftype == t_polyline){\n\t\tdefStyle = jQuery.extend({}, default_line_style);\n\t\tdefStyle.color = paleta(index).hex();\n\t\tif(nodata){\n\t\t\tdefStyle.color = NODATA_COLOR;\n\t\t}\n\t}else if (ftype == t_polygon){\n\t\tdefStyle = jQuery.extend({}, default_area_style);\n\t\tdefStyle.color = paleta(index).hex();\n\t\tif(nodata){\n\t\t\tdefStyle.color = NODATA_COLOR;\n\t\t}\n\t}\n\tdefStyle.geometryType = ftype;\n\treturn defStyle;\n}\n\nfunction showTematicRangs(geomType){\n\t//TODO cambiar nombre a la funcion\n\t//console.debug(\"showTematicRangs\");\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"rangs\");\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\n\tjQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\",\"rangs\");\n\tpaleta = paleta ? paleta : 'Paired';\n\tvar scale = createScale(paleta, values.length, reverse);\n\t\t\t\n\tvar defer = jQuery.Deferred();\n\tvar valuesStyle = [];\n\tvar ftype = transformTipusGeometry(geomType);\n\tvaluesStyle = jQuery.map( values, function( a, i ) {\n\t\tif (a.nodata){\n\t\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale,true), index: i};\n\t\t}else{\n\t\t\treturn {v: a, style: createIntervalStyle(i,ftype,scale,false), index: i};\n\t\t}\n\t});\n\tdefer.resolve(valuesStyle);\n\treturn defer.promise();\n}\n\nfunction div2RangStyle(tematic, tdElem){\n\t//console.debug(\"div2RangStyle\");\n\tvar rangStyle;\n\t\n\tvar ftype = transformTipusGeometry(tematic.geometrytype);\n\tvar divElement;\t\n\tif (ftype == t_marker){\n\t\tdivElement = tdElem.find('div');\n\t\trangStyle = {\n\t\t\tborderColor :  \"#ffffff\",\n\t\t\tborderWidth :  2,\n\t\t\tsimbolSize: parseInt(parseInt(divElement.css('height'))/2.4),\n\t\t\tcolor: jQuery.Color(divElement.css('background-color')).toHexString(),\n\t\t\topacity: 90\n\t\t};\n\t}else if (ftype == t_polyline){\n\t\tdivElement = tdElem.find('canvas')[0].getContext(\"2d\");\n\t\trangStyle = {\n\t\t\tlineWidth :  divElement.lineWidth,\n\t\t\tcolor: divElement.strokeStyle,\n\t\t};\n\t}else if (ftype == t_polygon){\n\t\tdivElement = tdElem.find('canvas')[0].getContext(\"2d\");\n\t\trangStyle = {\n\t\t\tborderColor :  divElement.strokeStyle,\n\t\t\tborderWidth :  divElement.lineWidth,\n\t\t\tcolor: jQuery.Color(divElement.fillStyle).toHexString(),\n\t\t\topacity: Math.round(jQuery.Color(divElement.fillStyle).alpha()*100)\t\t\n\t\t};\n\t}\n\treturn rangStyle;\n}\n\nfunction createTematicLayerCategories(event, extraOptions, extraData, deferred){\n//\tconsole.debug(\"createTematicLayerCategories\"); //al guardar\n\t$.publish('analyticsEvent',{event:['mapa', tipus_user+'estils', 'categories', 1]});\n\tconsole.info(\"ok\");\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\n\tvar tipusRang = $(\"input:radio[name=rd_tipus_agrupacio]:checked\").val();\n//\tvar visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\n//\tconsole.debug(visualitzacio);\n\tvar tematicFrom = jQuery(\"#dialog_tematic_rangs\").data(\"capamare\");\n\tvar capaMare = controlCapes._layers[tematicFrom.leafletid].layer;\n\tvar rangsTr = jQuery('#list_tematic_values tbody tr');\n\n\tvar rangs = [];\n\tvar layerName = capaMare.options.nom+\" \"+window.lang.translate(\"Categories\");\n\t\n\tif(\"S\" != tipusRang)\n\t{\n\n\t\tjQuery.each(rangsTr, function( index, value ) {\n\t\t\tvar _this = jQuery(value);\n\t\t\tvar tdRang, tdMin, tdMax;\n\t\t\tvar tdVal;\n\t\t\tvar rang = {};\n\t\t\tvar rangEstil;\n\t\t\tif (_this.children().length == 2){\n\t\t\t\ttdRang = _this.find('td:eq(0)');\n\t\t\t\t//console.debug(tdRang);\n\t\t\t\ttdVal = _this.find('td:eq(1)');\n\t\t\t\t//console.debug(tdVal);\n\t\t\t\trangEstil = div2RangStyle(tematicFrom, tdVal);\n\t\t\t\trang.estil = rangEstil;\n\t\t\t\trang.valueMax = tdRang.text();\n\t\t\t\trang.valueMin = tdRang.text();\n\t\t\t\trangs.push(rang);\n\t\t\t}else{\n\t\t\t\ttdMin = _this.find('td:eq(0)');\n\t\t\t\ttdMax = _this.find('td:eq(1)');\n\t\t\t\ttdVal = _this.find('td:eq(2)');\n\t\t\t\t//console.debug(tdMin);\n\t\t\t\t//console.debug(tdMax);\n\t\t\t\t//console.debug(tdVal);\n\t\t\t\trangEstil = div2RangStyle(tematicFrom, tdVal);\n\t\t\t\trang.estil = rangEstil; \n\t\t\t\trang.valueMin = tdMin.find('input').val();\n\t\t\t\trang.valueMax = tdMax.find('input').val();\n\t\t\t\trangs.push(rang);\n\t\t\t}\n\t\t});\n\n\t}\n\telse\n\t{\n\n\t\tvar auxRangs = $(\"#dialog_tematic_rangs\").data(\"rangs\");\n\t\t$.each(auxRangs, function(index, value)\n\t\t{\n\n\t\t\tvar rang = {};\n\t\t\trang.estil = div2RangStyle(tematicFrom, $(rangsTr[index]).find(\"td:last\"));\n\t\t\trang.valueMin = value.min;\n\t\t\trang.valueMax = value.max;\n\t\t\trangs.push(rang);\n\n\t\t});\n\n\t\tvar key = $(\"#dataField\").val();\n\t\tlayerName = key + \" \" + window.lang.translate(\"Escala de color\") + \" \" + window.lang.translate(\"(Valor de ref: \") + auxRangs[1].min + \")\";\n\t\textraData = {trafficLightKey: key, trafficLightValue: auxRangs[1].min, trafficLightLowerColor: rangs[0].estil.color, \n\t\t\ttrafficLightEqualColor: rangs[1].estil.color, trafficLightHigherColor: rangs[2].estil.color};\n\n\t}\n\t//console.debug(rangs);\n\tvar estils = {\n\t\testils: rangs,\n\t\tdataField: jQuery('#dataField').val().toLowerCase(),\n\t\tlabelField: jQuery('#dataField').val().toLowerCase()\n\t};\n\tvar data1 = {};\n\tif(capaMare.tipus == t_url_file || tematicFrom.tipus==t_url_file){\n\t\tdata1 = {\n\t\t\tuid: Cookies.get('uid'),\n\t\t\tbusinessId1: capaMare.options.businessId\n\t\t};\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\") || data.status.indexOf(\"PAS 3\"))!=-1 && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tloadURLfileLayer(data.results).then(function(results){\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t\t//L'afegim a les dades guardades\n\t\t\t\t\t\t\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers = {};\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._options = {};\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers[data.layer.businessId] = data.visualitzacio;\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._options[data.layer.businessId] = data.layer;\n\t\t\t\t\t\t\t\t\t\tif(undefined !== deferred)\n\t\t\t\t\t\t\t\t\t\t\tdeferred.resolve(results._leaflet_id);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tbusy=false;\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\t\t\t\t\n\t\t\t\tvar options = {\n\t\t\t\t\t\turl: capaMare.options.url,\n\t\t\t\t\t\ttem: tem_clasic,\n\t\t\t\t\t\tstyle: estils,\n\t\t\t\t\t\torigen: capaMare.options.businessId,\n\t\t\t\t\t\ttipus : t_url_file,\n\t\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\n\t\t\t\t\t\ttipusAcc: capaMare.options.tipusAcc,\n\t\t\t\t\t\ttipusCodi: capaMare.options.tipusCodi,\n\t\t\t\t\t\ttipusFont: capaMare.options.tipusFont,\n\t\t\t\t\t\tnomCampCodi: capaMare.options.nomCampCodi,\n\t\t\t\t\t\testil_do: estils,\n\t\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\n\t\t\t\t\t\tgeometryType: capaMare.options.geometryType,\n\t\t\t\t\t\tcolX: capaMare.options.colX,\n\t\t\t\t\t\tcolY: capaMare.options.colY,\n\t\t\t\t\t\tdinamic: capaMare.options.dinamic\t\t\t\t\t\t\n\t\t\t\t\t};\n\t\t\t\t\t$.extend(options, extraOptions);\n\t\t\t\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\tmapBusinessId: url('?businessid'),\n\t\t\t\t\t\tserverName: layerName,\n\t\t\t\t\t\tserverType: capaMare.options.tipus,\n\t\t\t\t\t\tcalentas: false,\n\t\t\t\t        activas: true,\n\t\t\t\t        visibilitats: true,\n\t\t\t\t        order: capesOrdre_sublayer,\t\t\t\t\n\t\t\t\t        epsg: capaMare.options.epsgIN,\n\t\t\t\t        transparency: true,\n\t\t\t\t        opacity: 1,\n\t\t\t\t        visibilitat: 'O',\n\t\t\t\t        url: capaMare.options.url,\n\t\t\t\t\t\toptions: JSON.stringify(options),\n\t\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\t\ttipusTematic:\"t_url_file\",\n\t\t\t\t\t\turlTematic:paramUrl.createServidorInMap,\n\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\n\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\n\t\t\t\t\t};\n\t\t\t\t\t$.extend(data, extraData);\n\t\t\t\t\tcallActions(data);\n\t\t\t\t\t/*createServidorInMap(data);/*.then(function(results){\n\t\t\t\t\t\tbusy=false;\t\t\t\t\t\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\tloadURLfileLayer(results.results).then(function(results){\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t});\n\t\t\t\t\t});*/\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\t\t\t\n\t\t });\n\t}else{\n\t\tdata1 = {\n\t\t\tuid: Cookies.get('uid'),\n\t\t\tbusinessId1: capaMare.options.businessId\n\t\t};\n\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\tvar tmpFile=\"\";\n\t\t\tif (results.status==\"OK\"){\n\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\tvar pollTime =3000;\n\t\t\t\t//Fem polling\n\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t//console.debug(data);\n\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\")!=-1 || data.status.indexOf(\"PAS 3\")!=-1) && busy){\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\n\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t\t//L'afegim a les dades guardades\n\t\t\t\t\t\t\t\t\t\tif(!controlCapes.hasOwnProperty(\"_visLayers\"))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers = {};\n\t\t\t\t\t\t\t\t\t\t\tcontrolCapes._options = {};\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._visLayers[data.layer.businessId] = data.visualitzacio;\n\t\t\t\t\t\t\t\t\t\tcontrolCapes._options[data.layer.businessId] = data.layer;\n\t\t\t\t\t\t\t\t\t\tif(undefined !== deferred)\n\t\t\t\t\t\t\t\t\t\t\tdeferred.resolve(results._leaflet_id);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t},pollTime);\n\t\t\t\t\t\n\t\t\t\t})();\n\n\t\t\t\tvar data = {\n\t\t\t\t\t\tbusinessId: tematicFrom.businessid,//businessId id de la visualización de origen\n\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t        mapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t        nom: layerName,\n\t\t\t\t        activas: true,\n\t\t\t\t        order: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t        dataField: jQuery('#dataField').val(),//¿?¿?¿?¿?\n\t\t\t\t\t\ttem: tem_clasic,//visualitzacio.from,//tem_simple\n\t\t\t\t\t\testils: JSON.stringify(estils),\n\t\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\t\ttipusTematic:\"t_visualitzacio_categories\",\n\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioTematica,\n\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\n\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\n\t\t\t\t\t};\n\t\t\t\t\t$.extend(data, extraData);\n\t\t\t\t\tcallActions(data);\n\t\t\t\t//\tcreateVisualitzacioTematica(data);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t}\n\t\t\n\t\t\t\n\t\t\t\n\t\t\t/*createVisualitzacioTematica(data);/*.then(function(results){\n\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\tbusy=false;\n\t\t\t\tif(results.status == 'OK'){\n\t\t\t\t\tvar defer = $.Deferred();\n\t\t\t\t\treadVisualitzacio(defer, results.visualitzacio, results.layer).then(function(results){\n\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t});\t\t\t\t\n\t\t\t\t}\n\t\t\t});\t\t*/\n\t\t});\t\t\t\t\n\t}\n\t\n\tevent.preventDefault();\n\tevent.stopImmediatePropagation();\n\n\tif(\"undefined\" !== typeof deferred)\n\t\treturn deferred.promise();\n\t\n}\n\nfunction updatePaletaRangs(softColors){\n\t\n\tvar softColorsUsed = (undefined !== softColors && softColors);\n\tvar paleta = jQuery(\"#dialog_tematic_rangs\").data(\"paleta\");\n\tvar tematicFrom = jQuery(\"#dialog_tematic_rangs\").data(\"capamare\");\n\t\n\t//console.debug( jQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\"));\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\");\n\t//values = values;\n\tvar rangs = jQuery(\"#dialog_tematic_rangs\").data(\"rangs\");\n\t\n\tvar tipusrang = jQuery(\"#dialog_tematic_rangs\").data(\"tipusrang\");\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\n\t\n\n\t\n\tvar val_leng = 0;\n\tif (tipusrang == 'rangs'){\n\t\tval_leng = rangs.length;\n\t}else{\n\t\tval_leng = values.length;\n\t}\n\n\t//If soft colors are used instead of getting the [0, val_leng] and the rest evenly distributed\n\t//we use the half values of each interval\n\t//Example: 3 colors from [0, 3]\n\t//Non soft colors gets the colors on the [0, 1.5, 3] points\n\t//Soft colors gets the colors on the [0.75, 1.5, 2.25] points\n\t\n\tvar ftype = transformTipusGeometry(tematicFrom.geometrytype);\n\tpaleta = paleta ? paleta : 'Paired';\n\n\tvar scale = createScale(paleta, val_leng, reverse);\n\t\n\tif (ftype == t_marker){\n\t\tvar elems = $(\"#list_tematic_values tbody td div\");\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\n\t\tvar factor = val_leng/length;\n\t\tvar start = (softColors ? factor : 0);\n\t\telems.each(function(i, elm){\n\t\t\tvar color = scale(start + i*factor).hex();\n\t\t\tjQuery(elm).css('background-color', color);\n\t\t});\n\t}else if (ftype == t_polyline){\n\t\tvar elems = $(\"#list_tematic_values canvas\");\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\n\t\tvar factor = val_leng/length;\n\t\tvar start = (softColors ? factor : 0);\n\t\telems.each(function(i, elm){\n\t\t\tvar color = scale(start + i*factor).hex();\n\t\t\taddGeometryInitLRang(elm, {style:{color: color}});\n\t\t});\n\t}else if (ftype == t_polygon){\n\t\tvar elems = $(\"#list_tematic_values canvas\");\n\t\tvar length = (softColors ? elems.length + 1 : elems.length - 1);\n\t\tvar factor = val_leng/length;\n\t\tvar start = (softColors ? factor : 0);\n\t\telems.each(function(i, elm){\n\t\t\tvar color = scale(start + i*factor).hex();\n\t\t\taddGeometryInitPRang(elm, {style:{color: color}});\n\t\t});\n\t}\n}\n\nfunction createSemaforicValues(geomType)\n{\n\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values\");\n\tif (values.valors!=undefined) values = values.valors;\n\tvar nodata = jQuery(\"#dialog_tematic_rangs\").data(\"nodata\");\n\tvalues = jQuery.grep(values, function( n, i ) {\n\t\treturn (n != NODATA_VALUE && jQuery.isNumeric(parseFloat(n)));\n\t});\n\tvalues.sort(function(a,b){return a-b;});\n\tvar min = parseFloat(values[0]);\n\tvar max = parseFloat(values[values.length-1]);\n\tvar half = (max + min)/2;\n\n\t//Creem un vector amb els següents rangs:\n\t// [valor mínim, valor anterior al valor mig)\n\t// [valor anterior al valor mig, valor següent al valor mig)\n\t// [valor següent al valor mig, valor màxim]\n\tvar newRangs = [{min: min, max: max}];\n\tvar i = 0;\n\twhile (values[i] <= half)\n\t\ti++;\n\t\n\tnewRangs[0].max = parseFloat(values[i-1]);\n\tnewRangs.push({min: parseFloat(values[i-1]), max: parseFloat(values[i])});\n\tnewRangs.push({min: parseFloat(values[i]), max: max});\n\n\tif (nodata){\n\t\tnewRangs.push({min: NODATA_VALUE, max: NODATA_VALUE, nodata:true});\n\t}\n\t\n\tjQuery(\"#dialog_tematic_rangs\").data(\"rangs\", newRangs);\n\tshowTematicRangs(geomType).then(function(results){\n\t\tloadTematicValueTemplate(results,'semaforic');\n\t\tupdatePaletaRangs();\n\t});\n\n}\n\nfunction createRangsValues(rangs,geomType){\n\t//console.debug(\"createRangsValues\");\n\tvar values = jQuery(\"#dialog_tematic_rangs\").data(\"values\");\n\tif (values.valors!=undefined) values = values.valors;\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\n\t//var visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\n\tvar nodata = jQuery(\"#dialog_tematic_rangs\").data(\"nodata\");\n\tvar reverse = jQuery(\"#dialog_tematic_rangs\").data(\"reverse\");\n\tvalues = jQuery.grep(values, function( n, i ) {\n\t\treturn (n != NODATA_VALUE && jQuery.isNumeric(parseFloat(n)));\n\t});\n\tvalues.sort(function(a,b){return a-b;});\n\tvar min = parseFloat(values[0]);\n\tvar max = parseFloat(values[values.length-1]);\n\tvar deltaR = (max - min)/rangs;\n\tdeltaR = parseFloat(deltaR.toFixed(2));\n\tvar newRangs = [];\n\tvar i = 0;\n\twhile (min < max && i < rangs){\n\t\tif (i == (rangs-1)){\n\t\t\tnewRangs.push({min: min, max: max});\n\t\t}else{\n\t\t\tvar tmpmax = parseFloat((min+deltaR).toFixed(2));\n\t\t\tnewRangs.push({min: min, max: tmpmax});\n\t\t\tmin = tmpmax;\n\t\t}\n\t\ti++;\n\t}\n\tif (nodata){\n\t\tnewRangs.push({min: NODATA_VALUE, max: NODATA_VALUE, nodata:true});\n\t}\n\t\n\tjQuery(\"#dialog_tematic_rangs\").data(\"rangs\", newRangs);\n\tshowTematicRangs(geomType).then(function(results){\n\t\tloadTematicValueTemplate(results,'rangs');\n\t});\n}\n\nfunction loadTematicValueTemplate(results, rtype){\n\n\tvar source1;\n\tvar geometryType = results[0].style.geometryType;\n\tif (!geometryType){\n\t\tgeometryType = results[0].style.tipus;\n\t}\n\tvar ftype = transformTipusGeometry(geometryType);\n\tif (ftype == t_marker){\n\t\tif (rtype == 'rangs'){\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-punt-template\").html();\n\t\t}else if(rtype == \"unic\"){\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-punt-template\").html();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-punt-template\").html();\n\t\t}\n\t\t\n\t}else if (ftype == t_polyline){\n\t\tif (rtype == 'rangs'){\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-polyline-template\").html();\n\t\t}else if(rtype == \"unic\"){\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-polyline-template\").html();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-polyline-template\").html();\n\t\t}\n\t\t\n\t}else if (ftype == t_polygon){\n\t\tif (rtype == 'rangs'){\n\t\t\tsource1 = jQuery(\"#tematic-values-rangs-polygon-template\").html();\n\t\t}else if(rtype == \"unic\"){\n\t\t\tsource1 = jQuery(\"#tematic-values-unic-polygon-template\").html();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsource1 = jQuery(\"#tematic-values-semaforic-polyline-template\").html();\n\t\t}\n\t}\n\t\n\tvar resultsNoRepetits=[];\n\tif (rtype=='unic'){\t\n\t\tvar data = {};\t\t\n\t\tjQuery.grep(results,  function( n, i ) {\n\t\t\t\tvar value = n.v;\n\t\t\t\tif(isBlank(value)) value = \"nodata\";\n\t\t\t\tif(!data[value]){\n\t\t\t\t\tdata[value] = value;\n\t\t\t\t\tresultsNoRepetits.push(n);\n\t\t\t\t}\n\t\t});\n\t\t//match ints and floats/decimals\n\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\t\tvar resultsFloat = [];\n\t\tvar i=0;\n\t\tvar j=0;\n\t\tjQuery.grep(resultsNoRepetits, function( n, i ) {\n\t\t\t//console.debug(n.v);\n\t\t\t//console.debug(floatRegex.test(n.v));\t\t\t\n\t\t\tif (floatRegex.test(n.v)) {\n\t\t\t\t//console.debug(n.v);\n\t\t\t\tresultsFloat[j]=n;\n\t\t\t\tj++;\n\t\t\t}\n\t\t\t\t\n\t\t});\n\t\tvar template1 = Handlebars.compile(source1);\n\t\tvar html1 = \"\";\n\t\tif (resultsFloat.length>0 && resultsNoRepetits.length == resultsFloat.length) {\n\t\t\t//resultsFloat.sort(function(a,b){return a.v-b.v;});\n\t\t\tresultsFloat.sort(sortByValueMax);\n\t\t\thtml1 = template1({values:resultsFloat});\n\t\t}\n\t\telse {\n\t\t\tresultsNoRepetits.sort(sortByValueMax);\n\t\t\thtml1 = template1({values:resultsNoRepetits});\n\t\t}\n\t\tjQuery(\"#dialog_tematic_rangs\").data(\"values-norepetits\",resultsNoRepetits);\n\t}\n\telse {\n\t\t\n\t\t//match ints and floats/decimals\n\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\t\tvar resultsFloat = [];\n\t\tvar i=0;\n\t\tjQuery.grep(results, function( n, i ) {\n\t\t\tif (floatRegex.test(n.v)) {\n\t\t\t\tresultsFloat[i]=n;\n\t\t\t\ti++;\n\t\t\t}\n\t\t\t\t\n\t\t});\n\t\t\n\t\tvar template1 = Handlebars.compile(source1);\n\t\tvar html1 = \"\";\n\t\tif (resultsFloat.length>0) {\n\t\t\tresultsFloat.sort(function(a,b){return a.v-b.v;});\n\t\t\thtml1 = template1({values:resultsFloat});\n\t\t}\n\t\telse if(\"semaforic\" == rtype)\n\t\t{\n\n\t\t\thtml1 = template1({value:results[1].v.min});\n\n\t\t}\n\t\telse {\n\t\t\tresults.sort();\n\t\t\thtml1 = template1({values:results});\n\t\t}\n\t}\n\t\n\t\n\tjQuery('#list_tematic_values').html(html1);\n\tjQuery('#dialog_tematic_rangs .btn-success').show();\n\tif (ftype == t_marker){\n\t\tjQuery('#list_tematic_values div.awesome-marker-web').on('click',function(e){\n\t\t\tvar _this = this;\n\t\t\tvar _$this = $(this);\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\n\t\t\t\t_$this.css('background-color',e.color);\n\t\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t});\n\t\t});\n\t\t\n\t}else if (ftype == t_polyline){\n\t\tjQuery('#list_tematic_values canvas').each(function(i, val){\n\t\t\taddGeometryInitLRang(val, results[i]);\n\t\t});\n\t\t\n\t\tjQuery('#list_tematic_values canvas').on('click',function(e){\n\t\t\tvar _this = this;\n\t\t\tvar _$this = $(this);\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\n\t\t\t\tvar canvas = _this;\n\t\t\t\tvar style = {style:{}};\n\t\t\t\tstyle.style.color = e.color;\n\t\t\t\taddGeometryInitLRang(canvas, style);\n\t\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t});\n\t\t\t\n\t\t});\n\t\t\n\t}else if (ftype == t_polygon){\n\t\t\n\t\tjQuery('#list_tematic_values canvas').each(function(i, val){\n\t\t\taddGeometryInitPRang(val, results[i]);\n\t\t});\n\t\t\n\t\tjQuery('#list_tematic_values canvas').on('click',function(e){\n\t\t\tvar _this = this;\n\t\t\tvar _$this = $(this);\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t\n\t\t\t_$this.after('<div id=\"temp_color_pallete\" class=\"dropdown-menu\"></div>');\n\t\t\t\n\t\t\t$(\"#temp_color_pallete\").css({'top':_$this.position().top,'left':_$this.position().left+25}).colorPalette().on('selectColor', function(e) {\n\t\t\t\tvar canvas = _this;\n\t\t\t\tvar style = {style:{}};\n\t\t\t\tstyle.style.color = e.color;\n\t\t\t\taddGeometryInitPRang(canvas, style);\n\t\t\t\t$(\"#temp_color_pallete\").remove();\n\t\t\t});\n\t\t\t\n\t\t});\n\t}\n}\n\nfunction addGeometryInitLRang(canvas, style){\n\tvar\tcv_ctx_l=canvas.getContext(\"2d\");\n\tvar scale = 0.7;\n\t\n\tcv_ctx_l.clearRect(0, 0, canvas.width, canvas.height);\n\t\t\n\tcv_ctx_l.shadowColor = '#999';\n\tcv_ctx_l.shadowBlur = 4;\n\tcv_ctx_l.shadowOffsetX = 2;\n\tcv_ctx_l.shadowOffsetY = 2;\n\t\n\tcv_ctx_l.moveTo(0.7*scale,39.42*scale);\n\tcv_ctx_l.lineTo(2.05*scale,34.43*scale);\n\tcv_ctx_l.lineTo(3.62*scale,31.00*scale);\n\tcv_ctx_l.lineTo(5.95*scale,27.72*scale);\n\tcv_ctx_l.lineTo(8.17*scale,25.61*scale);\n\tcv_ctx_l.lineTo(10.72*scale,23.84*scale);\n\tcv_ctx_l.lineTo(13.059*scale,22.73*scale);\n\tcv_ctx_l.lineTo(15.32*scale,22.28*scale);\n\tcv_ctx_l.lineTo(17.76*scale,22.08*scale);\n\tcv_ctx_l.lineTo(20.30*scale,21.47*scale);\n\tcv_ctx_l.lineTo(23.28*scale,20.51*scale);\n\tcv_ctx_l.lineTo(25.88*scale,18.90*scale);\n\tcv_ctx_l.lineTo(28.265*scale,16.83*scale);\n\tcv_ctx_l.lineTo(29.9*scale,14.71*scale);\n\tcv_ctx_l.lineTo(31.89*scale,12.195*scale);\n\tcv_ctx_l.lineTo(33.62*scale,9.42*scale);\n\tcv_ctx_l.lineTo(34.81*scale,6.64*scale);\n\tcv_ctx_l.lineTo(35.46*scale,3.92*scale);\n\tcv_ctx_l.lineTo(35.52*scale,0.54*scale);\n\tcv_ctx_l.strokeStyle=style.style.color;\n\tcv_ctx_l.lineWidth=3;\n\tcv_ctx_l.stroke(); \t\n}\n\nfunction addGeometryInitPRang(canvas, style){\n\tvar\tcv_ctx_p=canvas.getContext(\"2d\");\n\tvar scale = 0.7;\n\t\n\tcv_ctx_p.clearRect(0, 0, canvas.width, canvas.height);\n\t\t\n\tcv_ctx_p.shadowColor = '#999';\n\tcv_ctx_p.shadowBlur = 4;\n\tcv_ctx_p.shadowOffsetX = 2;\n\tcv_ctx_p.shadowOffsetY = 2;\n\t\n\tcv_ctx_p.moveTo(5.13*scale,15.82*scale);\n\tcv_ctx_p.lineTo(25.49*scale,5.13*scale);\n\tcv_ctx_p.lineTo(37.08*scale,13.16*scale);\n\tcv_ctx_p.lineTo(20.66*scale,38.01*scale);\n\tcv_ctx_p.lineTo(2.06*scale,33.67*scale);\n\tcv_ctx_p.closePath();\n\tcv_ctx_p.strokeStyle=\"#ffffff\"; //hex\n\tcv_ctx_p.fillStyle=jQuery.Color(style.style.color).alpha(0.75).toRgbaString(); //rgba\n\tcv_ctx_p.lineWidth=1;\n\tcv_ctx_p.fill();\n\tcv_ctx_p.stroke();\n}\n\nfunction readDataUrlFileLayer(urlFileLayer, key){\n\t\n\tvar defer = jQuery.Deferred();\n\tvar data = {};\n\tvar dataValues = [];\t\n\t\n\tjQuery.each( urlFileLayer._layers, function(i,feature) {\n\t\t//var value = feature.properties[key.toLowerCase()];\n\t\tvar value = feature.feature.properties[key];\n\t\tif(!data[value]){\n\t\t\tdata[value] = value;\n\t\t\tdataValues.push(value);\n\t\t}\n\t});\n\t\n\tdefer.resolve(dataValues);\n\treturn defer.promise();\n}\n\nfunction readDataVisualitzacio(visualitzacio, key){\n\t//console.debug(\"readDataVisualitzacio\");\n\tvar defer = jQuery.Deferred();\n\tvar data = {};\n\tvar dataValues = [];\n\tjQuery.each(visualitzacio.estil, function(index, item){\n\t\tjQuery.each( item.geometria.features, function(i,feature) {\n\t\t\t//var value = feature.properties[key.toLowerCase()];\n\t\t\tvar value = feature.properties[key];\n\t\t\t//Si es blanc assignem categoria \"Sense valor\" com una més\n\t\t\t//if(isBlank(value)) value = window.lang.translate(\"Sense valor\");\n\t\t\tif(isBlank(value)) value = \"nodata\";\n\t\t\tif(!data[value]){\n\t\t\t\tdata[value] = value;\n\t\t\t\tdataValues.push(value);\n\t\t\t}\n\t\t});\n\t});\n\tdefer.resolve(dataValues);\n\treturn defer.promise();\n}\n\nfunction createScale(paleta, length, reverse){\n\tvar scale = ColorScales.createScale(paleta, length, reverse);\n\treturn scale;\n}\n\n\n\nfunction createTematicCategoriesActualitzat(data,sublayer,businessIdCapaMare,layerMare){\n\tvar paleta,reverse,dataField,labelField,tipusClasicTematic;\n\tif (sublayer.layer.options.paleta!=undefined) paleta = sublayer.layer.options.paleta;\n\tif (sublayer.layer.options.reverse!=undefined) reverse = sublayer.layer.options.reverse;\n\tif (sublayer.layer.options.dataField!=undefined) dataField = sublayer.layer.options.dataField;\n\tif (sublayer.layer.options.labelField!=undefined) labelField = sublayer.layer.options.labelField;\n\tif (sublayer.layer.options.tipusClasicTematic!=undefined) tipusClasicTematic = sublayer.layer.options.tipusClasicTematic;\n\t\n\tvar tematic = jQuery(\"#dialog_tematic_rangs\").data(\"tematic\");\n//\tvar visualitzacio = jQuery(\"#dialog_tematic_rangs\").data(\"visualitzacio\");\n\tvar capaMare = controlCapes._layers[layerMare.layer._leaflet_id].layer;\n//\tconsole.debug(paleta);\n\tpaleta = paleta ? paleta : 'Paired';\n\tvar sToCount = $(\"#count-\"+businessIdCapaMare).html();\n\tsToCount = sToCount.replace(\"(\", \" \");\n\tsToCount = sToCount.replace(\")\", \" \");\t\n\tvar toCount = parseInt(sToCount.trim());\n\tvar scale = createScale(paleta, toCount, reverse);\t\n\tvar ftype = transformTipusGeometry(layerMare.layer.options.geometryType);\t\n\tvar dataVis={\n\t\t\tbusinessId1: businessIdCapaMare,\n\t\t\tkey: dataField,\n\t\t\tuid: Cookies.get('uid')\n\t};\n\tvar rangsEstils=[];\n\tgetValuesFromKeysProperty(dataVis).then(function(results){\n\t\tvar valors = results.valors;\n\t\tvar resultatsFinals=[];\n\t\t\t\t\t\t\n\t\tif (tipusClasicTematic==undefined || tipusClasicTematic==\"unic\"){\n\t\t\tvar resultsNoRepetits=[];\n\t\t\tvar data = {};\t\t\n\t\t\tjQuery.grep(valors,  function( n, i ) {\n\t\t\t\t\t\tvar value = n;\n\t\t\t\t\t\tif(isBlank(value)) value = \"nodata\";\n\t\t\t\t\t\t\tif(!data[value]){\n\t\t\t\t\t\t\t\tdata[value] = value;\n\t\t\t\t\t\t\t\tresultsNoRepetits.push(n);\n\t\t\t\t\t\t\t}\n\t\t\t});\n\t\t\t//match ints and floats/decimals\n\t\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\t\t\tvar resultsFloat = [];\n\t\t\tvar i=0;\n\t\t\tjQuery.grep(resultsNoRepetits, function( n, i ) {\n\t\t\t\tif (floatRegex.test(n.v)) {\n\t\t\t\t\tresultsFloat[i]=n;\n\t\t\t\t\ti++;\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t});\n\t\t\tif (resultsFloat.length>0) resultatsFinals=resultsFloat;\n\t\t\telse resultatsFinals=resultsNoRepetits;\n\t\t}\n\t\telse {\n\t\t\t//match ints and floats/decimals\n\t\t\tvar floatRegex = new RegExp('(^-?0\\.[0-9]*[1-9]+[0-9]*$)|(^-?[1-9]+[0-9]*((\\.[0-9]*[1-9]+[0-9]*$)|(\\.[0-9]+)))|(^-?[1-9]+[0-9]*$)|(^0$){1}');\n\t\t\tvar resultsFloat = [];\n\t\t\tvar i=0;\n\t\t\tjQuery.grep(valors, function( n, i ) {\n\t\t\t\tif (floatRegex.test(n.v)) {\n\t\t\t\t\tresultsFloat[i]=n;\n\t\t\t\t\ti++;\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t});\n\t\t\tif (resultsFloat.length>0) resultatsFinals=resultsFloat;\n\t\t\telse resultatsFinals=valors;\n\t\t}\n\t\tvar valuesStyle = jQuery.map( resultatsFinals, function( a, i) {\n\t\t\trangsEstils[i]={v: a, style: createIntervalStyle(i,ftype,scale)};\t\t\t\t\t\t\t\n\t\t});\n\t\tloadRangValues(rangsEstils,tipusClasicTematic,layerMare.layer.options.geometryType,sublayer.layer.options.estilsRangs,sublayer.layer.options.estil).then(function(rangs){\n\t\t\tvar data1 = {\n\t\t\t\t\tuid: Cookies.get('uid'),\n\t\t\t\t\tbusinessId1: capaMare.options.businessId\n\t\t\t\t};\n\t\t\t\tcrearFitxerPolling(data1).then(function(results) {\n\t\t\t\t\tvar tmpFile=\"\";\n\t\t\t\t\tif (results.status==\"OK\"){\n\t\t\t\t\t\ttmpFile = results.tmpFilePath;\n\t\t\t\t\t\t//Definim interval de polling en funcio de la mida del fitxer\n\t\t\t\t\t\tvar pollTime =3000;\n\t\t\t\t\t\t//Fem polling\n\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tpollBuffer = function(){\n\t\t\t\t\t\t\t\t$.ajax({\n\t\t\t\t\t\t\t\t\turl: paramUrl.polling +\"pollingFileName=\"+ results.tmpFileName,\n\t\t\t\t\t\t\t\t\tdataType: 'json',\n\t\t\t\t\t\t\t\t\ttype: 'get',\n\t\t\t\t\t\t\t\t\tsuccess: function(data){\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\tjQuery('#dialog_tematic_rangs').hide();\n\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').show();\n\t\t\t\t\t\t\t\t\t\tif(data.status.indexOf(\"PAS 1\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_current\" lang=\"ca\">1. '+window.lang.translate('Creant categories')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_uncheck\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t}else if((data.status.indexOf(\"PAS 2\")!=-1 || data.status.indexOf(\"PAS 3\")!=-1) && busy){\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+'<span class=\"one\">.</span><span class=\"two\">.</span><span class=\"three\">.</div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_current\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+'</div>'\t\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"OK\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\"\");\n\t\t\t\t\t\t\t\t\t\t\tjQuery(\"#div_uploading_txt\").html(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step1\" class=\"status_check\" lang=\"ca\">1. '+window.lang.translate('Categories creades')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'+\n\t\t\t\t\t\t\t\t\t\t\t\t\t'<div id=\"div_upload_step2\" class=\"status_check\" lang=\"ca\">2. '+window.lang.translate('Processant la resposta')+' <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span></div>'\n\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tvar defer = $.Deferred();\n\t\t\t\t\t\t\t\t\t\t\treadVisualitzacio(defer, data.visualitzacio, data.layer).then(function(results){\n\t\t\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+businessIdCapaMare).attr(\"checked\")!=undefined) $( \"#input-\"+businessIdCapaMare).click();\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\t\t\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t\t\t\t\t\t}else if(data.status.indexOf(\"ERROR\")!=-1 && busy){\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(\"Error calculant l'operació\");\n\t\t\t\t\t\t\t\t\t\t\tconsole.error(data);\n\t\t\t\t\t\t\t\t\t\t\tbusy = false;\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(\"\");\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload_txt').html(window.lang.translate(\"Error calculant l'operació\"));\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t$('#dialog_error_upload').modal('show');\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse if (!busy){\n\t\t\t\t\t\t\t\t\t\t\tclearInterval(pollInterval);\n\t\t\t\t\t\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tpollInterval = setInterval(function(){\n\t\t\t\t\t\t\t\tpollBuffer();\n\t\t\t\t\t\t\t},pollTime);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t})();\n\t\t\t\t\t\t\tvar estils = {\n\t\t\t\t\t\t\t\testils: rangs,\n\t\t\t\t\t\t\t\tdataField: dataField,\n\t\t\t\t\t\t\t\tlabelField: dataField\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tvar options = {\n\t\t\t\t\t\t\t\turl: capaMare.options.url,\n\t\t\t\t\t\t\t\ttem: tem_clasic,\n\t\t\t\t\t\t\t\tstyle: estils,\n\t\t\t\t\t\t\t\torigen: capaMare.options.businessId,\n\t\t\t\t\t\t\t\ttipus : t_url_file,\n\t\t\t\t\t\t\t\ttipusFile: capaMare.options.tipusFile,\n\t\t\t\t\t\t\t\testil_do: estils,\n\t\t\t\t\t\t\t\tepsgIN: capaMare.options.epsgIN,\n\t\t\t\t\t\t\t\tgeometryType: capaMare.options.geometryType,\n\t\t\t\t\t\t\t\tcolX: capaMare.options.colX,\n\t\t\t\t\t\t\t\tcolY: capaMare.options.colY,\n\t\t\t\t\t\t\t\tdinamic: capaMare.options.dinamic\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\t\tbusinessId: businessIdCapaMare,//businessId id de la visualización de origen\n\t\t\t\t\t\t\t\tuid: Cookies.get('uid'),//uid id de usuario\n\t\t\t\t\t\t\t\tmapBusinessId: url('?businessid'),//mapBusinessId id del mapa donde se agrega la visualización\t           \n\t\t\t\t\t\t\t\tnom:  sublayer.layer.options.nom,\n\t\t\t\t\t\t\t\tactivas: true,\n\t\t\t\t\t\t\t\torder: capesOrdre_sublayer,//order (optional) orden de la capa en el mapa\n\t\t\t\t\t\t\t\tdataField: jQuery('#dataField').val(),//¿?¿?¿?¿?\n\t\t\t\t\t\t\t\ttem: tem_clasic,//visualitzacio.from,//tem_simple\n\t\t\t\t\t\t\t\testils: JSON.stringify(estils),\n\t\t\t\t\t\t\t\ttipusTematic:\"t_visualitzacio_categories\",\n\t\t\t\t\t\t\t\turlTematic:paramUrl.createVisualitzacioTematica,\n\t\t\t\t\t\t\t\ttmpFilePath: tmpFile,\n\t\t\t\t\t\t\t\tpaleta: jQuery(\"#dialog_tematic_rangs\").data(\"paleta\"),\n\t\t\t\t\t\t\t\treverse: jQuery(\"#dialog_tematic_rangs\").data(\"reverse\")\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t//console.debug(\"callActions\");\n\t\t\t\t\t\t\tcallActions(data);\n\t\t\t\t\t\t\t/*createVisualitzacioTematica(data).then(function(results){\n\t\t\t\t\t\t\t\t\tvar defer = jQuery.Deferred();\n\t\t\t\t\t\t\t\t\treadVisualitzacio (defer,results.visualitzacio,results.layer).then(function(results2){\n\t\t\t\t\t\t\t\t\t\tactivaPanelCapes(true);\n\t\t\t\t\t\t\t\t\t\t//Desactivem la capa mare\n\t\t\t\t\t\t\t\t\t\tif ($( \"#input-\"+capaMare.options.businessId).attr(\"checked\")!=undefined) $( \"#input-\"+capaMare.options.businessId).click();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});*/\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tjQuery('#info_uploadFile').hide();\t\t\n\t\t\t\t\t\tbusy=false;\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t});\t\n\t\t\t\t\n\t\t\t});\n\t\t\t\t\t\t\n\t\t});\n}\n\nfunction loadRangValues(rangsEstils,tipusClasicTematic,geometrytype,estilsRangs,estilLayer){\n\tvar defer = jQuery.Deferred();\n\tvar rangs=[];\n\tvar rangsGuardats=[];\n\tif (tipusClasicTematic==\"rangs\"){\n\t\tjQuery.each(estilsRangs, function( index, value ) {\n\t\t\tvar values =[];\n\t\t\tvalues=index.split(\" - \");\n        \tvar indexEstil = 0;\n        \twhile(indexEstil<estilLayer.length && value!=estilLayer[indexEstil].businessId){\n        \t\t\tindexEstil++;\n\t\t\t}\n\t\t\tvar estil = estilLayer[indexEstil];\t\t\t\n\t\t\tvar tdRang, tdMin, tdMax;\n\t\t\tvar tdVal;\n\t\t\tvar rang = {};\n\t\t\trang.estil = transformStyle(estil,geometrytype);\n\t\t\trang.valueMax = values[1];\n\t\t\trang.valueMin = values[0];\n\t\t\trangs.push(rang);\n\t\t});\n\t}\n\tif (tipusClasicTematic==undefined || tipusClasicTematic==\"unic\"){\n\t\tjQuery.each(rangsEstils, function( index, value ) {\n\t\t\tvar tdRang, tdMin, tdMax;\n\t\t\tvar tdVal;\n\t\t\tvar rang = {};\n\t\t\trang.estil = transformStyle(value.style,geometrytype);\n\t\t\trang.valueMax = value.v;\n\t\t\trang.valueMin = value.v;\n\t\t\trangs.push(rang);\n\t\t\t\n\t\t});\t\n\t}\n\tconsole.debug(rangs);\n\tdefer.resolve(rangs);\n\treturn defer.promise();\n}\n\nfunction transformStyle(style,geometrytype){\n\tvar rangStyle;\n\tvar ftype = transformTipusGeometry(geometrytype);\n\tif (ftype == t_marker){\n\t\t//divElement = tdElem.find('div');\n\t\tvar color;\n\t\tif (style.fillColor!=undefined) color=style.fillColor;\n\t\telse if (style.color!=undefined) color=style.color;\n\t\trangStyle = {\n\t\t\tborderColor :  \"#ffffff\",\n\t\t\tborderWidth :  2,\n\t\t\tsimbolSize: style.simbolSize,\n\t\t\tcolor: color,\n\t\t\topacity: 90\n\t\t};\n\t}else if (ftype == t_polyline){\n\t\t//divElement = tdElem.find('canvas')[0].getContext(\"2d\");\n\t\tvar lineWidth;\n\t\tif (style.dashArray!=undefined) lineWidth=style.dashArray;\n\t\telse if (style.lineWidth) lineWidth=style.lineWidth;\n\t\trangStyle = {\n\t\t\tlineWidth :  style.dashArray,\n\t\t\tcolor: style.color,\n\t\t};\n\t}else if (ftype == t_polygon){\n\t\t\n\t\t//divElement = tdElem.find('canvas')[0].getContext(\"2d\");\n\t\trangStyle = {\n\t\t\tborderColor : '#FFFFFF',\n\t\t\tborderWidth :  '1',\n\t\t\tcolor: style.color,\n\t\t\tfillColor: style.color,\n\t\t\tfillOpacity: style.opacity,\n\t\t\topacity: '75'\t\t//75!\n\t\t};\n\t\t//console.debug(rangStyle);\n\t}\n\treturn rangStyle;\n}\n\t\n\n\n","//var per controlar si hi ha hagut edicio dels elements de la capa, i si cal fer refresh\nvar editat = false;\nvar geomBusinessId = '-1';\nvar geomRowIndex = 0;\nvar numRows = 0;\n\n\nfunction addFuncioEditDataTable(){\n\t\n\taddHtmlModalDataTable();\n\taddHtmlModalDeleteDataTableRow();\n\t\n\t$('#dialog_delete_row .btn-danger').on('click', function(event){\n\t\tvar button = $(event.relatedTarget); // Button that triggered the modal\n\t\tvar recipient = button.data('whatever');\n\t\t\n    \tvar geometryid = $('#dialog_delete_row .btn-danger').data(\"geometryid\");\n    \tvar geometriesBusinessId = $('#dialog_delete_row .btn-danger').data(\"geometriesBusinessId\");\n    \tvar businessId = $('#dialog_delete_row .btn-danger').data(\"businessId\");\t\t\n\t\t\n    \tremoveGeometryDB(geometryid,businessId,geometriesBusinessId);\n\t});\n\t\n\t$('#modal_data_table').on('hidden.bs.modal', function (e) {\n\t\t\n//\t\tconsole.debug(controlCapes);\n\t\t\n\t\t//si hem editat dades recarreguem la capa per visualitzar els canvis\n\t\tif(editat){\n//\t\t\tconsole.debug(\"Tanquem modal data table\");\n\t\t\t  \n\t    \t//Actualitzem visualitzacions de la capa on estava la geometria modificada\n\t\t\tvar capaEdicio = $('#modal_data_table').data(\"capaEdicio\");//controlCapes._layers[capaEdicioLeafletId];\n//\t\t\tconsole.debug(\"capaEdicio:\");\n//\t\t\tconsole.debug(capaEdicio);\n\t\t\tvar layerServidor = $('#modal_data_table').data(\"layerServidor\");\n\t\t\t\n\t\t\tlayerServidor.capesOrdre = capaEdicio.layer.options.zIndex.toString();\n\t\t\t\n//\t\t\tconsole.debug(\"layerServidor:\");\n//\t\t\tconsole.debug(layerServidor);\t\n\t\t\t\n\t\t\t//Eliminem la capa de controlCapes i mapa\n\t\t\tmap.closePopup();\n\t\t\tmap.removeLayer(capaEdicio.layer);\n\t\t\tcontrolCapes.removeLayer(capaEdicio);\t\t\t\n\t\t\t\n\t\t\t//Recarrego la capa origen\n\t\t\tloadVisualitzacioLayer(layerServidor).then(function(results){\n\t\t\t\t//recarrego les sublayers si les te\n\t\t\t\tjQuery.each(capaEdicio._layers, function(i, sublayer){\n\t\t\t\t\t\n\t\t\t\t\tif(jQuery.type(capaEdicio.layer.options)== \"string\"){\n\t\t\t\t\t\tcapaEdicio.layer.options = $.parseJSON(capaEdicio.layer.options);\n\t\t\t\t\t}\t            \t  \n\t\t\t\t\t//Sublayer visualitzacio, carrego la capa\n\t\t\t\t\tif(sublayer.layer.options.tipus.indexOf(t_visualitzacio)!=-1){\n\t\t\t\t  \t\t  sublayer.layer.serverName = sublayer.layer.options.nom;\n\t\t\t\t  \t\t  sublayer.layer.serverType = sublayer.layer.options.tipus;\n\t\t\t\t  \t\t  sublayer.layer.capesActiva = \"true\";\n\t\t\t\t  \t\t  sublayer.layer.options.origen = capaEdicio.layer.options.businessId;//layer.properties.capaBusinessId;//BusinessIdCapaorigen\n\t\t\t\t  \t\t  //tipusRang\n\t\t\t\t  \t\t  sublayer.layer.businessId = sublayer.layer.options.businessId;//Si no, no ho trobarà després\n\t\t\t\t  \t\t  sublayer.layer.options = JSON.stringify(sublayer.layer.options);\n\t\t\t\t  \t\t  \n\t\t\t\t  \t\t  //eliminem sublayer del mapa, i recarreguem\n\t\t\t\t  \t\t  map.closePopup();\n\t\t\t\t  \t\t  map.removeLayer(sublayer.layer);\n\t\t\t\t  \t\t  \n\t\t\t\t  \t\t  loadVisualitzacioLayer(sublayer.layer);\n\t\t\t  \t  \t}\n\t\t\t\t});\t\n\t\t\t});\t\t\n\t\t}\n\t\teditat = false;\n\t\tgeomBusinessId = '-1';\n\t\tgeomRowIndex = 0;\n\t\tnumRows = 0;\n\t\t$('#modal_data_table').off('post-body.bs.table');\n\t\t$('#modal_data_table_body #layer-data-table').bootstrapTable('destroy');\n\t});\t\n\t\n}\n\nfunction fillModalDataTable(obj, geomBid){\n\t\n\tvar columNames = [];\n\tvar geometriesBusinessId = \"\";\n\tvar modeMapa = ($(location).attr('href').indexOf('/mapa.html')!=-1);\n\t\n\tif(isValidValue(geomBid)){\n\t\tgeomBusinessId = geomBid;\n\t\t\n\t\t$('#modal_data_table').on('post-body.bs.table\t', function(event, name, row, \toldValue, param) {\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopImmediatePropagation();\n\t\t\t\n//\t\t\tvar scroll = ($('div.fixed-table-body #layer-data-table tbody')[0].scrollHeight * (geomRowIndex+1)) / numRows;\n//\t\t\tconsole.debug(\"scroll:\");\n//\t\t\tconsole.debug(scroll);\n\t\t\t\n\t\t\t var parentDiv =  $('div.fixed-table-body');\n\t\t\t var innerListItem = $('div.fixed-table-body #layer-data-table tbody tr.success');\n\t\t\t if(!editat) parentDiv.scrollTo(innerListItem);\n\t\t\t \n\t\t});\n\t}\n\t\n\t$('#modal_data_table').data(\"capaEdicio\", obj);\n\t\n\t//obj.layer.serverName\t\n\t//$('#modal_data_table_title').html(obj.name.toUpperCase());\n\t$('#modal_data_table_title').text(obj.name.toUpperCase());\t\n\t\n\tvar options = obj.layer.options;\n\tif (obj.layer.options!=undefined && obj.layer.options.estil!=undefined){\n\t\t//Primer trobem column names\n\t\tjQuery.each(obj.layer.options.estil, function(indexEstil, estil){\n\t\t\t\n\t\t\tjQuery.each(estil.geometria.features, function(indexFeature, feature){\n\t\t\t\t//console.debug(feature);\n\t\t\t\t//Geometry Id\n\t\t\t\tvar objGeomId = {\n\t\t\t\t\t\tfield: 'geometryid',\n\t\t\t\t\t\ttitle: 'ID',\n\t\t\t\t\t\tvisible: false\n\t\t\t\t}\n\t\t\t\tcolumNames.push(objGeomId);\t\n\t\n\t\t\t\t//Geometry Bid \n\t\t\t\tvar objGeomBid = {\n\t\t\t\t\t\tfield: 'geometrybid',\n\t\t\t\t\t\ttitle: 'BID',\n\t\t\t\t\t\tvisible: false\n\t\t\t\t}\n\t\t\t\tcolumNames.push(objGeomBid);\t\t\t\n\t\t\t\t\n\t\t\t\t//geometryBBOX\n\t\t\t\tvar objGeomBBOX = {\n\t\t\t\t\t\tfield: 'geometryBBOX',\n\t\t\t\t\t\ttitle: 'BBOX',\n\t\t\t\t\t\tvisible: false \n\t\t\t\t}\n\t\t\t\tcolumNames.push(objGeomBBOX);\t\t\t\n\t\t\t\t\n\t\t\t\t//console.debug(options);\n\t\t\t\tif(modeMapa){\n\t\t\t\t\tvar isADrawMarker=false;\n\t\t\t\t\t//properties headers\n\t\t\t\t\t//console.debug(feature);\n\t\t\t\t\tvar propName;\n\t\t\t\t\tif(typeof (options.propName)==\"string\"){\t\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tpropName = JSON.parse(options.propName);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\tpropName = options.propName;\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}else{\t\t\t\n\t\t\t\t\t\tpropName = options.propName;\t\n\t\t\t\t\t}\n\t\t\t\t\tif (propName!=undefined && propName.toString().indexOf(\"nom,text\")==-1) {\n\t\t\t\t\t\t\n\t\t\t\t\t\tfor(var x in propName){\t\n\t\t\t\t\t\t\tif (propName[x].toLowerCase()!=\"geomorigen\") {\n\t\t\t\t\t\t\t\t//console.debug(propName[x]);\n\t\t\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\t\ttitle: propName[x].toUpperCase(),\n\t\t\t\t\t\t\t\t\tfield: propName[x].toLowerCase(),\n\t\t\t\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\t\t\t\teditable: {\n\t\t\t\t\t\t\t\t\t\temptytext : '-'\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (options.propName[x]=='text' || options.propName[x]=='TEXT') isADrawMarker=true;\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\t\t\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tfor(var x in feature.properties){\n\t\t\t\t\t\t\tif (x.toLowerCase()!=\"geomorigen\"){\n\t\t\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\t\ttitle: x.toUpperCase(),\n\t\t\t\t\t\t\t\t\tfield: x.toLowerCase(),\n\t\t\t\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\t\t\t\teditable: {\n\t\t\t\t\t\t\t\t\t\temptytext : '-'\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (x=='text' || x=='TEXT') isADrawMarker=true;\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (isADrawMarker && feature.geometry.type==\"Point\"){ //Nomes pintem longitud/latitud quan és un punt\n\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\n\t\t\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\n\t\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t obj = {\n\t\t\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\n\t\t\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\n\t\t\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t columNames.push(obj);\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t//Actions\n\t\t\t\t\tvar objActions = {\n\t\t\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\n\t\t\t\t\t\t\tfield: 'Accions',\n\t\t\t\t\t\t\tformatter: 'actionFormatter',\n\t\t\t\t\t\t\tevents: 'actionEvents'\n\t\t\t\t\t}\t\n\t\t\t\t\tcolumNames.push(objActions);\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t//Taula no editable pel visor\n\t\t\t\t\t//properties headers\n\t\t\t\t\tvar isADrawMarker=false;\n\t\t\t\t\tif (options.propName!=undefined && options.propName.toString().indexOf(\"nom,text\")==-1) {\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tfor(var x in options.propName){\n\t\t\t\t\t\t\t\tif (options.propName[x].toLowerCase()!=\"geomorigen\") {\n\t\t\t\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\t\t\ttitle: options.propName[x].toUpperCase(),\n\t\t\t\t\t\t\t\t\t\tfield: options.propName[x].toLowerCase(),\n\t\t\t\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif (options.propName[x]=='text' || options.propName[x]=='TEXT') isADrawMarker=true;\n\t\t\t\t\t\t\t\t\telse isADrawMarker=false;\n\t\t\t\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tfor(var x in feature.properties){\n\t\t\t\t\t\t\tif (x.toLowerCase()!=\"geomorigen\"){\n\t\t\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\t\ttitle: x.toUpperCase(),\n\t\t\t\t\t\t\t\t\tfield: x.toLowerCase(),\n\t\t\t\t\t\t\t\t\tsortable: true\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (x=='text' || x=='TEXT') isADrawMarker=true;\n\t\t\t\t\t\t\t\telse isADrawMarker=false;\n\t\t\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\n\t\t\t\t\tif (isADrawMarker){\n\t\t\t\t\t\tvar obj = {\n\t\t\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\n\t\t\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\n\t\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\tcolumNames.push(obj);\n\t\t\t\t\t\t obj = {\n\t\t\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\n\t\t\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\n\t\t\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t columNames.push(obj);\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t//Actions\n\t\t\t\t\tvar objActions = {\n\t\t\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\n\t\t\t\t\t\t\tfield: 'Accions',\n\t\t\t\t\t\t\tformatter: 'actionFormatterVisor',\n\t\t\t\t\t\t\tevents: 'actionEvents'\n\t\t\t\t\t}\t\n\t\t\t\t\tcolumNames.push(objActions);\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t});\n\t\t\t\n\t\t\t//return false;\n\t\t});\t\n\t}\n\telse {//Primer cop que dibuixem una geometria\n\t\t//Geometry Id\n\t\tvar objGeomId = {\n\t\t\t\tfield: 'geometryid',\n\t\t\t\ttitle: 'ID',\n\t\t\t\tvisible: false\n\t\t}\n\t\tcolumNames.push(objGeomId);\t\n\n\t\t//Geometry Bid \n\t\tvar objGeomBid = {\n\t\t\t\tfield: 'geometrybid',\n\t\t\t\ttitle: 'BID',\n\t\t\t\tvisible: false\n\t\t}\n\t\tcolumNames.push(objGeomBid);\t\t\t\n\t\t\n\t\t//geometryBBOX\n\t\tvar objGeomBBOX = {\n\t\t\t\tfield: 'geometryBBOX',\n\t\t\t\ttitle: 'BBOX',\n\t\t\t\tvisible: false \n\t\t}\n\t\tcolumNames.push(objGeomBBOX);\t\t\n\t\t//console.debug(options);\n\t\tif(modeMapa){\n\t\t\tvar isADrawMarker=true;\n\t\t\t//properties headers\n\t\t\t//console.debug(feature);\n\t\t\n\t\t\tvar obj2 = {\n\t\t\t\t\ttitle: \"nom\".toUpperCase(),\n\t\t\t\t\tfield: \"nom\".toLowerCase(),\n\t\t\t\t\tsortable: true,\n\t\t\t\t\teditable: {\n\t\t\t\t\t\temptytext : '-'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\tcolumNames.push(obj2);\n\t\t\tobj2 = {\n\t\t\t\t\ttitle: \"text\".toUpperCase(),\n\t\t\t\t\tfield: \"text\".toLowerCase(),\n\t\t\t\t\tsortable: true,\n\t\t\t\t\teditable: {\n\t\t\t\t\t\temptytext : '-'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\tcolumNames.push(obj2);\n\t\t\t\n\t\t\tif (isADrawMarker && options.geometryType==\"marker\"){ //Nomes pintem longitud/latitud quan és un punt\n\t\t\t\tvar obj2 = {\n\t\t\t\t\t\ttitle: \"latitud\".toUpperCase(),\n\t\t\t\t\t\tfield: \"latitud\".toLowerCase(),\n\t\t\t\t\t\tsortable: true\n\t\t\t\t\t}\n\t\t\t\tcolumNames.push(obj2);\n\t\t\t\t obj2 = {\n\t\t\t\t\t\t\ttitle: \"longitud\".toUpperCase(),\n\t\t\t\t\t\t\tfield: \"longitud\".toLowerCase(),\n\t\t\t\t\t\t\tsortable: true\n\t\t\t\t\t\t}\n\t\t\t\t columNames.push(obj2);\n\t\t\t}\n\t\t\t\n\t\t\t//Actions\n\t\t\tvar objActions = {\n\t\t\t\t\ttitle: window.lang.translate(\"ACCIONS\"),\n\t\t\t\t\tfield: 'Accions',\n\t\t\t\t\tformatter: 'actionFormatter',\n\t\t\t\t\tevents: 'actionEvents'\n\t\t\t}\t\n\t\t\tcolumNames.push(objActions);\n\t\t\t\n\t\t}\n\t\t\n\t}\n\t\n\twindow.actionEvents = {\n\t\t    'click .remove': function (e, value, row, index) {\n\t\t    \t//Afegim parametres al button del dialog, per despres poder fer crida al remove\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"geometryid\", row.geometryid);\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"geometriesBusinessId\", geometriesBusinessId);\n\t\t    \t$('#dialog_delete_row .btn-danger').data(\"businessId\", obj.layer.options.businessId);\n\t\t    \t\n\t\t    \t$('#dialog_delete_row').modal('show');\n\t\t    },\n\t        'click .zoomTo': function (e, value, row, index) {\n\t        \t$('#modal_data_table').modal('hide');\n\t        \tvar coords = row.geometryBBOX.split(\"#\"); \n\t\t\t\tvar bbox = L.latLngBounds(L.latLng(coords[1], coords[0]), L.latLng(coords[3], coords[2]));\n\t\t\t\tmap.fitBounds(bbox);\n\t        }\n\t\t};\t\n\n\t//Portem properties del servidor\n\tvar data ={\n\t\t\tbusinessId: obj.layer.options.businessId,\n\t\t\tuid:Cookies.get('uid')\n\t\t};\n\t\n\t\n\tgetGeometriesPropertiesLayer(data).then(function(results){\n\t\t\t\n\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\n\t\t\t\tgeometriesBusinessId = results.geometriesBusinessId;\n\t\t\t\t$('#modal_data_table').data(\"layerServidor\", results.layer);\n\t\t\t\tvar resultats = results.results;\n\t\t\t\tvar coords = resultats.split(\"#\");  \n\t\t\t\tvar lon = parseFloat(coords[2]);\n\t\t\t\tvar lat = parseFloat(coords[1]);\n\t\t\t\t//resultats = resultats.replace(\"}]\",\",\\\"longitud\\\":\\\"\"+lon.toFixed(5)+\"\\\",\\\"latitud\\\":\\\"\"+lat.toFixed(5)+\"\\\"}]\");\n\t\t\t\tvar resultats2 = $.parseJSON(resultats);\n\t\t\t\tvar resultatsMod = [];\n\t\t\t\tvar resultI=0;\n\t\t\t\tvar haveGeomOrigen=false;\n\t\t\t\tjQuery.each(resultats2, function(i, result){\n\t\t\t\t\tvar coords = result.geometryBBOX.split(\"#\");  \n\t\t\t\t\tvar lon = parseFloat(coords[2]);\n\t\t\t\t\tvar lat = parseFloat(coords[1]);\n\t\t\t\t\tif (result.longitud==undefined)  result.longitud=lon.toFixed(5);\n\t\t\t\t\tif (result.latitud==undefined)  result.latitud=lat.toFixed(5);\t\t\t\t\t\n\t\t\t\t\t$.each( result, function( key, value ) {\n\t\t\t\t\t\tif (key.toLowerCase()!=\"geomorigen\"){\n\t\t\t\t\t\t\tvar valorStr=value.toString();\n\t\t\t\t\t\t\tif (valorStr.indexOf(\"src\")>-1){\n\t\t\t\t\t\t\t\tvalue=valorStr.replaceAll('\"',\"'\");//Issue #560\n\t\t\t\t\t\t\t\t//console.debug(value);\n\t\t\t\t\t\t\t\tresult[key]=value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse result[key]=value;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tresult[key] = null;\n\t\t\t\t\t\t\tdelete result[key];\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tresultatsMod[resultI]=result;\n\t\t\t\t\t\n\t\t\t\t\tresultI++;\n\t\t\t\t\t//console.debug(result);\n\t\t\t\t\t\n\t\t\t\t});\n\t\t\t\tvar showRefresh=false;\n\t\t\t\tif (mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC) showRefresh=true;\n\t\t\t\t$('#modal_data_table_body #layer-data-table').bootstrapTable({\n\t\t\t\t\tsearch: true,\n\t\t\t\t\tstriped: true,\n\t\t\t\t\theight: '600',\n\t\t\t\t\tidField: 'geometryid',\n//\t\t\t\t\tclickToSelect: true,\n//\t\t\t\t\tcheckboxHeader: true,\n//\t\t\t\t\tshowColumns: true,\n//\t\t\t\t\t showHeader: true,\n\t\t\t\t\trowStyle: 'rowStyle',\n\t\t\t\t    columns: columNames,\n\t\t\t\t    showExport: true,\t\t\t\n\t\t\t\t    showRefresh: showRefresh,\n\t\t\t\t    exportTypes: ['json', 'csv', 'txt', 'excel'],\n\t\t\t\t    ignoreColumn: [columNames.length-4],\n\t\t\t\t    data: resultatsMod,\n\t\t\t\t    icons: {\n\t\t\t\t       refresh: 'glyphicon-refresh'\n\t\t\t\t    }\n\t\t\t\t});\t\n\t\t\t\t\n\n\t\t\t\t$('#modal_data_table').on('editable-save.bs.table', function(event, name, row, \toldValue, param) {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tevent.stopImmediatePropagation();\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tif(isValidValue(name)){\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar dataUpdate ={\n\t\t\t\t\t\t\t\tuid:Cookies.get('uid'),\n\t\t\t\t\t\t\t\tgeometryid: row[\"geometryid\"],\n\t\t\t\t\t\t\t\tkey:  name,\n\t\t\t\t\t\t\t\tnewValue: row[name]\n\t\t\t\t\t\t\t};\n//\t\t\t\t\t\tconsole.debug(dataUpdate);\n\t\t\t\t\t\tupdateGeometriaProperties(dataUpdate).then(function(results){\n\t\t\t\t\t\t\tif (results.status == \"OK\"){\n//\t\t\t\t\t\t\t\tconsole.debug(results);\n\t\t\t\t\t\t\t\teditat = true;\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tconsole.debug('error updateGeometriaProperties');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},function(results){\n\t\t\t\t\t\t\tconsole.debug('error updateGeometriaProperties');\n\t\t\t\t\t\t});\t\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t});\t\n\t\t\t\t\n\t\t\t\t$('[name=\"refresh\"]').on('click',function(){\n\t\t\t\t\tvar capaEdicio = $('#modal_data_table').data(\"capaEdicio\");\n\t\t\t\t\t$('#modal_data_table').modal('hide');\n\t\t\t\t\tcarregarModalFitxer(true,obj.layer.options.businessId,obj.name,this.dataset.servertype,capaEdicio);\n\t\t\t\t\t\n\t\t\t\t\t//Tornem a carregar les dades de la visualització\n\t\t\t\t\t/*updateGeometries(data).then(function(results){\n\t\t\t\t\t\tif (results.status == \"OK\"){\n\t\t\t\t\t\t\teditat = true;\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.debug('error updateGeometries');\n\t\t\t\t\t\t}\n\t\t\t\t\t\t},function(results){\n\t\t\t\t\t\t\tconsole.debug('error updateGeometries');\n\t\t\t\t\t\t});\t\t\t\t\t\t\t\n\t\t\t\t\t}*/\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t}else{\n\t\t\t\tconsole.debug('error getGeometriesPropertiesLayer');\n\t\t\t}\n\t\t},function(results){\n\t\t\tconsole.debug('error getGeometriesPropertiesLayer');\n\t\t});\n\t\n}\n\nfunction rowStyle(row, index) {\n\t\n\tnumRows = numRows + 1;\n\tif (row.geometrybid == geomBusinessId) {\n//    \tconsole.debug(\"rowStyle:\");\n   \n//    \tconsole.debug(index);\n    \tgeomRowIndex = index;\n        return {\n            classes: 'success'//classes[index / 2]\n        };\n    }\n    return {};\n\t\n//    var classes = ['active', 'success', 'info', 'warning', 'danger'];\n//    \n//    if (index % 2 === 0 && index / 2 < classes.length) {\n//    \tconsole.debug(\"rowStyle:\");\n//    \tconsole.debug(row);\n//        return {\n//            classes: classes[index / 2]\n//        };\n//    }\n//    return {};\n}\n\nfunction actionFormatter(value, row, index) {\n    return [\n        '<a class=\"zoomTo\" href=\"javascript:void(0)\" title=\"ZoomTo\">',\n        '<i class=\"glyphicon glyphicon-zoom-in data-table-icon-zoom\"></i>',            \n        '<a class=\"remove ml10\" href=\"javascript:void(0)\" title=\"Remove\">',\n        '<i class=\"glyphicon glyphicon-trash data-table-icon-remove\"></i>',\n        '</a>'\n    ].join('');\n}\n\nfunction actionFormatterVisor(value, row, index) {\n    return [\n        '<a class=\"zoomTo\" href=\"javascript:void(0)\" title=\"ZoomTo\">',\n        '<i class=\"glyphicon glyphicon-zoom-in data-table-icon-zoom\"></i>',            \n        '</a>'\n    ].join('');\n}\n\nfunction removeGeometryDB(geometryid, businessId, geometriesBusinessId){\n\t\n\tvar data ={\n\t\t\tbusinessId: businessId,\n\t\t\tuid:Cookies.get('uid'),\n\t\t\tgeometryid: geometryid,\n\t\t\tgeometriesBusinessId: geometriesBusinessId\n\t\t};\n\t\n\tremoveGeometriaFromProperties(data).then(function(results){\n\t\t\n\t\tif(results.status == \"OK\"){\n\t\t\teditat = true;\n\t\t    $('#modal_data_table_body #layer-data-table').bootstrapTable('remove', {\n\t            field: 'geometryid',\n\t            values: [geometryid]\n\t        }); \n\t\t}else{\n\t\t\tconsole.debug(\"ERROR removeGeometriaFromProperties\");\n\t\t}\n\t\t\n\t},function(results){\n\t\tconsole.debug(\"ERROR removeGeometriaFromProperties\");\n\t});\n\t\n}\n\nfunction addHtmlModalDataTable(){\n\t\n\tjQuery('#mapa_modals').append(\n\t'<!-- Modal Data Table -->'+\n\t'\t\t<div id=\"modal_data_table\" class=\"modal fade\">'+\n\t'\t\t<div class=\"modal-dialog modal-lg\">'+\n\t'\t\t\t<div class=\"modal-content panel-primary\">'+\n\t'\t\t\t\t<div class=\"modal-header panel-heading\">'+\n\t'\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button>'+\n\t'\t\t\t\t\t<h4 lang=\"ca\" id=\"modal_data_table_title\"  class=\"modal-title\"></h4>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div id=\"modal_data_table_body\" class=\"modal-body\">'+\n//\t'\t\t\t\t\t<div id=\"div-table\">'+\n//\t'\t\t\t\t\t\t<div class=\"cell-left\">'+\n\t'\t\t\t\t\t\t\t<div id=\"layer-data-table\"></div>'+\n//\t'\t\t\t\t\t\t</div>'+\n//\t'\t\t\t\t\t\t<div class=\"cell-right\"></div>'+\n//\t'\t\t\t\t\t\t<div class=\"clearfix\"></div>'+\n//\t'\t\t\t\t\t</div>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t'\t\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\" lang=\"ca\">Tancar</button>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t<!-- /.modal-content -->'+\n\t'\t\t</div>'+\n\t'\t\t<!-- /.modal-dialog -->'+\n\t'\t</div>'+\n\t'<!-- fi Data Table -->'\t\t\n\t);\n}\n\nfunction addHtmlModalDeleteDataTableRow(){\n\t\n\tjQuery('#mapa_modals').append(\n\t'<!-- Modal delete data table row -->'+\n\t'\t\t<div id=\"dialog_delete_row\" class=\"modal fade\">'+\n\t'\t\t<div class=\"modal-dialog\">'+\n\t'\t\t\t<div class=\"modal-content\">'+\n\t'\t\t\t\t<div class=\"modal-body\">'+\n\t'\t\t\t\t\t<h4><span lang=\"ca\">Vols esborrar la fila?</span></h4>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t\t<div class=\"modal-footer\">'+\n\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn btn-default\"'+\n\t'\t\t\t\t\t\tdata-dismiss=\"modal\">Cancel·lar</button>'+\n\t'\t\t\t\t\t<button lang=\"ca\" type=\"button\" class=\"btn btn-danger\"'+\n\t'\t\t\t\t\t\tdata-dismiss=\"modal\">Esborrar</button>'+\n\t'\t\t\t\t</div>'+\n\t'\t\t\t</div>'+\n\t'\t\t\t<!-- /.modal-content -->'+\n\t'\t\t</div>'+\n\t'\t\t<!-- /.modal-dialog -->'+\n\t'\t</div>'+\n\t'\t<!-- /.modal -->'+\n\t'\t<!-- Fi Modal delete -->\t'\t\t\n\t);\n}\n\n","/**\n * InstamapsLayers \n * \n * require todos los archivos con los diferentes tipos de capas\n * require geocat.mapa.wms\n * require geocat.mapa.json\n * require geocat.mapa.tematic\n * require geocat.mapa.url-file\n * require geocat.mapa.geojsonvt\n * require geocat.mapa.dades-obertes\n * require geocat.mapa.xarxes-socials\n * require geocat.mapa.heat\n * require geocat.mapa.cluster\n * require geocat.mapa.visualitzacioWMS\n */\n;(function(global, $){\n\tvar InstamapsLayers = function(options){\n\t\treturn new InstamapsLayers.init(options);\n\t};\n\t\n\tInstamapsLayers.prototype = {\n\t\tloadLayer: function(value){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\tdefer = $.Deferred();\n\n\t\t\tif (value.epsg == \"4326\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG4326;\n\t\t\t}else if (value.epsg == \"25831\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG25831;\n\t\t\t}else if (value.epsg == \"23031\"){\n\t\t\t\tvalue.epsg = L.CRS.EPSG23031;\n\t\t\t}else{\n\t\t\t\tvalue.epsg = _map.options.crs;\n\t\t\t}\n\n\t\t\t//Si la capa es de tipus wms\n\t\t\tif(value.serverType == t_wms){\n\t\t\t\tloadWmsLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_json){\n\t\t\t\tloadCapaFromJSON(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus url file\n\t\t\t}else if(value.serverType == t_url_file){\n\t\t\t\tloadURLfileLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t},function(result){\n\t\t\t\t\tdefer.reject(result);\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_geojsonvt){\n\t\t\t\t//console.debug(loadGeojsonvtLayer);\n\t\t\t\tloadGeojsonvtLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t//Si la capa es de tipus dades obertes\n\t\t\t}else if(value.serverType == t_dades_obertes){\n\t\t\t\tloadDadesObertesLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t},function(result){\n\t\t\t\t\tdefer.reject(result);\n\t\t\t\t});\n\t\t\t//Si la capa es de tipus xarxes socials\n\t\t\t}else if(value.serverType == t_xarxes_socials){\n\t\t\t\tvar options = $.parseJSON( value.options );\n\t\t\t\tif(options.xarxa_social == 'twitter') loadTwitterLayer(value, options.hashtag);\n\t\t\t\telse if(options.xarxa_social == 'panoramio') loadPanoramioLayer(value);\n\t\t\t\telse if(options.xarxa_social == 'wikipedia') loadWikipediaLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}else if(value.serverType == t_tematic){\n\t\t\t\tloadTematicLayer(value).then(function(){\n\t\t\t\t\tdefer.resolve();\n\t\t\t\t});\n\t\t\t}else if(value.serverType == t_visualitzacio){\n\t\t\t\tif (self.edit) {\n\t\t\t\t\tloadVisualitzacioLayer(value).then(function(){\n\t\t\t\t\t\tdefer.resolve();\n\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tloadCacheVisualitzacioLayer(value).then(function(){\n\t\t\t\t\t\tdefer.resolve();\n\t\t\t\t\t});\t\n\t\t\t\t}\n\t\t\t//Si la capa es de tipus vis_wms\n\t\t\t}else if(value.serverType == t_vis_wms || value.serverType == t_vis_wms_noedit){\n\t\t\t\tloadVisualitzacioWmsLayer(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}\n\t\t\telse if(value.serverType == tem_heatmap_wms || value.serverType == tem_cluster_wms){\n\t\t\t\tloadVisualitzacioWmsLayerSenseUtfGrid(value);\n\t\t\t\tdefer.resolve();\n\t\t\t}else{\n\t\t\t\tconsole.error(\"Tipus capa no soportat\");\n\t\t\t\tdefer.reject({msg:\"Tipus capa no soportat\"});\n\t\t\t}\n\n\t\t\treturn defer.promise();\n\t\t}, \n\t\t\n\t\t_loadAllLayers: function(_mapConfig, _controlCapes){\n\t\t\tvar self = this,\n\t\t\tdfd = $.Deferred();\n\t\t\tself.waitDeferred = dfd;\n\t\t\t\n\t\t\tself._loadOrigenWMS(_mapConfig, _controlCapes).then(function(results){\n\t\t\t\tvar num_origen = 0;\n\t\t\t\tself.numLayers = results.origen.length + results.sublayers.length;\n\t\t\t\tif(self.numLayers === 0){\n\t\t\t\t\tself._waitLoadAll(0);\n\t\t\t\t}\n\n\t\t\t\tif (!self.edit)\n\t\t\t\t{\n\t\t\t\t\n\t\t\t\t\tself.map.oms = new OverlappingMarkerSpiderfier(self.map, {keepSpiderfied : false});\n\t\t\t\t\tvar popup = new L.Popup();\n\t\t\t\t\tself.map.oms.addListener('click', function(marker) {\n\n\t\t\t\t\t\tif(marker.getPopup)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tpopup.setContent(marker.getPopup().getContent());\n\t\t\t\t\t\t\tpopup.setLatLng(marker.getLatLng());\n\t\t\t\t\t\t\tself.map.openPopup(popup);\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\t$.each(results.origen, function(index, value){\n\n\t\t\t\t\tself.loadLayer(value).then(function(){\n\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\tif (num_origen == results.origen.length){\n\t\t\t\t\t\t\t$.each(results.sublayers, function(index, value){\n\t\t\t\t\t\t\t\tself.loadLayer(value).then(function(){\n\t\t\t\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\t\t\t},function(){\n\t\t\t\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t},function(){\n\t\t\t\t\t\tnum_origen++;\n\t\t\t\t\t\tself._waitLoadAll(num_origen);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn dfd.promise();\n\t\t},\n\t\t\t\t\n\t\t_waitLoadAll: function(numLayers){\n\t\t\tvar self = this;\n\t\t\tif(self.numLayers === numLayers){\n\t\t\t\tself.waitDeferred.resolve();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_loadOrigenWMS: function(_mapConfig, _controlCapes){\n\t\t\tvar dfd = $.Deferred(),\n\t\t\tlayer_map = {origen:[],sublayers:[]};\n\t\t\t\n\t\t\t$.each(_mapConfig.servidorsWMS, function(index, value){\n\t\t\t\t//TODO parsear las options y el group y dejarlo en json.\n\t\t\t\t//TODO quitar el parse de cada tipo de capa.\n\t\t\t\tif(value.options && value.capesGroup){\n\t\t\t\t\tvar options;\n\t\t\t\t\tif(typeof (value.options)==\"string\"){\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\toptions = JSON.parse(value.options);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\t\toptions = value.options;\n\t\t\t\t\t\t}\n\t\t\t\t\t}else{\n\t\t\t\t\t\toptions = value.options;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar group = JSON.parse(value.capesGroup);\n\t\t\t\t\toptions.group = group;\n\t\t\t\t\tvalue.options = JSON.stringify(options);\n\t\t\t\t}\n\t\t\t\tif(value.capesOrdre == capesOrdre_sublayer){\n\t\t\t\t\tlayer_map.sublayers.push(value);\n\t\t\t\t\tlsublayers.push(value); //variable global se tendría que quitar\n\t\t\t\t}else{\n\t\t\t\t\tlayer_map.origen.push(value);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(layer_map.origen, function(index, value){\n\t\t\t\tvar jsonOptions;\n\t\t\t\tif(typeof (value.options)==\"string\"){\n\t\t\t\t\ttry {\n\t\t\t\t\t\tjsonOptions = JSON.parse(value.options);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\tjsonOptions = value.options;\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tjsonOptions = value.options;\n\t\t\t\t}\n\n\t\t\t\tif(jsonOptions && jsonOptions.group){\n\t\t\t\t\tif(_controlCapes){\n\t\t\t\t\t\t_controlCapes._addGroupFromObject(jsonOptions.group);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tdfd.resolve(layer_map);\n\t\t\treturn dfd.promise();\n\t\t},\n\n\t};\n\t\n\tInstamapsLayers.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, options);\n\t};\n\t\n\tInstamapsLayers.init.prototype = InstamapsLayers.prototype;\n\t\n\tglobal.InstamapsLayers = InstamapsLayers;\n\t\n}(window, jQuery));","/**\n * \n */\n;(function(global, $){\n\tvar InstamapsWms = function(options){\n\t\treturn new InstamapsWms.init(options);\n\t};\n\t\n\tvar _options = {\n\t\tproxyUrl: \"http://www.instamaps.cat/share/jsp/ows2json.jsp?\"\t\n\t};\n\t\n\tInstamapsWms.prototype = {\n\t\tinitUi: function(){\n\t\t\tvar self = this;\n\t\t\tself._div = self.container;\n\t\t\tself._botons = self.botons;\n\t\t\tif (self.loadTemplateParam==undefined) self.loadTemplate();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tloadTemplate: function(){\n\t\t\tvar self = this;\n\t\t\t$.get(\"templates/wmsTemplate.html\",function(data){\n\t\t\t\tself._div.html(data);\n\t\t\t\tself._uiloaded = true;\n\t\t\t\t$(\".layers-wms\").hide();\n\t\t\t\t\n\t\t\t\t$(\".url-wms\").focus(function() {\n\t\t\t\t\tself.clear();\n\t\t\t\t\t//jQuery('#txt_URLWMS').val('');\n\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t$(\".btn-conn-wms\").on('click', function(e) {\n\t\t\t\t\t\n\t\t\t\t\tvar input = $(e.target).closest('.txt_ext').find('.url-wms');\t\t\t\t\t\n\t\t\t\t    var url = $.trim(input.val());\n\t\t\t\t\t\n\t\t\t\t\tif (url === \"\") {\n\t\t\t\t\t\talert(window.lang.translate(\"Has d'introduïr una URL del servidor\"));\n\t\t\t\t\t} else if (!isValidURL(url)) {\n\t\t\t\t\t\talert(window.lang.translate(\"La URL introduïda no sembla correcte\"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tself.getCapabilities({url:url});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\t\n\t\t\t});\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tclear: function(){\n\t\t\tvar self = this;\n\t\t\t$('.layers-wms').html('');\n\t\t\t$(\".layers-wms\").hide();\n\t\t\tself._botons.empty();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tshow: function(){\n\t\t\tvar self = this;\n\t\t\t$(\".layers-wms\").show();\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tgetLayers: function(options){\n\t\t\tvar self = this;\n\t\t\t$(\".url-wms\").val(options.url);\n\t\t\tself.url = options.url;\n\t\t\tself.name = options.name;\t\t\t\n\t\t\toptions.capa ? self.capa=options.capa : self.capa=null;\t\t\t\n\t\t\tself.getCapabilities();\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tgetWMSLayers: function(data){\n\t\t\tvar self = this;\n\t\t\treturn jQuery.ajax({\n\t\t\t\turl: self.proxyUrl,\n\t\t\t\tdata: data,\n\t\t\t\tasync: true,\n\t\t\t\tmethod: 'post',\n\t\t\t\tdataType: 'jsonp',\n\t\t\t\ttimeout: 12000 //timeout WMS\n\t\t\t}).promise();\n\t\t},\n\t\t\n\t\tgetCapabilities: function(options){\n\t\t\tvar self = this,\n\t\t\t\tActiuWMS = {};\n\t\t\t\n\t\t\tself = $.extend(self, options);\n\t\t\tvar data = {url: self.url, capa:self.capa};\n\t\t\t\n\t\t\tself.getWMSLayers(data).then(function(results) {\n\t\t\t\tvar bbox, servidor, WMS_BBOX,\n\t\t\t\tsouce_capabilities_template = $(\"#capabilities-template\").html(),\n\t\t\t\tcapabilities_template = Handlebars.compile(souce_capabilities_template);\n\t\t\t\t\n\t\t\t\tHandlebars.registerPartial( \"list-template\", $( \"#list-template\" ).html() );\n\t\t\t\tHandlebars.registerHelper('layer', function(context, options) {\n\t\t\t\t  var ret = \"\";\n\t\t\t\t  if (!Handlebars.Utils.isArray(context)){\n\t\t\t\t\t  context = [context];\n\t\t\t\t  }\n\t\t\t\t  for(var i=0, j=context.length; i<j; i++) {\n\t\t\t\t\t  if (!Handlebars.Utils.isArray(context[i])){\n\t\t\t\t\t\t  ret = ret + options.fn(context[i]);\n\t\t\t\t\t  }else{\n\t\t\t\t\t\t  for(var k=0, l=context.length; k<l; k++) {\n\t\t\t\t\t\t\t  ret = ret + options.fn(context[i][k]);\n\t\t\t\t\t\t  }\n\t\t\t\t\t  }\n\t\t\t\t  }\n\t\t\t\t  return ret;\n\t\t\t\t});\n\t\t\t\tHandlebars.registerHelper(\"debug\", function(optionalValue) {\n\t\t\t\t  console.log(\"Current Context\");\n\t\t\t\t  console.log(\"====================\");\n\t\t\t\t  console.log(this);\n\t\t\t\t \n\t\t\t\t  if (optionalValue) {\n\t\t\t\t    console.log(\"Value\");\n\t\t\t\t    console.log(\"====================\");\n\t\t\t\t    console.log(optionalValue);\n\t\t\t\t  }\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tself.clear().show();\n\n\t\t\t\tif (servidor == null) {\n\t\t\t\t\tservidor = results.Service.Title;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\ttry{\n\t\t\t\t\tif(results.Capability.Layer.Layer.LatLonBoundingBox){\n\t\t\t\t\t\tbbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else if(results.Capability.Layer.LatLonBoundingBox){\n\t\t\t\t\t\tbbox = results.Capability.Layer.LatLonBoundingBox;\n\t\t\t\t\t\tWMS_BBOX=[[bbox[\"@miny\"], bbox[\"@minx\"]],[bbox[\"@maxy\"], bbox[\"@maxx\"]]];\n\t\t\t\t\t}else{\n\t\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t\t}\t\n\t\t\t\t} catch (err) {\n\t\t\t\t\tWMS_BBOX=null;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\ttry {\n\t\t\t\t\tvar matriuEPSG = results.Capability.Layer.CRS,\n\t\t\t\t\tepsg = [],\n\t\t\t\t\thtml = \"\";\n\t\t\t\t\t\n\t\t\t\t\tif($.isArray(results.Capability.Layer)){\n\t\t\t\t\t\thtml = capabilities_template({Layer: results.Capability.Layer});\n\t\t\t\t\t}else{\n\t\t\t\t\t\thtml = capabilities_template({Layer: [results.Capability.Layer]});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tActiuWMS.servidor = self.name || servidor || results.Capability.Layer.Title;\n\t\t\t\t\tActiuWMS.url = self.url;\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer.SRS;\n\t\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].CRS;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (!matriuEPSG) {\n\t\t\t\t\t\t\t\tmatriuEPSG = results.Capability.Layer[0].SRS;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($.isArray(matriuEPSG)){\n\t\t\t\t\t\t$.each(matriuEPSG, function(index, value) {\n\t\t\t\t\t\t\tepsg.push(value);\n\t\t\t\t\t\t});\n\t\t\t\t\t}else{\n\t\t\t\t\t\tepsg.push(matriuEPSG);\n\t\t\t\t\t}\n\t\t\t\n\t\t\t\t\tif ($.inArray('EPSG:3857', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t\t\t} else if ($.inArray('EPSG:900913', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG3857;\n\t\t\t\t\t\tActiuWMS.epsgtxt = 'EPSG:3857';\n\t\t\t\t\t} else if ($.inArray('EPSG:4326', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t\t\t} else if ($.inArray('CRS:84', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\n\t\t\t\t\t} else if ($.inArray('EPSG:4258', epsg) != -1) {\n\t\t\t\t\t\tActiuWMS.epsg = L.CRS.EPSG4326;\n\t\t\t\t\t\tActiuWMS.epsgtxt = '4326';\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\talert(window.lang.translate(\"No s'ha pogut visualitzar aquest servei: Instamaps només carrega serveis WMS globals en EPSG:3857 i EPSG:4326\"));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tself.ActiuWMS = ActiuWMS;\n\t\t\t\t\t\n\t\t\t\t\t$('.layers-wms').empty().append(html);\n\t\t\t\t\tself.addTreeEvents();\n\t\t\t\t\tself._botons.empty();\n\t\t\t\t\tself._botons.html(\n\t\t\t\t\t\t'<div style=\"float:right\"><button lang=\"ca\" class=\"btn btn-success btn-add-wms\" >' +\n\t\t\t\t\t\twindow.lang.translate(\"Afegir capes\") + '</button></div>');\n\t\t\t\t\t\n\t\t\t\t\t//if(self.capa){\n\t\t\t\t\tif(self.hasOwnProperty('capa')){\n\t\t\t\t\t\tvar ls;\n\t\t\t\t\t\tvar hits=0;\n\t\t\t\t\t\t//para las capas con nombres de números y que solo son dos capas\n\t\t\t\t\t\t//en el excel puede variar el formato y poner 5.5 en lugar de 5.1\n\t\t\t\t\t\tif(self.capa == null){\n\t\t\t\t\t\t\tself.capa=\"null\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tself.capa = self.capa.replace(/(\\d)\\.(\\d)/,\"$1,$2\");\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(self.capa.indexOf(\",\")!=-1){\t\t\t\t\t\t\t\t//hi ha més una capa\n\t\t\t\t\t\t\tls=self.capa.split(\",\");\n\t\t\t\t\t\t\tfor(i=0; i < ls.length;i++){\n\t\t\t\t\t\t\t\thits=hits + self._ckechLayerWMS(ls[i]);\n\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tls=self.capa;\n\t\t\t\t\t\t\thits=hits + self._ckechLayerWMS(ls);\n\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(hits > 0){\n\t\t\t\t\t\t\tself.addExternalWMS(false);\t\t\t\t\t\t\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tjQuery(\"#div_controlWMS_OFICIALS\").show();\n\t\t\t\t\t\t\tjQuery(\"#div_emptyWMS_OFICIALS\").show();\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t}else{\n\t\t\t\t\t\tjQuery(\"#div_controlWMS_OFICIALS\").show();\n\t\t\t\t\t\tjQuery(\"#div_emptyWMS_OFICIALS\").show();\n\t\t\t\t\t}\n\t\t\t\t\t//ckbox_layer\t\t\t\t\t\n\t\t\t\t\t$(\".btn-add-wms\").on('click', function(e) {\n\t\t\t\t\t    self.addExternalWMS(false);\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.debug(err);\n\t\t\t\t\t$('.layers-wms').html('<hr lang=\"ca\">'+window.lang.translate(\"Error en interpretar capabilities\")+': ' + err + '</hr>');\n\t\t\t\t}\n\t\t\t},function(data,status,error){\n\t\t\t\tstatus.indexOf('parser')!=-1?alert(window.lang.translate(\"Error en interpretar capabilities\")):alert(window.lang.translate(\"Error: No s'ha pogut executar l'operació\"));\n\t\t\t\t\n\t\t\t\t});\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_ckechLayerWMS: function(layerName){\n\t\t\tvar self = this;\n\t\t\tvar hit=0;\n\t\t\tjQuery(\".ckbox_layer\").each(function() {\t\t\n\t\t\t\tif(this.value==layerName){\t\t\t\t\n\t\t\t\tjQuery(this).prop('checked',true);\n\t\t\t\thit=hit +1;\t\t\t\t\n\t\t\t\t}\t\t\t\t\n\t\t\t});\t\t\t\n\t\t\treturn hit;\t\t\t\n\t\t},\t\n\t\t\n\t\t_getChekedLayers:function(){\n\t\t\tvar ch=0;\n\t\t\t$(\".ckbox_layer\").each(function() {\n\t\t\t\tif(jQuery(this).prop('checked')){\n\t\t\t\t\tch=ch + 1;\n\t\t\t\t}\n\t\t\t\treturn ch;\t\t\t\t\t\n\t\t\t});\t\n\t\t},\t\n\t\t\n\t\taddExternalWMS: function(){\n\t\t\tvar self = this,\n\t\t\t_dateFormat = false;\n\t\t\t\t\t\t\n\t\t\tvar cc = $('.layers-wms input:checked').map(function(){\n\t\t\t\tvar name = this.value.replace(/:/g,\"\\\\\\:\");\n\t\t\t\ttry{\n\t\t\t\t\tif($('#geoservicetime_'+name).length > 0){\n\t\t\t\t\t\t_dateFormat = true;\n\t\t\t\t\t}\n\t\t\t\t}catch(e){\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\treturn this.value;\n\t\t\t});\n\t\t\t\n\t\t\tcc = jQuery.makeArray(cc);\n\t\t\tcc = cc.join(',');\n\t\t\t\t\t\t\n\t\t\tvar _nomCapesWMS=[];\n\t\t\tvar cc1 = $('.layers-wms input:checked').map(function(){\t\t\t\n\t\t\t\treturn this.id;\n\t\t\t});\n\t\t\t\n\t\t\tcc1 = jQuery.makeArray(cc1);\t\n\t\t\t\n\t\t\t//TODO esto lo debemos activar para la pestaña de WMS y no para las de \n\t\t\t//dades oficials\n\t\t\tif(cc1.length==1){\n\t\t\t\t//self.ActiuWMS.servidor=cc1.join(\" \");\n\t\t\t}\n\t\t\t\n\t\t\tself.ActiuWMS.wmstime = _dateFormat;\n\t\t\t\n\t\t\tif(cc.length === 0){\n\t\t\t\talert(window.lang.translate(\"Has de seleccionar almenys una capa\"));\n\t\t\t}else{\n\t\t\t\tself.ActiuWMS.layers = cc;\n\t\t\t\tif(self.callback){\n\t\t\t\t\tself.callback(self.ActiuWMS);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\taddTreeEvents: function(){\n\t\t\tvar self = this;\n\t\t\t\n\t\t\t$('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');\n\t\t    $('.tree li.parent_li > span').on('click', function (e) {\n\t\t        var children = $(this).parent('li.parent_li').find(' > ul > li');\n\t\t        if (children.is(\":visible\")) {\n\t\t            children.hide('fast');\n\t\t            $(this).attr('title', 'Expand this branch').find(' > i').addClass('glyphicon-folder-close').removeClass('glyphicon-folder-open');\n\t\t        } else {\n\t\t            children.show('fast');\n\t\t            $(this).attr('title', 'Collapse this branch').find(' > i').addClass('glyphicon-folder-open').removeClass('glyphicon-folder-close');\n\t\t        }\n\t\t        e.stopPropagation();\n\t\t    });\n\t\t    \n\t\t    $('.tree li > span.leaf').on('click', function (e) {\n\t\t    \t$(this).children('.ckbox_layer').click();\n\t\t    });\n\t\t    \n\t\t    $('.ckbox_layer').on('click', function (e) {\n\t\t    \te.stopPropagation();\n\t\t    });\n\t\t    \n\t\t    $('.btn-all').on('click',function(){\n\t\t    \t$(this).parent('li.parent_li').find('input:checkbox').prop('checked', true);\n\t\t\t});\n\t\t\t\n\t\t\t$('.btn-none').on('click',function(){\n\t\t\t\t$(this).parent('li.parent_li').find('input:checkbox').prop('checked', false);\n\t\t\t});\n\n\t\t\t$('.btn-invert').on('click',function(){\n\t\t\t\tvar ul = $(this).parent(\"li.parent_li\").find(\".sublayers_list\");\n\t\t\t\tul.children().each(function(i,li){ul.prepend(li)});\n\t\t\t});\n\t\t\t\n\t\t\treturn self;\n\t\t}\n\t\t\n\t};\n\t\n\tInstamapsWms.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, _options, options);\n\t\tself.initUi();\n\t};\n\t\n\tInstamapsWms.init.prototype = InstamapsWms.prototype;\n\t\n\tglobal.InstamapsWms = InstamapsWms;\n\t\n}(window, jQuery));\n","/**\n * TODO Cambiar a la carpeta de leaflet\n */\nL.IM_ControlFons = L.Control.extend({\n\toptions: {\n\t\tcollapsed: true,\n        position: 'bottomleft',\n        title: 'Escollir el mapa de fons',\n        langTitle: 'Escollir el mapa de fons',\n        tooltip: 'right'\n    },\n    \n    onAdd: function (map) {\n    \tthis._initLayout();\n    \t\n    \tthis._div = this._container;\n    \t\n    \treturn this._container;\n    },\n    \n    _initLayout: function(){\n    \tvar self = this,\n\t\toptions = self.options,\n\t\tclassName = 'control-btn-fons',\n\t    container = this._container = L.DomUtil.create('div', className);\n    \t\n    \t// makes this work on IE touch devices by stopping it from firing a mouseout event when the touch is released\n\t\tcontainer.setAttribute('aria-haspopup', true);\n\t\t\n\t\tcontainer.title = options.title;\n\t\tcontainer.dataset.toggle = 'tooltip';\n\t\tcontainer.dataset.placement = options.tooltip;\n\t\tcontainer.dataset.langTitle = options.langTitle;\n\n        var ua = window.navigator.userAgent;\n        var msie = ua.indexOf(\"MSIE \");\n        var version = 11;\n        if (msie > 0) version = parseInt(ua.substring(msie + 5, ua.indexOf(\".\", msie)));\n\t\t\n        if (!L.Browser.touch) {\n\t\t\tL.DomEvent\n\t\t\t\t.disableClickPropagation(container)\n\t\t\t\t.disableScrollPropagation(container);\n\t\t} else {\n\t\t\tL.DomEvent.on(container, 'click', L.DomEvent.stopPropagation);\n\t\t}\n    \t\n\t\n\t\tif (this.options.collapsed){\n\t\t\t//#499: Amb IE10 no es carreguen els visors\n\t\t\tif (msie==0){\n\t\t\t\tif (!L.Browser.android) {\n\t\t\t\t\t\tL.DomEvent.on(container, {\n\t\t\t\t\t\t\tmouseenter: this._expand,\n\t\t\t\t\t\t\tmouseleave: this._collapse\n\t\t\t\t\t\t}, this);\n\t\t\t\t\t}\n\t\t\t}\n\t\t\t\n    \t\t\n    \t\t\n    \t\tL.DomEvent.on(container, 'click', this._expand, this);\n    \t\t\n    \t\tthis._map.on('click', this._collapse, this);\n    \t}else{\n    \t\tthis._expand();\n    \t}\n    \t    \t\n    \tvar btllista = L.DomUtil.create('div','leaflet-bar btn btn-default btn-sm');\n    \t\n    \tif (this._map.getActiveMap() == \"ortoMap\"){\n    \t\tL.DomUtil.addClass(btllista, 'bt_topo');\n    \t}else{\n    \t\tL.DomUtil.addClass(btllista, 'bt_orto');\n    \t}\n    \t\n\t\tcontainer.appendChild(btllista);\n\t\tthis._btllista = btllista;\n\t\tbtllista.innerHTML = '<small id=\"sm_tipus\" lang=\"ca\">Fons</small>';\n\t\t\t\t\n\t\tvar llistaFons = L.DomUtil.create('div','leaflet-bar btn btn-default llista-fons');\n\t\t\n\t\tthis._addLayers(llistaFons);\n\t\n\t\tcontainer.appendChild(llistaFons);\n\t\t\t\t\t\t\n\t\treturn container;\n    },\n    \n    hideBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).hide();\n\t},\n\t\n\tshowBtn: function(){\n\t\tvar self = this;\n\t\t$(self._div).show();\n\t},\n    \n    _update: function(){\n    \t\n    },\n    \n    _expand: function(){\n    \tL.DomUtil.addClass(this._container, 'control-btn-fons-expanded');\t\n    },\n    \n    _collapse: function(){\n    \tL.DomUtil.removeClass(this._container, 'control-btn-fons-expanded');\n    },\n    \n    _addLayers: function(container){\n\t\t\n\n\t\t\n    \t this._addItem(container,{id:'topoMap',className:'div_fons_1',title:'Topogràfic'});\n    \t this._addItem(container,{id:'topoMapGeo',className:'div_fons_12',title:'Simple'});\n    \t this._addItem(container,{id:'hibridMap',className:'div_fons_13',title:'Mapa híbrid'});\n    \t this._addItem(container,{id:'ortoMap',className:'div_fons_3',title:'Imatge'});    \t\n    \t this._addItem(container,{id:'terrainMap',className:'div_fons_4',title:'Terreny'});\n    \t this._addItem(container,{id:'alcadaMap',className:'div_fons_15',title:'Model d\\'elevacions'});\n    \t this._addItem(container,{id:'historicOrtoMap',className:'div_fons_11',title:'Ortofoto històrica Catalunya 1956-57'});\n    \t this._addItem(container,{id:'historicOrtoMap46',className:'div_fons_14',title:'Ortofoto històrica Catalunya 1946'});\n    \t this._addItem(container,{id:'historicMap',className:'div_fons_10',title:'Mapa històric Catalunya 1936'});     \t\n    \t this._addItem(container,{id:'topoGrisMap',className:'div_fons_2',title:'Topogràfic gris'});\n    \t this._addItem(container,{id:'nit',className:'div_fons_6',title:'Nit'});\n    \t this._addItem(container,{id:'sepia',className:'div_fons_7',title:'Sèpia'});\n    \t this._addItem(container,{id:'zombie',className:'div_fons_8',title:'Coure'});\n    \t this._addItem(container,{id:'orquidea',className:'div_fons_9',title:'BluePrint'});\n    \t this._addItem(container,{id:'naturalMap',className:'div_fons_16',title:'Natural'});\n    \t this._addItem(container,{id:'divadminMap',className:'div_fons_17',title:'Divisions administratives'});\t\t \n\t\t this._addItem(container,{id:'hibridTerrainMap',className:'div_fons_18',title:'Terreny híbrid'});\t\t\n\t\t this._addItem(container,{id:'colorBlankMapwhite',className:'div_fons_blank',title:'Fons neutre blanc'});\n\t\t this._addItem(container,{id:'colorBlankMaplightgray',className:'div_fons_gris',title:'Fons neutre gris'} );\n\t\t this._addItem(container,{id:'colorBlankMapgray',className:'div_fons_gris_fort',title:'Fons neutre gris fort'});\n\t\t \n\t\t \n    },\n    \n    _addItem: function(container, properties){\n\t\t\n\t\n    \tvar item = document.createElement('div');\n    \titem.id = properties.id;\n    \titem.className = properties.className;\n    \titem.setAttribute(\"data-toggle\",\"tooltip\");\n    \titem.setAttribute(\"data-lang-title\",properties.title);\n    \titem.title = properties.title;\n    \t\n    \tL.DomEvent.on(item, 'click', L.DomEvent.stopPropagation);\n    \tL.DomEvent.on(item, 'click', this._onItemClick, this);\n    \tcontainer.appendChild(item);\n    \t$(item).tooltip({placement : 'bottom',container : 'body'});\n    },\n    \n    _onItemClick: function(evt){\n    \tvar that = this;\n    \tvar _this = evt.target;\n    \tvar fons = $(_this).attr('id');\n\t\t\n\t\t\n\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#fons', fons, 1]});\n\t\tif (fons == 'topoMap'){\n\t\t\tthis._map.topoMap();\n\t\t}else if (fons == 'topoMapGeo') {\n\t\t\tthis._map.topoMapGeo();\n\t\t}else if (fons == 'ortoMap') {\n\t\t\tthis._map.ortoMap();\n\t\t}else if (fons == 'terrainMap') {\n\t\t\tthis._map.terrainMap();\n\t\t}else if (fons == 'topoGrisMap') {\n\t\t\tthis._map.topoGrisMap();\n\t\t}else if (fons == 'historicOrtoMap') {\n\t\t\tthis._map.historicOrtoMap();\n\t\t}else if (fons == 'historicMap') {\n\t\t\tthis._map.historicMap();\n\t\t}else if (fons == 'hibridMap'){\n\t\t\tthis._map.hibridMap();\n\t\t}else if (fons == 'historicOrtoMap46'){\n\t\t\tthis._map.historicOrtoMap46();\n\t\t}else if (fons == 'alcadaMap'){\n\t\t\tthis._map.alcadaMap();\n\t\t\t\n\t\t}else if (fons == 'naturalMap') {\n\t\t\tthis._map.naturalMap();\n\t\t\t\n\t\t}else if (fons == 'divadminMap') {\n\t\t\tthis._map.divadminMap();\n\t\t\n\n\t\t}else if (fons == 'hibridTerrainMap') {\n\t\t\tthis._map.hibridTerrainMap();\t\n\t\t\t\n\t\t}else if (fons.indexOf('colorBlankMap')!=-1) {\n\t\t\t\t\t\t\n\t\t\t\t\n\t\t\tthis._map.colorBlankMap(fons);\n\t\t\t\n\t\t}else{\n\t\t\tthis._map.colorMap(fons);\t\t\t\n\t\t}\n\t\tif (fons == 'ortoMap'){\n\t\t\tL.DomUtil.removeClass(this._btllista, 'bt_orto');\n\t\t\tL.DomUtil.addClass(this._btllista, 'bt_topo');\n\t\t}else{\n\t\t\tL.DomUtil.removeClass(this._btllista, 'bt_topo');\n\t\t\tL.DomUtil.addClass(this._btllista, 'bt_orto');\n\t\t}\n\t\tthis._collapse();\n    }\n});\n\nL.IM_controlFons = function (options) {\n    return new L.IM_ControlFons(options);\n};\n\n/*\n//Control mapa orto/topo\n\tvar ctr_llistaCapes = L.control({\n        position : 'bottomright'\n\t});\n\tctr_llistaCapes.onAdd = function (map) {\n\n\t\t\n\t};\n\tctr_llistaCapes.addTo(map);\n\t\n\tjQuery('.div_barrabotons').on('click', function () {\n\t\tif (jQuery('div', this).hasClass('bt_orto')) {\n\t        map.ortoMap();\n\t        canvasTiles.bringToFront();\n\t        jQuery('#sm_tipus').text('Mapa');\n\t        jQuery('div', this).addClass('bt_topo');\n\t        jQuery('div', this).removeClass('bt_orto');\n\t\t}else{\n\t        map.topoMapGeo();\n\t        canvasTiles.bringToFront();\n\t        jQuery('#sm_tipus').text('Ortofoto');\n\t        jQuery('div', this).addClass('bt_orto');\n\t        jQuery('div', this).removeClass('bt_topo');\n\t\t}\n\t});\n\t\n*/\t","/*\nVariables GLOBALS del 3D\n */\nvar viewer;\nvar mapaVista3D = null;\nvar capesActives3D;\nvar modul3D = true;\nvar terreny;\nvar _imageryLayers;\nvar scene;\nvar camera;\nvar ellipsoid;\nvar handler = null;\nvar baseLayer3D = [];\nvar overLayers3D = [];\nvar matriu3 = [];\nvar factorTerreny = 14;\nvar browserWebGL;\nvar disparaEventMapa = true;\nvar mapaEstatNOPublicacio = true;\nvar initAmbVistaControlada = false;\nvar testModel3D=false;\nvar msgHTML = \"\";\nvar modeDebug3D=true;\nvar _urlTerrenys = 'http://tilemaps.icgc.cat/terrenys/demextes';\nvar urlApp=document.location.href;\n\nif((urlApp.indexOf('localhost')!=-1)||(urlApp.indexOf('.local')!=-1)||(urlApp.indexOf('172.70.1.11')!=-1)){\n\t _urlTerrenys = 'http://imtilemapsdev.icgc.local/terrenys/dem2out';\n\t//_urlTerrenys = 'http://tilemaps.icgc.cat/terrenys/demextes';\n}\nvar _urlModels3D='http://tilemaps.icgc.cat/terrenys/model3D/test/Prova1_cesium.json';\nvar appl='mapa';\nvar factorNavegador=1000;\n\nfunction addModul3D(config) {\n\tvar _mapConfig = config;\n\tvar socChrome=isChrome();\n\n\tif(socChrome){factorNavegador=600;}\n\t\n\tif(!getModeMapa()){appl='visor';}\n\t\n\tbrowserWebGL = detectoCapacitatsWebGL();\n\n\tif (browserWebGL) {\n\t\tloadCesiumCssJs();\n\t\t$(\"body\").append('<div id=\"map3D\"></div>');\n\t\t$(\"body\").append('<div id=\"popup3D\"></div>');\n\t\t$.publish('analyticsEvent',{event:[ appl, 'siWebGL3D', 'label 3D', 1]});\n\t}\n\n\tjQuery('.bt_3D_2D').on('click', function (event) {\n\t\taturaClick(event);\n\t\t$.publish('analyticsEvent',{event:[ appl, tipus_user + '3D', 'label 3D', 1]});\n\t\t$('.tooltip').hide();\n\t\tactivaVista3d_2d(this);\n\t});\n\n\tjQuery(document).on('click', \"#tanca3D\", function (e) {\n\t\tjQuery(\"#popup3D\").hide();\n\n\t});\n\n\tjQuery(document).on('click', \"#chk_ad_3d\", function (e) {\n\t\tCookies.set('msg3D', true, {\n\t\t\texpires: 365\n\t\t});\n\t});\n\t\n\tif (url('?3D') == 'true') {\n\t\tvar fT = parseInt(_mapConfig.servidorsWMS.length * 1000 / 2);\n\t\tsetTimeout(function(){\n\t\t\tinitMapa3DfromMapConfig(_mapConfig);\n\t\t}, fT);\n\t} else if (_mapConfig.options && _mapConfig.options.mapa3D) {\n\t\tvar fT = parseInt(_mapConfig.servidorsWMS.length * 1000 / 2);\n\t\tsetTimeout(function(){\n\t\t\tinitMapa3DfromMapConfig(_mapConfig);\n\t\t}, fT);\n\t}\n\t\n\tif (url('?testModel3D') == 'true') {\t\n\t\ttestModel3D=true;\n\t\t_urlTerrenys='//assets.agi.com/stk-terrain/world';\n\t}\t\n}\n\nfunction loadCesiumCssJs(){\n    $(\"head\").append('<link id=\"cesium_css\" href=\"/llibreries/cesium/Cesium.css\" type=\"text/css\" rel=\"stylesheet\" />');\n    $(\"body\").append('<script src=\"/llibreries/cesium/Cesium.js\"  type=\"text/javascript\"></script>');\n    $(\"body\").append('<script src=\"/llibreries/cesium/Cesium.PinBuilder_IM.js\"  type=\"text/javascript\"></script>');\n    $(\"body\").append('<script src=\"/llibreries/cesium/cesium-navigation.js\"  type=\"text/javascript\"></script>');\n}\n\nfunction activaVista3d_2d(_this){\n\t// mirar si el navegador suporta 3d\n\tbrowserWebGL ? canviaVista_3D_2D(_this) : mostraMsgNo3D();\n}\n\nfunction gestionFonsMapa3D() {\n\tif (estatMapa3D && mapaEstatNOPublicacio) {\n\t\tmapaVista3D.addBaseLayersCesium();\n\t}\n}\n\nfunction canviaVista_3D_2D(boto, event) {\n\t(jQuery(boto).text() == '3D') ? init3D(boto) : init2D(boto);\n}\n\nfunction initMapa3DfromMapConfig(config) {\n\tif (browserWebGL) {\n\t\tinitAmbVistaControlada = true;\n\t\tjQuery('.bt_3D_2D').text('2D');\n\t\tinicialitzaMapa3D('_fromConfig', config);\n\t}\n}\n\nfunction inicialitzaMapa3D(origen, config) {\n\tif (browserWebGL) {\n\t\tif (mapaVista3D == null) {\n\t\t\tmapaVista3D = new IM_aplicacio({\n\t\t\t\t'mapId' : 'map',\n\t\t\t\t'mapId3D' : 'map3D', \n\t\t\t\tmapConfig: config\n\t\t\t});\n\t\t}\n\t\tmapaVista3D.canviaVisor3D(map, controlCapes, origen);\n\t\tActDesOpcionsVista3D(true);\n\t\tif (getModeMapa()) {\n\t\t\tif (drgFromMapa) {\n\t\t\t\tdrgFromMapa.destroy();\n\t\t\t\tdrgFromMapa = null;\n\t\t\t\tcreaAreesDragDropFiles();\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction init3D(boto) {\n\tmap.spin(true);\n\tif (browserWebGL) {\n\t\tinitAmbVistaControlada = false;\n\t\tif (!Cookies.get('msg3D')) {\n\t\t\tjQuery(\"#dialgo_ad_3D\").modal('show');\n\t\t}\n\t\tjQuery(boto).text('2D');\n\t\tinicialitzaMapa3D('_fromBoto');\n\t} else {}\n}\n\nfunction init2D(boto) {\n\tjQuery(boto).text('3D');\n\tmapaVista3D.retornaPosicio2D().then(function (bbox) {\n\t\tmap.fitBounds([[bbox.lat0, bbox.lng0], [bbox.lat1, bbox.lng1]]);\n\t\tmap.spin(true);\n\t\t$(\"#map3D\").fadeOut(\"slow\", function () {\n\t\t\tjQuery('.leaflet-map-pane').show();\n\t\t\tjQuery(\"#map3D\").hide();\n\t\t\tjQuery(\"#popup3D\").hide();\n\t\t\tjQuery(\"#map3D\").html('');\n\t\t\tjQuery(\"#not_3d\").remove();\n\t\t\tjQuery(\"#not_3d_mini\").remove();\n\t\t\tmap.spin(false);\n\t\t});\n\n\t\testatMapa3D = false;\n\t\tmapaVista3D = null;\n\n\t\tif (getModeMapa()) {\n\t\t\tdrgFromMapa.destroy();\n\t\t\tdrgFromMapa = null;\n\t\t\tcreaAreesDragDropFiles();\n\t\t}\n\n\t\tActDesOpcionsVista3D(false);\n\n\t\tjQuery('label span').each(function (index) {\n\t\t\tjQuery(this).css('text-decoration', 'none');\n\t\t});\n\n\t\tsetTimeout(function () {\n\t\t\thandler = null;\n\t\t\tviewer = null\n\t\t}, 2000);\n\n\t});\n\n\tmap.spin(false);\n}\n\nfunction ActDesOpcionsVista3D(activa3D) {\n\tvar crtl = ['.leaflet-control-scale',\n\t\t'.leaflet-control-minimap-toggle-display',\n\t\t'.leaflet-control-zoom',\n\t\t'.bt_geopdf',\n\t\t'.leaflet-control-draw-measure',\n\t\t'#dv_bt_Routing'\n\t];\n\n\tif (activa3D) {\n\t\tjQuery('#funcio_draw').prepend('<div id=\"not_3d\">' +\n\t\t\twindow.lang.translate('Operacions no disponibles en modus 3D') +\n\t\t\t'</div>');\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'hidden');\n\t\t$.each(crtl, function (index, value) {\n\t\t\tjQuery(value).hide();\n\t\t});\n\t} else {\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'visible');\n\t\t$.each(crtl, function (index, value) {\n\t\t\tjQuery(value).show();\n\t\t});\n\t\tviewer.navigation = undefined;\n\t\tjQuery('.leaflet-control-minimap').css('visibility', 'visible');\n\t}\n}\n\nvar IM_aplicacio = function (options) {\n\tthis.options = options;\n\tthis.cesium = undefined;\n\tthis.leaflet = undefined;\n\tthis.mapId = this.options.mapId;\n\tthis.mapId3D = this.options.mapId3D;\n\tthis.container = document.getElementById(this.mapId);\n\tthis.matriuCapes = {};\n\tthis.matriuCapes.base = [];\n\tthis.matriuCapes.overlays = [];\n\tthis.mapConfig = this.options.mapConfig;\n\tthis.setVisor = function (isLeaflet) {\n\t\tthis.leaflet = isLeaflet;\n\t};\n\tthis.canviaVisor2D = function () {\n\t\testatMapa3D = false;\n\t};\n\tthis.canviaVisor3D = function (map, controlCapes, origen) {\n\t\toverLayers3D = [];\n\t\tthis.bounds = map.getBounds();\n\t\tthis.center = map.getCenter();\n\t\tterreny = new Cesium.CesiumTerrainProvider({\n\t\t\turl : _urlTerrenys,\n\t\t\tcredit : 'icgc'\n\n\t\t});\n\t\tthis.gestionaTerrainProvaider(this.bounds.getCenter().lat, this.bounds.getCenter().lng, 'icgc').then(function (terrain) {\n\t\t\tif (terrain != null) {\n\t\t\t\tterreny = terrain;\n\t\t\t}\n\t\t});\n\n\t\tviewer = new Cesium.Viewer(this.mapId3D, {\n\t\t\timageryProvider : false,\n\t\t\ttimeline : false,\n\t\t\tnavigationHelpButton : false,\n\t\t\tscene3DOnly : true,\n\t\t\tfullscreenButton : false,\n\t\t\tbaseLayerPicker : false,\n\t\t\thomeButton : false,\n\t\t\tinfoBox : false,\n\t\t\tsceneModePicker : false,\n\t\t\tanimation : false,\n\t\t\tgeocoder : false,\n\t\t\tcontextOptions : {\n\t\t\t\twebgl : {\n\t\t\t\t\tpreserveDrawingBuffer : true\n\t\t\t\t}\n\t\t\t},\n\t\t\tshowRenderLoopErrors : false,\n\t\t\tuseDefaultRenderLoop : true,\n\t\t\tsceneMode : Cesium.SceneMode.SCENE3D,\n\t\t\tterrainProvider : terreny\n\t\t});\n\n\t\tnavigationInitialization(this.mapId3D, viewer);\n\t\tscene = viewer.scene;\n\t\tscene.globe.depthTestAgainstTerrain = true;\n\t\tcamera = viewer.scene.camera;\n\t\tellipsoid = scene.globe.ellipsoid;\n\t\tviewer.scene.globe.enableLighting = true;\n\t\tviewer.scene.fog.enabled = true;\n\t\tviewer.scene.fog.density = 0.0002;\n\t\tviewer.scene.fog.screenSpaceErrorFactor = 2;\n\t\tcapesActives3D = viewer.scene.imageryLayers;\n\t\t_imageryLayers = viewer.imageryLayers;\n\t\t\n\t\tviewer.scene.globe.baseColor =Cesium.Color.fromCssColorString(jQuery('#map').css('background-color'));\n\t\t\n\t\tjQuery(\"#bt_pinch3D\").show();\n\t\tmap.spin(true);\n\t\tvar zz = parseInt(map.getZoom());\n\t\tif (zz < 15) {\n\t\t\t//disparaEventMapa=false;\n\t\t\t//map.setZoom(parseInt(zz) + 1)\n\t\t}\n\t\tthis.bounds = map.getBounds();\n\t\tthis.mapZoom = map.getZoom();\n\n\t\t$(\".leaflet-map-pane\").fadeOut(\"slow\", function () {\n\t\t\tjQuery('#map3D').show();\n\t\t\tdocument.getElementById('map3D').style.display = 'block';\n\t\t\tjQuery(\".leaflet-map-pane\").hide();\n\t\t\tmap.spin(false);\n\t\t});\n\n\t\testatMapa3D = true;\n\t\n\t\tthis.calculaPosicioInici(this.bounds, this.mapZoom).then(function (rectangle) {\n\t\t\tif (initAmbVistaControlada && this.mapConfig.options) {\n\t\t\t\tif (this.mapConfig.options && this.mapConfig.options.camera3D) {\n\t\t\t\t\tvar cameraPos = this.mapConfig.options.camera3D;\n\t\t\t\t\tif (cameraPos.indexOf('NaN') == -1) {\n\t\t\t\t\t\tmapaVista3D.setPosicioCamera3D(cameraPos);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tviewer.camera.setView({\n\t\t\t\t\t\t\tdestination : rectangle.rectangle\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tviewer.camera.setView({\n\t\t\t\t\t\tdestination : rectangle.rectangle\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (origen == '_fromBoto') {\n\t\t\t\t\tvar _altu = parseFloat(rectangle.altMetres) + parseFloat(rectangle.newAlt[0].height);\n\t\t\t\t\tif (terreny.credit.text = 'icgc' && !testModel3D) {\n\t\t\t\t\t\tviewer.camera.flyTo({\n\t\t\t\t\t\t\tdestination : rectangle.rectangle,\n\t\t\t\t\t\t\tduration : 0,\n\t\t\t\t\t\t\tcomplete : function () {\n\t\t\t\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\t\t\t\tviewer.camera.flyTo({\n\t\t\t\t\t\t\t\t\t\tdestination : Cesium.Cartesian3.fromDegrees(rectangle.centerLng, rectangle.newLat, (parseFloat(rectangle.altMetres) + parseFloat(rectangle.newAlt[0].height * 1.5))),\n\t\t\t\t\t\t\t\t\t\torientation : {\n\t\t\t\t\t\t\t\t\t\t\theading : Cesium.Math.toRadians(0.0),\n\t\t\t\t\t\t\t\t\t\t\tpitch : Cesium.Math.toRadians(rectangle._picth), //tilt\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\teasingFunction : Cesium.EasingFunction.LINEAR_NONE\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}, 2000);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tviewer.camera.setView({\n\t\t\t\t\t\t\tdestination : rectangle.rectangle\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tviewer.camera.setView({\n\t\t\t\t\t\tdestination : rectangle.rectangle\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.addBaseLayersCesium();\n\t\tvar that=this;\n\t\tsetTimeout(function(){\t\t\t\n\t\t\tthat.miraCapesiExternes();\n\t\t},factorNavegador*3);\n\n\t\t//Afegin Events Cesium hanlers\n\t\tif (handler == null) {\n\t\t\thandler = new Cesium.ScreenSpaceEventHandler(scene.canvas);\n\t\t\tvar thet = this;\n\t\t\thandler.setInputAction(function (movement) {\n\t\t\t\tif (estatMapa3D) {\n\t\t\t\t\tvar pickedObjects = scene.drillPick(movement.position);\n\t\t\t\t\tmsgHTML = \"\";\n\t\t\t\t\tjQuery(\"#popup3D\").hide();\n\t\t\t\t\tvar pickRay = viewer.camera.getPickRay(movement.position);\n\t\t\t\t\tvar featuresPromise = viewer.imageryLayers.pickImageryLayerFeatures(pickRay, viewer.scene);\n\t\t\t\t\tif (!Cesium.defined(featuresPromise)) {}\n\t\t\t\t\telse {\n\t\t\t\t\t\tCesium.when(featuresPromise, function (features) {\n\t\t\t\t\t\t\tif (features.length > 0) {\n\t\t\t\t\t\t\t\tif (features[0].data.properties) {\n\t\t\t\t\t\t\t\t\tthet.generaPopup(features[0].data, \"vector\");\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthet.generaPopup(features[0], \"raster\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (Cesium.defined(pickedObjects)) {\n\t\t\t\t\t\tif (pickedObjects.length > 0) {\n\t\t\t\t\t\t\tthet.generaPopup(pickedObjects[0].id, \"vector\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, Cesium.ScreenSpaceEventType.LEFT_CLICK);\n\t\t\t\n\t\t\thandler.setInputAction(function (movement) {\n\t\t\t\tif (estatMapa3D) {\n\t\t\t\t\tthet.miraPosicioXYZ(movement);\n\t\t\t\t}\n\t\t\t}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);\n\t\t}\n\t\tthis.activaEventLeaflet();\n\t};\n\n\tthis.miraCapesiExternes = function () {\n\t\tthis.addOverlaysLayersCesium(controlCapes);\n\t};\n\n\tthis.activaEventLeaflet = function () {\n\t\tvar thet = this;\n\t\tmap.on('viewreset', function (e) {\n\t\t\tif (estatMapa3D && disparaEventMapa) {\n\t\t\t\tthet._goToBounds(map.getBounds(), map.getZoom());\t\t\t\t\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.miraPosicioXYZ = function (movement) {\n\t\tmatriu3 = [];\n\t\ttry {\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\tvar cartesian = viewer.camera.pickEllipsoid(movement.endPosition, ellipsoid);\n\t\t\tif (cartesian) {\n\t\t\t\tvar cartographic = ellipsoid.cartesianToCartographic(cartesian);\n\t\t\t\tvar lon = Cesium.Math.toDegrees(cartographic.longitude);\n\t\t\t\tvar lat = Cesium.Math.toDegrees(cartographic.latitude);\n\t\t\t\tvar lonC = Cesium.Math.toRadians(lon);\n\t\t\t\tvar latC = Cesium.Math.toRadians(lat);\n\t\t\t\tif (!isNaN(lonC)) {\n\t\t\t\t\tvar text = '<div>WGS84 ' + lon.toFixed(5) + ' ' + lat.toFixed(5) + '</div>';\n\t\t\t\t\tjQuery('.leaflet-control-mouseposition').html(text);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (Err) {\n\t\t\t$.publish('analyticsEvent',{event:[ 'error3D', Err, 'miraPosicioXYZ', 1]});\n\t\t}\n\t};\n\n\tthis._goToBounds = function (bounds, mapZoom) {\n\t\tvar rectangle = Cesium.Rectangle.fromDegrees((bounds.getWest()),\n\t\t\t((bounds.getSouth())), \n\t\t\t(bounds.getEast()),\n\t\t\t((bounds.getNorth())));\n\t\tviewer.camera.setView({\n\t\t\tdestination : rectangle\n\t\t});\n\t};\n\n\tthis._goTo = function (lat, lng) {\n\t\tviewer.camera.setView({\n\t\t\tdestination : Cesium.Cartesian3.fromDegrees(lng, lat, viewer.camera.positionCartographic.height),\n\t\t\torientation : {\n\t\t\t\theading : viewer.camera.heading,\n\t\t\t\tpitch : viewer.camera.pitch,\n\t\t\t\troll : viewer.camera.roll\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.canviaOpacity = function (businessId, opacity) {\n\t\tjQuery.each(capesActives3D._layers, function (index, layer) {\n\t\t\tif (layer.id == businessId) {\n\t\t\t\tlayer.alpha = opacity;\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.actualitzaVistaOverlays = function (obj, accio, visible) {\n\t\tif (mapaEstatNOPublicacio) {\n\t\t\tif (accio == \"add\") {\n\t\t\t\tif (jQuery.inArray(obj.businessId, overLayers3D) == -1) {\n\t\t\t\t\tthis.matriuCapes.overlays = [];\n\t\t\t\t\tthis.addOverlaysLayersCesium();\n\t\t\t\t}\n\t\t\t} else if ((accio == \"display\") || (accio == \"remove\")) {\n\t\t\t\tvar trobatCapa = false;\n\t\t\t\tjQuery.each(capesActives3D._layers, function (index, layer) {\n\t\t\t\t\tif (layer && layer.id == obj.businessId) {\n\t\t\t\t\t\ttrobatCapa = true;\n\t\t\t\t\t\tif (accio == \"display\") {\n\t\t\t\t\t\t\tlayer.show = visible\n\t\t\t\t\t\t} else if (accio == \"remove\") {\n\t\t\t\t\t\t\tcapesActives3D.remove(layer, true)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tvar n = 0;\n\t\t\t\tfor (var f = 0; f < viewer.entities.values.length; f++) {\n\t\t\t\t\tvar feature = viewer.entities.values[f];\n\t\t\t\t\tif (feature && feature.properties) {\n\t\t\t\t\t\tif (feature.properties.dataSource == obj.businessId) {\n\t\t\t\t\t\t\ttrobatCapa = true;\n\t\t\t\t\t\t\tif (accio == \"display\") {\n\t\t\t\t\t\t\t\tfeature.show = visible;\n\t\t\t\t\t\t\t} else if (accio == \"remove\") {\n\t\t\t\t\t\t\t\tfeature.show = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!trobatCapa) {\n\t\t\t\t\tmap.spin(true);\n\t\t\t\t\tif (jQuery.inArray(obj.businessId, overLayers3D) == -1) {\n\t\t\t\t\t\tthis.matriuCapes.overlays = [];\n\t\t\t\t\t\tthis.addOverlaysLayersCesium();\n\t\t\t\t\t\tmap.spin(false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tjQuery.each(viewer.entities.values, function (index, feature) {\n\t\t\t\t\tif (feature.properties.dataSource == obj.businessId) {\n\t\t\t\t\t\tfeature.show = visible;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.generaPopup = function (player, origen) {\n\t\tif (origen == \"vector\" && player.properties) {\n\t\t\tvar out = [];\n\t\t\tif (player.properties.nom && !isBusinessId(player.properties.nom)) {\n\t\t\t\tmsgHTML += '<h4>' + player.properties.nom + '</h4>';\n\t\t\t} else if (player.properties.name && !isBusinessId(player.properties.name)) {\n\t\t\t\tmsgHTML += '<h4>' + player.properties.name + '</h4>';\n\t\t\t} else if (player.properties.Name && !isBusinessId(player.properties.Name)) {\n\t\t\t\tmsgHTML += '<h4>' + player.properties.Name + '</h4>';\n\t\t\t}\n\t\t\tif (player.properties.description) {\n\t\t\t\tif (!$.isNumeric(player.properties.description) && !validateWkt(player.properties.description))\n\t\t\t\t\tmsgHTML += '<div>' + parseUrlTextPopUp(player.properties.description) + '</div>';\n\t\t\t\telse\n\t\t\t\t\tmsgHTML += '<div>' + player.properties.description + '</div>';\n\t\t\t}\n\t\t\tmsgHTML += '<div class=\"div_popup_visor\"><div class=\"popup_pres\">';\n\t\t\tvar pp = player.properties;\n\t\t\t$.each(pp, function (key, value) {\n\t\t\t\tif (key != \"styles\" && key != \"dataSource\" && key != \"OGR\" && key != \"OGR_STYLE\") {\n\t\t\t\t\tif (isValidValue(value)) {\n\t\t\t\t\t\tif (key != 'name' && key != 'Name' && key != 'description' && key != 'id' && key != 'businessId' && key != 'slotd50') {\n\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_row\">';\n\t\t\t\t\t\t\tvar txt = value;\n\t\t\t\t\t\t\tif (!$.isNumeric(txt) && key != \"styles\" && !validateWkt(txt)) {\n\t\t\t\t\t\t\t\ttxt = parseUrlTextPopUp(value, key);\n\t\t\t\t\t\t\t\tif (txt.indexOf(\"iframe\") == -1 && txt.indexOf(\"img\") == -1) {\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_key\">' + key + '</div>';\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_value\">' + txt + '</div>';\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_img_iframe\">' + txt + '</div>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_key\">' + key + '</div>';\n\t\t\t\t\t\t\t\tmsgHTML += '<div class=\"popup_data_value\">' + txt + '</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmsgHTML += '</div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tmsgHTML += '</div></div>';\n\t\t} else {\n\t\t\tmsgHTML += player.data;\n\t\t}\n\t\tvar html2 = '<div class=\"leaflet-popup leaflet-container leaflet-zoom-animated\" style=\"opacity:1\"><a id=\"tanca3D\" class=\"leaflet-popup-close-button\" href=\"#close\">Ã—</a>' +\n\t\t\t'<div class=\"leaflet-popup-content-wrapper\">' +\n\t\t\t'<div class=\"leaflet-popup-content\" style=\"width: 301px;\">' +\n\t\t\tmsgHTML +\n\t\t\t'</div></div></div>';\n\t\tjQuery(\"#popup3D\").show();\n\t\tjQuery(\"#popup3D\").html(html2);\n\t};\n\t\n\tthis.addBaseLayersCesium = function () {\n\t\tif (mapaEstatNOPublicacio) {\n\t\t\tjQuery.each(baseLayer3D, function (index, layer) {\n\t\t\t\t_imageryLayers.remove(layer, true); //capesActives3D\n\t\t\t});\n\t\t\tbaseLayer3D = [];\n\t\t\tthis.matriuCapes.base = map.getLGActiveMap().getLayers();\n\t\t\tthis.matriuCapes.base.reverse();\n\t\t\tfor (var i = 0; i < this.matriuCapes.base.length; i++) {\n\t\t\t\tvar url = this.matriuCapes.base[i]._url;\n\t\t\t\tif (url.indexOf('osm.org') != -1 || url.indexOf('openstreetmap.org') != -1) {\n\t\t\t\t\tif (!this._miraCentreDins(this.center.lat, this.center.lng)) {\n\t\t\t\t\t\tthis.matriuCapes.base[i].options.tms ? url = url.replace('{y}', '{reverseY}') : url;\n\t\t\t\t\t\tvar BB_layer = _imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({\n\t\t\t\t\t\t\turl : url,\n\t\t\t\t\t\t\tmaximumLevel : 18,\n\t\t\t\t\t\t\tminimumLevel : 3\n\t\t\t\t\t\t}));\n\t\t\t\t\t\t_imageryLayers.lowerToBottom(BB_layer);\n\t\t\t\t\t\tbaseLayer3D.push(BB_layer);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.matriuCapes.base[i].options.tms ? url = url.replace('{y}', '{reverseY}') : url;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tvar _mxlevel=18;\t\t\t\t\t\n\t\t\t\t\tif(url.indexOf('bases_noutm')!=-1){\n\t\t\t\t\t\t_mxlevel=19;\t\t\t\t\t\t\t\n\t\t\t\t\t}else if(url.indexOf('relleu')!=-1){\n\t\t\t\t\t\t_mxlevel=17;\t\n\t\t\t\t\t}\n\t\t\t\t\tvar BB_layer = _imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({\n\t\t\t\t\t\turl : url,\n\t\t\t\t\t\tmaximumLevel : _mxlevel,\n\t\t\t\t\t\tminimumLevel : 3\n\t\t\t\t\t}));\n\t\t\t\t\t_imageryLayers.lowerToBottom(BB_layer);\n\t\t\t\t\tbaseLayer3D.push(BB_layer);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(testModel3D){\n\t\t\t\tvar tileset=viewer.scene.primitives.add( new Cesium.Cesium3DTileset({\n\t\t\t\t\turl: _urlModels3D,\n\t\t\t\t\tmaximumScreenSpaceError: 2,\n\t\t\t\t\tmaximumNumberOfLoadedTiles: 1000\n\t\t\t\t}));\t \n\t\t\t}\t\n\t\t}\n\t};\n\n\tthis.addOverlaysLayersCesium = function () {\n\t\tvar that = this;\n\t\tvar numCapes = 1;\n\t\tvar numCapesActives = 0;\n\t\ttry {\n\t\t\tnumCapes = controlCapes.getCountLayers();\n\t\t\tjQuery.each(controlCapes._layers, function (i, item) {\n\t\t\t\tif (item.layer._map != null) {\n\t\t\t\t\tnumCapesActives = numCapesActives + 1;\n\t\t\t\t}\n\t\t\t\tjQuery.each(item._layers, function (j, item2) {\n\t\t\t\t\tif (item2.layer._map != null) {\n\t\t\t\t\t\tnumCapesActives = numCapesActives + 1;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t\tnumCapes = numCapesActives;\n\t\t} catch (Err) {\n\t\t\tnumCapes = 1;\n\t\t}\n\t\tjQuery.each(controlCapes._layers, function (i, item) {\n\t\t\tthat._utilValidoClassificoTipusCapa(item, numCapes);\n\t\t\tjQuery.each(item._layers, function (j, item2) {\n\t\t\t\tthat._utilValidoClassificoTipusCapa(item2, numCapes);\n\t\t\t});\n\t\t});\n\t\tthis.addOverlaysVectorsCesium();\n\t\tthis.addOverlaysRastersCesium();\n\t};\n\n\tthis._utilValidoClassificoTipusCapa = function (item, numCapes) {\n\t\tif (item.layer._map != null) {\n\t\t\tif (item.layer.options.tipusRang != tem_heatmap && item.layer.options.tipusRang != tem_cluster && item.layer.options.wmstime != true) {\n\t\t\t\tif (jQuery.inArray(item.layer.options.businessId, overLayers3D) == -1) {\n\t\t\t\t\tthis.matriuCapes.overlays.push(this._utilDeterminaTipusItem(item, true, numCapes));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tjQuery('label span#' + item.layer._leaflet_id).css('text-decoration', 'line-through');\n\t\t\t\tjQuery('.leaflet-bar-timecontrol').hide();\n\t\t\t}\n\t\t} else { //NO ACTIVES\n\t\t\tif (item.layer.options.tipusRang != tem_heatmap && item.layer.options.tipusRang != tem_cluster && item.layer.options.wmstime != true) {\n\t\t\t\t\n\t\t\t} else {\n\t\t\t\tjQuery('label span#' + item.layer._leaflet_id).css('text-decoration', 'line-through');\n\t\t\t\tjQuery('.leaflet-bar-timecontrol').hide();\n\t\t\t}\n\t\t} //FI ELSE NO actives\n\t};\n\n\tthis.addOverlaysRastersCesium = function () {\n\t\tmatriuCapesLL.layers = [];\n\t\tmatriuCapesLL.n_layers = [];\n\t\tmatriuCapesLL.id_layers = [];\n\t\tmatriuCapesLL.t_layers = [];\n\t\tmatriuCapesLL.c_layers = [];\n\t\tmatriuCapesLL.v_layers = [];\n\t\tvar _hihaVecras = false;\n\t\tfor (var i = 0; i < this.matriuCapes.overlays.length; i++) {\n\t\t\tif (jQuery.inArray(this.matriuCapes.overlays[i].businessId, overLayers3D) == -1) {\n\t\t\t\tif (this.matriuCapes.overlays[i].tipus == \"raster\") {\n\t\t\t\t\tvar raster = this.matriuCapes.overlays[i].item;\n\t\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\n\t\t\t\t\tif (raster.layer.options.tipus.indexOf(\"wms\") != -1) {\n\t\t\t\t\t\tvar _url = raster.layer._url;\n\t\t\t\t\t\tif (_url) {\n\t\t\t\t\t\t\tif (_url.indexOf('?') == -1) {\n\t\t\t\t\t\t\t\t_url = _url + '?';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar opacity = 0.9;\n\t\t\t\t\t\tif (raster.layer.options.opacity) {\n\t\t\t\t\t\t\topacity = raster.layer.options.opacity;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (urlApp.indexOf('172.70.1.11') != -1) {\n\t\t\t\t\t\t\t_url = _url.replace('betaserver.icgc.cat', '172.70.1.31');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar provider = new Cesium.WebMapServiceImageryProvider({\n\t\t\t\t\t\t\turl : _url,\n\t\t\t\t\t\t\tlayers : raster.layer.wmsParams.layers,\n\t\t\t\t\t\t\tenablePickFeatures : true,\n\t\t\t\t\t\t\tgetFeatureInfoAsXml : false,\n\t\t\t\t\t\t\tgetFeatureInfoAsGeoJson : false,\n\t\t\t\t\t\t\tgetFeatureInfoParameters : {\n\t\t\t\t\t\t\t\tinfo_format : 'text/plain'\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tparameters : {\n\t\t\t\t\t\t\t\ttransparent : 'true',\n\t\t\t\t\t\t\t\tformat : 'image/png',\n\t\t\t\t\t\t\t\tstyles : ''\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tmaximumLevel : 18,\n\t\t\t\t\t\t\tminimumLevel : 5,\n\t\t\t\t\t\t\tproxy : {\n\t\t\t\t\t\t\t\tgetURL : function (url) {\n\t\t\t\t\t\t\t\t\treturn paramUrl.proxy_betterWMS + '?url=' + encodeURIComponent(url);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tprovider.alpha = opacity;\n\t\t\t\t\t\tsetTimeout(this.delayAddImageProvider(provider, visible, raster.layer.options.businessId), 1000);\n\t\t\t\t\t}\n\t\t\t\t} else if (this.matriuCapes.overlays[i].tipus == \"vecras\") {\n\t\t\t\t\t_hihaVecras = true;\n\t\t\t\t\tvar vecras = this.matriuCapes.overlays[i].item;\n\t\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tompleCapesMatriu(vecras, true);\n\t\t\t\t\t\tmatriuCapesLL.v_layers.push(visible);\n\t\t\t\t\t} catch (Err) {}\n\t\t\t\t}\n\t\t\t}\n\t\t} //fi for\n\t\tif (_hihaVecras) {\n\t\t\tthis.generaWMSfromCapesVector();\n\t\t}\n\t};\n\n\tthis.generaWMSfromCapesVector = function () {\n\t\tvar data = matriuCapesLL;\n\t\tvar that = this;\n\t\tdata.request = \"createWMSfromMap\";\n\t\tdata.businessId = that.mapConfig.businessId;\n\t\tdata.nomAplicacio = that.mapConfig.nomAplicacio;\n\t\tdata.modeMapa = getModeMapa();\n\t\tgetModeMapa() ? data.entitatUid = _UsrID : data.entitatUid = that.mapConfig.servidorsWMS[0].entitatUid;\n\t\tif (that.mapConfig.entitatUid && that.mapConfig.entitatUid.indexOf(\"random_\") != -1) {\n\t\t\tdata.entitatUid = \"randomuser\"\n\t\t}\n\t\tif (data.c_layers.length > 0) {\n\t\t\tmap.spin(true);\n\t\t\tfor (var z = 0; z < data.c_layers.length; z++) {\n\t\t\t\tvar _newData = {};\n\t\t\t\t_newData.request = data.request;\n\t\t\t\t_newData.businessId = data.id_layers[z];\n\t\t\t\t_newData.nomAplicacio = data.nomAplicacio;\n\t\t\t\t_newData.modeMapa = data.modeMapa;\n\t\t\t\t_newData.entitatUid = data.entitatUid;\n\t\t\t\t_newData.layers = [data.layers[z]];\n\t\t\t\t_newData.n_layers = [data.n_layers[z]];\n\t\t\t\t_newData.id_layers = [data.id_layers[z]];\n\t\t\t\t_newData.t_layers = [data.t_layers[z]];\n\t\t\t\t_newData.c_layers = [data.c_layers[z]];\n\t\t\t\t_newData.v_layers = [data.v_layers[z]];\n\t\t\t\tcreateMapToWMS(_newData).then(\n\t\t\t\t\tfunction (results) {\n\t\t\t\t\tif (results.status == \"OK\") {\n\t\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\t\tvar url = results.url;\n\t\t\t\t\t\t\tif (url.indexOf('?') == -1) {\n\t\t\t\t\t\t\t\turl = url + '?';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthat.addVectortoWMSToMatriuCapes(_newData.id_layers[0], _newData.n_layers[0], url, _newData.v_layers[0]);\n\t\t\t\t\t\t}, factorNavegador);\n\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} //fi for\n\t\t} //fi bucle\n\t};\n\n\tthis.addVectortoWMSToMatriuCapes = function (layers, titles, url, visible) {\n\t\tvar that = this;\n\t\tvar _bbox = 'bbox={westProjected}%2C{southProjected}%2C{eastProjected}%2C{northProjected}&';\n\t\tvar srs = \"EPSG:3857\";\n\t\tprovider = new Cesium.UrlTemplateImageryProvider({\n\t\t\tenablePickFeatures : true,\n\t\t\tgetFeatureInfoAsXml : false,\n\t\t\tgetFeatureInfoAsGeoJson : true,\n\t\t\tgetFeatureInfoParameters : {\n\t\t\t\tinfo_format : 'geojson'\n\t\t\t},\n\t\t\turl : url + '&tiled=true&' +\n\t\t\t'transparent=true&format=image%2Fpng&exceptions=application/vnd.ogc.se_blank&' +\n\t\t\t'styles=&service=WMS&version=1.1.1&request=GetMap&' +\n\t\t\t'layers=Capa_' + layers + '&srs=' + encodeURI(srs) + '&' +\n\t\t\t_bbox +\n\t\t\t'width=256&height=256&',\n\t\t\tmaximumLevel : 19,\n\t\t\tminimumLevel : 3\n\t\t});\n\t\tsetTimeout(that.delayAddImageProvider(provider, visible, layers), 100);\n\t};\n\n\tthis.delayAddImageProvider = function (provider, visible, id) {\n\t\tvar _tmpLayer = capesActives3D.addImageryProvider(provider);\n\t\t_tmpLayer.id = id;\n\t\t_tmpLayer.show = false;\n\t\tsetTimeout(function () {\n\t\t\t_tmpLayer.show = visible;\n\t\t\tmap.spin(false);\n\t\t}, factorNavegador *2);\n\t\toverLayers3D.push(_tmpLayer);\n\t};\n\t\n\tthis.addOverlaysVectorsCesium = function () {\n\t\tvar that = this;\n\t\tfor (var i = 0; i < this.matriuCapes.overlays.length; i++) {\n\t\t\tif (this.matriuCapes.overlays[i].tipus == \"vector\") {\n\t\t\t\tvar vector = this.matriuCapes.overlays[i].item;\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tvar visible = this.matriuCapes.overlays[i].show;\t\t\t\t\t\t\t\n\t\t\t\tvar gj = vector.layer.toGeoJSONStyles2ToProperties();\n\t\t\t\tvar msg = this.matriuCapes.overlays[i].msg;\n\t\t\t\tvar bb = vector.layer.options.businessId;\n\t\t\t\tif (jQuery.inArray(bb, overLayers3D) == -1) {\n\t\t\t\t\toverLayers3D.push(bb);\n\t\t\t\t\tvar promise = Cesium.GeoJsonDataSource.load(gj);\n\t\t\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\t\t\tpromise.then(function (dataSource) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tdataSource.id = bb;\n\t\t\t\t\t\tvar dataL = dataSource;\n\t\t\t\t\t\tvar XYZ_Edificis = [];\t\t\t\t\t\t\t\n\t\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\tthat.calculaMatriuAlcades(dataL, XYZ_Edificis, 3, visible, msg);\n\t\t\t\t\t\t},factorNavegador);\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t}).otherwise(function (error) {\n\t\t\t\t\t\tconsole.warn(error);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._utilDeterminaTipusItem = function (item, visibilitat, numCapes) {\n\t\tvar tmp_feature = {\n\t\t\t\"item\" : item,\n\t\t\t\"show\" : visibilitat,\n\t\t\t\"businessId\" : item.layer.options.businessId,\n\t\t\t\"msg\" : 'vector'\n\t\t};\n\t\tvar factor = 1;\n\t\tvar mapZoom = this.mapZoom;\n\t\tif (numCapes <= 15) {\n\t\t\tfactor = 3\n\t\t}\n\t\tif (numCapes >= 15) {\n\t\t\tfactor = 1\n\t\t}\n\t\tvar _factorNumVectorsPol = 450 * factor;\n\t\tvar _factorNumVectorsLin = 300 * factor;\n\t\tvar _factorNumVectorsPunt = 500 * factor;\n\t\tif (numCapes >= 25) {\n\t\t\t_factorNumVectorsPol = 10;\n\t\t\t_factorNumVectorsLin = 20;\n\t\t\t_factorNumVectorsPunt = 30;\n\t\t}\n\t\ttry {\n\t\t\tvar ff = item.layer.toGeoJSON();\t\t\t\t\t\n\t\t\tvar numFeatures = ff.features.length;\n\t\t\tif (item.layer.options.geometryType) {\n\t\t\t\tif (item.layer.options.geometryType.indexOf('polygon') != -1) {\n\t\t\t\t\t_escriuDebug(item.layer.options,\"instamaps.mapa3D-1.0.0\",1288);\n\t\t\t\t\tif (item.layer.options.source && item.layer.options.source.indexOf('json')!=-1) {\n\t\t\t\t\t\tnumFeatures <= _factorNumVectorsPol ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t\t\tif (tmp_feature.tipus == 'vector') {\n\t\t\t\t\t\t\tfor (var j = 0; j < numFeatures; j++) {\n\t\t\t\t\t\t\t\tvar vertex = ff.features[j].geometry.coordinates[0].length;\n\t\t\t\t\t\t\t\t_escriuDebug(vertex,\"instamaps.mapa3D-1.0.0\",1303);\n\t\t\t\t\t\t\t\tif (vertex > 46000) {\n\t\t\t\t\t\t\t\t\ttmp_feature.msg = 'none';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (mapZoom <= 10 && numFeatures < 3500) {\n\t\t\t\t\t\t\ttmp_feature.msg = 'none';\n\t\t\t\t\t\t\ttmp_feature.tipus = 'vector'\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (item.layer.options.source && item.layer.options.source.indexOf('xls') != -1) {\n\t\t\t\t\t\tnumFeatures <= 1000 ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t\t\ttmp_feature.msg = 'none';\n\t\t\t\t\t} else if (item.layer.options.source && item.layer.options.source.indexOf('csv') != -1) {\n\t\t\t\t\t\tnumFeatures <= 1000 ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t\t\ttmp_feature.msg = 'none';\n\t\t\t\t\t} else if (!item.layer.options.source) {\n\t\t\t\t\t\tnumFeatures <= _factorNumVectorsPol ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttmp_feature.tipus = 'vecras';\n\t\t\t\t\t}\n\t\t\t\t} else if (item.layer.options.geometryType.indexOf('polyline') != -1) {\n\t\t\t\t\tnumFeatures <= (_factorNumVectorsLin) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t} else { //son punts\n\t\t\t\t\tnumFeatures <= (_factorNumVectorsPunt) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t\t}\n\t\t\t} else if (item.layer.options.tipusRang) {\n\t\t\t\ttmp_feature.tipus = 'vecras';\n\t\t\t} else {\n\t\t\t\tnumFeatures <= (_factorNumVectorsPunt) ? tmp_feature.tipus = 'vector' : tmp_feature.tipus = 'vecras';\n\t\t\t}\n\t\t\tff = \"\";\n\t\t\t_escriuDebug(tmp_feature,\"instamaps.mapa3D-1.0.0\",1367);\n\t\t\treturn tmp_feature;\n\t\t} catch (err) {\n\t\t\t$.publish('analyticsEvent',{event:[ 'error3D', err, '_utilDeterminaTipusItem', 1]});\n\t\t\tif (item.layer.options.tipusRang) {\n\t\t\t\ttmp_feature.tipus = 'vecras';\n\t\t\t} else {\n\t\t\t\ttmp_feature.tipus = 'raster';\n\t\t\t}\n\t\t\t_escriuDebug(tmp_feature,\"instamaps.mapa3D-1.0.0\",1382);\n\t\t\treturn tmp_feature;\n\t\t}\n\t};\n\n\tthis.calculaMatriuAlcades = function (dataSource, matriu, hFactor, visible, msg) {\n\t\t_escriuDebug(\"calculaMatriuAlcades\",\"instamaps.mapa3D-1.0.0\",1367);\n\t\tvar collection = dataSource.entities;\n\t\tvar entities = collection.values;\n\t\tvar length = entities.length;\n\t\tvar that = this;\n\t\tif (msg == 'vector') {\n\t\t\tfor (var i = 0; i < length; ++i) {\n\t\t\t\tvar entity = entities[i];\n\t\t\t\tentity.ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\t\tif (entity.billboard) {\n\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.position._value);\n\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\n\t\t\t\t} else if (entity.polyline) {\n\t\t\t\t\tfor (var j = 0; j < entity.polyline.positions._value.length; ++j) {\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polyline.positions._value[j]);\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\n\t\t\t\t\t}\n\t\t\t\t} else if (entity.polygon) {\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polygon._hierarchy._value.positions[j]);\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} //fi bicle FOR\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, factorTerreny, matriu);\n\t\t\tCesium.when(promise, function (updatedPositions) {\n\t\t\t\t_escriuDebug(length,\"instamaps.mapa3D-1.0.0\",1452);\n\t\t\t\tif(length >50){\n\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\n\t\t\t\t\t},factorNavegador);\n\t\t\t\t}else{\t\t\t\t\n\t\t\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\n\t\t\t\t}\t\n\t\t\t});\n\t\t\tmap.spin(true);\n\t\t} else {\n\t\t\tthat.addEntitiesVisorCesium(dataSource, matriu, 13, visible, msg);\n\t\t}\n\t};\n\n\tthis.calculaMatriuAlcadesClaimTerrain = function (dataSource, matriu, hFactor, visible, msg) {\n\t\tvar collection = dataSource.entities;\n\t\tvar entities = collection.values;\n\t\tvar length = entities.length;\n\t\tvar that = this;\n\t\tif (msg == 'vector' && !entities[0].polyline) {\n\t\t\tconsole.info(\"No hauria entrar\");\n\t\t\tfor (var i = 0; i < length; ++i) {\n\t\t\t\tvar entity = entities[i];\n\t\t\t\tentity.ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\t\tif (entity.billboard) {\n\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.position._value)\n\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\n\t\t\t\t} \n\t\t\t\telse if (entity.polygon) {\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\n\t\t\t\t\t\tvar point = ellipsoid.cartesianToCartographic(entity.polygon._hierarchy._value.positions[j]);\n\t\t\t\t\t\tmatriu.push(Cesium.Cartographic.fromRadians(point.longitude,point.latitude));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} //fi bicle FOR\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, factorTerreny, matriu);\n\t\t\tCesium.when(promise, function (updatedPositions) {\n\t\t\t\tif(length >50){\n\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\n\t\t\t\t\t},factorNavegador);\n\t\t\t\t}else{\t\t\t\t\n\t\t\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\t\n\t\t\t\t}\t\n\t\t\t});\n\t\t\tmap.spin(true);\n\t\t} else {\n\t\t\tthis.addEntitiesVisorCesiumClamTerrain(dataSource, matriu, 13, visible, msg);\t\n\t\t}\n\t};\n\t\n\tthis.addEntitiesVisorCesiumClamTerrain = function (dataSource, matriu, hfactor, visible, msg) {\n\t\tvar entities = dataSource.entities.values;\n\t\tvar z = 0;\n\t\tfor (var i = 0; i < entities.length; i++) {\n\t\t\tvar entity = entities[i];\n\t\t\tentity.show = true;\n\t\t\tentity.properties.dataSource = dataSource.id;\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\tif (entity.polyline) {\n\t\t\t\tvar colorLin=entity.properties.styles.color;\n\t\t\t\tvar wLin=entity.properties.styles.weight;\n\t\t\t\tif(!colorLin){colorLin=\"#FFCC00\";}\n\t\t\t\tif(!wLin){wLin=2;}\n\t\t\t\tvar _newEntity = {\n\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\tpolyline : {\n\t\t\t\t\t\tpositions : entity.polyline.positions._value,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\twidth :(parseInt(wLin)*4),\n\t\t\t\t\t\tmaterial : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin)),\n\t\t\t\t\t\tcolor : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin)),\n\t\t\t\t\t\theightReference :Cesium.HeightReference.CLAMP_TO_GROUND\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(_newEntity);\n\t\t\t} else if (entity.billboard) {\n\t\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\n\t\t\t\tif (entity.properties.styles.icon) {\n\t\t\t\t\tvar _alt = parseInt(matriu[i].height + 100)\n\t\t\t\t\tvar redEllipse = viewer.entities.add({\n\t\t\t\t\t\tposition : ellipsoid.cartographicToCartesian(matriu[i]),\n\t\t\t\t\t\theight : matriu[i].height,\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tellipse : {\n\t\t\t\t\t\t\tsemiMinorAxis : 0.75,\n\t\t\t\t\t\t\tsemiMajorAxis : 0.75,\n\t\t\t\t\t\t\tperPositionHeight : false,\n\t\t\t\t\t\t\theight : matriu[i].height,\n\t\t\t\t\t\t\tmaterial : Cesium.Color.WHITE,\n\t\t\t\t\t\t\textrudedHeight : parseInt(_alt)\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tmatriu[i].height = _alt;\n\t\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\n\t\t\t\t\tvar pinBuilder = new PinBuilder_IM();\n\t\t\t\t\tentity.billboard.color = Cesium.Color.WHITE;\n\t\t\t\t\tif (entity.properties.styles.icon.options.markerColor) {\n\t\t\t\t\t\tvar colorPUNT = entity.properties.styles.icon.options.markerColor; //\n\t\t\t\t\t\tif (colorPUNT.indexOf('punt_r') == -1) {\n\t\t\t\t\t\t\tentity.billboard.image = pinBuilder.fromColor(\n\t\t\t\t\t\t\t\tCesium.Color[colorPUNT.toUpperCase()], 48);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tentity.billboard = \"\";\n\t\t\t\t\t\t\tentity.point = {\n\t\t\t\t\t\t\t\tshow : visible, // default\n\t\t\t\t\t\t\t\tcolor : Cesium.Color\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.fillColor), // default:\n\t\t\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.icon.options.radius) * 1.5), // default:\n\t\t\t\t\t\t\t\toutlineColor : Cesium.Color\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.color), // default:\n\t\t\t\t\t\t\t\toutlineWidth : 2\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (entity.properties.styles.icon.options.iconUrl) {\n\t\t\t\t\t\tvar url = entity.properties.styles.icon.options.iconUrl;\n\t\t\t\t\t\tentity.billboard.image = url;\n\t\t\t\t\t}\n\t\t\t\t} else if (!entity.properties.styles.icon) {\n\t\t\t\t\tvar _color=\"#FFCC00\";\n\t\t\t\t\tentity.properties.styles.color?_color=entity.properties.styles.color:_color=_color;\n\t\t\t\t\tentity.billboard = \"\";\n\t\t\t\t\tentity.point = {\n\t\t\t\t\t\tshow : visible, // default\n\t\t\t\t\t\tcolor : Cesium.Color\n\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.fillColor), // default:\n\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.radius) * 1.5), // default:\n\t\t\t\t\t\toutlineColor : Cesium.Color\n\t\t\t\t\t\t.fromCssColorString(_color), // default:\n\t\t\t\t\t\toutlineWidth : 2\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\t_escriuDebug(\"No hauria entrar aqui\",\"instamaps.mapa3D-1.0.0\",1713);\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(entity); //add billboard\n\t\t\t} else if (entity.polygon) {\n\t\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\t\tentity.polygon.perPositionHeight = new Cesium.ConstantProperty(false);\n\t\t\t\tvar borderColor = entity.properties.styles.borderColor ? entity.properties.styles.borderColor : \"\";\n\t\t\t\tvar fillOpacity = entity.properties.styles.fillOpacity ? entity.properties.styles.fillOpacity : false;\n\t\t\t\tvar fillColor = entity.properties.styles.fillColor ? entity.properties.styles.fillColor : \"\";\n\t\t\t\tvar outlineWidth = entity.properties.styles.weight;\n\t\t\t\tif (fillColor == \"\") {\n\t\t\t\t\tfillColor = entity.properties.styles.color\n\t\t\t\t};\n\t\t\t\tif (borderColor == \"\" || borderColor == \"#FFC400\") {\n\t\t\t\t\tborderColor = entity.properties.styles.color\n\t\t\t\t};\n\t\t\t\tif (!fillOpacity) {\n\t\t\t\t\tfillOpacity = 0.5;\n\t\t\t\t};\n\t\t\t\tvar alcada = 0;\n\t\t\t\tvar _tenimAlcada = false;\n\t\t\t\tif (entity.properties.elevation) {\n\t\t\t\t\talcada = parseInt(entity.properties.elevation);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.ELEVATION) {\n\t\t\t\t\talcada = parseInt(entity.properties.ELEVATION);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.height) {\n\t\t\t\t\talcada = parseInt(entity.properties.height);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.HEIGHT) {\n\t\t\t\t\talcada = parseInt(entity.properties.HEIGHT);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.altura) {\n\t\t\t\t\talcada = parseInt(entity.properties.altura);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.ALTURA) {\n\t\t\t\t\talcada = parseInt(entity.properties.ALTURA);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.z) {\n\t\t\t\t\talcada = parseInt(entity.properties.z);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.Z) {\n\t\t\t\t\talcada = parseInt(entity.properties.Z);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.volum) {\n\t\t\t\t\talcada = parseInt(entity.properties.volum);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.VOLUM) {\n\t\t\t\t\talcada = parseInt(entity.properties.VOLUM);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else {\n\t\t\t\t\t_tenimAlcada = false;\n\t\t\t\t}\n\t\t\t\tvar entityMatriu = [];\n\t\t\t\tvar _matriuAlcada = [];\n\t\t\t\tvar _extrudeAlcada;\n\t\t\t\tif (msg == 'vector') {\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\n\t\t\t\t\t\tz = z + 1;\n\t\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\n\t\t\t\t\t\tif (_tenimAlcada) {\n\t\t\t\t\t\t\t_matriuAlcada.push(matriu[z - 1].height);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\n\t\t\t\t} else {\n\t\t\t\t\tvar cartesianPositions = entity.polygon._hierarchy._value;\n\t\t\t\t}\n\t\t\t\tvar _newEntity;\n\t\t\t\tif (_tenimAlcada) {\n\t\t\t\t\tvar terra = 0;\n\t\t\t\t\tif (msg == 'vector') {\n\t\t\t\t\t\tterra = (Math.max.apply(Math, _matriuAlcada));\n\t\t\t\t\t}\n\t\t\t\t\t_extrudeAlcada = terra + parseInt(alcada);\n\t\t\t\t\t_newEntity = {\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\tpolygon : {\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\n\t\t\t\t\t\t\toutline : true,\n\t\t\t\t\t\t\textrudedHeight : _extrudeAlcada,\n\t\t\t\t\t\t\tfill : true,\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\n\t\t\t\t\t\t\t// outlineWidth : 3.0,\n\t\t\t\t\t\t\tperPositionHeight : true\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\t_newEntity = {\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\tpolygon : {\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\n\t\t\t\t\t\t\toutline : true,\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\n\t\t\t\t\t\t\theightReference :Cesium.HeightReference.CLAMP_TO_GROUND\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(_newEntity);\n\t\t\t}\n\t\t} // final for afegim el DataSource\n\t\tdataSource = \"\";\n\t\tmap.spin(false);\n\t\tmatriu = [];\n\t};\n\t\n\tthis.addEntitiesVisorCesium = function (dataSource, matriu, hfactor, visible, msg) {\n\t\t_escriuDebug(\"addEntitiesVisorCesium\",\"instamaps.mapa3D-1.0.0\",1891);\n\t\tvar entities = dataSource.entities.values;\n\t\tvar z = 0;\n\t\tfor (var i = 0; i < entities.length; i++) {\n\t\t\tvar entity = entities[i];\n\t\t\tentity.show = true;\n\t\t\tentity.properties.dataSource = dataSource.id;\n\t\t\tvar ellipsoid = viewer.scene.globe.ellipsoid;\n\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\tif (entity.polyline) {\t\t\t\t\t\n\t\t\t\tvar entityMatriu = [];\n\t\t\t\tfor (var j = 0; j < entity.polyline.positions._value.length; ++j) {\n\t\t\t\t\tz = z + 1;\n\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\n\t\t\t\t}\n\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\n\t\t\t\tvar colorLin=entity.properties.styles.color;\n\t\t\t\tvar wLin=entity.properties.styles.weight;\n\t\t\t\tif(!colorLin){colorLin=\"#FFCC00\";}\n\t\t\t\tif(!wLin){wLin=2;}\t\t\t\n\t\t\t\tvar _newEntity = {\n\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\tpolyline : {\n\t\t\t\t\t\tpositions : cartesianPositions,\n\t\t\t\t\t\toutline : true,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\twidth :wLin,\n\t\t\t\t\t\tmaterial : new Cesium.ColorMaterialProperty(Cesium.Color.fromCssColorString(colorLin))\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(_newEntity);\n\t\t\t} else if (entity.billboard) {\n\t\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\n\t\t\t\tif (entity.properties.styles.icon) {\n\t\t\t\t\tvar _alt = parseInt(matriu[i].height + 100)\n\t\t\t\t\tvar redEllipse = viewer.entities.add({\n\t\t\t\t\t\tposition : ellipsoid.cartographicToCartesian(matriu[i]),\n\t\t\t\t\t\theight : matriu[i].height,\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tellipse : {\n\t\t\t\t\t\t\tsemiMinorAxis : 0.75,\n\t\t\t\t\t\t\tsemiMajorAxis : 0.75,\n\t\t\t\t\t\t\tperPositionHeight : false,\n\t\t\t\t\t\t\theight : matriu[i].height,\n\t\t\t\t\t\t\tmaterial : Cesium.Color.WHITE,\n\t\t\t\t\t\t\textrudedHeight : parseInt(_alt)\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tmatriu[i].height = _alt;\n\t\t\t\t\tentity.position._value = ellipsoid.cartographicToCartesian(matriu[i]);\n\t\t\t\t\tvar pinBuilder = new PinBuilder_IM();\n\t\t\t\t\tentity.billboard.color = Cesium.Color.WHITE;\n\t\t\t\t\tentity.billboard.heightReference=Cesium.HeightReference.NONE ;\n\t\t\t\t\tif (entity.properties.styles.icon.options.markerColor) {\n\t\t\t\t\t\tvar colorPUNT = entity.properties.styles.icon.options.markerColor; //\n\t\t\t\t\t\tif (colorPUNT.indexOf('punt_r') == -1) {\n\t\t\t\t\t\t\tentity.billboard.image = pinBuilder.fromColor(Cesium.Color[colorPUNT.toUpperCase()], 48);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tentity.billboard = \"\";\n\t\t\t\t\t\t\tentity.point = {\n\t\t\t\t\t\t\t\tshow : visible, // default\n\t\t\t\t\t\t\t\tcolor : Cesium.Color\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.fillColor), // default:\n\t\t\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.icon.options.radius) * 1.5), // default:\n\t\t\t\t\t\t\t\toutlineColor : Cesium.Color\n\t\t\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.icon.options.color), // default:\n\t\t\t\t\t\t\t\toutlineWidth : 2\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (entity.properties.styles.icon.options.iconUrl) {\t\t\t\t\t\t\n\t\t\t\t\t\tvar url = entity.properties.styles.icon.options.iconUrl;\n\t\t\t\t\t\tentity.billboard.image = url;\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t} else if (!entity.properties.styles.icon) {\n\t\t\t\t\tvar _color=\"#FFCC00\";\n\t\t\t\t\tentity.properties.styles.color?_color=entity.properties.styles.color:_color=_color;\n\t\t\t\t\tentity.billboard = \"\";\n\t\t\t\t\tentity.point = {\n\t\t\t\t\t\tshow : visible, // default\n\t\t\t\t\t\tcolor : Cesium.Color\n\t\t\t\t\t\t.fromCssColorString(entity.properties.styles.fillColor), // default:\n\t\t\t\t\t\tpixelSize : (parseInt(entity.properties.styles.radius) * 1.5), // default:\n\t\t\t\t\t\toutlineColor : Cesium.Color\n\t\t\t\t\t\t.fromCssColorString(_color), // default:\n\t\t\t\t\t\toutlineWidth : 2\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\t_escriuDebug(\"No hauria entrar aqui\",\"instamaps.mapa3D-1.0.0\",2023);\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(entity); //add billboard\n\t\t\t} else if (entity.polygon) {\n\t\t\t\tentity.ellipsoid = ellipsoid;\n\t\t\t\tentity.polygon.perPositionHeight = new Cesium.ConstantProperty(false);\n\t\t\t\tvar borderColor = entity.properties.styles.borderColor ? entity.properties.styles.borderColor : \"\";\n\t\t\t\tvar fillOpacity = entity.properties.styles.fillOpacity ? entity.properties.styles.fillOpacity : false;\n\t\t\t\tvar fillColor = entity.properties.styles.fillColor ? entity.properties.styles.fillColor : \"\";\n\t\t\t\tvar outlineWidth = entity.properties.styles.weight;\n\t\t\t\tif (fillColor == \"\") {\n\t\t\t\t\tfillColor = entity.properties.styles.color\n\t\t\t\t};\n\t\t\t\tif (borderColor == \"\" || borderColor == \"#FFC400\") {\n\t\t\t\t\tborderColor = entity.properties.styles.color\n\t\t\t\t};\n\t\t\t\tif (!fillOpacity) {\n\t\t\t\t\tfillOpacity = 0.5;\n\t\t\t\t};\n\t\t\t\tvar alcada = 0;\n\t\t\t\tvar _tenimAlcada = false;\n\t\t\t\t_escriuDebug(entity.properties,\"instamaps.mapa3D-1.0.0\",2053);\n\t\t\t\tif (entity.properties.elevation) {\n\t\t\t\t\talcada = parseInt(entity.properties.elevation);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.ELEVATION) {\n\t\t\t\t\talcada = parseInt(entity.properties.ELEVATION);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.height) {\n\t\t\t\t\talcada = parseInt(entity.properties.height);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.HEIGHT) {\n\t\t\t\t\talcada = parseInt(entity.properties.HEIGHT);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.altura) {\n\t\t\t\t\talcada = parseInt(entity.properties.altura);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.ALTURA) {\n\t\t\t\t\talcada = parseInt(entity.properties.ALTURA);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.z) {\n\t\t\t\t\talcada = parseInt(entity.properties.z);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.Z) {\n\t\t\t\t\talcada = parseInt(entity.properties.Z);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.volum) {\n\t\t\t\t\talcada = parseInt(entity.properties.volum);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.VOLUM) {\n\t\t\t\t\talcada = parseInt(entity.properties.VOLUM);\n\t\t\t\t\t_tenimAlcada = true;\n\t\t\t\t} else if (entity.properties.text) {\n\t\t\t\t\tif(entity.properties.text.indexOf('volum#')!=-1){\n\t\t\t\t\t\taltT=entity.properties.text.replace('volum#','');\n\t\t\t\t\t\talcada = parseInt(altT);\t\n\t\t\t\t\t\t_tenimAlcada = true;\t\n\t\t\t\t\t}else{\n\t\t\t\t\t_tenimAlcada = false;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t_tenimAlcada = false;\n\t\t\t\t}\n\t\t\t\tvar entityMatriu = [];\n\t\t\t\tvar _matriuAlcada = [];\n\t\t\t\tvar _extrudeAlcada;\n\t\t\t\tif (msg == 'vector') {\n\t\t\t\t\tfor (var j = 0; j < entity.polygon._hierarchy._value.positions.length; ++j) {\n\t\t\t\t\t\tz = z + 1;\n\t\t\t\t\t\tentityMatriu.push(matriu[z - 1]);\n\t\t\t\t\t\tif (_tenimAlcada) {\n\t\t\t\t\t\t\t_matriuAlcada.push(matriu[z - 1].height);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tvar cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(entityMatriu);\n\t\t\t\t} else {\n\t\t\t\t\tvar cartesianPositions = entity.polygon._hierarchy._value;\n\t\t\t\t}\n\t\t\t\tvar _newEntity;\n\t\t\t\tif (_tenimAlcada) {\n\t\t\t\t\tvar terra = 0;\n\t\t\t\t\tif (msg == 'vector') {\n\t\t\t\t\t\tterra = (Math.max.apply(Math, _matriuAlcada));\n\t\t\t\t\t}\n\t\t\t\t\t_extrudeAlcada = terra + parseInt(alcada);\n\t\t\t\t\t_newEntity = {\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\tpolygon : {\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\n\t\t\t\t\t\t\toutline : true,\n\t\t\t\t\t\t\textrudedHeight : _extrudeAlcada,\n\t\t\t\t\t\t\tfill : true,\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\n\t\t\t\t\t\t\tperPositionHeight : true\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t} else {\n\t\t\t\t\t_newEntity = {\n\t\t\t\t\t\tproperties : entity.properties,\n\t\t\t\t\t\tshow : visible,\n\t\t\t\t\t\tpolygon : {\n\t\t\t\t\t\t\thierarchy : cartesianPositions,\n\t\t\t\t\t\t\toutline : true,\n\t\t\t\t\t\t\toutlineColor : Cesium.Color.fromCssColorString(borderColor),\n\t\t\t\t\t\t\tmaterial : Cesium.Color.fromCssColorString(fillColor).withAlpha(fillOpacity),\n\t\t\t\t\t\t\theightReference : Cesium.HeightReference.CLAMP_TO_GROUND\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tviewer.entities.add(_newEntity);\n\t\t\t}\n\t\t} // final for afegim el DataSource\n\t\tdataSource = \"\";\n\t\tmap.spin(false);\n\t\tmatriu = [];\n\t};\n\n\tthis.getPosicioCamera3D = function () {\n\t\tvar dfd = $.Deferred();\n\t\ttry {\n\t\t\tvar cameraPos = viewer.camera._position.x + ',' + viewer.camera._position.y + ',' + viewer.camera._position.z + ','\n\t\t\t\t+viewer.camera._directionWC.x + ',' + viewer.camera._directionWC.y + ',' + viewer.camera._directionWC.z + ','\n\t\t\t\t+viewer.camera._up.x + ',' + viewer.camera._up.y + ',' + viewer.camera._up.z;\n\n\t\t\tdfd.resolve(cameraPos);\n\t\t} catch (Err) {\n\t\t\tdfd.reject(Err);\n\t\t}\n\t\treturn dfd.promise();\n\t};\n\n\tthis.setPosicioCamera3D = function (cameraPos) {\n\t\tvar v = cameraPos.split(\",\");\n\t\t//_postion\n\t\teye = new Cesium.Cartesian3(parseFloat(v[0]), parseFloat(v[1]), parseFloat(v[2]));\n\t\ttarget = Cesium.Cartesian3.add(eye, new Cesium.Cartesian3(parseFloat(v[3]), parseFloat(v[4]), parseFloat(v[5])),\n\t\t\tnew Cesium.Cartesian3());\n\t\tup = new Cesium.Cartesian3(parseFloat(v[6]), parseFloat(v[7]), parseFloat(v[8]));\n\t\tviewer.camera.flyTo({\n\t\t\tdestination : new Cesium.Cartesian3(parseFloat(v[0]), parseFloat(v[1]), parseFloat(v[2])),\n\t\t\torientation : {\n\t\t\t\tdirection : new Cesium.Cartesian3(parseFloat(v[3]), parseFloat(v[4]), parseFloat(v[5])),\n\t\t\t\tup : new Cesium.Cartesian3(parseFloat(v[6]), parseFloat(v[7]), parseFloat(v[8]))\n\t\t\t},\n\t\t\tduration : 0\n\t\t});\n\t};\n\n\tthis.gestionaTerrainProvaider = function (lat, lng, credit) {\n\t\tvar dfd = $.Deferred();\n\t\ttry {\n\t\t\tif (this._miraCentreDins(lat, lng) && credit != 'icgc') {\n\t\t\t\tfactorTerreny = 14\n\t\t\t\t\tterreny = new Cesium.CesiumTerrainProvider({\n\t\t\t\t\t\turl : _urlTerrenys,\n\t\t\t\t\t\tcredit : 'icgc'\n\t\t\t\t\t});\n\t\t\t\tdfd.resolve(terreny);\n\t\t\t} else if (!this._miraCentreDins(lat, lng) && credit != 'cesium') {\n\t\t\t\tfactorTerreny = 11;\n\t\t\t\tterreny = new Cesium.CesiumTerrainProvider({\n\t\t\t\t\turl : 'http://assets.agi.com/stk-terrain/world',\n\t\t\t\t\tcredit : 'cesium'\n\t\t\t\t});\n\t\t\t\tdfd.resolve(terreny);\n\t\t\t} else {\n\t\t\t\tdfd.resolve(null);\n\t\t\t}\n\t\t} catch (Err) {\n\t\t\tdfd.reject(Err);\n\t\t}\n\t\treturn dfd.promise();\n\t};\n\n\tthis._ActivaDesactivaCapa = function (bi, visible) {\n\t\tfor (var i = 0; i < viewer.dataSources.length; i++) {\n\t\t\tviewer.dataSources[i].show = false;\n\t\t}\n\t};\n\n\tthis._miraPosicioCamera = function () {\n\t\tvar pos = viewer.camera.positionCartographic;\n\t\tvar obj = new Object;\n\t\tobj.x = parseFloat(pos.longitude * (180.0 / Math.PI));\n\t\tobj.y = parseFloat(pos.latitude * (180.0 / Math.PI));\n\t\tobj.z = pos.height;\n\t\treturn obj;\n\t};\n\n\tthis.calculaPosicioInici = function (bounds, mapZoom) {\n\t\tvar dfd = $.Deferred();\n\t\ttry {\n\t\t\tvar ns = parseFloat(bounds.getNorth() - bounds.getSouth());\n\t\t\tvar we = parseFloat(bounds.getEast() - bounds.getWest());\n\t\t\tvar ew = parseFloat(bounds.getWest() - bounds.getEast());\n\t\t\tvar centerLng = parseFloat(bounds.getEast()) + parseFloat(ew / 2);\n\t\t\tvar centerLat = parseFloat(bounds.getNorth()) - parseFloat(ns / 2);\n\t\t\tvar inNS = parseFloat(ns / 2);\n\t\t\tvar inWE = parseFloat(we / 2);\n\t\t\tvar southLat = bounds.getSouth();\n\t\t\tvar factor = 1;\n\t\t\tvar rectangle2 = Cesium.Rectangle.fromDegrees((bounds.getWest() + inWE),\n\t\t\t\t((bounds.getSouth()) - ns), \n\t\t\t\t(bounds.getEast() - inWE),\n\t\t\t\t((bounds.getNorth()) - ns));\n\t\t\tvar matriuAlt = [56623104, 28311552, 14155776, 7077888, 3538944, 1769472, 884736, 442368, 221184, 110592, 55296, 27648, 13824, 6912, 3456, 1728, 864, 432, 216, 108, 54, 27, 13, 5];\n\t\t\tvar matriuGrauSud = [16, 16, 16, 13, 10, 7, 4, 2, 1, 0.8, 0.7, 0.2, 0.1, 0.055, 0.03, 0.015, 0.0095, 0.005, 0.002, 0.0015, 0.0005, 0.00035, 0.0002];\n\t\t\tvar matriuPitch = [-73, -73, -73, -71, -69, -67, -65, -63, -61, -59, -57, -55, -53, -51, -49, -47, -45, -43, -41, -39, -37, -35, -33];\n\t\t\tvar altMetres = matriuAlt[mapZoom];\n\t\t\tvar grausSud = matriuGrauSud[mapZoom];\n\t\t\tvar _picth = matriuPitch[mapZoom];\n\t\t\tvar distMetres = altMetres * Math.sin(37.5);\n\t\t\tvar factorLat = Cesium.Math.toDegrees(Math.tan(distMetres / 6370000));\n\t\t\tvar newLat = parseFloat(centerLat) - parseFloat(grausSud);\n\t\t\tvar positions = [\n\t\t\t\tCesium.Cartographic.fromDegrees(centerLng, newLat)\n\t\t\t];\n\t\t\tvar promise = Cesium.sampleTerrain(terreny, 15, positions);\n\t\t\tCesium.when(promise, function (updatedPositions) {\n\n\t\t\t});\n\t\t\tvar rectangle3 = Cesium.Rectangle.fromDegrees(\n\t\t\t\t(bounds.getWest()),\n\t\t\t\t((bounds.getSouth()) - parseFloat(ns / 2)),\n\t\t\t\t(bounds.getEast()),\n\t\t\t\t((bounds.getNorth()) - parseFloat(ns / 2)));\n\n\t\t\tvar rectangle4 = Cesium.Rectangle.fromDegrees(\n\t\t\t\t(bounds.getWest()),\n\t\t\t\t((bounds.getSouth()) + parseFloat(factorLat)),\n\t\t\t\t(bounds.getEast()),\n\t\t\t\t((bounds.getNorth()) + parseFloat(factorLat)));\n\n\t\t\tvar rectangle = Cesium.Rectangle.fromDegrees(\n\t\t\t\t(bounds.getWest()),\n\t\t\t\t((bounds.getSouth())), \n\t\t\t\t(bounds.getEast()),\n\t\t\t\t((bounds.getNorth())));\n\n\t\t\tvar posicioMapa3D = {\n\t\t\t\t'rectangle' : rectangle,\n\t\t\t\t'rectangle2' : rectangle2,\n\t\t\t\t'rectangle3' : rectangle3,\n\t\t\t\t'rectangle4' : rectangle4,\n\t\t\t\t'centerLng' : centerLng,\n\t\t\t\t'centerLat' : centerLat,\n\t\t\t\t'altMetres' : altMetres,\n\t\t\t\t'newAlt' : positions,\n\t\t\t\t'grausSud' : grausSud,\n\t\t\t\t'_picth' : _picth,\n\t\t\t\t'newLat' : newLat,\n\t\t\t\t'southLat' : southLat,\n\t\t\t\t'x0' : bounds.getWest(),\n\t\t\t\t'y0' : bounds.getSouth(),\n\t\t\t\t'x1' : bounds.getEast(),\n\t\t\t\t'y1' : bounds.getNorth()\n\t\t\t};\n\t\t\tdfd.resolve(posicioMapa3D);\n\t\t} catch (Err) {\n\t\t\tdfd.reject(Err);\n\t\t}\n\t\treturn dfd.promise();\n\t};\n\n\tthis.retornaPosicio2D = function () {\n\t\tvar dfd = $.Deferred();\n\t\ttry {\n\t\t\tvar windowPosition = new Cesium.Cartesian2(viewer.container.clientWidth / 2, viewer.container.clientHeight / 2);\n\t\t\tvar pickPosition = viewer.camera.pickEllipsoid(windowPosition);\n\t\t\tvar pickPositionCartographic = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPosition);\n\t\t\tvar posUL = new Cesium.Cartesian2(0, 0);\n\t\t\tvar posLR = new Cesium.Cartesian2(viewer.container.clientWidth, viewer.container.clientHeight);\n\t\t\tvar pickPositionUL = viewer.camera.pickEllipsoid(posUL);\n\t\t\tvar pickPositionCartographicUL = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPositionUL);\n\t\t\tvar pickPositionLR = viewer.camera.pickEllipsoid(posLR);\n\t\t\tvar pickPositionCartographicLR = viewer.scene.globe.ellipsoid.cartesianToCartographic(pickPositionLR);\n\t\t\tvar bbox = {};\n\t\t\tbbox.lng0 = Cesium.Math.toDegrees(pickPositionCartographicUL.longitude);\n\t\t\tbbox.lat0 = Cesium.Math.toDegrees(pickPositionCartographicUL.latitude);\n\t\t\tbbox.lng1 = Cesium.Math.toDegrees(pickPositionCartographicLR.longitude);\n\t\t\tbbox.lat1 = Cesium.Math.toDegrees(pickPositionCartographicLR.latitude);\n\t\t\tvar zoomLevel;\n\t\t\tvar latDiff = parseFloat(bbox.lat1) - parseFloat(bbox.lat0);\n\t\t\tvar lngDiff = parseFloat(bbox.lng1) - parseFloat(bbox.lng1);\n\t\t\tvar centerLat = parseFloat(bbox.lat0) + (parseFloat(latDiff / 2));\n\t\t\tvar centerLng = parseFloat(bbox.lng0) + (parseFloat(lngDiff / 2));\n\t\t\tvar maxDiff = (lngDiff > latDiff) ? lngDiff : latDiff;\n\t\t\tif (maxDiff < 256 / Math.pow(2, 20)) {\n\t\t\t\tzoomLevel = 21;\n\t\t\t} else {\n\t\t\t\tzoomLevel = parseInt((-1 * ((Math.log(maxDiff) / Math.log(2)) - (Math.log(360) / Math.log(2)))));\n\t\t\t\tif (zoomLevel > 18) {\n\t\t\t\t\tzoomLevel = zoomLevel - 2;\n\t\t\t\t}\n\t\t\t\tif (zoomLevel < 1) {\n\t\t\t\t\tzoomLevel = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbbox.centerLat = centerLat;\n\t\t\tbbox.centerLng = centerLng;\n\t\t\tbbox.zoomLevel = zoomLevel;\n\t\t\tdfd.resolve(bbox);\n\t\t} catch (Err) {\n\t\t\tvar bbox = {};\n\t\t\tbbox.lng0 = map.getBounds().getWest();\n\t\t\tbbox.lat0 = map.getBounds().getSouth();\n\t\t\tbbox.lng1 = map.getBounds().getEast();\n\t\t\tbbox.lat1 = map.getBounds().getNorth();\n\t\t\tdfd.resolve(bbox);\n\t\t}\n\t\treturn dfd.promise();\n\t};\n\n\tthis._miraCentreDins = function (y, x) {\n\t\tvar x0 = 0.1087; // 0.7525\n\t\tvar y0 = 40.4763; // 40.5263\n\t\tvar x1 = 3.33669; // 3.3563\n\t\tvar y1 = 42.8855; // 42.3748\n\t\tif (x >= x0 && x <= x1 && y >= y0 && y <= y1) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t};\n} // fi objecte\n\n\nfunction mostraMsgNo3D() {\n\tjQuery(\"#dialgo_no_webgl\").modal('show');\n\t$.publish('analyticsEvent',{event:[ appl, 'noWebGL3D', 'label 3D', 1]});\n}\n\nfunction detectoCapacitatsWebGL() {\n\tvar soc3D = true;\n\tif (!Modernizr.webgl) {\n\t\tsoc3D = false;\n\t} else if (!window.WebGLRenderingContext) {\n\t\tsoc3D = false;\n\t} else {\n\t\tvar canvas = document.createElement('canvas');\n\t\tvar webglOptions = {\n\t\t\talpha : false,\n\t\t\tstencil : false,\n\t\t\tfailIfMajorPerformanceCaveat : true\n\t\t};\n\t\tvar gl = canvas.getContext(\"webgl\", webglOptions) || canvas.getContext(\"experimental-webgl\", webglOptions);\n\t\tif (!gl) {\n\t\t\tsoc3D = false;\n\t\t}\n\t}\n\treturn soc3D;\n}\n\nfunction addHtmlModalNoWebGL() {\n\tjQuery('#mapa_modals').append(\n\t\t'\t<!-- Modal Old Browser -->' +\n\t\t'\t\t<div id=\"dialgo_no_webgl\" class=\"modal\">' +\n\t\t'\t\t<div class=\"modal-dialog\">' +\n\t\t'\t\t\t<div class=\"modal-content\">' +\n\t\t'\t\t\t\t<div class=\"modal-header\">' +\n\t\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"' +\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>' +\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\">Ups! Ho sentim, no es pot inicialitzar el mapa en 3D.</h4>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t\t<div class=\"modal-body\">' +\n\t\t'\t\t\t\t\t<div lang=\"ca\">Aquest prototip utilitza Cesium JS, una llibreria per a la creació de mapes en 3D - basada amb WebGL - que per funcionar correctament necessita que tingueu la darrera versió del navegador web i que la tarja gràfica del vostre ordinador tingui carregats els drivers més actuals</div>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t\t<div class=\"modal-footer\">' +\n\t\t'\t\t\t\t\t<button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Continuar</button>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t</div>' +\n\t\t'\t\t\t<!-- /.modal-content -->' +\n\t\t'\t\t</div>' +\n\t\t'\t\t<!-- /.modal-dialog -->' +\n\t\t'\t</div>' +\n\t\t'\t<!-- fi Modal Old Browser -->');\n\n\tjQuery('#mapa_modals').append(\n\t\t'\t<!-- Modal Old Browser -->' +\n\t\t'\t\t<div id=\"dialgo_ad_3D\" class=\"modal\">' +\n\t\t'\t\t<div class=\"modal-dialog\">' +\n\t\t'\t\t\t<div class=\"modal-content\">' +\n\t\t'\t\t\t\t<div class=\"modal-header\">' +\n\t\t'\t\t\t\t\t<button id=\"old_icon_close\" type=\"button\" class=\"close\" data-dismiss=\"modal\"' +\n\t\t'\t\t\t\t\t\taria-hidden=\"true\">&times;</button>' +\n\t\t'\t\t\t\t\t<h4 lang=\"ca\" class=\"modal-title\"><span lang=\"ca\">La modalitat 3D està en fase beta.</span> <span style=\"color:#ffa500\" class=\"fa fa-warning sign\"></span> </h4>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t\t<div class=\"modal-body\">' +\n\t\t'\t\t\t\t\t<div class=\"alert-warning\"  style=\"padding:5px\"  lang=\"ca\">' +\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">En el mode 3D podeu seguir utilitzant la majoria de les funcionalitat d\\'Instamaps. Amb tot, notareu que algunes es troben de moment deshabilitades.</div><br>' +\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">La tecnologia WebGL que s\\'utilitza per la renderització 3D consumeix recursos del vostre maquinari i navegador. En funció del vostre equip obtindreu una millor rendiment. Comproveu que el vostre navegador està actualitzat.</div><br>' +\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\">Us recomanem que per al treball en 3 dimensions utilitzeu preferiblement <b>Chrome</b>, ja que demostra un més alt rendiment.</div>' +\n\t\t'                </div><hr>' +\n\t\t'\t\t\t\t\t<div>' +\n\t\t'\t\t\t\t\t\t<div style=\"float:left;padding-left: 14px;\"  lang=\"ca\"><img width=\"70\" src=\"/geocatweb/img/nav3d.png\"></div>' +\n\t\t'\t\t\t\t\t\t<div style=\" width: 80%;float:right;padding:5px\" class=\"alert-info\">' +\n\t\t'\t\t\t\t\t\t<div lang=\"ca\"><span>1-</span><span lang=\"ca\">Arrossegueu per rotar i girar la vista. Consells: També podeu orbitar lliurement prement la tecla CTRL i arrossegant el mapa .Fent doble click podreu inicialitzar la vista</span></div><br>' +\n\t\t'\t\t\t\t\t\t\t<div lang=\"ca\"><span>2-</span><span lang=\"ca\">Feu clic i arrossegueu per rotar la càmera</span></div>' +\n\t\t'\t\t\t\t\t\t</div>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t\t<div class=\"modal-footer\">' +\n\t\t'\t\t\t\t\t<span style=\"float:left\"><input id=\"chk_ad_3d\" type=\"checkbox\"><span lang=\"ca\">No mostrar més aquest missatge</span></span>  <button id=\"old_btn_close\" lang=\"ca\" type=\"button\" class=\"btn btn-info\" data-dismiss=\"modal\">Continuar</button>' +\n\t\t'\t\t\t\t</div>' +\n\t\t'\t\t\t</div>' +\n\t\t'\t\t\t<!-- /.modal-content -->' +\n\t\t'\t\t</div>' +\n\t\t'\t\t<!-- /.modal-dialog -->' +\n\t\t'\t</div>' +\n\t\t'\t<!-- fi Modal Old Browser -->');\n}\n\naddHtmlModalNoWebGL();\n","/**\n * require geocat.ajax-1.0.0\n * require geocat.web-1.0.0\n * require geocat.mapa.edit-data-table\n * require url.min\n * require leaflet\n * require L.IM_Map\n * require L.IM_controlFons\n * require jQuery.cookie\n * require geocat.utils\n * require geocat.constants\n * require instamaps.visor.geolocal\n */\n\n;(function(global, $){\n\n\tvar Visor = function(options){\n\t\treturn new Visor.init(options);\n\t}\n\n\tvar map_ = new L.IM_Map('map', {\n\t  \tzoomAnimation: false,\n        typeMap : \"topoMapGeo\",\n        minZoom: 2,\n        maxZoom : 19,\n        zoomControl: true,\n        timeDimension: true,\n\t    timeDimensionControl: true,\n\t    timeDimensionControlOptions:{\n\t    \tspeedSlider:false\n\t    },\n\t    spinerDiv: 'div_loading'\n\t}).setView([ 41.431, 1.8580 ], 8);\n\n\tvar visorOptions = {\n\t\taddDefaultZoomControl: true,\n\t\tcontrols: {},\n\t\tmap: map_\n\t};\n\n\tvar changeInitVisor = function(){\n\t\t$('.container').css('width','95%');\n\t\t//TODO ver como hacer para no depender del timeout\n\t\t//if (!isIframeOrEmbed()) setTimeout('activaPanelCapes(false)',3000);\n\t};\n\n\tVisor.prototype = {\n\t\taddLogoInstamap: function(){\n\t\t\tvar self = this;\n\t\t\t$.get(\"templates/logoInstamaps.html\",function(data){\n\t\t\t\tself.controls.controlLogos.addLogoHtml(data);\n\t\t\t});\n\n\t\t\treturn self;\n   \t\t},\n\n   \t\tremoveLogoInstamap: function(){\n\t\t\tvar self = this;\n\t\t\tself.controls.controlLogos.removeLogo({\n\t\t\t\tclassName: 'logo_instamaps'\n\t\t\t});\n\n\t\t\treturn self;\n   \t\t},\n\n   \t\tresizeMap: function(){\n\t\t\tvar self = this,\n\t\t\tmap = self.map,\n\t\t\toptionsBtn = {},\n\t\t\tfactorH = 0,\n\t\t\tfactorW = 0,\n\t\t\t_window = $( window ),\n\t\t\twidthW = _window.width(),\n\t\t\theightW = _window.height(),\n\t\t\t_mapDiv = $('#map'),\n\t\t\tcl = jQuery('.bt_llista span').attr('class');\n\t\t\tif(self.embed){//Pel cas visor, embeded\n\t\t\t\tfactorH = 0;\n\t\t\t}else{\n\t\t\t\tfactorH = $('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\n\t\t\t}\n\t\t\t_mapDiv.css('top', factorH + 'px');\n\t\t\t_mapDiv.height(heightW - factorH);\n\t\t\t_mapDiv.width(widthW - factorW);\n\n\t\t\tif(widthW<500 || heightW<=350){\n\t\t\t\toptionsBtn = {\n\t\t\t\t\topenInstamaps: true,\n\t\t\t\t\thome: false,\n\t\t\t\t\trouting: false,\n\t\t\t\t\tsearch: false,\n\t\t\t\t\tlocation: false,\n\t\t\t\t\tshare: false,\n\t\t\t\t\tlike: false,\n\n\t\t\t\t\tsnapshot: false,\n\t\t\t\t\t//print: false,\n\t\t\t\t\t//geopdf: false,\n\t\t\t\t\tc3d: false,\n\t\t\t\t\tmousePosition: false,\n\t\t\t\t\tscale: false,\n\t\t\t\t\tfons: false,\n\t\t\t\t\tlegend: false,\n\t\t\t\t\tlayers: false,\n\t\t\t\t\tminimap: false,\n\t\t\t\t\twidgets: false\n\t\t\t\t};\n\t\t\t}else{\n\t\t\t\toptionsBtn = {\n\t\t\t\t\topenInstamaps: false,\n\t\t\t\t\thome: true,\n\t\t\t\t\trouting: true,\n\t\t\t\t\tsearch: true,\n\t\t\t\t\tlocation: true,\n\t\t\t\t\tshare: true,\n\t\t\t\t\tlike: true,\n\n\t\t\t\t\tsnapshot: true,\n\t\t\t\t\t//print: true,\n\t\t\t\t\t//geopdf: true,\n\t\t\t\t\tc3d: true,\n\t\t\t\t\tmousePosition: true,\n\t\t\t\t\tscale: true,\n\t\t\t\t\tfons: true,\n\t\t\t\t\tlegend: true,\n\t\t\t\t\tlayers: true,\n\t\t\t\t\tminimap: true,\n\t\t\t\t\twidgets: true\n\t\t\t\t};\n\t\t\t}\n\t\t\tself._redrawButtons(optionsBtn);\n\t\t\tmap.invalidateSize();\n\t\t\treturn self;\n\t\t},\n\n\t\t_redrawButtons: function(options){\n\t\t\tvar self = this;\n\t\t\tif(options.home && self.controls.homeControl){\n\t\t\t\tself.controls.homeControl.showBtn();\n\t\t\t}else if(self.controls.homeControl){\n\t\t\t\tself.controls.homeControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.openInstamaps && self.controls.openInstamapsControl){\n\t\t\t\tself.controls.openInstamapsControl.showBtn();\n\t\t\t}else if(self.controls.openInstamapsControl){\n\t\t\t\tself.controls.openInstamapsControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.routing && self.controls.routingControl){\n\t\t\t\tself.controls.routingControl.showBtn();\n\t\t\t}else if(self.controls.routingControl){\n\t\t\t\tself.controls.routingControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.location && self.controls.locationControl){\n\t\t\t\tself.controls.locationControl.showBtn();\n\t\t\t}else if(self.controls.locationControl){\n\t\t\t\tself.controls.locationControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.share && self.controls.shareControl){\n\t\t\t\tself.controls.shareControl.showBtn();\n\t\t\t}else if(self.controls.shareControl){\n\t\t\t\tself.controls.shareControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.like && self.controls.likeControl){\n\t\t\t\tself.controls.likeControl.showBtn();\n\t\t\t}else if(self.controls.likeControl){\n\t\t\t\tself.controls.likeControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.search && self.controls.searchControl){\n\t\t\t\tself.controls.searchControl.showBtn();\n\t\t\t}else if(self.controls.searchControl){\n\t\t\t\tself.controls.searchControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.snapshot && self.controls.snapshotControl){\n\t\t\t\tself.controls.snapshotControl.showBtn();\n\t\t\t}else if(self.controls.snapshotControl){\n\t\t\t\tself.controls.snapshotControl.hideBtn();\n\t\t\t}\n\n\t\t\t/*\n\t\t\tif(options.print && self.controls.printControl){\n\t\t\t\tself.controls.printControl.showBtn();\n\t\t\t}else if(self.controls.printControl){\n\t\t\t\tself.controls.printControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.geopdf && self.controls.geopdfControl){\n\t\t\t\tself.controls.geopdfControl.showBtn();\n\t\t\t}else if(self.controls.geopdfControl){\n\t\t\t\tself.controls.geopdfControl.hideBtn();\n\t\t\t}\n\n\t\t\t*/\n\n\t\t\tif(options.c3d && self.controls.control3d){\n\t\t\t\tself.controls.control3d.showBtn();\n\t\t\t}else if(self.controls.control3d){\n\t\t\t\tself.controls.control3d.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.mousePosition && self.controls.mousePositionControl){\n\t\t\t\tself.controls.mousePositionControl.showBtn();\n\t\t\t}else if(self.controls.mousePositionControl){\n\t\t\t\tself.controls.mousePositionControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.scale && self.controls.scaleControl){\n\t\t\t\tself.controls.scaleControl.showBtn();\n\t\t\t}else if(self.controls.scaleControl){\n\t\t\t\tself.controls.scaleControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.fons && self.controls.fonsControl){\n\t\t\t\tself.controls.fonsControl.showBtn();\n\t\t\t}else if(self.controls.fonsControl){\n\t\t\t\tself.controls.fonsControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.legend && self.controls.llegendaControl){\n\t\t\t\tself.controls.llegendaControl.showBtn();\n\t\t\t}else if(self.controls.llegendaControl){\n\t\t\t\tself.controls.llegendaControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.layers && self.controls.layersControl){\n\t\t\t\tself.controls.layersControl.showBtn();\n\t\t\t}else if(self.controls.layersControl){\n\t\t\t\tself.controls.layersControl.hideBtn();\n\t\t\t}\n\n\t\t\tif(options.minimap && self.controls.minimapControl){\n\t\t\t\tself.controls.minimapControl.showBtn();\n\t\t\t}else if(self.controls.minimapControl){\n\t\t\t\tself.controls.minimapControl.hideBtn();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\n\t\thideControl: function(control){\n\t\t\tvar self = this;\n\t\t\tif(self.controls[control]){\n\t\t\t\tself.controls[control].hideBtn();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\n\t\tshowControl: function(control){\n\t\t\tvar self = this;\n\t\t\tif(self.controls[control]){\n\t\t\t\tself.controls[control].showBtn();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\n\t\tremoveCapes: function(){\n\t\t\tvar self = this;\n\t\t\t//var map = self.map;\n\t\t\t//map.removeControl(self.controlCapes);\n\t\t\t$('.bt_llista').hide();\n\t\t\treturn self;\n\t\t},\n\n\t\tdrawEmbed: function(){\n\t\t\tvar self = this;\n\t\t\t$('#navbar-visor').hide();\n\t\t\t$('#searchBar').css('top', '0');\n\n\t\t\t//Per defecte embed té el control de zoom, el botó d'obrir finestra Instamaps i el control de capes.\n\t\t\tself.addDefaultZoomControl = 1;\n\t\t\tself.openinstamaps = 1;\n\t\t\tself.layerscontrol = 1;\n\t\t\tself.ltoolbar=1;\n\t\t\tself.rtoolbar=1;\n\n\t\t\tif (!self.mouseposition) self.mouseposition = 0;\n\t\t\tif (!self.scalecontrol) self.scalecontrol = 0;\n\t\t\tif (!self.minimapcontrol) self.minimapcontrol = 0;\n\t\t\tif (!self.fonscontrol) self.fonscontrol = 0;\n\n\t\t\tif (!self.homecontrol) self.homecontrol = 0;\n\t\t\tif (!self.locationcontrol) self.locationcontrol = 0;\n\t\t\tif (!self.sharecontrol) self.sharecontrol = 0;\n\t\t\tif (!self.searchcontrol) self.searchcontrol = 0;\n\t\t\tif (!self.routingcontrol) self.routingcontrol = 0;\n\t\t\tif (!self.likecontrol) self.likecontrol = 0;\n\n\t\t\tif (!self.control3d) self.control3d = 0;\n\n\t\t\tif (!self.snapshotcontrol) self.snapshotcontrol = 0;\n\n\t\t\tif (!self.printcontrol) self.printcontrol = 0;\n\t\t\tif (!self.geopdfcontrol) self.geopdfcontrol = 0;\n\n\t\t\tif (!self.llegenda) self.llegenda = 0;\n\t\t\tif (!self.colorscalecontrol) self.colorscalecontrol = 0;\n\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'embed']});\n\t\t\treturn self;\n\t\t},\n\n\t\taddMousePositionControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_position,\n\t\t\t_map = self.map;\n\t\t\tctr_position = L.control.coordinates({\n\t  \t\t\tposition : 'bottomright',\n\t  \t\t\t'emptystring':' ',\n\t  \t\t\t'numDigits': 2,\n\t  \t\t\t'numDigits2': 6,\n\t  \t\t\t'prefix': 'ETRS89 UTM 31N',\n\t  \t\t\t'prefix2': 'WGS84',\n\t  \t\t\t'separator': ' ',\n\t  \t\t\t'showETRS89':true\n\t  \t\t}).addTo(_map);\n\n\t\t\tself.controls.mousePositionControl = ctr_position;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddScaleControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_scale,\n\t\t\t_map = self.map;\n\t\t\tctr_scale = L.control.escala({\n\t\t\t\tposition : 'bottomright',\n\t\t\t\t'metric':true,\n\t\t\t\t'imperial':false\n\t\t\t}).addTo(_map);\n\n\t\t\tself.controls.scaleControl = ctr_scale;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddMinimapControl: function(options){\n\t\t\tvar self = this,\n\t\t\t_minTopo,\n\t\t\tctr_minimap,\n\t\t\t_map = self.map,\n\t\t\t_options = {\n\t\t\t\ttoggleDisplay: true,\n\t\t\t\tautoToggleDisplay: false,\n\t\t\t\tminimized: true,\n\t\t\t\tmapOptions: {trackResize: false}\n\t\t\t};\n\n\t\t\t_options = $.extend(_options, options);\n\n\t\t\t_minTopo = new L.TileLayer(URL_MQ, {\n\t\t\t\tminZoom: 0,\n\t\t\t\tmaxZoom: 19,\n\t\t\t\tsubdomains:subDomains});\n\n\t\t\tctr_minimap = L.control.minimapa(_minTopo, _options).addTo(_map)._minimize();\n\n\t\t\tself.controls.minimapControl = ctr_minimap;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddFonsControl: function(){\n\n\t\t\tvar self = this,\n\t\t\tctr_fons,\n\t\t\t_map = self.map;\n\t\t\tctr_fons = new L.IM_controlFons({\n\t\t\t\ttitle: window.lang.translate('Escollir el mapa de fons'),\n\t\t\t}).addTo(_map);\n\n\t\t\tself.controls.fonsControl = ctr_fons;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddLayersControl: function(button){\n\t\t\tvar self = this,\n\t\t\tbtn_ctr_layers,\n\t\t\t_mapConfig = self._mapConfig,\n\t\t\t_map = self.map;\n\n\t\t\tbutton = (button !== undefined) ? button : true;\n\n\t\t\tbtn_ctr_layers = L.control.layersBtn({\n\t\t\t\tmapConfig: _mapConfig,\n\t\t\t\ttitle: window.lang.translate('Llista de capes'),\n\t\t\t\tbutton: button\n\t\t\t});\n\t\t\tbtn_ctr_layers.addTo(_map);\n\n\t\t\tself.controls.layersControl = btn_ctr_layers;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddOpenInstamapsControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_linkViewMap,\n\t\t\t_map = self.map;\n\n\t\t\tctr_linkViewMap = L.control.openInstamaps({\n\t\t\t\tbusinessid: self.businessid,\n\t\t\t\turlwms: self.urlwms,\n\t\t\t\tlayername: self.layername,\n\t\t\t\ttitle: window.lang.translate('Veure a InstaMaps'),\n\t\t\t\tfn: function(event) {\n\t\t\t\t\t$.publish('analyticsEvent',{event:['visor', 'button#veureInstamaps', 'label embed', 1]});\n\t\t\t\t}\n\t\t\t});\n\t\t\tctr_linkViewMap.addTo(_map);\n\n\t\t\tself.controls.openInstamapsControl = ctr_linkViewMap;\n\t\t},\n\n\t\taddHomeControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_vistaInicial,\n\t\t\t_mapConfig = self.mapConfig,\n\t\t\t_map = self.map;\n\n\t\t\tctr_vistaInicial = L.control.home({\n\t\t\t\tmapConfig: _mapConfig,\n\t\t\t\ttitle: window.lang.translate('Vista inicial')\n\t\t\t});\n\t\t\tctr_vistaInicial.addTo(_map);\n\n\t\t\tself.controls.homeControl = ctr_vistaInicial;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddLikeControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_like,\n\t\t\t_mapConfig = self.mapConfig,\n\t\t\t_map = self.map;\n\n\t\t\tctr_like = L.control.like({\n\t\t\t\tmapConfig: _mapConfig,\n\t\t\t\ttitle: window.lang.translate(\"M'agrada\")\n\t\t\t});\n\t\t\tctr_like.addTo(_map);\n\n\t\t\tself.controls.likeControl = ctr_like;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddShareControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_shareBT,\n\t\t\tv_url = window.location.href,\n\t\t\t_map = self.map;\n\n\t\t\tif(v_url.indexOf('localhost')!=-1){\n\t\t\t\tv_url = v_url.replace('localhost',DOMINI);\n\t\t\t}\n\t\t\tif (v_url.indexOf(\"mapacolaboratiu=si\")>-1) v_url=v_url.replace(\"&mapacolaboratiu=si\",\"\");\n\n\t\t\tshortUrl(v_url).then(function(results){\n\t\t\t\t$('#socialShare_visor').share({\n\t\t\t\t\tnetworks: ['email','facebook','googleplus','twitter','linkedin','pinterest'],\n\t\t\t\t\t//orientation: 'vertical',\n\t\t\t\t\t//affix: 'left center',\n\t\t\t\t\ttheme: 'square',\n\t\t\t\t\turlToShare: results.id\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t$('.share-square a').attr('target','_blank');\n\n\t\t\tctr_shareBT = L.control.share({\n\t\t\t\ttitle: window.lang.translate('Compartir')\n\t\t\t});\n\t\t\tctr_shareBT.addTo(_map);\n\n\t\t\tself.controls.shareControl = ctr_shareBT;\n\n\t\t},\n\n\t\taddRoutingControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_routingBT,\n\t\t\t_map = self.map;\n\n\t\t\tctr_routingBT = L.control.routingControl({\n\t\t\t\ttitle: window.lang.translate('Routing'),\n\t\t\t\tlang: web_determinaIdioma()\n\t\t\t});\n\n\t\t\tctr_routingBT.addTo(_map);\n\n\t\t\tself.controls.routingControl = ctr_routingBT;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddLocationControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_gps,\n\t\t\t_map = self.map;\n\n\t\t\t//TODO agregar las opciones por defecto al control\n\t\t\tctr_gps = L.control.locationControl({\n\t\t\t\tautoCenter: true,\t\t//move map when gps location change\n\t\t\t\tstyle: {\n\t\t\t\t\tradius: 6,\t\t//marker circle style\n\t\t\t\t\tweight:3,\n\t\t\t\t\tcolor: '#e03',\n\t\t\t\t\tfill: true,\n\t\t\t\t\tfillColor: '#e03',\n\t\t\t\t\topacity: 1,\n\t\t\t\t\tfillOpacity: 0.5},\n\t\t\t\ttitle: window.lang.translate('Centrar mapa a la seva ubicació'),\n\t\t\t\ttextErr: window.lang.translate('Error del GPS'),\t//error message on alert notification\n\t\t\t\tcallErr: null\t\t//function that run on gps error activating\n\t\t\t});\n\n\t\t\t_map.addControl(ctr_gps);\n\n\t\t\tself.controls.locationControl = ctr_gps;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddSearchControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_findBT,\n\t\t\t_map = self.map;\n\n\t\t\tctr_findBT = L.control.searchControl({\n\t\t\t\ttitle: window.lang.translate('Cercar'),\n\t\t\t\tsearchUrl: paramUrl.searchAction+\"searchInput={s}\",\n\t\t\t\tinputplaceholderText: window.lang.translate('Cercar llocs al món o coordenades  ...')\n\t\t\t});\n\t\t\t_map.addControl(ctr_findBT);\n\t\t\t//TODO generar el control del search\n\t\t\t//addControlCercaEdit();\n\n\t\t\tself.controls.searchControl = ctr_findBT;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddSnapshotControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_snapshot,\n\t\t\t_map = self.map;\n\n\t\t\tctr_snapshot = L.control.mapExport({\n\t\t\t\ttitle: window.lang.translate('Capturar la vista del mapa')\n\t\t\t});\n\t\t\tctr_snapshot.addTo(_map);\n\n\t\t\tself.controls.snapshotControl = ctr_snapshot;\n\n\t\t\treturn self;\n\t\t},\n\n\n\t\t/*\n\t\taddSnapshotControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_snapshot,\n\t\t\t_map = self.map;\n\n\t\t\tctr_snapshot = L.control.snapshot({\n\t\t\t\ttitle: window.lang.translate('Capturar la vista del mapa')\n\t\t\t});\n\t\t\tctr_snapshot.addTo(_map);\n\n\t\t\tself.controls.snapshotControl = ctr_snapshot;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddPrintControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_printmap,\n\t\t\t_map = self.map;\n\n\t\t\tctr_printmap = L.control.printmap({\n\t\t\t\ttitle: window.lang.translate('Imprimir la vista del mapa')\n\t\t\t});\n\t\t\tctr_printmap.addTo(_map);\n\n\t\t\tself.controls.printControl = ctr_printmap;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddGeopdfControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_geopdf,\n\t\t\t_map = self.map;\n\n\t\t\tctr_geopdf = L.control.geopdf({\n\t\t\t\ttitle: window.lang.translate('Descarrega mapa en format GeoPDF')\n\t\t\t});\n\t\t\tctr_geopdf.addTo(_map);\n\n\t\t\tself.controls.geopdfControl = ctr_geopdf;\n\n\t\t\treturn self;\n\t\t},\n\t\t*/\n\n\t\taddAppModul:function(modul){\n\t\t\tvar self = this,\n\t\t\tctr_arbres,\n\t\t\t_map = self.map;\n\t\t\tif(modul=='arbres'){\n\t\t\t\t$.getScript( \"/moduls/\" + modul + \"/js/modul_\"+modul+\"_1.0.0.js\", function( data, textStatus, jqxhr ) {\n\t\t\t\t\tif (jqxhr.status==200){\n\t\t\t\t\tctr_arbres=L.control.addmodulArbres(new L.geoJson()).addTo(_map);\n\t\t\t\t\tself.controls.arbresControl = ctr_arbres;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn self;\n\n\n\t\t},\n\n\t\taddLlegenda: function(){\n\t\t\tvar self = this,\n\t\t\tctr_legend,\n\t\t\t_map = self.map;\n\n\t\t\tctr_legend = L.control.legend({\n\t\t\t\ttitle: window.lang.translate('Llegenda'),\n\t\t\t\ttipusllegenda: self.tipusllegenda,  //\"dinamica\"\n\t\t\t\tllegendaOpt: self.llegendaOpt,\n\t\t\t\torigenllegenda:'visor'\n\t\t\t});\n\n\t\t\tctr_legend.addTo(_map);\n\n\t\t\tself.controls.llegendaControl = ctr_legend;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddControl3d: function(){\n\t\t\tvar self = this,\n\t\t\tctr_3d,\n\t\t\t_map = self.map;\n\n\t\t\tctr_3d = L.control.control3d({\n\t\t\t\ttitle: window.lang.translate('Canviar vista')\n\t\t\t});\n\t\t\tctr_3d.addTo(_map);\n\n\t\t\tself.controls.control3d = ctr_3d;\n\n\t\t\treturn self;\n\t\t},\n\n\t\taddControlLogos: function(){\n\t\t\tvar self = this,\n\t\t\tctr_logos,\n\t\t\t_map = self.map;\n\n\t\t\tctr_logos = L.control.logos();\n\t\t\tctr_logos.addTo(_map);\n\n\t\t\tself.controls.controlLogos = ctr_logos;\n\n\t\t\treturn self;\n\t\t},\n\n\t\tdrawMap: function(){\n\t\t\tvar self = this,\n\t\t\t_map = self.map;\n\t\t\tmap = self.map;\n\n\t\t\tself._listenEvents();\n\t\t\treturn self;\n\t\t},\n\n\t\tdrawControls: function(){\n\t\t\tvar self = this;\n\n\t\t\tself.addControlLogos();\n\n\t\t\tif((self.mouseposition && self.mouseposition==\"1\") || self.mouseposition===null){\n\t\t\t\tself.addMousePositionControl();\n\t\t\t}\n\t\t\tif((self.scalecontrol && self.scalecontrol==\"1\") || self.scalecontrol===null){\n\t\t\t\tself.addScaleControl();\n\t\t\t}\n\t\t\tif((self.minimapcontrol && self.minimapcontrol==\"1\") || self.minimapcontrol===null){\n\t\t\t\tself.addMinimapControl();\n\t\t\t}\n\n\t\t\tif((self.fonscontrol && self.fonscontrol==\"1\") || self.fonscontrol===null) {\n\t\t\t\tself.addFonsControl();\n\t\t\t}\n\n\t\t\tif((self.ltoolbar && self.ltoolbar==\"1\") || (self.ltoolbar===null)){\n\t\t\t\tif(self.embed){\n\t\t\t\t\tif((self.openinstamaps && self.openinstamaps==\"1\") || (self.openinstamaps===null)){\n\t\t\t\t\t\tself.addOpenInstamapsControl();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif((self.homecontrol && self.homecontrol==\"1\") || self.homecontrol===null){\n\t\t\t\t\tself.addHomeControl();\n\t\t\t\t}\n\t\t\t\tif((self.locationcontrol && self.locationcontrol==\"1\") || self.locationcontrol===null){\n\t\t\t\t\tself.addLocationControl();\n\t\t\t\t}\n\t\t\t\tif((self.searchcontrol && self.searchcontrol==\"1\") || self.searchcontrol===null){\n\t\t\t\t\tself.addSearchControl();\n\t\t\t\t}\n\t\t\t\tif((self.routingcontrol && self.routingcontrol==\"1\") || self.routingcontrol===null){\n\t\t\t\t\tself.addRoutingControl();\n\t\t\t\t}\n\t\t\t\tif((self.sharecontrol && self.sharecontrol==\"1\") || self.sharecontrol===null){\n\t\t\t\t\tself.addShareControl();\n\t\t\t\t}\n\t\t\t\tif((self.likecontrol && self.likecontrol==\"1\") || self.likecontrol===null){\n\t\t\t\t\tself.addLikeControl();\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif((self.rtoolbar && self.rtoolbar==\"1\") || (self.rtoolbar===null)){\n\t\t\t\tif((self.layerscontrol && self.layerscontrol==\"1\") || (self.layerscontrol===null)){\n\t\t\t\t\tself.addLayersControl();\n\t\t\t\t}else{\n\t\t\t\t\tself.addLayersControl(false);\n\t\t\t\t}\n\n\t\t\t\tif((self.control3d && self.control3d==\"1\") || self.control3d===null) {\n\t\t\t\t\tself.addControl3d();\n\t\t\t\t}\n\n\n\n\t\t\t\tif((self.snapshotcontrol && self.snapshotcontrol==\"1\") || self.snapshotcontrol===null){\n\n\n\t\t\t\t\tself.addSnapshotControl();\n\t\t\t\t}else if((self.printcontrol && self.printcontrol==\"1\") || self.printcontrol===null){\n\n\n\t\t\t\t//\tself.addSnapshotControl();\n\t\t\t\t}\n\t\t\t\telse if ((self.geopdfcontrol && self.geopdfcontrol==\"1\") || self.geopdfcontrol===null){\n\n\n\t\t\t\t//\tself.addSnapshotControl();\n\t\t\t\t}\n\n\n\n\t\t\t}else{\n\t\t\t\tself.addLayersControl(false);\n\t\t\t}\n\t\t\tif((self.llegenda && self.llegenda==\"1\") || self.llegenda===null){\n\t\t\t\tvar hasLayers = false;\n\t\t\t\tif(self._mapConfig.hasOwnProperty(\"legend\"))\n\t\t\t\t{\n\n\t\t\t\t\tvar leg = JSON.parse(self._mapConfig.legend);\n\t\t\t\t\tvar keys = Object.keys(leg);\n\t\t\t\t\tfor(var i=0; i<keys.length; ++i) {\n\t\t\t\t\t\tfor  (var j=0;j<leg[keys[i]].length;j++){\n\t\t\t\t\t\t\tif (hasLayers || leg[keys[i]][j].chck) {\n\t\t\t\t\t\t\t\thasLayers=hasLayers || leg[keys[i]][j].chck;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!self.nollegenda && hasLayers) {\n\t\t\t\t\t\tself.addLlegenda();\n\t\t\t\t\t\tif (self.llegendaOpt==false){\n\t\t\t\t\t\t\tself.controls.llegendaControl.button.show();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(self.appmodul){\n\t\t\t\tself.addAppModul(self.appmodul);\n\n\t\t\t}\n\n\t\t\treturn self;\n\t\t},\n\n\t\tloadErrorPage: function(){\n\t\t\t//TODO redirect a la pagina de error 404\n\t\t\tconsole.debug(\"error\");\n\t\t\t//window.location.href = paramUrl.galeriaPage;\n\t\t},\n\n\t\tloadLoginPage: function(){\n\t\t\twindow.location.href = paramUrl.loginPage;\n\t\t},\n\n\t\t//hace el redirect para que el invitado al colaborativo pueda ver que puede editar el mapa\n\t\tloadMapaColaboratiuPage: function(){\n\t\t\tvar self = this,\n\t\t\t_businessid = self.businessid;\n\t\t\twindow.location = paramUrl.mapaPage+\"?businessid=\"+_businessid+\"&mapacolaboratiu=si\";\n\t\t},\n\n\t\t_loadPasswordModal: function(){\n\t\t\tvar self = this,\n\t\t\t_businessid = self.businessid;\n\n\t\t\t$('#dialog_password').modal('show');\n\n\t\t\t$('#dialog_password .btn-primary').on('click',function(){\n\t\t\t\tvar clau = $.trim($('#inputPassword').val());\n\t\t\t\tif(clau == \"\"){\n\t\t\t\t\t$('#password_msg').removeClass('hide');\n\t\t\t\t}else{\n\t\t\t\t\t$('#password_msg').addClass('hide');\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\tclauVisor: clau,\n\t\t\t\t\t\tbusinessId: _businessid\n\t\t\t\t\t};\n\t\t\t\t\tloadPrivateMapByBusinessId(data).then(function(results){\n\t\t\t\t\t\tif(results.status == \"ERROR\"){\n\t\t\t\t\t\t\t$('#password_msg').removeClass('hide');\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tself._beforeLoadConfig(results);\n\t\t\t\t\t\t\t$('#password_msg').addClass('hide');\n\t\t\t\t\t\t\t$('#dialog_password').modal('hide');\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_colaboratiuToLogin: function(){\n\t\t\tvar self = this,\n\t\t\t_uid = self.uid;\n\t\t\t_businessid=self.businessid;\n\t\t\tCookies.remove('uid');\n\t\t\tCookies.set('collaboratebid', _businessid);\n\t\t\tCookies.set('collaborateuid', _uid);\n\t\t\tself.loadLoginPage();\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_beforeLoadConfig: function(results){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_uid = self.uid,\n\t\t\t_businessid = self.businessid,\n\t\t\t_mapacolaboratiu = self.mapacolaboratiu;\n\n\t\t\tif ( _mapacolaboratiu  &&  _mapacolaboratiu==\"alta\" && !Cookies.get('uid')) {\n\t\t\t\tself._colaboratiuToLogin();\n\t\t\t}\n\t\t\telse if (_mapacolaboratiu &&  _mapacolaboratiu==\"alta\" && _uid!=Cookies.get('uid')) {\n\t\t\t\tself._colaboratiuToLogin();\n\t\t\t}\n\t\t\telse if (url('?mapacolaboratiu') &&  url('?mapacolaboratiu')==\"alta\" && _uid==Cookies.get('uid')) {\n\t\t\t\tself.loadMapaColaboratiuPage();\n\t\t\t}\n\t\t\tvar _mapConfig;\n\t\t\tif (undefined != results.results) _mapConfig= $.parseJSON(results.results);\n\t\t\telse _mapConfig=results;\n\t\t\tif(_mapConfig.options){\n\t\t\t\t_mapConfig.options = $.parseJSON(_mapConfig.options);\n\t\t\t\tif(_mapConfig.options.llegenda === false){\n\t\t\t\t\tself.nollegenda = \"1\"; //ocultar la llegenda\n\t\t\t\t\tself.llegenda = 0;\n\t\t\t\t}\n\t\t\t\tself.tipusllegenda=_mapConfig.options.tipusllegenda;\n\t\t\t\tself.llegendaOpt=_mapConfig.options.llegendaOpt;\n\t\t\t}\n\t\t\tself._mapConfig = _mapConfig;\n\n\t\t\tself._configControls();\n\n\t\t\t_map.fire('loadconfig', _mapConfig);\n\t\t\t$.publish('loadConfig', _mapConfig);\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_configControls: function(){\n\t\t\tvar self = this,\n\t\t\tmapConfigOptions = self._mapConfig.options;\n\n\t\t\tif(mapConfigOptions.params){\n\t\t\t\tvar params = mapConfigOptions.params;\n\t\t\t\tif(self.embed && (!$.isEmptyObject(params.iframe))){\n\t\t\t\t\tvar piframe = params.iframe;\n\t\t\t\t\t$.each(piframe, function(key, value){\n\t\t\t\t\t\tif(self[key] == 0 || self[key] == 1){\n\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tself[key] = value;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}else if(!$.isEmptyObject(params.visor)){\n\t\t\t\t\tvar pvisor = params.visor;\n\t\t\t\t\t$.each(pvisor, function(key, value){\n\t\t\t\t\t\tif(self[key] == 0 || self[key] == 1){\n\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tself[key] = value;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn self;\n\t\t},\n\n\t\tfireLoadConfig: function(){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_mapConfig = self._mapConfig;\n\n\t\t\t_map.fire('visorconfig', _mapConfig);\n\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_loadCacheMap: function(_businessid,_uid,_mapacolaboratiu){\n\t\t\tvar self=this;\n\t\t\tif (_uid==null){\n\t\t\t\tif (undefined != url('?id')){ \n\t\t\t\t\t_uid=url('?id');\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t_uid = url(-3);\n\t\t\t\t}\n\t\t\t}\n\t\t\t//console.debug(HOST_APP+'capesuser/'+_uid+'/'+_businessid+'.json');\n\t\t\t$.get(HOST_APP+'capesuser/'+_uid+'/'+_businessid+'.json', function(results) { \n\t\t\t\tif(results){\t\n\t\t\t\t\tif (results.clau){\n\t\t\t\t\t\t//ocultar las pelotas\n\t\t\t\t\t\tself._hideLoading();\n\t\t\t\t\t\t//mostar modal con contraseña\n\t\t\t\t\t\tself._loadPasswordModal();\n\t\t\t\t\t}\n\t\t\t\t\telse self._beforeLoadConfig(results);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\t\tbusinessId: _businessid,\n\t\t\t\t\t\t\tid: _uid,\n\t\t\t\t\t\t\tmapacolaboratiu: _mapacolaboratiu,\n\t\t\t\t\t\t\tuid: _uid\t\n\t\t\t\t\t\t};\n\t\t\t\t\tgetCacheMapByBusinessId(data).then(function(results){\n\t\t\t\t\t\tif (results.status == \"ERROR\"){\n\t\t\t\t\t\t\tself.loadErrorPage();\n\t\t\t\t\t\t}else if (results.status == \"PRIVAT\"){\n\t\t\t\t\t\t\t//ocultar las pelotas\n\t\t\t\t\t\t\tself._hideLoading();\n\t\t\t\t\t\t\t//mostar modal con contraseña\n\t\t\t\t\t\t\tself._loadPasswordModal();\n\t\t\t\t\t\t}else{\n\t\t\t\n\t\t\t\t\t\t\tself._beforeLoadConfig(results);\n\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}).fail(function() {\n\t\t\t\tvar data = {\n\t\t\t\t\t\tbusinessId: _businessid,\n\t\t\t\t\t\tid: _uid,\n\t\t\t\t\t\tmapacolaboratiu: _mapacolaboratiu,\n\t\t\t\t\t\tuid: _uid\t\n\t\t\t\t\t};\n\t\t\t\tgetCacheMapByBusinessId(data).then(function(results){\n\t\t\t\t\tif (results.status == \"ERROR\"){\n\t\t\t\t\t\tself.loadErrorPage();\n\t\t\t\t\t}else if (results.status == \"PRIVAT\"){\n\t\t\t\t\t\t//ocultar las pelotas\n\t\t\t\t\t\tself._hideLoading();\n\t\t\t\t\t\t//mostar modal con contraseña\n\t\t\t\t\t\tself._loadPasswordModal();\n\t\t\t\t\t}else{\n\t\t\n\t\t\t\t\t\tself._beforeLoadConfig(results);\n\t\t\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t},\n\t\t\n\t\tloadMapConfig: function(){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_uid = self.uid,\n\t\t\t_businessid = self.businessid,\n\t\t\t_mapacolaboratiu = self.mapacolaboratiu;\n\t\t\t\t\t\t\n\t\t\tself._loadCacheMap(_businessid,_uid,_mapacolaboratiu);\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\n\t\tloadURLConfig: function() {\n\n\t\t\tvar self = this;\n\n\t\t\tself.mouseposition = self.mouseposition || false;\n\t\t\tself.scalecontrol = self.scalecontrol || false;\n\t\t\tself.minimapcontrol = self.minimapcontrol || false;\n\t\t\tself.fonscontrol = self.fonscontrol || false;\n\t\t\tself.homecontrol = self.homecontrol || false;\n\t\t\tself.locationcontrol = self.locationcontrol || false;\n\t\t\tself.searchcontrol = self.searchcontrol || false;\n\t\t\tself.routingcontrol = self.routingcontrol || false;\n\t\t\tself.sharecontrol = self.sharecontrol || false;\n\t\t\tself.likecontrol = self.likecontrol || false;\n\t\t\tself.layerscontrol = self.layerscontrol || false;\n\t\t\tself.control3d = self.control3d || false;\n\n\t\t\tself.snapshotcontrol = self.snapshotcontrol || false;\n\n\t\t\tself.printcontrol = self.printcontrol || false;\n\t\t\tself.geopdfcontrol = self.geopdfcontrol || false;\n\n\t\t\tself.rtoolbar = self.rtoolbar || false;\n\t\t\tself.llegenda = self.llegenda || false;\n\t\t\tself.appmodul = self.appmodul || false;\n\t\t\tself.zoomcontrol = self.zoomcontrol || false;\n\t\t\tself.fons = self.fons || \"hibridMap\";\n\n\t\t\tvar hash = location.hash;\n\t\t\thashControl = new L.Hash(self.map);\n\t\t\tvar parsed = hashControl.parseHash(hash);\n\t\t\tself._mapConfig = {\n\t\t\t\ttipusAplicacioId : TIPUS_APLIACIO_INSTAMAPS,\n\t\t\t\tnomAplicacio : (self.appname ? self.appname : \"\"),\n\t\t\t\tentitatUid : \"@\",\n\t\t\t\tnomEntitat : \"\",\n\t\t\t\tservidorsWMS : [],\n\t\t\t\toptions : {\n\t\t\t\t\tcenter : (parsed ? parsed.center.lat + \",\" + parsed.center.lng : \"41.431,1.8580\"),\n\t\t\t\t\tzoom : (parsed ? parsed.zoom : 8),\n\t\t\t\t\tdescription : \"\",\n\t\t\t\t\tfons : self.fons\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif(!self.zoomcontrol){\n\t\t\t\tself.map.removeControl(self.map.zoomControl);\n\t\t\t}\n\n\t\t\treturn self;\n\t\t},\n\n\t\tloadApp: function(){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_mapConfig = self._mapConfig;\n\n\t\t\tself._loadPublicMap(_mapConfig);\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_mapNameShortener: function(inName) {\n\t\t\tname = \"<div id='mapNameContainer'><span title=\\\"\" + inName + \"\\\">\" + inName + \"</span></div>\";\n\t\t\treturn name;\n\t\t},\n\n\t\t_loadPublicMap: function(_mapConfig){\n\t\t\tvar self = this,\n\t\t\t\tnomUser = _mapConfig.entitatUid.split(\"@\"),\n\t\t\t\tnomEntitat = _mapConfig.nomEntitat,\n\t\t\t\tinfoHtml = '';\n\n\t\t\tvar nomAp = _mapConfig.nomAplicacio;\n\t\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) {\n\t\t\t\t$('meta[property=\"og:title\"]').attr('content', \"Mapa \"+nomAp.replaceAll(\"'\",\"\\'\"));\n\t\t\t}\n\t\t\tif ($(location).attr('href').indexOf('/visor_onsoc.html') != -1) {\n\t\t\t\tdocument.title=url('?title');\n\t\t\t}\n\t\t\tCookies.set('perfil', 'instamaps');\n\t\t\tcheckUserLogin();\n\n\t\t\tinfoHtml += '<p>'+nomUser[0]+'</p>';\n\n\t\t\tif (_mapConfig.options){\n\t\t\t\tvar desc=_mapConfig.options.description;\n\n\t\t\t\tdesc==\"\"?desc=_mapConfig.nomAplicacio:desc=desc;\n\n\t\t\t\tif (desc!=undefined)  desc = desc.replaceAll(\"'\",\"\\'\");\n\t\t\t\tif ($(location).attr('href').indexOf('/visor.html') != -1) {\n\t\t\t\t\t$('meta[name=\"description\"]').attr('content', desc+' - Fet amb InstaMaps.cat');\n\t\t\t\t\t$('meta[property=\"og:description\"]').attr('content', desc+' - Fet amb InstaMaps.cat');\n\n\t\t\t\t\tvar urlThumbnail = GEOCAT02 + paramUrl.urlgetMapImage+ \"&request=getGaleria&update=false&businessid=\" + url('?businessid');\n\t\t\t\t\t$('meta[property=\"og:image\"]').attr('content', urlThumbnail);\n\t\t\t\t\tvar urlMap = HOST_APP+paramUrl.visorPage+\"?businessid=\"+_mapConfig.businessId;\n\t\t\t\t\tvar nomApp=_mapConfig.nomAplicacio;\n\t\t\t\t\tif (undefined!=nomApp){\n\t\t\t\t\t\tvar nomIndexacio=nomApp;\n\t\t\t        \t(nomIndexacio.length > 100)?nomIndexacio=nomIndexacio.substring(0,100):nomIndexacio;\n\t\t\t        \tnomIndexacio= encodeURI(nomIndexacio);\n\t\t\t\t\t\turlMap += \"&title=\"+nomIndexacio;\n\t\t\t\t\t}\n\t\t\t\t\tvar generatedScript=\"<script type=\\\"application/ld+json\\\">\"+\n\t\t\t\t\tgenerarScriptMarkupGoogle(urlMap,nomAp,urlThumbnail,_mapConfig.entitatUid,_mapConfig.dataPublicacio,desc)+\n\t\t\t\t\t\"</script>\";\n\t\t\t\t\t$('head').append(generatedScript);\n\t\t\t\t}\n\t\t\t\tif (_mapConfig.options.description!=undefined) infoHtml += '<p>'+_mapConfig.options.description+'</p>';\n\t\t\t\tif (_mapConfig.options.tags!=undefined) infoHtml += '<p>'+_mapConfig.options.tags+'</p>';\n\n\t\t\t\t$('.escut').hide();\n\t\t\t}\n\t\t\t$(\"#mapTitle\").html(self._mapNameShortener(_mapConfig.nomAplicacio) + '<span id=\"infoMap\" lang=\"ca\" class=\"glyphicon glyphicon-info-sign pop\" data-toggle=\"popover\" title=\"Informació\" data-lang-title=\"Informació\" ></span>');\n\n\t\t\t$('#infoMap').popover({\n\t\t\t\tplacement : 'bottom',\n\t\t\t\thtml: true,\n\t\t\t\tcontent: infoHtml\n\t\t\t});\n\n\t\t\t$('#infoMap').on('show.bs.popover', function () {\n\t\t\t\t$(this).attr('data-original-title', window.lang.translate($(this).data('lang-title')));\n\t\t\t});\n\n\t\t\t//TODO quitar la global ya que se usa en el control de capas.\n\t\t\tdownloadableData = (_mapConfig.options && _mapConfig.options.downloadable?\n\t\t\t\t\t_mapConfig.options.downloadable:[]);\n\n\t\t\t_mapConfig.newMap = false;\n\t\t\t$('#nomAplicacio').html(_mapConfig.nomAplicacio);\n\n\t\t\tself._loadMapConfig(_mapConfig).then(function(){\n\n\t\t\t});\n\t\t},\n\n\t\t_loadMapConfig: function(_mapConfig){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_layers = self.instamapsLayers,\n\t\t\tdfd = $.Deferred();\n\n\t\t\tif (!$.isEmptyObject( _mapConfig )){\n\n\t\t\t\t$('#businessId').val(_mapConfig.businessId);\n\t\t\t\t//TODO ver los errores de leaflet al cambiar el mapa de fondo\n\t\t\t\t//cambiar el mapa de fondo a orto y gris\n\t\t\t\tif (_mapConfig.options != null){\n\t\t\t\t\tif(_mapConfig.options.hasOwnProperty(\"fons\"))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar fons = _mapConfig.options.fons;\n\t\t\t\t\t\tif (fons == 'topoMap'){\n\t\t\t\t\t\t\t_map.topoMap();\n\t\t\t\t\t\t}else if (fons == 'topoMapGeo') {\n\t\t\t\t\t\t\t_map.topoMapGeo();\n\t\t\t\t\t\t}else if (fons == 'ortoMap') {\n\t\t\t\t\t\t\t_map.ortoMap();\n\t\t\t\t\t\t}else if (fons == 'terrainMap') {\n\t\t\t\t\t\t\t_map.terrainMap();\n\t\t\t\t\t\t}else if (fons == 'topoGrisMap') {\n\t\t\t\t\t\t\t_map.topoGrisMap();\n\t\t\t\t\t\t}else if (fons == 'historicOrtoMap') {\n\t\t\t\t\t\t\t_map.historicOrtoMap();\n\t\t\t\t\t\t}else if (fons == 'historicMap') {\n\t\t\t\t\t\t\t_map.historicMap();\n\t\t\t\t\t\t}else if (fons == 'hibridMap'){\n\t\t\t\t\t\t\t_map.hibridMap();\n\t\t\t\t\t\t}else if (fons == 'historicOrtoMap46'){\n\t\t\t\t\t\t\t_map.historicOrtoMap46();\n\t\t\t\t\t\t}else if (fons == 'alcadaMap'){\n\t\t\t\t\t\t\t_map.alcadaMap();\n\t\t\t\t\t\t}else if (fons == 'colorMap') {\n\t\t\t\t\t\t\t_map.colorMap(_mapConfig.options.fonsColor);\n\t\t\t\t\t\t}else if (fons == 'naturalMap') {\n\t\t\t\t\t\t\t_map.naturalMap();\n\t\t\t\t\t\t}else if (fons == 'divadminMap') {\n\t\t\t\t\t\t\t_map.divadminMap();\n\t\t\t\t\t\t}else if (fons == 'hibridTerrainMap') {\n\t\t\t\t\t\t\t_map.hibridTerrainMap();\n\t\t\t\t\t\t}else if (fons.indexOf('colorBlankMap')!=-1) {\n\t\t\t\t\t\t\t_map.colorBlankMap(fons);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t_map.setActiveMap(_mapConfig.options.fons);\n\t\t\t\t\t\t_map.setMapColor(_mapConfig.options.fonsColor);\n\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//carga las capas en el mapa\n\t\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\n\t\t\t\t_UsrID = _mapConfig.entitatUid;\n\t\t\t\t_layers._loadAllLayers(_mapConfig, controlCapes).then(function(){\n\t\t\t\t\tself._updateLayerControl();\n\t\t\t\t});\n\n\t\t\t\tself._hideLoading();\n\t\t\t}\n\t\t\tdfd.resolve();\n\t\t\treturn dfd.promise();\n\t\t},\n\n\t\t_addDownloadLayer: function(){\n\t\t\tvar self = this;\n\t\t\taddFuncioDownloadLayer('visor');\n\t\t\treturn self;\n\t\t},\n\n\t\t_addDataTable: function(){\n\t\t\tvar self = this;\n\t\t\taddFuncioEditDataTable();\n\t\t\treturn self;\n\t\t},\n\n\t\t_drawVisor: function(){\n\t\t\tvar self = this,\n\t\t\tmap = self.map,\n\t\t\t_mapConfig = self._mapConfig;\n\n\t\t\tif(self.embed){\n\t\t\t\tself.drawEmbed();\n\t\t\t}\n\n\t\t\tif(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_INSTAMAPS){\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\n\n\t\t\t\tif(self.embed){\n\t\t\t\t\tself.addLogoInstamap();\n\t\t\t\t}\n\t\t\t\t$(\".leaflet-control-draw-measure\").hide();\t//Eliminem el control de mesura si no és geolocal/AOC\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'visor_instamaps', _mapConfig.entitatUid, 1]});\n\t\t\t}else if(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_GEOLOCAL){\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()\n\t\t\t\t._drawVisorGeolocal()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\n\t\t\t\taddDrawTooltips();\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','visor_entitat', _mapConfig.nomEntitat, 1]});\n\n\t\t\t}else if(_mapConfig.tipusAplicacioId == TIPUS_APLIACIO_AOC){\n\t\t\t\tself._initCenter().drawMap().resizeMap().drawControls().fireLoadConfig().loadApp()\n\t\t\t\t._drawVisorGeolocal()._addTooltips()._addDownloadLayer()._addDataTable()._hideLoading();\n\t\t\t\taddDrawTooltips();\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','visor_entitat', _mapConfig.nomEntitat, 1]});\n\n\t\t\t}else{\n\n\t\t\talert(\"No hi ha tipus definit\");\n\n\t\t\t}\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_drawVisorGeolocal: function(){\n\t\t\tvar self = this;\n\n\t\t\tvar visorGeolocal = VisorGeolocal({visor:self}).draw();\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_drawVisorSimple: function(){\n\t\t\tvar self = this;\n\n\t\t\tvar visorSimple = VisorSimple({visor:self}).draw();\n\n\t\t\t$.publish('trackPageview', null);\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_initCenter: function(){\n\t\t\tvar self = this,\n\t\t\t_map = self.map,\n\t\t\t_mapConfig = self._mapConfig;\n\n\t\t\tvar ineFound = false;\n\t\t\tif(self.INE10)\n\t\t\t{\n\n\t\t\t\tvar municipis = ListViewMunicipis.municipis;\n\t\t\t\tfor(var i=0; i<municipis.length && !ineFound; ++i)\n\t\t\t\t{\n\n\t\t\t\t\tineFound = (municipis[i].municipiCodi == self.INE10);\n\t\t\t\t\tif(ineFound)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tvar data = municipis[i];\n\t\t\t\t\t\tvar bbox = data.bbox.split(\",\");\n\t\t\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]),\n\t\t\t\t\t\tnorthEast = L.latLng(bbox[3], bbox[2]),\n\t\t\t\t\t\tbounds = L.latLngBounds(southWest, northEast);\n\t\t\t\t\t\t_map.fitBounds(bounds)\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif(!ineFound)\n\t\t\t{\n\n\t\t\t\tvar hash = location.hash;\n\t\t\t\thashControl = new L.Hash(_map);\n\t\t\t\tvar parsed = hashControl.parseHash(hash);\n\n\t\t\t\tif(\"\" == hash && _mapConfig.options){\n\t\t\t\t\tif (_mapConfig.options.center){\n\t\t\t\t\t\tvar opcenter = _mapConfig.options.center.split(\",\");\n\t\t\t\t\t\t_map.setView(L.latLng(opcenter[0], opcenter[1]), _mapConfig.options.zoom);\n\t\t\t\t\t}else if (_mapConfig.options.bbox){\n\t\t\t\t\t\tvar bbox = _mapConfig.options.bbox.split(\",\");\n\t\t\t\t\t\tvar southWest = L.latLng(bbox[1], bbox[0]);\n\t\t\t\t\t    var northEast = L.latLng(bbox[3], bbox[2]);\n\t\t\t\t\t    var bounds = L.latLngBounds(southWest, northEast);\n\n\t\t\t\t\t    _map.fitBounds( bounds );\n\t\t\t\t\t}\n\t\t\t\t}else if (parsed){\n\n\t\t\t\t\thashControl.update();\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn self;\n\t\t},\n\n\t\tdraw: function(){\n\t\t\tvar self = this,\n\t\t\t   \t_map = self.map;\n\n\t\t\tchangeInitVisor();\n\n\t\t\t$(window).resize(_.debounce(function(){\n\t\t\t\tself.resizeMap();\n\t\t\t},150));\n\n\t\t\tif(self.businessid){\n\t\t\t\tself.loadMapConfig();\n\t\t\t\t_map.on('loadconfig', self._drawVisor, self);\n\t\t\t}else{\n\t\t\t\tif(self.urlwms){ //cloudifier\n\t\t\t\t\tif(self.embed){\n\t\t\t\t\t\tself.drawEmbed();\n\t\t\t\t\t}\n\t\t\t\t\tself.drawMap().resizeMap().drawControls()._drawVisorSimple()._hideLoading();\n\t\t\t\t}\n\t\t\t\telse if(self.text) {\t//map defined by url params\n\t\t\t\t\tself.loadURLConfig()._initCenter()._drawVisor()._addURLMarker();\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tself.loadErrorPage();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(!self.embed){\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'no embed']});\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\n\t\t_addURLMarker: function() {\n\t\t\tvar self = this;\n\t\t\tvar opcenter = self._mapConfig.options.center.split(\",\");\n\t\t\tvar defaultPunt = L.AwesomeMarkers.icon(default_onsoc_style);\n\t\t\tvar marker = L.marker(new L.LatLng(opcenter[0], opcenter[1]), {icon: defaultPunt,\n\t\t\t\t\t tipus: t_marker}).addTo(self.map);\n\n\t\t\tif(self.text)\n\t\t\t{\n\n\t\t\t\tvar html = '';\n\t\t\t\tvar hasValidLink = ((null != self.link) && (\"\" != self.link.trim()) && isValidURL(self.link));\n\n\t\t\t\tif(hasValidLink)\n\t\t\t\t{\n\n\t\t\t\t\tvar hasProtocol = (-1 != self.link.indexOf(\"://\"));\n\t\t\t\t\tif(!hasProtocol)\n\t\t\t\t\t\thtml += \"<a href=\\\"http://\" + self.link + \"\\\" target=\\\"_blank\\\">\";\n\t\t\t\t\telse\n\t\t\t\t\t\thtml += \"<a href=\\\"\" + self.link + \"\\\" target=\\\"_blank\\\">\";\n\n\t\t\t\t\thtml += self.text;\n\t\t\t\t\thtml += \"</a>\";\n\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\n\t\t\t\t\thtml += parseUrlTextPopUp(self.text, \"\");\n\n\t\t\t\t}\n\n\t\t\t\tmarker.bindPopup(html);\n\t\t\t\tmarker.openPopup();\n\t\t\t\t$.publish('analyticsEvent',{event:[ 'visor','parametres']});\n\n\t\t\t}\n\n\t\t\t$(\"#infoMap\").hide();\n\n\t\t},\n\n\t\t_addTooltips: function(){\n\t\t\tvar self = this;\n\t\t\t$('[data-toggle=\"tooltip\"]').tooltip({container: 'body'});\n\t\t\treturn self;\n\t\t},\n\n\t\t_updateLang: function(e, data){\n\t\t\tvar self = this;\n\t\t\t//TODO esto deberia ir en cada control que es responsable de toda su funcionalidad\n\t\t\tjQuery('body').on('show.bs.tooltip','[data-toggle=\"tooltip\"]',function(){\n\t\t\t\tjQuery(this).attr('data-original-title', window.lang.translate(jQuery(this).data('lang-title')));\n\t\t\t});\n\t\t\t//Add tooltip caixa cerca\n\t\t\tjQuery(\".leaflet-control-search .search-button, .glyphicon-search\").attr('title',window.lang.translate('Cercar llocs o coordenades ...'));\n\t\t\tjQuery(\".leaflet-control-search .search-input\").attr('placeholder',window.lang.translate('Cercar llocs o coordenades ...'));\n\n\t\t\treturn self;\n\t\t},\n\n\t\t_updateLayerControl: function(e, data){\n\t\t\tvar self = this;\n\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\n\t\t\tif(controlCapes){\n\t\t\t\tcontrolCapes.forceUpdate();\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\n\t\t_showRoutingEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#routing', 'label routing', 1]});\n\t\t},\n\n\t\t_mapsnapshotEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#export_mapa', 'label export maps', 1]});\n\t\t},\n\n\n\t\t/*\n\t\t_mapprintEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', this.tipusUser+'print', 'label print', 1]});\n\t\t},\n\n\t\t_mapgeopdfEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', this.tipusUser+'geopdf', 'label geopdf', 1]});\n\t\t},\n\t\t*/\n\t\t_map3dmodeEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'button#3D', 'label 3D', 1]});\n\t\t},\n\n\t\t_hideLoading: function(){\n\t\t\t$('#div_loading').hide();\n\t\t\treturn this;\n\t\t},\n\n\t\t_listenEvents: function(){\n\t\t\tvar self = this,\n\t\t\t\t_map = self.map;\n\t\t\tif(_map){\n\t\t\t\t_map.on('showRouting', self._showRoutingEvent, self);\n\t\t\t\t_map.on('mapsnapshot', self._mapsnapshotEvent, self);\n\t\t\t\t_map.on('mapprint', self._mapprintEvent, self);\n\t\t\t\t_map.on('mapgeopdf', self._mapgeopdfEvent, self);\n\t\t\t\t_map.on('map3dmode', self._map3dmodeEvent, self);\n\t\t\t\t_map.on('zoomend',self._gestionaEtiquetes, self);\n\t\t\t}\n\t\t\t$.subscribe('change-lang',self._updateLang);\n\t\t},\n\t\t_gestionaEtiquetes: function(){\n\t\t\tvar self=this;\n\t\t\tvar controlCapes = (self.controls.layersControl) ? self.controls.layersControl.control : null;\n\t\t\tjQuery.each(controlCapes._layers, function(i, obj){\n\t\t\t\t if (obj.layer.options.opcionsVisEtiqueta!=undefined && (obj.layer.options.opcionsVisEtiqueta==\"nomesetiqueta\" ||\n\t\t\t\t\t\t\tobj.layer.options.opcionsVisEtiqueta==\"etiquetageom\")){\n\t\t\t\t\t \t\tvar zoomInicial = \"2\";\n\t\t\t\t\t \t\tif (obj.layer.options.zoomInicial) zoomInicial=obj.layer.options.zoomInicial;\n\t\t\t\t\t \t\tvar zoomFinal = \"19\";\n\t\t\t\t\t \t\tif (obj.layer.options.zoomFinal) zoomFinal = obj.layer.options.zoomFinal;\n\n\t\t\t\t\t \t\tif ( map.getZoom()>=zoomInicial &&  map.getZoom() <= zoomFinal) {//mostrem labels\n\t\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\n\t\t\t\t\t\t\t\t\tif (lay.label!=undefined) {\n\t\t\t\t\t\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(1);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif(lay._showLabel){\n\t\t\t\t\t                        lay._showLabel({latlng: lay.label._latlng});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t \t\t }\n\t\t\t\t\t \t\t else {//amaguem labels\n\t\t\t\t\t\t\t\tjQuery.each(obj.layer._layers, function(i, lay){\n\t\t\t\t\t\t\t\t\tif(lay.label){\n\t\t\t\t\t\t\t\t\t\tlay.label.setOpacity(0);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t }\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t};\n\n\tVisor.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, visorOptions, options);\n\t\tself.instamapsLayers = InstamapsLayers(visorOptions);\n\t}\n\n\tVisor.init.prototype = Visor.prototype;\n\n\tglobal.Visor = Visor;\n\n}(window, jQuery));\n","/**\n * require geocat.web-1.0.0\n * require url https://github.com/websanova/js-url\n * require geocat.google-analytics.js\n * requier geocat.utils\n */\nvar visorOptions = {\n\tuid: url('?uid') || null,\n\turlwms: url('?urlwms') || null,\n\tlayername: url('?layername') || null,\n\ttype: url('?type') || null,\n\turl: url('?url') || null,\n\tq: url('?q') || null,\n\tbusinessid: url('?businessid') || null,\n\tmapacolaboratiu: url('?mapacolaboratiu') || null,\n\tembed: url('?embed') || null,\n\tllegenda: url('?llegenda') || null,\n\tmouseposition: url('?mouseposition') || null,\n\tlayerscontrol: url('?layerscontrol') || null,\n\tprintcontrol: url('?printcontrol') || null,\n\tminimapcontrol: url('?minimapcontrol') || null,\n\tsnapshotcontrol: url('?snapshotcontrol') || null,\n\tgeopdfcontrol: url('?geopdfcontrol') || null,\n\twidgetscontrol: url('?widgetscontrol') || null,\n\tfonscontrol: url('?fonscontrol') || null,\n\tsharecontrol: url('?sharecontrol') || null,\n\tlikecontrol: url('?likecontrol') || null,\n\tsearchcontrol: url('?searchcontrol') || null,\n\troutingcontrol: url('?routingcontrol') || null,\n\topeninstamaps: url('?openinstamaps') || null,\n\tscalecontrol: url('?scalecontrol') || null,\n\tcontrol3d: url('?control3d') || null,\n\tview3d: url('?3d') || null,\n\thomecontrol: url('?homecontrol') || null,\n\tlocationcontrol: url('?locationcontrol') || null,\n\tzoomcontrol: url('?zoomcontrol') || null,\n\tstaticmap: url('?staticmap') || null,\n\tnavbar: url('?navbar') || null,\n\trtoolbar: url('?rtoolbar') || null,\n\tltoolbar: url('?ltoolbar') || null,\n\tappmodul: url('?appmodul') || null,\n\tlat : url(\"?lat\") || null,\n\tlon : url(\"?lon\") || null,\n\tzoom : url(\"?zoom\") || null,\n\ttext: url(\"?text\") || null,\n\tlink: url(\"?link\") || null,\n\tappname: url(\"?appname\") || null,\n\tfons: url(\"?fons\") || null,\n\tINE10: url(\"?INE10\") || null, \n\trandom: url(\"?random\") || null\n};\n\nvar visor; \n\njQuery(document).ready(function() {\n\t//TODO ver si esto es mejor ponerlo cuando ya esté cargado todo el visor para cojer bien el titulo, etc.\n\t//$.publish('trackPageview', null);\n\t\n\tvar tipus_user = defineTipusUser();  //geocat.web-1.0.0\n\t\n\tvisorOptions.tipusUser = tipus_user;\n\t\n\tif (visorOptions.businessid==null){\n\t\tvar busid = url(-2);\n\t\tvisorOptions.businessid=busid;\n\t}\n\tvisor = Visor(visorOptions).draw();\n\t\n}); // Final document ready\n\n","/**\n * require: jquery\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar SelectMunicipis = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \treturn this;\n        },\n        \n        cache: function(){\n        \tvar that = this;\n        \t$.get(\"/geocatweb/dades/municipis4326.json\",function(data){\n        \t\tthat.municipis = data;\n        \t});\n        },\n \n        createSelect: function(){\n        \tvar that = this;\n        \tvar selMuni = $('<select/>')\n        \t.addClass('selectMunicipis')\n        \t.prop('title', \"Escull un municipi\")\n        \t.on('change',function(){\n        \t\t$.publish('changeSelectMunicipis',$(this).find(\":selected\").data('item'));\n        \t});\n        \t$.each(that.municipis, function() {\n        \t\tvar item = this;\n        \t\tvar option = $('<option/>')\n        \t\t.prop('value',item.municipiCodi)\n        \t\t.data('item', item)\n        \t\t.html(item.municipi);\n        \t\tselMuni.append(option);\n        \t});\n        \treturn selMuni;\n        },\n        \n        getViewMunicipis: function(bbox){\n        \t\n        },\n                      \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \t\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return SelectMunicipis.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.SelectMunicipis = SelectMunicipis.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, leafletjs\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar ListViewMunicipis = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.filtered = [];\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \treturn this;\n        },\n        \n        cache: function(){\n        \tvar that = this;\n        \t$.get(\"/geocatweb/dades/municipis4326.json\",function(data){\n        \t\tthat.municipis = data;\n        \t});\n        },\n \n        createList: function(container){\n        \tvar that = this;\n        \tthat.container = container;\n        \t$('<div/>').prop('lang','ca').addClass('listlabel').html('Municipis en vista').appendTo(container);\n        \tthat.label = that.container.find('.listlabel');\n        \tvar listMuni = $('<ul/>')\n        \t.addClass('listMunicipis')\n        \t.on('click','li',function(){\n        \t\t$.publish('changeSelectMunicipis',$(this).data('item'));\n        \t});\n        \tlistMuni.appendTo(container);\n        \tthat.listMuni = listMuni;\n        \tthat.drawList();\n        },\n        \n        drawList: function(){\n        \tvar that = this;\n        \tif(that.label){\n        \t\tthat.label.show();\n        \t}\n        \tif(that.listMuni){\n        \t\t$.each(that.filtered, function() {\n            \t\tvar item = this;\n            \t\tvar option = $('<li/>')\n            \t\t.data('item', item)\n            \t\t.html(item.municipi);\n            \t\tthat.listMuni.append(option);\n            \t});\n        \t}\n        },\n        \n        cleanList: function(){\n        \tvar that = this;\n        \tif(that.label){\n        \t\tthat.label.hide();\n        \t}\n        \tif(that.listMuni){\n        \t\tthat.listMuni.empty();\n        \t}\n        \tthat.filtered = [];\n        },\n                \n        getViewMunicipis: function(bbox){\n        \tvar that = this;\n        \tvar arrayLength = that.municipis.length;\n        \tvar municipi, mbbox;\n        \tthat.cleanList();\n        \tfor(var i = 0; i < arrayLength; i++){\n        \t\tmunicipi = that.municipis[i];\n        \t\tmbbox = municipi.bbox.split(\",\");\n        \t\tmbbox = L.latLngBounds([[parseFloat(mbbox[1]),parseFloat(mbbox[0])],[parseFloat(mbbox[3]),parseFloat(mbbox[2])]]);\n        \t\tif(bbox.intersects(mbbox)){\n        \t\t\tthat.filtered.push(municipi);\n        \t\t}\n        \t}\n        \tthat.drawList();\n        },\n                      \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('mapMoveend',function(e, data){\n        \t\tvar map = data;\n        \t\tif (map.getZoom() >= 13){\n        \t\t\tthat.getViewMunicipis(map.getBounds());\n        \t\t}else{\n        \t\t\tthat.cleanList();\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return ListViewMunicipis.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.ListViewMunicipis = ListViewMunicipis.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetMeteo = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.url = \"http://www.aemet.es/ca/eltiempo/prediccion/municipios/mostrarwidget/widget_prov_id_municipi?w=g3p11111110ohmffffffw350z252x333333t999999r1s1n1\";\n        \tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tvar that = this;\n        \tthat.container = $(that.containerId);\n        \t$.get(\"/geocatweb/dades/municipisAemet.json\",function(data){\n        \t\tthat.municipis = data;\n        \t});\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n        \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-meteo')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Meteo']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \tthis.iframe = false;\n        \t$(this.containerId).empty();\n        },\n        \n        getMunicipi: function(codigo){\n        \tvar that = this;\n        \tvar codiMeteo;\n        \tif (codigo != null){\n        \t\tif (codigo.length > 5){\n        \t\t\tcodigo = codigo.substring(0,5);\n        \t\t}\n        \t\tvar arrayLength = that.municipis.length;\n        \t\tfor (var i = 0; i < arrayLength; i++) {\n        \t\t\tif (that.municipis[i].indexOf(codigo) != -1){\n        \t\t\t\tcodiMeteo = that.municipis[i];\n        \t\t\t\tbreak;\n        \t\t\t}\n        \t\t}\n        \t}\n        \treturn codiMeteo;\n        },\n        \n        draw: function(data){\n        \tvar that = this;\n        \tif(that.active   && data.tipusMunicipi){\n        \t\tvar codi = that.getMunicipi(data.municipiCodi);\n        \t\tif (codi){\n            \t\tvar url = that.url.replace(\"widget_prov_id_municipi\", codi);\n            \t\tif (that.iframe){\n            \t\t\t$(that.containerId).find('iframe').prop('src',url);\n                \t}else{\n                \t\t$('<iframe/>').prop('src',url)\n                \t\t.attr('seamless','seamless').attr('scrolling','no')\n                \t\t.appendTo($(that.containerId));\n                \t\tthat.iframe = true;\n                \t}\n            \t}else{\n            \t\t$(that.containerId).empty();\n            \t}\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetMeteo.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetMeteo = WidgetMeteo.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetIdescat = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.url = \"http://api.idescat.cat/emex.ifr?bc=333333&lc=0000cc&c=000000&t=0&e=f&enc=utf-8&tc=ffffff&id=widget_id_municipi&i=f261,f321,f187,f188,f184,f91,f242,f122,f133,f134,f141,f144,f215,f219,f19&lang=cat\";\n\t\t\tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tthis.container = $(this.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n                \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-idescat')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Idescat']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \tthis.iframe = false;\n        \t$(this.containerId).empty();\n        },\n        \n        draw: function(data){\n        \tvar that = this;\n        \tif(that.active   && data.tipusMunicipi){\n        \t\tvar codi = data.municipiCodi;\n        \t\tif (codi){\n            \t\tvar url = that.url.replace(\"widget_id_municipi\", codi);\n            \t\tif (that.iframe){\n            \t\t\t$(that.containerId).find('iframe').prop('src',url);\n                \t}else{\n                \t\t$('<iframe/>').prop('src',url)\n                \t\t.attr('seamless','seamless').attr('scrolling','no')\n                \t\t.appendTo($(that.containerId));\n                \t\tthat.iframe = true;\n                \t}\n            \t}else{\n            \t\t$(that.containerId).empty();\n            \t}\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetIdescat.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetIdescat = WidgetIdescat.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetCartoteca = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.url = \"http://cartotecadigital.icc.cat/cdm/search/searchterm/widget_id_llistamunis/mode/all/conn/and/cosuppress/\";\n        \tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tthis.container = $(this.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n                \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-cartoteca')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Cartoteca']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \t$(this.containerId).empty();\n        },\n        \n        draw: function(data){\n        \tvar that = this;\n        \tif(that.active){\n        \t\t$(that.containerId).empty();\n        \t\tvar llistamunis = encodeURIComponent(data.municipi);\n        \t\tvar url = that.url.replace(\"widget_id_llistamunis\", llistamunis);\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \n    \t\t\tthis.windowObjectReference.focus();\n    \t\t\t\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\n    \t\t\t$('<div></div>').addClass('list').append(\n\t    \t\t\t$('<a></a>', {\n\t\t\t\t\t\t'href' : url,\n\t\t\t\t\t\t'target' : '_blank'\n\t\t\t\t\t}).html(data.municipi + \" a la cartoteca digital\")).append(\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\n            \t\t\t\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetCartoteca.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetCartoteca = WidgetCartoteca.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetRPUC = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.url = \"http://ptop.gencat.cat/rpucportal/AppJava/cercaExpedient.do?reqCode=cerca&municipiSel=widget_id_municipi\";;\n        \tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tthis.container = $(this.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n                \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-rpuc')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Rpuc']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \t$(this.containerId).empty();\n        },\n        \n        draw: function(data){\t\n\t\t\n\t\n        \tvar that = this;\n        \tif(that.active  && data.tipusMunicipi){\n\t\t\t\t\n\t\t\t\n\t\t\t\t\n        \t\t$(that.containerId).empty();\n        \t\tvar codi = data.municipiCodi.substring(0,5);\n        \t\tvar url = that.url.replace(\"widget_id_municipi\", codi);\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \n    \t\t\tthis.windowObjectReference.focus();\n    \t\t\t\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\n    \t\t\t$('<div></div>').addClass('list').append(\n\t    \t\t\t$('<a></a>', {\n\t\t\t\t\t\t'href' : url,\n\t\t\t\t\t\t'target' : '_blank'\n\t\t\t\t\t}).html(data.municipi + \" al registre de planejament urbanístic de Catalunya\")).append(\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetRPUC.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetRPUC = WidgetRPUC.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetCadastre = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.rutaUrbanaCadastre = \"http://www.catastro.minhap.es/INSPIRE/CadastralParcels/_provincia_/_codi_-_nom_/A.ES.SDGC.CP.U._codi_.zip\";\n\t\t\tthis.rutaRuralCadastre = \"http://www.catastro.minhap.es/INSPIRE/CadastralParcels/_provincia_/_codi_-_nom_/A.ES.SDGC.CP.R._codi_.zip\";\n\t\t\tthis.containerId = '.drawWidgets';\n\t\t\tthis.m_SGDC = \"Els arxius es descarregaran en el format GML 3.2. Si tens problemes per visualitzar-los consulta la <a href='http://www.geoportal.cat/geoportal/cat/documentacio/manuals/index.jsp' target='_blank' class='alert-link'>Guia IDEC de visualització GML</a> <br><br><i>Font dades:<a href='http://www.catastro.minhap.es/INSPIRE/CadastralParcels/ES.SDGC.CP.Atom.xml' target='_blank' class='alert-link'>Servei INSPIRE-ATOM SDGC</a></i>\";\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tvar that = this;\n        \tthat.container = $(that.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n        \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-cadastre')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Cadastre']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \t$(this.containerId).empty();\n        },\n        \n        draw: function(data){\n        \tvar that = this;\n        \tif(that.active   && data.tipusMunicipi){\n        \t\t$(that.containerId).empty();\n        \t\tvar codi = data.codiCadastre;\n        \t\tvar urlUrbana = that.rutaUrbanaCadastre.replace('_nom_',data.municipiCadastre);\n        \t\turlUrbana = urlUrbana.replace('_provincia_',data.provinciaCodi);\n        \t\turlUrbana = urlUrbana.replace(/_codi_/g,data.codiCadastre);\n        \t\t\n        \t\tvar urlRural = that.rutaRuralCadastre.replace('_nom_',data.municipiCadastre);\n        \t\turlRural = urlRural.replace('_provincia_',data.provinciaCodi);\n        \t\turlRural = urlRural.replace(/_codi_/g,data.codiCadastre);\n        \t\t\n        \t\tif (codi){\n        \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\n        \t\t\t$('<div></div>').addClass('list').append(\n        \t\t\t$('<a></a>', {\n    \t\t\t\t\t'href' : urlUrbana,\n    \t\t\t\t\t'class' : 'zip',\n    \t\t\t\t\t'target' : '_blank'\n    \t\t\t\t}).html(data.municipiCadastre + \" urbana.zip\")).append(\n    \t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-compressed'})).appendTo($(that.containerId));\n        \t\t\t\n        \t\t\t$('<div></div>').addClass('list').append($('<a></a>', {\n    \t\t\t\t\t'href' : urlRural,\n    \t\t\t\t\t'class' : 'zip',\n    \t\t\t\t\t'target' : '_blank'\n    \t\t\t\t}).html(data.municipiCadastre + \" rústega.zip\")).append(\n        \t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-compressed'})).appendTo($(that.containerId));\n        \t\t\t\n        \t\t\t$('<p></p>').appendTo($(that.containerId));\n        \t\t\t$('<div></div>').addClass('alert alert-info').html(that.m_SGDC).appendTo($(that.containerId));\n        \t\t}else{\n            \t\t$(that.containerId).empty();\n            \t}\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetCadastre.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetCadastre = WidgetCadastre.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetInfoparcela = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\tthis.url = \"http://www.geolocal.cat/geoLocal/infoParcela/?bbox=widget_bbox_municipi&title=widget_nom_municipi\";;\n\t\t\tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \tthis.bindEvents();\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tthis.container = $(this.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n                \n        drawButton: function(container){\n        \tvar that = this;\n        \t$('<div/>').addClass('widget-button').addClass('widget-infoparcela')\n        \t.on('click',function(){\n        \t\t$.publish('widgetActivated',{'target':this,'widget':that});\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_InfoParcela']});\n        \t})\n        \t.appendTo(container);\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \t$(this.containerId).empty();\n        },\n        \n        draw: function(data){\t\n        \tvar that = this;\n        \t\n        \tif(that.active && data.tipusMunicipi){\n        \t\t$(that.containerId).empty();\n        \t\t//var codi = data.municipiCodi.substring(0,5);\n        \t\tvar url = that.url.replace(\"widget_nom_municipi\", data.municipi);\n        \t\turl = url.replace(\"widget_bbox_municipi\", data.bbox);\n    \t\t\tthis.windowObjectReference = window.open(url,\"PromoteFirefoxWindowName\", \"resizable=yes,scrollbars=yes,status=yes\");  \n    \t\t\tthis.windowObjectReference.focus();\n    \t\t\t\n    \t\t\t$('<p></p>').addClass('text').html('Municipi de <b>' + data.municipi + '</b>').appendTo($(that.containerId));\n    \t\t\t$('<div></div>').addClass('list').append(\n\t    \t\t\t$('<a></a>', {\n\t\t\t\t\t\t'href' : url,\n\t\t\t\t\t\t'target' : '_blank'\n\t\t\t\t\t}).html(data.municipi + \" a InfoParcel·la\")).append(\n\t\t\t\t\t$('<span></span>',{'class':'glyphicon glyphicon-new-window'})).appendTo($(that.containerId));\n        \t}\n        },\n                \n        /**********Events**************/\n        bindEvents: function(){\n        },\n        \n        subscriptions: function() {\n        \tvar that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n        \t\tif(data){\n        \t\t\tthat.draw(data);\n        \t\t}\n        \t});\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetInfoparcela.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetInfoparcela = WidgetInfoparcela.init();\n\t\n})( jQuery, window, document );","/**\n * require: jquery, bootstrap\n */\n(function ( $, window, document, undefined ) {\n\t\"use strict\";\n\tvar WidgetMascara = {\n\t\t\t\t\t\n\t\tinit: function() {\n\t\t\t\n\t\t\t\n\t\t\tthis.url = \"/geotimeservices/aoc?\";\n\t\t\tthis.layerFiltreCom='filtre_comarca';\n\t\t\tthis.layerFiltreMuni='filtre_municipi'\n\t\t\tthis.layerWMS=null;\n\t\t\tthis.itemActive=null;\n\t\t\tthis.containerId = '.drawWidgets';\n\t\t\tthis.cache();\n        \tthis.subscriptions();\n        \t//this.bindEvents();\t\t\t\n        \tthis.uiLoaded = false;                    \t\n            return this;\n        },\n        \n        cache: function(){\n        \tthis.container = $(this.containerId);\n        },\n        \n        getWidget: function(){\n        \treturn this;\n        },\n                \n        drawButton: function(container){\n\t\t\t\n\t\t\tvar selMask = $('<input/>')\n        \t.addClass('chk_mascara')\n        \t.prop('type', \"checkbox\")\n\t\t\t\n\t\t\t.prop('id', \"id_chk_mascara\")\n        \t.on('click',function(){\n        \t\t$.publish('changeMask',$(this).prop('checked'));\n        \t\t$.publish('analyticsEvent',{event:[ 'visor', 'widget_Mascara']});\n        \t});\n\t\t\t\n\t\t\tvar selMaskdiv = $('<div/>').addClass('checkbox');\n\t\t\tselMask.appendTo(selMaskdiv);\n\t\t\t\n\t\t\tvar selLabelMask=$('<label />')\n\t\t\t.prop('for', \"id_chk_mascara\")\n\t\t\t.text( \"Aplicar màscara\");\n\t\t\tselLabelMask.appendTo(selMaskdiv);\n\t\t\tcontainer.append( selMaskdiv);\n\t\t\t\n\t\t\t\n\t\t\tthis.bindEvents();\t\n\t\t\t\n        },\n        \n        activate: function(){\n        \tthis.active = true;\n        },\n        \n        deactivate: function(){\n        \tthis.active = false;\n        \t$(this.containerId).empty();\n        },\n        getActiveItem:function(){\n\t\t\n\t\t\treturn this.itemActive;\n\t\t\n\t\t},\t\n\t\t\n\t\tsetActiveItem:function(data){\n\t\t\t this.itemActive=data;\n\t\t\t\n\t\t},\t\n\t\tdraw:function(data,input){\n\t\t\t\n\t\t\tvar that = this;\n\t\t\t\t\n\t\t\tif(this.layerWMS !=null && map.hasLayer(this.layerWMS)){map.removeLayer(this.layerWMS);}\t\n\t\t\t\n\t\t\tif(input){\n\n\t\t\tvar layerFiltre=that.layerFiltreMuni;\n\n\t\t\t\tthis.itemActive.tipusMunicipi?layerFiltre=that.layerFiltreMuni:layerFiltre=that.layerFiltreCom;\n\t\t\t\t\t\n\t\t\t\t\tthis.layerWMS= L.tileLayer.betterWms(that.url, {\n\t\t\t\t\tlayers : layerFiltre,\n\t\t\t\t\t//crs : '3857',\n\t\t\t\t\t\n\t\t\t\t\ttransparent : true,\n\t\t\t\t\tCODIENS : this.itemActive.municipiMunicat,\n\t\t\t\t\texceptions:'application/vnd.ogc.se_blank',\n\t\t\t\t\t//exceptions:checkExceptionsType(wms.url),\n\t\t\t\t\tformat : 'image/png',\n\t\t\t\t\twmstime:false,\n\t\t\t\t\ttileSize:512\n\t\t\t\t}).addTo(map).bringToFront();\n\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\n\t\t},\n\t\t\n        \n                \n        /**********Events**************/\n        bindEvents: function(){\n\t\t\tvar _that =this;\n\t\t\tmap.on('layeradd',function(e){\n\t\t\t\t\n\t\t\t\tif(_that.layerWMS !=null && map.hasLayer(_that.layerWMS)){_that.layerWMS.bringToFront()}\t\n\t\t\t\t\n\t\t\t});\t\n\t\t\t\n\t\t\t\n        },\n        \n        subscriptions: function() {\n        \tvar _that = this;\n        \t$.subscribe('changeSelectMunicipis',function(e, data){\n\t\t\t\t\n\t\t\t\t_that.setActiveItem(data);\n\t\t\t\t\n        \t\tif(data && $('#id_chk_mascara').prop('checked')){\n     \n\t\t\t\t_that.draw(data, true);\t\n\t\t\t\t\t\n\t\t\t\t\t\n        \t\t}\n        \t});\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t$.subscribe('changeMask',function(e, input){\n\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\t\tvar data=_that.getActiveItem();\n\t\t\t\t\t\t\t\t\n        \t\tif(input && data ){\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t_that.draw(data, true);\t\n\n        \t\t}else{\n\t\t\t\t\n\t\t\t\t_that.draw(null, false);\t\n\t\t\t\t\n\t\t\t\t}\t\n        \t});\n\t\t\t\n\t\t\t\n        }\n\t}\n\t\n\t//Registre module if AMD is present:\n   \tif(typeof define === \"function\" && define.amd){\n   \t\tdefine([], function(){return WidgetMascara.init();} );\n   \t}\n   \t\n   \t//Initialize the whole thing. Can be referenced anywhere in your code after it has been declared.\n   \twindow.WidgetMascara = WidgetMascara.init();\n\t\n})( jQuery, window, document );","/**\n * \n * require: WidgetsGeolocal, \n */\n;(function(global, $){\n\n\tvar VisorGeolocal = function(options){\n\t\treturn new VisorGeolocal.init(options);\n\t};\n\t\n\tvar visorOptions = {\n\t\tcontrols: {},\n\t};\n\t\n\tVisorGeolocal.prototype = {\n\t\t\t\n\t\taddWidgetsControl: function(){\n\t\t\tvar self = this,\n\t\t\tctr_widgets,\n\t\t\tvisor = self.visor,\n\t\t\t_map = visor.map;\n\t\t\t\n\t\t\tctr_widgets = L.control.widgets({\n\t\t\t\ttitle: window.lang.translate('Ginys')\n\t\t\t});\n\t\t\tctr_widgets.addTo(_map);\n\t\t\t\n\t\t\tself.controls.widgetsControl = ctr_widgets;\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tresizeMap: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tmap = visor.visor,\n\t\t\toptionsBtn = {},\n\t\t\tfactorH = 0,\n\t\t\tfactorW = 0,\n\t\t\t_window = $( window ),\n\t\t\twidthW = _window.width(),\n\t\t\theightW = _window.height(),\n\t\t\t_mapDiv = $('#map'),\n\t\t\tcl = jQuery('.bt_llista span').attr('class');\n\t\t\tif(self.embed){//Pel cas visor, embeded\n\t\t\t\tfactorH = 0;\n\t\t\t}else{\n\t\t\t\tfactorH = $('.navbar').css('height').replace(/[^-\\d\\.]/g, '');\n\t\t\t}\n\t\t\t_mapDiv.css('top', factorH + 'px');\n\t\t\t_mapDiv.height(heightW - factorH);\n\t\t\t_mapDiv.width(widthW - factorW);\n\t\t\t\n\t\t\tif(widthW<500 || heightW<=350){\n\t\t\t\toptionsBtn = {\n\t\t\t\t\twidgets: false\n\t\t\t\t};\n\t\t\t}else{\n\t\t\t\toptionsBtn = {\n\t\t\t\t\twidgets: true\n\t\t\t\t};\n\t\t\t}\n\t\t\tself._redrawButtons(optionsBtn);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_redrawButtons: function(options){\n\t\t\tvar self = this;\n\t\t\t\n\t\t\tif(options.widgets && self.controls.widgetsControl){\n\t\t\t\tself.controls.widgetsControl.showBtn();\n\t\t\t}else if(self.controls.widgetsControl){\n\t\t\t\tself.controls.widgetsControl.hideBtn();\n\t\t\t}\n\t\t},\n\t\t\n\t\t_loadPublicMap: function(_mapConfig){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tmap = visor.map,\n\t\t\tnomUser = _mapConfig.entitatUid.split(\"@\"),\n\t\t\tnomEntitat = _mapConfig.nomEntitat,\n\t\t\tinfoHtml = '';\n\t\t\t\n\t\t\t//TODO  ver si podemos usar un objeto usuario para almacenar este tipo de cosas.\n\t\t\t//cambiamos la cookie del perfil\n\t\t\tCookies.set('perfil', 'geolocal');\n\t\t\tcheckUserLogin();\n\t\t\t\n\t\t\t//cambiamos la cuenta de google\n\t\t\t//_gaq.push(['_setAccount', 'UA-46332195-6']);\n\t\t\tga('create', 'UA-46332195-6', 'auto');\n\t\t\t//cambiamos el info\n\t\t\tinfoHtml += '<div style=\"color:#ffffff\">';\n\t\t\tif (nomEntitat!=undefined) infoHtml +='<p>'+nomEntitat+'</p>';\n\t\t\tinfoHtml += '</div>';\n\t\t\t\n\t\t\t//destruir el creado en el visor\n\t\t\t$('#infoMap').popover('destroy');\n\t\t\t$('#infoMap').popover({\n\t\t\t\tplacement : 'bottom',\n\t\t\t\thtml: true,\n\t\t\t\tcontent: infoHtml\n\t\t\t});\n\t\t\t$('#infoMap').on('show.bs.popover', function () {\n\t\t\t\t$(this).attr('data-original-title', window.lang.translate($(this).data('lang-title')));\t\t\n\t\t\t});\n\t\t\t\n\t\t\t$('.brand-txt').hide();//#496: Traiem \"Instamaps\" dels visors de Geolocal\n\t\t\t$('.img-circle2-icon').hide();\n\n\t\t\tif (_mapConfig.options.barColor){\n\t\t\t\t$('#navbar-visor').css('background-color', _mapConfig.options.barColor);\n\t\t\t}\n\n\t\t\tif (_mapConfig.options.textColor){\n\t\t\t\t$('#navbar-visor').css('color', _mapConfig.options.textColor).css('border-color', '#ffffff');\n\t\t\t\t$('.navbar-brand').css('color', _mapConfig.options.textColor);\n\t\t\t\t$('#mapTitle').css('color', _mapConfig.options.textColor);\n\t\t\t\t$('#mapTitle h3').css('color', '#ffffff');\n\t\t\t\t$('.navbar-inverse .navbar-nav > li > a').css('color', _mapConfig.options.textColor);\n\t\t\t\t$('#menu_user > a > span').removeClass('green').css('color', _mapConfig.options.textColor);\n\t\t\t\t$('.navbar-form').css('border-color', 'transparent');\n\t\t\t\t$('.bt-sessio').css('border-color', '#ffffff');\n\t\t\t}\n\n\t\t\tif (_mapConfig.options.fontType){\n\t\t\t\t$('#navbar-visor').css('font-family', _mapConfig.options.fontType);\n\t\t\t}\n\n\t\t\t$('.escut').show();\n\t\t\tif (_mapConfig.logo){\n\t\t\t\t$('.escut img').prop('src', '/logos/'+_mapConfig.logo);\n\t\t\t}\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tdrawEmbed: function(){\n\t\t\tvar self = this;\n\t\t\t\n\t\t\tself.widgetscontrol = true;\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tdraw: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tmap = visor.map,\n\t\t\t_mapConfig = visor._mapConfig;\n\t\t\t\n\t\t\t$(window).resize(_.debounce(function(){\n\t\t\t\tself.resizeMap();\n\t\t\t},150));\n\t\t\t\n\t\t\tself._listenEvents();\n\t\t\t\n\t\t\tif(visor.embed){\n\t\t\t\tself.drawEmbed();\n\t\t\t}\n\t\t\t\n\t\t\tif(!visor.rtoolbar){\n\t\t\t\tif(!self.widgetscontrol){\n\t\t\t\t\tself.addWidgetsControl();\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tself._addLogosGeolocal();\n\t\t\t\n\t\t\tself._loadPublicMap(_mapConfig);\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\t_addLogosGeolocal: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tmap = visor.map;\n\t\t\t\n\t\t\tvisor.addLogoInstamap();\n\t   \t\t\n\t   \t\t$.get(\"templates/logosGeolocal.html\",function(data){\n\t   \t\t\tvisor.controls.controlLogos.addLogoHtml(data);\n\t\t\t});\n\t\t\t\n\t   \t\treturn self;\n\t\t},\n\t\t\n\t\t_showwigetsEvent: function(){\n\t\t\t$.publish('analyticsEvent',{event:[ 'visor', 'widgets']});\n\t\t},\n\t\t\n\t\t_listenEvents: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\t_map = visor.map;\n\t\t\tif(_map){\n\t\t\t\t_map.on('showwigets', self._showwigetsEvent, self);\n\t\t\t}\n\t\t}\n\t\t\n\t};\n\t\n\tVisorGeolocal.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, visorOptions, options);\n\t};\n\t\n\tVisorGeolocal.init.prototype = VisorGeolocal.prototype;\n\t\n\tglobal.VisorGeolocal = VisorGeolocal;\n\t\n}(window, jQuery));","/**\n * Crear el visor simple para el cloudifier\n */\n;(function(global, $){\n\t\n\tvar VisorSimple = function(options){\n\t\treturn new VisorSimple.init(options);\n\t};\n\t\n\tvar visorOptions = {\n\t\tcontrols: {},\n\t};\n\t\n\tVisorSimple.prototype = {\n\t\t\n\t\tdrawEmbed: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor;\n\t\t\t\n\t\t\tvisor.hideControl('layersControl');\n\t\t\t\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tsetMapWMSBoundingBox: function(url){\n\t\t\tvar instamapsWms = InstamapsWms({\n\t\t\t\tloadTemplateParam :false});\n\t\t\tvar dataWMS = {url: url};\n\t\t\tinstamapsWms.getWMSLayers(dataWMS).then(function(results) {\n\t\t\t\t//Fem Layer.Layer perq des de el cloudifier sempre tindrem nomes una capa\n\t\t\t\tvar bbox = results.Capability.Layer.Layer.LatLonBoundingBox;\n\t\t\t\tmap.fitBounds([\n\t\t\t       [bbox[\"@miny\"], bbox[\"@minx\"]],\n\t\t\t       [bbox[\"@maxy\"], bbox[\"@maxx\"]]\n\t\t\t\t]);\n\t\t\t},function(){\n\t\t\t\tconsole.error(\"Error getCapabilities\");\n\t\t\t});\n\t\t},\n\t\t\n\t\tloadWmsVisorSimple: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tlayername = visor.layername,\n\t\t\tmap = visor.map,\n\t\t\turl = visor.urlwms;\n\t\t\t\n\t\t\tlayer = {\n\t\t\t\t\"url\": url,\n\t\t\t\t\"servername\": layername,\n\t\t\t\t\"layers\": layername,\n\t\t\t    \"imgFormat\": \"image/png\",\n\t\t\t    \"transparency\": \"true\",\n\t\t\t    \"version\": \"1.1.1\",\n\t\t\t    \"opacity\": 1,\n\t\t\t    \"epsg\": undefined,\n\t\t\t\t\"serverName\": layername,\n\t\t\t\t\"serverType\": t_wms,\n\t\t\t\t\"capesActiva\": \"true\",\n\t\t\t\t\"capesCalenta\" : \"false\",\n\t\t\t\t\"capesOrdre\":  \"1\",\n\t\t\t\t\"capesVisibilitat\":  \"true\",\n\t\t\t\t\"visibilitat\": \"O\",\n\t\t\t    \"businessId\": \"-1\"\n\t\t\t};\n\t\t\tif(visor.random){\n\t\t\t\tlayer.random = visor.random;\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\tloadWmsLayer(layer, map);\n\t\t\tself.setMapWMSBoundingBox(layer.url);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tloadVisorSimple: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor,\n\t\t\tlayername = visor.layername,\n\t\t\ttitle = \"Mapa  \"+ layername +\" cloudifier\",\n\t\t\t_map = visor.map;\n\t\t\t\n\t\t\t$('meta[poperty=\"og:title\"]').attr('content', title);\n\t\t\t$('#nomAplicacio').html(title);\n\t\t\tdocument.title = title;\n\t\t\t$(\"#mapTitle\").html(title);\n\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tdraw: function(){\n\t\t\tvar self = this,\n\t\t\tvisor = self.visor;\n\t\t\t\n\t\t\tif(visor.embed){\n\t\t\t\tself.drawEmbed();\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\tself.loadVisorSimple();\n\t\t\tself.loadWmsVisorSimple();\n\t\t\t\n\t\t\treturn self;\n\t\t}\n\t};\n\t\n\tVisorSimple.init = function(options){\n\t\tvar self = this;\n\t\tself = $.extend(self, visorOptions, options);\n\t};\n\t\n\tVisorSimple.init.prototype = VisorSimple.prototype;\n\t\n\tglobal.VisorSimple = VisorSimple;\n\t\n}(window, jQuery));","/**\n * \n */\n;(function(global, $){\n\t\n\tvar Instamaps = function(options){\n\t\treturn new Instamaps.init(options);\n\t}\n\t\n\tvar perfils = [\"instamaps\",\"geolocal\"];\n\t\n\tvar footers = {\n\t\tinstamaps: \"InstaMaps Beta\",\n\t\tgeolocal: \"InstaMaps.Geolocal\"\n\t};\n\t\n\tvar galeriaLink = {\n\t\tinstamaps: \"/geocatweb/galeria.html\",\n\t\tgeolocal: \"/geocatweb/galeria_geolocal.html\"\n\t};\n\t\n\tvar sessionLink = {\n\t\tinstamaps: \"/geocatweb/sessio.html\",\n\t\tgeolocal: \"/geocatweb/sessio_geolocal.html\"\t\n\t};\n\t\n\tvar brand = {\n\t\tinstamaps: \"InstaMaps\",\n\t\tgeolocal: \"InstaMaps.GeoLocal\"\n\t};\n\t\n\tvar brandLink = {\n\t\tinstamaps: \"/index.html\",\n\t\tgeolocal: \"/geolocal.html\"\n\t};\n\t\n\tvar contactEmail = {\n\t\tinstamaps: \"instamapes@icgc.cat\",\n\t\tgeolocal: \"geolocal@icgc.cat\"\t\n\t};\n\t\n\tvar instamapsOptions = {\n\t\tperfil: perfils[0]\t\n\t};\n\t\n\tInstamaps.prototype = {\n\t\t\n\t\tsetPerfil: function(perfil){\n\t\t\tvar self = this;\n\t\t\tif(perfils.indexOf(perfil) === -1){\n\t\t\t\tthrow \"Perfil no soportado\";\n\t\t\t}else{\n\t\t\t\tself.options.perfil = perfil;\n\t\t\t}\n\t\t\t\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tchangeSession: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = sessionLink[self.perfil];\n\t\t\t$(selector).attr(\"href\",msg);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tchangeBrand: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = brand[self.perfil];\n\t\t\t$(selector).html(msg);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tchangeBrandLink: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = brandLink[self.perfil];\n\t\t\t$(selector).attr(\"href\",msg);\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tchangeGaleria: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = galeriaLink[self.perfil];\n\t\t\tif (self.perfil=='geolocal'){\n\t\t\t\tvar msg = \"http://www.instamaps.cat/\"+paramUrl.galeriaPage.substring(1,paramUrl.galeriaPage.length)+\"?user=\"+self.uid;\n\t\t\t\t$(selector).attr(\"href\",msg);\t\t\t\t\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$(selector).attr(\"href\",msg);\n\t\t\t}\n\t\t\treturn self;\n\t\t},\n\t\t\n\t\tchangeFooter: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = footers[self.perfil];\n\t\t\t$(selector).html(msg);\n\t\t\treturn self;\n\t\t}, \n\t\t\n\t\tchangeContact: function(selector){\n\t\t\tvar self = this;\n\t\t\tif(!$){\n\t\t\t\tthrow \"jQuery not loaded\";\n\t\t\t}\n\t\t\tif(!selector){\n\t\t\t\tthrow \"Missing jQuery selector\";\n\t\t\t}\n\t\t\tvar msg = contactEmail[self.perfil];\n\t\t\t$(selector).attr(\"href\",\"mailto:\"+msg);\n\t\t\treturn self;\n\t\t}\n\t\n\t};\n\t\n\tInstamaps.init = function(options){\n\t\tvar self = this;\n\t\t$.extend(self, instamapsOptions, options);\n\t\tswitch(self.tipusEntitat){\n\t\t\tcase 1:\n\t\t\t\tself.perfil = \"instamaps\";\n\t\t\t\tbreak;\n\t\t\tcase 2: \n\t\t\t\tself.perfil = \"geolocal\";\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tself.perfil = \"instamaps\";\n\t\t}\n\t}\n\t\n\tInstamaps.init.prototype = Instamaps.prototype;\n\t\n\tglobal.Instamaps = Instamaps; \n\t\n}(window, jQuery));"]}